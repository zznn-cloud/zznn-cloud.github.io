<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>wsl安装edge浏览器并设置中文支持</title>
      <link href="/2025/09/02/wsl%E5%AE%89%E8%A3%85edge%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B9%B6%E8%AE%BE%E7%BD%AE%E4%B8%AD%E6%96%87%E6%94%AF%E6%8C%81/"/>
      <url>/2025/09/02/wsl%E5%AE%89%E8%A3%85edge%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B9%B6%E8%AE%BE%E7%BD%AE%E4%B8%AD%E6%96%87%E6%94%AF%E6%8C%81/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="wsl安装edge浏览器并设置中文支持"><a href="#wsl安装edge浏览器并设置中文支持" class="headerlink" title="wsl安装edge浏览器并设置中文支持"></a>wsl安装edge浏览器并设置中文支持</h2><p>deb包下载路径:<a href="https://packages.microsoft.com/repos/edge/pool/main/m/microsoft-edge-stable/microsoft-edge-stable_139.0.3405.125-1_amd64.deb?brand=M102">https://packages.microsoft.com/repos/edge/pool/main/m/microsoft-edge-stable/microsoft-edge-stable_139.0.3405.125-1_amd64.deb?brand=M102</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 安装edge</span></span><br><span class="line">sudo apt --fix-broken install || apt install -y </span><br><span class="line">dpkg -i  microsoft-edge-stable_139.0.3405.125-1_amd64.deb</span><br><span class="line"><span class="comment"># 启动edge（需要在普通用户下运行）</span></span><br><span class="line">microsoft-edge</span><br><span class="line"></span><br><span class="line"><span class="comment"># 中文支持</span></span><br><span class="line">sudo apt install fonts-noto-cjk fonts-noto-cjk-extra</span><br><span class="line">sudo apt install language-pack-zh-hans  <span class="comment"># 简体中文</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 步骤1：将中文设为默认语言打开 Edge，在地址栏输入：</span></span><br><span class="line">edge://settings/languages</span><br><span class="line"><span class="comment"># 检查已安装的中文字体</span></span><br><span class="line">fc-list :lang=zh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 终端输入</span></span><br><span class="line">fc-list :lang=zh</span><br><span class="line">如果输出包含 Noto Sans CJK 或 Microsoft YaHei，说明字体已生效。</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启宿主机 再次运行edge此时已经支持中文</span></span><br><span class="line">microsoft-edge</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="构建docker镜像"><a href="#构建docker镜像" class="headerlink" title="构建docker镜像"></a>构建docker镜像</h3><p>已构建镜像: registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:edge</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/ubuntu:20.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置非交互模式</span></span><br><span class="line"><span class="string">ENV</span> <span class="string">DEBIAN_FRONTEND=noninteractive</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖（包括 GUI/多媒体库，Edge 必须要的）</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">apt</span> <span class="string">update</span> <span class="string">&amp;&amp;</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">\</span></span><br><span class="line">    <span class="string">tzdata</span> <span class="string">\</span></span><br><span class="line">    <span class="string">wget</span> <span class="string">\</span></span><br><span class="line">    <span class="string">xdg-utils</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libx11-xcb1</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libxtst6</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libnss3</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libasound2</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libatk1.0-0</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libatk-bridge2.0-0</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libgtk-3-0</span> <span class="string">\</span></span><br><span class="line">    <span class="string">fonts-liberation</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libdrm2</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libgbm1</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libxcb-dri3-0</span> <span class="string">\</span></span><br><span class="line">    <span class="string">libxshmfence1</span> <span class="string">\</span></span><br><span class="line">    <span class="string">&amp;&amp;</span> <span class="string">ln</span> <span class="string">-fs</span> <span class="string">/usr/share/zoneinfo/UTC</span> <span class="string">/etc/localtime</span> <span class="string">\</span></span><br><span class="line">    <span class="string">&amp;&amp;</span> <span class="string">dpkg-reconfigure</span> <span class="string">--frontend</span> <span class="string">noninteractive</span> <span class="string">tzdata</span> <span class="string">\</span></span><br><span class="line">    <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用自定义源（如需）</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">sources.list</span> <span class="string">/etc/apt/sources.list</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">apt</span> <span class="string">update</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">fonts-noto-cjk</span> <span class="string">fonts-noto-cjk-extra</span></span><br><span class="line"><span class="comment"># 复制 Edge 安装包</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">./microsoft-edge-stable_139.0.3405.125-1_amd64.deb</span> <span class="string">/opt/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Edge</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">-f</span> <span class="string">-y</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">apt</span> <span class="string">--fix-broken</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">apt</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">/opt/microsoft-edge-stable_139.0.3405.125-1_amd64.deb</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/var/lib/apt/lists/*</span> <span class="string">/opt/*.deb</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建非 root 用户</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">groupadd</span> <span class="string">-r</span> <span class="string">appuser</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">useradd</span> <span class="string">-r</span> <span class="string">-g</span> <span class="string">appuser</span> <span class="string">-d</span> <span class="string">/home/appuser</span> <span class="string">-s</span> <span class="string">/bin/bash</span> <span class="string">appuser</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/home/appuser</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">chown</span> <span class="string">-R</span> <span class="string">appuser:appuser</span> <span class="string">/home/appuser</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/app</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">chown</span> <span class="string">-R</span> <span class="string">appuser:appuser</span> <span class="string">/app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换用户</span></span><br><span class="line"><span class="string">USER</span> <span class="string">appuser</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Edge，禁用 sandbox &amp; crashpad，避免 /dev/shm 问题</span></span><br><span class="line"><span class="string">CMD</span> [<span class="string">&quot;microsoft-edge&quot;</span>, <span class="string">&quot;--no-sandbox&quot;</span>, <span class="string">&quot;--disable-dev-shm-usage&quot;</span>, <span class="string">&quot;--disable-crash-reporter&quot;</span>]</span><br></pre></td></tr></table></figure><p>构建</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -f Dockerfile -t zznn/edge .</span><br></pre></td></tr></table></figure><p>运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xhost +<span class="built_in">local</span>:</span><br><span class="line">docker run -it   -e DISPLAY=<span class="variable">$DISPLAY</span>   -v /tmp/.X11-unix:/tmp/.X11-unix   zznn/edge:latest</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>现成的镜像运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it   -e DISPLAY=<span class="variable">$DISPLAY</span>   -v /tmp/.X11-unix:/tmp/.X11-unix   registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:edge </span><br></pre></td></tr></table></figure><h3 id="docker版本桌面快捷方式"><a href="#docker版本桌面快捷方式" class="headerlink" title="docker版本桌面快捷方式"></a>docker版本桌面快捷方式</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="keyword">if</span> &quot;%<span class="number">1</span>&quot;==&quot;h&quot; <span class="keyword">goto</span> begin</span><br><span class="line"><span class="built_in">start</span> mshta vbscript:createobject(&quot;wscript.shell&quot;).run(&quot;&quot;&quot;%~nx0&quot;&quot; h&quot;,<span class="number">0</span>)(window.close)&amp;&amp;<span class="keyword">exit</span></span><br><span class="line">:begin</span><br><span class="line"></span><br><span class="line">wsl -d Ubuntu-<span class="number">20</span>.<span class="number">04</span> -- bash -c &quot;docker run --rm   -e DISPLAY=$DISPLAY   -v /tmp/.X11-unix:/tmp/.X11-unix   registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:edge&quot;</span><br></pre></td></tr></table></figure><h3 id="二进制方式快捷方式bat"><a href="#二进制方式快捷方式bat" class="headerlink" title="二进制方式快捷方式bat"></a>二进制方式快捷方式bat</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="keyword">if</span> &quot;%<span class="number">1</span>&quot;==&quot;h&quot; <span class="keyword">goto</span> begin</span><br><span class="line"><span class="built_in">start</span> mshta vbscript:createobject(&quot;wscript.shell&quot;).run(&quot;&quot;&quot;%~nx0&quot;&quot; h&quot;,<span class="number">0</span>)(window.close)&amp;&amp;<span class="keyword">exit</span></span><br><span class="line">:begin</span><br><span class="line"></span><br><span class="line">wsl -d Ubuntu-<span class="number">20</span>.<span class="number">04</span> -- bash -c &quot;microsoft-edge&quot;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> wsl </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wsl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s面试题总结</title>
      <link href="/2025/08/19/k8s%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93/"/>
      <url>/2025/08/19/k8s%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="k8s面试题总结"><a href="#k8s面试题总结" class="headerlink" title="k8s面试题总结"></a>k8s面试题总结</h1><h2 id="一、网络插件-calico-的工作模式有哪几种"><a href="#一、网络插件-calico-的工作模式有哪几种" class="headerlink" title="一、网络插件 calico 的工作模式有哪几种"></a>一、网络插件 calico 的工作模式有哪几种</h2><p><strong>Calico 在 Kubernetes  中的工作模式主要分为以下几种，你在部署时可以根据集群环境、需求和底层网络选择不同模式：</strong></p><h3 id="1-BGP-模式"><a href="#1-BGP-模式" class="headerlink" title="1. BGP 模式"></a>1. <strong>BGP 模式</strong></h3><ul><li><strong>原理</strong>：每个节点运行 <code>calico/node</code>，节点之间通过 <strong>BGP（Border Gateway Protocol）</strong> 交换路由信息。</li><li><strong>特点</strong>：<ul><li><strong>Pod IP 在整个集群中是可路由的，不需要 NAT。</strong></li><li><strong>不依赖 Overlay（隧道），性能好，延迟低。</strong></li><li><strong>常见有两种拓扑：</strong><ul><li><strong>Full-mesh BGP</strong>：所有节点互相建立 BGP 对等关系，适合小规模集群（几十个节点）。</li><li><strong>Route Reflector 模式</strong>：大规模集群时，用一部分节点做 BGP Route Reflector 来减少对等连接数。</li></ul></li></ul></li></ul><h3 id="2-IP-in-IP-模式"><a href="#2-IP-in-IP-模式" class="headerlink" title="2. IP-in-IP 模式"></a>2. <strong>IP-in-IP 模式</strong></h3><ul><li><strong>原理</strong>：在节点之间使用 IP-in-IP 封装（类似 Overlay 网络），解决节点之间路由不可达的问题。</li><li><strong>特点</strong>：<ul><li><strong>适合没有配置 BGP 或底层网络不支持 Pod CIDR 直通的环境。</strong></li><li><strong>数据包经过一次封装，性能比 BGP 模式稍差。</strong></li><li><strong>默认模式之一，部署简单。</strong></li></ul></li></ul><h3 id="3-VXLAN-模式"><a href="#3-VXLAN-模式" class="headerlink" title="3. VXLAN 模式"></a>3. <strong>VXLAN 模式</strong></h3><ul><li><strong>原理</strong>：和 IP-in-IP 类似，但使用 VXLAN 封装。</li><li><strong>特点</strong>：<ul><li><strong>通常在云环境或底层网络受限时使用。</strong></li><li><strong>VXLAN 隧道更通用（大多数云厂商都支持），兼容性强。</strong></li><li><strong>性能比纯三层（BGP 模式）差一些。</strong></li></ul></li></ul><h3 id="4-CrossSubnet-模式"><a href="#4-CrossSubnet-模式" class="headerlink" title="4. CrossSubnet 模式"></a>4. <strong>CrossSubnet 模式</strong></h3><ul><li><strong>原理</strong>：结合 BGP 和隧道（IP-in-IP 或 VXLAN）。</li><li><strong>特点</strong>：<ul><li><strong>同一子网内节点之间直接路由，不走隧道。</strong></li><li><strong>跨子网节点之间才使用隧道封装。</strong></li><li><strong>在性能和兼容性之间做平衡。</strong></li></ul></li></ul><h3 id="5-Policy-only-模式"><a href="#5-Policy-only-模式" class="headerlink" title="5. Policy-only 模式"></a>5. <strong>Policy-only 模式</strong></h3><ul><li><strong>原理</strong>：只使用 Calico 的 <strong>网络策略（NetworkPolicy）</strong> 功能，不负责 Pod 的网络互通。</li><li><strong>特点</strong>：<ul><li><strong>依赖 CNI 提供网络（比如 Flannel、Cilium、AWS VPC CNI），Calico 仅作为策略控制器。</strong></li><li><strong>适合只想用 Calico 强大的安全策略功能的场景。</strong></li></ul></li></ul><p>总结一下常见选择：</p><ul><li><strong>高性能裸机/自建数据中心</strong> → BGP 模式（大规模用 Route Reflector）。</li><li><strong>云环境 / 无法直通路由</strong> → VXLAN 或 IP-in-IP 模式。</li><li><strong>混合环境</strong> → CrossSubnet。</li><li><strong>只要策略，不要网络</strong> → Policy-only。</li></ul><p><strong>这是 Calico 各种工作模式的对比图（性能、兼容性、安全性 评分 1~5）：</strong></p><ul><li><strong>BGP</strong>：性能最佳，但兼容性取决于底层网络是否支持。</li><li><strong>IP-in-IP / VXLAN</strong>：兼容性强，适合云环境，但性能比直连稍差。</li><li><strong>CrossSubnet</strong>：性能和兼容性折中。</li><li><strong>Policy-only</strong>：依赖其他 CNI 提供网络，安全策略功能最强。</li></ul><h2 id="二、cgroup-和-ns-的区别"><a href="#二、cgroup-和-ns-的区别" class="headerlink" title="二、cgroup 和 ns 的区别"></a>二、cgroup 和 ns 的区别</h2><p>**在 **<strong>Linux 容器技术</strong>里，<code>cgroup</code>（control group）和 <code>namespace</code>（命名空间）是两大核心概念，它们解决的问题完全不同，但又经常配合使用。</p><h3 id="1-cgroup（控制组）"><a href="#1-cgroup（控制组）" class="headerlink" title="1. cgroup（控制组）"></a>1. <strong>cgroup（控制组）</strong></h3><ul><li><strong>作用</strong>：限制和管理进程可以使用的资源。</li><li><strong>核心点</strong>：资源隔离 + 限额控制。</li><li><strong>常见控制的资源</strong>：<ul><li><strong>CPU（限制某个进程组最多使用多少 CPU 时间）</strong></li><li><strong>内存（限制最大内存使用，超过时 OOM Kill）</strong></li><li><strong>磁盘 I/O（限制读写带宽）</strong></li><li><strong>网络带宽（在某些扩展里支持）</strong></li></ul></li><li><strong>使用场景</strong>：<ul><li><strong>Docker 限制容器 CPU、内存用量</strong></li><li><strong>Kubernetes Pod 资源请求/限制（requests/limits）</strong></li></ul></li><li>类比：像给进程“配额”，规定它能吃多少饭、喝多少水。</li></ul><h3 id="2-namespace（命名空间）"><a href="#2-namespace（命名空间）" class="headerlink" title="2. namespace（命名空间）"></a>2. <strong>namespace（命名空间）</strong></h3><ul><li><strong>作用</strong>：提供进程间的隔离环境。</li><li><strong>核心点</strong>：视图隔离 + 资源虚拟化。</li><li><strong>常见类型</strong>：<ul><li><strong>PID namespace</strong>：进程号隔离（容器里的 PID 1 不会看到宿主机 PID）</li><li><strong>NET namespace</strong>：网络隔离（容器有独立网卡、IP、路由）</li><li><strong>IPC namespace</strong>：进程间通信隔离（消息队列、信号量）</li><li><strong>UTS namespace</strong>：主机名隔离（容器可有不同 hostname）</li><li><strong>MNT namespace</strong>：挂载点隔离（不同文件系统视图）</li><li><strong>USER namespace</strong>：用户和权限隔离（容器里 root 映射到宿主机普通用户）</li></ul></li><li><strong>使用场景</strong>：<ul><li><strong>让容器拥有独立的文件系统、进程树、网络栈</strong></li></ul></li><li>类比：像给进程戴上“VR 眼镜”，它只能看到自己虚拟出来的世界。</li></ul><h2 id="三、ns-隔离资源的原理"><a href="#三、ns-隔离资源的原理" class="headerlink" title="三、ns 隔离资源的原理"></a>三、ns 隔离资源的原理</h2><p>**要理解 **<strong>namespace（命名空间）是如何实现隔离的</strong>，得从 <strong>Linux 内核的设计原理</strong> 说起。</p><h3 id="1-基础概念"><a href="#1-基础概念" class="headerlink" title="1. 基础概念"></a>1. 基础概念</h3><p><strong>在 Linux 内核里，****一切都是全局的</strong>：</p><ul><li>**默认情况下，所有进程共享同一套 **<strong>进程号表、网络协议栈、挂载点表、主机名、IPC 资源</strong>。</li><li><strong>如果没有特殊机制，所有进程看到的都是同一个“系统”。</strong></li></ul><p><strong>Namespace 的作用</strong>：就是在内核中创建多个“虚拟副本”，让进程只能访问自己那份副本，从而实现隔离。</p><h3 id="2-工作原理"><a href="#2-工作原理" class="headerlink" title="2. 工作原理"></a>2. 工作原理</h3><h4 id="（1）内核数据结构“虚拟化”"><a href="#（1）内核数据结构“虚拟化”" class="headerlink" title="（1）内核数据结构“虚拟化”"></a>（1）内核数据结构“虚拟化”</h4><ul><li>**内核会为某些全局资源，设计一层 **<strong>namespace 抽象层</strong>。</li><li><strong>当新建一个 namespace 时，内核会生成该资源的“独立副本”。</strong></li><li>**不同 namespace 下的进程，指向的是 **<strong>不同的内核对象</strong>。</li></ul><p><strong>例如：</strong></p><ul><li><strong>PID namespace</strong>：每个 namespace 都有独立的 PID 映射表。容器里的 PID 1，其实在宿主机可能是 2345。</li><li><strong>NET namespace</strong>：每个 namespace 有自己的网卡、路由表、iptables 规则。容器之间网络互不影响。</li><li><strong>MNT namespace</strong>：挂载点表被隔离，不同容器看到的文件系统层次不同。</li></ul><h4 id="（2）进程与-namespace-的绑定"><a href="#（2）进程与-namespace-的绑定" class="headerlink" title="（2）进程与 namespace 的绑定"></a>（2）进程与 namespace 的绑定</h4><ul><li>**每个进程在内核中都有一个 **<code>task_struct</code> 结构体。</li><li>**里面包含指针，指向该进程所属的 **<strong>namespace 对象</strong>（pid_ns、net_ns、mnt_ns…）。</li><li>**所以 **<strong>同一宿主机上的进程，可以属于不同的 namespace</strong>。</li></ul><h4 id="（3）系统调用支持"><a href="#（3）系统调用支持" class="headerlink" title="（3）系统调用支持"></a>（3）系统调用支持</h4><ul><li>**Linux 提供了 **<code>clone()</code>、<code>unshare()</code>、<code>setns()</code> 等系统调用，用来创建或切换 namespace。</li><li><strong>容器运行时（Docker、containerd、K8s）启动容器时，会调用这些 API：</strong><ul><li><code>clone(CLONE_NEWNET)</code> → 创建新的网络栈</li><li><code>clone(CLONE_NEWPID)</code> → 创建新的 PID 空间</li><li><code>clone(CLONE_NEWNS)</code> → 创建新的挂载空间</li></ul></li></ul><h3 id="3-类比理解"><a href="#3-类比理解" class="headerlink" title="3. 类比理解"></a>3. 类比理解</h3><ul><li><strong>namespace</strong> 就像一个 <strong>隔板</strong>，把原本全局共享的大空间分隔成多个小房间，每个进程只能在自己的房间里活动。</li><li><strong>进程看不到房间外的东西</strong>，所以它“以为”自己独占了系统。</li></ul><h3 id="🔹-总结"><a href="#🔹-总结" class="headerlink" title="🔹 总结"></a>🔹 总结</h3><ul><li><strong>原理</strong>：namespace 通过内核抽象层，把全局资源复制/虚拟化成多个实例，每个进程只绑定到自己的实例。</li><li><strong>关键点</strong>：<ul><li><strong>数据结构隔离（不同 namespace，资源表不同）</strong></li><li><strong>进程与 namespace 绑定（task_struct 记录所属 ns）</strong></li><li><strong>系统调用支持（clone/unshare/setns 管理 ns 生命周期）</strong></li></ul></li></ul><hr><p>**⚡ **一句话：namespace 通过在内核中为全局资源建立多个副本 + 进程绑定不同副本，实现“视图隔离”。</p><h2 id="四、k8s-创建-pod-的流程"><a href="#四、k8s-创建-pod-的流程" class="headerlink" title="四、k8s 创建 pod 的流程"></a>四、k8s 创建 pod 的流程</h2><p>**Kubernetes 创建一个 Pod，其实涉及 **<strong>API Server、调度器、kubelet、容器运行时</strong> 等多个核心组件。我给你梳理下 <strong>从用户提交 YAML 到 Pod 运行起来</strong> 的完整流程。</p><h3 id="1-用户提交请求"><a href="#1-用户提交请求" class="headerlink" title="1. 用户提交请求"></a>1. 用户提交请求</h3><ul><li>**用户通过 **<code>kubectl apply -f pod.yaml</code> 或 API 调用，向 <strong>API Server</strong> 发送创建 Pod 的请求。</li><li><strong>API Server</strong>：<ul><li><strong>接收请求</strong></li><li><strong>校验 YAML（合法性、schema、资源配额、Admission Webhook…）</strong></li><li>**存储 Pod 对象到 **<strong>etcd</strong></li></ul></li></ul><p><strong>👉 此时，Pod 对象已经存在于 etcd，但还没运行。</strong></p><h3 id="2-调度流程"><a href="#2-调度流程" class="headerlink" title="2. 调度流程"></a>2. 调度流程</h3><ul><li><strong>调度器（kube-scheduler）</strong> 会监听到新 Pod 处于 <code>Pending</code> 状态。</li><li><strong>调度器：</strong><ol><li><strong>根据调度策略（资源请求/限制、亲和性/反亲和性、污点/容忍度、优先级等）筛选可用节点</strong></li><li><strong>选择一个最优节点</strong></li><li>**把调度结果（Pod → 节点）写回 **<strong>API Server</strong></li></ol></li></ul><p>**👉 此时，Pod 还是 **<code>Pending</code>，但已经绑定到某个 Node。</p><h3 id="3-kubelet-创建-Pod"><a href="#3-kubelet-创建-Pod" class="headerlink" title="3. kubelet 创建 Pod"></a>3. kubelet 创建 Pod</h3><ul><li>**目标节点上的 **<strong>kubelet</strong> 监听到有 Pod 调度过来。</li><li><strong>kubelet 执行以下步骤：</strong><ol><li><strong>向 API Server 拉取 Pod 的定义</strong></li><li>**创建 **<strong>PodSandbox</strong>（通常是一个 pause 容器，充当 Pod 的网络 &amp; namespace 容器）</li><li><strong>配置 Pod 网络（CNI 插件：Calico、Flannel…，为 Pod 分配 IP）</strong></li><li><strong>配置存储卷（挂载 PV、PVC、本地目录、ConfigMap、Secret 等）</strong></li><li><strong>拉取镜像（containerd / CRI-O / Docker shim）</strong></li><li><strong>启动 Pod 中定义的各个容器</strong></li></ol></li></ul><p>**👉 此时，容器运行起来，Pod 进入 **<code>Running</code> 状态。</p><h3 id="4-Pod-生命周期管理"><a href="#4-Pod-生命周期管理" class="headerlink" title="4. Pod 生命周期管理"></a>4. Pod 生命周期管理</h3><ul><li><strong>kubelet 持续监控容器状态，上报给 API Server。</strong></li><li><strong>API Server 把状态写入 etcd。</strong></li><li>**用户通过 **<code>kubectl get pod</code> 看到的状态，其实是从 <strong>etcd → API Server → kubectl</strong> 返回的结果。</li><li>**如果容器异常退出，kubelet 会按 Pod 的 **<code>restartPolicy</code>（Always/OnFailure/Never）决定是否重启。</li></ul><h3 id="5-事件流总结"><a href="#5-事件流总结" class="headerlink" title="5. 事件流总结"></a>5. 事件流总结</h3><ol><li><strong>kubectl / API</strong> → 请求创建 Pod</li><li><strong>API Server</strong> → 校验、存储到 etcd</li><li><strong>调度器</strong> → 选择节点，更新 Pod 绑定信息</li><li><strong>kubelet（目标节点）</strong> → 创建 PodSandbox、网络、存储、拉镜像、启动容器</li><li><strong>Pod Running</strong> → 状态通过 kubelet 上报 API Server</li></ol><h3 id="🔹-总结-1"><a href="#🔹-总结-1" class="headerlink" title="🔹 总结"></a>🔹 总结</h3><ul><li><strong>API Server</strong>：前台，接收请求，存储对象</li><li><strong>Scheduler</strong>：选人（决定 Pod 跑在哪个节点）</li><li><strong>Kubelet</strong>：干活的工人（在节点上真正创建容器）</li><li><strong>etcd</strong>：存档，保存集群所有状态</li></ul><hr><p><strong>⚡</strong>一句话：用户提交 YAML → API Server 存储 → Scheduler 分配 → Kubelet 创建 → Pod Running。</p><h2 id="五、svc-暴露端口用到的是哪个组件"><a href="#五、svc-暴露端口用到的是哪个组件" class="headerlink" title="五、svc 暴露端口用到的是哪个组件"></a>五、svc 暴露端口用到的是哪个组件</h2><p><strong>bernetes 里，****Service (svc)</strong> 暴露端口时用到的核心组件主要是 <strong>kube-proxy</strong>。</p><hr><h3 id="Service-暴露端口的实现组件"><a href="#Service-暴露端口的实现组件" class="headerlink" title="Service 暴露端口的实现组件"></a>Service 暴露端口的实现组件</h3><h4 id="1-kube-proxy"><a href="#1-kube-proxy" class="headerlink" title="1. kube-proxy"></a>1. <strong>kube-proxy</strong></h4><ul><li><strong>运行在每个节点上。</strong></li><li><strong>作用：</strong><ul><li><strong>监听 API Server 上的 Service 和 Endpoints 变化。</strong></li><li>**在节点上设置转发规则，让访问 **<code>ServiceIP:Port</code> 能被转发到后端 Pod。</li></ul></li><li><strong>实现方式：</strong><ul><li><strong>iptables 模式</strong>（常用）：基于 iptables 的 DNAT 规则转发流量。</li><li><strong>ipvs 模式</strong>：基于 Linux IPVS，性能更好，支持更多调度算法（rr、lc、dh 等）。</li><li><strong>userspace 模式</strong>（很少用，性能差）。</li></ul></li></ul><p>**👉 **<strong>核心点</strong>：Pod 内部或节点上访问 Service ClusterIP，流量先经过 <strong>kube-proxy 配置的规则</strong>，再转发到某个 Pod。</p><h4 id="2-Service-类型决定是否需要其他组件"><a href="#2-Service-类型决定是否需要其他组件" class="headerlink" title="2. Service 类型决定是否需要其他组件"></a>2. <strong>Service 类型决定是否需要其他组件</strong></h4><ul><li><strong>ClusterIP（默认）</strong>：<ul><li><strong>仅集群内部可访问。</strong></li><li><strong>依赖 kube-proxy 实现端口转发。</strong></li></ul></li><li><strong>NodePort</strong>：<ul><li><strong>在每个 Node 上打开一个端口（30000–32767）。</strong></li><li><strong>仍由 kube-proxy 维护规则，把访问 Node:Port 的流量转发到 Pod。</strong></li></ul></li><li><strong>LoadBalancer</strong>：<ul><li>**需要依赖云厂商的 **<strong>云负载均衡器</strong>（比如 AWS ELB、阿里云 SLB）。</li><li><strong>kube-proxy 仍然负责节点内部转发。</strong></li></ul></li><li><strong>ExternalName</strong>：<ul><li><strong>不依赖 kube-proxy，只是 DNS CNAME 到外部地址。</strong></li></ul></li></ul><hr><h4 id="🔹-总结-2"><a href="#🔹-总结-2" class="headerlink" title="🔹 总结"></a>🔹 总结</h4><ul><li><strong>核心组件</strong>：<code>kube-proxy</code>（iptables 或 ipvs 规则，负责转发 Service 流量）。</li><li><strong>扩展组件</strong>：<ul><li><strong>NodePort → 依赖 kube-proxy</strong></li><li>**LoadBalancer → 依赖 **<strong>云厂商 LB + kube-proxy</strong></li><li><strong>ExternalName → 依赖 DNS，不走 kube-proxy</strong></li></ul></li></ul><hr><p><strong>⚡</strong>一句话：Kubernetes Service 暴露端口的底层实现，核心就是 kube-proxy，它在每个节点配置转发规则，把 Service IP/端口映射到后端 Pod。</p><h2 id="六、云上以及二进制部署的k8s-怎样扩容集群"><a href="#六、云上以及二进制部署的k8s-怎样扩容集群" class="headerlink" title="六、云上以及二进制部署的k8s 怎样扩容集群"></a>六、云上以及二进制部署的k8s 怎样扩容集群</h2><h3 id="☁️-云上-K8s-扩容"><a href="#☁️-云上-K8s-扩容" class="headerlink" title="☁️ 云上 K8s 扩容"></a>☁️ 云上 K8s 扩容</h3><p><strong>（典型：阿里云 ACK、腾讯云 TKE、AWS EKS、GKE、AKS）</strong></p><h4 id="1-控制平面扩容"><a href="#1-控制平面扩容" class="headerlink" title="1. 控制平面扩容"></a>1. 控制平面扩容</h4><ul><li><strong>大多数云厂商</strong>已经提供了高可用的 API Server / etcd 管理，用户通常不需要手动扩容控制平面。</li><li>**如果支持 **<strong>专有集群 / 自管控制平面</strong>，一般通过控制台或 API <strong>新增 Master 节点</strong>，云平台会自动调整 <code>etcd</code> 和 <code>kube-apiserver</code>。</li></ul><h4 id="2-Node-扩容"><a href="#2-Node-扩容" class="headerlink" title="2. Node 扩容"></a>2. Node 扩容</h4><p><strong>方式一：****控制台/CLI 一键加节点</strong></p><ul><li><strong>在控制台选择“添加节点” → 选择云服务器规格、数量。</strong></li><li><strong>系统自动安装 kubelet / kube-proxy，并加入集群。</strong></li></ul><p><strong>方式二：****弹性伸缩 (Cluster Autoscaler)</strong></p><ul><li><strong>开启自动伸缩，云平台会自动创建/释放节点。</strong></li><li><strong>常用于弹性业务场景。</strong></li></ul><p>**👉 **云上扩容的关键是：节点由云厂商提供初始化脚本，自动向 API Server 注册。</p><h3 id="🖥-二进制部署-K8s-扩容"><a href="#🖥-二进制部署-K8s-扩容" class="headerlink" title="🖥 二进制部署 K8s 扩容"></a>🖥 二进制部署 K8s 扩容</h3><p><strong>（二进制方式：kubeadm 之外的纯手工安装，常见于生产环境或大规模私有云）</strong></p><h4 id="1-扩容-Master-节点"><a href="#1-扩容-Master-节点" class="headerlink" title="1. 扩容 Master 节点"></a>1. 扩容 Master 节点</h4><ul><li><strong>需要手动准备新服务器，安装：</strong><code>kube-apiserver</code>、<code>kube-scheduler</code>、<code>kube-controller-manager</code>。</li><li><strong>将新 Master 加入现有的 etcd 集群：</strong><ul><li><strong>在 etcd 上添加新成员 → 同步数据</strong></li><li><strong>修改所有 Master 配置 → 让它们都能访问完整 etcd 集群</strong></li></ul></li><li><strong>配置 kube-apiserver 使用新的 etcd 集群。</strong></li><li><strong>配置高可用入口（Nginx/HAProxy/Keepalived/VIP）来统一 API Server 地址。</strong></li></ul><h4 id="2-扩容-Node-节点"><a href="#2-扩容-Node-节点" class="headerlink" title="2. 扩容 Node 节点"></a>2. 扩容 Node 节点</h4><p><strong>步骤：</strong></p><ol><li><strong>在新机器上安装必要组件：</strong><ul><li><strong>kubelet</strong></li><li><strong>kube-proxy</strong></li><li><strong>CNI 插件（Calico/Flannel/Cilium 等）</strong></li></ul></li><li><strong>配置 kubelet：</strong><ul><li>**指定 **<code>--kubeconfig</code> 指向 API Server</li><li><strong>设置节点名、证书、工作目录</strong></li></ul></li><li><strong>启动 kubelet → kubelet 会向 API Server 注册自己。</strong></li><li>**管理员在 Master 上 **<code>kubectl get nodes</code> 查看新节点状态。</li></ol><h4 id="3-注意点"><a href="#3-注意点" class="headerlink" title="3. 注意点"></a>3. 注意点</h4><ul><li><strong>证书签发：如果启用了 TLS，需要新节点的 kubelet 证书由集群 CA 签发。</strong></li><li><strong>网络：确保新节点与 Pod 网段、Service 网段互通。</strong></li><li><strong>负载均衡：如果是 Master 扩容，记得更新 LB 配置，把新 Master 加入。</strong></li></ul><hr><h4 id="🔹-总结对比"><a href="#🔹-总结对比" class="headerlink" title="🔹 总结对比"></a>🔹 总结对比</h4><table><thead><tr><th><strong>部署方式</strong></th><th><strong>Master 扩容</strong></th><th><strong>Node 扩容</strong></th></tr></thead><tbody><tr><td><strong>云上托管</strong></td><td><strong>云厂商自动维护，用户无需操作</strong></td><td><strong>控制台/CLI 添加节点，或启用弹性伸缩</strong></td></tr><tr><td><strong>二进制自建</strong></td><td><strong>手动安装组件，加入 etcd，配置 LB</strong></td><td><strong>手动安装 kubelet/kube-proxy，配置证书，加入 API Server</strong></td></tr></tbody></table><hr><p><strong>⚡一句话：</strong></p><ul><li><strong>云上扩容 → 控制台点几下，节点自动加进来</strong>。</li><li>二进制扩容 → 自己装 kubelet/kube-proxy/网络插件，搞证书，搞 etcd/LB。</li></ul><h2 id="七、k8s有几种探针以及区别-探针失败了-k8s-会咋样"><a href="#七、k8s有几种探针以及区别-探针失败了-k8s-会咋样" class="headerlink" title="七、k8s有几种探针以及区别 探针失败了 k8s 会咋样"></a>七、k8s有几种探针以及区别 探针失败了 k8s 会咋样</h2><p><strong>exec TCPSoket HTTPGet</strong></p><p>**在 Kubernetes 里 **<strong>Pod 的健康检查</strong>是靠 <strong>探针 (Probe)</strong> 实现的，一共有三种：</p><h3 id="1-探针类型"><a href="#1-探针类型" class="headerlink" title="1. 探针类型"></a>1. 探针类型</h3><h4 id="✅-Liveness-Probe（存活探针）"><a href="#✅-Liveness-Probe（存活探针）" class="headerlink" title="✅ Liveness Probe（存活探针）"></a>✅ Liveness Probe（存活探针）</h4><ul><li><strong>作用</strong>：判断容器是否“还活着”。</li><li><strong>失败时行为</strong>：kubelet 会 <strong>杀掉容器并重启</strong>（遵循 <code>restartPolicy</code>）。</li><li><strong>典型用途</strong>：容器进程卡死、死循环、死锁时，用它来自动重启恢复。<br><strong>例子</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">livenessProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /healthz</span><br><span class="line">    port: 8080</span><br><span class="line">  initialDelaySeconds: 10</span><br><span class="line">  periodSeconds: 5</span><br></pre></td></tr></table></figure></li></ul><p><strong>解释：</strong></p><ul><li><strong>容器启动后 10 秒开始检测。</strong></li><li>**每 5 秒检查一次 **<code>/healthz</code> 接口。</li><li><strong>如果接口连续失败，k8s 会重启容器。</strong></li></ul><h3 id="2-Readiness-Probe（就绪探针）"><a href="#2-Readiness-Probe（就绪探针）" class="headerlink" title="2. Readiness Probe（就绪探针）"></a>2. <strong>Readiness Probe（就绪探针）</strong></h3><ul><li><strong>作用</strong>：检查容器是否 <strong>准备好接收流量</strong>。</li><li><strong>行为</strong>：如果 Readiness 探针失败，Pod 会 <strong>从 Service 的 Endpoints 中移除</strong>，不会被流量路由到。</li><li><strong>典型场景</strong>：应用启动慢，或者加载了大数据才真正可用。</li></ul><p><strong>示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">readinessProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /ready</span><br><span class="line">    port: 8080</span><br><span class="line">  initialDelaySeconds: 5</span><br><span class="line">  periodSeconds: 5</span><br></pre></td></tr></table></figure><p><strong>解释：</strong></p><ul><li>**容器启动 5 秒后开始检查 **<code>/ready</code> 接口。</li><li><strong>接口失败则表示容器暂时不接收流量，但不会被重启。</strong></li></ul><h3 id="3-Startup-Probe（启动探针）"><a href="#3-Startup-Probe（启动探针）" class="headerlink" title="3. Startup Probe（启动探针）"></a>3. <strong>Startup Probe（启动探针）</strong></h3><ul><li><strong>作用</strong>：用于检测 <strong>容器启动是否成功</strong>，适用于启动慢的应用。</li><li><strong>行为</strong>：<ul><li>**在容器启动阶段，Startup Probe 失败会 **<strong>直接重启容器</strong>。</li><li><strong>启动完成后，Startup Probe 会停止工作，交给 Liveness Probe 监控。</strong></li></ul></li><li><strong>典型场景</strong>：Java、数据库等启动很慢的服务。</li></ul><p><strong>例子</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">startupProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /healthz</span><br><span class="line">    port: 8080</span><br><span class="line">  failureThreshold: 30</span><br><span class="line">  periodSeconds: 10</span><br></pre></td></tr></table></figure><p><strong>解释：</strong></p><ul><li>**每 10 秒检查一次 **<code>/healthz</code>。</li><li><strong>连续失败 30 次才重启容器，适合启动时间较长的应用。</strong></li></ul><hr><h3 id="4-区别总结表"><a href="#4-区别总结表" class="headerlink" title="4. 区别总结表"></a>4. 区别总结表</h3><table><thead><tr><th><strong>探针类型</strong></th><th><strong>触发动作</strong></th><th><strong>典型用途</strong></th></tr></thead><tbody><tr><td><strong>Liveness</strong></td><td><strong>失败 → 容器重启</strong></td><td><strong>死锁、进程挂掉</strong></td></tr><tr><td><strong>Readiness</strong></td><td><strong>失败 → Pod 从 Service 移除</strong></td><td><strong>应用暂时不可用</strong></td></tr><tr><td><strong>Startup</strong></td><td><strong>失败 → 容器重启（仅启动阶段）</strong></td><td><strong>启动慢的应用</strong></td></tr></tbody></table><hr><h3 id="5-举例说明容器探针失败后的行为"><a href="#5-举例说明容器探针失败后的行为" class="headerlink" title="5. 举例说明容器探针失败后的行为"></a>5. 举例说明容器探针失败后的行为</h3><p><strong>假设我们有一个 Nginx 容器：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">- name: nginx</span><br><span class="line">  image: nginx</span><br><span class="line">  livenessProbe:</span><br><span class="line">    httpGet:</span><br><span class="line">      path: /healthz</span><br><span class="line">      port: 80</span><br><span class="line">    initialDelaySeconds: 5</span><br><span class="line">    periodSeconds: 2</span><br></pre></td></tr></table></figure><ul><li>**如果 **<code>/healthz</code> 接口返回非 200，连续失败：<ul><li><strong>k8s 会杀掉 nginx 容器并重启。</strong></li></ul></li><li><strong>如果我们加了 Readiness Probe：</strong><ul><li><strong>Pod 会暂时被 Service 下线，不会被访问，直到探针恢复。</strong></li></ul></li></ul><h2 id="八、k8s组件总览"><a href="#八、k8s组件总览" class="headerlink" title="八、k8s组件总览"></a>八、k8s组件总览</h2><h3 id="1️⃣-命名空间-资源隔离相关"><a href="#1️⃣-命名空间-资源隔离相关" class="headerlink" title="1️⃣ 命名空间 / 资源隔离相关"></a>1️⃣ <strong>命名空间 / 资源隔离相关</strong></h3><ul><li><strong>Namespace（命名空间）</strong>：Kubernetes 内置，用于逻辑隔离资源。</li><li><strong>NetworkPolicy</strong>：控制 Pod 间网络访问策略，实现隔离。</li><li><strong>RBAC（Role/ClusterRole）</strong>：权限隔离。</li><li><strong>ResourceQuota / LimitRange</strong>：资源使用隔离。</li></ul><blockquote><p><strong>类似 “ns” 的概念，主要是做逻辑分组、隔离和权限控制。</strong></p></blockquote><hr><h3 id="2️⃣-服务发现-DNS"><a href="#2️⃣-服务发现-DNS" class="headerlink" title="2️⃣ 服务发现 / DNS"></a>2️⃣ <strong>服务发现 / DNS</strong></h3><ul><li><strong>CoreDNS</strong>：<ul><li><strong>默认集群 DNS 组件。</strong></li><li>**为 Pod 提供 **<code>service-name.namespace.svc.cluster.local</code> 解析。</li></ul></li><li><strong>kube-dns</strong>（旧版，已被 CoreDNS 替代）。</li><li><strong>ExternalDNS</strong>：<ul><li><strong>将 Kubernetes Service 的域名自动同步到外部 DNS（如 Route53、阿里云 DNS）。</strong></li></ul></li></ul><blockquote><p>**核心功能是名字解析和服务发现，类似 Linux 下的 **<code>nslookup</code> / <code>hosts</code> 功能，但在集群内部自动化。</p></blockquote><hr><h3 id="3️⃣-网络-CNI-相关"><a href="#3️⃣-网络-CNI-相关" class="headerlink" title="3️⃣ 网络 / CNI 相关"></a>3️⃣ <strong>网络 / CNI 相关</strong></h3><ul><li><strong>CNI 插件</strong>（Container Network Interface）：<ul><li><strong>Calico</strong>：提供网络策略和安全组功能。</li><li><strong>Flannel</strong>：简单的 L2/L3 网络实现。</li><li><strong>Weave Net</strong>：支持加密和跨节点 Pod 通信。</li><li><strong>Cilium</strong>：基于 eBPF 的高级网络和安全策略。</li></ul></li><li><strong>kube-proxy</strong>：<ul><li><strong>实现 ClusterIP、Service 负载均衡。</strong></li></ul></li></ul><blockquote><p><strong>这些组件都和 Pod 通信、网络路由、服务发现有关系。</strong></p></blockquote><hr><h3 id="4️⃣-配置-配置管理"><a href="#4️⃣-配置-配置管理" class="headerlink" title="4️⃣ 配置 / 配置管理"></a>4️⃣ <strong>配置 / 配置管理</strong></h3><ul><li><strong>ConfigMap</strong>：管理非敏感配置信息。</li><li><strong>Secret</strong>：管理敏感信息（密码、证书）。</li><li><strong>ServiceAccount / Token</strong>：提供 Pod 对 API Server 的访问凭证。</li></ul><blockquote><p><strong>配置、密钥、访问控制也是“命名和资源管理”的一部分。</strong></p></blockquote><hr><h3 id="5️⃣-高级服务发现-服务网格"><a href="#5️⃣-高级服务发现-服务网格" class="headerlink" title="5️⃣ 高级服务发现 / 服务网格"></a>5️⃣ <strong>高级服务发现 / 服务网格</strong></h3><ul><li><strong>Istio / Linkerd / Consul</strong>：<ul><li><strong>提供微服务间流量管理、服务发现、可观测性。</strong></li><li><strong>结合 Envoy 代理实现 L7 层流量控制。</strong></li></ul></li></ul><hr><p><strong>💡 总结：</strong> ** “类似 **<code>ns</code> 的组件”，可以理解为 <strong>命名、隔离、发现、路由</strong>相关的系统组件，主要包括：</p><ul><li><strong>命名空间、RBAC、资源配额（隔离）</strong></li><li><strong>CoreDNS / kube-dns / ExternalDNS（服务发现）</strong></li><li><strong>CNI 插件、kube-proxy（网络和路由）</strong></li><li><strong>配置管理组件（ConfigMap / Secret）</strong></li><li><strong>高级服务网格（Istio / Consul / Linkerd）</strong></li></ul><h2 id="九、Deployment-StatefulSet-有状态的和无状态的服务之间的区别"><a href="#九、Deployment-StatefulSet-有状态的和无状态的服务之间的区别" class="headerlink" title="九、Deployment  StatefulSet 有状态的和无状态的服务之间的区别"></a>九、Deployment  StatefulSet 有状态的和无状态的服务之间的区别</h2><p>**在 **<strong>Kubernetes</strong> 中，<code>Deployment</code> 和 <code>StatefulSet</code> 是两种常见的 <strong>工作负载控制器</strong>，主要用于管理 <strong>无状态服务</strong> 和 <strong>有状态服务</strong>。它们的区别主要体现在以下几个方面：</p><hr><h3 id="1-适用场景"><a href="#1-适用场景" class="headerlink" title="1. 适用场景"></a>1. <strong>适用场景</strong></h3><ul><li><strong>Deployment（无状态服务）</strong><ul><li>**用于 **<strong>无状态应用</strong>，比如 Nginx、前端应用、微服务 API、负载均衡器等。</li><li><strong>每个 Pod 都是相同的，之间没有身份差异，随时可替换或扩缩容。</strong></li></ul></li><li><strong>StatefulSet（有状态服务）</strong><ul><li>**用于 **<strong>有状态应用</strong>，比如 MySQL、Redis（主从）、Zookeeper、Kafka、Etcd。</li><li>**每个 Pod 都有 **<strong>固定身份</strong>（编号、存储），不能随便替换。</li></ul></li></ul><hr><h3 id="2-Pod-标识（Identity）"><a href="#2-Pod-标识（Identity）" class="headerlink" title="2. Pod 标识（Identity）"></a>2. <strong>Pod 标识（Identity）</strong></h3><ul><li><strong>Deployment</strong><ul><li><strong>Pod 名称是随机的，比如：</strong><code>nginx-5c9c7d8c9f-abc12</code>。</li><li><strong>删除一个 Pod，再起的新 Pod 名字不同。</strong></li><li>**所有 Pod **<strong>对外是一样的</strong>。</li></ul></li><li><strong>StatefulSet</strong><ul><li><strong>Pod 有固定的编号，比如：</strong><code>mysql-0</code>, <code>mysql-1</code>, <code>mysql-2</code>。</li><li>**删除 **<code>mysql-1</code> 后，新建的 Pod 还是 <code>mysql-1</code>。</li><li><strong>Pod 之间有顺序和唯一身份。</strong></li></ul></li></ul><hr><h3 id="3-存储（Storage）"><a href="#3-存储（Storage）" class="headerlink" title="3. 存储（Storage）"></a>3. <strong>存储（Storage）</strong></h3><ul><li><strong>Deployment</strong><ul><li>**一般配合 **<strong>临时存储（emptyDir）</strong> 或共享存储。</li><li><strong>Pod 删除后数据也会丢失。</strong></li></ul></li><li><strong>StatefulSet</strong><ul><li>**支持 **<strong>稳定的持久化存储（PVC）</strong>，通常由 <code>volumeClaimTemplates</code> 生成。</li><li><strong>即使 Pod 被删除或迁移，数据依然会保留，并重新挂载到同编号的 Pod 上。</strong></li></ul></li></ul><hr><h3 id="4-启动顺序与依赖"><a href="#4-启动顺序与依赖" class="headerlink" title="4. 启动顺序与依赖"></a>4. <strong>启动顺序与依赖</strong></h3><ul><li><strong>Deployment</strong><ul><li>**Pod 可以 **<strong>无序并行启动</strong>，因为它们没有依赖关系。</li></ul></li><li><strong>StatefulSet</strong><ul><li>**Pod 有顺序：先启动 **<code>pod-0</code>，再启动 <code>pod-1</code>……</li><li>**删除时也是 **<strong>逆序删除</strong>。</li><li>**适合需要 **<strong>主从/集群初始化</strong> 的场景。</li></ul></li></ul><hr><h3 id="5-网络标识（DNS）"><a href="#5-网络标识（DNS）" class="headerlink" title="5. 网络标识（DNS）"></a>5. <strong>网络标识（DNS）</strong></h3><ul><li><strong>Deployment</strong><ul><li><strong>Pod 的 DNS 名字是随机的，只能通过 Service 访问。</strong></li></ul></li><li><strong>StatefulSet</strong><ul><li><strong>每个 Pod 都有稳定的 DNS 名字：</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;pod-name&gt;.&lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local</span><br><span class="line">比如：mysql-0.mysql.default.svc.cluster.local</span><br></pre></td></tr></table></figure></li><li><strong>方便应用之间直接通过固定域名访问。</strong></li></ul></li></ul><hr><h3 id="6-典型使用场景"><a href="#6-典型使用场景" class="headerlink" title="6. 典型使用场景"></a>6. <strong>典型使用场景</strong></h3><ul><li><strong>Deployment（无状态）</strong><ul><li><strong>Web 服务（Nginx、Tomcat）</strong></li><li><strong>API 服务</strong></li><li><strong>静态内容服务</strong></li></ul></li><li><strong>StatefulSet（有状态）</strong><ul><li><strong>数据库（MySQL、Postgres、MongoDB）</strong></li><li><strong>分布式协调服务（ZooKeeper、Etcd、Consul）</strong></li><li><strong>消息队列（Kafka、RabbitMQ）</strong></li></ul></li></ul><hr><h3 id="📌-总结一句话"><a href="#📌-总结一句话" class="headerlink" title="📌 总结一句话"></a>📌 总结一句话</h3><ul><li>**如果应用 **<strong>不依赖持久存储、Pod 身份、启动顺序</strong> → 用 <strong>Deployment</strong>。</li><li>**如果应用 **<strong>需要固定身份、稳定存储、顺序启动</strong> → 用 <strong>StatefulSet</strong>。</li></ul><h2 id="十、yaml方式介绍deploy有哪些组件"><a href="#十、yaml方式介绍deploy有哪些组件" class="headerlink" title="十、yaml方式介绍deploy有哪些组件"></a>十、yaml方式介绍deploy有哪些组件</h2><p>qexo</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前置准备</span></span><br><span class="line"><span class="comment"># 设置污点</span></span><br><span class="line"><span class="comment"># kubectl taint nodes k8s1 tag=heima:NoExecute</span></span><br><span class="line"><span class="comment"># # 去除污点</span></span><br><span class="line"><span class="comment"># kubectl taint nodes k8s1 tag:NoExecute-</span></span><br><span class="line"><span class="comment"># # 例子</span></span><br><span class="line"><span class="comment"># kubectl taint nodes gegewu node-role.kubernetes.io/control-plane:NoSchedule-</span></span><br><span class="line"><span class="comment"># # 查看污点设置是否成功</span></span><br><span class="line"><span class="comment"># kubectl describe nodes |grep Taints</span></span><br><span class="line"><span class="comment"># # Taints:             tag=heima:NoExecute</span></span><br><span class="line"><span class="comment"># # Taints:             &lt;none&gt;</span></span><br><span class="line"><span class="comment"># # 设置节点标签</span></span><br><span class="line"><span class="comment"># kubectl label nodes k8s1 nodeenv=pro</span></span><br><span class="line"><span class="comment"># kubectl get nodes --show-labels</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qexo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>         <span class="comment"># 修改为3副本</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 定义滚动更新</span></span><br><span class="line">  <span class="comment"># ● 重建更新 Recreate: 在创建出该label下新的Pod之前会先杀掉所有已存在的Pod</span></span><br><span class="line">  <span class="comment"># ● 滚动更新: 可以通过strategy指定策略类型, 支持两个属性</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">3</span>      <span class="comment"># 保留历史版本，是为了版本回退</span></span><br><span class="line">  <span class="attr">paused:</span> <span class="literal">false</span>                <span class="comment"># 暂停部署，默认是false 即创建完deploy立即开始部署pod</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span> <span class="comment"># 部署超时时间（s），默认是600</span></span><br><span class="line">  <span class="attr">strategy:</span>                    <span class="comment"># 策略</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span>        <span class="comment"># 滚动更新策略 或 Recreate 重建更新</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span>             <span class="comment"># 滚动更新</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span>            <span class="comment"># 在更新过程中，最多可以增加的 Pod 数量</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">30</span><span class="string">%</span>      <span class="comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 重建更新（另一种方式）</span></span><br><span class="line">  <span class="comment"># strategy:</span></span><br><span class="line">  <span class="comment">#   type: Recreate</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">qexo</span>   <span class="comment"># 必须与 .spec.template.metadata.labels 匹配</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">qexo</span> <span class="comment"># 必须与 .spec.selector.matchLabels 匹配</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qexo</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:qexo-3.6.0</span> </span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">qexo</span></span><br><span class="line">        <span class="comment"># command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do /bin/echo $(date +%T);sleep 60; done;&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境变量</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;username&quot;</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;password&quot;</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 资源配额</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span>    <span class="comment"># 限制资源（上限）</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span> <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;10Gi&quot;</span> <span class="comment"># 内存限制</span></span><br><span class="line">          <span class="attr">requests:</span>        <span class="comment"># 请求资源（下限）</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span>       <span class="comment"># CPU请求，单位是core数</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1000Mi&quot;</span> <span class="comment"># 内存请求 </span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 磁盘挂载</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qexo-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/app/db</span>   <span class="comment"># 挂载到目录而不是单个文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 勾子函数</span></span><br><span class="line">        <span class="comment"># ● post start：容器创建之后执行，如果失败了会重启容器</span></span><br><span class="line">        <span class="comment"># ● pre stop ：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</span></span><br><span class="line">        <span class="comment"># 钩子处理器支持使用下面三种方式定义动作：</span></span><br><span class="line">        <span class="comment"># ● Exec命令：在容器内执行一次命令</span></span><br><span class="line">        <span class="comment"># ● 相当于 docker 中 docker exec -it centos ls 这样的命令</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># lifecycle:</span></span><br><span class="line">        <span class="comment">#   postStart:</span></span><br><span class="line">        <span class="comment">#     exec: # 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span></span><br><span class="line">        <span class="comment">#       command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo postStart... &gt; /usr/share/nginx/html/index.html&quot;]</span></span><br><span class="line">        <span class="comment">#   preStop:</span></span><br><span class="line">        <span class="comment">#     exec: # 在容器停止之前停止nginx服务</span></span><br><span class="line">        <span class="comment">#       command: [&quot;/usr/sbin/nginx&quot;,&quot;-s&quot;,&quot;quit&quot;]  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器探针</span></span><br><span class="line">        <span class="comment"># ● liveness probes：存活性探针，用于检测应用实例是否存活，如果不是，k8s会重启容器</span></span><br><span class="line">        <span class="comment"># ● readiness probes：就绪性探针，用于检测实例是否可以接收请求，如果不能，k8s不会转发流量</span></span><br><span class="line">        <span class="comment"># ● livenessProbe 决定是否重启容器，readinessProbe 决定是否将请求转发给容器</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 上面两种探针支持三种探测方式：</span></span><br><span class="line">        <span class="comment"># ● Exec命令、● HTTP请求、● TCP Socket</span></span><br><span class="line">        <span class="comment"># livenessProbe:</span></span><br><span class="line">        <span class="comment">#   httpGet:       # 实际就是访问 http://127.0.0.1:8000/</span></span><br><span class="line">        <span class="comment">#     scheme: HTTP # 协议，http 或 https</span></span><br><span class="line">        <span class="comment">#     port: 8000   # 端口号</span></span><br><span class="line">        <span class="comment">#     path: /      # URI地址</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">tcpSocket:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8000</span> <span class="comment"># 尝试访问8080端口</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 宿主机挂载目录（不存在就创建）</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qexo-volume</span></span><br><span class="line">        <span class="attr">hostPath:</span> </span><br><span class="line">          <span class="attr">path:</span> <span class="string">/opt/qexo/app/db</span>    <span class="comment"># 宿主机目录  </span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span>              </span><br><span class="line"></span><br><span class="line">      <span class="comment"># 污点与容忍</span></span><br><span class="line">      <span class="comment"># ● PreferNoSchedule：尽量避免调度，但非强制</span></span><br><span class="line">      <span class="comment"># ● NoSchedule：不会调度到带此污点的节点，但已有Pod不受影响</span></span><br><span class="line">      <span class="comment"># ● NoExecute：不会调度，并驱逐已有Pod</span></span><br><span class="line">      <span class="comment"># 如果污点的效果是NoExecute，需在容忍规则中设置 effect: &quot;NoExecute&quot;</span></span><br><span class="line">      <span class="comment"># 也可以省略 effect，用 operator: &quot;Exists&quot; 容忍任意效果</span></span><br><span class="line">      <span class="attr">tolerations:</span>    </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;tag&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 亲和性设置(软限制)</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 软限制</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">preference:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span> <span class="comment"># 匹配 nodeenv 标签的值在 [&quot;pro&quot;,&quot;yyy&quot;] 中的节点</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span> [<span class="string">&quot;pro&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 亲和性设置(硬限制)</span></span><br><span class="line">      <span class="comment"># affinity:</span></span><br><span class="line">      <span class="comment">#   podAffinity: # 设置pod亲和性</span></span><br><span class="line">      <span class="comment">#     requiredDuringSchedulingIgnoredDuringExecution: # 硬限制</span></span><br><span class="line">      <span class="comment">#     - labelSelector:</span></span><br><span class="line">      <span class="comment">#         matchExpressions:    # 匹配podenv的值在 [&quot;xxx&quot;,&quot;yyy&quot;] 的标签</span></span><br><span class="line">      <span class="comment">#         - key: podenv</span></span><br><span class="line">      <span class="comment">#           operator: In</span></span><br><span class="line">      <span class="comment">#           values: [&quot;xxx&quot;,&quot;yyy&quot;]</span></span><br><span class="line">      <span class="comment">#       topologyKey: kubernetes.io/hostname  # 基于节点调度</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 暴露qexo端口</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qexo-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">qexo</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># 将服务暴露为 NodePort 类型</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>nginx</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前置准备</span></span><br><span class="line"><span class="comment"># 设置污点</span></span><br><span class="line"><span class="comment"># kubectl taint nodes k8s1 tag=heima:NoExecute</span></span><br><span class="line"><span class="comment"># # 去除污点</span></span><br><span class="line"><span class="comment"># kubectl taint nodes k8s1 tag:NoExecute-</span></span><br><span class="line"><span class="comment"># # 例子</span></span><br><span class="line"><span class="comment"># kubectl taint nodes gegewu node-role.kubernetes.io/control-plane:NoSchedule-</span></span><br><span class="line"><span class="comment"># # 查看污点设置是否成功</span></span><br><span class="line"><span class="comment"># kubectl describe nodes |grep Taints</span></span><br><span class="line"><span class="comment"># # Taints:             tag=heima:NoExecute</span></span><br><span class="line"><span class="comment"># # Taints:             &lt;none&gt;</span></span><br><span class="line"><span class="comment"># # 设置节点标签</span></span><br><span class="line"><span class="comment"># kubectl label nodes k8s1 nodeenv=pro</span></span><br><span class="line"><span class="comment"># kubectl get nodes --show-labels</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  <span class="comment"># 版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>     <span class="comment"># 类型</span></span><br><span class="line"><span class="attr">metadata:</span>            <span class="comment"># 源数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy-nginx</span> <span class="comment"># 当前deployment所属的名字</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>     <span class="comment"># 命名空间</span></span><br><span class="line">  <span class="attr">labels:</span>            <span class="comment"># 当前deploy的标签</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;label-test&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 此栏目配置滚动更新配置</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>        <span class="comment"># 定义副本数</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 定义滚动更新</span></span><br><span class="line">  <span class="comment"># ● 重建更新Recreate  在创建出该label下新的Pod之前会先杀掉所有已存在的Pod</span></span><br><span class="line">  <span class="comment"># ● 滚动更新,可以通过strategy指定策略类型,支持两个属性:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">3</span>      <span class="comment"># 保留历史版本 是为了版本回退</span></span><br><span class="line">  <span class="attr">paused:</span> <span class="literal">false</span>                <span class="comment"># 暂停部署，默认是false 即创建完deploy立即开始部署pod</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span> <span class="comment"># 部署超时时间（s），默认是600</span></span><br><span class="line">  <span class="attr">strategy:</span>                    <span class="comment"># 策略</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span>        <span class="comment"># 滚动更新策略 或Recreate重建更新</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span>             <span class="comment"># 滚动更新</span></span><br><span class="line">      <span class="comment"># 违规词汇: 30%  # 最大额外可以存在的副本数，可以为百分比，也可以为整数</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span>            <span class="comment"># 在更新过程中，最多可以增加的 Pod 数量</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">30</span><span class="string">%</span>      <span class="comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 重建更新</span></span><br><span class="line">  <span class="comment">#strategy: # 策略</span></span><br><span class="line">    <span class="comment">#type: Recreate # 重建更新</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">selector:</span>        <span class="comment"># 标签选择器 选择标签进行操作</span></span><br><span class="line">    <span class="attr">matchLabels:</span>   <span class="comment"># 选择nginx标签</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">label-test</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">template:</span>                   <span class="comment"># 以下为pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span>                 <span class="comment"># 标签</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">label-test</span>   <span class="comment"># 定义标签为label-test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 镜像信息等</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-test</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span> <span class="comment"># 用于设置镜像拉取策略</span></span><br><span class="line">        <span class="comment"># cmd变量与端口</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;while true;do /bin/echo $(date +%T);sleep 60; done;&quot;</span>]</span><br><span class="line">        <span class="attr">env:</span>                     <span class="comment"># 设置环境变量列表</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;username&quot;</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;password&quot;</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line">        <span class="comment"># 资源配额</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span>    <span class="comment"># 限制资源（上限）</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span> <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;10Gi&quot;</span> <span class="comment"># 内存限制</span></span><br><span class="line">          <span class="attr">requests:</span>        <span class="comment"># 请求资源（下限）</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span>       <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;10Mi&quot;</span> <span class="comment"># 内存限制</span></span><br><span class="line">        <span class="comment"># 勾子函数</span></span><br><span class="line">        <span class="attr">lifecycle:</span></span><br><span class="line">          <span class="attr">postStart:</span></span><br><span class="line">            <span class="attr">exec:</span> <span class="comment"># 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span></span><br><span class="line">              <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo postStart... &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">          <span class="attr">preStop:</span></span><br><span class="line">            <span class="attr">exec:</span> <span class="comment"># 在容器停止之前停止nginx服务</span></span><br><span class="line">              <span class="attr">command:</span> [<span class="string">&quot;/usr/sbin/nginx&quot;</span>,<span class="string">&quot;-s&quot;</span>,<span class="string">&quot;quit&quot;</span>]</span><br><span class="line"></span><br><span class="line">      <span class="comment"># nodeName: node1  # 定向调度</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># ● PreferNoSchedule：kubernetes将尽量避免把Pod调度到具有该污点的Node上，除非没有其他节点可调度</span></span><br><span class="line">      <span class="comment"># ● NoSchedule：kubernetes将不会把Pod调度到具有该污点的Node上，但不会影响当前Node上已存在的Pod</span></span><br><span class="line">      <span class="comment"># ● NoExecute：kubernetes将不会把Pod调度到具有该污点的Node上，同时也会将Node上已存在的Pod驱离</span></span><br><span class="line">      <span class="comment"># tag=heima:NoExecute</span></span><br><span class="line">      <span class="comment"># 如果污点的效果是NoExecute，那么您需要在容忍规则中设置effect: &quot;NoExecute&quot;。</span></span><br><span class="line">      <span class="comment"># 如果污点的效果不确定，也可以省略effect字段，用operator: &quot;Exists&quot;来容忍任何效果。例如：</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">tolerations:</span>        <span class="comment"># 添加容忍</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;tag&quot;</span>        <span class="comment"># 要容忍的污点的key</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span> <span class="comment"># 操作符（等于操作符）</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;heima&quot;</span>    <span class="comment"># 容忍的污点的value</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span>   <span class="comment"># 添加容忍的规则，这里必须和标记的污点规则相同</span></span><br><span class="line">  </span><br><span class="line">      <span class="comment"># 容忍任何效果</span></span><br><span class="line">      <span class="comment">#- key: &quot;tag&quot;</span></span><br><span class="line">      <span class="comment">#  operator: &quot;Exists&quot;</span></span><br><span class="line">      <span class="comment"># 亲和性设置(软限制)</span></span><br><span class="line">  </span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span> <span class="comment"># 设置node亲和性</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 软限制</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">preference:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span> <span class="comment"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签(当前环境没有)</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span> [<span class="string">&quot;pro&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br><span class="line"></span><br><span class="line">      <span class="comment"># # 亲和性设置(硬限制)</span></span><br><span class="line">      <span class="comment"># affinity:</span></span><br><span class="line">      <span class="comment">#   podAffinity: # 设置pod亲和性</span></span><br><span class="line">      <span class="comment">#     requiredDuringSchedulingIgnoredDuringExecution: # 硬限制</span></span><br><span class="line">      <span class="comment">#     - labelSelector:</span></span><br><span class="line">      <span class="comment">#         matchExpressions:    # 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span><br><span class="line">      <span class="comment">#         - key: podenv</span></span><br><span class="line">      <span class="comment">#           operator: In</span></span><br><span class="line">      <span class="comment">#           values: [&quot;xxx&quot;,&quot;yyy&quot;]</span></span><br><span class="line">      <span class="comment">#       topologyKey: kubernetes.io/hostname  # 基于节点调度</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>~</p>]]></content>
      
      
      <categories>
          
          <category> 明月策 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 明月策 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openstack常用命令</title>
      <link href="/2025/08/04/openstack%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
      <url>/2025/08/04/openstack%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="openstack常用命令"><a href="#openstack常用命令" class="headerlink" title="openstack常用命令"></a>openstack常用命令</h1><h2 id="各个组件命令总结"><a href="#各个组件命令总结" class="headerlink" title="各个组件命令总结"></a>各个组件命令总结</h2><p><strong>概览：</strong></p><ul><li><strong>openstack domain list   查看目前的域</strong></li><li><strong>openstack domain create –description “An Example Domain” example  创建新域</strong></li><li><strong>openstack project create –domain default –description “Demo Project” myproject   创建普通项目</strong></li></ul><h3 id="零、创建-service-项目、user-角色、域，default-域默认已经存在"><a href="#零、创建-service-项目、user-角色、域，default-域默认已经存在" class="headerlink" title="零、创建 service 项目、user 角色、域，default 域默认已经存在"></a>零、创建 service 项目、user 角色、域，default 域默认已经存在</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看目前的域</span></span><br><span class="line">openstack domain list</span><br><span class="line"><span class="comment"># 创建新域 example，（仅用于测试，可以不创建）。</span></span><br><span class="line">openstack domain create --description <span class="string">&quot;An Example Domain&quot;</span> example </span><br><span class="line">openstack domain list</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/8/image_88b40ebcc3e0853bf68b6b2f99f43e5c.png"></p><p>创建普通项目 myproject（仅用于测试，可以不创建）。 </p><p>一个租户在 OpenStack 里就是一个项目，创建用户时必须先要有租户（项目），同时还需要一个能分配给该用户的角色，这样创建的用户才有意义。 </p><p><strong>创建 service 项目（租户），service 项目将作为 OpenStack 的系统项目，所有系统服务都要加入到 service 项目中。</strong></p><hr><h3 id="一、项目与角色"><a href="#一、项目与角色" class="headerlink" title="一、项目与角色"></a>一、<strong>项目与角色</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 创建普通项目</span><br><span class="line">openstack project create --domain default --description &quot;Demo Project&quot; myproject</span><br><span class="line"># 创建普通用户 myuser（仅用于测试，可以不创建），密码为 myuser。 </span><br><span class="line"> openstack user create --domain default --password-prompt myuser</span><br><span class="line"># 创建角色（仅用于测试，可以不创建）</span><br><span class="line">openstack role create myrole</span><br><span class="line"># 将 myrole 角色添加到 myproject 项目和 myuser 用户（仅用于测试，可以不创建）。</span><br><span class="line">openstack role add --project myproject --user myuser myrole</span><br><span class="line"></span><br><span class="line"># 实际创建用户</span><br><span class="line">openstack user create --domain default --password SKYLINE_PASS  skyline </span><br><span class="line"># 加入admin权限</span><br><span class="line">openstack role add --project service --user skyline admin </span><br><span class="line">   </span><br><span class="line"># 查看角色权限</span><br><span class="line">openstack role list</span><br><span class="line"># 查看用户</span><br><span class="line">openstack user list</span><br><span class="line"># 查看目前的项目</span><br><span class="line">openstack project list</span><br><span class="line"># 查看当前认证用户的 Token 和相关认证信息</span><br><span class="line">openstack token issue</span><br><span class="line"># 列出 keystone 服务中的 API 端点以验证与 Identity 服务的连接。</span><br><span class="line">openstack catalog list</span><br><span class="line">#  查看镜像</span><br><span class="line">openstack image list</span><br><span class="line"># 查看实例类型</span><br><span class="line">openstack flavor list</span><br></pre></td></tr></table></figure><p>📌 openstack token issue 作用说明</p><p>当你运行 <strong><code>openstack token issue</code> 时，它会向 Keystone 认证服务发送请求，然后返回一个包含用户认证详情的响应，</strong>主要用于验证当前环境变量（如用户名、密码、项目等）是否配置正确**。</p><h3 id="二、查看服务"><a href="#二、查看服务" class="headerlink" title="二、查看服务"></a>二、查看服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有组件</span><br><span class="line">openstack service list</span><br><span class="line"># 查看计算服务组件</span><br><span class="line">openstack compute service list</span><br><span class="line"># 查看已注册的计算节点</span><br><span class="line">openstack compute service list --service nova-compute</span><br><span class="line"># 查看某一个服务</span><br><span class="line">openstack volume service list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 等同nova命令</span><br><span class="line">nova service-list | grep nova-compute</span><br></pre></td></tr></table></figure><h3 id="三、查看实例"><a href="#三、查看实例" class="headerlink" title="三、查看实例"></a>三、查看实例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 查看实例列表</span><br><span class="line">openstack server list </span><br><span class="line"># 查看某一个实例的详细信息 </span><br><span class="line">openstack server show d032241e-0bed-412</span><br><span class="line"></span><br><span class="line"># 查看实例操作记录</span><br><span class="line">openstack server event list  93a08381-b1be-4cec-9284-e48ece60cabb</span><br><span class="line"># nova命令操作方式（可以看到requestid）</span><br><span class="line">nova instance-action-list 93a08381-b1be-4cec-9284-e48ece60cabb</span><br><span class="line"></span><br><span class="line"># 登录实例 </span><br><span class="line">virsh console instance-00000001</span><br><span class="line"></span><br><span class="line"># 手动删除实例</span><br><span class="line">说明：使用 virsh console 登录实例后如何退出实例：直接按 Ctrl + ] 组合键 </span><br><span class="line"># 关闭实例 </span><br><span class="line">openstack server stop vm01 </span><br><span class="line"># 启动实例 </span><br><span class="line">openstack server start vm01 </span><br><span class="line"># 删除所选的实例 </span><br><span class="line">openstack server delete vm01  （或-openstack server delete &lt;虚拟机的ID&gt;）</span><br></pre></td></tr></table></figure><h3 id="四、cinder常用命令"><a href="#四、cinder常用命令" class="headerlink" title="四、cinder常用命令"></a>四、cinder常用命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 创建存储卷</span><br><span class="line">openstack volume create --size 1 volume01</span><br><span class="line"># 说明：创建一个卷名为 volume01 大小为 1GB 的卷</span><br><span class="line"># 查看存储卷列表</span><br><span class="line">openstack volume list</span><br><span class="line"># 为存储卷创建快照</span><br><span class="line">openstack volume snapshot create --volume volume01 snap-volume01</span><br><span class="line"># 说明：为卷 volume01 创建一个名为 snap-volume01 的快照</span><br><span class="line"># 查看快照列表</span><br><span class="line">openstack volume snapshot list</span><br><span class="line"># 挂载卷到实例</span><br><span class="line">nova volume-attach vm01 ead55f47-a0f3-4eb9-854e-9dff638ff534 /dev/vdb</span><br><span class="line"># 说明：挂载卷时，要指定卷 id，此处要指定卷 volume01 的 id，然后是连接到实例 vm01 的/dev/vdb 上</span><br><span class="line"># 虚拟机卸载卷</span><br><span class="line">nova volume-detach vm01 ead55f47-a0f3-4eb9-854e-9dff638ff534</span><br><span class="line"># 说明：卸载卷时，请先在操作系统层停止正在使用要卸载的应用，umount 掉，然后再执行 volume-detach</span><br><span class="line"># 删除所选存储卷</span><br><span class="line">openstack volume snapshot delete snap-volume01</span><br><span class="line">openstack volume delete volume01</span><br><span class="line"># 说明：删除卷要具备 2 个条件，第一个是卷状态是可用(available)或其他而非使用中；第二个就是要删除的卷上没有快照，如果有要先删除快照。</span><br><span class="line">openstack volume show volume01</span><br><span class="line"># 禁用存储节点</span><br><span class="line">openstack volume service set --disable compute02@lvm cinder-volume</span><br><span class="line"># 启用存储节点</span><br><span class="line">openstack volume service set --enable compute02@lvm cinder-volume</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 根据云主机id查询云硬盘</span><br><span class="line">virsh domblklist 17dc79da-2c5c-4691-1855-154618622fa7</span><br><span class="line"># 查看是否到期</span><br><span class="line">cinder get-qos 17dc79da-2c5c-4691-1855-154618622fa7</span><br></pre></td></tr></table></figure><h3 id="五、nova操作"><a href="#五、nova操作" class="headerlink" title="五、nova操作"></a>五、nova操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 查看云主机</span><br><span class="line">nova list</span><br><span class="line"># 详细查看云主机信息</span><br><span class="line">nova show 6ae61de8-b0bd-4567-bf5d-2a151d853fce</span><br><span class="line"># 配置状态为active</span><br><span class="line">nova reset-state --active fdfjfdjgbjgf-fdfkdkvn-fdkfv</span><br><span class="line"># 执行强制删除</span><br><span class="line">nova force-delete fdfjfdjgbjgf-fdfkdkvn-fdkfv</span><br><span class="line"></span><br><span class="line"># 查看服务</span><br><span class="line">nova service-list | grep nova-compute</span><br><span class="line"></span><br><span class="line"># nova命令查看实例操作记录</span><br><span class="line">nova instance-action-list 93a08381-b1be-4cec-9284-e48ece60cabb</span><br></pre></td></tr></table></figure><h3 id="六、-hypervisor使用命令查看资源利用率"><a href="#六、-hypervisor使用命令查看资源利用率" class="headerlink" title="六、 hypervisor使用命令查看资源利用率"></a>六、 hypervisor使用命令查看资源利用率</h3><hr><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 列出所有计算节点</span><br><span class="line">openstack hypervisor list</span><br><span class="line"># 查看单个计算节点的资源使用情况</span><br><span class="line">openstack hypervisor show compute1</span><br><span class="line"># 查看所有计算节点的资源汇总情况</span><br><span class="line">openstack hypervisor stats show</span><br></pre></td></tr></table></figure><h3 id="七、glance镜像操作"><a href="#七、glance镜像操作" class="headerlink" title="七、glance镜像操作"></a>七、glance镜像操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 查看日志拿到镜像uuid（3.0）</span><br><span class="line">grep ctyunos-cii-25.07 /var/lib/docker/volumes/glance-api-6516030_kolla_logs/_data/glance/glance.log</span><br><span class="line"># 通过镜像名称过滤</span><br><span class="line">glance image-list |grep ctyunos-cii-25.07</span><br><span class="line"># 通过日志中的req id过滤</span><br><span class="line">glance task-list |grep 7c91577eec464f4fa960be908ee372ff</span><br><span class="line">--------------------------------------------------------------------</span><br><span class="line">| 8a2dcafb-0fb6-494d-b4c7-98ccac7e8cd4 | import      | failure | 7c91577eec464f4fa960be908ee372ff |</span><br><span class="line">| 0e6538d1-c781-4461-9bf2-c6359325b407 | import      | failure | 7c91577eec464f4fa960be908ee372ff |</span><br><span class="line">| 753be1a9-2528-4b1f-8815-35bdb47892fc | import      | failure | 7c91577eec464f4fa960be908ee372ff |</span><br><span class="line">| 17265974-5cac-4b18-8372-90ff2140a8e4 | import      | failure | 7c91577eec464f4fa960be908ee372ff |</span><br><span class="line">| 2a7eb98c-7594-4960-9d9f-0325a5345cd4 | import      | failure | 7c91577eec464f4fa960be908ee372ff |</span><br><span class="line">| a1645767-807d-4e8b-b1df-6291de2d200b | import      | failure | 7c91577eec464f4fa960be908ee372ff |</span><br><span class="line">| cadc9b91-1646-4525-bdfa-12fbeba73863 | import      | failure | 7c91577eec464f4fa960be908ee372ff |</span><br><span class="line"># 根据回显id过滤查看镜像状态（可以看到报错503）升级研发（镜像id）</span><br><span class="line">glance task-show  8a2dcafb-0fb6-494d-b4c7-98ccac7e8cd4</span><br><span class="line"># 查看镜像详情</span><br><span class="line">glance image-show c83208ae-8dee-49ff-a1f3-3ba292067fea</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"># 查看镜像</span><br><span class="line">openstack image list</span><br><span class="line"># 查看镜像详情</span><br><span class="line">openstack image show  c83208ae-8dee-49ff-a1f3-3ba292067fea</span><br></pre></td></tr></table></figure><h3 id="八、热迁移与冷迁移（3-0）"><a href="#八、热迁移与冷迁移（3-0）" class="headerlink" title="八、热迁移与冷迁移（3.0）"></a>八、热迁移与冷迁移（3.0）</h3><h4 id="热迁移"><a href="#热迁移" class="headerlink" title="热迁移"></a><strong>热迁移</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 查看虚拟机列表信息</span><br><span class="line">nova list </span><br><span class="line"># 查看虚拟机详细信息</span><br><span class="line">nova show demo</span><br><span class="line"># 迁移到compute2</span><br><span class="line">nova live-migration 7d1f1d0f-3afd-45fe-8c7a-07cca49067ad  compute2</span><br><span class="line"># 查看最近五次的迁移记录</span><br><span class="line">nova migration-list --instance-uuid 7d1f1d0f-3afd-45fe-8c7a-07cca49067ad   --limit 5</span><br></pre></td></tr></table></figure><p><strong>新版本</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># f7e9d5dc-0b9c-4d75-bbee-65b3b9b7c2b6实例热迁移到compute2</span><br><span class="line">openstack server migrate --live compute2 --live-migration f7e9d5dc-0b9c-4d75-bbee-65b3b9b7c2b6 --shared-migration</span><br><span class="line"># 查看迁移记录</span><br><span class="line">openstack server migration list --server f7e9d5dc-0b9c-4d75-bbee-65b3b9b7c2b6 --limit 5</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/8/image_99cad43ae50bf12e4cc573902a989e49.png"></p><h4 id="冷迁移（必须要先关闭实例）"><a href="#冷迁移（必须要先关闭实例）" class="headerlink" title="冷迁移（必须要先关闭实例）"></a><strong>冷迁移</strong>（必须要先关闭实例）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 冷迁移实例到 compute2（如果支持指定 host）</span><br><span class="line">nova migrate --host compute2 &lt;server-id&gt;</span><br><span class="line"># 查看状态，变成 VERIFY_RESIZE</span><br><span class="line">openstack server show &lt;server-id&gt;</span><br><span class="line"># 确认变更</span><br><span class="line">nova resize-confirm &lt;server-id&gt;</span><br><span class="line"># 或取消迁移</span><br><span class="line">nova resize-revert &lt;server-id&gt;</span><br><span class="line"></span><br><span class="line"># 关闭虚拟机</span><br><span class="line">nova stop 7d1f1d0f-3afd-45fe-8c7a-07cca49067ad</span><br><span class="line"># 查看是否成功关闭</span><br><span class="line">nova list </span><br><span class="line">nova show 7d1f1d0f-3afd-45fe-8c7a-07cca49067ad</span><br><span class="line"># 开始进行冷迁移 将虚拟机 7d1f1d0f-3afd-45fe-8c7a-07cca49067ad 迁移到compute1</span><br><span class="line">nova migrate --host compute1 7d1f1d0f-3afd-45fe-8c7a-07cca49067ad</span><br><span class="line"># 最后确认迁移变更操作 输入如下命令</span><br><span class="line">nova resize-confirm 7d1f1d0f-3afd-45fe-8c7a-07cca49067ad</span><br><span class="line"># 最后进行开机确认业务即可</span><br><span class="line">nova start 7d1f1d0f-3afd-45fe-8c7a-07cca49067ad</span><br></pre></td></tr></table></figure><p><strong>新版本</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 自动选择节点</span><br><span class="line">openstack server migrate &lt;server-id&gt;</span><br><span class="line"># 手动选择迁移节点</span><br><span class="line">openstack server migrate --host &lt;target-hostname&gt; &lt;server-id&gt;</span><br><span class="line"># 确认迁移</span><br><span class="line">openstack server resize confirm &lt;server-id&gt;</span><br><span class="line"></span><br><span class="line"># 迁移到compute2</span><br><span class="line">openstack server migrate --host compute2 ccef2616-2578-4a08-b2b8-e034a9fc1b8e</span><br><span class="line"># 等待迁移完成（用以下命令查看状态，直到状态变为VERIFY_RESIZE）</span><br><span class="line">openstack server show ccef2616-2578-4a08-b2b8-e034a9fc1b8e</span><br><span class="line"># 确认迁移</span><br><span class="line">openstack server resize confirm ccef2616-2578-4a08-b2b8-e034a9fc1b8e</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/8/image_2ee2420a7eb57dc2f3f23537a2c1e33d.png"></p><h3 id="九、移域"><a href="#九、移域" class="headerlink" title="九、移域"></a>九、移域</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![](https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/8/image_922caf1409b32e8703bb535c64785ef7.png)# 主机聚合3是ceshi1</span><br><span class="line"># 列出所有主机聚合及其相关信息（如 ID、名称、可用域等）</span><br><span class="line">nova aggregate-list</span><br><span class="line"># 查看主机聚合ceshi1`中有哪些计算节点</span><br><span class="line">nova aggregate-show 3</span><br><span class="line"># 从指定的聚合中移除某个计算节点（主机）</span><br><span class="line">nova aggregate-remove-host 3 compute1</span><br><span class="line"># 将compute1再次加入主机聚合3</span><br><span class="line">nova aggregate-add-host 3 compute1</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/8/image_ca1eb239e42e407ae8d85ee44cf420e9.png"></p><h3 id="十、flavor实例类型操作"><a href="#十、flavor实例类型操作" class="headerlink" title="十、flavor实例类型操作"></a>十、flavor实例类型操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 创建实例类型</span><br><span class="line">openstack flavor create --disk 1 --ram 512 --vcpu 1 --id 99999 test0</span><br><span class="line"># 查看实例类型</span><br><span class="line">openstack flavor list</span><br><span class="line"># 查看实例类型详情</span><br><span class="line">openstack flavor show 48ddfdf5-c00d-4681-bcc7-2f6b5d16dd6e</span><br><span class="line"># 删除实例类型</span><br><span class="line">openstack flavor delete 99999</span><br></pre></td></tr></table></figure><h3 id="十一、安全组操作"><a href="#十一、安全组操作" class="headerlink" title="十一、安全组操作"></a>十一、安全组操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 创建安全组</span><br><span class="line">openstack security group create my-security-group --description &quot;My-Security-Group&quot;</span><br><span class="line"># 查看安全组id</span><br><span class="line">openstack security group list</span><br><span class="line"># 添加所有icmp规则入口</span><br><span class="line">openstack security group rule create --protocol icmp --ingress 89a9d87c-03ae-4315-854f-a1c817a2979d</span><br><span class="line"># 添加所有icmp规则出口</span><br><span class="line">openstack security group rule create --protocol icmp --egress  89a9d87c-03ae-4315-854f-a1c817a2979d</span><br><span class="line"># 添加所有udp规则入口</span><br><span class="line">openstack security group rule create --protocol udp --ingress  89a9d87c-03ae-4315-854f-a1c817a2979d</span><br><span class="line"># 添加所有udp规则出口</span><br><span class="line">openstack security group rule create --protocol udp --egress  89a9d87c-03ae-4315-854f-a1c817a2979d</span><br><span class="line"># 添加所有tcp规则入口</span><br><span class="line">openstack security group rule create --protocol tcp --ingress 89a9d87c-03ae-4315-854f-a1c817a2979d</span><br><span class="line"># 添加所有tcp规则出口</span><br><span class="line">openstack security group rule create --protocol tcp --egress  89a9d87c-03ae-4315-854f-a1c817a2979d</span><br><span class="line"># 放通入方向22端口</span><br><span class="line">openstack security group rule create --ingress --protocol tcp --dst-port 22:22 89a9d87c-03ae-4315-854f-a1c817a2979d</span><br><span class="line"># 放通10.0.0.30入方向80端口</span><br><span class="line">openstack security group rule create --ingress --protocol tcp --dst-port 80:80 --remote-ip 10.0.0.30/32 89a9d87c-03ae-4315-854f-a1c817a2979d</span><br><span class="line"># 查看安全组规则</span><br><span class="line">openstack security group rule list 89a9d87c-03ae-4315-854f-a1c817a2979d</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> openstack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu锁文件被占用问题（/var/lib/dpkg/lock-frontend 被 unattended-upgr 进程占用）解决</title>
      <link href="/2025/07/17/ubuntu%E9%94%81%E6%96%87%E4%BB%B6%E8%A2%AB%E5%8D%A0%E7%94%A8%E9%97%AE%E9%A2%98%EF%BC%88/var/lib/dpkg/lock-frontend%20%E8%A2%AB%20unattended-upgr%20%E8%BF%9B%E7%A8%8B%E5%8D%A0%E7%94%A8%EF%BC%89%E8%A7%A3%E5%86%B3/"/>
      <url>/2025/07/17/ubuntu%E9%94%81%E6%96%87%E4%BB%B6%E8%A2%AB%E5%8D%A0%E7%94%A8%E9%97%AE%E9%A2%98%EF%BC%88/var/lib/dpkg/lock-frontend%20%E8%A2%AB%20unattended-upgr%20%E8%BF%9B%E7%A8%8B%E5%8D%A0%E7%94%A8%EF%BC%89%E8%A7%A3%E5%86%B3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>要解决在安装NTP时遇到的锁文件被占用问题（<code>/var/lib/dpkg/lock-frontend</code> 被 <code>unattended-upgr</code> 进程占用），请按以下步骤操作：</p><h3 id="步骤-1：停止占用锁的进程"><a href="#步骤-1：停止占用锁的进程" class="headerlink" title="步骤 1：停止占用锁的进程"></a>步骤 1：停止占用锁的进程</h3><ol><li><p><strong>终止自动更新进程</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">kill</span> 4937  <span class="comment"># 结束持有锁的unattended-upgr进程（PID为4937）</span></span><br></pre></td></tr></table></figure><p>如果进程仍在运行，强制终止：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">kill</span> -9 4937</span><br></pre></td></tr></table></figure></li><li><p><strong>停止 systemd 定时任务</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop apt-daily.timer       <span class="comment"># 停止自动更新计时器</span></span><br><span class="line">sudo systemctl <span class="built_in">disable</span> apt-daily.timer    <span class="comment"># 禁用开机自启（可选）</span></span><br><span class="line">sudo systemctl stop apt-daily.service     <span class="comment"># 停止正在运行的更新服务</span></span><br><span class="line">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure></li></ol><h3 id="步骤-2：删除锁文件（如果需要）"><a href="#步骤-2：删除锁文件（如果需要）" class="headerlink" title="步骤 2：删除锁文件（如果需要）"></a>步骤 2：删除锁文件（如果需要）</h3><p>如果终止进程后锁文件仍未释放：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">rm</span> /var/lib/dpkg/lock-frontend  <span class="comment"># 删除前端锁文件</span></span><br><span class="line">sudo <span class="built_in">rm</span> /var/lib/apt/lists/lock      <span class="comment"># 删除APT列表锁文件</span></span><br></pre></td></tr></table></figure><h3 id="步骤-3：修复包管理器状态"><a href="#步骤-3：修复包管理器状态" class="headerlink" title="步骤 3：修复包管理器状态"></a>步骤 3：修复包管理器状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg --configure -a  <span class="comment"># 修复可能中断的包配置</span></span><br></pre></td></tr></table></figure><h3 id="步骤-4：重试安装-NTP"><a href="#步骤-4：重试安装-NTP" class="headerlink" title="步骤 4：重试安装 NTP"></a>步骤 4：重试安装 NTP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update         <span class="comment"># 更新包列表</span></span><br><span class="line">sudo apt install -y ntp ntpdate  <span class="comment"># 安装软件</span></span><br></pre></td></tr></table></figure><h3 id="步骤-5（可选）：恢复自动更新"><a href="#步骤-5（可选）：恢复自动更新" class="headerlink" title="步骤 5（可选）：恢复自动更新"></a>步骤 5（可选）：恢复自动更新</h3><p>安装完成后，重新启用自动更新：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> apt-daily.timer</span><br><span class="line">sudo systemctl start apt-daily.timer</span><br></pre></td></tr></table></figure><h3 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntpq -p  <span class="comment"># 检查NTP服务状态</span></span><br></pre></td></tr></table></figure><h3 id="常见原因与预防"><a href="#常见原因与预防" class="headerlink" title="常见原因与预防"></a>常见原因与预防</h3><ul><li><strong>问题根源</strong>：系统自动更新（<code>unattended-upgrades</code>）在后台运行，与手动 apt 操作冲突。</li><li><strong>预防措施</strong>：<ul><li>在手动管理包前，临时关闭自动更新：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop apt-daily.timer</span><br><span class="line">sudo systemctl stop apt-daily.service</span><br></pre></td></tr></table></figure></li><li>或在非生产时段手动更新系统。</li></ul></li></ul><blockquote><p><strong>注意</strong>：强制删除锁文件或终止进程仅在必要时操作，避免影响系统稳定性。完成后务必验证包状态（<code>sudo dpkg --configure -a</code>）。</p><p>要解决在安装NTP时遇到的锁文件被占用问题（<code>/var/lib/dpkg/lock-frontend</code> 被 <code>unattended-upgr</code> 进程占用），请按以下步骤操作：</p><h3 id="步骤-1：停止占用锁的进程-1"><a href="#步骤-1：停止占用锁的进程-1" class="headerlink" title="步骤 1：停止占用锁的进程"></a>步骤 1：停止占用锁的进程</h3><ol><li><p><strong>终止自动更新进程</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">kill</span> 4937  <span class="comment"># 结束持有锁的unattended-upgr进程（PID为4937）</span></span><br></pre></td></tr></table></figure><p>如果进程仍在运行，强制终止：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">kill</span> -9 4937</span><br></pre></td></tr></table></figure></li><li><p><strong>停止 systemd 定时任务</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop apt-daily.timer       <span class="comment"># 停止自动更新计时器</span></span><br><span class="line">sudo systemctl <span class="built_in">disable</span> apt-daily.timer    <span class="comment"># 禁用开机自启（可选）</span></span><br><span class="line">sudo systemctl stop apt-daily.service     <span class="comment"># 停止正在运行的更新服务</span></span><br><span class="line">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure></li></ol><h3 id="步骤-2：删除锁文件（如果需要-尽量不要操作此步骤）"><a href="#步骤-2：删除锁文件（如果需要-尽量不要操作此步骤）" class="headerlink" title="步骤 2：删除锁文件（如果需要 尽量不要操作此步骤）"></a>步骤 2：删除锁文件（如果需要 尽量不要操作此步骤）</h3><p>如果终止进程后锁文件仍未释放：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">rm</span> /var/lib/dpkg/lock-frontend  <span class="comment"># 删除前端锁文件</span></span><br><span class="line">sudo <span class="built_in">rm</span> /var/lib/apt/lists/lock      <span class="comment"># 删除APT列表锁文件</span></span><br></pre></td></tr></table></figure><h3 id="步骤-3：修复包管理器状态-1"><a href="#步骤-3：修复包管理器状态-1" class="headerlink" title="步骤 3：修复包管理器状态"></a>步骤 3：修复包管理器状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg --configure -a  <span class="comment"># 修复可能中断的包配置</span></span><br></pre></td></tr></table></figure><h3 id="步骤-4：重试安装-NTP-1"><a href="#步骤-4：重试安装-NTP-1" class="headerlink" title="步骤 4：重试安装 NTP"></a>步骤 4：重试安装 NTP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update         <span class="comment"># 更新包列表</span></span><br><span class="line">sudo apt install -y ntp ntpdate  <span class="comment"># 安装软件</span></span><br></pre></td></tr></table></figure><h3 id="步骤-5（可选）：恢复自动更新-1"><a href="#步骤-5（可选）：恢复自动更新-1" class="headerlink" title="步骤 5（可选）：恢复自动更新"></a>步骤 5（可选）：恢复自动更新</h3><p>安装完成后，重新启用自动更新：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> apt-daily.timer</span><br><span class="line">sudo systemctl start apt-daily.timer</span><br></pre></td></tr></table></figure><h3 id="验证安装-1"><a href="#验证安装-1" class="headerlink" title="验证安装"></a>验证安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntpq -p  <span class="comment"># 检查NTP服务状态</span></span><br></pre></td></tr></table></figure><h3 id="常见原因与预防-1"><a href="#常见原因与预防-1" class="headerlink" title="常见原因与预防"></a>常见原因与预防</h3><ul><li><strong>问题根源</strong>：系统自动更新（<code>unattended-upgrades</code>）在后台运行，与手动 apt 操作冲突。</li><li><strong>预防措施</strong>：<ul><li>在手动管理包前，临时关闭自动更新：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop apt-daily.timer</span><br><span class="line">sudo systemctl stop apt-daily.service</span><br></pre></td></tr></table></figure></li><li>或在非生产时段手动更新系统。</li></ul></li></ul><blockquote><p><strong>注意</strong>：强制删除锁文件或终止进程仅在必要时操作，避免影响系统稳定性。完成后务必验证包状态（<code>sudo dpkg --configure -a</code>）。</p></blockquote></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>centos配置桥接网卡br0</title>
      <link href="/2025/07/07/centos%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E5%8D%A1br0/"/>
      <url>/2025/07/07/centos%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E5%8D%A1br0/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="centos配置桥接网卡br0"><a href="#centos配置桥接网卡br0" class="headerlink" title="centos配置桥接网卡br0"></a>centos配置桥接网卡br0</h2><p>为了编写简单我们cp ens33网卡在其基础上编写</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> ifcfg-ens33 ifcfg-br0</span><br></pre></td></tr></table></figure><h3 id="1、修改ifcfg-ens33网卡配置"><a href="#1、修改ifcfg-ens33网卡配置" class="headerlink" title="1、修改ifcfg-ens33网卡配置"></a>1、修改<code>ifcfg-ens33</code>网卡配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">2、BOOTPROTO=<span class="string">&quot;dhcp&quot;</span> <span class="comment"># 改为 BOOTPROTO=&quot;static&quot;</span></span><br><span class="line">3、BRIDGE=br0       <span class="comment"># 调整为网桥模式 其他不做更改</span></span><br><span class="line"><span class="comment"># 保留如下配置其他配置通通删除</span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=<span class="built_in">yes</span></span><br><span class="line">IPV6_AUTOCONF=<span class="built_in">yes</span></span><br><span class="line">IPV6_DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">BRIDGE=br0</span><br><span class="line">UUID=01d75770-3b87-47e3-bbc3-bebaed2293e3</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/7/image_af9a3c0ca3e2b4cd4e46a8f49472d14a.png"></p><h3 id="2、修改ifcfg-br0"><a href="#2、修改ifcfg-br0" class="headerlink" title="2、修改ifcfg-br0"></a>2、修改ifcfg-br0</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1、TYPE=<span class="string">&quot;Ethernet&quot;</span>   <span class="comment"># 修改为TYPE=&quot;Bridge&quot;</span></span><br><span class="line">2、BOOTPROTO=<span class="string">&quot;dhcp&quot;</span>  <span class="comment"># 改为 BOOTPROTO=&quot;static&quot;</span></span><br><span class="line">3、NAME=<span class="string">&quot;ens33&quot;</span>      <span class="comment"># 修改为 NAME=&quot;br0&quot;  及 DEVICE=&quot;ens33&quot;  修改为 DEVICE=&quot;br0&quot;</span></span><br><span class="line">4、注释 UUID         <span class="comment"># UUID=&quot;a8d78ec6-485c-4d14-aae1-1908bc6b9a61&quot;</span></span><br><span class="line">5、配置静态IP</span><br><span class="line">IPADDR=10.0.0.20</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.220</span><br><span class="line">DNS1=223.5.5.5</span><br><span class="line"><span class="comment"># 完整网卡配置 -------------------------------</span></span><br><span class="line">TYPE=Bridge</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=<span class="built_in">yes</span></span><br><span class="line">IPV6_AUTOCONF=<span class="built_in">yes</span></span><br><span class="line">IPV6_DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=br0</span><br><span class="line"><span class="comment"># UUID=01d75770-3b87-47e3-bbc3-bebaed2293e3</span></span><br><span class="line">DEVICE=br0</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">IPADDR=10.0.0.20</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.220</span><br><span class="line">DNS1=223.5.5.5</span><br></pre></td></tr></table></figure><h3 id="3、最后重启网卡生效"><a href="#3、最后重启网卡生效" class="headerlink" title="3、最后重启网卡生效"></a>3、最后重启网卡生效</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启网卡</span></span><br><span class="line">systemctl restart network.service</span><br></pre></td></tr></table></figure><p>此时配置完成。</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssh手动添加免密</title>
      <link href="/2025/06/23/ssh%E6%89%8B%E5%8A%A8%E6%B7%BB%E5%8A%A0%E5%85%8D%E5%AF%86/"/>
      <url>/2025/06/23/ssh%E6%89%8B%E5%8A%A8%E6%B7%BB%E5%8A%A0%E5%85%8D%E5%AF%86/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ssh手动添加免密"><a href="#ssh手动添加免密" class="headerlink" title="ssh手动添加免密"></a>ssh手动添加免密</h2><p>报错：</p><p>wsl环境 root@k8s:~/ansible# ssh-copy-id <a href="mailto:&#x72;&#111;&#111;&#x74;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#x33;&#49;&#x2e;&#x31;&#54;&#53;">&#x72;&#111;&#111;&#x74;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#x33;&#49;&#x2e;&#x31;&#54;&#53;</a> /usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: “/root/.ssh/id_rsa.pub” /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed /usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed – if you are prompted now it is to install the new keys <a href="mailto:&#114;&#111;&#x6f;&#x74;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#x36;&#56;&#x2e;&#51;&#49;&#46;&#x31;&#54;&#x35;">&#114;&#111;&#x6f;&#x74;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#x36;&#56;&#x2e;&#51;&#49;&#46;&#x31;&#54;&#x35;</a>: Permission denied (publickey).</p><p>这个情况说明：</p><ul><li>WSL 本地已生成了 SSH 密钥（<code>/root/.ssh/id_rsa.pub</code>）；</li><li><code>ssh-copy-id</code> 成功读取了公钥；</li><li><strong>但目标主机 <code>192.168.31.165</code> 禁用了密码登录</strong>，所以 <code>ssh-copy-id</code> 无法登录进去安装公钥。</li></ul><hr><h2 id="✅-解决方法"><a href="#✅-解决方法" class="headerlink" title="✅ 解决方法"></a>✅ 解决方法</h2><p>因为目标主机只支持 <code>publickey</code> 登录，你有两个选择：</p><hr><h3 id="方案-1：手动通过目标主机控制台添加公钥"><a href="#方案-1：手动通过目标主机控制台添加公钥" class="headerlink" title="方案 1：手动通过目标主机控制台添加公钥"></a><strong>方案 1：手动通过目标主机控制台添加公钥</strong></h3><p>如果你能登录目标主机的控制台（比如通过 VMware/ESXi/vCenter、KVM 控制台或者物理机），请执行以下操作：</p><h4 id="🚀-1-在-WSL-查看公钥内容："><a href="#🚀-1-在-WSL-查看公钥内容：" class="headerlink" title="🚀 1. 在 WSL 查看公钥内容："></a>🚀 1. 在 WSL 查看公钥内容：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure><p>输出形如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA1z... root@k8s</span><br></pre></td></tr></table></figure><h4 id="🛠-2-在目标主机（192-168-31-165）上执行："><a href="#🛠-2-在目标主机（192-168-31-165）上执行：" class="headerlink" title="🛠 2. 在目标主机（192.168.31.165）上执行："></a>🛠 2. 在目标主机（192.168.31.165）上执行：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /root/.ssh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;【上面那串公钥内容】&quot;</span> &gt;&gt; /root/.ssh/authorized_keys</span><br><span class="line"><span class="built_in">chmod</span> 700 /root/.ssh</span><br><span class="line"><span class="built_in">chmod</span> 600 /root/.ssh/authorized_keys</span><br></pre></td></tr></table></figure><p>确保 <code>sshd_config</code> 中如下内容没有被禁用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PermitRootLogin <span class="built_in">yes</span></span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>修改后重启 SSH 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart ssh</span><br></pre></td></tr></table></figure><hr><h3 id="方案-2：临时允许密码登录用于-ssh-copy-id"><a href="#方案-2：临时允许密码登录用于-ssh-copy-id" class="headerlink" title="方案 2：临时允许密码登录用于 ssh-copy-id"></a><strong>方案 2：临时允许密码登录用于 ssh-copy-id</strong></h3><blockquote><p>仅建议你临时改一下，用完再改回去！</p></blockquote><h4 id="在目标机修改-etc-ssh-sshd-config："><a href="#在目标机修改-etc-ssh-sshd-config：" class="headerlink" title="在目标机修改 /etc/ssh/sshd_config："></a>在目标机修改 <code>/etc/ssh/sshd_config</code>：</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br></pre></td></tr></table></figure><p>然后重启 SSH 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart ssh</span><br></pre></td></tr></table></figure><p>然后在 WSL 执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id root@192.168.31.165</span><br></pre></td></tr></table></figure><p>验证后建议把 <code>PasswordAuthentication</code> 改回 <code>no</code>，提高安全性。</p><hr><h3 id="✅-验证-SSH-是否成功："><a href="#✅-验证-SSH-是否成功：" class="headerlink" title="✅ 验证 SSH 是否成功："></a>✅ 验证 SSH 是否成功：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.31.165</span><br></pre></td></tr></table></figure><p>若无需密码，说明配置成功，此时 Ansible 就能正常跑了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i host -m ping</span><br></pre></td></tr></table></figure><hr><p>需要我帮你写自动检测是否已配置 SSH 公钥、自动推送脚本，也可以继续告诉我。</p>]]></content>
      
      
      <categories>
          
          <category> ssh </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>四、ansible各个模块组件介绍与使用</title>
      <link href="/2025/06/22/%E5%9B%9B%E3%80%81ansible%E5%90%84%E4%B8%AA%E6%A8%A1%E5%9D%97%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
      <url>/2025/06/22/%E5%9B%9B%E3%80%81ansible%E5%90%84%E4%B8%AA%E6%A8%A1%E5%9D%97%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="四、ansible各个模块组件介绍与使用"><a href="#四、ansible各个模块组件介绍与使用" class="headerlink" title="四、ansible各个模块组件介绍与使用"></a>四、ansible各个模块组件介绍与使用</h2><h3 id="一、inventory模块"><a href="#一、inventory模块" class="headerlink" title="一、inventory模块"></a>一、inventory模块</h3><p>inventory文件中填写需要被管理主机与主机信息（逻辑上定义）。</p><p>默认inventory文件在：/etc/ansible/hosts</p><p>可以自定义 使用-i 选项指定inventory组件的文件位置。</p><p>配置invertoy文件</p><h4 id="场景1"><a href="#场景1" class="headerlink" title="场景1"></a>场景1</h4><p>基于密码连接（方式1，主机+端口+密码）</p><p>固定的格式为：</p><ol start="0"><li>主机 ：在最前10.0.0.10</li><li>端口 ：ansible_ssh_port=22</li><li>用户 ：ansible_ssh_user=root</li><li>密码 ；ansible_ssh_pass=’123456’</li><li>[webservers] ：是项目名称</li></ol><p><strong>写法如下：</strong></p><p>写法1（常用）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">10.0.0.10  ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=’123456’</span><br><span class="line">10.0.0.11  ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=’123456’</span><br></pre></td></tr></table></figure><p>写法2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">Web[1:2].oldboy.com ansible_ssh_pass=’123456’[webservers]</span><br><span class="line">Web[1:2].oldboy.com ansible_ssh_pass=’123456’</span><br></pre></td></tr></table></figure><p>写法3</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">Web[1:2].oldboy.com</span><br><span class="line">[webservers：vars]  <span class="comment"># 意为把web....这个组设置为变量 连接时直接使用下方密码</span></span><br><span class="line">ansible_ssh_pass=’123456’</span><br></pre></td></tr></table></figure><h4 id="演示：在刚才新建的项目下面新建自定义inventory清单"><a href="#演示：在刚才新建的项目下面新建自定义inventory清单" class="headerlink" title="演示：在刚才新建的项目下面新建自定义inventory清单"></a>演示：在刚才新建的项目下面新建自定义inventory清单</h4><p>注：此种方法不是很安全不常用需要先给被控端安装python。</p><p>新建文件hosts</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[fruit]</span><br><span class="line">192.168.31.165  ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="string">&#x27;123&#x27;</span></span><br><span class="line"><span class="comment">#10.0.0.11  ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=&#x27;123&#x27;</span></span><br><span class="line">~                                                                        </span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#python2.7.5安装</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y build-essential zlib1g-dev libssl-dev \</span><br><span class="line">  libncurses5-dev libncursesw5-dev libreadline-dev libsqlite3-dev \</span><br><span class="line">  libgdbm-dev libdb5.3-dev libbz2-dev libffi-dev wget</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/src</span><br><span class="line">sudo wget https://www.python.org/ftp/python/2.7.5/Python-2.7.5.tgz</span><br><span class="line">sudo tar xzf Python-2.7.5.tgz</span><br><span class="line"><span class="built_in">cd</span> /usr/src/Python-2.7.5</span><br><span class="line"></span><br><span class="line">sudo ./configure --prefix=/usr/local/python2.7.5</span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">/usr/local/python2.7.5/bin/python2.7 -V</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">ln</span> -s /usr/local/python2.7.5/bin/python2.7 /usr/local/bin/python2.7.5</span><br><span class="line"></span><br><span class="line">python2.7.5</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三、ansible配置文件解析</title>
      <link href="/2025/06/22/%E4%B8%89%E3%80%81ansible%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/"/>
      <url>/2025/06/22/%E4%B8%89%E3%80%81ansible%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="三、ansible配置文件解析"><a href="#三、ansible配置文件解析" class="headerlink" title="三、ansible配置文件解析"></a>三、ansible配置文件解析</h2><p>cat /etc/ansible/ansible.cfg</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line"></span><br><span class="line"><span class="comment"># some basic default values...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#inventory      = /etc/ansible/hosts  </span></span><br><span class="line"><span class="comment">#library        = /usr/share/my_modules/              # 主机列表配置文件</span></span><br><span class="line"><span class="comment">#module_utils   = /usr/share/my_module_utils/         # 库文件存放目录</span></span><br><span class="line"><span class="comment">#remote_tmp     = ~/.ansible/tmp                      # 临时py文件存放在远程主机目录</span></span><br><span class="line"><span class="comment">#local_tmp      = ~/.ansible/tmp                      # 本机的临时执行目录</span></span><br><span class="line"><span class="comment">#plugin_filters_cfg = /etc/ansible/plugin_filters.yml </span></span><br><span class="line"><span class="comment">#forks          = 5       # 默认并发数</span></span><br><span class="line"><span class="comment">#poll_interval  = 15  </span></span><br><span class="line"><span class="comment">#sudo_user      = root    # 默认sudo用户</span></span><br><span class="line"><span class="comment">#ask_sudo_pass = True     # 每次执行是否询问sudo的ssh密码</span></span><br><span class="line"><span class="comment">#ask_pass      = True     # 每次执行是否询问ssh密码</span></span><br><span class="line"><span class="comment">#transport      = smart</span></span><br><span class="line"><span class="comment">#remote_port    = 22      # 远程主机端口</span></span><br><span class="line"><span class="comment">#module_lang    = C</span></span><br><span class="line"><span class="comment">#module_set_locale = False </span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>二、ansible安装</title>
      <link href="/2025/06/22/%E4%BA%8C%E3%80%81ansible%E5%AE%89%E8%A3%85/"/>
      <url>/2025/06/22/%E4%BA%8C%E3%80%81ansible%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="二、ansible安装"><a href="#二、ansible安装" class="headerlink" title="二、ansible安装"></a>二、ansible安装</h2><h3 id="ubuntu与centos（换源阿里云后直接安装）"><a href="#ubuntu与centos（换源阿里云后直接安装）" class="headerlink" title="ubuntu与centos（换源阿里云后直接安装）"></a>ubuntu与centos（换源阿里云后直接安装）</h3><p>centos需要epel.repo源：<a href="https://developer.aliyun.com/mirror/epel/">https://developer.aliyun.com/mirror/epel/</a></p><p>换源：<a href="https://developer.aliyun.com/mirror/">https://developer.aliyun.com/mirror/</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">apt</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">ansible</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s:/mydata/jenkins_home/secrets# ansible --version</span><br><span class="line">ansible 2.9.6</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;, &#x27;/usr/share/ansible/plugins/modules&#x27;]</span><br><span class="line">  ansible python module location = /usr/lib/python3/dist-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 3.8.10 (default, Mar 18 2025, 20:04:55) [GCC 9.4.0]</span><br></pre></td></tr></table></figure><p>centos可用博主多年以前写的脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#作用：安装ansible</span></span><br><span class="line"><span class="function"><span class="title">welcome</span></span>() &#123;</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">1.需要用到的命令awk/ansible --version </span></span><br><span class="line"><span class="string">2.需要用到的循环for/if 安装ansible需要epel源</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">   epel_check=`<span class="built_in">ls</span> /etc/yum.repos.d/epel.repo`</span><br><span class="line">   version=`ansible --version |awk -F<span class="string">&#x27;[ .]+&#x27;</span> <span class="string">&#x27;NR==1&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">&#125;</span><br><span class="line">[ -f <span class="variable">$&#123;epel_check&#125;</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;已存在epel源&quot;</span> || wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;epel_check&#125;</span>&quot;</span> = <span class="string">&quot;epel.repo&quot;</span> -a <span class="string">&quot;<span class="variable">$&#123;version&#125;</span>&quot;</span> = <span class="string">&quot;ansible&quot;</span> ];</span><br><span class="line">   <span class="keyword">then</span></span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;ansible已安装&quot;</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">     yum install -y ansible</span><br><span class="line">     [ <span class="string">&quot;$?&quot;</span> = <span class="string">&quot;0&quot;</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;安装成功&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;安装失败请检查&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">  welcome</span><br><span class="line">  start</span><br><span class="line">&#125;</span><br><span class="line">main</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一、ansible介绍</title>
      <link href="/2025/06/22/%E4%B8%80%E3%80%81ansible%E4%BB%8B%E7%BB%8D/"/>
      <url>/2025/06/22/%E4%B8%80%E3%80%81ansible%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="一、ansible介绍"><a href="#一、ansible介绍" class="headerlink" title="一、ansible介绍"></a>一、ansible介绍</h2><p>ansible运行的基本过程图</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_9c322e7552ff461af69593bd94873582.png"></p><p>需要学习的目标</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_59a850ba496c92d30545e695e71d8c2e.png"></p><h3 id="一、什么是ansible"><a href="#一、什么是ansible" class="headerlink" title="一、什么是ansible"></a>一、什么是ansible</h3><p>Ansible首次发布于2012年，作者MichaelDeHaan</p><ul><li>MichaelDeHaan也是cobbler的作者</li><li>于2015年被redhat收购</li></ul><p>Ansible是一款自动化运维工具、基于python开发</p><ul><li>批量系统配置</li><li>批量程序部署</li><li>批量运行命令等功能</li></ul><p>Ansible是一个it自动化配置管理工具自动化主要体现在absible集成了丰富模块丰富的功能组件，可以通过一个命令行完成一些列的操作。进而减少重复性的工作和维护成本，以提高工作效率。</p><p><strong>如在10台服务器上安装nginx服务</strong></p><p>假设我们要在10台linx服务器上安装一个nginx服务，手动如何作的?</p><ul><li>第一步、ssh登陆NUM(1..n)服务器</li><li>第二步、输入对应服务器密码</li><li>第三步、安装yum install nginx</li><li>第四步、启动systemctl start nginx</li><li>第五步、退出登录</li></ul><p>如此循环十次</p><p><strong>Ansible可以完成这些功能</strong></p><ol><li>批量执行远程命令，可以对n台主机同时进行命令的执行</li><li>批量配置软件服务，可以进行自动化的方式配置和管理服务</li><li>实现软件开发功能，jumpserver底层使用ansible来实现自动化管理</li><li>编排高级的IT任务，ansible的playbook是一门编程语言可以用来描绘一台IT的架构。</li></ol><p><strong>Ansible的特点</strong></p><ol><li>容易学习，无代理模式，不像saltstack既要学客户端与服务端，还需要学习客户端与服务端中间通讯协议</li><li>操作灵活，体现在Ansible有较多的模块，提供了丰富的功能、playbook则提供类似于编程语言的复杂功</li><li>简单易用体现在Ansible一个命令可以完成很多事情。</li><li>安全可靠因为Ansible使用了SSH协议进行通讯，联稳定也安全</li><li>移植性高，可以将写好的playbook拷贝至任意机器进行执行</li></ol><p><strong>Ansible的python只能是2.7.5.不能升级到python3</strong></p><p>控制端与被控端必须有python</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_0157a38c37fb66d1a4da9e5796c38a74.png"></p><p><strong>Ansible–version 解析</strong></p><ul><li>Ansible版本：2.9.72</li><li>配置文件：/etc/ansible/ansible.cfg</li><li>配置模块查找的路径：</li><li>/home/gegewu/.ansible/plugins/modules</li><li>/usr/share/ansible/plugins/modules</li><li>Python模块路径：/usr/lib/python2.7/site-packages/ansible</li><li>执行位置： /usr/bin/ansible</li></ul><p><strong>Ansible存在优先级问题</strong></p><p>Ansible的配置文件可以存放在任何位置，但配置文件有读取顺序，先Ansible配置做一个基本了解。ansible的配置文件有查找顺序（可通过ansible –version查看）:</p><ol><li>最先查找SANSIBLECONFIG变量</li><li>其次查找当前日录下ansible.cfg</li><li>然后查找用户家日录下的.ansible.cfg</li><li>最后查找’etc/ansible/ansible.cfg(认)</li></ol><p><strong>例1：测试优先级第二个配置文件项目目录下的ansible.cfg</strong></p><p>在家目录创建一个项目</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_583529ab672b89f1555cdfe2c6346205.png"></p><p>再到没有项目的目录时：前面三个没找到 推到最后一个配置文件</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_c3fb56ef97640110eda427530585ea87.png"></p><p><strong>例2：测试优先级第三个配置文件家目录下的.ansible.cfg</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_8367c8a80acbec08d1b7c67cd33dbad7.png"></p><p><strong>例3：测试优先级最后一个个配置文件：/etc/ansible/ansible.cfg</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_214822b0205b0cc46856726e95ab106a.png"></p>]]></content>
      
      
      <categories>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三、jenkins安装</title>
      <link href="/2025/06/22/%E4%B8%89%E3%80%81jenkins%E5%AE%89%E8%A3%85/"/>
      <url>/2025/06/22/%E4%B8%89%E3%80%81jenkins%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="三、jenkins安装"><a href="#三、jenkins安装" class="headerlink" title="三、jenkins安装"></a>三、jenkins安装</h2><p>docker/k8s方式安装jenkins</p><h3 id="docker方式部署"><a href="#docker方式部署" class="headerlink" title="docker方式部署"></a>docker方式部署</h3><p><strong>镜像：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官方</span></span><br><span class="line">docker pull jenkins/jenkins:lts</span><br><span class="line"><span class="comment"># 自有阿里云docker仓库</span></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/zznn/jenkins:lts</span><br></pre></td></tr></table></figure><p><strong>构建jenkins</strong></p><p>如果jenkins无法启动则是持久化宿主机目录权限有问题</p><ul><li><input checked disabled type="checkbox"> chown -R 1000 /mydata/jenkins_home</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /mydata/jenkins_home</span><br><span class="line">docker run -di --name=jenkins -p 8080:8080 -v /mydata/jenkins_home:/var/jenkins_home registry.cn-hangzhou.aliyuncs.com/zznn/jenkins:lts</span><br></pre></td></tr></table></figure><p><strong>docker-compose</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jenkins:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/jenkins:lts</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/jenkins_home:/var/jenkins_home</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure><h3 id="k8s方式部署"><a href="#k8s方式部署" class="headerlink" title="k8s方式部署"></a>k8s方式部署</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">jenkins</span> <span class="comment"># has to match .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;jenkins&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span> <span class="comment"># by default is 1               # 3副本</span></span><br><span class="line">  <span class="comment"># minReadySeconds: 10 # by default is 0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">jenkins</span> <span class="comment"># has to match .spec.selector.matchLabels</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/jenkins:lts</span></span><br><span class="line">        <span class="comment"># env:</span></span><br><span class="line">        <span class="comment"># - name: jenkins_ROOT_PASSWORD</span></span><br><span class="line">        <span class="comment">#   value: &quot;root_password&quot;  # 设置根密码,建议使用 Secrets 存储</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">jenkins-storage</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins-storage</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/mydata/jenkins_home</span>      <span class="comment"># 宿主机目录</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span>     <span class="comment"># 目录存在就使用，不存在就先创建后使用</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># 将服务暴露为 NodePort 类型</span></span><br></pre></td></tr></table></figure><p><strong>通过日志查看密码：70b19f8448b24a68bb8aa30dec2e3db4</strong></p><p><strong>初始化完成后本教程创建admin账户默认密码等都写admin</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_39ff478ad43429568ca44722b665b5c5.png"></p><p><strong>映射目录</strong></p><p><strong>安装完成（最后初始化过程<strong><strong>需要点击使用admin账户继续</strong></strong>）</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_49944c13e5842923fb378930487bd225.png"></p>]]></content>
      
      
      <categories>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>二、jenkins持续集成的操作步骤</title>
      <link href="/2025/06/22/%E4%BA%8C%E3%80%81jenkins%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%9A%84%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4/"/>
      <url>/2025/06/22/%E4%BA%8C%E3%80%81jenkins%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%9A%84%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="二、jenkins持续集成的操作步骤"><a href="#二、jenkins持续集成的操作步骤" class="headerlink" title="二、jenkins持续集成的操作步骤"></a>二、jenkins持续集成的操作步骤</h2><p>根据持续集成的设计、代码从提交到生产、整个环境有以下几步。</p><p><strong>提交</strong></p><p>流程的第一步、是开发者向代码仓库提交代码。所有后面的步骤都始于本地代码的一次提交（commit）。</p><p><strong>测试（第一轮）</strong></p><p>代码仓库对commit操作配置了钩子（hook）、只要提交代码或者合并进主干、就会跑自动化测试。</p><p><strong>测试的种类：</strong></p><ul><li>单元测试：针对函数或模块的测试</li><li>集成测试：针对整体产品的某个功能的测试、又称功能测试</li><li>端对端测试：从用户界面直达数据库的全链路测试。</li></ul><p><strong>构建</strong></p><p>通过第一轮测试、代码就可以合并进主干、就算可以交付了。</p><p>交付后、先进行构建（bulid）、再进行第二轮测试。所谓构建、指的是将源码转换成可以直接运行的实际代码、比如安装依赖、配置各种资源（样式表、JS脚本、图片）等等。</p><p><strong>常用的构建工具如下：</strong></p><ul><li>jenkins</li><li>travis</li><li>codeship</li><li>strider</li></ul><p>jenkins和starider是开源软件、travis和codeship对于开源项目可以免费使用。他们都会将构建和测试、在一次运行中执行完成。</p><p><strong>测试（第二轮）</strong></p><p>构建完成、就要进行第二轮测试。如果第一轮已经涵盖了所有测试内容，第二轮可以忽略，当然、这时构建步骤也要移到第一轮测试前面。</p><p>第二轮是全面测试、单元测试和集成测试都会跑，有条件的话，也要做端对端测试。所有测试以自动化为主，少数无法自动化的测试用例，就要人工跑。</p><p>需要强调的是、新版本的每一个更新点都必须测试到。如果测试的覆盖率不高、进入后面的部署阶段后、很可能会出现严重问题。</p><p><strong>部署</strong></p><p>通过了第二轮测试、当前代码就是一个可以直接部署的版本（artifack）。将这个版本的所有文件打包（tar filename.tar*）存档，发到生产服务器。</p><p>生产服务器将打包文件，解包成本地的一个目录、再将运行路径的符号链接（symlink）指向这个目录、然后重启应用。这方面的部署工具有ansible、chef、puppet等。</p><p><strong>回滚</strong></p><p>一但当前版本发生问题、就要回滚到上一个版本构建的结果。最简单的做法就是修改一下符号链接，指向上一个版本的目录。</p>]]></content>
      
      
      <categories>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一、jenkins（cicd介绍）</title>
      <link href="/2025/06/22/%E4%B8%80%E3%80%81jenkins%E4%BB%8B%E7%BB%8D/"/>
      <url>/2025/06/22/%E4%B8%80%E3%80%81jenkins%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、jenkins（cicd介绍）"><a href="#一、jenkins（cicd介绍）" class="headerlink" title="一、jenkins（cicd介绍）"></a>一、jenkins（cicd介绍）</h1><p>怎么说呢 去年就想学jinkens了一直拖到现在 二十四岁已经部署中年拖延了  那么学习jenkins就从jenkins介绍开始吧 冲！</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_6e6225dd1c97fd461dbae68abf994de4.png"></p><h2 id="一、什么是持续集成（ci）"><a href="#一、什么是持续集成（ci）" class="headerlink" title="一、什么是持续集成（ci）"></a>一、什么是持续集成（ci）</h2><p><strong>持续集成（continuous integration）指的是频繁的（一天多次）将代码集成到主干。他的好处主要有两个：</strong></p><ul><li><strong>快速发现错误没完成一点更新就集成到主干、可以快速的发现错误、定位错误也比较容易</strong></li><li><strong>防止分支大幅度偏离主干。如果不是经常集成、主干又在不断更新、会导致以后集成的难度变大、甚至难以集成</strong></li></ul><p><strong>Martin Fowier说过、“持续集成并不能消除bug、而是让他们非常容易发现和改正”。</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_a110c2eb492f2a70bf99e26a7a556270.png"></p><p><strong>持续集成强调开发人员提交了新代码之后，立即进行构建，（单元）测试。根据测试结果、我们可以确定新代码和原有代码能否正确的集成在一起。</strong></p><h2 id="二、持续交付（CD）手动部署"><a href="#二、持续交付（CD）手动部署" class="headerlink" title="二、持续交付（CD）手动部署"></a>二、持续交付（CD）手动部署</h2><p>持续交付（continuous delivery）指的是频繁的将软件的新版本、交付给质量团队或者用户、以供评审。如果评审通过、代码可以进入生产阶段。</p><p><strong>持续交付可以看作持续集成的下一步。他强调的是、不管怎么更新、软件是随时随地可以交付的。</strong></p><p>持续交付在持续集成的基础上、将集成后的代码部署到更贴近真实的运行环境的{类生产环境}（production-like envionments）中。比如我们完成单元测试后、可以把代码部署到连接数据库的staging环境中更多的测试。如果代码没有问题、可以继续手动部署到生产环境中（测试环境没有问题再到类生产环境跑代码）、没有问题此时再部署到正确的生产环境。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_37ae822b3ac29b75a5ab025f48e4c89b.png"></p><h2 id="三、持续部署（生产环境自动部署）"><a href="#三、持续部署（生产环境自动部署）" class="headerlink" title="三、持续部署（生产环境自动部署）"></a>三、持续部署（生产环境自动部署）</h2><p>持续部署（continuous deployment）是持续交付的下一步指的是代码通过评审后自动部署到生产环境。</p><p>持续部署的目标是、代码在任何时刻都是可部署的，可以进入生产阶段。</p><p><strong>持续部署的前提是能自动化完成测试、构建、部署等步骤。</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_25086192d2536f8fc774faf3438a70b9.png"></p><h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p><strong>持续集成 ：</strong>首先代码提交到仓库&gt;&gt; 自动化构建测试&gt;&gt;返回结果 （确认现在的代码是不是和之前的代码正确的集成在一起）</p><p><strong>持续交付：</strong>将代码放在一个测试环境运行没有问题则会到一个类生产环境运行 类生产环境没有问题则 手动部署到正式生产环境 这样也有点麻烦后面就有了持续部署</p><p><strong>持续部署：</strong>不需要手动部署到正式的生产环境了 而是可以自动部署</p><hr><h2 id="jenkins介绍"><a href="#jenkins介绍" class="headerlink" title="jenkins介绍"></a>jenkins介绍</h2><p><strong>官网：</strong><a href="https://www.jenkins.io/">https://www.jenkins.io</a></p><p><strong>插件：</strong><a href="https://plugins.jenkins.io/">https://plugins.jenkins.io</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_69ff3cfcc806713501bd43e4d69787b1.png"></p><p><strong>jenkins原名Hudson，2011年改为现在的名字，它是一个开源的实现持续集成的软件工具。</strong></p><p>**官方网站:  <a href="http://jenkins-ci.org/">http://jenkins-ci.org/</a> 或 **<a href="https://www.jenkins.io/">https://www.jenkins.io</a></p><p><strong>Jenkins 能实施监控集成中存在的错误，提供详细的日志文件和提醒功能，还能用图表的形式形象地展示项目构建的趋势和稳定性。</strong></p><h3 id="特点："><a href="#特点：" class="headerlink" title="特点："></a>特点：</h3><ul><li><strong>易安装:仅仅一个java-jar jenkins.war（本文使用docker方式安装jenkins），从官网下载该文件后，直接运行，无需额外的安装，更无需安装数</strong></li><li><strong>据库;</strong></li><li><strong>易配置: 提供友好的 GUI配置界面;</strong></li><li><strong>变更支持: Jenkins能从代码仓库(Subversion/CVS)中获取并产生代码更新列表并输出到编译输出信息中;</strong></li><li><strong>支持永久链接: 用户是通过 web来访问Jenkins的，而这些web页面的链接地址都是永久链接地址，因此，你可以在各种文档中直接使用该链接;</strong></li><li><strong>以在等待结果过程中，干别的事情)</strong></li><li><strong>集成 E-Mai/RSS/IM:当完成一次集成时，可通过这些工具实时告诉你集成结果(据我所知，构建一次集成需要花费一定时间，有了这个功能，你就可以在等待结果过程中，干别的事情)</strong></li><li><strong>JUnit/TestNG 测试报告:也就是用以图表等形式提供详细的测试报表功能;</strong></li><li><strong>支持分布式构建: Jenkins可以把集成构建等工作分发到多台计算机中完成;</strong></li><li><strong>文件指纹信息:Jenkins会保存哪次集成构建产生了哪些jars文件，哪一次集成构建使用了哪个版本的jars文件</strong></li><li><strong>等构建记录;</strong></li></ul>]]></content>
      
      
      <categories>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s总结（共享存储nfs 亲和性等）</title>
      <link href="/2025/06/03/k8s%E6%80%BB%E7%BB%93%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8nfs%20%E4%BA%B2%E5%92%8C%E6%80%A7%E7%AD%89/"/>
      <url>/2025/06/03/k8s%E6%80%BB%E7%BB%93%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8nfs%20%E4%BA%B2%E5%92%8C%E6%80%A7%E7%AD%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="k8s总结（共享存储nfs-亲和性等）"><a href="#k8s总结（共享存储nfs-亲和性等）" class="headerlink" title="k8s总结（共享存储nfs 亲和性等）"></a>k8s总结（共享存储nfs 亲和性等）</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_41c38c90c0a93c4baa0f93e474f099a7.png"></p><h2 id="一、设置环境"><a href="#一、设置环境" class="headerlink" title="一、设置环境"></a>一、设置环境</h2><p><strong>设置节点污点与标签</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置污点</span></span><br><span class="line">kubectl taint nodes k8s1 tag=heima:NoExecute</span><br><span class="line"><span class="comment"># 去除污点</span></span><br><span class="line">kubectl taint nodes k8s1 tag:NoExecute-</span><br><span class="line"><span class="comment"># 例子</span></span><br><span class="line">kubectl taint nodes gegewu node-role.kubernetes.io/control-plane:NoSchedule-</span><br><span class="line"><span class="comment"># 查看污点设置是否成功</span></span><br><span class="line">kubectl describe nodes |grep Taints</span><br><span class="line"><span class="comment"># Taints:             tag=heima:NoExecute</span></span><br><span class="line"><span class="comment"># Taints:             &lt;none&gt;</span></span><br><span class="line"><span class="comment"># 设置节点标签</span></span><br><span class="line">kubectl label nodes k8s1 nodeenv=pro</span><br><span class="line">kubectl get nodes --show-labels<span class="comment"># 设置污点</span></span><br><span class="line">kubectl taint nodes k8s1 tag=heima:NoExecute</span><br><span class="line"><span class="comment"># 去除污点</span></span><br><span class="line">kubectl taint nodes k8s1 tag:NoExecute-</span><br><span class="line"><span class="comment"># 例子</span></span><br><span class="line">kubectl taint nodes gegewu node-role.kubernetes.io/control-plane:NoSchedule-</span><br><span class="line"><span class="comment"># 查看污点设置是否成功</span></span><br><span class="line">kubectl describe nodes |grep Taints</span><br><span class="line"><span class="comment"># Taints:             tag=heima:NoExecute</span></span><br><span class="line"><span class="comment"># Taints:             &lt;none&gt;</span></span><br><span class="line"><span class="comment"># 设置节点标签</span></span><br><span class="line">kubectl label nodes k8s1 nodeenv=pro</span><br><span class="line">kubectl get nodes --show-labels</span><br></pre></td></tr></table></figure><h2 id="二、配置yaml文件"><a href="#二、配置yaml文件" class="headerlink" title="二、配置yaml文件"></a>二、配置yaml文件</h2><p><strong>以yaml配置方式总结 创建一个可以外部访问的nginx（zj.yaml）：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  <span class="comment"># 版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>     <span class="comment"># 类型</span></span><br><span class="line"><span class="attr">metadata:</span>            <span class="comment"># 源数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy-nginx</span> <span class="comment"># 当前deployment所属的名字</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>     <span class="comment"># 及ns</span></span><br><span class="line">  <span class="attr">labels:</span>            <span class="comment"># 当前deploy的标签</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;label-test&quot;</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>        <span class="comment"># 定义副本数</span></span><br><span class="line">  <span class="attr">selector:</span>          <span class="comment"># 标签选择器 选择标签进行操作</span></span><br><span class="line">    <span class="attr">matchLabels:</span>     <span class="comment"># 选择nginx标签</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">label-test</span></span><br><span class="line">  <span class="attr">template:</span>                   <span class="comment"># 以下为pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span>                 <span class="comment"># 标签</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">label-test</span>   <span class="comment"># 定义标签为label-test</span></span><br><span class="line">  </span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 镜像信息等   </span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span> <span class="comment"># 用于设置镜像拉取策略</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-test</span></span><br><span class="line">        <span class="comment"># cmd变量与端口</span></span><br><span class="line">        <span class="attr">ports:</span>       </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span>  </span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;while true;do /bin/echo $(date +%T);sleep 60; done;&quot;</span>]</span><br><span class="line">          <span class="attr">env:</span>                     <span class="comment"># 设置环境变量列表</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;username&quot;</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;password&quot;</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;123456&quot;</span>   </span><br><span class="line">        <span class="comment"># 资源配额</span></span><br><span class="line">        <span class="attr">resources:</span>              </span><br><span class="line">          <span class="attr">limits:</span>    <span class="comment"># 限制资源（上限）</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span> <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;10Gi&quot;</span> <span class="comment"># 内存限制</span></span><br><span class="line">          <span class="attr">requests:</span>        <span class="comment"># 请求资源（下限）</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span>       <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;10Mi&quot;</span> <span class="comment"># 内存限制  </span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># 勾子函数</span></span><br><span class="line">      <span class="attr">lifecycle:</span></span><br><span class="line">        <span class="attr">postStart:</span> </span><br><span class="line">          <span class="attr">exec:</span> <span class="comment"># 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo postStart... &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">        <span class="attr">preStop:</span></span><br><span class="line">          <span class="attr">exec:</span> <span class="comment"># 在容器停止之前停止nginx服务</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;/usr/sbin/nginx&quot;</span>,<span class="string">&quot;-s&quot;</span>,<span class="string">&quot;quit&quot;</span>]</span><br><span class="line">      <span class="attr">tolerations:</span>        <span class="comment"># 添加容忍</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;tag&quot;</span>        <span class="comment"># 要容忍的污点的key</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span> <span class="comment"># 操作符（等于操作符）</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;heima&quot;</span>        <span class="comment"># 容忍的污点的value</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span>   <span class="comment"># 添加容忍的规则，这里必须和标记的污点规则相同 </span></span><br><span class="line">  </span><br><span class="line">      <span class="comment"># 亲和性设置  </span></span><br><span class="line">      <span class="attr">affinity:</span>   </span><br><span class="line">        <span class="attr">nodeAffinity:</span> <span class="comment"># 设置node亲和性</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 软限制</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">preference:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span> <span class="comment"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签(当前环境没有)</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span> [<span class="string">&quot;pro&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br></pre></td></tr></table></figure><p><strong>总结2加入共享存储挂载</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  <span class="comment"># 版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>     <span class="comment"># 类型</span></span><br><span class="line"><span class="attr">metadata:</span>            <span class="comment"># 源数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy-nginx</span> <span class="comment"># 当前deployment所属的名字</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>     <span class="comment"># 及ns</span></span><br><span class="line">  <span class="attr">labels:</span>            <span class="comment"># 当前deploy的标签</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;label-test&quot;</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>        <span class="comment"># 定义副本数</span></span><br><span class="line">  <span class="attr">selector:</span>          <span class="comment"># 标签选择器 选择标签进行操作</span></span><br><span class="line">    <span class="attr">matchLabels:</span>     <span class="comment"># 选择nginx标签</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">label-test</span></span><br><span class="line">  <span class="attr">template:</span>                   <span class="comment"># 以下为pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span>                 <span class="comment"># 标签</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">label-test</span>   <span class="comment"># 定义标签为label-test</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 镜像信息等   </span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span> <span class="comment"># 用于设置镜像拉取策略</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-test</span></span><br><span class="line">        <span class="comment"># cmd变量与端口</span></span><br><span class="line">        <span class="attr">ports:</span>         </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span> </span><br><span class="line">        <span class="comment"># 环境变量</span></span><br><span class="line">        <span class="attr">env:</span>                 </span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;username&quot;</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;password&quot;</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;123456&quot;</span>   </span><br><span class="line">        <span class="comment"># 容器命令</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;while true;do /bin/echo $(date +%T);sleep 60; done;&quot;</span>]</span><br><span class="line">        <span class="comment"># 挂载卷</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">logs-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log/nginx</span></span><br><span class="line">        <span class="comment"># 资源配额</span></span><br><span class="line">        <span class="attr">resources:</span>                </span><br><span class="line">          <span class="attr">limits:</span>    <span class="comment"># 限制资源（上限）</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span> <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;10Gi&quot;</span> <span class="comment"># 内存限制</span></span><br><span class="line">          <span class="attr">requests:</span>        <span class="comment"># 请求资源（下限）</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span>       <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;10Mi&quot;</span> <span class="comment"># 内存限制  </span></span><br><span class="line">        <span class="comment"># 勾子函数</span></span><br><span class="line">        <span class="attr">lifecycle:</span></span><br><span class="line">          <span class="attr">postStart:</span> </span><br><span class="line">            <span class="attr">exec:</span> <span class="comment"># 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span></span><br><span class="line">              <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo postStart... &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">          <span class="attr">preStop:</span></span><br><span class="line">            <span class="attr">exec:</span> <span class="comment"># 在容器停止之前停止nginx服务</span></span><br><span class="line">              <span class="attr">command:</span> [<span class="string">&quot;/usr/sbin/nginx&quot;</span>,<span class="string">&quot;-s&quot;</span>,<span class="string">&quot;quit&quot;</span>]</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 定义 volume</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">logs-volume</span></span><br><span class="line">        <span class="attr">nfs:</span></span><br><span class="line">          <span class="attr">server:</span> <span class="number">58.49</span><span class="number">.144</span><span class="number">.8</span>  <span class="comment"># nfs服务器地址 （宿主机地址）</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/srv/nfs4</span>      <span class="comment"># 共享文件路径      </span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 容忍污点</span></span><br><span class="line">      <span class="attr">tolerations:</span>   </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;tag&quot;</span>    </span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span> </span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;heima&quot;</span>    </span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span>   </span><br><span class="line">    </span><br><span class="line">      <span class="comment"># 亲和性设置  </span></span><br><span class="line">      <span class="attr">affinity:</span>   </span><br><span class="line">        <span class="attr">nodeAffinity:</span> <span class="comment"># 设置node亲和性</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 软限制</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">preference:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span> <span class="comment"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签(当前环境没有)</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span> [<span class="string">&quot;pro&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>验证nfs挂载是否成功</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it deploy-nginx-7d9b78b676-dvbxh -n dev -- /bin/sh</span><br><span class="line"><span class="comment"># 进入容器挂载目录</span></span><br><span class="line"><span class="built_in">cd</span> /var/log/nginx</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="comment"># 1.txt  access.log  error.log  successful# 进入容器</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it deploy-nginx-7d9b78b676-dvbxh -n dev -- /bin/sh</span><br><span class="line"><span class="comment"># 进入容器挂载目录</span></span><br><span class="line"><span class="built_in">cd</span> /var/log/nginx</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="comment"># 1.txt  access.log  error.log  successful</span></span><br></pre></td></tr></table></figure><p><strong>对外暴露端口</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-nginx</span>    <span class="comment"># svc名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>     <span class="comment"># ns名称</span></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">label-test</span>     <span class="comment"># 标签</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.109</span><span class="number">.179</span><span class="number">.231</span> <span class="comment"># 固定svc的内网ip kubectl get svc -n dev 可查看</span></span><br><span class="line">  <span class="attr">ports:</span>                    <span class="comment"># 端口配置需要与上方一致  </span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span>                <span class="comment"># 宿主机端口</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span>          <span class="comment"># 容器端口  </span></span><br><span class="line">  <span class="attr">selector:</span>                 <span class="comment"># 选择对标签label-test操作</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">label-test</span> </span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>            <span class="comment"># 类型NodePort  </span></span><br></pre></td></tr></table></figure><p>效果</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_0b97396d49190205d9862e55a8af18ba.png"><strong>kubectl get pod -n dev –show-labels</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_a01f7f55492ae5715c4515d795d79cc5.png"></p><p><strong># 只筛选出标签是version=2.0的pod</strong></p><p><strong>kubectl get pods -l “version=2.0” -n dev –show-labels</strong></p><p><strong># 只筛选出标签是version=2.0的pod</strong></p><p><strong>kubectl get pods -l “version=2.0” -n dev –show-labels</strong></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssh暴力破解解决ssh白名单及防火墙设置</title>
      <link href="/2025/05/22/ssh%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E8%A7%A3%E5%86%B3ssh%E7%99%BD%E5%90%8D%E5%8D%95%E5%8F%8A%E9%98%B2%E7%81%AB%E5%A2%99%E8%AE%BE%E7%BD%AE/"/>
      <url>/2025/05/22/ssh%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E8%A7%A3%E5%86%B3ssh%E7%99%BD%E5%90%8D%E5%8D%95%E5%8F%8A%E9%98%B2%E7%81%AB%E5%A2%99%E8%AE%BE%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="ssh暴力破解解决ssh白名单及防火墙设置"><a href="#ssh暴力破解解决ssh白名单及防火墙设置" class="headerlink" title="ssh暴力破解解决ssh白名单及防火墙设置"></a>ssh暴力破解解决ssh白名单及防火墙设置</h1><p>从你的 <code>journalctl -u sshd -f</code> 日志来看，这些日志主要显示的是来自 <strong>外部 IP 对你的服务器 SSH 端口的连接尝试</strong>，并不属于你服务器自身的错误，而是一些典型的 <strong>暴力破解扫描行为（brute-force scan）</strong> 或 <strong>探测行为</strong>。下面是每条日志的含义解释：</p><hr><h3 id="🔍-日志分析："><a href="#🔍-日志分析：" class="headerlink" title="🔍 日志分析："></a>🔍 日志分析：</h3><h4 id="1-连接尝试然后关闭"><a href="#1-连接尝试然后关闭" class="headerlink" title="1. 连接尝试然后关闭"></a>1. <strong>连接尝试然后关闭</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">May 23 13:40:13 ... sshd[42391]: Connection from 165.154.168.234 port 53228 on 10.0.0.4 port 22</span><br><span class="line">May 23 13:40:18 ... sshd[42391]: Connection closed by 165.154.168.234 port 53228 [preauth]</span><br></pre></td></tr></table></figure><ul><li>说明：这个 IP 连接到了你的 SSH 端口，然后马上关闭连接了。</li><li>状态：可能是扫描器探测，没有进行登录尝试。</li></ul><hr><h4 id="2-暴力破解尝试"><a href="#2-暴力破解尝试" class="headerlink" title="2. 暴力破解尝试"></a>2. <strong>暴力破解尝试</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">May 23 13:40:52 ... sshd[42494]: Connection from 223.197.125.110 port 54040</span><br><span class="line">May 23 13:40:53 ... pam_unix(sshd:auth): authentication failure ... user=root</span><br><span class="line">May 23 13:40:54 ... sshd[42494]: Failed password for root from 223.197.125.110</span><br><span class="line">May 23 13:40:56 ... sshd[42494]: Received disconnect ... Bye Bye [preauth]</span><br></pre></td></tr></table></figure><ul><li>说明：这个 IP 尝试用 <code>root</code> 用户登录，密码验证失败。</li><li>状态：这是典型的暴力破解攻击。</li></ul><hr><h4 id="3-连接后立刻断开"><a href="#3-连接后立刻断开" class="headerlink" title="3. 连接后立刻断开"></a>3. <strong>连接后立刻断开</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">May 23 13:41:21 ... sshd[42588]: Connection from 193.32.162.185 ...</span><br><span class="line">May 23 13:41:22 ... error: kex_exchange_identification: Connection closed by remote host</span><br><span class="line">May 23 13:41:22 ... Connection closed by 193.32.162.185 ...</span><br></pre></td></tr></table></figure><ul><li>说明：连接建立后，尚未完成密钥交换就被远程主机关闭。</li><li>状态：也是扫描器或探测器的行为。</li></ul><hr><h3 id="🚨-总结"><a href="#🚨-总结" class="headerlink" title="🚨 总结"></a>🚨 总结</h3><p>这些日志表明你的服务器暴露在公网，正在被多个 IP 地址扫描或尝试暴力破解 SSH 登录。</p><hr><h3 id="✅-建议的安全措施："><a href="#✅-建议的安全措施：" class="headerlink" title="✅ 建议的安全措施："></a>✅ 建议的安全措施：</h3><ol><li><p><strong>禁止 root 登录：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 SSH 配置</span></span><br><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line"><span class="comment"># 设置：</span></span><br><span class="line">PermitRootLogin no</span><br><span class="line"><span class="comment"># 然后重启 SSH 服务</span></span><br><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure></li><li><p><strong>开启防火墙限制 SSH IP：</strong></p><ul><li>ufw<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 默认拒绝所有人访问 SSH（先清除现有规则）</span></span><br><span class="line">sudo ufw deny 22/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 允许指定 IP 访问 SSH</span></span><br><span class="line">sudo ufw allow from 203.0.113.10 to any port 22 proto tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启用 ufw（如果没启用过）</span></span><br><span class="line">sudo ufw <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 查看规则确认</span></span><br><span class="line">sudo ufw status numbered</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>iptables<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 先清除之前可能的规则（仅SSH相关）</span></span><br><span class="line">iptables -D INPUT -p tcp --dport 22 -j ACCEPT || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 允许指定 IP 访问端口 22</span></span><br><span class="line">iptables -A INPUT -p tcp -s 203.0.113.10 --dport 22 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 拒绝所有其他 IP 的 SSH 连接</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 保存规则（CentOS 7）</span></span><br><span class="line">service iptables save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者 Ubuntu:</span></span><br><span class="line">iptables-save &gt; /etc/iptables/rules.v4</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>只允许特定 IP 登录 SSH（如果你有固定 IP）：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-rich-rule=<span class="string">&#x27;rule family=&quot;ipv4&quot; source address=&quot;你的IP地址&quot; port protocol=&quot;tcp&quot; port=&quot;22&quot; accept&#x27;</span></span><br><span class="line">firewall-cmd --permanent --remove-service=ssh</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure></li></ul><p>或者开启root密码登录并限制 AllowUsers</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">开启root密码登录并限制 AllowUsers</span><br><span class="line"><span class="comment"># 查看访问本机的公网地址使用</span></span><br><span class="line">curl ifconfig.me</span><br><span class="line"><span class="comment"># 首先为 root 设置密码 后允许root用户登录</span></span><br><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line">PermitRootLogin <span class="built_in">yes</span></span><br><span class="line">AllowUsers root@127.0.0.1/32 root@本机所在的外网网段/31 root@内网ip段</span><br><span class="line"></span><br><span class="line">systemctl restart ssh</span><br></pre></td></tr></table></figure></li><li><p><strong>使用非标准端口（变更默认22端口）：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line">Port 22222  <span class="comment"># 改为你自定义的端口</span></span><br><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure></li><li><p><strong>使用 Fail2Ban 自动封锁暴力破解 IP：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release fail2ban</span><br><span class="line">yum install -y fail2ban</span><br><span class="line">systemctl <span class="built_in">enable</span> --now fail2ban</span><br></pre></td></tr></table></figure></li><li><p><strong>使用跳板机或 VPN 隐藏 SSH 接口</strong></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> ssh </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssh跳过一些 PAM鉴权</title>
      <link href="/2025/05/18/ssh%E8%B7%B3%E8%BF%87%E4%B8%80%E4%BA%9B%20PAM%E9%89%B4%E6%9D%83/"/>
      <url>/2025/05/18/ssh%E8%B7%B3%E8%BF%87%E4%B8%80%E4%BA%9B%20PAM%E9%89%B4%E6%9D%83/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ssh跳过一些-PAM鉴权"><a href="#ssh跳过一些-PAM鉴权" class="headerlink" title="ssh跳过一些 PAM鉴权"></a>ssh跳过一些 PAM鉴权</h2><hr><h3 id="🧩-什么是-PAM？"><a href="#🧩-什么是-PAM？" class="headerlink" title="🧩 什么是 PAM？"></a>🧩 什么是 PAM？</h3><p>PAM（Pluggable Authentication Modules）是 Linux 中一个可插拔的认证框架，它允许系统管理员灵活地配置用户认证机制。</p><p>在 SSH 登录过程中，PAM 是其中一个可选的认证机制。如果启用了 PAM，SSH 登录时就会调用 <code>/etc/pam.d/sshd</code> 文件中配置的模块进行一系列检查，比如：</p><ul><li>密码复杂度验证</li><li>是否允许特定用户或用户组登录</li><li>是否启用双因子认证</li><li>登录失败次数限制（如 <code>pam_tally2</code> 或 <code>pam_faillock</code>）</li><li>SELinux/安全策略限制等</li></ul><hr><h3 id="🛠️-SSH-配置文件中-PAM-相关项"><a href="#🛠️-SSH-配置文件中-PAM-相关项" class="headerlink" title="🛠️ SSH 配置文件中 PAM 相关项"></a>🛠️ SSH 配置文件中 PAM 相关项</h3><p>在 <code>/etc/ssh/sshd_config</code> 中有一项：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UsePAM <span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>含义如下：</p><ul><li><code>yes</code>：SSH 登录会调用 PAM 模块 <code>/etc/pam.d/sshd</code>，应用一系列策略检查。</li><li><code>no</code>：不使用 PAM，跳过这些策略，可能只依赖 <code>sshd_config</code> 中的其它登录控制项（如 <code>AllowUsers</code>、<code>PasswordAuthentication</code> 等）来决定是否允许登录。</li></ul><hr><h3 id="🧨-注意事项"><a href="#🧨-注意事项" class="headerlink" title="🧨 注意事项"></a>🧨 注意事项</h3><p>把 <code>UsePAM</code> 改成 <code>no</code> 虽然能跳过一些 PAM 限制，但也可能造成：</p><ol><li><strong>绕过安全限制</strong>，如密码尝试次数限制、防暴力破解等；</li><li><strong>某些登录验证机制失效</strong>，如使用 LDAP、指纹识别、MFA 等基于 PAM 的认证方法。</li></ol><hr><h3 id="✅-示例场景"><a href="#✅-示例场景" class="headerlink" title="✅ 示例场景"></a>✅ 示例场景</h3><p>你遇到过一些限制登录的问题，可能就是 PAM 模块（比如 <code>pam_access.so</code>）限制了用户登录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/pam.d/sshd 示例片段</span></span><br><span class="line">account    required     pam_access.so</span><br></pre></td></tr></table></figure><p>对应的 <code>/etc/security/access.conf</code> 可能配置了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-:testuser:ALL</span><br></pre></td></tr></table></figure><p>这样就会拒绝用户 <code>testuser</code> 的 SSH 登录。</p><p>若此时你把 <code>UsePAM no</code>，SSH 就不会再执行上面的 <code>pam_access.so</code> 检查了，用户就能绕过登录限制。</p><hr><h3 id="🔐-总结"><a href="#🔐-总结" class="headerlink" title="🔐 总结"></a>🔐 总结</h3><table><thead><tr><th>项</th><th>含义</th></tr></thead><tbody><tr><td><code>UsePAM yes</code></td><td>调用<code>/etc/pam.d/sshd</code>中的模块，执行多种安全检查</td></tr><tr><td><code>UsePAM no</code></td><td>不调用 PAM，简单认证流程，登录限制会变少</td></tr></tbody></table><p>是否启用 PAM 取决于你对安全性和控制能力的需求。需要安全策略就启用，想简化登录就关闭。</p><p>是否需要我帮你审查一下 <code>/etc/pam.d/sshd</code> 里面有哪些模块可能影响登录？</p>]]></content>
      
      
      <categories>
          
          <category> ssh </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos控制台登录报错Permission-denied</title>
      <link href="/2025/05/08/centos%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%99%BB%E5%BD%95%E6%8A%A5%E9%94%99Permission-denied/"/>
      <url>/2025/05/08/centos%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%99%BB%E5%BD%95%E6%8A%A5%E9%94%99Permission-denied/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="centos7账户名和密码都正确-却怎么都登录失败"><a href="#centos7账户名和密码都正确-却怎么都登录失败" class="headerlink" title="centos7账户名和密码都正确-却怎么都登录失败"></a><a href="https://www.cnblogs.com/tangshengjie/p/15645506.html" title="发布于 2021-12-05 18:49">centos7账户名和密码都正确-却怎么都登录失败</a></h1><p>参考：<a href="https://wn.zznnwn.cloudns.biz/2023/08/09/ubuntu18-04%E9%80%9A%E7%94%A8%E5%88%9D%E5%A7%8B%E5%8C%96/">https://wn.zznnwn.cloudns.biz/2023/08/09/ubuntu18-04%E9%80%9A%E7%94%A8%E5%88%9D%E5%A7%8B%E5%8C%96/</a></p><h1 id="问题概述及解决"><a href="#问题概述及解决" class="headerlink" title="问题概述及解决"></a>问题概述及解决</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>Centos 7 系统 优化系统内核后，账户无法登录（输入的账号和密码均正确，绝对没有错误!!,也没有禁止登录!!）。 报错为：Permission denied。</p><p>优化内核内容为：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/5/image_0e2522ad9bf3786bf27e2046dce4bc00.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/security/limits.conf</span><br><span class="line">* soft nofile 10000000  #错的，千万别用</span><br><span class="line">* hard nofile 10000000 #错的，千万别用</span><br><span class="line">* hard nproc 10000000 #错的，千万别用</span><br><span class="line">* soft nproc 10000000 #错的，千万别用</span><br></pre></td></tr></table></figure><p>报错截图：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/5/image_73846570bd70375dc0a70a26e4e670dc.png"></p><p>出现上述问题，是因为在优化内核参数时数值过大</p><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p><del>limit设置的最大进程数和打开的最大文件数超过了内核参数sysctl..conf定义的值就是超过了内核允许的默认最大值</del></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p |grep fs.file-max</span><br><span class="line">sysctl -p |grep fs.nr_open</span><br></pre></td></tr></table></figure><h2 id="问题解决方法一"><a href="#问题解决方法一" class="headerlink" title="问题解决方法一"></a>问题解决方法一</h2><p>修改内核参数为与limit一样的就行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/sysctl.conf </span></span><br><span class="line"><span class="comment"># sysctl settings are defined through files in</span></span><br><span class="line"><span class="comment"># /usr/lib/sysctl.d/, /run/sysctl.d/, and /etc/sysctl.d/.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Vendors settings live in /usr/lib/sysctl.d/.</span></span><br><span class="line"><span class="comment"># To override a whole file, create a new file with the same in</span></span><br><span class="line"><span class="comment"># /etc/sysctl.d/ and put new settings there. To override</span></span><br><span class="line"><span class="comment"># only specific settings, add a file with a lexically later</span></span><br><span class="line"><span class="comment"># name in /etc/sysctl.d/ and put new settings there.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, see sysctl.conf(5) and sysctl.d(5).</span></span><br><span class="line">fs.file-max = 10000000</span><br><span class="line">fs.nr_open = 10000000</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/6/image_a1768e4a3fbafdcf1b5fc43e10de07e0.png"></p><h2 id="问题解决方法二"><a href="#问题解决方法二" class="headerlink" title="问题解决方法二"></a>问题解决方法二</h2><p>进单用户模式将/etc/security/limits.conf 中的参数改为系统可承受的值，经过多次测验，最大可允许的数值为<code>1000009。</code></p><h1 id="问题发现及排查"><a href="#问题发现及排查" class="headerlink" title="问题发现及排查"></a>问题发现及排查</h1><h2 id="问题发现"><a href="#问题发现" class="headerlink" title="问题发现"></a>问题发现</h2><p>Centos系统部署完成，并进行系统内核调优，重启系统后，发现账户无法登录。确定输入的密码肯定正确，但是报错Permission denied。</p><p>解决</p><p>加载内核时按e键进入单用户模式</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/5/image_d73ddba442a5120ce2ad9054fe768241.png"></p><p>按方向键下键↓，找到设置语言的地方，如<code>LANG=en\_US.UTF-8</code>，在后面追加<code>rw single init=/bin/bash</code>,然后按<code>ctrl+x</code>重启系统</p><p>进入后就出现此报错</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/5/image_9ef4a15a2fde00976a591e39aff7b1ea.png"></p><p>修改内核参数为系统可以承受的范围</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/security/limits.conf</span><br><span class="line">* soft nofile 1000000</span><br><span class="line">* hard nofile 1000000</span><br><span class="line">* hard <span class="built_in">nproc</span> 10000000</span><br><span class="line">* soft <span class="built_in">nproc</span> 1000000</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>或修改为</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/security/limits.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">* - nofile 65535</span></span><br><span class="line"><span class="string">* - nproc 65535</span></span><br><span class="line"><span class="string">root - nofile 65535</span></span><br><span class="line"><span class="string">root - nproc 65535</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">ulimit</span> -HSn 65535</span><br><span class="line"><span class="built_in">ulimit</span> -a</span><br></pre></td></tr></table></figure><p>按Ctrl+D，执行reboot重启生效。</p><p>输入账户密码，成功登录。</p><p>至此，问题成功定位并解决。</p><p>输入<code>exec /sbin/init</code>命令重启系统</p><p><strong>参数解释：</strong></p><p><strong>以下是你提供的 <code>/etc/security/limits.conf</code> 配置的详细说明表格：</strong></p><table><thead><tr><th>用户/组</th><th>类型</th><th>项目</th><th>限制值</th><th>说明</th></tr></thead><tbody><tr><td><code>*</code></td><td>soft</td><td>nofile</td><td>1000000</td><td>每个进程可打开的最大文件数（软限制）</td></tr><tr><td><code>*</code></td><td>hard</td><td>nofile</td><td>1000000</td><td>每个进程可打开的最大文件数（硬限制）</td></tr><tr><td><code>*</code></td><td>hard</td><td>nproc</td><td>10000000</td><td>每个用户可创建的最大进程数（硬限制）</td></tr><tr><td><code>*</code></td><td>soft</td><td>nproc</td><td>1000000</td><td>每个用户可创建的最大进程数（软限制）</td></tr></tbody></table><p><strong>/etc/security/limits.conf 设置内容解析</strong></p><table><thead><tr><th>用户/组</th><th>类型</th><th>项目</th><th>限制值</th><th>说明</th></tr></thead><tbody><tr><td><code>*</code></td><td><code>-</code></td><td>nofile</td><td>65535</td><td>所有用户最大可打开文件数（软硬限制都设置）</td></tr><tr><td><code>*</code></td><td><code>-</code></td><td>nproc</td><td>65535</td><td>所有用户最大可创建进程数（软硬限制都设置）</td></tr><tr><td><code>root</code></td><td><code>-</code></td><td>nofile</td><td>65535</td><td>root 用户最大可打开文件数（软硬限制都设置）</td></tr><tr><td><code>root</code></td><td><code>-</code></td><td>nproc</td><td>65535</td><td>root 用户最大可创建进程数（软硬限制都设置）</td></tr></tbody></table><blockquote><p>注：<code>-</code> 表示同时设置软限制（soft）和硬限制（hard）</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* hard nofile 1000000</span><br></pre></td></tr></table></figure><ul><li><strong>含义</strong>：所有用户的 <strong>hard（硬限制）</strong> 的 <code>nofile</code> 为 <code>1000000</code>。</li><li><strong>硬限制</strong> 是系统强制施加的上限，不能被非特权用户提升。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* hard <span class="built_in">nproc</span> 10000000</span><br></pre></td></tr></table></figure><ul><li><strong>含义</strong>：所有用户的 <strong>硬限制</strong> 的 <code>nproc</code>（每个用户能创建的最大进程数）为 <code>10000000</code>。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* soft <span class="built_in">nproc</span> 1000000</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><strong>含义</strong>：所有用户的 <strong>软限制</strong> 的 <code>nproc</code> 为 <code>1000000</code>。</li></ul><p><strong>Shell 命令解析</strong></p><table><thead><tr><th>命令</th><th>作用说明</th></tr></thead><tbody><tr><td><code>ulimit -HSn 65535</code></td><td>设置当前 shell 会话的文件描述符软硬限制为 65535</td></tr><tr><td><code>ulimit -a</code></td><td>查看当前 shell 会话的所有资源限制</td></tr></tbody></table><hr><p>ulimit -a 输出参数解释表（含常见字段）</p><p>以下是 <code>ulimit -a</code> 可能输出的项目及含义（具体输出会因系统而异）：</p><table><thead><tr><th>参数名称</th><th>说明</th></tr></thead><tbody><tr><td>core file size</td><td>生成 core dump 文件的最大大小（单位 blocks）</td></tr><tr><td>data seg size</td><td>数据段的最大大小（进程可用的数据空间）</td></tr><tr><td>scheduling priority</td><td>进程调度优先级</td></tr><tr><td>file size</td><td>单个文件的最大可写入大小</td></tr><tr><td>open files (<code>nofile</code>)</td><td>每个进程最大可打开的文件描述符数</td></tr><tr><td>pipe size</td><td>管道缓冲区大小</td></tr><tr><td>POSIX message queues</td><td>POSIX 消息队列可用的最大内存</td></tr><tr><td>real-time priority</td><td>实时调度策略的优先级</td></tr><tr><td>stack size</td><td>线程栈大小限制</td></tr><tr><td>cpu time</td><td>单个进程可使用的 CPU 时间限制（单位秒）</td></tr><tr><td>max user processes (<code>nproc</code>)</td><td>每个用户允许的最大进程数（包括线程）</td></tr><tr><td>virtual memory</td><td>可用的虚拟内存总量（地址空间）</td></tr><tr><td>locked-in-memory size</td><td>允许锁定到 RAM 的内存最大值</td></tr></tbody></table><p><strong>补充说明</strong>：</p><ul><li><code>*</code> 表示对所有用户生效。</li><li><code>soft</code>（软限制）可以由用户自己临时提高到 <code>hard</code> 限值以下。</li><li><code>hard</code>（硬限制）是系统施加的最大限制，不能被非 root 用户提高。</li><li><code>nofile</code>：最大文件描述符数量，影响网络连接、文件打开等。</li><li><code>nproc</code>：最大进程数，影响用户能同时运行多少进程或线程。</li></ul><p>你是在哪种场景下需要设这么高的 <code>nofile</code> 和 <code>nproc</code>？是做高并发服务（如 Nginx、Redis、Kafka）还是 AI 模型计算类任务？</p><h3 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h3><ol><li><p>这些限制只会在使用 PAM 登录时生效（如 SSH、su、login 等）。</p></li><li><p>要让它生效，还要确保 <code>/etc/pam.d/common-session</code> 或 <code>/etc/pam.d/sshd</code> 中有如下配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session required pam_limits.so</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>设置过高的值（比如 <code>nproc</code> 设到千万级）如果没有必要，可能导致系统资源耗尽或被滥用，建议根据实际情况设置。</p></li></ol><p>你是为哪类应用或服务配置这么大的资源限制？</p>]]></content>
      
      
      <categories>
          
          <category> default </category>
          
      </categories>
      
      
        <tags>
            
            <tag> default </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Centos创建iscsi存储</title>
      <link href="/2025/04/28/Centos%E5%88%9B%E5%BB%BAiscsi%E5%AD%98%E5%82%A8/"/>
      <url>/2025/04/28/Centos%E5%88%9B%E5%BB%BAiscsi%E5%AD%98%E5%82%A8/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Centos创建iscsi存储"><a href="#Centos创建iscsi存储" class="headerlink" title="Centos创建iscsi存储"></a>Centos创建iscsi存储</h1><p>参考：</p><p><a href="https://blog.csdn.net/weixin_45052781/article/details/121300343">https://blog.csdn.net/weixin_45052781/article/details/121300343</a></p><h3 id="ISCSI服务介绍"><a href="#ISCSI服务介绍" class="headerlink" title="ISCSI服务介绍"></a>ISCSI服务介绍</h3><ul><li>全称：Internet Small Computer System Interface——互联网小型计算机接口<br>通过网络获取磁盘设备在本地进行存储使用。</li><li>iscsi是基于TCP/IP和scsi协议的一项技术，任一主机通过iscsi target功能成为iscsi存储空间的共享者/服务端；同样的，任一主机通过iscsi initiator(初始化用户)功能可以成为iscsi存储空间的使用者/客户端；限制iscsi的相互之间的联系需要配置规则，在无规则情况下，双方是可以建立联系的</li></ul><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/4/image_754fb78a46fd0fc815ae53870f2416e4.png"></p><ul><li>由于iscsi和scsi差的是一个internet（tcp/ip协议），大同小异，所以<strong>阅读本文时可以将iscsi和scsi视为同一物</strong>。（<strong>虽然严格来说不一样</strong>）</li></ul><h3 id="环境规划"><a href="#环境规划" class="headerlink" title="环境规划"></a>环境规划</h3><table><thead><tr><th>地址</th><th>角色</th><th>其他</th></tr></thead><tbody><tr><td>10.0.0.10</td><td>服务端</td><td>无</td></tr><tr><td>10.0.0.11</td><td>客户端</td><td>无</td></tr></tbody></table><h3 id="服务端搭建"><a href="#服务端搭建" class="headerlink" title="服务端搭建"></a>服务端搭建</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/4/image_7a9f43f9608836490af7ea99d7e0f177.png"></p><h4 id="安装服务端软件"><a href="#安装服务端软件" class="headerlink" title="安装服务端软件"></a>安装服务端软件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装软件</span></span><br><span class="line">yum install targetcli.noarch  -y</span><br><span class="line">yum install targetd targetcli -y  <span class="comment"># 共享磁盘服务</span></span><br></pre></td></tr></table></figure><h4 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart target //重启target服务</span><br><span class="line">systemctl stop firewalld //记得关闭防火墙或者配置防火墙规则也可以</span><br><span class="line"><span class="comment"># centos7永久开放3260端口：</span></span><br><span class="line">firewall-cmd --zone=public --add-port=3260/tcp --permanent</span><br><span class="line">setenforce 0 //暂时关闭selinux</span><br></pre></td></tr></table></figure><h4 id="配置服务端输入-targetcli-进入交互式界面"><a href="#配置服务端输入-targetcli-进入交互式界面" class="headerlink" title="配置服务端输入 targetcli 进入交互式界面"></a>配置服务端输入 targetcli 进入交互式界面</h4><p>交互式操作需要用到的命令：标黄色部分</p><p>targetcli</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@zxw1 ~]<span class="comment"># targetcli</span></span><br><span class="line">Warning: Could not load preferences file /root/.targetcli/prefs.bin.</span><br><span class="line">targetcli shell version 2.1.53</span><br><span class="line">Copyright 2011-2013 by Datera, Inc and others.</span><br><span class="line">For <span class="built_in">help</span> on commands, <span class="built_in">type</span> <span class="string">&#x27;help&#x27;</span>.</span><br><span class="line"></span><br><span class="line">/&gt; <span class="built_in">ls</span></span><br><span class="line">o- / ......................................................................................................................... [...]</span><br><span class="line">  o- backstores .............................................................................................................. [...]</span><br><span class="line">  | o- block .................................................................................................. [Storage Objects: 0]</span><br><span class="line">  | o- fileio ................................................................................................. [Storage Objects: 0]</span><br><span class="line">  | o- pscsi .................................................................................................. [Storage Objects: 0]</span><br><span class="line">  | o- ramdisk ................................................................................................ [Storage Objects: 0]</span><br><span class="line">  o- iscsi ............................................................................................................ [Targets: 0]</span><br><span class="line">  o- loopback ......................................................................................................... [Targets: 0]</span><br><span class="line">/&gt; <span class="built_in">cd</span> /backstores/block</span><br><span class="line">/backstores/block&gt; <span class="built_in">ls</span></span><br><span class="line">o- block ...................................................................................................... [Storage Objects: 0]</span><br><span class="line">/backstores/block&gt; create dev=/dev/sdb name=disk0</span><br><span class="line">Created block storage object disk0 using /dev/sdb.</span><br><span class="line">/backstores/block&gt; <span class="built_in">cd</span> iscsi</span><br><span class="line">No such path /backstores/block/iscsi</span><br><span class="line">/backstores/block&gt; <span class="built_in">ls</span></span><br><span class="line">o- block ...................................................................................................... [Storage Objects: 1]</span><br><span class="line">  o- disk0 .............................................................................. [/dev/sdb (5.0GiB) write-thru deactivated]</span><br><span class="line">    o- alua ....................................................................................................... [ALUA Groups: 1]</span><br><span class="line">      o- default_tg_pt_gp ........................................................................... [ALUA state: Active/optimized]</span><br><span class="line">/backstores/block&gt; <span class="built_in">cd</span>  /iscsi</span><br><span class="line">/iscsi&gt; <span class="built_in">ls</span></span><br><span class="line">o- iscsi .............................................................................................................. [Targets: 0]</span><br><span class="line">/iscsi&gt; create</span><br><span class="line">Created target iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22.</span><br><span class="line">Created TPG 1.</span><br><span class="line">Global pref auto_add_default_portal=<span class="literal">true</span></span><br><span class="line">Created default portal listening on all IPs (0.0.0.0), port 3260.</span><br><span class="line">/iscsi&gt; <span class="built_in">ls</span></span><br><span class="line">o- iscsi .............................................................................................................. [Targets: 1]</span><br><span class="line">  o- iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22 .............................................................. [TPGs: 1]</span><br><span class="line">    o- tpg1 ................................................................................................. [no-gen-acls, no-auth]</span><br><span class="line">      o- acls ............................................................................................................ [ACLs: 0]</span><br><span class="line">      o- luns ............................................................................................................ [LUNs: 0]</span><br><span class="line">      o- portals ...................................................................................................... [Portals: 1]</span><br><span class="line">        o- 0.0.0.0:3260 ....................................................................................................... [OK]</span><br><span class="line">/iscsi&gt; <span class="built_in">cd</span> iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22/tpg1/</span><br><span class="line">/iscsi/iqn.20...f8aabb22/tpg1&gt; <span class="built_in">ls</span></span><br><span class="line">o- tpg1 ..................................................................................................... [no-gen-acls, no-auth]</span><br><span class="line">  o- acls ................................................................................................................ [ACLs: 0]</span><br><span class="line">  o- luns ................................................................................................................ [LUNs: 0]</span><br><span class="line">  o- portals .......................................................................................................... [Portals: 1]</span><br><span class="line">    o- 0.0.0.0:3260 ........................................................................................................... [OK]</span><br><span class="line">/iscsi/iqn.20...f8aabb22/tpg1&gt; <span class="built_in">set</span> attribute authentication=0 demo_mode_write_protect=0 generate_node_acls=1 cache_dynamic_acls=1</span><br><span class="line">Parameter demo_mode_write_protect is now <span class="string">&#x27;0&#x27;</span>.</span><br><span class="line">Parameter authentication is now <span class="string">&#x27;0&#x27;</span>.</span><br><span class="line">Parameter generate_node_acls is now <span class="string">&#x27;1&#x27;</span>.</span><br><span class="line">Parameter cache_dynamic_acls is now <span class="string">&#x27;1&#x27;</span>.</span><br><span class="line">/iscsi/iqn.20...f8aabb22/tpg1&gt; <span class="built_in">cd</span> luns</span><br><span class="line">/iscsi/iqn.20...b22/tpg1/luns&gt; <span class="built_in">ls</span></span><br><span class="line">o- luns .................................................................................................................. [LUNs: 0]</span><br><span class="line">/iscsi/iqn.20...b22/tpg1/luns&gt; create /backstores/block/disk0</span><br><span class="line">Created LUN 0.</span><br><span class="line">/iscsi/iqn.20...b22/tpg1/luns&gt; <span class="built_in">exit</span></span><br><span class="line">Global pref auto_save_on_exit=<span class="literal">true</span></span><br><span class="line">Configuration saved to /etc/target/saveconfig.json</span><br></pre></td></tr></table></figure><p>上述无论任何<code>IP</code>客服端均可连接</p><h4 id="参数命令解释"><a href="#参数命令解释" class="headerlink" title="参数命令解释"></a>参数命令解释</h4><h5 id="配置iscsi服务器端的共享资源"><a href="#配置iscsi服务器端的共享资源" class="headerlink" title="配置iscsi服务器端的共享资源"></a>配置iscsi服务器端的共享资源</h5><ul><li>使用targetcli命令管理iscsi的配置，它提供了一个交互式的配置界面，类似fdisk命令</li><li>执行targetcli进入配置界面</li><li>查看初始配置</li></ul><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/4/image_73eda6e10ee26ffb5dcc9c1fd4ceba88.png"></p><p>进入到 /backstores/block 目录，将创建的md0或者磁盘添加到共享设备的“资源池”中</p><p>将文件重新命名为disk0</p><p>backstores/block #物理卷 如果创建的是物理卷在该目录创建</p><p>backstores/fileio #逻辑卷 如果创建的是逻辑卷在该目录创建 如lv</p><p>我们之前加入了一个sdb磁盘</p><p>利用sdb创建</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> backstores/block</span><br><span class="line">create disk0 /dev/sdb</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/4/image_f941ceee7ed5e18a2aab70d2e9df9ef5.png"></p><h4 id="创建iscsi-target名称及配置共享资源"><a href="#创建iscsi-target名称及配置共享资源" class="headerlink" title="创建iscsi target名称及配置共享资源"></a>创建iscsi target名称及配置共享资源</h4><ul><li>iscsi target名称是由系统自动生成的，这是一串用于描述共享资源的唯一字符串</li><li>用户在扫描iscsi服务端时会显示这个target名称。进入到/iscsi目录下，生成target名称，</li><li>同时会创建一个同名的“目录”，来存放共享资源</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /iscsi</span><br><span class="line">create</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/4/image_4f835ddcf8d451cacc98030fdedc37c7.png"></p><h5 id="进入到新创建的目录中，将disk0添加到这个新目录"><a href="#进入到新创建的目录中，将disk0添加到这个新目录" class="headerlink" title="进入到新创建的目录中，将disk0添加到这个新目录"></a>进入到新创建的目录中，将disk0添加到这个新目录</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> iqn.2003-01.org.linux-iscsi.ceph01.x8664:sn.22f6a7064678/tpg1/luns</span><br><span class="line"></span><br><span class="line">create /backstores/block/disk0</span><br></pre></td></tr></table></figure><p>目录：/iscsi/iqn.2003-01.org.linux-iscsi.ceph01.x8664:sn.22f6a7064678/tpg1/luns</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/4/image_520faee99bc566524dc5ede08cb63a58.png"></p><h3 id="二、设置访问控制列表-ACL"><a href="#二、设置访问控制列表-ACL" class="headerlink" title="二、设置访问控制列表(ACL)"></a>二、设置访问控制列表(ACL)</h3><ul><li><p>不设置则所有人都可以挂载此块磁盘</p></li><li><p>名称与服务端中设置的访问控制列表中某一名称条目一致即可。acls参数目录用于存放能够访问iscsi服务</p></li><li><p>共享存储资源的客户端名称。</p></li><li><p>在iscsi服务端的配置文件中写入一串能够验证用户信息的名称，这里使用target名称，加上:client，这个</p></li><li><p>自己定义的字符串，具有唯一性即可</p></li><li><p>iscsi协议是通过客户端名称进行验证的，用户在访问存储共享资源是不需要输入密码，只要iscsi客户端的</p></li><li><p>targetcli进入交互界面</p><p>目录：/iscsi/iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22/tpg1/acls</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/4/image_dc18bb21ec3942cd2a585e58dfa4608d.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /iscsi/iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22/tpg1/acls</span><br><span class="line">create iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22:client</span><br></pre></td></tr></table></figure></li></ul><h4 id="设置iscsi服务端监听的IP和端口号"><a href="#设置iscsi服务端监听的IP和端口号" class="headerlink" title="设置iscsi服务端监听的IP和端口号"></a>设置iscsi服务端监听的IP和端口号</h4><p>目录：/iscsi/iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22/tpg1/portals</p><p>此IP需要是服务端的IP（10.0.0.10）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /iscsi/iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22/tpg1/portals</span><br><span class="line">delete 0.0.0.0 3260</span><br><span class="line">create 10.0.0.10 3260</span><br></pre></td></tr></table></figure><p>先删掉之前默认生成的0.0.0.0否则会报错</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/4/image_5684c7857214ab2948680e4db85dc616.png"></p><p>检查配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/iscsi/iqn.20.../tpg1/portals&gt; <span class="built_in">cd</span> /</span><br><span class="line">/&gt; <span class="built_in">ls</span></span><br><span class="line">o- / ......................................................................................................................... [...]</span><br><span class="line">  o- backstores .............................................................................................................. [...]</span><br><span class="line">  | o- block .................................................................................................. [Storage Objects: 1]</span><br><span class="line">  | | o- disk0 ............................................................................ [/dev/sdb (5.0GiB) write-thru activated]</span><br><span class="line">  | |   o- alua ................................................................................................... [ALUA Groups: 1]</span><br><span class="line">  | |     o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized]</span><br><span class="line">  | o- fileio ................................................................................................. [Storage Objects: 0]</span><br><span class="line">  | o- pscsi .................................................................................................. [Storage Objects: 0]</span><br><span class="line">  | o- ramdisk ................................................................................................ [Storage Objects: 0]</span><br><span class="line">  o- iscsi ............................................................................................................ [Targets: 1]</span><br><span class="line">  | o- iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22 ............................................................ [TPGs: 1]</span><br><span class="line">  |   o- tpg1 .................................................................................................. [gen-acls, no-auth]</span><br><span class="line">  |     o- acls .......................................................................................................... [ACLs: 1]</span><br><span class="line">  |     | o- iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22:client ........................................ [Mapped LUNs: 1]</span><br><span class="line">  |     |   o- mapped_lun0 ................................................................................. [lun0 block/disk0 (rw)]</span><br><span class="line">  |     o- luns .......................................................................................................... [LUNs: 1]</span><br><span class="line">  |     | o- lun0 ...................................................................... [block/disk0 (/dev/sdb) (default_tg_pt_gp)]</span><br><span class="line">  |     o- portals .................................................................................................... [Portals: 1]</span><br><span class="line">  |       o- 10.0.0.11:3260 ................................................................................................... [OK]</span><br><span class="line">  o- loopback ......................................................................................................... [Targets: 0]</span><br><span class="line">/&gt; saveconfig</span><br><span class="line">Last 10 configs saved <span class="keyword">in</span> /etc/target/backup/.</span><br><span class="line">Configuration saved to /etc/target/saveconfig.json</span><br></pre></td></tr></table></figure><p>最后：saveconfig 保存</p><p>若：有多块磁盘依次创建即可</p><p><strong>如果一个客服端要连接多个服务端则需要设置的chap一样 ascl一样如下</strong></p><h3 id="三、重启服务，配置防火墙"><a href="#三、重启服务，配置防火墙" class="headerlink" title="三、重启服务，配置防火墙"></a>三、重启服务，配置防火墙</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart targetd</span><br><span class="line">firewall-cmd --permanent --add-port=3260/tcp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><p>iscsi服务器端配置完成。</p><h3 id="四、iscsi客户端搭建"><a href="#四、iscsi客户端搭建" class="headerlink" title="四、iscsi客户端搭建"></a>四、iscsi客户端搭建</h3><h4 id="配置linux客户端"><a href="#配置linux客户端" class="headerlink" title="配置linux客户端"></a>配置linux客户端</h4><p>使用yum安装客户端软件iscsi-initiator-utils</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install iscsi-initiator-utils -y</span><br></pre></td></tr></table></figure><h5 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h5><p>编辑客户端中的initiator名称文件，把服务器端的访问控制列表名称填写进来(服务器端acls目录中自定义的名称),重启服务。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/iscsi/initiatorname.iscsi</span><br><span class="line"><span class="comment"># 默认配置</span></span><br><span class="line">InitiatorName=iqn.1994-05.com.redhat:391499fd3913</span><br><span class="line"><span class="comment"># 修改后</span></span><br><span class="line">InitiatorName=iqn.1994-05.com.redhat:391499fd3913</span><br><span class="line">InitiatorName=iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22:client</span><br><span class="line"><span class="comment"># 重启客户端</span></span><br><span class="line">systemctl restart iscsid</span><br><span class="line">systemctl <span class="built_in">enable</span> iscsid</span><br></pre></td></tr></table></figure><h5 id="扫描iscsi服务器端，查看可用的共享存储资源"><a href="#扫描iscsi服务器端，查看可用的共享存储资源" class="headerlink" title="扫描iscsi服务器端，查看可用的共享存储资源"></a>扫描iscsi服务器端，查看可用的共享存储资源</h5><ul><li><p>口诀“先发现，在登陆，最后挂载并使用”。</p></li><li><p>iscsiadm 用于管理、查询、插入、更新或删除iscsi数据库配置文件的工具。</p></li><li><p>-m discovery 扫描并发现可用的存储资源</p></li><li><p>-t st 执行扫描操作的类型</p></li><li><p>-p 192.168.137.10 参数为iscsi服务端的IP地址</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iscsiadm -m discovery -t st -p 10.0.0.10</span><br></pre></td></tr></table></figure><h5 id="登录iscsi服务端"><a href="#登录iscsi服务端" class="headerlink" title="登录iscsi服务端"></a>登录iscsi服务端</h5><ul><li>使用iscsiadm命令</li><li>-m node 将客户端所在主机作为一台节点服务器</li><li>-T iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22 指定要使用的资源</li><li>–login 或-l 进行登录验证</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iscsiadm -m node -T iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22 -p 10.0.0.10 --login</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">successful</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/4/image_d32627fc0d656f836035e9f6bf231244.png"></p><p>登录成功后，会在客户端多出一块存储设备/dev/sdb(设备名可能不同)，现在就可以对新设备进行分区，挂载使用了。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/4/image_e85da5af0ba2ea08659ee7ab4b410654.png"></p><h3 id="四、卸载存储设备"><a href="#四、卸载存储设备" class="headerlink" title="四、卸载存储设备"></a>四、卸载存储设备</h3><p>使用iscsiadm -u 将设备卸载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iscsiadm -m node -T iqn.2003-01.org.linux-iscsi.zxw1.x8664:sn.a27ff8aabb22 -p 10.0.0.10 -u</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="五、扩展"><a href="#五、扩展" class="headerlink" title="五、扩展"></a>五、扩展</h3><p>创建chap认证 等待下次文档更新时间</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gpu驱动持久化及nvlink检查</title>
      <link href="/2025/04/07/gpu%E9%A9%B1%E5%8A%A8%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%8Anvlink%E6%A3%80%E6%9F%A5/"/>
      <url>/2025/04/07/gpu%E9%A9%B1%E5%8A%A8%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%8Anvlink%E6%A3%80%E6%9F%A5/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="gpu驱动持久化及nvlink检查"><a href="#gpu驱动持久化及nvlink检查" class="headerlink" title="gpu驱动持久化及nvlink检查"></a>gpu驱动持久化及nvlink检查</h2><blockquote><p>GPU内存常驻<br>使用root用户或sudo权限运行以下命令来设置GPU驱动的内存常驻模式：nvidia-smi -pm 1<br>需要注意的是，启用GPU驱动的内存常驻模式会持续占用系统资源，并增加能耗。因此，在使用完毕后，如果不再需要常驻模式，建议将其禁用，以节省资源和能源。可以使用以下命令将GPU驱动程序设置为非常驻模式：nvidia-smi -pm 0</p></blockquote><p>转载：</p><p><a href="https://blog.csdn.net/weixin_54757969/article/details/131960450">https://blog.csdn.net/weixin_54757969/article/details/131960450</a></p><h3 id="操作系统及NVlink桥接及gpu驱动持久化"><a href="#操作系统及NVlink桥接及gpu驱动持久化" class="headerlink" title="操作系统及NVlink桥接及gpu驱动持久化"></a>操作系统及NVlink桥接及gpu驱动持久化</h3><p>我最熟悉的linux操作系统是Ubuntu，起初想装23.04，它的内核是6.2。最终选择了装Ubuntu22.04，考虑就是这个版本支持较好。基本上所有的支持linux软件，都有Ubuntu22.04的安装方法。我没装server版，直接上了桌面版本，显卡驱动版本530.41.03。（注：后来我为了安装cuda11.7.1及cudnn8.6，把驱动降至515.65.01,2023.7.26）</p><p>然后是让NVlink工作，需要开启驱动持久化模式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi -pm 1</span><br><span class="line">sudo reboot</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>检查方法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi topo -m</span><br><span class="line"></span><br><span class="line">GPU0GPU1CPU AffinityNUMA Affinity</span><br><span class="line">GPU0 X NV40-23N/A</span><br><span class="line">GPU1NV4 X 0-23N/A</span><br></pre></td></tr></table></figure><p>这里有一个事项要说明，NVlink插好时，会发现咔哒一声。起初我插完后，持久化重启，用检查命令查不到nvlink工作。后来断电关机，重新插了一次NVlink，听到咔哒一声。然后再开机，一切正常了。测试一下桥接速度，不知道为何14GB，快吗？</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">allonx@x299:~/qmx_projects/langchain-ChatGLM$ nvidia-smi nvlink -s</span><br><span class="line">GPU 0: NVIDIA GeForce RTX 3090 (UUID: GPU-9cca89b5-8627-6cff-7cb4-d8fae8dfadbe)</span><br><span class="line"> Link 0: 14.062 GB/s</span><br><span class="line"> Link 1: 14.062 GB/s</span><br><span class="line"> Link 2: 14.062 GB/s</span><br><span class="line"> Link 3: 14.062 GB/s</span><br><span class="line">GPU 1: NVIDIA GeForce RTX 3090 (UUID: GPU-f3fc3749-f793-189f-b592-5af6bb39a569)</span><br><span class="line"> Link 0: 14.062 GB/s</span><br><span class="line"> Link 1: 14.062 GB/s</span><br><span class="line"> Link 2: 14.062 GB/s</span><br><span class="line"> Link 3: 14.062 GB/s</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>再查一下详细情况：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">allonx@x299:~/qmx_projects/langchain-ChatGLM$ nvidia-smi nvlink -c</span><br><span class="line">GPU 0: NVIDIA GeForce RTX 3090 (UUID: GPU-9cca89b5-8627-6cff-7cb4-d8fae8dfadbe)</span><br><span class="line"> Link 0, P2P is supported: <span class="literal">true</span></span><br><span class="line"> Link 0, Access to system memory supported: <span class="literal">true</span></span><br><span class="line"> Link 0, P2P atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 0, System memory atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 0, SLI is supported: <span class="literal">true</span></span><br><span class="line"> Link 0, Link is supported: <span class="literal">false</span></span><br><span class="line"> Link 1, P2P is supported: <span class="literal">true</span></span><br><span class="line"> Link 1, Access to system memory supported: <span class="literal">true</span></span><br><span class="line"> Link 1, P2P atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 1, System memory atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 1, SLI is supported: <span class="literal">true</span></span><br><span class="line"> Link 1, Link is supported: <span class="literal">false</span></span><br><span class="line"> Link 2, P2P is supported: <span class="literal">true</span></span><br><span class="line"> Link 2, Access to system memory supported: <span class="literal">true</span></span><br><span class="line"> Link 2, P2P atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 2, System memory atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 2, SLI is supported: <span class="literal">true</span></span><br><span class="line"> Link 2, Link is supported: <span class="literal">false</span></span><br><span class="line"> Link 3, P2P is supported: <span class="literal">true</span></span><br><span class="line"> Link 3, Access to system memory supported: <span class="literal">true</span></span><br><span class="line"> Link 3, P2P atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 3, System memory atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 3, SLI is supported: <span class="literal">true</span></span><br><span class="line"> Link 3, Link is supported: <span class="literal">false</span></span><br><span class="line">GPU 1: NVIDIA GeForce RTX 3090 (UUID: GPU-f3fc3749-f793-189f-b592-5af6bb39a569)</span><br><span class="line"> Link 0, P2P is supported: <span class="literal">true</span></span><br><span class="line"> Link 0, Access to system memory supported: <span class="literal">true</span></span><br><span class="line"> Link 0, P2P atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 0, System memory atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 0, SLI is supported: <span class="literal">true</span></span><br><span class="line"> Link 0, Link is supported: <span class="literal">false</span></span><br><span class="line"> Link 1, P2P is supported: <span class="literal">true</span></span><br><span class="line"> Link 1, Access to system memory supported: <span class="literal">true</span></span><br><span class="line"> Link 1, P2P atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 1, System memory atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 1, SLI is supported: <span class="literal">true</span></span><br><span class="line"> Link 1, Link is supported: <span class="literal">false</span></span><br><span class="line"> Link 2, P2P is supported: <span class="literal">true</span></span><br><span class="line"> Link 2, Access to system memory supported: <span class="literal">true</span></span><br><span class="line"> Link 2, P2P atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 2, System memory atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 2, SLI is supported: <span class="literal">true</span></span><br><span class="line"> Link 2, Link is supported: <span class="literal">false</span></span><br><span class="line"> Link 3, P2P is supported: <span class="literal">true</span></span><br><span class="line"> Link 3, Access to system memory supported: <span class="literal">true</span></span><br><span class="line"> Link 3, P2P atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 3, System memory atomics supported: <span class="literal">true</span></span><br><span class="line"> Link 3, SLI is supported: <span class="literal">true</span></span><br><span class="line"> Link 3, Link is supported: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中有提示“Link is supported: false”，不明就里，上网查了一下，有一个人与我一样的情况，回复说是正常。</p><p>总体来说，这个主机方案接近完美，为了省钱，我没选择水冷，采用了经济实惠的风冷方案。</p><p>装机之后，我先装了一个windows系统测试。可能是这块主板有些古老（2017年生产），试了几次我都没法成功安装win11，只能安装win10。用cup-z、gpu-z、鲁大师、3dmark都进行了测试。也许是华硕tuf 3090都这样，3dmark稳定度测试最高都只达到97%-98%之间，算是勉强通过了测试。</p><p>另有一个小小的缺憾，就是这台工作站的主机上面缺少了档板，不知道是不是长期运行主机会进入大量灰尘。而且x299 gaming7的档板很难配，偶尔有卖的，一块档板竟要价近300元。实在没必要。</p><h3 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/339893484">https://zhuanlan.zhihu.com/p/339893484</a></li><li><a href="https://www.pugetsystems.com/labs/articles/NVIDIA-NVLink-2021-Update-and-Compatibility-Chart-2074/">https://www.pugetsystems.com/labs/articles/NVIDIA-NVLink-2021-Update-and-Compatibility-Chart-2074/</a></li><li><a href="https://forums.developer.nvidia.com/t/two-dual-geforce-rtx-3090s-and-nvlink-ubuntu-support-at-least-blender-has-support-for-nvlink/160561">https://forums.developer.nvidia.com/t/two-dual-geforce-rtx-3090s-and-nvlink-ubuntu-support-at-least-blender-has-support-for-nvlink/160561</a></li><li><a href="https://forums.developer.nvidia.com/t/two-rtx-a6000-nvlink-link-is-supported-false/177285">https://forums.developer.nvidia.com/t/two-rtx-a6000-nvlink-link-is-supported-false/177285</a></li></ul><p>gpu p2p通信科普</p><blockquote><p>在多GPU服务器或工作站中，<strong>P2P（Peer-to-Peer）通信</strong>是指<strong>GPU卡之间直接进行数据传输</strong>，绕过主机CPU和内存，达到更高的带宽和更低的延迟。</p><h3 id="GPU间P2P（Peer-to-Peer）含义"><a href="#GPU间P2P（Peer-to-Peer）含义" class="headerlink" title="GPU间P2P（Peer-to-Peer）含义"></a>GPU间P2P（Peer-to-Peer）含义</h3><p>通常情况下，多张GPU卡需要共享数据。例如，一个深度学习模型的不同层分布在不同GPU上，需要频繁交换中间结果。这种时候，P2P通信就很关键。</p><hr><h3 id="P2P的两种模式"><a href="#P2P的两种模式" class="headerlink" title="P2P的两种模式"></a>P2P的两种模式</h3><ol><li><strong>P2P Memory Access（内存访问）</strong><ul><li>一张GPU可以直接读写另一张GPU的内存（global memory）。</li></ul></li><li><strong>P2P Memory Copy（内存拷贝）</strong><ul><li>在编程中使用 <code>cudaMemcpyPeer()</code> 或 <code>cudaMemcpyPeerAsync()</code> 实现GPU之间的内存拷贝。</li></ul></li></ol><hr><h3 id="是否支持P2P通信取决于硬件架构"><a href="#是否支持P2P通信取决于硬件架构" class="headerlink" title="是否支持P2P通信取决于硬件架构"></a>是否支持P2P通信取决于硬件架构</h3><ul><li><strong>GPU之间的物理连接方式</strong>：<ul><li>支持P2P的前提是两张GPU之间通过 <strong>NVLink</strong>、<strong>PCIe同一Switch</strong>、或 <strong>同一个PCIe Root Complex</strong>。</li></ul></li><li>例如：<ul><li><strong>NVIDIA A100、V100、P100</strong> 支持 NVLink 的直接互联，P2P效率高。</li><li>如果GPU之间跨Socket（NUMA架构），P2P性能会变差甚至不可用。</li></ul></li></ul><hr><h3 id="如何检测GPU之间是否支持P2P？"><a href="#如何检测GPU之间是否支持P2P？" class="headerlink" title="如何检测GPU之间是否支持P2P？"></a>如何检测GPU之间是否支持P2P？</h3><p>可以使用命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi topo -m</span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">        GPU0    GPU1    CPU Affinity</span><br><span class="line">GPU0     X      NV2     0-15</span><br><span class="line">GPU1    NV2      X      0-15</span><br></pre></td></tr></table></figure><p>其中 <code>NV2</code> 表示通过 <strong>NVLink 2.0</strong> 连接，支持高速P2P；若显示 <code>PHB</code>，表示是通过 PCIe Host Bridge，不一定支持高效的P2P。</p><hr><h3 id="P2P的优势"><a href="#P2P的优势" class="headerlink" title="P2P的优势"></a>P2P的优势</h3><ul><li>避免数据先拷贝到CPU内存再拷贝到另一GPU</li><li>显著提升多卡训练、多卡计算的性能</li><li>降低系统总线负载，减少延迟</li></ul><hr><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul><li>分布式深度学习（如TensorFlow、PyTorch多GPU训练）</li><li>科学计算中GPU间数据交互</li><li>GPU直接DMA传输</li></ul><hr><p>如你使用NVIDIA GPU，并使用CUDA编程，可通过如下函数开启P2P：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cudaSetDevice</span>(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">cudaDeviceEnablePeerAccess</span>(<span class="number">1</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>表示：GPU0 允许访问 GPU1。</p><hr><p>如果你想我帮你判断你机器的GPU是否支持P2P，可以发我 <code>nvidia-smi topo -m</code> 的输出，我来分析。</p></blockquote><p><strong>扩展查看gpu p2p通信</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">root@A100:~<span class="comment"># nvidia-smi topo -m</span></span><br><span class="line">        GPU0    GPU1    GPU2    GPU3    GPU4    GPU5    GPU6    GPU7    NIC0    NIC1    NIC2    NIC3    NIC4    NIC5    CPU Affinity     NUMA Affinity   GPU NUMA ID</span><br><span class="line">GPU0     X      NV12    NV12    NV12    NV12    NV12    NV12    NV12    PXB     NODE    NODE    SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU1    NV12     X      NV12    NV12    NV12    NV12    NV12    NV12    PXB     NODE    NODE    SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU2    NV12    NV12     X      NV12    NV12    NV12    NV12    NV12    NODE    PXB     PXB     SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU3    NV12    NV12    NV12     X      NV12    NV12    NV12    NV12    NODE    PXB     PXB     SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU4    NV12    NV12    NV12    NV12     X      NV12    NV12    NV12    SYS     SYS     SYS     PXB     NODE    NODE    32-63,96-127     1               N/A</span><br><span class="line">GPU5    NV12    NV12    NV12    NV12    NV12     X      NV12    NV12    SYS     SYS     SYS     PXB     NODE    NODE    32-63,96-127     1               N/A</span><br><span class="line">GPU6    NV12    NV12    NV12    NV12    NV12    NV12     X      NV12    SYS     SYS     SYS     NODE    PXB     PXB     32-63,96-127     1               N/A</span><br><span class="line">GPU7    NV12    NV12    NV12    NV12    NV12    NV12    NV12     X      SYS     SYS     SYS     NODE    PXB     PXB     32-63,96-127     1               N/A</span><br><span class="line">NIC0    PXB     PXB     NODE    NODE    SYS     SYS     SYS     SYS      X      NODE    NODE    SYS     SYS     SYS</span><br><span class="line">NIC1    NODE    NODE    PXB     PXB     SYS     SYS     SYS     SYS     NODE     X      PIX     SYS     SYS     SYS</span><br><span class="line">NIC2    NODE    NODE    PXB     PXB     SYS     SYS     SYS     SYS     NODE    PIX      X      SYS     SYS     SYS</span><br><span class="line">NIC3    SYS     SYS     SYS     SYS     PXB     PXB     NODE    NODE    SYS     SYS     SYS      X      NODE    NODE</span><br><span class="line">NIC4    SYS     SYS     SYS     SYS     NODE    NODE    PXB     PXB     SYS     SYS     SYS     NODE     X      PIX</span><br><span class="line">NIC5    SYS     SYS     SYS     SYS     NODE    NODE    PXB     PXB     SYS     SYS     SYS     NODE    PIX      X </span><br><span class="line"></span><br><span class="line">Legend:</span><br><span class="line"></span><br><span class="line">  X    = Self</span><br><span class="line">  SYS  = Connection traversing PCIe as well as the SMP interconnect between NUMA nodes (e.g., QPI/UPI)</span><br><span class="line">  NODE = Connection traversing PCIe as well as the interconnect between PCIe Host Bridges within a NUMA node</span><br><span class="line">  PHB  = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU)</span><br><span class="line">  PXB  = Connection traversing multiple PCIe bridges (without traversing the PCIe Host Bridge)</span><br><span class="line">  PIX  = Connection traversing at most a single PCIe bridge</span><br><span class="line">  NV<span class="comment">#  = Connection traversing a bonded set of # NVLinks</span></span><br><span class="line"></span><br><span class="line">NIC Legend:</span><br><span class="line"></span><br><span class="line">  NIC0: mlx5_0</span><br><span class="line">  NIC1: mlx5_1</span><br><span class="line">  NIC2: mlx5_2</span><br><span class="line">  NIC3: mlx5_3</span><br><span class="line">  NIC4: mlx5_4</span><br><span class="line">  NIC5: mlx5_5root@A100:~<span class="comment"># nvidia-smi topo -m</span></span><br><span class="line">        GPU0    GPU1    GPU2    GPU3    GPU4    GPU5    GPU6    GPU7    NIC0    NIC1    NIC2    NIC3    NIC4    NIC5    CPU Affinity     NUMA Affinity   GPU NUMA ID</span><br><span class="line">GPU0     X      NV12    NV12    NV12    NV12    NV12    NV12    NV12    PXB     NODE    NODE    SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU1    NV12     X      NV12    NV12    NV12    NV12    NV12    NV12    PXB     NODE    NODE    SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU2    NV12    NV12     X      NV12    NV12    NV12    NV12    NV12    NODE    PXB     PXB     SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU3    NV12    NV12    NV12     X      NV12    NV12    NV12    NV12    NODE    PXB     PXB     SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU4    NV12    NV12    NV12    NV12     X      NV12    NV12    NV12    SYS     SYS     SYS     PXB     NODE    NODE    32-63,96-127     1               N/A</span><br><span class="line">GPU5    NV12    NV12    NV12    NV12    NV12     X      NV12    NV12    SYS     SYS     SYS     PXB     NODE    NODE    32-63,96-127     1               N/A</span><br><span class="line">GPU6    NV12    NV12    NV12    NV12    NV12    NV12     X      NV12    SYS     SYS     SYS     NODE    PXB     PXB     32-63,96-127     1               N/A</span><br><span class="line">GPU7    NV12    NV12    NV12    NV12    NV12    NV12    NV12     X      SYS     SYS     SYS     NODE    PXB     PXB     32-63,96-127     1               N/A</span><br><span class="line">NIC0    PXB     PXB     NODE    NODE    SYS     SYS     SYS     SYS      X      NODE    NODE    SYS     SYS     SYS</span><br><span class="line">NIC1    NODE    NODE    PXB     PXB     SYS     SYS     SYS     SYS     NODE     X      PIX     SYS     SYS     SYS</span><br><span class="line">NIC2    NODE    NODE    PXB     PXB     SYS     SYS     SYS     SYS     NODE    PIX      X      SYS     SYS     SYS</span><br><span class="line">NIC3    SYS     SYS     SYS     SYS     PXB     PXB     NODE    NODE    SYS     SYS     SYS      X      NODE    NODE</span><br><span class="line">NIC4    SYS     SYS     SYS     SYS     NODE    NODE    PXB     PXB     SYS     SYS     SYS     NODE     X      PIX</span><br><span class="line">NIC5    SYS     SYS     SYS     SYS     NODE    NODE    PXB     PXB     SYS     SYS     SYS     NODE    PIX      X </span><br><span class="line"></span><br><span class="line">Legend:</span><br><span class="line"></span><br><span class="line">  X    = Self</span><br><span class="line">  SYS  = Connection traversing PCIe as well as the SMP interconnect between NUMA nodes (e.g., QPI/UPI)</span><br><span class="line">  NODE = Connection traversing PCIe as well as the interconnect between PCIe Host Bridges within a NUMA node</span><br><span class="line">  PHB  = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU)</span><br><span class="line">  PXB  = Connection traversing multiple PCIe bridges (without traversing the PCIe Host Bridge)</span><br><span class="line">  PIX  = Connection traversing at most a single PCIe bridge</span><br><span class="line">  NV<span class="comment">#  = Connection traversing a bonded set of # NVLinks</span></span><br><span class="line"></span><br><span class="line">NIC Legend:</span><br><span class="line"></span><br><span class="line">  NIC0: mlx5_0</span><br><span class="line">  NIC1: mlx5_1</span><br><span class="line">  NIC2: mlx5_2</span><br><span class="line">  NIC3: mlx5_3</span><br><span class="line">  NIC4: mlx5_4</span><br><span class="line">  NIC5: mlx5_5root@A100:~<span class="comment"># nvidia-smi topo -m</span></span><br><span class="line">        GPU0    GPU1    GPU2    GPU3    GPU4    GPU5    GPU6    GPU7    NIC0    NIC1    NIC2    NIC3    NIC4    NIC5    CPU Affinity     NUMA Affinity   GPU NUMA ID</span><br><span class="line">GPU0     X      NV12    NV12    NV12    NV12    NV12    NV12    NV12    PXB     NODE    NODE    SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU1    NV12     X      NV12    NV12    NV12    NV12    NV12    NV12    PXB     NODE    NODE    SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU2    NV12    NV12     X      NV12    NV12    NV12    NV12    NV12    NODE    PXB     PXB     SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU3    NV12    NV12    NV12     X      NV12    NV12    NV12    NV12    NODE    PXB     PXB     SYS     SYS     SYS     0-31,64-95       0               N/A</span><br><span class="line">GPU4    NV12    NV12    NV12    NV12     X      NV12    NV12    NV12    SYS     SYS     SYS     PXB     NODE    NODE    32-63,96-127     1               N/A</span><br><span class="line">GPU5    NV12    NV12    NV12    NV12    NV12     X      NV12    NV12    SYS     SYS     SYS     PXB     NODE    NODE    32-63,96-127     1               N/A</span><br><span class="line">GPU6    NV12    NV12    NV12    NV12    NV12    NV12     X      NV12    SYS     SYS     SYS     NODE    PXB     PXB     32-63,96-127     1               N/A</span><br><span class="line">GPU7    NV12    NV12    NV12    NV12    NV12    NV12    NV12     X      SYS     SYS     SYS     NODE    PXB     PXB     32-63,96-127     1               N/A</span><br><span class="line">NIC0    PXB     PXB     NODE    NODE    SYS     SYS     SYS     SYS      X      NODE    NODE    SYS     SYS     SYS</span><br><span class="line">NIC1    NODE    NODE    PXB     PXB     SYS     SYS     SYS     SYS     NODE     X      PIX     SYS     SYS     SYS</span><br><span class="line">NIC2    NODE    NODE    PXB     PXB     SYS     SYS     SYS     SYS     NODE    PIX      X      SYS     SYS     SYS</span><br><span class="line">NIC3    SYS     SYS     SYS     SYS     PXB     PXB     NODE    NODE    SYS     SYS     SYS      X      NODE    NODE</span><br><span class="line">NIC4    SYS     SYS     SYS     SYS     NODE    NODE    PXB     PXB     SYS     SYS     SYS     NODE     X      PIX</span><br><span class="line">NIC5    SYS     SYS     SYS     SYS     NODE    NODE    PXB     PXB     SYS     SYS     SYS     NODE    PIX      X </span><br><span class="line"></span><br><span class="line">Legend:</span><br><span class="line"></span><br><span class="line">  X    = Self</span><br><span class="line">  SYS  = Connection traversing PCIe as well as the SMP interconnect between NUMA nodes (e.g., QPI/UPI)</span><br><span class="line">  NODE = Connection traversing PCIe as well as the interconnect between PCIe Host Bridges within a NUMA node</span><br><span class="line">  PHB  = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU)</span><br><span class="line">  PXB  = Connection traversing multiple PCIe bridges (without traversing the PCIe Host Bridge)</span><br><span class="line">  PIX  = Connection traversing at most a single PCIe bridge</span><br><span class="line">  NV<span class="comment">#  = Connection traversing a bonded set of # NVLinks</span></span><br><span class="line"></span><br><span class="line">NIC Legend:</span><br><span class="line"></span><br><span class="line">  NIC0: mlx5_0</span><br><span class="line">  NIC1: mlx5_1</span><br><span class="line">  NIC2: mlx5_2</span><br><span class="line">  NIC3: mlx5_3</span><br><span class="line">  NIC4: mlx5_4</span><br><span class="line">  NIC5: mlx5_5</span><br></pre></td></tr></table></figure><p><strong>上方 参数 解释：</strong></p><blockquote><p>从你提供的 <code>nvidia-smi topo -m</code> 输出看，你的系统有 8 张 GPU 卡，它们之间通过 <strong>NV12</strong> 互联，这说明 <strong>每对 GPU 间都有 12 条 NVLink 直连通道</strong>，属于目前非常高规格的连接方式。</p><hr><h3 id="✅-你的系统支持极佳的-GPU-间-P2P-通信"><a href="#✅-你的系统支持极佳的-GPU-间-P2P-通信" class="headerlink" title="✅ 你的系统支持极佳的 GPU 间 P2P 通信"></a>✅ 你的系统支持极佳的 GPU 间 P2P 通信</h3><p><strong>解释如下：</strong></p><ul><li><code>NV12</code> 表示两张GPU之间通过 <strong>12条 NVLink 通道</strong>互连，属于 NVIDIA NVSwitch 架构的一部分。</li><li>NVLink 是 NVIDIA 专为 GPU 高速互联设计的技术，远高于传统 PCIe 带宽和延迟。</li><li>你的输出中 GPU0~GPU7 之间全部为 <code>NV12</code>，说明这些 GPU 构成一个 <strong>NVLink 全互连拓扑（full mesh）</strong>，<strong>P2P 通信性能极高</strong>。</li><li>这是典型的 <strong>HGX A100 服务器</strong>结构，通常用于 AI 训练、HPC 超算等场景。</li></ul><hr><h3 id="NUMA信息也说明系统为对称架构"><a href="#NUMA信息也说明系统为对称架构" class="headerlink" title="NUMA信息也说明系统为对称架构"></a>NUMA信息也说明系统为对称架构</h3><ul><li>GPU0~GPU3 属于 NUMA 节点 0（Affinity: <code>0-31,64-95</code>）</li><li>GPU4~GPU7 属于 NUMA 节点 1（Affinity: <code>32-63,96-127</code>）</li></ul><p>这通常意味着双路CPU，每个CPU挂载4张GPU，通过 NVSwitch 实现GPU间的高速互通。</p><hr><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><table><thead><tr><th>项目</th><th>状态</th></tr></thead><tbody><tr><td>GPU间P2P</td><td>✅ 全部支持（NV12）</td></tr><tr><td>通信方式</td><td>NVLink 12路互联</td></tr><tr><td>架构类型</td><td>多GPU NVSwitch</td></tr><tr><td>适合场景</td><td>大模型训练、多卡推理、深度学习训练等</td></tr></tbody></table><hr><h3 id="✅-建议"><a href="#✅-建议" class="headerlink" title="✅ 建议"></a>✅ 建议</h3><p>你可以在 CUDA 或深度学习框架（如 PyTorch、TensorFlow）中放心使用多卡训练，不需要担心 GPU 间的数据传输瓶颈。</p><p>如需验证程序中是否使用了 P2P，可在 PyTorch 中使用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">torch.cuda.device(<span class="number">0</span>).can_access_peer(<span class="number">1</span>)  <span class="comment"># True</span></span><br></pre></td></tr></table></figure><p>如果你要进一步优化多GPU训练性能，还可以设置环境变量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NCCL_P2P_LEVEL=NVL  <span class="comment"># 强制NCCL使用NVLink</span></span><br></pre></td></tr></table></figure><p>需要帮助配置多卡训练或 NCCL 参数优化，也可以继续问我。</p><p>从你提供的 <code>nvidia-smi topo -m</code> 输出看，你的系统有 8 张 GPU 卡，它们之间通过 <strong>NV12</strong> 互联，这说明 <strong>每对 GPU 间都有 12 条 NVLink 直连通道</strong>，属于目前非常高规格的连接方式。</p><hr><h3 id="✅-你的系统支持极佳的-GPU-间-P2P-通信-1"><a href="#✅-你的系统支持极佳的-GPU-间-P2P-通信-1" class="headerlink" title="✅ 你的系统支持极佳的 GPU 间 P2P 通信"></a>✅ 你的系统支持极佳的 GPU 间 P2P 通信</h3><p><strong>解释如下：</strong></p><ul><li><code>NV12</code> 表示两张GPU之间通过 <strong>12条 NVLink 通道</strong>互连，属于 NVIDIA NVSwitch 架构的一部分。</li><li>NVLink 是 NVIDIA 专为 GPU 高速互联设计的技术，远高于传统 PCIe 带宽和延迟。</li><li>你的输出中 GPU0~GPU7 之间全部为 <code>NV12</code>，说明这些 GPU 构成一个 <strong>NVLink 全互连拓扑（full mesh）</strong>，<strong>P2P 通信性能极高</strong>。</li><li>这是典型的 <strong>HGX A100 服务器</strong>结构，通常用于 AI 训练、HPC 超算等场景。</li></ul><hr><h3 id="NUMA信息也说明系统为对称架构-1"><a href="#NUMA信息也说明系统为对称架构-1" class="headerlink" title="NUMA信息也说明系统为对称架构"></a>NUMA信息也说明系统为对称架构</h3><ul><li>GPU0~GPU3 属于 NUMA 节点 0（Affinity: <code>0-31,64-95</code>）</li><li>GPU4~GPU7 属于 NUMA 节点 1（Affinity: <code>32-63,96-127</code>）</li></ul><p>这通常意味着双路CPU，每个CPU挂载4张GPU，通过 NVSwitch 实现GPU间的高速互通。</p><hr><h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><table><thead><tr><th>项目</th><th>状态</th></tr></thead><tbody><tr><td>GPU间P2P</td><td>✅ 全部支持（NV12）</td></tr><tr><td>通信方式</td><td>NVLink 12路互联</td></tr><tr><td>架构类型</td><td>多GPU NVSwitch</td></tr><tr><td>适合场景</td><td>大模型训练、多卡推理、深度学习训练等</td></tr></tbody></table><hr><h3 id="✅-建议-1"><a href="#✅-建议-1" class="headerlink" title="✅ 建议"></a>✅ 建议</h3><p>你可以在 CUDA 或深度学习框架（如 PyTorch、TensorFlow）中放心使用多卡训练，不需要担心 GPU 间的数据传输瓶颈。</p><p>如需验证程序中是否使用了 P2P，可在 PyTorch 中使用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">torch.cuda.device(<span class="number">0</span>).can_access_peer(<span class="number">1</span>)  <span class="comment"># True</span></span><br></pre></td></tr></table></figure><p>如果你要进一步优化多GPU训练性能，还可以设置环境变量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NCCL_P2P_LEVEL=NVL  <span class="comment"># 强制NCCL使用NVLink</span></span><br></pre></td></tr></table></figure><p>需要帮助配置多卡训练或 NCCL 参数优化，也可以继续问我。</p></blockquote><p>gpu机器中nvidia-fabricmanager-550服务是干嘛的</p><blockquote><p><code>Fabric Manager</code> 是 NVIDIA 提供的一个系统守护进程服务，主要用于支持 <strong>NVSwitch/NVLink 架构的多GPU通信和管理</strong>，特别是在 A100、H100 等数据中心级别的 GPU 系统中（如 NVIDIA HGX 平台）。</p><hr><h2 id="🔧-Fabric-Manager-是什么？"><a href="#🔧-Fabric-Manager-是什么？" class="headerlink" title="🔧 Fabric Manager 是什么？"></a>🔧 Fabric Manager 是什么？</h2><p><strong>Fabric Manager</strong> 是 NVIDIA GPU 驱动的一部分，主要用于：</p><h3 id="✅-管理和启用-NVSwitch（GPU互联交换芯片）"><a href="#✅-管理和启用-NVSwitch（GPU互联交换芯片）" class="headerlink" title="✅ 管理和启用 NVSwitch（GPU互联交换芯片）"></a>✅ 管理和启用 NVSwitch（GPU互联交换芯片）</h3><ul><li><strong>NVSwitch</strong> 是一种高速交换芯片，用于连接多个 GPU，实现类似“网络交换机”一样的互联。</li><li>Fabric Manager 会负责发现、初始化、配置这些 NVSwitch，让多GPU之间可以 <strong>共享内存、进行高速P2P通信</strong>。</li></ul><h3 id="✅-支持统一内存空间（如-Multi-Instance-GPU）"><a href="#✅-支持统一内存空间（如-Multi-Instance-GPU）" class="headerlink" title="✅ 支持统一内存空间（如 Multi-Instance GPU）"></a>✅ 支持统一内存空间（如 Multi-Instance GPU）</h3><ul><li>在 A100/H100 上，Fabric Manager 协助构建一个大的<strong>统一虚拟 GPU 内存空间</strong>（Unified Virtual Address Space, UVA）。</li><li>这样可以让多个 GPU 像一个整体一样运行，比如模型并行、大模型训练。</li></ul><h3 id="✅-保证-GPU-拓扑感知通信正常"><a href="#✅-保证-GPU-拓扑感知通信正常" class="headerlink" title="✅ 保证 GPU 拓扑感知通信正常"></a>✅ 保证 GPU 拓扑感知通信正常</h3><ul><li>确保 GPU 拓扑（如 NVLink、NVSwitch 互联关系）能正确暴露给如 NCCL、CUDA 等框架。</li></ul><hr><h2 id="🖥-你在哪些情况下需要-Fabric-Manager？"><a href="#🖥-你在哪些情况下需要-Fabric-Manager？" class="headerlink" title="🖥 你在哪些情况下需要 Fabric Manager？"></a>🖥 你在哪些情况下需要 Fabric Manager？</h2><table><thead><tr><th>场景</th><th>是否需要 Fabric Manager</th></tr></thead><tbody><tr><td>多GPU无NVSwitch互联（如两张 3090）</td><td>❌ 不需要</td></tr><tr><td>使用 A100/H100 HGX平台，有 NVSwitch</td><td>✅ 必须启用</td></tr><tr><td>需要 Multi-Instance GPU（MIG）</td><td>✅ 必须启用</td></tr><tr><td>运行 NCCL 跨卡通信（在 NVSwitch 架构上）</td><td>✅ 建议启用</td></tr></tbody></table><hr><h2 id="📦-如何查看-Fabric-Manager-是否运行？"><a href="#📦-如何查看-Fabric-Manager-是否运行？" class="headerlink" title="📦 如何查看 Fabric Manager 是否运行？"></a>📦 如何查看 Fabric Manager 是否运行？</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status nvidia-fabricmanager</span><br></pre></td></tr></table></figure><p>正常运行状态应为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">● nvidia-fabricmanager.service - NVIDIA Fabric Manager Daemon</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/nvidia-fabricmanager.service; enabled)</span><br><span class="line">   Active: active (running)</span><br></pre></td></tr></table></figure><p>如果未启动，可使用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start nvidia-fabricmanager</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nvidia-fabricmanager</span><br></pre></td></tr></table></figure><hr><h2 id="🧩-与-GPU-驱动的关系"><a href="#🧩-与-GPU-驱动的关系" class="headerlink" title="🧩 与 GPU 驱动的关系"></a>🧩 与 GPU 驱动的关系</h2><ul><li>Fabric Manager 是 GPU 驱动包的一部分（在 A100/H100 平台驱动安装时可选）。</li><li>安装方式一般是：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nvidia-fabricmanager-&lt;driver_version&gt;</span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nvidia-fabricmanager-550</span><br></pre></td></tr></table></figure><hr><h2 id="✅-小结"><a href="#✅-小结" class="headerlink" title="✅ 小结"></a>✅ 小结</h2><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>服务名称</td><td><code>nvidia-fabricmanager</code></td></tr><tr><td>所属平台</td><td>A100/H100 + NVSwitch 架构</td></tr><tr><td>是否必需</td><td>如果你用的是 NVSwitch 互联（如 HGX），<strong>必须启用</strong></td></tr><tr><td>作用</td><td>管理 GPU 互联拓扑、启用 NVSwitch、支持统一内存、MIG、多GPU通信</td></tr></tbody></table><hr><p>如果你当前服务器是 8x A100 并且 <code>nvidia-smi topo -m</code> 显示 <code>NV12</code>，那么你应该<strong>启用了 Fabric Manager</strong>，它在后台负责这些 NVLink 和 NVSwitch 的配置工作。</p><p>如果你想我帮你检查当前 Fabric Manager 的状态或是否需要配置，我也可以帮你确认。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> gpu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>揭秘Ubuntu系统中的br0网络接口：揭秘网络配置背后的秘密</title>
      <link href="/2025/03/25/Ubuntu%E7%B3%BB%E7%BB%9F%E4%B8%AD%E9%85%8D%E7%BD%AEbr0%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3/"/>
      <url>/2025/03/25/Ubuntu%E7%B3%BB%E7%BB%9F%E4%B8%AD%E9%85%8D%E7%BD%AEbr0%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="揭秘Ubuntu系统中的br0网络接口：揭秘网络配置背后的秘密"><a href="#揭秘Ubuntu系统中的br0网络接口：揭秘网络配置背后的秘密" class="headerlink" title="揭秘Ubuntu系统中的br0网络接口：揭秘网络配置背后的秘密"></a>揭秘Ubuntu系统中的br0网络接口：揭秘网络配置背后的秘密</h1><p>本文转载自：<a href="https://www.oryoy.com/news/jie-mi-ubuntu-xi-tong-zhong-de-br0-wang-luo-jie-kou-jie-mi-wang-luo-pei-zhi-bei-hou-de-mi-mi.html">揭秘Ubuntu系统中的br0网络接口：揭秘网络配置背后的秘密 - 云原生实践</a></p><p>备注：重启后将会失效</p><h2 id="概览："><a href="#概览：" class="headerlink" title="概览："></a>概览：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo brctl addbr br0</span><br><span class="line">sudo brctl addif br0 eth0</span><br><span class="line">hostname -I</span><br><span class="line">sudo ip addr add 172.31.63.56/24 dev br0</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line">sudo route add default gw 172.31.63.1  br0</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>永久生效：</p><ul><li>sudo nano /etc/netplan/01-netcfg.yaml</li><li>sudo netplan apply<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">networkd</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">eth0:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">bridges:</span></span><br><span class="line">    <span class="attr">br0:</span></span><br><span class="line">      <span class="attr">interfaces:</span> [<span class="string">eth0</span>]</span><br><span class="line">      <span class="attr">addresses:</span> [<span class="number">172.31</span><span class="number">.63</span><span class="number">.56</span><span class="string">/24</span>]</span><br><span class="line">      <span class="attr">gateway4:</span> <span class="number">172.31</span><span class="number">.63</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">addresses:</span> [<span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span>, <span class="number">223.5</span><span class="number">.5</span><span class="number">.5</span>]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><p> <img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_2e0b558b5e87e1f781e8113b48ff54f9.png"></p><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在Ubuntu系统中，您可能会遇到名为br0的网络接口。这个接口对于某些网络配置来说至关重要，但对于新手来说，它可能显得神秘。本文将深入探讨br0网络接口的作用、配置方法以及背后的原理。</p><h2 id="br0网络接口简介"><a href="#br0网络接口简介" class="headerlink" title="br0网络接口简介"></a>br0网络接口简介</h2><p>br0是Bridge（网桥）的简称，它是一种虚拟网络接口，用于将多个物理网络接口或虚拟接口连接起来，形成一个逻辑上的网络段。在Linux系统中，网桥通常用于虚拟机网络、容器网络以及复杂网络环境中的多主机通信。</p><h2 id="br0的作用"><a href="#br0的作用" class="headerlink" title="br0的作用"></a>br0的作用</h2><ol><li><strong>连接多个网络接口</strong>：通过网桥，您可以连接多个网络接口，形成一个逻辑上的网络段。</li><li><strong>隔离网络流量</strong>：网桥可以将不同的网络流量隔离开来，从而提高网络安全性。</li><li><strong>虚拟网络配置</strong>：在虚拟化环境中，网桥用于配置虚拟机网络。</li></ol><h2 id="br0的配置"><a href="#br0的配置" class="headerlink" title="br0的配置"></a>br0的配置</h2><h3 id="创建网桥"><a href="#创建网桥" class="headerlink" title="创建网桥"></a>创建网桥</h3><p>首先，您需要创建一个网桥接口，例如br0。以下是一个示例命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo brctl addbr br0</span><br></pre></td></tr></table></figure><h3 id="添加网络接口到网桥"><a href="#添加网络接口到网桥" class="headerlink" title="添加网络接口到网桥"></a>添加网络接口到网桥</h3><p>将物理接口或虚拟接口添加到网桥，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo brctl addif br0 eth0</span><br></pre></td></tr></table></figure><h3 id="配置IP地址"><a href="#配置IP地址" class="headerlink" title="配置IP地址"></a>配置IP地址</h3><p>为网桥分配一个IP地址，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip addr add 192.168.1.1/24 dev br0</span><br></pre></td></tr></table></figure><h3 id="启用网桥"><a href="#启用网桥" class="headerlink" title="启用网桥"></a>启用网桥</h3><p>启用网桥，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br></pre></td></tr></table></figure><h3 id="设置默认网关"><a href="#设置默认网关" class="headerlink" title="设置默认网关"></a>设置默认网关</h3><p>为网桥设置默认网关，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo route add default gw 192.168.1.254 br0</span><br></pre></td></tr></table></figure><h3 id="配置DNS服务器"><a href="#配置DNS服务器" class="headerlink" title="配置DNS服务器"></a>配置DNS服务器</h3><p>配置DNS服务器，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/resolv.conf</span><br></pre></td></tr></table></figure><p>在打开的文件中添加以下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nameserver 8.8.8.8</span><br><span class="line">nameserver 8.8.4.4</span><br></pre></td></tr></table></figure><p>保存并退出文件。</p><h2 id="br0背后的原理"><a href="#br0背后的原理" class="headerlink" title="br0背后的原理"></a>br0背后的原理</h2><ol><li><strong>数据帧转发</strong>：网桥通过检查数据帧的MAC地址，将数据帧转发到相应的网络接口。</li><li><strong>学习MAC地址表</strong>：网桥学习每个网络接口上的MAC地址，并将其存储在MAC地址表中。</li><li><strong>过滤流量</strong>：网桥可以过滤流量，防止未经授权的数据包进入网络。</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>br0网络接口是Ubuntu系统中一个重要的虚拟网络接口，它为用户提供了丰富的网络配置选项。通过本文的介绍，您应该已经对br0网络接口有了更深入的了解。在配置和使用br0时，请注意以下几点：</p><ul><li>确保您的网络环境满足需求。</li><li>仔细配置IP地址、网关和DNS服务器。</li><li>了解网桥背后的原理，以便更好地使用它。</li></ul><p>希望本文能帮助您更好地理解Ubuntu系统中的br0网络接口。</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务器报错nf_conntrack: table full, dropping packet解决</title>
      <link href="/2025/03/20/%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8A%A5%E9%94%99nf_conntrack:%20table%20full,%20dropping%20packet%E5%A4%84%E7%90%86/"/>
      <url>/2025/03/20/%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8A%A5%E9%94%99nf_conntrack:%20table%20full,%20dropping%20packet%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="服务器报错nf-conntrack-table-full-dropping-packet解决"><a href="#服务器报错nf-conntrack-table-full-dropping-packet解决" class="headerlink" title="服务器报错nf_conntrack: table full, dropping packet解决"></a>服务器报错nf_conntrack: table full, dropping packet解决</h2><h3 id="现象："><a href="#现象：" class="headerlink" title="现象："></a>现象：</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_59807eee8b52d2819b903d40a70f237e.png"></p><p>你的系统日志提示 <code>nf_conntrack: table full, dropping packet</code>，说明 <strong><code>conntrack</code> 连接跟踪表已满</strong>，导致新连接被丢弃。这个问题通常发生在高并发网络环境中，特别是 NAT 或防火墙规则使用 <code>conntrack</code> 进行连接跟踪时。</p><h3 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a><strong>解决方案：</strong></h3><h4 id="1-临时增加-conntrack-表大小"><a href="#1-临时增加-conntrack-表大小" class="headerlink" title="1. 临时增加 conntrack 表大小"></a><strong>1. 临时增加 conntrack 表大小</strong></h4><p>可以暂时增大 <code>nf_conntrack_max</code> 值，让系统能跟踪更多连接：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 262144 &gt; /proc/sys/net/netfilter/nf_conntrack_max</span><br></pre></td></tr></table></figure><p>也可以使用 <code>sysctl</code> 命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.netfilter.nf_conntrack_max=262144</span><br></pre></td></tr></table></figure><p><strong>说明：</strong></p><ul><li>默认值通常在 <code>65536</code> 左右，建议适当增加，比如 <code>262144</code> 或更高，具体取决于服务器的网络负载。</li></ul><h4 id="2-永久增加-conntrack-表大小"><a href="#2-永久增加-conntrack-表大小" class="headerlink" title="2. 永久增加 conntrack 表大小"></a><strong>2. 永久增加 conntrack 表大小</strong></h4><p>编辑 <code>/etc/sysctl.conf</code>，添加：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">net.netfilter.nf_conntrack_max</span>=<span class="number">262144</span></span><br></pre></td></tr></table></figure><p>然后使其生效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><h4 id="3-查看当前-conntrack-使用情况"><a href="#3-查看当前-conntrack-使用情况" class="headerlink" title="3. 查看当前 conntrack 使用情况"></a><strong>3. 查看当前 conntrack 使用情况</strong></h4><p>执行以下命令，查看当前的 <code>conntrack</code> 连接数和上限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/sys/net/netfilter/nf_conntrack_count</span><br><span class="line"><span class="built_in">cat</span> /proc/sys/net/netfilter/nf_conntrack_max</span><br></pre></td></tr></table></figure><p>如果 <code>conntrack_count</code> 接近 <code>conntrack_max</code>，说明表快满了，需要增加 <code>conntrack_max</code>。</p><h4 id="4-调整-hashsize"><a href="#4-调整-hashsize" class="headerlink" title="4. 调整 hashsize"></a><strong>4. 调整 <code>hashsize</code></strong></h4><p>conntrack 使用哈希表存储连接信息。如果表太大，默认 <code>hashsize</code> 可能导致查询效率降低，可以增加：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 65536 &gt; /sys/module/nf_conntrack/parameters/hashsize</span><br></pre></td></tr></table></figure><h4 id="5-清理无用连接"><a href="#5-清理无用连接" class="headerlink" title="5. 清理无用连接"></a><strong>5. 清理无用连接</strong></h4><p>可以定期清理 <code>conntrack</code> 连接，释放资源：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conntrack -F</span><br></pre></td></tr></table></figure><h4 id="6-检查-nf-conntrack-buckets-设置"><a href="#6-检查-nf-conntrack-buckets-设置" class="headerlink" title="6. 检查 nf_conntrack_buckets 设置"></a><strong>6. 检查 <code>nf_conntrack_buckets</code> 设置</strong></h4><p>默认情况下，<code>conntrack</code> 哈希桶的大小是 <code>nf_conntrack_max / 4</code>，如果 <code>conntrack_max</code> 过大，可能导致哈希冲突，影响性能。可以调整：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 16384 &gt; /sys/module/nf_conntrack/parameters/hashsize</span><br></pre></td></tr></table></figure><p><strong>或者永久生效：</strong><br>在 <code>/etc/modprobe.d/nf_conntrack.conf</code> 添加：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options nf_conntrack <span class="attr">hashsize</span>=<span class="number">16384</span></span><br></pre></td></tr></table></figure><p>然后重启服务器。</p><h4 id="7-降低-conntrack-超时时间"><a href="#7-降低-conntrack-超时时间" class="headerlink" title="7. 降低 conntrack 超时时间"></a><strong>7. 降低 <code>conntrack</code> 超时时间</strong></h4><p>可以减少 <code>conntrack</code> 表项的超时时间，让旧连接更快释放：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.netfilter.nf_conntrack_tcp_timeout_established=300</span><br><span class="line">sysctl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait=120</span><br><span class="line">sysctl -w net.netfilter.nf_conntrack_tcp_timeout_close_wait=60</span><br><span class="line">sysctl -w net.netfilter.nf_conntrack_tcp_timeout_fin_wait=60</span><br></pre></td></tr></table></figure><p>然后保存到 <code>/etc/sysctl.conf</code>，并执行 <code>sysctl -p</code>。</p><h4 id="8-检查系统负载"><a href="#8-检查系统负载" class="headerlink" title="8. 检查系统负载"></a><strong>8. 检查系统负载</strong></h4><p>高负载情况下，<code>conntrack</code> 处理效率可能降低：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line">htop</span><br><span class="line">dmesg | <span class="built_in">tail</span> -50</span><br></pre></td></tr></table></figure><p>如果发现 CPU、内存或 I/O 负载过高，可能需要优化服务器性能。</p><h4 id="9-关闭-conntrack（仅适用于无状态流量）"><a href="#9-关闭-conntrack（仅适用于无状态流量）" class="headerlink" title="9. 关闭 conntrack（仅适用于无状态流量）"></a><strong>9. 关闭 <code>conntrack</code>（仅适用于无状态流量）</strong></h4><p>如果你的服务器只是转发流量，不需要 <code>conntrack</code>，可以禁用它：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t raw -A PREROUTING -j NOTRACK</span><br><span class="line">iptables -t raw -A OUTPUT -j NOTRACK</span><br></pre></td></tr></table></figure><p>然后检查：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t raw -L -n -v</span><br></pre></td></tr></table></figure><hr><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>如果你的服务器 <strong>需要连接跟踪</strong>，可以：</p><ol><li><strong>增加 <code>nf_conntrack_max</code></strong></li><li><strong>调整 <code>hashsize</code></strong></li><li><strong>清理无用连接</strong></li><li><strong>降低 <code>conntrack</code> 超时时间</strong></li><li><strong>监控服务器负载</strong></li></ol><p>如果服务器只是 <strong>转发大量流量（如网关或边界路由器）</strong>，考虑 **禁用 <code>conntrack</code>**。</p><p>你可以先尝试 <code>sysctl -w net.netfilter.nf_conntrack_max=262144</code>，然后观察是否减少丢包情况。如果问题仍然存在，检查是否有异常流量或 DDoS 攻击。</p>]]></content>
      
      
      <categories>
          
          <category> default </category>
          
      </categories>
      
      
        <tags>
            
            <tag> default </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>容器化部署ollama环境变量问题</title>
      <link href="/2025/03/12/%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2ollama%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%97%AE%E9%A2%98/"/>
      <url>/2025/03/12/%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2ollama%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="容器化部署ollama环境变量问题"><a href="#容器化部署ollama环境变量问题" class="headerlink" title="容器化部署ollama环境变量问题"></a>容器化部署ollama环境变量问题</h2><p>你的 GPU 是 <strong>GTX 1050 Ti</strong>，而 <strong>Ollama 依赖 CUDA 计算能力至少 7.0</strong>，但 GTX 1050 Ti 只有 <strong>6.1</strong>，这可能是 Ollama 不支持的原因。</p><p>你可以运行：</p><pre class="!overflow-visible" data-start="1950" data-end="2009"><div class="contain-inline-size rounded-md border-[0.5px] border-token-border-medium relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary dark:bg-token-main-surface-secondary select-none rounded-t-[5px]">bash</div><div class="sticky top-9"><div class="absolute bottom-0 right-0 flex h-9 items-center pr-2"><div class="flex items-center rounded bg-token-sidebar-surface-primary px-2 font-sans text-xs text-token-text-secondary dark:bg-token-main-surface-secondary"><span class data-state="closed"><button class="flex gap-1 items-center select-none px-4 py-1" aria-label="复制"><svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-xs"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z" fill="currentColor"/></svg>复制</button></span><span class data-state="closed"><button class="flex select-none items-center gap-1 px-4 py-1"><svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-xs"><path d="M2.5 5.5C4.3 5.2 5.2 4 5.5 2.5C5.8 4 6.7 5.2 8.5 5.5C6.7 5.8 5.8 7 5.5 8.5C5.2 7 4.3 5.8 2.5 5.5Z" fill="currentColor" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/><path d="M5.66282 16.5231L5.18413 19.3952C5.12203 19.7678 5.09098 19.9541 5.14876 20.0888C5.19933 20.2067 5.29328 20.3007 5.41118 20.3512C5.54589 20.409 5.73218 20.378 6.10476 20.3159L8.97693 19.8372C9.72813 19.712 10.1037 19.6494 10.4542 19.521C10.7652 19.407 11.0608 19.2549 11.3343 19.068C11.6425 18.8575 11.9118 18.5882 12.4503 18.0497L20 10.5C21.3807 9.11929 21.3807 6.88071 20 5.5C18.6193 4.11929 16.3807 4.11929 15 5.5L7.45026 13.0497C6.91175 13.5882 6.6425 13.8575 6.43197 14.1657C6.24513 14.4392 6.09299 14.7348 5.97903 15.0458C5.85062 15.3963 5.78802 15.7719 5.66282 16.5231Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M14.5 7L18.5 11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>编辑</button></span></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="!whitespace-pre language-bash"><span><span>nvidia-smi --query-gpu=compute_cap --format=csv</span></span></code></div></div></pre><p>如果输出 <code>&lt; 7.0</code>，说明你的 GPU 不支持 Ollama 的 CUDA 版本，你可能需要使用 CPU 推理，或者换一张更高计算能力的 GPU（如 RTX 20 系列及以上）。</p><h2 id="环境变量解释："><a href="#环境变量解释：" class="headerlink" title="环境变量解释："></a>环境变量解释：</h2><ul><li>CUDA_VISIBLE_DEVICES: 0   # 指定使用 GPU 0</li><li>OLLAMA_USE_CUDA: true  # ollama开启GPU</li><li>OLLAMA_USE_GPU: true    # ollama开启GPU</li></ul><h2 id="这些环境变量的详细解释如下（GPT4-0回答）："><a href="#这些环境变量的详细解释如下（GPT4-0回答）：" class="headerlink" title="这些环境变量的详细解释如下（GPT4.0回答）："></a>这些环境变量的详细解释如下（GPT4.0回答）：</h2><h3 id="1-KEEP-GPUS-TIMEOUT-40"><a href="#1-KEEP-GPUS-TIMEOUT-40" class="headerlink" title="1. KEEP_GPUS_TIMEOUT: 40"></a><strong>1. <code>KEEP_GPUS_TIMEOUT: 40</code></strong></h3><ul><li><strong>作用</strong>：保持 GPU 资源分配的超时时间，单位通常是 <strong>秒</strong>。</li><li><strong>影响</strong>：如果 Ollama 在 40 秒内没有使用 GPU，可能会释放 GPU 资源（取决于实现）。</li><li><strong>适用场景</strong>：避免 GPU 资源长期占用而不释放，有助于提高资源利用率。</li></ul><hr><h3 id="2-TZ-Asia-Shanghai"><a href="#2-TZ-Asia-Shanghai" class="headerlink" title="2. TZ: Asia/Shanghai"></a><strong>2. <code>TZ: Asia/Shanghai</code></strong></h3><ul><li><strong>作用</strong>：设置 <strong>容器内部的时区</strong> 为 <code>Asia/Shanghai</code>（北京时间）。</li><li><strong>影响</strong>：影响日志、任务调度等依赖系统时间的功能。</li><li><strong>适用场景</strong>：如果不设置，容器可能默认使用 UTC 时间，导致日志时间与实际不符。</li></ul><hr><h3 id="3-OLLAMA-ORIGINS-quot-quot"><a href="#3-OLLAMA-ORIGINS-quot-quot" class="headerlink" title="3. OLLAMA_ORIGINS: &quot;*&quot;"></a><strong>3. <code>OLLAMA_ORIGINS: &quot;*&quot;</code></strong></h3><ul><li><strong>作用</strong>：配置 <strong>CORS 允许的来源</strong>，<code>*</code> 表示允许所有来源访问 Ollama API。</li><li><strong>影响</strong>：<ul><li>允许任何客户端（前端网页、应用等）访问 Ollama API。</li><li>可能存在安全风险，建议限制特定域名，如：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">OLLAMA_ORIGINS:</span> <span class="string">&quot;http://example.com,https://example.com&quot;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><strong>适用场景</strong>：<ul><li>允许 Web 应用（如 <code>Vue</code> 或 <code>React</code>）调用 Ollama。</li><li>开发和测试环境，方便跨域请求。</li></ul></li></ul><hr><h3 id="4-OLLAMA-HOST-quot-0-0-0-0-quot"><a href="#4-OLLAMA-HOST-quot-0-0-0-0-quot" class="headerlink" title="4. OLLAMA_HOST: &quot;0.0.0.0&quot;"></a><strong>4. <code>OLLAMA_HOST: &quot;0.0.0.0&quot;</code></strong></h3><ul><li><strong>作用</strong>：设置 Ollama 监听的 <strong>网络接口</strong>，<code>0.0.0.0</code> 表示监听所有 IP 地址。</li><li><strong>影响</strong>：<ul><li>允许外部访问 Ollama API（如 <code>http://&lt;服务器IP&gt;:11434</code>）。</li><li>如果只想让本地访问，建议改成：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">OLLAMA_HOST:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><strong>适用场景</strong>：<ul><li>部署在远程服务器，允许局域网或公网访问 Ollama。</li><li>如果是本地开发，建议限制为 <code>127.0.0.1</code>。</li></ul></li></ul><hr><h3 id="5-CUDA-VISIBLE-DEVICES-0"><a href="#5-CUDA-VISIBLE-DEVICES-0" class="headerlink" title="5. CUDA_VISIBLE_DEVICES: 0"></a><strong>5. <code>CUDA_VISIBLE_DEVICES: 0</code></strong></h3><ul><li><strong>作用</strong>：指定 <strong>可见的 GPU</strong>，<code>0</code> 表示使用 <strong>第 1 块 GPU</strong>。</li><li><strong>影响</strong>：<ul><li>如果服务器有多块 GPU：<ul><li><code>CUDA_VISIBLE_DEVICES: 1</code>  → 只使用 <strong>第 2 块 GPU</strong>。</li><li><code>CUDA_VISIBLE_DEVICES: 0,1</code> → 使用 <strong>第 1 和 2 块 GPU</strong>。</li></ul></li><li>如果设置为 <code>-1</code>，则 <strong>禁用 GPU</strong>，强制使用 CPU。</li></ul></li><li><strong>适用场景</strong>：<ul><li>多 GPU 服务器，指定某块 GPU 运行 Ollama。</li><li>资源控制，避免 Ollama 占用所有 GPU。</li></ul></li></ul><hr><h3 id="6-OLLAMA-USE-CUDA-true"><a href="#6-OLLAMA-USE-CUDA-true" class="headerlink" title="6. OLLAMA_USE_CUDA: true"></a><strong>6. <code>OLLAMA_USE_CUDA: true</code></strong></h3><ul><li><strong>作用</strong>：强制启用 <strong>CUDA 加速</strong>，让 Ollama 使用 GPU 进行推理。</li><li><strong>影响</strong>：<ul><li><code>true</code>：如果检测到 <strong>NVIDIA GPU</strong>，Ollama 运行在 GPU 上（性能更快）。</li><li><code>false</code>：即使有 GPU 也 <strong>强制使用 CPU</strong>（可能用于调试）。</li></ul></li><li><strong>适用场景</strong>：<ul><li>需要 GPU 加速的模型推理。</li><li>服务器上有 GPU，但默认未启用，需要手动指定。</li></ul></li></ul><h3 id="7、NVIDIA-DRIVER-CAPABILITIES-compute-utility"><a href="#7、NVIDIA-DRIVER-CAPABILITIES-compute-utility" class="headerlink" title="7、NVIDIA_DRIVER_CAPABILITIES=compute,utility"></a>7、NVIDIA_DRIVER_CAPABILITIES=compute,utility</h3><p><code>NVIDIA_DRIVER_CAPABILITIES=compute,utility</code> 是一个环境变量，用于控制 Docker 容器内可用的 NVIDIA 驱动功能。</p><p>在 Docker 运行带 GPU 加速的容器时，这个变量确保容器可以使用必要的 GPU 计算能力。它的作用如下：</p><ul><li>**<code>compute</code>**：启用 GPU 计算功能（用于 CUDA、TensorFlow、PyTorch 等）。</li><li>**<code>utility</code>**：启用 NVIDIA 实用程序（如 <code>nvidia-smi</code>）。</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><table><thead><tr><th>变量</th><th>作用</th><th>影响</th></tr></thead><tbody><tr><td><code>KEEP_GPUS_TIMEOUT: 40</code></td><td>GPU 资源保持时间</td><td>40 秒内无任务可能释放 GPU</td></tr><tr><td><code>TZ: Asia/Shanghai</code></td><td>设置时区</td><td>确保容器日志时间正确</td></tr><tr><td><code>OLLAMA_ORIGINS: &quot;*&quot;</code></td><td>允许所有来源访问 API</td><td>跨域访问，可能有安全风险</td></tr><tr><td><code>OLLAMA_HOST: &quot;0.0.0.0&quot;</code></td><td>监听所有 IP</td><td>允许外部访问 Ollama</td></tr><tr><td><code>CUDA_VISIBLE_DEVICES: 0</code></td><td>选择 GPU</td><td><code>0</code>代表使用第 1 块 GPU</td></tr><tr><td><code>OLLAMA_USE_CUDA: true</code></td><td>启用 GPU 加速</td><td><code>true</code>= 使用 CUDA，<code>false</code>= 仅 CPU</td></tr></tbody></table><p>如果你在 <strong>云服务器</strong> 上运行 Ollama，建议：</p><ul><li><strong>限制 API 访问</strong>，避免被滥用：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">OLLAMA_ORIGINS:</span> <span class="string">&quot;http://yourdomain.com&quot;</span></span><br></pre></td></tr></table></figure></li><li><strong>只监听本地</strong>，如果不需要外部访问：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">OLLAMA_HOST:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br></pre></td></tr></table></figure></li><li><strong>指定 GPU</strong>，避免影响其他任务：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CUDA_VISIBLE_DEVICES:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></li></ul><p>你是想排查 <strong>Ollama 不使用 GPU</strong> 的问题吗？如果是，<code>nvidia-smi</code> 显示 <strong>无进程</strong>，说明 Ollama 仍然在 CPU 上跑，可能要进一步检查 Ollama 运行日志或 <code>docker-compose</code> 配置。🚀</p><h2 id="docker-compose-yml文件如下"><a href="#docker-compose-yml文件如下" class="headerlink" title="docker-compose.yml文件如下"></a>docker-compose.yml文件如下</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">ollama:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:ollama</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ollama</span></span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">devices:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">driver:</span> <span class="string">nvidia</span></span><br><span class="line">            <span class="attr">capabilities:</span> [<span class="string">&quot;gpu&quot;</span>]</span><br><span class="line">            <span class="attr">count:</span> <span class="string">all</span>  <span class="comment"># 根据需要调整 GPU 的数量  </span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/root/.ollama:/root/.ollama</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;11434:11434&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KEEP_GPUS_TIMEOUT:</span> <span class="number">40</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">OLLAMA_ORIGINS:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">      <span class="attr">OLLAMA_HOST:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">      <span class="attr">CUDA_VISIBLE_DEVICES:</span> <span class="number">0</span><span class="string">,1</span></span><br><span class="line">      <span class="attr">OLLAMA_USE_CUDA:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">NVIDIA_DRIVER_CAPABILITIES:</span> <span class="string">compute,utility</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> gpu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>天翼云裸金属安全组放通端口后 docker端口仍然无法访问问题</title>
      <link href="/2025/03/10/%E5%A4%A9%E7%BF%BC%E4%BA%91%E8%A3%B8%E9%87%91%E5%B1%9E%E5%AE%89%E5%85%A8%E7%BB%84%E6%94%BE%E9%80%9A%E7%AB%AF%E5%8F%A3%E5%90%8E%20docker%E7%AB%AF%E5%8F%A3%E4%BB%8D%E7%84%B6%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E9%97%AE%E9%A2%98/"/>
      <url>/2025/03/10/%E5%A4%A9%E7%BF%BC%E4%BA%91%E8%A3%B8%E9%87%91%E5%B1%9E%E5%AE%89%E5%85%A8%E7%BB%84%E6%94%BE%E9%80%9A%E7%AB%AF%E5%8F%A3%E5%90%8E%20docker%E7%AB%AF%E5%8F%A3%E4%BB%8D%E7%84%B6%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="天翼云裸金属安全组放通端口后-docker端口仍然无法访问问题"><a href="#天翼云裸金属安全组放通端口后-docker端口仍然无法访问问题" class="headerlink" title="天翼云裸金属安全组放通端口后 docker端口仍然无法访问问题"></a>天翼云裸金属安全组放通端口后 docker端口仍然无法访问问题</h1><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>1、查看iptables规则iptables -L -n -v<br>2、清空iptables规则（iptables -F）<br>3、重启docker（systemctl restart docker）<br>4、此时即可访问</p><h2 id="需要单独端口时添加到第一条不要添加在拒绝规则–reject-with-icmp-host-prohibited这个的否则不会生效"><a href="#需要单独端口时添加到第一条不要添加在拒绝规则–reject-with-icmp-host-prohibited这个的否则不会生效" class="headerlink" title="需要单独端口时添加到第一条不要添加在拒绝规则–reject-with icmp-host-prohibited这个的否则不会生效"></a>需要单独端口时添加到第一条不要添加在拒绝规则–reject-with icmp-host-prohibited这个的否则不会生效</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT 1  -p tcp -m state --state NEW -m tcp --dport 9000 -j ACCEPT</span><br></pre></td></tr></table></figure><p>本文参考：<a href="https://blog.csdn.net/qq_36074547/article/details/130359377">iptables 开放端口后依然无法访问问题_linux iptables开放端口无效-CSDN博客</a></p><p>当在iptables中开放端口但仍然无法访问时，可能是因为–reject-withicmp-host-prohibited规则在新端口规则之后，导致开放端口无效。要解决此问题，需确保开放端口的规则位于拒绝规则之前使用service  iptables  save保存，然后重启iptables服务。</p><h3 id="iptables开放端口后仍然无法访问问题–reject-with-icmp-host-prohibited"><a href="#iptables开放端口后仍然无法访问问题–reject-with-icmp-host-prohibited" class="headerlink" title="iptables开放端口后仍然无法访问问题–reject-with icmp-host-prohibited"></a>iptables开放端口后仍然无法访问问题–reject-with icmp-host-prohibited</h3><h3 id="–reject-with-icmp-host-prohibited"><a href="#–reject-with-icmp-host-prohibited" class="headerlink" title="–reject-with icmp-host-prohibited"></a>–reject-with icmp-host-prohibited</h3><p>-A INPUT -j REJECT –reject-with icmp-host-prohibited，这行已拒绝其他端口的命令，如果我们将新插入的开放端口在放在这行命令之后的情况下，后面的配置开放的端口是不会被启用的。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-A INPUT -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 8777 -j ACCEPT</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_31e71b55868aa0a566124fd5213429ca.png"></p><p>新增iptables端口规则时，用 service iptables save 这个命令保存规则会自动把系统外的端口加到–reject-with icmp-host-prohibited 的后面，所以在操作时需要用vim /etc/sysconfig/iptables 把新增规则编辑到–reject-with icmp-host-prohibited前面，最后重启iptables service iptables restart</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TCP队列满了导致web无法访问</title>
      <link href="/2025/03/10/TCP%E9%98%9F%E5%88%97%E6%BB%A1%E4%BA%86%E5%AF%BC%E8%87%B4web%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE/"/>
      <url>/2025/03/10/TCP%E9%98%9F%E5%88%97%E6%BB%A1%E4%BA%86%E5%AF%BC%E8%87%B4web%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="TCP队列满了导致web无法访问"><a href="#TCP队列满了导致web无法访问" class="headerlink" title="TCP队列满了导致web无法访问"></a>TCP队列满了导致web无法访问</h2><p>参考：<a href="https://www.cnblogs.com/wx170119/p/12068005.html">性能分析之TCP全连接队列占满问题分析及优化过程（转载） - 寒冰宇若 - 博客园</a></p><h3 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_eba7a8290c34f4202f101b972931a190.png"></p><p>从图中明显可以看出建立 TCP 连接的时候，有两个队列：<code>syns queue</code>（半连接队列）和<code>accept queue</code>（全连接队列），分别在第一次握手和第三次握手。<br><strong>半连接队列：</strong> 保存 SYN_RECV 状态的连接。<br><strong>控制参数：</strong></p><ul><li>半连接队列的大小：min(backlog, 内核参数 net.core.somaxconn，内核参数tcp_max_syn_backlog).</li><li>net.ipv4.tcp_max_syn_backlog：能接受 SYN 同步包的最大客户端数量，即半连接上限；</li><li>tcp_syncookies：当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击，默认为0，表示关闭；</li></ul><p><strong>accept队列-全连接队列：</strong>保存 ESTABLISHED 状态的连接。<br><strong>控制参数：</strong></p><ul><li>全连接队列的大小：min(backlog, /proc/sys/net/core/somaxconn)，意思是取backlog 与 somaxconn 两值的最小值，<code>net.core.somaxconn</code> 定义了系统级别的全连接队列最大长度，而 backlog 只是应用层传入的参数，所以 backlog 值尽量小于<code>net.core.somaxconn</code>;</li><li><code>net.core.somaxconn</code>(内核态参数，系统中每一个端口最大的监听队列的长度);</li><li><code>net.core.netdev_max_backlog</code>(每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目);</li><li>ServerSocket(int port, int backlog) 代码中的backlog参数;</li><li>文件句柄;</li><li><code>net.ipv4.tcp_abort_on_overflow</code> = 0，此值为 0 表示握手到第三步时全连接队列满时则扔掉 client 发过来的 ACK，此值为 1 则说明握手到第三步时全连接队列满时则返回 reset 给客户端。</li></ul><h3 id="解决："><a href="#解决：" class="headerlink" title="解决："></a>解决：</h3><p>TCP 连接队列的溢出数据统计情况，命令为：“<code>netstat -s</code>”</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看TCP半连接队列溢出：</span></span><br><span class="line">netstat -s | grep LISTEN</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看TCPaccept队列溢出：</span></span><br><span class="line">netstat -s | grep overflow</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_d50e893c7e2b2767779ca86bb857b0ae.png"></p><p>通过反复敲命令，可以看出这个 overflow 的值一直在增加，那么这个现象说明 server 的TCP 全连接队列的确是满了。这时候应该想到的是，全连接队列已经溢出了，下一步就应该看一下，全连接队列的占用情况，命令为:<br><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_a5b95d65c58c598b8e7f7f07bd93d50a.png"></p><p>参数说明：</p><ul><li>Recv-Q：全连接当前长度</li><li>Send-Q：如果连接不是在建立状态，则是当前全连接最大队列长度</li></ul><p>从上图第三列的 <code>Send-Q</code> 可以看出,5000 端口服务的全连接队列最大为 50，而 <code>Recv-Q</code> 为当前使用了多少。在压测过程中，查看指定端口的 TCP 全连接队列使用情况，如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss -lnt |grep 5000</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_54bd96472bde73e4d972bb53f3c277c5.png"></p><p>上图可以看出，<strong>全连接队列几乎已经被占满</strong>，那么最终可以确定问题所在了。找到原因后，现在只要<strong>增大全连接队列的长度</strong>就可以了。<br>通过上面介绍的全连接队列中，我们知道全连接队列的大小为 backlog 和 somaxconn 的最小值，那么来看下 somaxconn 的取值。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysctl -a |grep net.core.somaxconn</span><br><span class="line">sysctl -a |grep net.ipv4.tcp_max_syn_backlog</span><br></pre></td></tr></table></figure><p>如果太少则增加就行：vim /etc/sysctl.conf</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_f9ba3c306d81b7dfbce878340dd5ac6a.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_b3f5209d1c489737a91f10ea33ee8bc3.png"></p><p>可以看出 somaxconn 的值是很大的，那就只有通知开发，增加应用代码中的 backlog 的值来加大全连接队列的长度。</p><h3 id="扩展："><a href="#扩展：" class="headerlink" title="扩展："></a>扩展：</h3><p>一、查看当前系统下所有连接状态的数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -n|awk <span class="string">&#x27;/^tcp/&#123;++S[\$NF]&#125;END&#123;for (key in S) print key,S[key]&#125;&#x27;</span></span><br><span class="line">ESTABLISHED 38</span><br><span class="line">TIME\_WAIT 1000</span><br></pre></td></tr></table></figure><p>二、看下我系统上默认的SYN队列大小</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">log</span>]<span class="comment"># cat /proc/sys/net/ipv4/tcp\_max\_syn\_backlog</span></span><br><span class="line">262144</span><br><span class="line">定义SYN队列大小：</span><br><span class="line"><span class="built_in">echo</span> 4096 &gt; /proc/sys/net/ipv4/tcp\_max\_syn\_backlog   --定义是php配置的两倍，大于php的就行</span><br></pre></td></tr></table></figure><p>三、看下我系统上默认的TIME_WAIT队列大小</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/sys/net/ipv4/tcp\_max\_tw\_buckets</span><br><span class="line">1000</span><br><span class="line">定义TIME\_WAIT的大小：</span><br><span class="line"><span class="built_in">echo</span> 4096 &gt; /proc/sys/net/ipv4/tcp\_max\_tw\_buckets</span><br></pre></td></tr></table></figure><p>四、修改backlog参数<br>Kernel会为LISTEN状态的socket维护两个队列，一个是SYN RECEIVED状态，另一个是ESTABLISHED状态，而backlog就是这两个队列的大小之和。<br>当前Linux版本使用上面说法，有两个队列：具有由系统范围设置指定的大小的SYN队列 和 应用程序（也就是backlog参数）指定的accept队列。</p><p>五、查看系统默认数量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/sys/net/core/netdev\_max\_backlog</span><br><span class="line">定义队列的数据包的最大数目</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;4096&quot;</span>  &gt; /proc/sys/net/core/netdev\_max\_backlog  <span class="comment">#在每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。</span></span><br></pre></td></tr></table></figure><p>六、nginx 配置参数优化：<br>有代理就设置在代理上：没有代理就直接设置在web应用上（或者两个都设置）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">upstream js\_sdk &#123;</span><br><span class="line"><span class="comment">#ip\_hash;</span></span><br><span class="line">server \*\*\*\*\*\*\* weight=1 max\_fails=3 fail\_timeout=10s;</span><br><span class="line">server \*\*\*\*\*\*\* weight=1 max\_fails=3 fail\_timeout=10s;</span><br><span class="line">keepalive 1000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80 default backlog=1024;</span><br><span class="line">    listen 443 ssl default backlog=1024;</span><br></pre></td></tr></table></figure><p>七、php优化：（-1  表示没有使用系统的 backlog ）<br>vim /usr/local/php/etc/php-fpm.conf</p><p>listen.backlog = 2048   #每一个端口最大的监听队列的长度,需要配置nginx配置文件使用，如下（暂时只更改这里）<br>八、linux内核参进行优化：<br>vim /etc/sysctl.conf</p><p> net.ipv4.tcp_syncookies = 1<br> net.ipv4.tcp_max_syn_backlog = 4096  #对于还未获得对方确认的连接请求，可保存在队列中的最大数目。如果服务器经常出现过载，可以尝试增加这个数字。<br> net.core.somaxconn = 4096   #定义了系统中每一个端口最大的监听队列的长度，这是个全局的参数。backlog需要设置这个</p><p>使用命令使之生效：sysctl -p<br>转自：<a href="https://blog.csdn.net/u010917150/article/details/95621873">https://blog.csdn.net/u010917150/article/details/95621873</a></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssh慢报错org.freedesktop.login1timed Out问题</title>
      <link href="/2025/03/02/ssh%E6%85%A2%E6%8A%A5%E9%94%99org.freedesktop.login1timed%20Out%E9%97%AE%E9%A2%98/"/>
      <url>/2025/03/02/ssh%E6%85%A2%E6%8A%A5%E9%94%99org.freedesktop.login1timed%20Out%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ssh慢报错org-freedesktop-login1timed-Out问题"><a href="#ssh慢报错org-freedesktop-login1timed-Out问题" class="headerlink" title="ssh慢报错org.freedesktop.login1timed Out问题"></a>ssh慢报错org.freedesktop.login1timed Out问题</h2><p>原因：</p><ul><li>systemd-logind      进程崩溃或未正常运行</li><li>systemd-logind      负责管理用户登录会话，如果它崩溃或无法启动，SSH 会话创建可能会超时。</li><li>D-Bus 相关问题</li><li>systemd-logind      依赖 dbus，如果 dbus 服务异常，也会导致 SSH 认证超时。</li><li>系统资源不足（CPU/内存占用过高）（排除）</li><li>如果系统负载过高，导致      systemd-logind 响应变慢，SSH 登录会变得异常缓慢。（排除）</li></ul><p>排查方案思考：</p><p>1、看cpu内存等资源占用情况 （正常）</p><p>2、网络带宽占用情况：iftop、bandwhich、nethogs、长ping等 （正常）</p><p>3、看是不是有异常的IP地址访问服务器 （正常）</p><p>4、排查服务（异常）</p><h2 id="现象与故障排查："><a href="#现象与故障排查：" class="headerlink" title="现象与故障排查："></a>现象与故障排查：</h2><p>ssh -v 192.168.100.10</p><p>journalctl -u sshd -f</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_14f9b56791e96a5ed113252939e65d4d.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/3/image_dea227b9c112edcfe113455ef77ad6c2.png"></p><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>删除machine-id后重启各个相关服务<br>rm -rf /etc/machine-id</p><p>systemd-machine-id-setup</p><p>systemctl restart dbus</p><p>systemctl restart systemd-logind</p><p>systemctl restart sshd</p>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Wsl安装的ubuntu20.04子系统二进制部署ollama实现直通底层1050ti及open-webui环境变量问题</title>
      <link href="/2025/02/10/Wsl%E5%AE%89%E8%A3%85%E7%9A%84ubuntu20.04%E5%AD%90%E7%B3%BB%E7%BB%9F%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2ollama%E5%AE%9E%E7%8E%B0%E7%9B%B4%E9%80%9A%E5%BA%95%E5%B1%821050ti%E5%8F%8Aopen-webui%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%97%AE%E9%A2%98/"/>
      <url>/2025/02/10/Wsl%E5%AE%89%E8%A3%85%E7%9A%84ubuntu20.04%E5%AD%90%E7%B3%BB%E7%BB%9F%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2ollama%E5%AE%9E%E7%8E%B0%E7%9B%B4%E9%80%9A%E5%BA%95%E5%B1%821050ti%E5%8F%8Aopen-webui%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="wsl安装的ubuntu20-04子系统二进制部署ollama实现直通底层1050ti及open-webui环境变量问题"><a href="#wsl安装的ubuntu20-04子系统二进制部署ollama实现直通底层1050ti及open-webui环境变量问题" class="headerlink" title="wsl安装的ubuntu20.04子系统二进制部署ollama实现直通底层1050ti及open-webui环境变量问题"></a>wsl安装的ubuntu20.04子系统二进制部署ollama实现直通底层1050ti及open-webui环境变量问题</h2><p>开始本文前需要先使用Wsl安装好ubuntu20.04LTS:</p><ul><li><a href="https://sunlight.zznnwn.cloudns.biz/2025/02/10/windows11%E4%BD%BF%E7%94%A8wsl%E5%AE%89%E8%A3%85ubuntu20.04%E5%B9%B6%E5%AE%89%E8%A3%851050ti%E9%A9%B1%E5%8A%A8/">windows11使用wsl安装ubuntu20.04并安装1050ti驱动</a></li><li><a href="https://sunlight.zznnwn.cloudns.biz/2024/09/05/windows11%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2ollama%E8%B0%83%E7%94%A8%E5%BA%95%E5%B1%82GPU/index.html?_sw-precache=7949b2ffa05f974aeb8530f0ce185b97">windows11使用docker部署ollama调用底层GPU</a></li></ul><p>部署：略</p><p>open-webui部署：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8080:8080 --privileged=<span class="literal">true</span> -e OLLAMA_BASE_URL=http://172.31.63.55:11434 -e ENABLE_SIGNUP=<span class="literal">true</span> -e ENABLE_OPENAI_API=False -v open-webui:/app/backend/data --name open-webui --restart always registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:open-webui-main</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> gpu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows11使用wsl安装ubuntu20.04并安装1050ti驱动</title>
      <link href="/2025/02/10/windows11%E4%BD%BF%E7%94%A8wsl%E5%AE%89%E8%A3%85ubuntu20.04%E5%B9%B6%E5%AE%89%E8%A3%851050ti%E9%A9%B1%E5%8A%A8/"/>
      <url>/2025/02/10/windows11%E4%BD%BF%E7%94%A8wsl%E5%AE%89%E8%A3%85ubuntu20.04%E5%B9%B6%E5%AE%89%E8%A3%851050ti%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="windows11使用wsl安装ubuntu20-04并安装1050ti驱动"><a href="#windows11使用wsl安装ubuntu20-04并安装1050ti驱动" class="headerlink" title="windows11使用wsl安装ubuntu20.04并安装1050ti驱动"></a>windows11使用wsl安装ubuntu20.04并安装1050ti驱动</h1><p>参考：</p><p><a href="https://zhuanlan.zhihu.com/p/689473287">NVIDIA Container Toolkit(NVIDIA Docker)安装教程 - 知乎 (zhihu.com)</a></p><p><a href="https://link.zhihu.com/?target=https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html%23installing-on-ubuntu-and-debian">nvidia官网操作教程</a></p><p><a href="https://sunlight.zznnwn.cloudns.biz/2024/09/05/windows11%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2ollama%E8%B0%83%E7%94%A8%E5%BA%95%E5%B1%82GPU/?highlight=ollama">本博客教程</a></p><p>本教程环境：</p><p>windows11上使用wsl安装的ubunto20.04LTS 显卡 Goforce 1050ti</p><h2 id="安装NVIDIA-Container-Toolkit-NVIDIA-Docker"><a href="#安装NVIDIA-Container-Toolkit-NVIDIA-Docker" class="headerlink" title="安装NVIDIA Container Toolkit(NVIDIA Docker)"></a>安装NVIDIA Container Toolkit(NVIDIA Docker)</h2><h3 id="平台要求"><a href="#平台要求" class="headerlink" title="平台要求"></a>平台要求</h3><ul><li>内核版本 &gt; 3.10 的 GNU/Linux x86_64</li><li>Docker &gt;= 19.03（推荐，但某些发行版可能包含旧版本的 Docker。支持的最低版本为 1.12)</li><li>GPU架构 &gt;= Kepler（或计算能力 3.0）的 NVIDIA GPU</li><li>NVIDIA Linux <a href="https://zhida.zhihu.com/search?content_id=241346902&content_type=Article&match_order=1&q=%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F&zhida_source=entity">驱动程序</a>&gt;= 520.56.06 (请注意，不支持较旧的驱动程序版本或分支。）</li></ul><h3 id="安装NVIDIA-DRIVE-Base-apt"><a href="#安装NVIDIA-DRIVE-Base-apt" class="headerlink" title="安装NVIDIA-DRIVE(Base apt)"></a>安装NVIDIA-DRIVE(Base apt)</h3><p>1.添加 PPA 源：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:graphics-drivers/ppa</span><br></pre></td></tr></table></figure><p>2.为系统安装依赖项以构建内核模块：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install dkms build-essential</span><br></pre></td></tr></table></figure><p>3.打开终端，输入如下命令，显示当前设备支持驱动的版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubuntu-drivers devices</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(base) xuehao@xuehao-Z370-HD3:~$ ubuntu-drivers devices</span><br><span class="line">== /sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0 ==</span><br><span class="line">modalias : pci:v000010DEd00001C82sv00007377sd00000000bc03sc00i00</span><br><span class="line">vendor   : NVIDIA Corporation</span><br><span class="line">model    : GP107 [GeForce GTX 1050 Ti]</span><br><span class="line">driver   : nvidia-driver-525 - distro non-free recommended</span><br><span class="line">driver   : nvidia-driver-470 - distro non-free</span><br><span class="line">driver   : nvidia-driver-515-server - distro non-free</span><br><span class="line">driver   : nvidia-driver-470-server - distro non-free</span><br><span class="line">driver   : nvidia-driver-510 - distro non-free</span><br><span class="line">driver   : nvidia-driver-418-server - distro non-free</span><br><span class="line">driver   : nvidia-driver-525-server - distro non-free</span><br><span class="line">driver   : nvidia-driver-515 - distro non-free</span><br><span class="line">driver   : nvidia-driver-450-server - distro non-free</span><br><span class="line">driver   : nvidia-driver-390 - distro non-free</span><br><span class="line">driver   : xserver-xorg-video-nouveau - distro free <span class="built_in">builtin</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>4.安装指定版本驱动：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nvidia-driver-525</span><br></pre></td></tr></table></figure><p>5.重启设备：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><p>6.执行以下命令验证驱动是否安装成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure><p>打印以下信息则安装成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(base) xuehao@xuehao-Z370-HD3:~$ nvidia-smi</span><br><span class="line">Mon Feb  6 09:55:22 2023   </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 525.78.01    Driver Version: 525.78.01    CUDA Version: 12.0     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                               |                      |               MIG M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  NVIDIA GeForce ...  Off  | 00000000:01:00.0  On |                  N/A |</span><br><span class="line">| 45%   36C    P0    N/A /  75W |    555MiB /  4096MiB |      8%      Default |</span><br><span class="line">|                               |                      |                  N/A |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line">                                                                           </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0   N/A  N/A      1084      G   /usr/lib/xorg/Xorg                 59MiB |</span><br><span class="line">|    0   N/A  N/A      1800      G   /usr/lib/xorg/Xorg                220MiB |</span><br><span class="line">|    0   N/A  N/A      1926      G   /usr/bin/gnome-shell               39MiB |</span><br><span class="line">|    0   N/A  N/A     49745      G   ...RendererForSitePerProcess       83MiB |</span><br><span class="line">|    0   N/A  N/A     60087      G   ...079604264900979074,131072      141MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="安装-NVIDIA-容器工具包（NVIDIA-Container-Toolkit）"><a href="#安装-NVIDIA-容器工具包（NVIDIA-Container-Toolkit）" class="headerlink" title="安装 NVIDIA 容器工具包（NVIDIA Container Toolkit）"></a>安装 NVIDIA 容器工具包（NVIDIA Container Toolkit）</h3><p>1.设置包存储库和 GPG 密钥：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">distribution=$(. /etc/os-release;<span class="built_in">echo</span> $ID<span class="variable">$VERSION_ID</span>) \</span><br><span class="line">      &amp;&amp; curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \</span><br><span class="line">      &amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/<span class="variable">$distribution</span>/libnvidia-container.list | \</span><br><span class="line">            sed <span class="string">&#x27;s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g&#x27;</span> | \</span><br><span class="line">            sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/nvidia-container-toolkit.list</span><br></pre></td></tr></table></figure><p>2.更新包列表后安装nvidia-docker2包（和依赖项）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y nvidia-docker2</span><br></pre></td></tr></table></figure><p>3.设置默认运行时后重启 Docker 守护进程完成安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><p>4.此时，可以通过运行基本 CUDA 容器来测试工作设置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --<span class="built_in">rm</span> --gpus all nvidia/cuda:11.6.2-base-ubuntu20.04 nvidia-smi</span><br></pre></td></tr></table></figure><p>这应该会产生如下所示的控制台输出：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 450.51.06    Driver Version: 450.51.06    CUDA Version: 11.0     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                               |                      |               MIG M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  Tesla T4            On   | 00000000:00:1E.0 Off |                    0 |</span><br><span class="line">| N/A   34C    P8     9W /  70W |      0MiB / 15109MiB |      0%      Default |</span><br><span class="line">|                               |                      |                  N/A |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|  No running processes found                                                 |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="扩展wsl命令简单使用及wsl安装的ubuntu的备份与还原"><a href="#扩展wsl命令简单使用及wsl安装的ubuntu的备份与还原" class="headerlink" title="扩展wsl命令简单使用及wsl安装的ubuntu的备份与还原"></a>扩展wsl命令简单使用及wsl安装的ubuntu的备份与还原</h3><p>参考：<a href="https://www.cnblogs.com/Chary/p/18011740">wsl2子系统的备份和还原 - CharyGao - 博客园 (cnblogs.com)</a></p><h4 id="wsl2子系统的备份和还原"><a href="#wsl2子系统的备份和还原" class="headerlink" title="wsl2子系统的备份和还原"></a><a href="https://www.cnblogs.com/Chary/p/18011740" title="发布于 2024-02-08 13:39">wsl2子系统的备份和还原</a></h4><h4 id="查看当前WSL版本"><a href="#查看当前WSL版本" class="headerlink" title="查看当前WSL版本"></a>查看当前<a href="https://so.csdn.net/so/search?q=WSL&spm=1001.2101.3001.7020">WSL</a>版本</h4><p>查看有哪些可以安装的系统</p><p><code>wsl --list --online</code></p><p><code>wsl -l</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PS C:\windows\system32&gt; wsl -l</span><br><span class="line"></span><br><span class="line">适用于 Linux 的 Windows 子系统分发:</span><br><span class="line">Ubuntu-22.04 (默认)</span><br></pre></td></tr></table></figure><p><code>wsl --version</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PS C:\windows\system32&gt; wsl --version</span><br><span class="line"></span><br><span class="line">WSL 版本： 1.2.5.0</span><br><span class="line">内核版本： 5.15.90.1</span><br><span class="line">WSLg 版本： 1.0.51</span><br><span class="line">MSRDC 版本： 1.2.3770</span><br><span class="line">Direct3D 版本： 1.608.2-61064218</span><br><span class="line">DXCore 版本： 10.0.25131.1002-220531-1700.rs-onecore-base2-hyp</span><br><span class="line">Windows 版本： 10.0.19045.2965</span><br></pre></td></tr></table></figure><h4 id="查看运行中的子系统"><a href="#查看运行中的子系统" class="headerlink" title="查看运行中的子系统"></a>查看运行中的子系统</h4><p><code>wsl -l --running</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\windows\system32&gt; wsl -l --running</span><br><span class="line">没有正在运行的分发。</span><br></pre></td></tr></table></figure><h4 id="运行子系统"><a href="#运行子系统" class="headerlink" title="运行子系统"></a>运行子系统</h4><p><code>wsl --distribution Ubuntu-22.04</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PS C:\windows\system32&gt; wsl --distribution Ubuntu-22.04</span><br><span class="line"></span><br><span class="line">Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.90.1-microsoft-standard-WSL2 x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line"> * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s</span><br><span class="line">   just raised the bar for easy, resilient and secure K8s cluster deployment.</span><br><span class="line"></span><br><span class="line">   https://ubuntu.com/engage/secure-kubernetes-at-the-edge</span><br><span class="line"></span><br><span class="line">This message is shown once a day. To disable it please create the</span><br><span class="line">/home/yang/.hushlogin file.</span><br></pre></td></tr></table></figure><h4 id="停止子系统"><a href="#停止子系统" class="headerlink" title="停止子系统"></a>停止子系统</h4><p><code>wsl --terminate Ubuntu-22.04</code> 或 <code>wsl --shutdown</code> (停止当前子系统)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS C:\windows\system32&gt; wsl --terminate Ubuntu-22.04</span><br><span class="line"></span><br><span class="line">操作成功完成。</span><br></pre></td></tr></table></figure><h4 id="备份子系统（需要先停止才能备份）"><a href="#备份子系统（需要先停止才能备份）" class="headerlink" title="备份子系统（需要先停止才能备份）"></a>备份子系统（需要先停止才能备份）</h4><p><code>wsl --export Ubuntu-22.04 D:\temp\Ubuntu-22.04.tar</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PS C:\windows\system32&gt; wsl --export Ubuntu-22.04 D:\temp\Ubuntu-22.04.tar</span><br><span class="line"></span><br><span class="line">正在导出，这可能需要几分钟时间。</span><br><span class="line">操作成功完成。</span><br></pre></td></tr></table></figure><h4 id="卸载子系统"><a href="#卸载子系统" class="headerlink" title="卸载子系统"></a>卸载子系统</h4><p><code>wsl --unregister Ubuntu-22.04</code></p><h4 id="还原子系统"><a href="#还原子系统" class="headerlink" title="还原子系统"></a>还原子系统</h4><p><code>wsl --import &lt;Distro&gt; &lt;InstallLocation&gt; &lt;FileName&gt; [Options]</code></p><p><code>wsl --import Ubuntu-22.04 C:\WSL D:\temp\Ubuntu-22.04.tar</code></p><p><strong>Note: 当还原后的子系统变为root权限了</strong></p><h4 id="改为默认用户权限"><a href="#改为默认用户权限" class="headerlink" title="改为默认用户权限"></a>改为默认用户权限</h4><ol><li>查看当前用户 <code>ls /home/</code></li><li>尝试切换至用户权限 <code>su 用户名</code></li><li>切换至<a href="https://so.csdn.net/so/search?q=root%E6%9D%83%E9%99%90&spm=1001.2101.3001.7020">root权限</a><code>sudo su</code></li><li>修改默认配置文件<ol><li>备份 <code>cp /etc/wsl.conf /etc/wsl.conf.bk</code></li><li>修改 <code>vim /etc/wsl.conf</code> 在最前面增加以下内容<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[user]</span><br><span class="line">default=用户名 </span><br></pre></td></tr></table></figure></li><li>重启wsl，在power shell中重启<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 查看当前运行的wsl</span><br><span class="line">wsl --list --running</span><br><span class="line"></span><br><span class="line"># 停止特定的wsl</span><br><span class="line">wsl -t Ubuntu-22.04</span><br><span class="line"># 启动特定版本wsl</span><br><span class="line">wsl -d Ubuntu-22.04</span><br><span class="line"></span><br><span class="line">#或者</span><br><span class="line"># 停止当前所有运行wsl</span><br><span class="line">wsl --shutdowm</span><br><span class="line"># 启动默认wsl</span><br><span class="line">wsl</span><br></pre></td></tr></table></figure></li></ol></li></ol><h2 id="wsl2迁移与恢复"><a href="#wsl2迁移与恢复" class="headerlink" title="wsl2迁移与恢复"></a>wsl2迁移与恢复</h2><p>此处记录一下wsl2的迁移，以及当在系统C盘重置系统如何恢复旧版wsl2</p><h3 id="wsl2迁移"><a href="#wsl2迁移" class="headerlink" title="wsl2迁移"></a>wsl2迁移</h3><p>这个是建立在已经安装wsl2的基础之上</p><p>1.查看当前wsl下的Linux是否为关闭状态，当state为Stopped才能进行下一步。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl -l -v  </span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/35ce5aa0dea44e0ab976a58404001362.png" alt="在这里插入图片描述"></p><p>若state为Running时，利用下面的命令结束</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --shutdown</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/d35fdc6412f1407a897cfa0e304af7a1.png" alt="在这里插入图片描述"><br>2.以.tar的形式导出到其他盘</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --<span class="keyword">export</span> <span class="title class_">Ubuntu</span>-<span class="number">20.04</span> <span class="attr">e</span>:\<span class="title class_">Ubuntu</span>-<span class="number">20.04</span>.<span class="property">tar</span></span><br></pre></td></tr></table></figure><p>【注】此处导出的==Ubuntu-20.04.tar==文件可以作为备份文件，下次恢复时直接执行第4步的导入系统就行</p><p>3.注销原有的<a href="https://so.csdn.net/so/search?q=linux%E7%B3%BB%E7%BB%9F&spm=1001.2101.3001.7020">linux系统</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --unregister <span class="title class_">Ubuntu</span>-<span class="number">20.04</span></span><br></pre></td></tr></table></figure><p>4.导入系统</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --<span class="keyword">import</span> <span class="title class_">Ubuntu</span>-<span class="number">20.04</span> <span class="attr">E</span>:\ubuntu2004 <span class="attr">E</span>:\<span class="title class_">Ubuntu</span>-<span class="number">20.04</span>.<span class="property">tar</span></span><br></pre></td></tr></table></figure><p>5.修改默认用户（因为不修改用户名，打开wsl ubuntu之后，默认以root身份登录。）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubuntu.<span class="property">exe</span> config --<span class="keyword">default</span>-user &lt;--用户名--&gt;</span><br></pre></td></tr></table></figure><p><strong>用户名</strong>是原有wsl ubuntu的用户名称。</p><h3 id="重装系统恢复旧版wsl2"><a href="#重装系统恢复旧版wsl2" class="headerlink" title="重装系统恢复旧版wsl2"></a>重装系统恢复旧版wsl2</h3><p>此处是针对重置系统盘，同时旧版wsl2已经迁移到其他盘，如何恢复旧版wsl2</p><p>1.先重新安装一个新的wsl2，这个可以参照网上的<a href="https://so.csdn.net/so/search?q=wsl2%E5%AE%89%E8%A3%85&spm=1001.2101.3001.7020">wsl2安装</a>教程，注意安装的Ubuntu的版本要和旧版的Ubuntu版本（即你想恢复的Ubuntu）一致<br>2.当安装wsl2成功后，此时wsl2默认安装在系统C盘，然后按照上面的==wsl2迁移==步骤把wsl2迁移到其他盘<br>3.迁移成功后，把新版的==ext4.vhdx==<strong>删除</strong>，拷贝成旧版的<strong>ext4.vhdx</strong><br>4.启动wsl2，即可恢复旧版wsl2<br>【注】一定要把新版的==ext4.vhdx==删除，不能用旧版的去替换新版的==ext4.vhdx==（即如下图操作是不能恢复到旧版），否则替换成功后，当你启动wsl2会发现还是新版的Ubuntu。<br><img src="https://img-blog.csdnimg.cn/9dd9723d83444ccbad37bb999e494b97.png" alt="在这里插入图片描述"></p><blockquote><p>Docker 是指容器化技术，用于支持创建和使用 Linux® 容器（LXC技术） 。<br>我们在 Window 上安装 Docker Desktop ，需要基于 Linux 环境。<br>在 Windows上，Docker Desktop 为我们提供通过了两个选项：WSL 与 Hyper-V 。</p></blockquote><h2 id="一、WSL2-以及-hyper-v区别，二者安装docker-desktop"><a href="#一、WSL2-以及-hyper-v区别，二者安装docker-desktop" class="headerlink" title="一、WSL2 以及 hyper-v区别，二者安装docker desktop"></a>一、WSL2 以及 hyper-v区别，二者安装docker desktop</h2><h5 id="1-WSL2和hyper-v区别"><a href="#1-WSL2和hyper-v区别" class="headerlink" title="1.WSL2和hyper-v区别"></a>1.WSL2和hyper-v区别</h5><p>简单来说：</p><ul><li>wsl是一个运行在我下面的解释linux命令的程序，可以直接操作win的资源，又集成了如putty类的集合，不过人家是自己做的。WSL 使用 Hyper-V 架构来实现其虚拟化。。</li><li>WSL 官方文档（Windows Subsystem for Linux，适用于windows的linux子系统）则是Windows 操作系统的一项特性，可让您直接在 Windows 上运行 Linux 文件系统以及 Linux 命令行工具和 GUI 应用程序，以及传统的 Windows 桌面和应用程序。</li><li>运行WSL的开销比运行一个虚拟机低很多。WSL 2实际上用的是运行在Hyper-v上的linux内核，相较于虚拟机你不需要很多的性能开销。</li><li>hyper-v是虚拟机程序，可以提供一个完整的计算机环模拟，与host需要通过网络访问 。Hyper-V 微软官方文档 :让你可以在 Windows 上以虚拟机形式运行多个操作系统，提供硬件虚拟化。</li></ul><p><strong>在大多数情况下：<br>如果你只使用 Docker : WSL<br>如果你需要Linux，其他的虚拟机或想访问Docker的高级选项卡来分配资源: Hyper-V</strong>。</p><h5 id="2-安装Docker-Desktop"><a href="#2-安装Docker-Desktop" class="headerlink" title="2.安装Docker Desktop"></a>2.安装Docker Desktop</h5><p><strong>参考：</strong><a href="https://blog.csdn.net/rilqa/article/details/118496196">docker win10专业版下 WSL 2 或 hyper-v 安装Docker Desktop</a></p><h2 id="二、docker-desktop限额配置，资源配置方法"><a href="#二、docker-desktop限额配置，资源配置方法" class="headerlink" title="二、docker desktop限额配置，资源配置方法"></a>二、docker desktop限额配置，资源配置方法</h2><p>使用WSL2和hyper-v安装的docker，配置是有区别的。</p><p><strong>1.使用WSL2运行docker：</strong></p><p>这里会是选择状态：<br><img src="https://img-blog.csdnimg.cn/123d6961eedb4fe9845c044cf9e6cfe0.png" alt="在这里插入图片描述"></p><p>它的配置方法如图所示，需要在用户目录(比如：C:\Users\lc)下建立一个新文件，叫做.wslconfig，<br><img src="https://img-blog.csdnimg.cn/4e6482bd7fe94aa79627fa25831b5043.png" alt="在这里插入图片描述"></p><p>修改文件内容为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[wsl2]</span><br><span class="line">processors=4</span><br><span class="line">memory=8GB</span><br><span class="line">swap=8GB</span><br><span class="line">localhostForwarding=true</span><br></pre></td></tr></table></figure><p>memory: 表示最大使用 2GB 内存<br>swap: 表示不设置 swap<br>localhostForwarding: 默认值为 true。如果 WSL 2 VM 中绑定到通配符或 localhost 的端口应该可以通过 localhost:port 从主机连接。<br>processors: 使用的核心数量，默认和你的 Windows 系统使用的核心数一样</p><p>重启wsl2:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --shutdown</span><br></pre></td></tr></table></figure><p><strong>2.使用hyper-v运行docker：</strong></p><p>首先不勾选Use the WSL 2 based engine，</p><p><img src="https://img-blog.csdnimg.cn/a13ad9bea2eb4c40a15045396883d8f3.png" alt="在这里插入图片描述"></p><p>然后进入Resources Advanced：<br><img src="https://img-blog.csdnimg.cn/3bf73387f47944aeafd7331f060194a7.png" alt="在这里插入图片描述"></p><p>修改即可！</p><p><a href="https://blog.csdn.net/weixin_43431218/article/details/132335797">【Docker】Docker Desktop配置资源：cpu、内存等(windows环境下)_wsl 2 对比 hyper-v-CSDN博客</a></p>]]></content>
      
      
      <categories>
          
          <category> gpu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>魔改笔记六：博客加速</title>
      <link href="/2025/01/23/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E5%85%AD%EF%BC%9A%E5%8D%9A%E5%AE%A2%E5%8A%A0%E9%80%9F/"/>
      <url>/2025/01/23/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E5%85%AD%EF%BC%9A%E5%8D%9A%E5%AE%A2%E5%8A%A0%E9%80%9F/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="魔改笔记六：博客加速（本文转载）"><a href="#魔改笔记六：博客加速（本文转载）" class="headerlink" title="魔改笔记六：博客加速（本文转载）"></a>魔改笔记六：博客加速（本文转载）</h1><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>这几天闲来无事，学习了下Hexo的博客速度优化，发现有好多方法。CDN加速、Coding部署、gulp压缩、hexo-neat、InstantClick 黑科技等等。这里记录下我使用gulp压缩进行Hexo速度优化和在此过程中遇到的问题，以及使用hexo-neat对Hexo进行速度优化。<br>这两种方法都是静态文件压缩，静态文件包括: html,css,js,images</p><p>0x01 优化之前<br>在博客速度优化之前，先来说说在浏览器输入url到页面打开，都做了些什么？，因为没怎么了解过，所以参考了很多博客，具体参考的博客链接在文末。<br>当在浏览器地址栏输入网址，如：<a href="http://www.baidu.com后浏览器是怎么把最终的页面呈现出来的呢？这个过程可以大致分为两个部分：网络通信和页面渲染。">www.baidu.com后浏览器是怎么把最终的页面呈现出来的呢？这个过程可以大致分为两个部分：网络通信和页面渲染。</a></p><h2 id="1、大致流程"><a href="#1、大致流程" class="headerlink" title="1、大致流程"></a>1、大致流程</h2><p>URL 解析-&gt;DNS 查询-&gt;TCP 连接-&gt;处理请求-&gt;接受响应-&gt;渲染页面<br>简单的来说，就是：</p><p>浏览器里输入网址<br>浏览器查找域名对应的IP地址<br>DNS具体的查找过程，包括：浏览器缓存-&gt;系统缓存-&gt;路由器缓存-&gt;ISP DNS缓存-&gt;根域名服务器<br>浏览器向web服务器发送一个HTTP请求<br>服务器的永久重定向响应（从<a href="http://baidu.com/">http://baidu.com</a> 到 <a href="http://www.baidu.com)/">http://www.baidu.com）</a><br>为什么要重定向？其中一个原因跟搜索引擎排名有关。如果一个页面有两个地址，就像<a href="http://baidu.com/%E5%92%8Chttp://www.baidu.com/%EF%BC%8C%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E4%BC%9A%E8%AE%A4%E4%B8%BA%E5%AE%83%E4%BB%AC%E6%98%AF%E4%B8%A4%E4%B8%AA%E7%BD%91%E7%AB%99%EF%BC%8C%E7%BB%93%E6%9E%9C%E9%80%A0%E6%88%90%E6%AF%8F%E4%B8%80%E4%B8%AA%E7%9A%84%E6%90%9C%E7%B4%A2%E9%93%BE%E6%8E%A5%E9%83%BD%E5%87%8F%E5%B0%91%E4%BB%8E%E8%80%8C%E9%99%8D%E4%BD%8E%E6%8E%92%E5%90%8D%E3%80%82%E6%89%80%E4%BB%A5%E8%A6%81%E6%8A%8A%E5%B8%A6www%E7%9A%84%E5%92%8C%E4%B8%8D%E5%B8%A6www%E7%9A%84%E5%9C%B0%E5%9D%80%E5%BD%92%E5%88%B0%E5%90%8C%E4%B8%80%E4%B8%AA%E7%BD%91%E7%AB%99%E6%8E%92%E5%90%8D%E4%B8%8B%E3%80%82%E8%BF%98%E6%9C%89%E4%B8%80%E4%B8%AA%E5%8E%9F%E5%9B%A0%E6%98%AF%E7%94%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E5%9C%B0%E5%9D%80%E4%BC%9A%E9%80%A0%E6%88%90%E7%BC%93%E5%AD%98%E5%8F%8B%E5%A5%BD%E6%80%A7%E5%8F%98%E5%B7%AE%E3%80%82">http://baidu.com/和http://www.baidu.com/，搜索引擎会认为它们是两个网站，结果造成每一个的搜索链接都减少从而降低排名。所以要把带www的和不带www的地址归到同一个网站排名下。还有一个原因是用不同的地址会造成缓存友好性变差。</a></p><p>浏览器跟踪重定向地址，发起GET请求<br>服务器”处理”请求，向浏览器发回一个HTML响应<br>浏览器解析显示HTML<br>浏览器发送请求获取嵌入在 HTML 中的资源（如图片、音频、视频、CSS、JS等等）<br>浏览器发送异步请求（ajax请求等）</p><h2 id="2、简单分析"><a href="#2、简单分析" class="headerlink" title="2、简单分析"></a>2、简单分析</h2><p>从上面的过程可以看出，大部分过程我们无法控制，所以只能从浏览器端入手来找一些可以做的事情。<br>少发送请求</p><p>把要加载的js文件（css文件同理）合并成一个（尽量少）文件，则可以向服务器少发送请求，从而减少等待时间。</p><p>压缩文件</p><p>使用压缩之后的js、css、img文件，同样可以减少请求时间。</p><p>Css Sprite</p><p>这是css的一项技术，将图片尽可能多的合并成一个图片文件，第一次使用的时候加载这张图片，然后浏览器会缓存下来，其他地方再使用的时候就不需要重新请求了。</p><p>js／css位置</p><p>css引用建议放在head标签里面；js脚本建议放到body内容的最后，原因：等待js加载或者脚本有错误的时候不会影响html页面的展示。</p><p>那么怎么提高hexo这个静态博客的页面加载速度呢？可以从以下的几个方面去入手：</p><p>将js文件尽可能放到body的闭合标签之前，因为在加载或者引入js文件时是阻塞式的，如果在页面的最开始就引入这些js文件，而这些文件又比较大，会造成页面在渲染时长时间处于白屏状态。<br>尽量避免去引用访问速度非常低下的cdn或者图片，可改用访问速度更快的cdn，或将难以迅速加载的图片保存到自己的站点目录下，以免在加载图片时耗费大量时间，最后还加载失败。<br>对页面的静态资源进行压缩，包括css、js和html等文件。<br>我们自己添加的css和js文件为了可读性，往往会有很多换行和空格，这些对于浏览器来说并没什么用，甚至还会降低渲染页面的速度。<br>至于html文件，由于Markdown转成html的bug，会导致页面存在大量的空白，查看下页面的源代码，会发现有大量的空白符，这也会造成页面渲染的性能问题。</p><h2 id="0x02-gulp4压缩静态文件"><a href="#0x02-gulp4压缩静态文件" class="headerlink" title="0x02 gulp4压缩静态文件"></a>0x02 gulp4压缩静态文件</h2><h3 id="1、安装gulp"><a href="#1、安装gulp" class="headerlink" title="1、安装gulp"></a>1、安装gulp</h3><p>在站点根目录下安装gulp工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install gulp -g</span><br></pre></td></tr></table></figure><p>2.安装gulp插件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install gulp-minify-html gulp-minify-css gulp-uglify gulp-imagemin --save</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解决【Gulp打包问题】 GulpUglifyError: unable to minify JavaScript</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 gulp-uglify 压缩JavaScript 不兼容 es5 语法的问题</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#npm install babel-core@6.26.3 --save</span></span><br><span class="line"><span class="comment">#npm install gulp-babel@7.0.1 --save</span></span><br><span class="line"><span class="comment">#npm install babel-preset-es2015@6.24.1 --save</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gulp-babel 取消严格模式方法(&quot;use strict&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#npm install gulp-remove-use-strict --save</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#问题：如果安装gulp-imagemin错误请执行以下语句</span></span><br><span class="line"><span class="comment">#sudo npm i gulp-imagemin --unsafe-perms</span></span><br></pre></td></tr></table></figure><h3 id="2、建立gulpfile-js文件"><a href="#2、建立gulpfile-js文件" class="headerlink" title="2、建立gulpfile.js文件"></a>2、建立gulpfile.js文件</h3><p>在站点根目录下创建gulpfile.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">&#x27;gulp&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Plugins模块获取</span></span><br><span class="line"><span class="keyword">var</span> minifycss = <span class="built_in">require</span>(<span class="string">&#x27;gulp-minify-css&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> uglify = <span class="built_in">require</span>(<span class="string">&#x27;gulp-uglify&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> minifyhtml = <span class="built_in">require</span>(<span class="string">&#x27;gulp-minify-html&#x27;</span>);</span><br><span class="line"><span class="comment">// 压缩 public 目录 css文件</span></span><br><span class="line">gulp.<span class="title function_">task</span>(<span class="string">&#x27;minify-css&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.<span class="title function_">src</span>(<span class="string">&#x27;./public/**/*.css&#x27;</span>)</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">minifycss</span>())</span><br><span class="line">        .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&#x27;./public&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩 public 目录 html文件</span></span><br><span class="line">gulp.<span class="title function_">task</span>(<span class="string">&#x27;minify-html&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.<span class="title function_">src</span>(<span class="string">&#x27;./public/**/*.html&#x27;</span>)</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">minifyhtml</span>())</span><br><span class="line">        .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&#x27;./public&#x27;</span>))</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 压缩 public/js 目录 js文件，忽略/public/lib/blog-encrypt.js</span></span><br><span class="line">gulp.<span class="title function_">task</span>(<span class="string">&#x27;minify-js&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//纠错前：return gulp.src(&#x27;./public/**/*.js&#x27;)</span></span><br><span class="line">    <span class="keyword">return</span> gulp.<span class="title function_">src</span>([<span class="string">&#x27;./public/**/*.js&#x27;</span>, <span class="string">&#x27;!./public/lib/blog-encrypt.js&#x27;</span>])</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">uglify</span>())</span><br><span class="line">        .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&#x27;./public&#x27;</span>))</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 压缩图片</span></span><br><span class="line"><span class="comment">//gulp.task(&#x27;minify-images&#x27;, function() &#123;</span></span><br><span class="line"><span class="comment">//    return gulp.src(&#x27;./public/images/**/*.*&#x27;)</span></span><br><span class="line"><span class="comment">//        .pipe(imagemin(</span></span><br><span class="line"><span class="comment">//        [imagemin.gifsicle(&#123;&#x27;optimizationLevel&#x27;: 3&#125;),</span></span><br><span class="line"><span class="comment">//        imagemin.jpegtran(&#123;&#x27;progressive&#x27;: true&#125;),</span></span><br><span class="line"><span class="comment">//        imagemin.optipng(&#123;&#x27;optimizationLevel&#x27;: 7&#125;),</span></span><br><span class="line"><span class="comment">//        imagemin.svgo()],</span></span><br><span class="line"><span class="comment">//        &#123;&#x27;verbose&#x27;: true&#125;))</span></span><br><span class="line"><span class="comment">//        .pipe(gulp.dest(&#x27;./public/images&#x27;))</span></span><br><span class="line"><span class="comment">//&#125;);</span></span><br><span class="line"><span class="comment">//因为我图片用的第三方图床存放的，所以就没压缩图片。(并且最后测试压缩图片时，发现有点权限问题，</span></span><br><span class="line"><span class="comment">//整了两个多小时没整好！@^@)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 分别执行css、heml、js的压缩任务</span></span><br><span class="line">gulp.<span class="title function_">task</span>(<span class="string">&#x27;default&#x27;</span>, gulp.<span class="title function_">parallel</span>(<span class="string">&#x27;minify-css&#x27;</span>, <span class="string">&#x27;minify-html&#x27;</span>, <span class="string">&#x27;minify-js&#x27;</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>注：<br>1.修改上面的各个目录为你的真实目录， ** 代表0或多个子目录<br>2.在默认任务中，gulp.parallel()是gulp4中的新写法：<br>gulp.series 用于串行(顺序)执行<br>gulp.parallel 用于并行执行<br>3.部署执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; gulp &amp;&amp; hexo d</span><br></pre></td></tr></table></figure><p>感觉命令有点多，也可以直接在<code>package.json</code>文件里添加</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;hexo&quot;</span>: <span class="string">&quot;hexo clean &amp;&amp; hexo g &amp;&amp; gulp &amp;&amp; hexo d&quot;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>3、遇到的问题</p><p>在使用gup4压缩静态文件时遇到一些问题，总结一下：<br><strong>1.gulp4的默认任务执行问题</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//4.0以前的写法 </span><br><span class="line">//gulp.task(<span class="string">&#x27;default&#x27;</span>, [<span class="string">&#x27;minify-html&#x27;</span>, <span class="string">&#x27;minify-css&#x27;</span>, <span class="string">&#x27;minify-js&#x27;</span>]);</span><br><span class="line">//4.0以后的写法</span><br><span class="line">// 执行 gulp 命令时执行的任务</span><br><span class="line">gulp.task(<span class="string">&#x27;default&#x27;</span>, gulp.parallel(<span class="string">&#x27;minify-css&#x27;</span>, <span class="string">&#x27;minify-html&#x27;</span>, <span class="string">&#x27;minify-js&#x27;</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>2.TypeError: dest.on is not a function</strong><br>先检查gulpfile.js若没有问题，删掉node_modules，重装一遍依赖npm install</p><p><strong>3.GulpUglifyError: unable to minify JavaScript(Gulp打包问题)</strong><br>错误原因有很多，如：有的文件不能打包、javascirpt语法问题等等。我遇到的问题是有的文件不能打包。<br>（1）解决方法1：<br>检查哪一个文件中的哪一行有问题，安装 gulp-util 模块 用于打印日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev gulp-util</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在<code>gulpfile.js</code>里添加：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">&#x27;script&#x27;</span>, <span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">    gulp.src([<span class="string">&#x27;public/**/*.js&#x27;</span>, <span class="string">&#x27;public/lib/**/*.js&#x27;</span>])</span><br><span class="line">        .pipe(uglify())</span><br><span class="line">        .on(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span>(err) &#123;</span><br><span class="line">            gutil.log(gutil.colors.red(<span class="string">&#x27;[Error]&#x27;</span>), err.toString());</span><br><span class="line">        &#125;)</span><br><span class="line">        .pipe(<span class="string">&#x27;dist/js&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>执行<code>gulp script</code>，这样就可以精准的逐个排查文件了。这里我排查到：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/1/image_f3aaeb96f790f6e8a908eba5ff8b3eef.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/1/image_f3aaeb96f790f6e8a908eba5ff8b3eef.png"></p><p>发现<code>blog-encrypt.js</code>有问题，在<code>gulpfile.js</code>忽略<code>blog-encrypt.js</code>即可，即</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 压缩 public/js 目录 js文件</span></span><br><span class="line">gulp.<span class="title function_">task</span>(<span class="string">&#x27;minify-js&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//纠错前：return gulp.src(&#x27;./public/**/*.js&#x27;)</span></span><br><span class="line">    <span class="keyword">return</span> gulp.<span class="title function_">src</span>([<span class="string">&#x27;./public/**/*.js&#x27;</span>, <span class="string">&#x27;!./public/lib/blog-encrypt.js&#x27;</span>])</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">uglify</span>())</span><br><span class="line">        .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&#x27;./public&#x27;</span>))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>（2）解决方法2：<br>继续方法1 安装 babel 模块<br><code>gulp-babel</code>、<code>babel-preset-es2015</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev gulp-babel babel-preset-es2015</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">gulp.task(<span class="string">&#x27;script&#x27;</span>, <span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">    gulp.src([<span class="string">&#x27;public/**/*.js&#x27;</span>, <span class="string">&#x27;public/lib/**/*.js&#x27;</span>])</span><br><span class="line">        .pipe(babel(&#123;</span><br><span class="line">            presets: [<span class="string">&#x27;es2015&#x27;</span>] // es5检查机制</span><br><span class="line">        &#125;))</span><br><span class="line">        .pipe(uglify())</span><br><span class="line">        .on(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span>(err) &#123;</span><br><span class="line">            gutil.log(gutil.colors.red(<span class="string">&#x27;[Error]&#x27;</span>), err.toString());</span><br><span class="line">        &#125;)</span><br><span class="line">        .pipe(<span class="string">&#x27;dist/js&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样就解决 gulp-uglify 压缩JavaScript 不兼容 es5 语法的问题了。<br>4.The following tasks did not complete: html Did you forget to signal async completion?<br>运行gulp，出现下面报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The following tasks did not complete: html </span><br><span class="line">Did you forget to signal async completion?</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>解决办法：在注册的任务函数里使用 async 和 await。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">&quot;html&quot;</span>,async()=&gt;&#123;</span><br><span class="line">await gulp.src(folder.src + <span class="string">&quot;html/*&quot;</span>)</span><br><span class="line">.pipe(htmlClean())</span><br><span class="line">.pipe(gulp.dest(folder.build + <span class="string">&quot;html&quot;</span>))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>gulp4安装使用过程中，我暂时就遇到上面这几种错误。除了上述错误，还有很多可能会出错的地方，这里有个博客记录了一些：gulp 错误集锦</p><p>0x03 hexo-neat压缩静态文件<br>hexo-neat是由rozbo大佬开发的压缩插件，配置简单，无需额外命令，只要使用原本的调试三连或者部署三连就可以自动完成静态资源的压缩</p><h4 id="1、安装hexo-neat"><a href="#1、安装hexo-neat" class="headerlink" title="1、安装hexo-neat"></a>1、安装hexo-neat</h4><p>在站点根目录下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-neat --save</span><br></pre></td></tr></table></figure><h5 id="2、添加相关配置"><a href="#2、添加相关配置" class="headerlink" title="2、添加相关配置"></a>2、添加相关配置</h5><p>在站点配置文件<code>_config.yml</code>添加相关配置，直接添加到站点配置文件<code>_config.yml</code>的末尾就可以。可以安装自己的需求去自定义配置，不过有些注意事项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hexo-neat</span></span><br><span class="line"><span class="comment"># 博文压缩</span></span><br><span class="line">neat_enable: <span class="literal">true</span></span><br><span class="line"><span class="comment"># 压缩html</span></span><br><span class="line">neat_html:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">  exclude:</span><br><span class="line"><span class="comment"># 压缩css  </span></span><br><span class="line">neat_css:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">  exclude:</span><br><span class="line">    - <span class="string">&#x27;**/*.min.css&#x27;</span></span><br><span class="line"><span class="comment"># 压缩js</span></span><br><span class="line">neat_js:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">  mangle: <span class="literal">true</span></span><br><span class="line">  output:</span><br><span class="line">  compress:</span><br><span class="line">  exclude:</span><br><span class="line">    - <span class="string">&#x27;**/*.min.js&#x27;</span></span><br><span class="line">    - <span class="string">&#x27;**/jquery.fancybox.pack.js&#x27;</span></span><br><span class="line">    - <span class="string">&#x27;**/index.js&#x27;</span>  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3、hexo-neat插件注意事项<br>在使用hexo-neat插件时，可以在命令窗口中看到各个文件的压缩率，于是可以通过跳过一些文件让效率更高。<br>1.跳过压缩文件的正确配置方式<br>如果按照官方插件的文档说明来配置exclude，会发现完全不起作用。这是因为配置的文件路径不对，压缩时找不到你配置的文件，自然也就无法跳过了。于是需要给这些文件指定正确的路径，万能的配置方式如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">neat_css:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">  exclude:</span><br><span class="line">    - <span class="string">&#x27;**/*.min.css&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2.压缩html时不要跳过.md文件和.swig文件<br>.md文件就是markdown文件，如果跳过压缩.md文件，而又刚好在文章中使用到了tab标签，那么当hexo在生成静态页面时就会发生解析错误。这会导致使用到了tab标签的页面生成失败而无法访问。</p><p>.swig文件是模板引擎文件，也就是hexo可以通过这些文件来生成对应的页面。如果跳过这些文件，所有页面完全没有起到压缩的效果，页面源代码里依然存在着一大堆空白。</p><h2 id="hexo-offline-popup插件（加速你博客的访问速度"><a href="#hexo-offline-popup插件（加速你博客的访问速度" class="headerlink" title="hexo-offline-popup插件（加速你博客的访问速度"></a>hexo-offline-popup插件（加速你博客的访问速度</h2><p>为了您的最佳浏览体验，建议打开原网址浏览哦<br>本文链接：<a href="https://colsrch.cn/posts/32c8ba21/">https://colsrch.cn/posts/32c8ba21/</a><br>hexo-offline-popup<br>hexo-offline-popup 是一个 hexo 插件， 它可加速你的Hexo网站的加载速度，以及网站内容更新弹窗提示。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>在Hexo根目录打开<code>Git-bash</code> ，执行命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i hexo-offline-popup --save</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>在博客根目录的<code>_config.yml</code>中添加如下配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># offline config passed to sw-precache.</span></span><br><span class="line">service_worker:</span><br><span class="line">  maximumFileSizeToCacheInBytes: 5242880</span><br><span class="line">  staticFileGlobs:</span><br><span class="line">  - public/**/*.&#123;js,html,css,png,jpg,gif,svg,eot,ttf,woff,woff2&#125;</span><br><span class="line">  stripPrefix: public</span><br><span class="line">  verbose: <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果你有CDN资源，例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- https://unpkg.com/artitalk</span><br><span class="line">- https://cdn.jsdelivr.net/npm/artitalk</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将此配置添加到根目录的<code>_config.yml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">service_worker:</span><br><span class="line">  runtimeCaching:</span><br><span class="line">    - urlPattern: /*</span><br><span class="line">      handler: cacheFirst</span><br><span class="line">      options:</span><br><span class="line">        origin: unpkg.com</span><br><span class="line">    - urlPattern: /*</span><br><span class="line">      handler: cacheFirst</span><br><span class="line">      options:</span><br><span class="line">        origin: cdn.jsdelivr.net</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="上传"><a href="#上传" class="headerlink" title="上传"></a>上传</h3><p>执行该代码激活并使用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo cl &amp;&amp; hexo g -d</span><br></pre></td></tr></table></figure><p>演示<br>由于该弹窗仅在博客更新时会弹出，因此留了一个弹窗演示站</p><p>弹窗演示站：<a href="https://pfc049.coding-pages.com/">https://pfc049.coding-pages.com/</a></p><p>FAQ<br>安装后未弹窗<br>该插件仅部署后生效，本地运行不生效<br>安装该插件后第一次打开网站不弹窗，后续更新将会弹窗<br>插件地址：hexo-offline-popup<br>版权声明：本网站所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明来自 Colsrch’Blog</p><p>原文链接1：<a href="https://blog.csdn.net/qq_43625917/article/details/104136304">https://blog.csdn.net/qq_43625917/article/details/104136304</a></p><p>原文链接2：<a href="https://blog.csdn.net/qq_42830477/article/details/107296226">https://blog.csdn.net/qq_42830477/article/details/107296226</a></p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>新年快乐！</title>
      <link href="/2025/01/23/%E6%96%B0%E5%B9%B4%E5%BF%AB%E4%B9%90%EF%BC%81/"/>
      <url>/2025/01/23/%E6%96%B0%E5%B9%B4%E5%BF%AB%E4%B9%90%EF%BC%81/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="新年快乐！"><a href="#新年快乐！" class="headerlink" title="新年快乐！"></a>新年快乐！</h1><p><img src="https://f005.backblazeb2.com/file/ZzNnWn-Images/ZzNnWn-Images/8ef4486c-c914-4932-ab06-5c073a639b79.webp"></p>]]></content>
      
      
      <categories>
          
          <category> default </category>
          
      </categories>
      
      
        <tags>
            
            <tag> default </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>魔改笔记三：文章三栏（店长+微调）</title>
      <link href="/2025/01/22/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%9A%E6%96%87%E7%AB%A0%E4%B8%89%E6%A0%8F%EF%BC%88%E5%BA%97%E9%95%BF+%E5%BE%AE%E8%B0%83%EF%BC%89/"/>
      <url>/2025/01/22/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%9A%E6%96%87%E7%AB%A0%E4%B8%89%E6%A0%8F%EF%BC%88%E5%BA%97%E9%95%BF+%E5%BE%AE%E8%B0%83%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="魔改笔记三：文章三栏（店长-微调）"><a href="#魔改笔记三：文章三栏（店长-微调）" class="headerlink" title="魔改笔记三：文章三栏（店长+微调）"></a>魔改笔记三：文章三栏（店长+微调）</h1><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><p>本网站采用的是三栏+响应式布局的方案，也就是slidecard的方案，但是为了可拓展性，我还是把两种都搬了过来，方便大家阅读！</p><p>1、修改<code>[BlogRoot]\themes\butterfly\layout\includes\mixins\post-ui.pug</code>,整个替换为下面的代码，注意，我这里用的是彩色的图标，每个<code>//- i.fas</code>那里表示我注释了黑白的额图标并换上彩色图标，彩色图标引入的具体方法见之前的教程，这里只需要替换成你自己的<code>图标名字</code>和调节相应的<code>大小</code>即可：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">mixin postUI(posts)</span><br><span class="line">  each article , index in page.posts.data</span><br><span class="line">    .recent-post-item</span><br><span class="line">      -</span><br><span class="line">        let link = article.link || article.path</span><br><span class="line">        let title = article.title || _p(&#x27;no_title&#x27;)</span><br><span class="line">        const position = theme.cover.position</span><br><span class="line">        let leftOrRight = position === &#x27;both&#x27;</span><br><span class="line">          ? index%2 == 0 ? &#x27;left&#x27; : &#x27;right&#x27;</span><br><span class="line">          : position === &#x27;left&#x27; ? &#x27;left&#x27; : &#x27;right&#x27;</span><br><span class="line">        let post_cover = article.cover</span><br><span class="line">        let no_cover = article.cover === false || !theme.cover.index_enable ? &#x27;no-cover&#x27; : &#x27;&#x27;</span><br><span class="line">      -</span><br><span class="line">      .recent-post-content(class=leftOrRight)</span><br><span class="line">        .recent-post-cover</span><br><span class="line">          img.article-cover(src=url_for(post_cover) onerror=`this.onerror=null;this.src=&#x27;`+ url_for(theme.error_img.post_page) + `&#x27;` alt=title)</span><br><span class="line">        .recent-post-info</span><br><span class="line">          a.article-title(href=url_for(link) title=title)</span><br><span class="line">            .article-title-link= title</span><br><span class="line">          .recent-post-meta            </span><br><span class="line">            .article-meta-wrap</span><br><span class="line">              if (is_home() &amp;&amp; (article.top || article.sticky &gt; 0))</span><br><span class="line">                span.article-meta</span><br><span class="line">                  //- i.fas.fa-thumbtack.sticky</span><br><span class="line">                  svg.meta_icon(style=&quot;width:16px;height:16px;position:relative;top:3px&quot;).post-ui-icon</span><br><span class="line">                    use(xlink:href=&#x27;#icon-tuding&#x27;)</span><br><span class="line">                  span.sticky= _p(&#x27;sticky&#x27;)</span><br><span class="line">                  span.article-meta-separator  | </span><br><span class="line">              if (theme.post_meta.page.date_type)</span><br><span class="line">                span.post-meta-date</span><br><span class="line">                  if (theme.post_meta.page.date_type === &#x27;both&#x27;)</span><br><span class="line">                    //- i.far.fa-calendar-alt</span><br><span class="line">                    svg.meta_icon(style=&quot;width:21px;height:21px;position:relative;top:6px&quot;).post-ui-icon</span><br><span class="line">                      use(xlink:href=&#x27;#icon-rili&#x27;)</span><br><span class="line">                    span.article-meta-label=_p(&#x27;post.created&#x27;)</span><br><span class="line">                    time.post-meta-date-created(datetime=date_xml(article.date) title=_p(&#x27;post.created&#x27;) + &#x27; &#x27; + full_date(article.date))=date(article.date, config.date_format)</span><br><span class="line">                    span.article-meta-separator  | </span><br><span class="line">                    //- i.fas.fa-history</span><br><span class="line">                    svg.meta_icon(style=&quot;width:13px;height:13px;position:relative;top:2px&quot;).post-ui-icon</span><br><span class="line">                      use(xlink:href=&#x27;#icon-gengxin1&#x27;)                </span><br><span class="line">                    span.article-meta-label=_p(&#x27;post.updated&#x27;) + &quot; &quot;</span><br><span class="line">                    time.post-meta-date-updated(datetime=date_xml(article.updated) title=_p(&#x27;post.updated&#x27;) + &#x27; &#x27; + full_date(article.updated))=date(article.updated, config.date_format)</span><br><span class="line">                  else</span><br><span class="line">                    - let data_type_updated = theme.post_meta.page.date_type === &#x27;updated&#x27;</span><br><span class="line">                    - let date_type = data_type_updated ? &#x27;updated&#x27; : &#x27;date&#x27;</span><br><span class="line">                    - let date_icon = data_type_updated ? &#x27;fas fa-history&#x27; :&#x27;far fa-calendar-alt&#x27;</span><br><span class="line">                    - let date_title = data_type_updated ? _p(&#x27;post.updated&#x27;) : _p(&#x27;post.created&#x27;)</span><br><span class="line">                    i(class=date_icon)</span><br><span class="line">                    span.article-meta-label=date_title</span><br><span class="line">                    time(datetime=date_xml(article[date_type]) title=date_title + &#x27; &#x27; + full_date(article[date_type]))=date(article[date_type], config.date_format)</span><br><span class="line">              if (theme.post_meta.page.categories &amp;&amp; article.categories.data.length &gt; 0)</span><br><span class="line">                span.article-meta</span><br><span class="line">                  span.article-meta-separator  | </span><br><span class="line">                  //- i.fas.fa-inbox</span><br><span class="line">                  svg.meta_icon(style=&quot;width:12px;height:12px;position:relative;top:1px&quot;).post-ui-icon</span><br><span class="line">                    use(xlink:href=&#x27;#icon-fenlei&#x27;)</span><br><span class="line">                  each item, index in article.categories.data</span><br><span class="line">                    a(href=url_for(item.path)).article-meta__categories #[=item.name]</span><br><span class="line">                    if (index &lt; article.categories.data.length - 1)</span><br><span class="line">                      i.fas.fa-angle-right.article-meta-link</span><br><span class="line">              if (theme.post_meta.page.tags &amp;&amp; article.tags.data.length &gt; 0)</span><br><span class="line">                span.article-meta.tags</span><br><span class="line">                  span.article-meta-separator  | </span><br><span class="line">                  //- i.fas.fa-tag</span><br><span class="line">                  svg.meta_icon(style=&quot;width:13px;height:13px;position:relative;top:2px&quot;).post-ui-icon</span><br><span class="line">                    use(xlink:href=&#x27;#icon-biaoqian&#x27;)</span><br><span class="line">                  each item, index in article.tags.data</span><br><span class="line">                    a(href=url_for(item.path)).article-meta__tags #[=item.name]</span><br><span class="line">                    if (index &lt; article.tags.data.length - 1)</span><br><span class="line">                      span.article-meta-link #[=&#x27; • &#x27;]</span><br><span class="line">          </span><br><span class="line">              mixin countBlockInIndex</span><br><span class="line">                - needLoadCountJs = true</span><br><span class="line">                span.article-meta</span><br><span class="line">                  span.article-meta-separator  | </span><br><span class="line">                  //- i.fas.fa-comments</span><br><span class="line">                  svg.meta_icon(style=&quot;width:13px;height:13px;position:relative;top:2px&quot;).post-ui-icon</span><br><span class="line">                    use(xlink:href=&#x27;#icon-pinglun1&#x27;)</span><br><span class="line">                  if block</span><br><span class="line">                    block</span><br><span class="line">                  span.article-meta-label= &#x27; &#x27; + _p(&#x27;card_post_count&#x27;)</span><br><span class="line">          </span><br><span class="line">              if theme.comments.card_post_count</span><br><span class="line">                case theme.comments.use[0]</span><br><span class="line">                  when &#x27;Disqus&#x27;</span><br><span class="line">                    +countBlockInIndex</span><br><span class="line">                      a(href=full_url_for(link) + &#x27;#disqus_thread&#x27;)</span><br><span class="line">                        i.fa-solid.fa-spinner.fa-spin</span><br><span class="line">                  when &#x27;Disqusjs&#x27;</span><br><span class="line">                    +countBlockInIndex</span><br><span class="line">                      a(href=full_url_for(link) + &#x27;#disqusjs&#x27;)</span><br><span class="line">                        span.disqus-comment-count(data-disqus-url=full_url_for(link))</span><br><span class="line">                          i.fa-solid.fa-spinner.fa-spin</span><br><span class="line">                  when &#x27;Valine&#x27;</span><br><span class="line">                    +countBlockInIndex</span><br><span class="line">                      a(href=url_for(link) + &#x27;#post-comment&#x27;)</span><br><span class="line">                        span.valine-comment-count(data-xid=url_for(link))</span><br><span class="line">                          i.fa-solid.fa-spinner.fa-spin</span><br><span class="line">                  when &#x27;Waline&#x27;</span><br><span class="line">                    +countBlockInIndex</span><br><span class="line">                      a(href=url_for(link) + &#x27;#post-comment&#x27;)</span><br><span class="line">                        span.waline-comment-count(id=url_for(link))</span><br><span class="line">                          i.fa-solid.fa-spinner.fa-spin</span><br><span class="line">                  when &#x27;Twikoo&#x27;</span><br><span class="line">                    +countBlockInIndex</span><br><span class="line">                      a.twikoo-count(href=url_for(link) + &#x27;#post-comment&#x27;)</span><br><span class="line">                        i.fa-solid.fa-spinner.fa-spin</span><br><span class="line">                  when &#x27;Facebook Comments&#x27;</span><br><span class="line">                    +countBlockInIndex</span><br><span class="line">                      a(href=url_for(link) + &#x27;#post-comment&#x27;)</span><br><span class="line">                        span.fb-comments-count(data-href=urlNoIndex(article.permalink))</span><br><span class="line">                  when &#x27;Remark42&#x27;</span><br><span class="line">                    +countBlockInIndex</span><br><span class="line">                      a(href=url_for(link) + &#x27;#post-comment&#x27;)</span><br><span class="line">                        span.remark42__counter(data-url=urlNoIndex(article.permalink))</span><br><span class="line">                          i.fa-solid.fa-spinner.fa-spin</span><br><span class="line">                  when &#x27;Artalk&#x27;</span><br><span class="line">                    +countBlockInIndex</span><br><span class="line">                      a(href=url_for(link) + &#x27;#post-comment&#x27;)</span><br><span class="line">                        span.artalk-count(data-page-key=url_for(link))</span><br><span class="line">                          i.fa-solid.fa-spinner.fa-spin  </span><br><span class="line">        a.article-content(href=url_for(link) title=title)</span><br><span class="line">          //- Display the article introduction on homepage</span><br><span class="line">          case theme.index_post_content.method</span><br><span class="line">            when false</span><br><span class="line">              - break</span><br><span class="line">            when 1</span><br><span class="line">              .article-content-text!= article.description</span><br><span class="line">            when 2</span><br><span class="line">              if article.description</span><br><span class="line">                .article-content-text!= article.description</span><br><span class="line">              else</span><br><span class="line">                - const content = strip_html(article.content)</span><br><span class="line">                - let expert = content.substring(0, theme.index_post_content.length) </span><br><span class="line">                - content.length &gt; theme.index_post_content.length ? expert += &#x27; ...&#x27; : &#x27;&#x27;</span><br><span class="line">                .article-content-text!= expert</span><br><span class="line">            default</span><br><span class="line">              - const content = strip_html(article.content)</span><br><span class="line">              - let expert = content.substring(0, theme.index_post_content.length) </span><br><span class="line">              - content.length &gt; theme.index_post_content.length ? expert += &#x27; ...&#x27; : &#x27;&#x27;</span><br><span class="line">              .article-content-text!= expert  </span><br><span class="line">        .recent-post-arrow</span><br><span class="line"></span><br><span class="line">    if theme.ad &amp;&amp; theme.ad.index</span><br><span class="line">      if (index + 1) % 3 == 0</span><br><span class="line">        .recent-post-item.ads-wrap!=theme.ad.index</span><br></pre></td></tr></table></figure><p>2、样式方案提供两种：</p><ul><li>样式一：电脑端宽屏采用滑动卡片，平板宽度采用双栏布局，手机宽度采用单栏卡片</li><li>样式二：移除滑动卡片，按屏幕宽度依次应用三栏、双栏、单栏</li></ul><p>新建目录<code>[BlogRoot]\themes\butterfly\source\css\_index_card_style\</code>,并在下面新建对应的文件<code>slidecard.styl</code>和<code>multicard.styl</code>并分别填入以下内容，第一个滑动卡片的是店长原版的，我微调一下第二个的样式，大家可以根据自己的选择进行修改：</p><div class="tabs" id="test4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test4-1">样式1：slidecard</button></li><li class="tab"><button type="button" data-href="#test4-2">样式2：multicard</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test4-1"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line">//default color:</span><br><span class="line">:root</span><br><span class="line">  --recent-post-bgcolor: rgba(255, 255, 255, 0.9)  //默认背景</span><br><span class="line">  --article-content-bgcolor: <span class="comment">#49b1f5 //描述版块背景</span></span><br><span class="line">  --recent-post-arrow: <span class="comment">#ffffff //箭头配色</span></span><br><span class="line">  --recent-post-cover-shadow: <span class="comment">#ffffff //封面遮罩层配色，建议和默认值的颜色相对应。</span></span><br><span class="line">  --recent-post-transition: all 0.5s cubic-bezier(0.59, 0.01, 0.48, 1.17)  //动画效果。不了解的不要改动</span><br><span class="line">[data-theme=<span class="string">&quot;dark&quot;</span>]</span><br><span class="line">  --recent-post-bgcolor: rgba(35,35,35,0.5)</span><br><span class="line">  --article-content-bgcolor: <span class="comment">#99999a</span></span><br><span class="line">  --recent-post-arrow: <span class="comment">#37e2dd</span></span><br><span class="line">  --recent-post-cover-shadow: <span class="comment">#232323</span></span><br><span class="line">// 默认的首页卡片容器布局</span><br><span class="line">.recent-posts</span><br><span class="line">  padding 0 15px 0 15px</span><br><span class="line">  height fit-content</span><br><span class="line">  .recent-post-item</span><br><span class="line">    margin-bottom 15px</span><br><span class="line">    width 100%</span><br><span class="line">    background var(--recent-post-bgcolor)</span><br><span class="line">    overflow hidden</span><br><span class="line">    border-radius 15px</span><br><span class="line">    .recent-post-content</span><br><span class="line">      display flex</span><br><span class="line">      background var(--recent-post-bgcolor)</span><br><span class="line">      position relative</span><br><span class="line">      .recent-post-cover</span><br><span class="line">        display flex</span><br><span class="line">        background transparent</span><br><span class="line">      .recent-post-info</span><br><span class="line">        display flex</span><br><span class="line">        background transparent</span><br><span class="line">        flex-direction column</span><br><span class="line">        justify-content center</span><br><span class="line">        align-items center</span><br><span class="line">        .article-title</span><br><span class="line">          height 50%</span><br><span class="line">          display: flex</span><br><span class="line">          text-align: center</span><br><span class="line">          align-items: center</span><br><span class="line">          justify-content: flex-end</span><br><span class="line">          flex-direction: column</span><br><span class="line">          .article-title-link</span><br><span class="line">            color: var(--text-highlight-color)</span><br><span class="line">            transition: all .2s ease-in-out</span><br><span class="line">            display: -webkit-box;</span><br><span class="line">            -webkit-box-orient: vertical;</span><br><span class="line">            overflow: hidden;</span><br><span class="line">            &amp;:hover</span><br><span class="line">              color: <span class="variable">$text</span>-hover</span><br><span class="line">        .recent-post-meta</span><br><span class="line">          height 50%</span><br><span class="line">          display: flex</span><br><span class="line">          text-align: center</span><br><span class="line">          align-items: center</span><br><span class="line">          justify-content: flex-start</span><br><span class="line">          flex-direction: column</span><br><span class="line">          .article-meta-wrap</span><br><span class="line">            color <span class="comment">#969797</span></span><br><span class="line">            display: -webkit-box;</span><br><span class="line">            -webkit-box-orient: vertical;</span><br><span class="line">            overflow: hidden;</span><br><span class="line">            a</span><br><span class="line">              color: var(--text-highlight-color)</span><br><span class="line">              transition: all .2s ease-in-out</span><br><span class="line">              color <span class="comment">#969797</span></span><br><span class="line">              &amp;:hover</span><br><span class="line">                color: <span class="variable">$text</span>-hover</span><br><span class="line">      .article-content</span><br><span class="line">        display flex</span><br><span class="line">        text-align: center</span><br><span class="line">        flex-direction row</span><br><span class="line">        align-items center</span><br><span class="line">        justify-content center</span><br><span class="line">        .article-content-text</span><br><span class="line">          display -webkit-box</span><br><span class="line">          -webkit-box-orient vertical</span><br><span class="line">          text-overflow: ellipsis</span><br><span class="line">          overflow hidden</span><br><span class="line">          color <span class="comment">#fff</span></span><br><span class="line">          text-shadow 1px 2px 3px <span class="comment">#000</span></span><br><span class="line">          &amp;::before</span><br><span class="line">            content <span class="string">&quot;❝&quot;</span></span><br><span class="line">            font-size 20px</span><br><span class="line">          &amp;::after</span><br><span class="line">            content <span class="string">&quot;❞&quot;</span></span><br><span class="line">            font-size 20px</span><br><span class="line">    &amp;.ads-wrap</span><br><span class="line">      display: block !important</span><br><span class="line">      height: auto !important</span><br><span class="line">// PC端滑动卡片样式</span><br><span class="line">@media screen and (min-width:1069px)</span><br><span class="line">  .recent-posts</span><br><span class="line">    padding 0 15px 0 15px</span><br><span class="line">    .recent-post-item</span><br><span class="line">      .recent-post-content</span><br><span class="line">        position relative</span><br><span class="line">        height 200px</span><br><span class="line">        width 100%</span><br><span class="line">        transition var(--recent-post-transition)</span><br><span class="line">        &amp;:hover</span><br><span class="line">          .recent-post-cover-shadow</span><br><span class="line">            width 10.1%</span><br><span class="line">            transition var(--recent-post-transition)</span><br><span class="line">          .recent-post-cover</span><br><span class="line">            width 10%</span><br><span class="line">            transition var(--recent-post-transition)</span><br><span class="line">          .article-content</span><br><span class="line">            width calc(30% + 80px)</span><br><span class="line">            transition var(--recent-post-transition)</span><br><span class="line">            .article-content-text</span><br><span class="line">              opacity 1</span><br><span class="line">          .recent-post-arrow</span><br><span class="line">            transition var(--recent-post-transition)</span><br><span class="line">        .recent-post-cover-shadow</span><br><span class="line">          z-index: 1</span><br><span class="line">          transition var(--recent-post-transition)</span><br><span class="line">          position: absolute</span><br><span class="line">          height 200px</span><br><span class="line">          width 40%</span><br><span class="line">        .recent-post-cover</span><br><span class="line">          height 200px</span><br><span class="line">          width 40%</span><br><span class="line">          transition var(--recent-post-transition)</span><br><span class="line">          img</span><br><span class="line">            height 100%</span><br><span class="line">            width 100%</span><br><span class="line">            object-fit cover</span><br><span class="line"></span><br><span class="line">        .recent-post-info</span><br><span class="line">          height 200px</span><br><span class="line">          width calc(60% - 80px)</span><br><span class="line">          .article-title</span><br><span class="line">            margin: 0px 40px</span><br><span class="line">            font-size 24px</span><br><span class="line">            .article-title-link</span><br><span class="line">              -webkit-line-clamp: 2;</span><br><span class="line">          .recent-post-meta</span><br><span class="line">            margin: 0px 20px</span><br><span class="line">            .article-meta-wrap</span><br><span class="line">              font-size 12px</span><br><span class="line">              -webkit-line-clamp: 3;</span><br><span class="line">        .article-content</span><br><span class="line">          height 200px</span><br><span class="line">          width 90px</span><br><span class="line">          background var(--article-content-bgcolor)</span><br><span class="line">          transition var(--recent-post-transition)</span><br><span class="line">          .article-content-text</span><br><span class="line">            -webkit-line-clamp 4</span><br><span class="line">            transition: var(--recent-post-transition)</span><br><span class="line">            opacity 0</span><br><span class="line">        .recent-post-arrow</span><br><span class="line">          transition var(--recent-post-transition)</span><br><span class="line">          display block</span><br><span class="line">          position absolute</span><br><span class="line">          height 20px</span><br><span class="line">          width 8px</span><br><span class="line">          background var(--recent-post-arrow)</span><br><span class="line">        &amp;.both,</span><br><span class="line">        &amp;.right</span><br><span class="line">          .recent-post-cover-shadow</span><br><span class="line">            left 0</span><br><span class="line">            background linear-gradient(to left, var(--recent-post-cover-shadow), transparent)</span><br><span class="line">          .recent-post-cover</span><br><span class="line">            order: 1</span><br><span class="line">          .recent-post-info</span><br><span class="line">            order: 2</span><br><span class="line">          .article-content</span><br><span class="line">            order: 3</span><br><span class="line">            clip-path polygon(0 50%, 80px 0, 100% 0, 100% 100%, 80px 100%)</span><br><span class="line">            .article-content-text</span><br><span class="line">              margin 20px 40px 20px 80px</span><br><span class="line">          .recent-post-arrow</span><br><span class="line">            order: 4</span><br><span class="line">            left calc(100% - 80px)</span><br><span class="line">            top calc(50% - 10px)</span><br><span class="line">            clip-path polygon(0 10px, 8px 0, 8px 20px)</span><br><span class="line">          &amp;:hover</span><br><span class="line">            .recent-post-arrow</span><br><span class="line">              left calc(100% - 40px)</span><br><span class="line">        &amp;.left</span><br><span class="line">          .recent-post-cover-shadow</span><br><span class="line">            right 0</span><br><span class="line">            background linear-gradient(to right, var(--recent-post-cover-shadow), transparent)</span><br><span class="line">          .recent-post-cover</span><br><span class="line">            order: 4</span><br><span class="line">          .recent-post-info</span><br><span class="line">            order: 3</span><br><span class="line">          .article-content</span><br><span class="line">            order: 2</span><br><span class="line">            clip-path polygon(100% 50%,calc(100% - 80px) 100%,0 100%,0 0,calc(100% - 80px) 0)</span><br><span class="line">            .article-content-text</span><br><span class="line">              margin 20px 80px 20px 40px</span><br><span class="line">          .recent-post-arrow</span><br><span class="line">            order: 1</span><br><span class="line">            left 72px</span><br><span class="line">            top calc(50% - 10px)</span><br><span class="line">            clip-path polygon(0 0, 8px 10px, 0 20px)</span><br><span class="line">          &amp;:hover</span><br><span class="line">            .recent-post-arrow</span><br><span class="line">              left 32px</span><br><span class="line">// 双栏布局卡片自适应适配</span><br><span class="line">@media screen and (min-width:572px) and (max-width:1068px)</span><br><span class="line">  .recent-posts</span><br><span class="line">    padding 0 15px 0 15px</span><br><span class="line">    display flex</span><br><span class="line">    flex-direction row</span><br><span class="line">    flex-wrap wrap</span><br><span class="line">    .recent-post-item</span><br><span class="line">      border-radius 15px</span><br><span class="line">      overflow hidden</span><br><span class="line">      width 47%</span><br><span class="line">      margin 0px 3% 20px 0px</span><br><span class="line">    nav<span class="comment">#pagination</span></span><br><span class="line">      width: 100%</span><br><span class="line">// 手机端单栏布局自适应适配</span><br><span class="line">@media screen and (max-width:572px)</span><br><span class="line">  .recent-posts</span><br><span class="line">    padding 0 15px 0 15px</span><br><span class="line">    .recent-post-item</span><br><span class="line">      border-radius 15px</span><br><span class="line">      overflow hidden</span><br><span class="line">    </span><br><span class="line">// 手机端及双栏卡片样式</span><br><span class="line">@media screen and (max-width:1068px)</span><br><span class="line">  .recent-posts</span><br><span class="line">    .recent-post-item</span><br><span class="line">      .recent-post-content</span><br><span class="line">        flex-direction column</span><br><span class="line">        flex-wrap nowrap</span><br><span class="line">        align-items center</span><br><span class="line">        max-height 350px</span><br><span class="line">        height: auto </span><br><span class="line">        width 100%</span><br><span class="line">        .recent-post-cover</span><br><span class="line">          width 100%</span><br><span class="line">          height 200px</span><br><span class="line">          clip-path polygon(0 130px,0 0,100% 0,100% 130px,50% 100%)</span><br><span class="line">          img</span><br><span class="line">            height 200px</span><br><span class="line">            width 100%</span><br><span class="line">            object-fit cover</span><br><span class="line">        .recent-post-info</span><br><span class="line">          height 150px</span><br><span class="line">          width 100%</span><br><span class="line">          padding 0px 25px 5px 25px</span><br><span class="line">          .article-title</span><br><span class="line">            margin: 0px 40px</span><br><span class="line">            font-size 18px</span><br><span class="line">            .article-title-link</span><br><span class="line">              -webkit-line-clamp: 2;</span><br><span class="line">          .recent-post-meta</span><br><span class="line">            margin: 0px 20px</span><br><span class="line">            .article-meta-wrap</span><br><span class="line">              font-size 12px</span><br><span class="line">              -webkit-line-clamp: 3;</span><br><span class="line">        .article-content</span><br><span class="line">          position absolute</span><br><span class="line">          height 200px</span><br><span class="line">          width 100%</span><br><span class="line">          background rgba(25,25,25,0.5)</span><br><span class="line">          clip-path polygon(0 130px,0 0,100% 0,100% 130px,50% 100%)</span><br><span class="line">          .article-content-text</span><br><span class="line">            -webkit-line-clamp 3</span><br><span class="line">            font-size 16px</span><br><span class="line">            margin 0px 25px 30px 25px</span><br><span class="line">        .recent-post-arrow</span><br><span class="line">          display block</span><br><span class="line">          background var(--article-content-bgcolor)</span><br><span class="line">          position absolute</span><br><span class="line">          height 10px</span><br><span class="line">          width 20px</span><br><span class="line">          clip-path polygon(0 0,100% 0,50% 100%)</span><br><span class="line">          top 20px</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test4-2"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">:root</span><br><span class="line">  --theme-color:rgb(57, 197, 187)</span><br><span class="line">  --text-bg-hover:rgba(57, 197, 187, 0.7)</span><br><span class="line">  </span><br><span class="line">.recent-posts</span><br><span class="line">  padding 0 5px 0 5px</span><br><span class="line">  height fit-content</span><br><span class="line">  .recent-post-item</span><br><span class="line">    margin-bottom 15px</span><br><span class="line">    overflow hidden</span><br><span class="line">    border-radius 15px</span><br><span class="line">    .recent-post-content</span><br><span class="line">      display flex</span><br><span class="line">      position relative</span><br><span class="line">      .recent-post-cover</span><br><span class="line">        display flex</span><br><span class="line">        background transparent</span><br><span class="line">      .recent-post-info</span><br><span class="line">        display flex</span><br><span class="line">        background transparent</span><br><span class="line">        flex-direction column</span><br><span class="line">        justify-content center</span><br><span class="line">        align-items center</span><br><span class="line">        .article-title</span><br><span class="line">          height 50%</span><br><span class="line">          display: flex</span><br><span class="line">          text-align: center</span><br><span class="line">          align-items: center</span><br><span class="line">          justify-content: flex-end</span><br><span class="line">          flex-direction: column</span><br><span class="line">          .article-title-link</span><br><span class="line">            color: var(--text-highlight-color)</span><br><span class="line">            transition: all .2s ease-in-out</span><br><span class="line">            display: -webkit-box;</span><br><span class="line">            -webkit-box-orient: vertical;</span><br><span class="line">            overflow: hidden;</span><br><span class="line">            &amp;:hover</span><br><span class="line">              color: var(--theme-color)</span><br><span class="line">        .recent-post-meta</span><br><span class="line">          height 50%</span><br><span class="line">          display: flex</span><br><span class="line">          text-align: center</span><br><span class="line">          align-items: center</span><br><span class="line">          justify-content: flex-start</span><br><span class="line">          flex-direction: column</span><br><span class="line">          .article-meta-wrap</span><br><span class="line">            color <span class="comment">#969797</span></span><br><span class="line">            display: -webkit-box;</span><br><span class="line">            -webkit-box-orient: vertical;</span><br><span class="line">            overflow: hidden;</span><br><span class="line">            a</span><br><span class="line">              color: var(--text-highlight-color)</span><br><span class="line">              transition: all .2s ease-in-out</span><br><span class="line">              color <span class="comment">#969797</span></span><br><span class="line">              &amp;:hover</span><br><span class="line">                color: var(--theme-color)</span><br><span class="line">      .article-content</span><br><span class="line">        display flex</span><br><span class="line">        text-align: center</span><br><span class="line">        flex-direction row</span><br><span class="line">        align-items center</span><br><span class="line">        justify-content center</span><br><span class="line">        .article-content-text</span><br><span class="line">          display -webkit-box</span><br><span class="line">          -webkit-box-orient vertical</span><br><span class="line">          text-overflow: ellipsis</span><br><span class="line">          overflow hidden</span><br><span class="line">          color <span class="comment">#fff</span></span><br><span class="line">          text-shadow 1px 2px 3px <span class="comment">#000</span></span><br><span class="line">          transition transform 0.6s;</span><br><span class="line">          &amp;:hover</span><br><span class="line">            transform: scale(1.1);</span><br><span class="line">    &amp;.ads-wrap</span><br><span class="line">      display: block !important</span><br><span class="line">      height: auto !important</span><br><span class="line">  nav<span class="comment">#pagination</span></span><br><span class="line">    width: 100%</span><br><span class="line">// 卡片单元布局样式</span><br><span class="line">.recent-posts</span><br><span class="line">  padding 0 5px 0 5px</span><br><span class="line">  display flex</span><br><span class="line">  flex-direction row</span><br><span class="line">  flex-wrap wrap</span><br><span class="line">  .recent-post-item</span><br><span class="line">    border-radius 15px</span><br><span class="line">    overflow hidden</span><br><span class="line">    .recent-post-content</span><br><span class="line">      flex-direction column</span><br><span class="line">      flex-wrap nowrap</span><br><span class="line">      align-items center</span><br><span class="line">      max-height 350px</span><br><span class="line">      height: auto</span><br><span class="line">      width 100%</span><br><span class="line">      .recent-post-cover</span><br><span class="line">        width 100%</span><br><span class="line">        height 200px</span><br><span class="line">        clip-path polygon(0 130px,0 0,100% 0,100% 130px,50% 100%)</span><br><span class="line">        img</span><br><span class="line">          height 200px</span><br><span class="line">          width 100%</span><br><span class="line">          object-fit cover</span><br><span class="line">      .recent-post-info</span><br><span class="line">        height 145px</span><br><span class="line">        width 100%</span><br><span class="line">        padding 0px 25px 5px 25px</span><br><span class="line">        .article-title</span><br><span class="line">          margin: 0px 40px</span><br><span class="line">          font-size 19px</span><br><span class="line">          .article-title-link</span><br><span class="line">            -webkit-line-clamp: 2;</span><br><span class="line">        .recent-post-meta</span><br><span class="line">          margin: 0px 20px</span><br><span class="line">          .article-meta-wrap</span><br><span class="line">            font-size 13px</span><br><span class="line">            -webkit-line-clamp: 3;</span><br><span class="line">      .article-content</span><br><span class="line">        position absolute</span><br><span class="line">        height 200px</span><br><span class="line">        width 100%</span><br><span class="line">        background rgba(25,25,25,0.4)</span><br><span class="line">        clip-path polygon(0 130px,0 0,100% 0,100% 130px,50% 100%)</span><br><span class="line">        .article-content-text</span><br><span class="line">          -webkit-line-clamp 3</span><br><span class="line">          font-size 16px</span><br><span class="line">          margin 0px 25px 30px 25px</span><br><span class="line">          &amp;::before</span><br><span class="line">            content <span class="string">&quot;「&quot;</span></span><br><span class="line">            font-size 20px</span><br><span class="line">          &amp;::after</span><br><span class="line">            content <span class="string">&quot;」&quot;</span></span><br><span class="line">            font-size 20px</span><br><span class="line">      .recent-post-arrow</span><br><span class="line">        display block</span><br><span class="line">        background var(--text-bg-hover)</span><br><span class="line">        position absolute</span><br><span class="line">        height 10px</span><br><span class="line">        width 20px</span><br><span class="line">        clip-path polygon(0 0,100% 0,50% 100%)</span><br><span class="line">// 三栏布局滑动卡片样式</span><br><span class="line">@media screen and (min-width:1069px)</span><br><span class="line">  .recent-posts</span><br><span class="line">    .recent-post-item</span><br><span class="line">      width 32.3%</span><br><span class="line">      margin 0px 1% 20px 0px</span><br><span class="line">      .recent-post-content</span><br><span class="line">        .recent-post-info</span><br><span class="line">          .article-title</span><br><span class="line">            margin: 0px 5px</span><br><span class="line">            .article-title-link</span><br><span class="line">              -webkit-line-clamp: 1;</span><br><span class="line">          .recent-post-meta</span><br><span class="line">            margin: 0px 5px</span><br><span class="line">            .article-meta-wrap</span><br><span class="line">              -webkit-line-clamp: 2;</span><br><span class="line">// 双栏布局卡片自适应适配</span><br><span class="line">@media screen and (min-width:572px) and (max-width:1068px)</span><br><span class="line">  .recent-posts</span><br><span class="line">    .recent-post-item</span><br><span class="line">      width 47%</span><br><span class="line">      margin 0px 3% 20px 0px</span><br><span class="line">// 单栏布局卡片自适应适配</span><br><span class="line">@media screen and (max-width:572px)</span><br><span class="line">  .recent-posts</span><br><span class="line">    .recent-post-item</span><br><span class="line">      width 100%</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>3、修改<code>[BlogRoot]\themes\butterfly\source\css\_page\homepage.styl</code>,将整文件内容替换为以下代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if hexo-config(&#x27;index_card_style&#x27;) == &#x27;slidecard&#x27;</span><br><span class="line">  @import &#x27;./_index_card_style/slidecard&#x27;</span><br><span class="line">else if hexo-config(&#x27;index_card_style&#x27;) == &#x27;multicard&#x27;</span><br><span class="line">  @import &#x27;./_index_card_style/multicard&#x27;</span><br></pre></td></tr></table></figure><p>4、然后在主题配置文件<code>[BlogRoot]\_config.butterfly.yml</code>里新增配置项，这样我们就可以通过配置项自由切换使用哪款了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 主页卡片样式</span><br><span class="line"># Docs: https://akilar.top/posts/d6b69c49/</span><br><span class="line">index_card_style: multicard # slidecard | multicard</span><br></pre></td></tr></table></figure><p>5、考虑到不管是样式一还是样式二都存在一个布局突变的情况。为了不至于让首页的文章出现空缺，建议将首页生成的文章数量控制为1,2,3的公倍数。修改站点配置文件<code>[BlogRoot]\_config.yml</code>。找到以下配置项进行调整，注意这是站点配置文件本就有的配置项，不是新增配置项。建议是调整为12篇。如果你的侧边栏魔改内容特别多，那么建议改成18、24、30。务必确保文章卡片栏比侧栏完全展开要长，这样展示效果最好</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Home page setting</span><br><span class="line"># path: Root path for your blogs index page. (default = &#x27;&#x27;)</span><br><span class="line"># per_page: Posts displayed per page. (0 = disable pagination)</span><br><span class="line"># order_by: Posts order. (Order by date descending by default)</span><br><span class="line">index_generator:</span><br><span class="line">  path: &#x27;&#x27;</span><br><span class="line">  per_page: 12</span><br><span class="line">  order_by: -date</span><br></pre></td></tr></table></figure><p>6、本教程讨论的卡片都是考虑有封面和有描述的。所以需要保证你已经开启了相应的配置，查看主题配置文件<code>[BlogRoot]\_config.butterfly.yml</code>,找到配置项开启描述栏，建议选择2模式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Display the article introduction on homepage</span><br><span class="line"># 1: description</span><br><span class="line"># 2: both (if the description exists, it will show description, or show the auto_excerpt)</span><br><span class="line"># 3: auto_excerpt (default)</span><br><span class="line"># false: do not show the article introduction</span><br><span class="line">index_post_content:</span><br><span class="line">  method: 2</span><br><span class="line">  length: 500 # if you set method to 2 or 3, the length need to config</span><br></pre></td></tr></table></figure><h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><a href="https://www.fomal.cc/posts/d739261b.html">https://www.fomal.cc/posts/d739261b.html</a></p><p><a href="https://akilar.top/posts/d6b69c49/">https://akilar.top/posts/d6b69c49/</a></p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>魔改笔记二：字体更改</title>
      <link href="/2025/01/22/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E4%BA%8C%EF%BC%9A%E5%AD%97%E4%BD%93%E6%9B%B4%E6%94%B9/"/>
      <url>/2025/01/22/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E4%BA%8C%EF%BC%9A%E5%AD%97%E4%BD%93%E6%9B%B4%E6%94%B9/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="魔改笔记二：字体更改"><a href="#魔改笔记二：字体更改" class="headerlink" title="魔改笔记二：字体更改"></a>魔改笔记二：字体更改</h1><p>字体下载地址：</p><p><a href="https://www.fonts.net.cn/font-38461409078.html">JetBrains Mono字体免费下载和在线预览-字体天下 (fonts.net.cn)</a></p><p><a href="https://developer.huawei.com/consumer/cn/design/resource-V1/">HarmonyOS设计资源下载-鸿蒙Sans字体下载-华为开发者联盟 (huawei.com)</a></p><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><h3 id="创建font文件夹"><a href="#创建font文件夹" class="headerlink" title="创建font文件夹"></a>创建font文件夹</h3><p>在<code>themes/butterfly/source/</code>下创建<code>font</code>文件夹</p><p>将<code>HarmonyOS_Sans_SC_Regular.ttf</code>和<code>JetBrainsMono-Regular.ttf</code>放进<code>font</code></p><h3 id="创建css"><a href="#创建css" class="headerlink" title="创建css"></a>创建css</h3><p>在<code>themes/butterfly/source/css/</code>下创建<code>font.css</code></p><p>编辑<code>font.css</code></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@font-face</span>&#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;JetBrains Mono&#x27;</span>;</span><br><span class="line">    <span class="attribute">font-display</span>: swap;</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">&#x27;../font/JetBrainsMono-Regular.ttf&#x27;</span>) <span class="built_in">format</span>(<span class="string">&quot;truetype&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@font-face</span>&#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;HarmonyOS Sans SC&#x27;</span>;</span><br><span class="line">    <span class="attribute">font-display</span>: swap;</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">&#x27;../font/HarmonyOS_Sans_SC_Regular.ttf&#x27;</span>) <span class="built_in">format</span>(<span class="string">&quot;truetype&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;JetBrains Mono&#x27;</span>,<span class="string">&#x27;HarmonyOS Sans SC&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="编辑-config-butterfly-yml"><a href="#编辑-config-butterfly-yml" class="headerlink" title="编辑_config.butterfly.yml"></a>编辑<code>_config.butterfly.yml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Inject</span></span><br><span class="line"><span class="comment"># Insert the code to head (before &#x27;&lt;/head&gt;&#x27; tag) and the bottom (before &#x27;&lt;/body&gt;&#x27; tag)</span></span><br><span class="line"><span class="comment"># 插入代码到头部 &lt;/head&gt; 之前 和 底部 &lt;/body&gt; 之前</span></span><br><span class="line"><span class="attr">inject:</span></span><br><span class="line">  <span class="attr">head:</span></span><br><span class="line">    <span class="comment"># - &lt;link rel=&quot;stylesheet&quot; href=&quot;/xxx.css&quot;&gt;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;link</span> <span class="string">rel=&quot;stylesheet&quot;</span> <span class="string">href=&quot;/css/font.css&quot;&gt;</span></span><br><span class="line">  <span class="attr">bottom:</span></span><br><span class="line">    <span class="comment"># - &lt;script src=&quot;xxxx&quot;&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>魔改笔记一：首页分类，轮播卡片以及动画添加</title>
      <link href="/2025/01/22/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E4%B8%80%EF%BC%9A%E9%A6%96%E9%A1%B5%E5%88%86%E7%B1%BB%EF%BC%8C%E8%BD%AE%E6%92%AD%E5%8D%A1%E7%89%87%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%B7%BB%E5%8A%A0/"/>
      <url>/2025/01/22/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E4%B8%80%EF%BC%9A%E9%A6%96%E9%A1%B5%E5%88%86%E7%B1%BB%EF%BC%8C%E8%BD%AE%E6%92%AD%E5%8D%A1%E7%89%87%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%B7%BB%E5%8A%A0/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="魔改笔记一：首页分类，轮播卡片以及动画添加"><a href="#魔改笔记一：首页分类，轮播卡片以及动画添加" class="headerlink" title="魔改笔记一：首页分类，轮播卡片以及动画添加"></a>魔改笔记一：首页分类，轮播卡片以及动画添加</h1><h2 id="一-首页动画效果："><a href="#一-首页动画效果：" class="headerlink" title="一.首页动画效果："></a>一.首页动画效果：</h2><p>首先我们需要下载一个插件：在博客的根目录下运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-butterfly-wowjs --save</span><br></pre></td></tr></table></figure><p>在根目录下的 _config.yml 文件中添加配置信息：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># butterfly主页动画</span></span><br><span class="line"><span class="attr">wowjs:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment">#控制动画开关。true是打开，false是关闭</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">10</span> <span class="comment">#过滤器优先级</span></span><br><span class="line">  <span class="attr">mobile:</span> <span class="literal">false</span> <span class="comment">#移动端是否启用，默认移动端禁用</span></span><br><span class="line">  <span class="attr">animateitem:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">class:</span> <span class="string">recent-post-item</span> <span class="comment">#必填项，需要添加动画的元素的class</span></span><br><span class="line">      <span class="attr">style:</span> <span class="string">animate__zoomIn</span> <span class="comment">#必填项，需要添加的动画</span></span><br><span class="line">      <span class="attr">duration:</span> <span class="string">1500ms</span> <span class="comment">#选填项，动画持续时间，单位可以是ms也可以是s。例如3s，700ms。</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="string">0ms</span> <span class="comment">#选填项，动画开始的延迟时间，单位可以是ms也可以是s。例如3s，700ms。</span></span><br><span class="line">      <span class="attr">offset:</span> <span class="number">0</span> <span class="comment">#选填项，开始动画的距离（相对浏览器底部）</span></span><br><span class="line">      <span class="attr">iteration:</span> <span class="number">1</span> <span class="comment">#选填项，动画重复的次数</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">class:</span> <span class="string">card-widget</span></span><br><span class="line">      <span class="attr">style:</span> <span class="string">animate__zoomIn</span></span><br><span class="line">      <span class="attr">duration:</span> <span class="string">1500ms</span> <span class="comment">#选填项，动画持续时间，单位可以是ms也可以是s。例如3s，700ms。</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="string">0ms</span> <span class="comment">#选填项，动画开始的延迟时间，单位可以是ms也可以是s。例如3s，700ms。</span></span><br><span class="line">      <span class="attr">offset:</span> <span class="number">0</span> <span class="comment">#选填项，开始动画的距离（相对浏览器底部）</span></span><br><span class="line">      <span class="attr">iteration:</span> <span class="number">1</span> <span class="comment">#选填项，动画重复的次数</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">class:</span> <span class="string">container</span></span><br><span class="line">      <span class="attr">style:</span> <span class="string">animate__zoomIn</span></span><br><span class="line">      <span class="attr">duration:</span> <span class="string">1500ms</span> <span class="comment">#选填项，动画持续时间，单位可以是ms也可以是s。例如3s，700ms。</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="string">0ms</span> <span class="comment">#选填项，动画开始的延迟时间，单位可以是ms也可以是s。例如3s，700ms。</span></span><br><span class="line">      <span class="attr">offset:</span> <span class="number">0</span> <span class="comment">#选填项，开始动画的距离（相对浏览器底部）</span></span><br><span class="line">      <span class="attr">iteration:</span> <span class="number">1</span> <span class="comment">#选填项，动画重复的次数</span></span><br><span class="line">  <span class="attr">animate_css:</span> <span class="string">https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css</span></span><br><span class="line">  <span class="attr">wow_js:</span> <span class="string">https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js</span></span><br><span class="line">  <span class="attr">wow_init_js:</span> <span class="string">https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js</span></span><br></pre></td></tr></table></figure><h2 id="二-首页轮播图："><a href="#二-首页轮播图：" class="headerlink" title="二. 首页轮播图："></a>二. 首页轮播图：</h2><p>也是一样，首先在根目录安装插件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-butterfly-swiper --save</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在配置文件 _config.yml 文件中配置相关项目：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hexo-butterfly-swiper 首页的轮播</span></span><br><span class="line"><span class="comment"># see https://akilar.top/posts/8e1264d1/</span></span><br><span class="line">swiper:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span> <span class="comment"># 开关</span></span><br><span class="line">  priority: 2 <span class="comment">#过滤器优先权</span></span><br><span class="line">  enable_page: all <span class="comment"># 应用页面</span></span><br><span class="line">  timemode: <span class="built_in">date</span> <span class="comment">#date/updated</span></span><br><span class="line">  layout: <span class="comment"># 挂载容器类型</span></span><br><span class="line">    <span class="built_in">type</span>: class</span><br><span class="line">    name: recent-posts</span><br><span class="line">    index: 0</span><br><span class="line">  default_descr: 再怎么看我也不知道怎么描述它的啦！快点进来瞧瞧！</span><br><span class="line">  swiper_css: https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css <span class="comment">#swiper css依赖</span></span><br><span class="line">  swiper_js: https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js <span class="comment">#swiper js依赖</span></span><br><span class="line">  custom_css: https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css <span class="comment"># 适配主题样式补丁</span></span><br><span class="line">  custom_js: https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js <span class="comment"># swiper初始化方法</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>或（本文使用下方方式）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hexo-butterfly-swiper</span></span><br><span class="line"><span class="comment"># see https://akilar.top/posts/8e1264d1/</span></span><br><span class="line"><span class="attr">swiper:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment"># 开关</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">5</span> <span class="comment">#过滤器优先权</span></span><br><span class="line">  <span class="attr">enable_page:</span> <span class="string">all</span> <span class="comment"># 应用页面</span></span><br><span class="line">  <span class="attr">timemode:</span> <span class="string">date</span> <span class="comment">#date/updated</span></span><br><span class="line">  <span class="attr">layout:</span> <span class="comment"># 挂载容器类型</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">id</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">recent-posts</span></span><br><span class="line">    <span class="attr">index:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">default_descr:</span> <span class="string">再怎么看我也不知道怎么描述它的啦！</span></span><br><span class="line">  <span class="attr">swiper_css:</span> <span class="string">https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css</span> <span class="comment">#swiper css依赖</span></span><br><span class="line">  <span class="attr">swiper_js:</span> <span class="string">https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js</span> <span class="comment">#swiper js依赖</span></span><br><span class="line">  <span class="attr">custom_css:</span> <span class="string">https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css</span> <span class="comment"># 适配主题样式补丁</span></span><br><span class="line">  <span class="attr">custom_js:</span> <span class="string">https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js</span> <span class="comment"># swiper初始化方法  </span></span><br></pre></td></tr></table></figure><p>注意事项</p><p>这个里面我感觉需要注意的就是layout选项，如果按照我的配置，分类会在轮播图下面显示，但是如果按照文档默认，这两个可能会导致前后顺序不对造成的问题，没有保存截图就不放了可以自己试试，注意需要设置 priority: 2 #过滤器优先权 按照我的文件配置即可</p><p>文章添加轮播需要在文章最前面新增配置 完整配置如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">title:</span> <span class="string">建站首发：Markdown语法开篇</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Markdown</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">语言</span></span><br><span class="line"><span class="attr">categories:</span> <span class="string">语言</span></span><br><span class="line"><span class="attr">sticky:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">katex:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cover:</span> <span class="string">http://qiniu.gocit.cn/blog_posts_1/cover_img.jpeg</span></span><br><span class="line"><span class="attr">top_img:</span> <span class="string">http://qiniu.gocit.cn/blog_posts_1/top_img.png</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2022-08-02 09:28:56</span></span><br><span class="line"><span class="attr">abbrlink:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">swiper_index:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">务必阅读：适用于新手快速入门的Markdown语法使用教程，运用Markdown语法是建立blog的必要前提!zf</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>本文实际添加：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">katex:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">abbrlink:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">swiper_index:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="三-分类卡片："><a href="#三-分类卡片：" class="headerlink" title="三. 分类卡片："></a>三. 分类卡片：</h2><p>安装插件咯：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-butterfly-categories-card --save</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将以下参数也是放到根目录下的_config.yml中即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hexo-butterfly-categories-card</span></span><br><span class="line"><span class="comment"># see https://akilar.top/posts/a9131002/</span></span><br><span class="line">categoryBar:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span> <span class="comment"># 开关</span></span><br><span class="line">  priority: 5 <span class="comment">#过滤器优先权</span></span><br><span class="line">  enable_page: / <span class="comment"># 应用页面</span></span><br><span class="line">  layout: <span class="comment"># 挂载容器类型</span></span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">id</span></span><br><span class="line">    name: recent-posts</span><br><span class="line">    index: 1</span><br><span class="line">  column: odd <span class="comment"># odd：3列 | even：4列</span></span><br><span class="line">  row: 2 <span class="comment">#显示行数，默认两行，超过行数切换为滚动显示</span></span><br><span class="line">  message:</span><br><span class="line">    - descr: 学习资料</span><br><span class="line">      cover: https://npm.elemecdn.com/akilar-candyassets/image/cover1.webp</span><br><span class="line">    - descr: 日常分享</span><br><span class="line">      cover: https://npm.elemecdn.com/akilar-candyassets/image/cover2.webp</span><br><span class="line">    - descr: 博客魔改</span><br><span class="line">      cover: https://npm.elemecdn.com/akilar-candyassets/image/cover3.webp</span><br><span class="line"><span class="comment">#    - descr: 个人日记</span></span><br><span class="line"><span class="comment">#      cover: https://npm.elemecdn.com/akilar-candyassets/image/cover4.webp</span></span><br><span class="line"><span class="comment">#    - descr: 诗词歌赋</span></span><br><span class="line"><span class="comment">#      cover: https://npm.elemecdn.com/akilar-candyassets/image/cover5.webp</span></span><br><span class="line"><span class="comment">#    - descr: 杂谈教程</span></span><br><span class="line"><span class="comment">#      cover: https://npm.elemecdn.com/akilar-candyassets/image/cover6.webp</span></span><br><span class="line">  custom_css: https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>注意事项：</p><p>注意修改其中的message为你的分类，这里我只有三个分类所以开了三个，尽量不要开过六个，我个人感觉滚动显示不好看<br>然后就是默认显示行数和列数，行数最好设置大一行，否则可能会出现滚动，列数保持到三就可以<br>如果配置了上方的swipper，最好不要动layout，当然我也不是很懂，但是至少这样能够正常运行haha</p><p>参考参数解释等：</p><p><a href="https://blog.csdn.net/weixin_42464282/article/details/130989629">https://blog.csdn.net/weixin_42464282/article/details/130989629</a></p><p><a href="https://blog.liushen.fun/posts/6af2a5bb/#%E4%B8%80-%E9%A6%96%E9%A1%B5%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C%EF%BC%9A">https://blog.liushen.fun/posts/6af2a5bb/#%E4%B8%80-%E9%A6%96%E9%A1%B5%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C%EF%BC%9A</a></p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>魔改笔记五：分类条及外链卡片</title>
      <link href="/2025/01/21/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E4%BA%94%EF%BC%9A%E5%88%86%E7%B1%BB%E6%9D%A1%E5%8F%8A%E5%A4%96%E9%93%BE%E5%8D%A1%E7%89%87/"/>
      <url>/2025/01/21/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E4%BA%94%EF%BC%9A%E5%88%86%E7%B1%BB%E6%9D%A1%E5%8F%8A%E5%A4%96%E9%93%BE%E5%8D%A1%E7%89%87/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="魔改笔记五：分类条及外链卡片"><a href="#魔改笔记五：分类条及外链卡片" class="headerlink" title="魔改笔记五：分类条及外链卡片"></a>魔改笔记五：分类条及外链卡片</h1><p>魔改教程<br>注意：由于本次魔改修改了主题内部文件，一定要注意提前备份！一定要注意提前备份！一定要注意提前备份！如果没有魔改基础建议紧跟教程，如果有任何问题可以在下方评论区提出。</p><p>分类条<br>我原有的分类是店长的分类卡片，但总感觉占用空间有点大，且如果分类超过三个会显示滚动条。我在网站设计中尽量避免显示滚动条，因为感觉不够美观。为了使网站更加简洁，我决定按照朋友 klcdm 的推荐，使用洪哥的分类条。然而，洪哥的分类条是纯静态的，分类需要手动添加上去，明显不符合我的懒蛋需求。因此，我决定修改洪哥的分类条，并从 hexo-theme-solitude 中提取出动态分类条的功能，以便更简洁地显示所有分类并快捷切换。</p><p>效果展示<br>以下是分类条的展示效果，具体效果可以在首页自行感受。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/1/image_0f8430c0f966cdd10dfebc5685e24b4f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/1/image_0f8430c0f966cdd10dfebc5685e24b4f.png"></p><p>为了美观，我把横向分类的滚动条移除了，但是仍然可以移动，如果是手机的话，通过左右滑动即可拉动滚动条，但是不太明显，有需要的可以自行添加其他元素。</p><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><p>新建文件[BlogRoot]\themes\butterfly\layout\includes\categoryBar.pug文件，写入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.category-bar-items#category-bar-items(class=is_home() ? &#x27;home&#x27; : &#x27;&#x27;)</span><br><span class="line">  .category-bar-item(class=is_home() ? &#x27;select&#x27; : &#x27;&#x27;, id=&quot;category-bar-home&quot;)</span><br><span class="line">    a(href=url_for(&#x27;/&#x27;))= __(&#x27;博客首页&#x27;)</span><br><span class="line">  each item in site.categories.find(&#123; parent: &#123; $exists: false &#125; &#125;).data</span><br><span class="line">    .category-bar-item(class=select ? (select === item.name ? &#x27;select&#x27; : &#x27;&#x27;) : &#x27;&#x27;, id=item.name)</span><br><span class="line">      a(href=url_for(item.path))= item.name</span><br><span class="line">  .category-bar-item</span><br><span class="line">    a(href=url_for(&#x27;/archives/&#x27;))= __(&#x27;文章存档&#x27;)</span><br><span class="line">div.category-bar-right</span><br><span class="line">  a.category-bar-more(href=url_for(&#x27;/categories/&#x27;))= __(&#x27;更多分类&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以上就是该滚动条的结构，下面我们开始实现样式的定义，新建文件[BlogRoot]\themes\butterfly\source\css_layout\category-bar.styl写入以下文件：</p><figure class="highlight styl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#category-bar</span></span><br><span class="line">  <span class="attribute">padding</span> <span class="number">7px</span> <span class="number">11px</span></span><br><span class="line">  <span class="attribute">background</span> <span class="built_in">var</span>(--card-bg)</span><br><span class="line">  <span class="attribute">border-radius</span> <span class="number">8px</span></span><br><span class="line">  <span class="attribute">display</span> flex</span><br><span class="line">  <span class="attribute">white-space</span> nowrap</span><br><span class="line">  <span class="attribute">overflow</span> hidden</span><br><span class="line">  <span class="attribute">transition</span> <span class="number">0.3s</span></span><br><span class="line">  <span class="attribute">height</span> <span class="number">50px</span></span><br><span class="line">  <span class="attribute">width</span> <span class="number">100%</span></span><br><span class="line">  <span class="attribute">justify-content</span> space-between</span><br><span class="line">  user-select <span class="attribute">none</span></span><br><span class="line">  <span class="attribute">align-items</span> center</span><br><span class="line">  <span class="attribute">margin-bottom</span> <span class="number">20px</span></span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.category-bar-right</span></span><br><span class="line">    <span class="attribute">display</span> flex</span><br><span class="line">    <span class="attribute">border-radius</span> <span class="number">8px</span></span><br><span class="line">    <span class="attribute">align-items</span> center</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.category-bar-more</span></span><br><span class="line">      <span class="attribute">margin-left</span> <span class="number">4px</span></span><br><span class="line">      <span class="attribute">margin-right</span> <span class="number">4px</span></span><br><span class="line">      <span class="attribute">font-weight</span> <span class="number">700</span></span><br><span class="line">      <span class="attribute">border-radius</span> <span class="number">8px</span></span><br><span class="line">      <span class="attribute">padding</span> <span class="number">0</span> <span class="number">8px</span></span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.category-bar-items</span></span><br><span class="line">    <span class="attribute">width</span> <span class="number">100%</span></span><br><span class="line">    <span class="attribute">white-space</span> nowrap</span><br><span class="line">    <span class="attribute">overflow-x</span> scroll</span><br><span class="line">    <span class="attribute">scrollbar-width</span>: none</span><br><span class="line">    -ms-<span class="attribute">overflow</span>-style: none</span><br><span class="line">    <span class="attribute">overflow-y</span> hidden</span><br><span class="line">    <span class="attribute">display</span> flex</span><br><span class="line">    <span class="attribute">border-radius</span> <span class="number">8px</span></span><br><span class="line">    <span class="attribute">align-items</span> center</span><br><span class="line">    <span class="attribute">height</span> <span class="number">30px</span></span><br><span class="line"></span><br><span class="line">    &amp;::-webkit-scrollbar</span><br><span class="line">      <span class="attribute">display</span>: none</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.category-bar-item</span></span><br><span class="line">      <span class="selector-tag">a</span></span><br><span class="line">        <span class="attribute">padding</span> .<span class="number">1rem</span> .<span class="number">5rem</span></span><br><span class="line">        <span class="attribute">margin-right</span> <span class="number">6px</span></span><br><span class="line">        <span class="attribute">font-weight</span> <span class="number">700</span></span><br><span class="line">        <span class="attribute">border-radius</span> <span class="number">8px</span></span><br><span class="line">        <span class="attribute">display</span> flex</span><br><span class="line">        <span class="attribute">align-items</span> center</span><br><span class="line">        <span class="attribute">height</span> <span class="number">30px</span></span><br><span class="line"></span><br><span class="line">      &amp;<span class="selector-class">.select</span></span><br><span class="line">        <span class="selector-tag">a</span></span><br><span class="line">          <span class="attribute">background</span> <span class="number">#3eb8be</span></span><br><span class="line">          <span class="attribute">color</span> <span class="built_in">var</span>(--btn-color)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在pug文件中，所有的颜色我都尽量使用了butterfly主题自带的变量进行了替代，确保大部分人可以正常显示。</p><p>然后将其添加到不同的位置，比如我这里实现了添加到分类页面等位置，配合上pjax可以做到无刷更新，效果很好，打开文件[BlogRoot]\themes\butterfly\layout\category.pug，添加其中两行代码，去掉加号即为正常缩进：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">extends includes/layout.pug</span><br><span class="line"></span><br><span class="line">block content</span><br><span class="line">  if theme.category_ui == &#x27;index&#x27;</span><br><span class="line">    include ./includes/mixins/post-ui.pug</span><br><span class="line">    #recent-posts.recent-posts.category_ui</span><br><span class="line"><span class="addition">+      #category-bar.category-bar</span></span><br><span class="line"><span class="addition">+        include includes/categoryBar.pug</span></span><br><span class="line">      +postUI</span><br><span class="line">      include includes/pagination.pug</span><br><span class="line">  else</span><br><span class="line">    include ./includes/mixins/article-sort.pug</span><br><span class="line">    #category</span><br><span class="line">      &lt;div id=&quot;categories-chart&quot; data-parent=&quot;true&quot; style=&quot;height: 300px; padding: 10px;&quot;&gt;&lt;/div&gt;</span><br><span class="line">      .article-sort-title= _p(&#x27;page.category&#x27;) + &#x27; - &#x27; + page.category</span><br><span class="line">      +articleSort(page.posts)</span><br><span class="line">      include includes/pagination.pug</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>注意上方的修改，需要将配置文件中，分类页面的主题改成index，否则不会显示。</p><p>下面我们将其添加到主页，打开文件[BlogRoot]\themes\butterfly\layout\index.pug文件，添加下面两行</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">extends includes/layout.pug</span><br><span class="line"></span><br><span class="line">block content</span><br><span class="line">  include ./includes/mixins/post-ui.pug</span><br><span class="line">  #recent-posts.recent-posts</span><br><span class="line"><span class="addition">+    #category-bar.category-bar</span></span><br><span class="line"><span class="addition">+      include includes/categoryBar.pug</span></span><br><span class="line">    +postUI</span><br><span class="line">    include includes/pagination.pug</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后就是实现点击切换后，高亮部分跟随分类页面走的部分，为了和主题融合我还是修改源码，打开[BlogRoot]\themes\butterfly\source\js\main.js，添加js函数，比如我添加到了778行左右，switchComments函数的上面：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 自己写的，实现功能切换类别表</span></span><br><span class="line"><span class="comment">   */</span> </span><br><span class="line">  const setCategoryBarActive = () =&gt; &#123;</span><br><span class="line">    const categoryBar = document<span class="selector-class">.querySelector</span>(&quot;<span class="selector-id">#category-bar</span>&quot;);</span><br><span class="line">    const currentPath = decodeURIComponent(window<span class="selector-class">.location</span><span class="selector-class">.pathname</span>);</span><br><span class="line">    const isHomePage = currentPath === GLOBAL_CONFIG<span class="selector-class">.root</span>;</span><br><span class="line"></span><br><span class="line">    if (categoryBar) &#123;</span><br><span class="line">        const categoryItems = categoryBar<span class="selector-class">.querySelectorAll</span>(&quot;<span class="selector-class">.category-bar-item</span>&quot;);</span><br><span class="line">        categoryItems<span class="selector-class">.forEach</span>(item =&gt; item<span class="selector-class">.classList</span><span class="selector-class">.remove</span>(&quot;select&quot;));</span><br><span class="line"></span><br><span class="line">        const activeItemId = isHomePage ? &quot;category-bar-home&quot; : currentPath.<span class="built_in">split</span>(<span class="string">&quot;/&quot;</span>).<span class="built_in">slice</span>(-<span class="number">2</span>, -<span class="number">1</span>)[<span class="number">0</span>];</span><br><span class="line">        const activeItem = document<span class="selector-class">.getElementById</span>(activeItemId);</span><br><span class="line"></span><br><span class="line">        if (activeItem) &#123;</span><br><span class="line">            activeItem<span class="selector-class">.classList</span><span class="selector-class">.add</span>(&quot;select&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后再在引用部分执行这个函数，在同一个文件，找到下面的函数并添加函数的调用，位置看下方注释：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">window<span class="selector-class">.refreshFn</span> = function () &#123;</span><br><span class="line">  initAdjust()</span><br><span class="line"></span><br><span class="line">  if (GLOBAL_CONFIG_SITE<span class="selector-class">.isPost</span>) &#123;</span><br><span class="line">    GLOBAL_CONFIG<span class="selector-class">.noticeOutdate</span> !== undefined &amp;&amp; addPostOutdateNotice()</span><br><span class="line">    GLOBAL_CONFIG<span class="selector-class">.relativeDate</span><span class="selector-class">.post</span> &amp;&amp; relativeDate(document<span class="selector-class">.querySelectorAll</span>(&#x27;<span class="selector-id">#post-meta</span> <span class="selector-tag">time</span>&#x27;))</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    GLOBAL_CONFIG<span class="selector-class">.relativeDate</span><span class="selector-class">.homepage</span> &amp;&amp; relativeDate(document<span class="selector-class">.querySelectorAll</span>(&#x27;<span class="selector-id">#recent-posts</span> <span class="selector-tag">time</span>&#x27;))</span><br><span class="line">    GLOBAL_CONFIG<span class="selector-class">.runtime</span> &amp;&amp; addRuntime()</span><br><span class="line">    addLastPushDate()</span><br><span class="line">    toggleCardCategory()</span><br><span class="line">    setCategoryBarActive()      // 自己加的，用于切换类别栏目</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>最后，hexo三件套，应该就能看到效果了！请根据自己的需要进行定制化。</p><h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a href="https://blog.liushen.fun/posts/a64defb4/">https://blog.liushen.fun/posts/a64defb4/</a></p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>12、pod控制器介绍</title>
      <link href="/2025/01/05/12%E3%80%81pod%E6%8E%A7%E5%88%B6%E5%99%A8%E4%BB%8B%E7%BB%8D/"/>
      <url>/2025/01/05/12%E3%80%81pod%E6%8E%A7%E5%88%B6%E5%99%A8%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="12、pod控制器介绍"><a href="#12、pod控制器介绍" class="headerlink" title="12、pod控制器介绍"></a>12、pod控制器介绍</h2><h3 id="一、Pod控制器介绍"><a href="#一、Pod控制器介绍" class="headerlink" title="一、Pod控制器介绍"></a>一、Pod控制器介绍</h3><p><strong>Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类：</strong></p><ul><li><strong>自主式pod：kubernetes直接创建出来的Pod，这种pod删除后就没有了，也不会重建</strong></li><li><strong>控制器创建的pod：kubernetes通过控制器创建的pod，这种pod删除了之后还会自动重建</strong></li></ul><h3 id="二、-lt-span-class-quot-ne-text-quot-gt-什么是Pod控制器-lt-span-gt"><a href="#二、-lt-span-class-quot-ne-text-quot-gt-什么是Pod控制器-lt-span-gt" class="headerlink" title="二、&lt;span class=&quot;ne-text&quot;&gt;什么是Pod控制器&lt;/span&gt;"></a>二、<code>&lt;span class=&quot;ne-text&quot;&gt;什么是Pod控制器&lt;/span&gt;</code></h3><p><strong>Pod控制器是管理pod的中间层，使用Pod控制器之后，只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它会创建出满足条件的Pod并确保每一个Pod资源处于用户期望的目标状态。如果Pod资源在运行中出现故障，它会基于指定策略重新编排Pod。</strong></p><p><strong>在kubernetes中，有很多类型的pod控制器，每种都有自己的适合的场景，常见的有下面这些：</strong></p><ul><li><strong>ReplicationController：比较原始的pod控制器，已经被废弃，由ReplicaSet替代</strong></li><li><strong>ReplicaSet：保证副本数量一直维持在期望值，并支持pod数量扩缩容，镜像版本升级</strong></li><li><strong>Deployment：通过控制ReplicaSet来控制Pod，并支持滚动升级、回退版本</strong></li><li><strong>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整Pod的数量，实现削峰填谷</strong></li><li><strong>DaemonSet：在集群中的指定Node上运行且仅运行一个副本，一般用于守护进程类的任务</strong></li><li><strong>Job：它创建出来的pod只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</strong></li><li><strong>Cronjob：它创建的Pod负责周期性任务控制，不需要持续后台运行</strong></li><li><strong>StatefulSet：管理有状态应用</strong></li></ul>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hostpath存储类型及headlines类型的service与手动指定ip版mysql5.7部署并构建webstack</title>
      <link href="/2025/01/01/hostpath%E5%AD%98%E5%82%A8%E7%B1%BB%E5%9E%8B%E5%8F%8Aheadlines%E7%B1%BB%E5%9E%8B%E7%9A%84service%E4%B8%8E%E6%89%8B%E5%8A%A8%E6%8C%87%E5%AE%9Aip%E7%89%88mysql5.7%E9%83%A8%E7%BD%B2%E5%B9%B6%E6%9E%84%E5%BB%BAwebstack/"/>
      <url>/2025/01/01/hostpath%E5%AD%98%E5%82%A8%E7%B1%BB%E5%9E%8B%E5%8F%8Aheadlines%E7%B1%BB%E5%9E%8B%E7%9A%84service%E4%B8%8E%E6%89%8B%E5%8A%A8%E6%8C%87%E5%AE%9Aip%E7%89%88mysql5.7%E9%83%A8%E7%BD%B2%E5%B9%B6%E6%9E%84%E5%BB%BAwebstack/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="hostpath存储类型及headlines类型的service与手动指定ip版mysql5-7部署并构建webstack"><a href="#hostpath存储类型及headlines类型的service与手动指定ip版mysql5-7部署并构建webstack" class="headerlink" title="hostpath存储类型及headlines类型的service与手动指定ip版mysql5.7部署并构建webstack"></a>hostpath存储类型及headlines类型的service与手动指定ip版mysql5.7部署并构建webstack</h1><h2 id="一、headlines类型的service版mysql构建"><a href="#一、headlines类型的service版mysql构建" class="headerlink" title="一、headlines类型的service版mysql构建"></a>一、headlines类型的service版mysql构建</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">my.cnf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    !includedir /etc/mysql/conf.d/</span></span><br><span class="line"><span class="string">    !includedir /etc/mysql/mysql.conf.d/</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">    [<span class="string">mysqld</span>]</span><br><span class="line">    <span class="comment">## 同一局域网内注意要唯一</span></span><br><span class="line">    <span class="string">server-id=001</span></span><br><span class="line">    <span class="comment">## 开启二进制日志功能,可以随便取（关键）</span></span><br><span class="line">    <span class="string">log-bin=mysql-bin</span></span><br><span class="line">  </span><br><span class="line">    <span class="string">gtid_mode=on</span></span><br><span class="line">    <span class="string">enforce_gtid_consistency=on</span></span><br><span class="line">  </span><br><span class="line">    <span class="string">relay-log=relay-log.log</span></span><br><span class="line">    <span class="string">binlog_format=ROW</span></span><br><span class="line">    <span class="comment">#MySQL5.7可以不启用此参数,5.7版本使用了gtid_executed表记录同步复制的信息,避免两次写入relay-log和binlog,降低了从库磁盘I/O</span></span><br><span class="line">    <span class="comment">#log_slave_updates=true</span></span><br><span class="line">    <span class="string">master_info_repository=TABLE</span></span><br><span class="line">    <span class="string">relay_log_info_repository=TABLE</span></span><br><span class="line">    <span class="string">sync_master_info=1</span></span><br><span class="line">    <span class="string">slave_parallel_workers=2</span></span><br><span class="line">    <span class="string">binlog_checksum=CRC32</span></span><br><span class="line">    <span class="string">master_verify_checksum=1</span></span><br><span class="line">    <span class="string">slave_sql_verify_checksum=1</span></span><br><span class="line">    <span class="string">binlog_rows_query_log_events=1</span></span><br><span class="line">    <span class="comment">#replicate_do_db=tt</span></span><br><span class="line">    <span class="comment">#MySQL5.7新增加的值,配置基于表的组提交并行复制,默认值为database（基于库进行多线程复制,MySQL5.6是基于库的方式进行多线程方式复制）建议改为logical_clock,基于表的组方式复制,提高复制的效率</span></span><br><span class="line">    <span class="string">slave_parallel_type=logical_clock</span></span><br><span class="line">    <span class="comment">#开启通用查询日志</span></span><br><span class="line">    <span class="string">general_log=1</span></span><br><span class="line">    <span class="comment">#设置通用日志的输出格式为文件和表</span></span><br><span class="line">    <span class="string">log_output=FILE,TABLE</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span> <span class="comment"># has to match .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;mysql&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span> <span class="comment"># by default is 1               # 3副本</span></span><br><span class="line">  <span class="comment"># minReadySeconds: 10 # by default is 0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span> <span class="comment"># has to match .spec.selector.matchLabels</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mysql:5.7</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;root_password&quot;</span>  <span class="comment"># 设置根密码,建议使用 Secrets 存储</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">webstack</span>         <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">webstack</span>         <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;root_password&quot;</span>  <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-map</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">&quot;/etc/mysql/my.cnf&quot;</span></span><br><span class="line">            <span class="attr">subPath:</span> <span class="string">my.cnf</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="comment"># 定义 ConfigMap 类型的 Volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-map</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql-cm</span>  <span class="comment"># 引用名为 mysql-cm 的 ConfigMap</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">          <span class="attr">hostPath:</span> </span><br><span class="line">            <span class="attr">path:</span> <span class="string">/opt/webstack_db</span>      <span class="comment"># 宿主机目录  </span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span>     <span class="comment"># 目录存在就使用，不存在就先创建后使用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span>  <span class="comment"># service的ip地址,如果不写,默认会生成一个 此中即为headline类型的service</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span>             <span class="comment"># Service端口</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3306</span>       <span class="comment"># pod端口</span></span><br></pre></td></tr></table></figure><p><strong>查看域名内部dns解析</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it mysql-0 -n dev   -- /bin/sh </span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="comment"># bin  boot  dev  docker-entrypoint-initdb.d  entrypoint.sh  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span></span><br><span class="line"><span class="built_in">cat</span> /etc/resolv.conf </span><br><span class="line"><span class="comment"># search dev.svc.cluster.local svc.cluster.local cluster.local</span></span><br><span class="line"><span class="comment"># nameserver 10.96.0.10</span></span><br><span class="line"><span class="comment"># options ndots:5</span></span><br></pre></td></tr></table></figure><p><strong>备注：域名规则 svc名称+ns名称+写死部分svc.cluster.local 即此headliness类型的pod域名方式访问应该是</strong></p><p>service-mysql.dev.svc.cluster.local</p><p><strong>验证（宿主机执行）：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">dig @10.96.0.10 service-mysql.dev.svc.cluster.local </span><br><span class="line">// 返回</span><br><span class="line">root@k8s:/opt/webstack<span class="comment"># dig @10.96.0.10 service-mysql.dev.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.18-Ubuntu &lt;&lt;&gt;&gt; @10.96.0.10 service-mysql.dev.svc.cluster.local</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .<span class="built_in">local</span> is reserved <span class="keyword">for</span> Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 52747</span></span><br><span class="line"><span class="string">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class="line"><span class="string">;; WARNING: recursion requested but not available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">; COOKIE: dd22da56f562b801 (echoed)</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;service-mysql.dev.svc.cluster.local. IN        A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">service-mysql.dev.svc.cluster.local. 30 IN A    172.16.0.9</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 0 msec</span></span><br><span class="line"><span class="string">;; SERVER: 10.96.0.10#53(10.96.0.10)</span></span><br><span class="line"><span class="string">;; WHEN: Tue Dec 24 15:19:34 CST 2024</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 127</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">root@k8s:/opt/webstack# kubectl get pod -n dev -o wide</span></span><br><span class="line"><span class="string">NAME      READY   STATUS    RESTARTS      AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span></span><br><span class="line"><span class="string">mysql-0   1/1     Running   0             18m   172.16.0.9   k8s    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"><span class="string">qexo-0    1/1     Running   1 (64m ago)   77m   172.16.0.6   k8s    &lt;none&gt;           &lt;none&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/1/image_bbf96436226c61db3ef129199d2968e5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/1/image_bbf96436226c61db3ef129199d2968e5.png"></p><p><strong>headlines类型的service集群之间通信直接使用svc名称</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/1/image_d98ea5eb38a20aaf13987b58ab40b280.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/1/image_d98ea5eb38a20aaf13987b58ab40b280.png"></p><h2 id="二、webstack构建"><a href="#二、webstack构建" class="headerlink" title="二、webstack构建"></a>二、webstack构建</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建webstack</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webstack</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span>         <span class="comment"># 修改为3副本</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">webstack</span>   <span class="comment"># 必须与 .spec.template.metadata.labels 匹配</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">webstack</span> <span class="comment"># 必须与 .spec.selector.matchLabels 匹配</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webstack</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:webstackv-1.2.2</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOGIN_COPTCHA</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;service-mysql&quot;</span>  <span class="comment"># 此处为headlines类型的service版mysql的地址</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">webstack</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USERNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">root</span>   </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">root_password</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APP_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;&quot;</span> <span class="comment"># 空值明确写为 &quot;&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">webstack</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;/entrypoint.sh&#x27;</span>,<span class="string">&#x27;serve&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露webstack端口</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webstack-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webstack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># 将服务暴露为 NodePort 类型</span></span><br></pre></td></tr></table></figure><p>成功！</p><h2 id="三、扩展、clusterIP-手动指定IP版本部署MySQL与webstack"><a href="#三、扩展、clusterIP-手动指定IP版本部署MySQL与webstack" class="headerlink" title="三、扩展、clusterIP 手动指定IP版本部署MySQL与webstack"></a>三、扩展、clusterIP 手动指定IP版本部署MySQL与webstack</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql配置</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">my.cnf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    !includedir /etc/mysql/conf.d/</span></span><br><span class="line"><span class="string">    !includedir /etc/mysql/mysql.conf.d/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    [<span class="string">mysqld</span>]</span><br><span class="line">    <span class="comment">## 同一局域网内注意要唯一</span></span><br><span class="line">    <span class="string">server-id=001</span></span><br><span class="line">    <span class="comment">## 开启二进制日志功能，可以随便取（关键）</span></span><br><span class="line">    <span class="string">log-bin=mysql-bin</span></span><br><span class="line"></span><br><span class="line">    <span class="string">gtid_mode=on</span></span><br><span class="line">    <span class="string">enforce_gtid_consistency=on</span></span><br><span class="line"></span><br><span class="line">    <span class="string">relay-log=relay-log.log</span></span><br><span class="line">    <span class="string">binlog_format=ROW</span></span><br><span class="line">    <span class="comment">#MySQL5.7可以不启用此参数，5.7版本使用了gtid_executed表记录同步复制的信息，避免两次写入relay-log和binlog，降低了从库磁盘I/O</span></span><br><span class="line">    <span class="comment">#log_slave_updates=true</span></span><br><span class="line">    <span class="string">master_info_repository=TABLE</span></span><br><span class="line">    <span class="string">relay_log_info_repository=TABLE</span></span><br><span class="line">    <span class="string">sync_master_info=1</span></span><br><span class="line">    <span class="string">slave_parallel_workers=2</span></span><br><span class="line">    <span class="string">binlog_checksum=CRC32</span></span><br><span class="line">    <span class="string">master_verify_checksum=1</span></span><br><span class="line">    <span class="string">slave_sql_verify_checksum=1</span></span><br><span class="line">    <span class="string">binlog_rows_query_log_events=1</span></span><br><span class="line">    <span class="comment">#replicate_do_db=tt</span></span><br><span class="line">    <span class="comment">#MySQL5.7新增加的值，配置基于表的组提交并行复制，默认值为database（基于库进行多线程复制，MySQL5.6是基于库的方式进行多线程方式复制）建议改为logical_clock，基于表的组 方式复制，提高复制的效率</span></span><br><span class="line">    <span class="string">slave_parallel_type=logical_clock</span></span><br><span class="line">    <span class="comment">#开启通用查询日志</span></span><br><span class="line">    <span class="string">general_log=1</span></span><br><span class="line">    <span class="comment">#设置通用日志的输出格式为文件和表</span></span><br><span class="line">    <span class="string">log_output=FILE,TABLE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span> <span class="comment"># has to match .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;mysql&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span> <span class="comment"># by default is 1               # 3副本</span></span><br><span class="line">  <span class="comment"># minReadySeconds: 10 # by default is 0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span> <span class="comment"># has to match .spec.selector.matchLabels</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mysql:5.7</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;root_password&quot;</span>         <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">webstack</span>         <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">webstack</span>         <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;root_password&quot;</span>  <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">          <span class="comment"># - --collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">          <span class="comment"># - &quot;--default-authentication-plugin=mysql_native_password&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-map</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">&quot;/etc/mysql/my.cnf&quot;</span></span><br><span class="line">            <span class="attr">subPath:</span> <span class="string">my.cnf</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="comment"># 定义 ConfigMap 类型的 Volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-map</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql-cm</span>  <span class="comment"># 引用名为 mysql-cm 的 ConfigMap</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/opt/mysql</span>         <span class="comment"># 宿主机目录</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span>  <span class="comment"># 目录存在就使用，不存在就先创建后使用</span></span><br><span class="line">        <span class="comment"># # 定义持久化存储 Volume</span></span><br><span class="line">        <span class="comment"># - name: mysql-storage</span></span><br><span class="line">        <span class="comment">#   persistentVolumeClaim:</span></span><br><span class="line">        <span class="comment">#     claimName: mysql-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使mysql ip固定</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.2</span>  <span class="comment"># service的ip地址，如果不写，默认会生成一个</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span>             <span class="comment"># Service端口</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3306</span>       <span class="comment"># pod端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建webstack</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webstack</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span>         <span class="comment"># 修改为3副本</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">webstack</span>   <span class="comment"># 必须与 .spec.template.metadata.labels 匹配</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">webstack</span> <span class="comment"># 必须与 .spec.selector.matchLabels 匹配</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webstack</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:webstackv-1.2.2</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOGIN_COPTCHA</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;10.96.0.2&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">webstack</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USERNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">root_password</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APP_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;&quot;</span> <span class="comment"># 空值明确写为 &quot;&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">webstack</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;/entrypoint.sh&#x27;</span>,<span class="string">&#x27;serve&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露webstack端口</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webstack-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webstack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># 将服务暴露为 NodePort 类型</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>11.3、污点和容忍（Taints）</title>
      <link href="/2024/12/23/11.3%E3%80%81%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%EF%BC%88Taints%EF%BC%89/"/>
      <url>/2024/12/23/11.3%E3%80%81%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%EF%BC%88Taints%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="11-3、污点和容忍（Taints）"><a href="#11-3、污点和容忍（Taints）" class="headerlink" title="11.3、污点和容忍（Taints）"></a>11.3、污点和容忍（Taints）</h2><h5 id="5-4-3-污点和容忍"><a href="#5-4-3-污点和容忍" class="headerlink" title="5.4.3 污点和容忍"></a>5.4.3 污点和容忍</h5><h2 id="一、污点（Taints）"><a href="#一、污点（Taints）" class="headerlink" title="一、污点（Taints）"></a>一、污点（Taints）</h2><p><strong>前面的调度方式都是站在Pod的角度上，通过在Pod上添加属性，来确定Pod是否要调度到指定的Node上，其实我们也可以站在Node的角度上，通过在Node上添加****污点</strong>属性，来决定是否允许Pod调度过来。</p><p><strong>Node被设置上污点之后就和Pod之间存在了一种相斥的关系</strong>，进而拒绝Pod调度进来，甚至可以将已经存在的Pod驱逐出去。</p><p><strong>污点的格式为：</strong><code>key=value:effect</code>, key和value是污点的标签，effect描述污点的作用，支持如下三个选项：</p><ul><li><p><strong>PreferNoSchedule：kubernetes</strong>将尽量避免把Pod调度到具有该污点的Node上**，除非没有其他节点可调度</p></li><li><p><strong>NoSchedule：kubernetes</strong>将不会把Pod调度到具有该污点的Node上<strong>，</strong>但不会影响当前Node上已存在的Pod</p></li><li><p>NoExecute：kubernetes将不会把Pod调度到具有该污点的Node上，**同时也会将Node上已存在的Pod驱离</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_6a5ef52803df8b0fa5f4224196dc22d5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_6a5ef52803df8b0fa5f4224196dc22d5.png"></p></li></ul><p><strong>使用kubectl设置和去除污点的命令示例如下：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置污点</span></span><br><span class="line">kubectl taint nodes node1 key=value:effect</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除污点</span></span><br><span class="line">kubectl taint nodes node1 key:effect-</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除所有污点</span></span><br><span class="line">kubectl taint nodes node1 key-</span><br></pre></td></tr></table></figure><p><strong>接下来，演示下污点的效果：</strong></p><ol><li><strong>准备节点node1（为了演示效果更加明显，暂时停止node2节点）</strong></li><li><strong>为node1节点设置一个污点:</strong> <code>tag=heima:PreferNoSchedule</code>；然后创建pod1( pod1 可以 )</li><li>**修改为node1节点设置一个污点: **<code>tag=heima:NoSchedule</code>；   然后创建pod2( pod1 正常 pod2 失败 )</li><li>**修改为node1节点设置一个污点: **<code>tag=heima:NoExecute</code>；     然后创建pod3 ( 3个pod都失败 )</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为node1设置污点（PreferNoSchedule）</span></span><br><span class="line">kubectl taint nodes node1 tag=heima:PreferNoSchedule</span><br><span class="line"><span class="comment"># 查看污点</span></span><br><span class="line">kubectl describe nodes |grep Taints  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建pod1（可以正常运行）</span></span><br><span class="line">kubectl run taint1 --image=registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest -n dev</span><br><span class="line">kubectl get pods -n dev -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为node1设置污点(取消PreferNoSchedule加个-减号即可，设置NoSchedule)</span></span><br><span class="line"><span class="comment"># 此时节点上已经存在的正常运行 创建新的则失败为pending状态</span></span><br><span class="line">kubectl taint nodes node1 tag:PreferNoSchedule-</span><br><span class="line">kubectl taint nodes node1 tag=heima:NoSchedule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建pod2</span></span><br><span class="line">kubectl run taint2 --image=registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest -n dev</span><br><span class="line">kubectl get pods taint2 -n dev -o wide</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为node1设置污点(取消NoSchedule，设置NoExecute)</span></span><br><span class="line">kubectl taint nodes node1 tag:NoSchedule-</span><br><span class="line">kubectl taint nodes node1 tag=heima:NoExecute</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建pod3</span></span><br><span class="line">kubectl run taint3 --image=registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest -n dev</span><br><span class="line">kubectl get pods -n dev -o wide</span><br></pre></td></tr></table></figure><p><strong>查看节点污染：</strong></p><p><strong>tag=heima:PreferNoSchedule 正常运行</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_929c89f9cb56ad00e6cba9511bc5cb76.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_929c89f9cb56ad00e6cba9511bc5cb76.png"></p><p><strong>tag=heima:NoSchedule 已经存在的正常运行 不存在的无法创建</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_c985ac7be50b36495a05c907c4491086.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_c985ac7be50b36495a05c907c4491086.png"></p><p><strong>tag=heima:NoExecute 不能创建且已经存在的会变成pending状态</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_45917f8c57c5bb25841a6dd6e2f7295a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_45917f8c57c5bb25841a6dd6e2f7295a.png"></p><p><strong>小提示：</strong></p><ul><li><strong>使用kubeadm搭建的集群，</strong>默认就会给master节点添加一个污点标记**,所以pod就不会调度到master节点上.**</li></ul><h2 id="二、容忍（Toleration）"><a href="#二、容忍（Toleration）" class="headerlink" title="二、容忍（Toleration）"></a>二、容忍（Toleration）</h2><p><strong>上面介绍了污点的作用，我们可以在node上添加污点用于拒绝pod调度上来，但是如果就是想将一个pod调度到一个有污点的node上去，这时候应该怎么做呢？这就要使用到<strong><strong>容忍</strong></strong>。</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_d8313ab720279ccfd4715949a4358d12.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_d8313ab720279ccfd4715949a4358d12.png"></p><p><strong>污点就是拒绝，容忍就是忽略，Node通过污点拒绝pod调度上去，Pod通过容忍忽略拒绝</strong></p><p><strong>下面先通过一个案例看下效果：</strong></p><ol><li><strong>上一小节，已经在node1节点上打上了</strong><code>&lt;span class=&quot;ne-text&quot;&gt;NoExecute&lt;/span&gt;</code>的污点，此时pod是调度不上去的</li><li><strong>本小节，可以通过给pod添加容忍，然后将其调度上去</strong></li></ol><h3 id="①、添加容忍"><a href="#①、添加容忍" class="headerlink" title="①、添加容忍"></a>①、添加容忍</h3><p><strong>当前已有污点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看容忍</span></span><br><span class="line">kubectl describe nodes |grep Taints</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_a049a5cb4835960227191a854537515b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_a049a5cb4835960227191a854537515b.png"><img src="https://cdn.nlark.com/yuque/0/2024/png/49872452/1730181091573-3816af4d-578f-46af-b877-25a1a69f3e89.png"></p><p><strong>创建pod-toleration.yaml,内容如下</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-toleration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span></span><br><span class="line">  <span class="attr">tolerations:</span>        <span class="comment"># 添加容忍</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;tag&quot;</span>        <span class="comment"># 要容忍的污点的key</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span> <span class="comment"># 操作符（等于操作符）</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;heima&quot;</span>        <span class="comment"># 容忍的污点的value</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span>   <span class="comment"># 添加容忍的规则，这里必须和标记的污点规则相同</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加容忍之前的pod</span></span><br><span class="line">kubectl get pods -n dev -o wide  </span><br><span class="line"><span class="comment"># 添加容忍之后的pod</span></span><br><span class="line">kubectl get pods -n dev -o wide</span><br></pre></td></tr></table></figure><p>添加NoExecute容忍前与容忍后状态</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_02ab68ad4ca512c496719b5c8baba33a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_02ab68ad4ca512c496719b5c8baba33a.png"></p><p><strong>下面看一下容忍的详细配置:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pod.spec.tolerations</span><br><span class="line">......</span><br><span class="line">FIELDS:</span><br><span class="line">   key       <span class="comment"># 对应着要容忍的污点的键，空意味着匹配所有的键</span></span><br><span class="line">   value     <span class="comment"># 对应着要容忍的污点的值</span></span><br><span class="line">   operator  <span class="comment"># key-value的运算符，支持Equal和Exists（默认）</span></span><br><span class="line">   effect    <span class="comment"># 对应污点的effect，空意味着匹配所有影响</span></span><br><span class="line">   tolerationSeconds   <span class="comment"># 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s中pod无法访问域名解决</title>
      <link href="/2024/12/22/k8s%E4%B8%ADpod%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E5%9F%9F%E5%90%8D%E8%A7%A3%E5%86%B3/"/>
      <url>/2024/12/22/k8s%E4%B8%ADpod%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E5%9F%9F%E5%90%8D%E8%A7%A3%E5%86%B3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="k8s中pod无法访问域名解决"><a href="#k8s中pod无法访问域名解决" class="headerlink" title="k8s中pod无法访问域名解决"></a>k8s中pod无法访问域名解决</h2><p>参考：</p><p><a href="https://www.cnblogs.com/sky-cheng/p/14254871.html" title="发布于 2021-06-30 17:06">kubernetes中的pod不能访问域名问题排查 </a></p><h3 id="一、进入pod可以访问IP，不能访问域名"><a href="#一、进入pod可以访问IP，不能访问域名" class="headerlink" title="一、进入pod可以访问IP，不能访问域名"></a>一、进入pod可以访问IP，不能访问域名</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it qexo-0  -n dev  -- /bin/sh</span><br><span class="line">bash-5.0# ping www.baidu.com</span><br><span class="line">ping: bad address &#x27;www.baidu.com</span><br></pre></td></tr></table></figure><h3 id="二、进入目标pod容器，查看-etc-resolv-conf"><a href="#二、进入目标pod容器，查看-etc-resolv-conf" class="headerlink" title="二、进入目标pod容器，查看/etc/resolv.conf"></a>二、进入目标pod容器，查看/etc/resolv.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0# cat /etc/resolv.conf </span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">search hl95-notary.svc.master69.kubernetes.blockchain.hl95.com svc.master69.kubernetes.blockchain.hl95.com master69.kubernetes.blockchain.hl95.com hlqxt</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure><p>可以看到dns服务器IP为0.96.0.10,我们查看下系统的coredns pod容器信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@redis-03 kubernetes]# kubectl get pods -n kube-system -o wide |grep coredns</span><br><span class="line">coredns-66bff467f8-6w5j5            1/1     Running   0          3d20h   10.244.3.9     redis-03.hlqxt   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-66bff467f8-h2zgp            1/1     Running   0          3d20h   10.244.4.9     redis-02.hlqxt   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p>可以看到两个coredns pod位于两个node节点上，并且状态是running，正常</p><p>我们再进一步查看dns service信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@redis-03 kubernetes]# kubectl get svc -n kube-system -o wide</span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE    SELECTOR</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   5d2h   k8s-app=kube-dns</span><br></pre></td></tr></table></figure><p>kube-dns服务的IP正是10.96.0.10，这样我们知道了pod是通过kube-dns 服务来解析域名的，现在的问题是POD无法与kube-dns通信呢？还是coredns本身域名解析有问题呢，我们需要进一步来确认kube-dns 服务后端正确绑定了coredns容器，我们查看endpoint来确认</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@redis-03 kubernetes]# kubectl get endpoints -n kube-system -o wide|grep kube-dns</span><br><span class="line">kube-dns                  10.244.3.9:53,10.244.4.9:53,10.244.3.9:9153 + 3 more...   5d2h</span><br><span class="line">[root@redis-03 kubernetes]# </span><br></pre></td></tr></table></figure><p>可以看到kube-dns后端正确的绑定了两个coredns pod的IP。</p><p>我们再将目标pod中的nameserver 的ip地址改为coredns pod的IP地址，绕过kube-dns服务，直接与coredns pod通信</p><p>参考例子（无效）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0<span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line">nameserver 10.244.3.9</span><br><span class="line"><span class="comment">#nameserver 10.96.0.10</span></span><br><span class="line">search hl95-notary.svc.master69.kubernetes.blockchain.hl95.com svc.master69.kubernetes.blockchain.hl95.com master69.kubernetes.blockchain.hl95.com hlqxt</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure><p>10.244.3.9：为coredns pod其中一个的IP</p><p><strong>实际操作设置pod dns服务器为阿里云的</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/app <span class="comment"># cat /etc/resolv.conf</span></span><br><span class="line">search dev.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line"><span class="comment"># nameserver 10.96.0.10</span></span><br><span class="line">nameserver 223.5.5.5  <span class="comment">#172.16.77.25</span></span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure><p>再执行ping</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0# ping www.baidu.com</span><br><span class="line">PING www.baidu.com (110.242.68.3): 56 data bytes</span><br><span class="line">64 bytes from 110.242.68.3: seq=0 ttl=50 time=9.281 ms</span><br><span class="line">64 bytes from 110.242.68.3: seq=1 ttl=50 time=9.296 ms</span><br><span class="line">64 bytes from 110.242.68.3: seq=2 ttl=50 time=9.203 ms</span><br><span class="line">64 bytes from 110.242.68.3: seq=3 ttl=50 time=9.233 ms</span><br><span class="line">64 bytes from 110.242.68.3: seq=4 ttl=50 time=9.241 ms</span><br><span class="line">64 bytes from 110.242.68.3: seq=5 ttl=50 time=9.259 ms</span><br><span class="line">64 bytes from 110.242.68.3: seq=6 ttl=50 time=9.270 ms</span><br><span class="line">64 bytes from 110.242.68.3: seq=7 ttl=50 time=9.342 ms</span><br></pre></td></tr></table></figure><p>可以看到域名解析成功</p><p>说明coredns pod工作是正常的，应用目标pod也是工作正常的问题出在kube-dns服务与coredns节点通信上，服务与pod之间通信是通过kube-proxy实现</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>11.2、亲和性调度（podAffinity）</title>
      <link href="/2024/12/18/11.2%E3%80%81%E4%BA%B2%E5%92%8C%E6%80%A7%E8%B0%83%E5%BA%A6%EF%BC%88podAffinity%EF%BC%89/"/>
      <url>/2024/12/18/11.2%E3%80%81%E4%BA%B2%E5%92%8C%E6%80%A7%E8%B0%83%E5%BA%A6%EF%BC%88podAffinity%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="11-2、亲和性调度（podAffinity）"><a href="#11-2、亲和性调度（podAffinity）" class="headerlink" title="11.2、亲和性调度（podAffinity）"></a>11.2、亲和性调度（podAffinity）</h2><h5 id="5-4-2-亲和性调度"><a href="#5-4-2-亲和性调度" class="headerlink" title="5.4.2 亲和性调度"></a>5.4.2 亲和性调度</h5><p><strong>上一节，介绍了两种定向调度的方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的Node，那么Pod将不会被运行，即使在集群中还有可用Node列表也不行，这就限制了它的使用场景。</strong></p><p><strong>基于上面的问题，kubernetes还提供了一种亲和性调度（Affinity）。它在NodeSelector的基础之上的进行了扩展，可以通过配置的形式，实现优先选择满足条件的Node进行调度，如果没有，也可以调度到不满足条件的节点上，使调度更加灵活。</strong></p><p><strong>Affinity主要分为三类：</strong></p><ul><li><strong>nodeAffinity(node亲和性）: 以node为目标，解决pod可以调度到哪些node的问题（即pod偏好node1则优先调度到node1）</strong></li><li><strong>podAffinity(pod亲和性) : 以pod为目标，解决pod可以和哪些已存在的pod部署在同一个拓扑域中的问题（即pod1喜欢和node2节点的pod2在一起那他就可以去node2上）</strong></li><li><strong>podAntiAffinity(pod反亲和性) : 以pod为目标，解决pod不能和哪些已存在pod部署在同一个拓扑域中的问题（即pod2讨厌和node1节点在一起那它就可以去node2节点  讨厌pod1那他就不会在pod1所在的节点）</strong></li></ul><p><strong>关于亲和性(反亲和性)使用场景的说明：</strong></p><p>*<em>亲和性</em>***：如果两个应用频繁交互，那就有必要利用亲和性让两个应用的尽可能的靠近，这样可以减少因网络通信而带来的性能损耗。 **</p><p><strong>反亲和性****：当应用的采用多副本部署时，有必要采用反亲和性让各个应用实例打散分布在各个node上，这样可以提高服务的高可用性（如tomcat高可用）。</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_0f7bd9d4220e2c5ec39d8d47113d4768.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_0f7bd9d4220e2c5ec39d8d47113d4768.png"></p><h2 id="一、NodeAffinity-node亲和性）"><a href="#一、NodeAffinity-node亲和性）" class="headerlink" title="一、NodeAffinity (node亲和性）"></a>一、NodeAffinity (node亲和性）</h2><h3 id="1、首先来看一下NodeAffinity的可配置项："><a href="#1、首先来看一下NodeAffinity的可配置项：" class="headerlink" title="1、首先来看一下NodeAffinity的可配置项："></a>1、首先来看一下<code>NodeAffinity</code>的可配置项：</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pod.spec.affinity.nodeAffinity</span><br><span class="line">  requiredDuringSchedulingIgnoredDuringExecution  Node节点必须满足指定的所有规则才可以，相当于硬限制</span><br><span class="line">    nodeSelectorTerms  节点选择列表</span><br><span class="line">      matchFields   按节点字段列出的节点选择器要求列表</span><br><span class="line">      matchExpressions   按节点标签列出的节点选择器要求列表(推荐)</span><br><span class="line">        key    键</span><br><span class="line">        values 值</span><br><span class="line">        operat <span class="keyword">or</span> 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</span><br><span class="line">  preferredDuringSchedulingIgnoredDuringExecution 优先调度到满足指定的规则的Node，相当于软限制 (倾向)</span><br><span class="line">    preference   一个节点选择器项，与相应的权重相关联</span><br><span class="line">      matchFields   按节点字段列出的节点选择器要求列表</span><br><span class="line">      matchExpressions   按节点标签列出的节点选择器要求列表(推荐)</span><br><span class="line">        key    键</span><br><span class="line">        values 值</span><br><span class="line">        <span class="keyword">operator</span> 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt</span><br><span class="line">weight 倾向权重，在范围<span class="number">1</span><span class="number">-100</span>。</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">关系符的使用说明:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span>              <span class="comment"># 匹配存在标签（label）的key为nodeenv的节点</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span>              <span class="comment"># 匹配标签的key为nodeenv,且value是&quot;xxx&quot;或&quot;yyy&quot;的节点</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">    <span class="attr">values:</span> [<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span>              <span class="comment"># 匹配标签的key为nodeenv,且value大于&quot;xxx&quot;的节点</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Gt</span></span><br><span class="line">    <span class="attr">values:</span> <span class="string">&quot;xxx&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2、requiredDuringSchedulingIgnoredDuringExecution硬限制"><a href="#2、requiredDuringSchedulingIgnoredDuringExecution硬限制" class="headerlink" title="2、requiredDuringSchedulingIgnoredDuringExecution硬限制"></a>2、<code>requiredDuringSchedulingIgnoredDuringExecution</code>硬限制</h3><p><strong>必须调度到含标签的node上否则报错</strong></p><p><strong>接下来首先演示一下</strong><code>&lt;span class=&quot;ne-text&quot;&gt;requiredDuringSchedulingIgnoredDuringExecution&lt;/span&gt;</code> （硬限制）,</p><p><strong>创建pod-nodeaffinity-required.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-nodeaffinity-required</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span> <span class="comment"># nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span>       <span class="comment"># 亲和性设置</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span> <span class="comment"># 设置node亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 硬限制必须满足如下条件才能调度</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span>       <span class="comment"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span>          <span class="comment"># 定义标签nodeenv的值必须为xxx或yyy    </span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br></pre></td></tr></table></figure><p><strong>查看当前节点下有没有这样的标签（label）可以看到当前的node节点都无法满足</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手动给节点打上标签</span></span><br><span class="line">kubectl label nodes k8s nodeenv=pro</span><br><span class="line">kubectl label nodes k8s1 nodeenv=<span class="built_in">test</span></span><br><span class="line"><span class="comment"># 查看节点标签</span></span><br><span class="line">kubectl get nodes --show-labels</span><br><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">kubectl create -f pod-nodeaffinity-required.yaml</span><br><span class="line"><span class="comment"># 查看pod状态 （运行失败）</span></span><br><span class="line">kubectl get pods pod-nodeaffinity-required -n dev -o wide</span><br><span class="line"><span class="comment"># 查看Pod的详情</span></span><br><span class="line"><span class="comment"># 发现调度失败，提示node选择失败</span></span><br><span class="line">kubectl describe pod pod-nodeaffinity-required -n dev</span><br><span class="line"><span class="comment"># 接下来，停止pod</span></span><br><span class="line">kubectl delete -f pod-nodeaffinity-required.yaml</span><br><span class="line"><span class="comment"># 修改文件，将values: [&quot;xxx&quot;,&quot;yyy&quot;]------&gt; [&quot;pro&quot;,&quot;yyy&quot;]</span></span><br><span class="line">vim pod-nodeaffinity-required.yaml</span><br><span class="line"><span class="comment"># 修改如下部分...</span></span><br><span class="line">  affinity:       <span class="comment"># 亲和性设置</span></span><br><span class="line">    nodeAffinity: <span class="comment"># 设置node亲和性</span></span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution: <span class="comment"># 硬限制必须满足如下条件才能调度</span></span><br><span class="line">        nodeSelectorTerms:</span><br><span class="line">        - matchExpressions:       <span class="comment"># 匹配env的值在[&quot;xxx&quot;,&quot;pro&quot;]中的标签</span></span><br><span class="line">          - key: nodeenv          <span class="comment"># 定义标签nodeenv的值必须为xxx或yyy    </span></span><br><span class="line">            operator: In</span><br><span class="line">            values: [<span class="string">&quot;pro&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次启动</span></span><br><span class="line">kubectl create -f pod-nodeaffinity-required.yaml</span><br><span class="line"><span class="comment"># 此时查看，发现调度成功，已经将pod调度到了node1上</span></span><br><span class="line">kubectl get pods pod-nodeaffinity-required -n dev -o wide</span><br><span class="line"></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP              NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-nodeaffinity-required   1/1     Running   0          95s   192.168.77.14   k8s    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p><strong>标签</strong></p><p><strong>调度失败（pending）</strong></p><p><strong>效果</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_591290abc700dccc1f988add80419da9.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_591290abc700dccc1f988add80419da9.png"></p><h3 id="3、requiredDuringSchedulingIgnoredDuringExecution-（软限制）"><a href="#3、requiredDuringSchedulingIgnoredDuringExecution-（软限制）" class="headerlink" title="3、requiredDuringSchedulingIgnoredDuringExecution （软限制）"></a>3、requiredDuringSchedulingIgnoredDuringExecution （软限制）</h3><p><strong>优先调度到权重高且符合标签的node上面</strong></p><p><strong>接下来再演示一下</strong><code>&lt;span class=&quot;ne-text&quot;&gt;requiredDuringSchedulingIgnoredDuringExecution&lt;/span&gt;</code> ,（软限制-即优先调度到满足条件的上面）</p><p><strong>创建 pod-nodeaffinity-preferred.yaml</strong></p><ul><li><strong>权重weight的意思是设置权重优先调度到满足条件的节点上去、如果没有满足的则随便调度在那个节点</strong></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-nodeaffinity-preferred</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span> <span class="comment"># nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span>       <span class="comment"># 亲和性设置</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span> <span class="comment"># 设置node亲和性</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 软限制</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span> <span class="comment"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签(当前环境没有)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">kubectl create -f pod-nodeaffinity-preferred.yaml</span><br><span class="line"><span class="comment"># 查看pod状态 （运行成功）</span></span><br><span class="line">kubectl get pod pod-nodeaffinity-preferred -n dev -o wide</span><br><span class="line"></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP                NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-nodeaffinity-preferred   1/1     Running   0          54s   192.168.166.208   k8s1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p><strong>NodeAffinity规则设置的注意事项：</strong></p><ul><li><strong>如果同时定义了nodeSelector和nodeAffinity，那么</strong>必须两个条件都得到满足<strong>，Pod才能运行在指定的Node上</strong></li><li><strong>如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可</strong></li><li><strong>如果一个nodeSelectorTerms中有多个matchExpressions即有多个key值 ，则一个节点必须满足所有的才能匹配成功</strong></li><li><strong>如果一个pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的节点亲和性需求，则系统将忽略此变化</strong></li></ul><h3 id="4、PodAffinity（新创建的Pod跟参照pod在一个区域）"><a href="#4、PodAffinity（新创建的Pod跟参照pod在一个区域）" class="headerlink" title="4、PodAffinity（新创建的Pod跟参照pod在一个区域）"></a>4、PodAffinity（<strong>新创建的Pod跟参照pod在一个区域</strong>）</h3><ul><li><strong>PodAffinity主要实现以运行的Pod为参照，实现让新创建的Pod跟参照pod在一个区域的功能。</strong></li></ul><p><strong>首先来看一下</strong><code>&lt;span class=&quot;ne-text&quot;&gt;PodAffinity&lt;/span&gt;</code>的可配置项：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pod.spec.affinity.podAffinity</span><br><span class="line">  requiredDuringSchedulingIgnoredDuringExecution  硬限制</span><br><span class="line">    namespaces       指定参照pod的<span class="keyword">namespace</span></span><br><span class="line">    topologyKey      指定调度作用域</span><br><span class="line">    labelSelector    标签选择器</span><br><span class="line">      matchExpressions  按节点标签列出的节点选择器要求列表(推荐)</span><br><span class="line">        key    键</span><br><span class="line">        values 值</span><br><span class="line">        <span class="keyword">operator</span>     关系符 支持In, NotIn, Exists, DoesNotExist.</span><br><span class="line">      matchLabels    指多个matchExpressions映射的内容</span><br><span class="line">  preferredDuringSchedulingIgnoredDuringExecution 软限制</span><br><span class="line">    podAffinityTerm  选项</span><br><span class="line">      namespaces  </span><br><span class="line">      topologyKey</span><br><span class="line">      labelSelector</span><br><span class="line">        matchExpressions  </span><br><span class="line">          key    键</span><br><span class="line">          values 值</span><br><span class="line">          <span class="keyword">operator</span></span><br><span class="line">        matchLabels </span><br><span class="line">    weight 倾向权重，在范围<span class="number">1</span><span class="number">-100</span></span><br></pre></td></tr></table></figure><p><strong>topologyKey用于指定调度时作用域,例如:</strong></p><ul><li><strong>如果指定为 <strong>kubernetes.io/hostname</strong>，那就是以Node节点为区分范围</strong></li><li>**如果指定为 **beta.kubernetes.io/os <strong>,则以Node节点的操作系统类型来区分</strong></li></ul><h4 id="4-1、接下来，演示下requiredDuringSchedulingIgnoredDuringExecution"><a href="#4-1、接下来，演示下requiredDuringSchedulingIgnoredDuringExecution" class="headerlink" title="4.1、接下来，演示下requiredDuringSchedulingIgnoredDuringExecution,"></a>4.1、接下来，演示下<code>requiredDuringSchedulingIgnoredDuringExecution</code>,</h4><p><strong>1）首先创建一个参照Pod，pod-podaffinity-target.yaml：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-podaffinity-target</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">podenv:</span> <span class="string">pro</span> <span class="comment">#设置标签</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span> <span class="comment">#nginx:1.17.1</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">k8s1</span> <span class="comment"># node1 将目标pod名确指定到node1上</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动目标pod</span></span><br><span class="line">kubectl create -f pod-podaffinity-target.yaml</span><br><span class="line"><span class="comment"># 查看pod状况</span></span><br><span class="line">kubectl get pods  pod-podaffinity-target -n dev</span><br><span class="line"></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-podaffinity-target   1/1     Running   0          2m59s</span><br></pre></td></tr></table></figure><h4 id="4-2、创建pod-podaffinity-required-yaml，内容如下："><a href="#4-2、创建pod-podaffinity-required-yaml，内容如下：" class="headerlink" title="4.2、创建pod-podaffinity-required.yaml，内容如下："></a>4.2、创建pod-podaffinity-required.yaml，内容如下：</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-podaffinity-required</span>  <span class="comment"># pod名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span> <span class="comment">#nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span>      <span class="comment"># 亲和性设置</span></span><br><span class="line">    <span class="attr">podAffinity:</span> <span class="comment"># 设置pod亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 硬限制</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span>    <span class="comment"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">podenv</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure><p><strong>上面配置表达的意思是：</strong></p><ul><li><p><strong>新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上</strong>，查看节点是否有现这样的pod显然没有，接下来，运行测试一下。</p></li><li><p><strong>topologyKey: kubernetes.io/hostname 指定了用于亲和性匹配的拓扑键。这表示 Pod 会被调度到与其宿主节点具有相同主机名的节点上。</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_9ef6cc967fa4c5448054dc6a458f614f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_9ef6cc967fa4c5448054dc6a458f614f.png"></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动pod</span></span><br><span class="line">kubectl create -f pod-podaffinity-required.yaml</span><br><span class="line"><span class="comment"># 查看pod状态，发现未运行</span></span><br><span class="line">kubectl get pods pod-podaffinity-required -n dev</span><br><span class="line"><span class="comment"># 查看详细信息</span></span><br><span class="line">kubectl describe pods pod-podaffinity-required  -n dev</span><br><span class="line"><span class="comment"># 接下来修改  values: [&quot;xxx&quot;,&quot;yyy&quot;]-----&gt;values:[&quot;pro&quot;,&quot;yyy&quot;]</span></span><br><span class="line"><span class="comment"># 意思是：新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上</span></span><br><span class="line">vim pod-podaffinity-required.yaml</span><br><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line">...</span><br><span class="line">  affinity:  <span class="comment">#亲和性设置</span></span><br><span class="line">    podAffinity: <span class="comment">#设置pod亲和性</span></span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution: <span class="comment"># 硬限制</span></span><br><span class="line">      - labelSelector:</span><br><span class="line">          matchExpressions: <span class="comment"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span><br><span class="line">          - key: podenv</span><br><span class="line">            operator: In</span><br><span class="line">            values: [<span class="string">&quot;pro&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br><span class="line">        topologyKey: kubernetes.io/hostname</span><br><span class="line">...</span><br><span class="line"><span class="comment"># 然后重新创建pod，查看效果</span></span><br><span class="line">kubectl delete -f  pod-podaffinity-required.yaml</span><br><span class="line"></span><br><span class="line">kubectl create -f pod-podaffinity-required.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发现此时Pod运行正常</span></span><br><span class="line">kubectl get pods pod-podaffinity-required -n dev</span><br></pre></td></tr></table></figure><p><strong>可以看到和参照的pod在一起</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_bcaccda2eda73fbce6bb2e44712bbfe9.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_bcaccda2eda73fbce6bb2e44712bbfe9.png"></p><p><strong>关于</strong><code>PodAffinity</code>的 <code>preferredDuringSchedulingIgnoredDuringExecution</code>，这里不再演示。</p><h4 id="4-3、PodAntiAffinity（新创建的Pod跟参照pod不在一个区域）"><a href="#4-3、PodAntiAffinity（新创建的Pod跟参照pod不在一个区域）" class="headerlink" title="4.3、PodAntiAffinity（新创建的Pod跟参照pod不在一个区域）"></a>4.3、PodAntiAffinity（新创建的Pod跟参照pod不在一个区域）</h4><p><strong>PodAntiAffinity主要实现以运行的Pod为参照，让新创建的Pod跟参照pod不在一个区域中的功能。</strong></p><p><strong>它的配置方式和选项跟PodAffinty是一样的，这里不再做详细解释，直接做一个测试案例。</strong></p><h5 id="4-3-1、继续使用上个案例中目标pod"><a href="#4-3-1、继续使用上个案例中目标pod" class="headerlink" title="4.3.1、继续使用上个案例中目标pod"></a>4.3.1、继续使用上个案例中目标pod</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n dev -o wide --show-labels</span><br><span class="line"></span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE     IP            NODE   NOMINATED NODE   READINESS GATES   LABELS</span><br><span class="line">pod-podaffinity-required   1/1     Running   0          5m53s   172.16.0.54   k8s1   &lt;none&gt;           &lt;none&gt;            &lt;none&gt;</span><br><span class="line">pod-podaffinity-target     1/1     Running   0          21m     172.16.0.53   k8s1   &lt;none&gt;           &lt;none&gt;            podenv=pro</span><br></pre></td></tr></table></figure><h5 id="4-3-2、创建pod-podantiaffinity-required-yaml，内容如下："><a href="#4-3-2、创建pod-podantiaffinity-required-yaml，内容如下：" class="headerlink" title="4.3.2、创建pod-podantiaffinity-required.yaml，内容如下："></a>4.3.2、创建pod-podantiaffinity-required.yaml，内容如下：</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-podantiaffinity-required</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span> <span class="comment"># nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span>          <span class="comment"># 亲和性设置</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span> <span class="comment"># 设置pod亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 硬限制</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span>                           <span class="comment"># 匹配podenv的值在[&quot;pro&quot;]中的标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">podenv</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">&quot;pro&quot;</span>]</span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure><p><strong>上面配置表达的意思是：新Pod必须要与拥有标签nodeenv=pro的pod不在同一Node上，运行测试一下。</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">kubectl create -f pod-podantiaffinity-required.yaml</span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line"><span class="comment"># 发现调度到了node2上</span></span><br><span class="line">kubectl get pods pod-podantiaffinity-required -n dev -o wide</span><br><span class="line">....</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE   .. </span><br><span class="line">pod-podantiaffinity-required   1/1     Running   0          30s   10.244.1.96   node2  ..</span><br></pre></td></tr></table></figure><p><strong>如果都有pro标签时则会报错如下：</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_28aa58a6ca5b11dfe0c95c5d57d2274b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_28aa58a6ca5b11dfe0c95c5d57d2274b.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>11.1、定向调度（NodeName）</title>
      <link href="/2024/12/17/11.1%E3%80%81%E5%AE%9A%E5%90%91%E8%B0%83%E5%BA%A6%EF%BC%88NodeName%EF%BC%89/"/>
      <url>/2024/12/17/11.1%E3%80%81%E5%AE%9A%E5%90%91%E8%B0%83%E5%BA%A6%EF%BC%88NodeName%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="11-1、定向调度（NodeName）"><a href="#11-1、定向调度（NodeName）" class="headerlink" title="11.1、定向调度（NodeName）"></a>11.1、定向调度（NodeName）</h2><h5 id="5-4-1-定向调度"><a href="#5-4-1-定向调度" class="headerlink" title="5.4.1 定向调度"></a>5.4.1 定向调度</h5><p><strong>定向调度，指的是利用在pod上声明nodeName或者nodeSelector，以此将Pod调度到期望的node节点上。注意，这里的调度是强制的，这就意味着即使要调度的目标Node不存在，也会向上面进行调度，只不过pod运行失败而已。</strong></p><h2 id="一、定向调度"><a href="#一、定向调度" class="headerlink" title="一、定向调度"></a>一、定向调度</h2><h3 id="1、NodeName"><a href="#1、NodeName" class="headerlink" title="1、NodeName"></a>1、NodeName</h3><p><strong>NodeName用于强制约束将Pod调度到指定的Name的Node节点上。这种方式，其实是直接跳过Scheduler的调度逻辑，直接将Pod调度到指定名称的节点。</strong></p><p><strong>接下来，实验一下：创建一个pod-nodename.yaml文件</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-nodename</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span>  <span class="comment"># nginx:1.17.1</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node1</span>       <span class="comment"># 指定调度到node1节点上</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">kubectl create -f pod-nodename.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod调度到NODE属性，确实是调度到了node1节点上</span></span><br><span class="line">kubectl get pods pod-nodename -n dev -o wide</span><br><span class="line"></span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP            NODE      ......</span><br><span class="line">pod-nodename   1/1     Running   0          56s   10.244.1.87   node1     ......   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来，删除pod，修改nodeName的值为node3（并没有node3节点）</span></span><br><span class="line">kubectl delete -f pod-nodename.yaml</span><br><span class="line">vim pod-nodename.yaml </span><br><span class="line">// nodeName: node3</span><br><span class="line"></span><br><span class="line">kubectl create -f pod-nodename.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看，发现已经向Node3节点调度，但是由于不存在node3节点，所以pod无法正常运行</span></span><br><span class="line">kubectl get pods pod-nodename -n dev -o wide</span><br><span class="line"></span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    ......</span><br><span class="line">pod-nodename   0/1     Pending   0          6s    &lt;none&gt;   node3   ......</span><br></pre></td></tr></table></figure><h3 id="2、NodeSelector"><a href="#2、NodeSelector" class="headerlink" title="2、NodeSelector"></a>2、NodeSelector</h3><p><strong>NodeSelector用于将pod调度到添加了指定标签的node节点上。它是通过kubernetes的label-selector机制实现的，也就是说，在pod创建之前，会由scheduler使用MatchNodeSelector调度策略进行label匹配，找出目标node，然后将pod调度到目标节点，该匹配规则是强制约束。</strong></p><p><strong>接下来，实验一下：</strong></p><p><strong>1 首先分别为node节点添加标签</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes node1 nodeenv=pro</span><br><span class="line">kubectl label nodes node2 nodeenv=<span class="built_in">test</span></span><br></pre></td></tr></table></figure><p><strong>2 创建一个pod-nodeselector.yaml文件，并使用它创建Pod</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-nodeselector</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">nodeSelector:</span> </span><br><span class="line">    <span class="attr">nodeenv:</span> <span class="string">pro</span> <span class="comment"># 指定调度到具有nodeenv=pro标签的节点上</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">kubectl create -f pod-nodeselector.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod调度到NODE属性，确实是调度到了node1节点上</span></span><br><span class="line">kubectl get pods pod-nodeselector -n dev -o wide</span><br><span class="line"></span><br><span class="line">NAME               READY   STATUS    RESTARTS   AGE     IP          NODE    ......</span><br><span class="line">pod-nodeselector   1/1     Running   0          47s   10.244.1.87   node1   ......</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来，删除pod，修改nodeSelector的值为nodeenv: xxxx（不存在打有此标签的节点）</span></span><br><span class="line">kubectl delete -f pod-nodeselector.yaml</span><br><span class="line"></span><br><span class="line">vim pod-nodeselector.yaml</span><br><span class="line">kubectl create -f pod-nodeselector.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看，发现pod无法正常运行,Node的值为none</span></span><br><span class="line">kubectl get pods -n dev -o wide</span><br><span class="line"></span><br><span class="line">NAME               READY   STATUS    RESTARTS   AGE     IP       NODE  </span><br><span class="line">pod-nodeselector   0/1     Pending   0          2m20s   &lt;none&gt;   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详情,发现node selector匹配失败的提示</span></span><br><span class="line">kubectl describe pods pod-nodeselector -n dev</span><br><span class="line">.......</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age        From               Message</span><br><span class="line">  ----     ------            ----       ----               -------</span><br><span class="line">  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: 3 node(s) didn<span class="string">&#x27;t match node selector.</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_f9784e7b2d5ef85a96addb1f3daa1093.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_f9784e7b2d5ef85a96addb1f3daa1093.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>11、pod调度（策略指定需要调动到哪个节点）</title>
      <link href="/2024/12/17/11%E3%80%81pod%E8%B0%83%E5%BA%A6%EF%BC%88%E7%AD%96%E7%95%A5%E6%8C%87%E5%AE%9A%E9%9C%80%E8%A6%81%E8%B0%83%E5%8A%A8%E5%88%B0%E5%93%AA%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%89/"/>
      <url>/2024/12/17/11%E3%80%81pod%E8%B0%83%E5%BA%A6%EF%BC%88%E7%AD%96%E7%95%A5%E6%8C%87%E5%AE%9A%E9%9C%80%E8%A6%81%E8%B0%83%E5%8A%A8%E5%88%B0%E5%93%AA%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="11、pod调度（策略指定需要调动到哪个节点）"><a href="#11、pod调度（策略指定需要调动到哪个节点）" class="headerlink" title="11、pod调度（策略指定需要调动到哪个节点）"></a>11、pod调度（策略指定需要调动到哪个节点）</h2><h4 id="5-4-Pod调度"><a href="#5-4-Pod调度" class="headerlink" title="5.4 Pod调度"></a>5.4 Pod调度</h4><p><strong>在默认情况下，一个Pod在哪个Node节点上运行，是由Scheduler组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足的需求，因为很多情况下，我们想控制某些Pod到达某些节点上，那么应该怎么做呢？这就要求了解kubernetes对Pod的调度规则，kubernetes提供了四大类调度方式：</strong></p><ul><li><strong>自动调度：运行在哪个节点上完全由Scheduler经过一系列的算法计算得出</strong></li><li><strong>定向调度：NodeName、NodeSelector （缺点这个节点坏了就无法运行了）</strong></li><li><strong>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity （容器所在节点坏了会自动在相同标签下的节点重建）</strong></li><li><strong>污点（容忍）调度：Taints、Toleration</strong></li></ul>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>10.5、重启策略（restartPolicy）</title>
      <link href="/2024/12/17/10.5%E3%80%81%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5%EF%BC%88restartPolicy%EF%BC%89/"/>
      <url>/2024/12/17/10.5%E3%80%81%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5%EF%BC%88restartPolicy%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="10-5、重启策略（restartPolicy）"><a href="#10-5、重启策略（restartPolicy）" class="headerlink" title="10.5、重启策略（restartPolicy）"></a>10.5、重启策略（restartPolicy）</h2><p>在上一节中，一旦容器探测出现了问题，kubernetes就会对容器所在的Pod进行重启，其实这是由pod的重启策略决定的，pod的重启策略有 3 种，分别如下：</p><ul><li>Always ：容器失效时，自动重启该容器，这也是默认值。</li><li>OnFailure ： 容器终止运行且退出码不为0时重启</li><li>Never ： 不论状态为何，都不重启该容器</li></ul><p>重启策略适用于pod对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由kubelet延迟一段时间后进行，且反复的重启操作的延迟时长以此为10s、20s、40s、80s、160s和300s，300s是最大延迟时长。</p><p><strong>创建 pod-restartpolicy.yaml：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-restartpolicy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span> </span><br><span class="line">    <span class="comment"># nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">livenessProbe:</span>   <span class="comment"># 容器探测</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/hello</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span> <span class="comment"># 设置重启策略为Never</span></span><br></pre></td></tr></table></figure><p><strong>运行Pod测试</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">kubectl create -f pod-restartpolicy.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod详情，发现nginx容器失败</span></span><br><span class="line">kubectl  describe pods pod-restartpolicy  -n dev</span><br><span class="line">......</span><br><span class="line">  Warning  Unhealthy  15s (x3 over 35s)  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: 404</span><br><span class="line">  Normal   Killing    15s                kubelet, node1     Container nginx failed liveness probe</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 多等一会，再观察pod的重启次数，发现一直是0，并未重启   </span></span><br><span class="line">kubectl  get pods pod-restartpolicy -n dev</span><br><span class="line"></span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-restartpolicy      0/1     Running   0          5min42s</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s与docker及其他中间件面试题总结</title>
      <link href="/2024/12/08/k8s%E4%B8%8Edocker%E5%8F%8A%E5%85%B6%E4%BB%96%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93/"/>
      <url>/2024/12/08/k8s%E4%B8%8Edocker%E5%8F%8A%E5%85%B6%E4%BB%96%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="k8s与docker及其他中间件面试题总结"><a href="#k8s与docker及其他中间件面试题总结" class="headerlink" title="k8s与docker及其他中间件面试题总结"></a>k8s与docker及其他中间件面试题总结</h1><h2 id="一、k8s"><a href="#一、k8s" class="headerlink" title="一、k8s"></a>一、k8s</h2><h3 id="1、k8s有几种pod控制器"><a href="#1、k8s有几种pod控制器" class="headerlink" title="1、k8s有几种pod控制器"></a>1、k8s有几种pod控制器</h3><p>答：</p><p>k8s有8中pod控制器 分别为“ReplicaSet、deployment、StatefulSet、Horizontal Pod Autoscaler(HPA)、DaemonSet、Job、CronJob”</p><h3 id="2、滚动更新和版本回退"><a href="#2、滚动更新和版本回退" class="headerlink" title="2、滚动更新和版本回退"></a>2、滚动更新和版本回退</h3><p>答：</p><p>滚动更新就是杀死一部分就启动一部分在更新过程中存在两个版本Pod</p><p>版本回退就是 支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能 升级过程中出现问题则回退到上一个版本</p><h3 id="3、什么是灰度发布-蓝绿发布-金丝雀发布"><a href="#3、什么是灰度发布-蓝绿发布-金丝雀发布" class="headerlink" title="3、什么是灰度发布/蓝绿发布/金丝雀发布"></a>3、什么是灰度发布/蓝绿发布/金丝雀发布</h3><p>答：</p><p>有一批新的Pod资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的Pod应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的Pod资源滚动更新。</p><h3 id="4、k8s-cni-cri-csi-分别是什么"><a href="#4、k8s-cni-cri-csi-分别是什么" class="headerlink" title="4、k8s cni cri csi 分别是什么"></a>4、k8s cni cri csi 分别是什么</h3><p>答：</p><ul><li><strong>CNI（caclico、flannel、Weave Net）</strong>：负责 Pod 的网络连接，例如为新创建的 Pod 分配 IP，并确保 Pod 之间可以通信。</li><li><strong>CSI（nfs ceph AWS EBS）</strong>：为 Pod 提供存储资源，例如挂载持久化存储卷。</li><li><strong>CRI（Docker、cri-oz、container）</strong>：为 Pod 提供容器运行环境，例如拉取镜像并启动容器。</li></ul><h3 id="5、k8s有哪些存储"><a href="#5、k8s有哪些存储" class="headerlink" title="5、k8s有哪些存储"></a>5、k8s有哪些存储</h3><p>答：</p><p>EmptyDir、HostPath、NFS、Pv、Pvc、StorageClass、ConfigMap、Secret</p><h3 id="6、service有几种类型"><a href="#6、service有几种类型" class="headerlink" title="6、service有几种类型"></a>6、service有几种类型</h3><p>答：</p><p>CluSterIP、Headliness、NodePort、Loadbalancer、ExternalName</p><h2 id="二、docker"><a href="#二、docker" class="headerlink" title="二、docker"></a>二、docker</h2><h3 id="1、docker-cgroup是什么"><a href="#1、docker-cgroup是什么" class="headerlink" title="1、docker cgroup是什么"></a>1、docker cgroup是什么</h3><p>答：</p><p><code>cgroup</code>（Control Groups）是 Linux 内核的一项功能，用于限制、隔离和监控系统资源（如 CPU、内存、I/O 和网络）的使用。Docker 使用 <code>cgroup</code> 来实现容器的资源限制和隔离。</p><h3 id="2、怎样查看docker的资源占用情况"><a href="#2、怎样查看docker的资源占用情况" class="headerlink" title="2、怎样查看docker的资源占用情况"></a>2、怎样查看docker的资源占用情况</h3><ul><li>通过telegraf、prometheus等监控插件监控</li><li>使用命令docker stats监控</li></ul><h3 id="3、dockerfile有哪些保留字指令"><a href="#3、dockerfile有哪些保留字指令" class="headerlink" title="3、dockerfile有哪些保留字指令"></a>3、dockerfile有哪些保留字指令</h3><p>docker build -f /home/Dockerfile/Dockerfile -t zznn/telegraf .</p><table><thead><tr><th>Dockerfile 指令</th><th>说明</th></tr></thead><tbody><tr><td>FROM</td><td>指定基础镜像，用于后续的指令构建。</td></tr><tr><td>MAINTAINER</td><td>指定Dockerfile的作者/维护者。（已弃用，推荐使用LABEL指令）</td></tr><tr><td>LABEL</td><td>添加镜像的元数据，使用键值对的形式。</td></tr><tr><td>RUN</td><td>在构建过程中在镜像中执行命令。</td></tr><tr><td>CMD</td><td>指定容器创建时的默认命令。（可以被覆盖）</td></tr><tr><td>ENTRYPOINT</td><td>设置容器创建时的主要命令。（不可被覆盖）</td></tr><tr><td>EXPOSE</td><td>声明容器运行时监听的特定网络端口。</td></tr><tr><td>ENV</td><td>在容器内部设置环境变量。</td></tr><tr><td>ADD</td><td>将文件、目录或远程URL复制到镜像中。</td></tr><tr><td>COPY</td><td>将文件或目录复制到镜像中。</td></tr><tr><td>VOLUME</td><td>为容器创建挂载点或声明卷。</td></tr><tr><td>WORKDIR</td><td>设置后续指令的工作目录。</td></tr><tr><td>USER</td><td>指定后续指令的用户上下文。</td></tr><tr><td>ARG</td><td>定义在构建过程中传递给构建器的变量，可使用 “docker build” 命令设置。</td></tr><tr><td>ONBUILD</td><td>当该镜像被用作另一个构建过程的基础时，添加触发器。</td></tr><tr><td>STOPSIGNAL</td><td>设置发送给容器以退出的系统调用信号。</td></tr><tr><td>HEALTHCHECK</td><td>定义周期性检查容器健康状态的命令。</td></tr><tr><td>SHELL</td><td>覆盖Docker中默认的shell，用于RUN、CMD和ENTRYPOINT指令。</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>10.4、容器探测（exec TCPSoket HTTPGet）</title>
      <link href="/2024/12/04/10.4%E3%80%81%E5%AE%B9%E5%99%A8%E6%8E%A2%E6%B5%8B%EF%BC%88exec%20TCPSoket%20HTTPGet%EF%BC%89/"/>
      <url>/2024/12/04/10.4%E3%80%81%E5%AE%B9%E5%99%A8%E6%8E%A2%E6%B5%8B%EF%BC%88exec%20TCPSoket%20HTTPGet%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="10-4、容器探测（exec-TCPSoket-HTTPGet）"><a href="#10-4、容器探测（exec-TCPSoket-HTTPGet）" class="headerlink" title="10.4、容器探测（exec TCPSoket HTTPGet）"></a>10.4、容器探测（exec TCPSoket HTTPGet）</h2><h2 id="一、概览"><a href="#一、概览" class="headerlink" title="一、概览"></a>一、概览</h2><p><strong>容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么kubernetes就会把该问题实例” 摘除 “，不承担业务流量。kubernetes提供了两种探针来实现容器探测，分别是：</strong></p><ul><li><strong>liveness probes：存活性探针，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s会重启容器</strong></li><li><strong>readiness probes：就绪性探针，用于检测应用实例当前是否可以接收请求，如果不能，k8s不会转发流量</strong></li></ul><p><strong>livenessProbe 决定是否重启容器，readinessProbe 决定是否将请求转发给容器。</strong></p><p><strong>上面两种探针目前均支持三种探测方式：</strong></p><ul><li><strong>Exec命令：在容器内执行一次命令，如果命令执行的退出码为0，则认为程序正常，否则不正常</strong></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">……</span></span><br><span class="line">  <span class="attr">livenessProbe:</span></span><br><span class="line">    <span class="attr">exec:</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line"><span class="string">……</span></span><br></pre></td></tr></table></figure><ul><li><strong>TCPSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则不正常</strong></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">……</span>  </span><br><span class="line">  <span class="attr">livenessProbe:</span></span><br><span class="line">    <span class="attr">tcpSocket:</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">……</span></span><br></pre></td></tr></table></figure><ul><li><strong>HTTPGet：调用容器内Web应用的URL，如果返回的状态码在200和399之间，则认为程序正常，否则不正常</strong></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">……</span></span><br><span class="line">  <span class="attr">livenessProbe:</span></span><br><span class="line">    <span class="attr">httpGet:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/</span> <span class="comment">#URI地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span> <span class="comment">#端口号</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="comment">#主机地址</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">HTTP</span> <span class="comment">#支持的协议，http或者https</span></span><br><span class="line"><span class="string">……</span></span><br></pre></td></tr></table></figure><p><strong>下面以liveness probes为例，做几个演示：</strong></p><h2 id="二、执行方式"><a href="#二、执行方式" class="headerlink" title="二、执行方式"></a>二、执行方式</h2><h3 id="1、方式一：Exec"><a href="#1、方式一：Exec" class="headerlink" title="1、方式一：Exec"></a>1、方式一：Exec</h3><p><strong>创建pod-liveness-exec.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-liveness-exec</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span> <span class="comment"># nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/cat&quot;</span>,<span class="string">&quot;/tmp/hello.txt&quot;</span>] <span class="comment"># 执行一个查看文件的命令</span></span><br></pre></td></tr></table></figure><p><strong>创建pod，观察效果</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">pod-liveness-exec.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod详情</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">pods</span> <span class="string">pod-liveness-exec</span> <span class="string">-n</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line">  <span class="string">Normal</span>   <span class="string">Created</span>    <span class="string">20s</span> <span class="string">(x2</span> <span class="string">over</span> <span class="string">50s)</span>  <span class="string">kubelet,</span> <span class="string">node1</span>     <span class="string">Created</span> <span class="string">container</span> <span class="string">nginx</span></span><br><span class="line">  <span class="string">Normal</span>   <span class="string">Started</span>    <span class="string">20s</span> <span class="string">(x2</span> <span class="string">over</span> <span class="string">50s)</span>  <span class="string">kubelet,</span> <span class="string">node1</span>     <span class="string">Started</span> <span class="string">container</span> <span class="string">nginx</span></span><br><span class="line">  <span class="string">Normal</span>   <span class="string">Killing</span>    <span class="string">20s</span>                <span class="string">kubelet,</span> <span class="string">node1</span>     <span class="string">Container</span> <span class="string">nginx</span> <span class="string">failed</span> <span class="string">liveness</span> <span class="string">probe,</span> <span class="string">will</span> <span class="string">be</span> <span class="string">restarted</span></span><br><span class="line">  <span class="string">Warning</span>  <span class="string">Unhealthy</span>  <span class="string">0s</span> <span class="string">(x5</span> <span class="string">over</span> <span class="string">40s)</span>   <span class="string">kubelet,</span> <span class="attr">node1     Liveness probe failed: cat:</span> <span class="string">can&#x27;t</span> <span class="string">open</span> <span class="string">&#x27;/tmp/hello11.txt&#x27;</span><span class="string">:</span> <span class="literal">No</span> <span class="string">such</span> <span class="string">file</span> <span class="string">or</span> <span class="string">directory</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 观察上面的信息就会发现nginx容器启动之后就进行了健康检查</span></span><br><span class="line"><span class="comment"># 检查失败之后，容器被kill掉，然后尝试进行重启（这是重启策略的作用，后面讲解）</span></span><br><span class="line"><span class="comment"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">pod-liveness-exec</span> <span class="string">-n</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>                <span class="string">READY</span>   <span class="string">STATUS</span>             <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pod-liveness-exec</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">CrashLoopBackOff</span>   <span class="number">2</span>          <span class="string">3m19s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当然接下来，可以修改成一个存在的文件，比如/tmp/hello.txt，再试，结果就正常了......</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_808501ef065eab0e4598ef658faa491c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_808501ef065eab0e4598ef658faa491c.png"></p><h3 id="2、方式二：TCPSocket"><a href="#2、方式二：TCPSocket" class="headerlink" title="2、方式二：TCPSocket"></a>2、方式二：TCPSocket</h3><p><strong>创建 pod-liveness-tcpsocket.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-liveness-tcpsocket</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span>  <span class="comment"># nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span> <span class="comment"># 尝试访问8080端口</span></span><br></pre></td></tr></table></figure><p><strong>创建pod，观察效果</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">kubectl create -f pod-liveness-tcpsocket.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod详情</span></span><br><span class="line">kubectl describe pods pod-liveness-tcpsocket -n dev</span><br><span class="line">......</span><br><span class="line">  Normal   Scheduled  31s                            default-scheduler  Successfully assigned dev/pod-liveness-tcpsocket to node2</span><br><span class="line">  Normal   Pulled     &lt;invalid&gt;                      kubelet, node2     Container image <span class="string">&quot;nginx:1.17.1&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    &lt;invalid&gt;                      kubelet, node2     Created container nginx</span><br><span class="line">  Normal   Started    &lt;invalid&gt;                      kubelet, node2     Started container nginx</span><br><span class="line">  Warning  Unhealthy  &lt;invalid&gt; (x2 over &lt;invalid&gt;)  kubelet, node2     Liveness probe failed: dial tcp 10.244.2.44:8080: connect: connection refused</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 观察上面的信息，发现尝试访问8080端口,但是失败了</span></span><br><span class="line"><span class="comment"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span></span><br><span class="line">kubectl get pods pod-liveness-tcpsocket  -n dev</span><br><span class="line"></span><br><span class="line">NAME                     READY   STATUS             RESTARTS   AGE</span><br><span class="line">pod-liveness-tcpsocket   0/1     CrashLoopBackOff   2          3m19s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当然接下来，可以修改成一个可以访问的端口，比如80，再试，结果就正常了......</span></span><br></pre></td></tr></table></figure><h3 id="3、方式三：HTTPGet"><a href="#3、方式三：HTTPGet" class="headerlink" title="3、方式三：HTTPGet"></a>3、方式三：HTTPGet</h3><p><strong>创建 pod-liveness-httpget.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-liveness-httpget</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span>       <span class="comment"># 其实就是访问http://127.0.0.1:80/hello  </span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span> <span class="comment"># 支持的协议，http或者https</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span>     <span class="comment"># 端口号</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/hello</span> <span class="comment"># URI地址</span></span><br></pre></td></tr></table></figure><p><strong>创建pod，观察效果</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">kubectl create -f pod-liveness-httpget.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod详情</span></span><br><span class="line">kubectl describe pod pod-liveness-httpget -n dev</span><br><span class="line">.......</span><br><span class="line">  Normal   Pulled     6s (x3 over 64s)  kubelet, node1     Container image <span class="string">&quot;nginx:1.17.1&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    6s (x3 over 64s)  kubelet, node1     Created container nginx</span><br><span class="line">  Normal   Started    6s (x3 over 63s)  kubelet, node1     Started container nginx</span><br><span class="line">  Warning  Unhealthy  6s (x6 over 56s)  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: 404</span><br><span class="line">  Normal   Killing    6s (x2 over 36s)  kubelet, node1     Container nginx failed liveness probe, will be restarted</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 观察上面信息，尝试访问路径，但是未找到,出现404错误</span></span><br><span class="line"><span class="comment"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span></span><br><span class="line">kubectl get pod pod-liveness-httpget -n dev</span><br><span class="line"></span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-liveness-httpget   1/1     Running   5          3m17s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当然接下来，可以修改成一个可以访问的路径path，比如/，再试，结果就正常了......</span></span><br></pre></td></tr></table></figure><p><strong>至此，已经使用liveness Probe演示了三种探测方式，但是查看livenessProbe的子属性，会发现除了这三种方式，还有一些其他的配置，在这里一并解释下：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl explain pod.spec.containers.livenessProbe</span></span><br><span class="line">FIELDS:</span><br><span class="line">   <span class="built_in">exec</span> &lt;Object&gt;  </span><br><span class="line">   tcpSocket    &lt;Object&gt;</span><br><span class="line">   httpGet      &lt;Object&gt;</span><br><span class="line">   initialDelaySeconds  &lt;<span class="built_in">integer</span>&gt;  <span class="comment"># 容器启动后等待多少秒执行第一次探测</span></span><br><span class="line">   timeoutSeconds       &lt;<span class="built_in">integer</span>&gt;  <span class="comment"># 探测超时时间。默认1秒，最小1秒</span></span><br><span class="line">   periodSeconds        &lt;<span class="built_in">integer</span>&gt;  <span class="comment"># 执行探测的频率。默认是10秒，最小1秒</span></span><br><span class="line">   failureThreshold     &lt;<span class="built_in">integer</span>&gt;  <span class="comment"># 连续探测失败多少次才被认定为失败。默认是3。最小值是1</span></span><br><span class="line">   successThreshold     &lt;<span class="built_in">integer</span>&gt;  <span class="comment"># 连续探测成功多少次才被认定为成功。默认是1</span></span><br></pre></td></tr></table></figure><p><strong>下面稍微配置两个，演示下效果即可：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># more pod-liveness-httpget.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-liveness-httpget</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span> </span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">30</span> <span class="comment"># 容器启动后30s开始探测</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">5</span> <span class="comment"># 探测超时时间为5s</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>10.3、钩子函数（exec）</title>
      <link href="/2024/12/04/10.3%E3%80%81%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%EF%BC%88exec%EF%BC%89/"/>
      <url>/2024/12/04/10.3%E3%80%81%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%EF%BC%88exec%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="10-3、钩子函数（exec）"><a href="#10-3、钩子函数（exec）" class="headerlink" title="10.3、钩子函数（exec）"></a>10.3、钩子函数（exec）</h2><h5 id="5-3-3-钩子函数"><a href="#5-3-3-钩子函数" class="headerlink" title="5.3.3 钩子函数"></a>5.3.3 钩子函数</h5><p><strong>钩子函数能够感知自身生命周期中的事件，并在相应的时刻到来时运行用户指定的程序代码。</strong></p><p><strong>kubernetes在主容器的启动之后和停止之前提供了两个钩子函数：</strong></p><ul><li><strong>post start：容器创建之后执行，如果失败了会重启容器</strong></li><li><strong>pre stop ：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</strong></li></ul><p><strong>钩子处理器支持使用下面三种方式定义动作：</strong></p><ul><li><strong>Exec命令：在容器内执行一次命令</strong></li><li><strong>相当于 docker 中 docker exec -it centos ls 这样的命令</strong></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">……</span></span><br><span class="line">  <span class="attr">lifecycle:</span></span><br><span class="line">    <span class="attr">postStart:</span> </span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line"><span class="string">……</span></span><br></pre></td></tr></table></figure><ul><li><strong>TCPSocket：在当前容器尝试访问指定的socket</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">……  </span><br><span class="line">  lifecycle:</span><br><span class="line">    postStart:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">……</span><br></pre></td></tr></table></figure><ul><li><strong>HTTPGet：在当前容器中向某url发起http请求</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line">  lifecycle:</span><br><span class="line">    postStart:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: / <span class="comment">#URI地址</span></span><br><span class="line">        port: 80 <span class="comment">#端口号</span></span><br><span class="line">        host: 192.168.5.3 <span class="comment">#主机地址</span></span><br><span class="line">        scheme: HTTP <span class="comment">#支持的协议，http或者https</span></span><br><span class="line">……</span><br></pre></td></tr></table></figure><p><strong>接下来，以exec方式为例，演示下钩子函数的使用，创建pod-hook-exec.yaml文件，内容如下：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-hook-exec</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span> <span class="comment"># nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span> </span><br><span class="line">        <span class="attr">exec:</span> <span class="comment"># 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo postStart... &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="comment"># 在容器停止之前停止nginx服务</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/usr/sbin/nginx&quot;</span>,<span class="string">&quot;-s&quot;</span>,<span class="string">&quot;quit&quot;</span>]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">kubectl create -f pod-hook-exec.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">kubectl get pods  pod-hook-exec -n dev -o wide</span><br><span class="line"></span><br><span class="line">NAME           READY   STATUS     RESTARTS   AGE    IP            NODE  </span><br><span class="line">pod-hook-exec  1/1     Running    0          29s    10.244.2.48   node2   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问pod</span></span><br><span class="line">curl 172.16.0.39</span><br><span class="line"></span><br><span class="line">postStart...</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_3110e799fd7a8f2fcdf6df765798f473.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_3110e799fd7a8f2fcdf6df765798f473.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>10.2、初始化容器（启动顺序）</title>
      <link href="/2024/12/04/10.2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%B9%E5%99%A8%EF%BC%88%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F%EF%BC%89/"/>
      <url>/2024/12/04/10.2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%B9%E5%99%A8%EF%BC%88%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="10-2、初始化容器（启动顺序）"><a href="#10-2、初始化容器（启动顺序）" class="headerlink" title="10.2、初始化容器（启动顺序）"></a>10.2、初始化容器（启动顺序）</h2><h5 id="5-3-2-初始化容器"><a href="#5-3-2-初始化容器" class="headerlink" title="5.3.2 初始化容器"></a>5.3.2 初始化容器</h5><p>初始化容器是在 <strong>pod</strong> <strong>的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</strong></p><ol><li><strong>初始化容器必须运行完成直至结束，若某初始化容器运行失败，那么kubernetes需要重启它直到成功完成</strong></li><li>初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行</li><li><strong>相当于docker中 的 depond on</strong></li></ol><p><strong>初始化容器有很多的应用场景，下面列出的是最常见的几个：</strong></p><ul><li><strong>提供主容器镜像中不具备的工具程序或自定义代码</strong></li><li><strong>初始化容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足</strong></li></ul><p><strong>接下来做一个案例，模拟下面这个需求：</strong></p><p><strong>假设要以主容器来运行nginx，但是要求在运行nginx之前先要能够连接上mysql和redis所在服务器</strong></p><p><strong>为了简化测试，事先规定好mysql</strong><code>(192.168.90.14)</code>和redis<code>(192.168.90.15)</code>服务器的地址</p><p><strong>创建pod-initcontainer.yaml，内容如下：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-initcontainer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-mysql</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until ping 192.168.90.14 -c 1 ; do echo waiting for mysql...; sleep 2; done;&#x27;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-redis</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until ping 192.168.90.15 -c 1 ; do echo waiting for reids...; sleep 2; done;&#x27;</span>]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">kubectl create -f pod-initcontainer.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod状态</span></span><br><span class="line"><span class="comment"># 发现pod卡在启动第一个初始化容器过程中，后面的容器不会运行</span></span><br><span class="line">kubectl describe pod  pod-initcontainer -n dev</span><br><span class="line">........</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  49s   default-scheduler  Successfully assigned dev/pod-initcontainer to node1</span><br><span class="line">  Normal  Pulled     48s   kubelet, node1     Container image <span class="string">&quot;busybox:1.30&quot;</span> already present on machine</span><br><span class="line">  Normal  Created    48s   kubelet, node1     Created container test-mysql</span><br><span class="line">  Normal  Started    48s   kubelet, node1     Started container test-mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态查看pod</span></span><br><span class="line">kubectl get pods pod-initcontainer -n dev -w</span><br><span class="line"></span><br><span class="line">NAME                             READY   STATUS     RESTARTS   AGE</span><br><span class="line">pod-initcontainer                0/1     Init:0/2   0          15s</span><br><span class="line">pod-initcontainer                0/1     Init:1/2   0          52s</span><br><span class="line">pod-initcontainer                0/1     Init:1/2   0          53s</span><br><span class="line">pod-initcontainer                0/1     PodInitializing   0          89s</span><br><span class="line">pod-initcontainer                1/1     Running           0          90s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来新开一个shell，为当前服务器新增两个ip，观察pod的变化</span></span><br><span class="line">ifconfig ens33:1 192.168.90.14 netmask 255.255.255.0 up</span><br><span class="line">ifconfig ens33:2 192.168.90.15 netmask 255.255.255.0 up</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>10.1、pod创建和停止</title>
      <link href="/2024/12/04/10.1%E3%80%81pod%E5%88%9B%E5%BB%BA%E5%92%8C%E5%81%9C%E6%AD%A2/"/>
      <url>/2024/12/04/10.1%E3%80%81pod%E5%88%9B%E5%BB%BA%E5%92%8C%E5%81%9C%E6%AD%A2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="10-1、pod创建和停止"><a href="#10-1、pod创建和停止" class="headerlink" title="10.1、pod创建和停止"></a>10.1、pod创建和停止</h2><p><strong>pod的创建过程</strong></p><ol><li><strong>用户通过kubectl或其他api客户端提交需要创建的pod信息给apiServer</strong></li><li><strong>apiServer开始生成pod对象的信息，并将信息存入etcd，然后返回确认信息至客户端</strong></li><li><strong>apiServer开始反映etcd中的pod对象的变化，其它组件使用watch机制来跟踪检查apiServer上的变动</strong></li><li><strong>scheduler发现有新的pod对象要创建，开始为Pod分配主机并将结果信息更新至apiServer</strong></li><li><strong>node节点上的kubelet发现有pod调度过来，尝试调用docker启动容器，并将结果回送至apiServer</strong></li><li><strong>apiServer将接收到的pod状态信息存入etcd中</strong></li></ol><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_9516d9c15d037af232b1f94ed0f31438.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_9516d9c15d037af232b1f94ed0f31438.png"></p><p><strong>pod的终止过程</strong></p><ol><li><strong>用户向apiServer发送删除pod对象的命令</strong></li><li><strong>apiServcer中的pod对象信息会随着时间的推移而更新，在宽限期内（默认30s），pod被视为dead</strong></li><li><strong>将pod标记为terminating状态</strong></li><li><strong>kubelet在监控到pod对象转为terminating状态的同时启动pod关闭过程</strong></li><li><strong>端点控制器监控到pod对象的关闭行为时将其从所有匹配到此端点的service资源的端点列表中移除</strong></li><li><strong>如果当前pod对象定义了preStop钩子处理器，则在其标记为terminating后即会以同步的方式启动执行</strong></li><li><strong>pod对象中的容器进程收到停止信号</strong></li><li><strong>宽限期结束后，若pod中还存在仍在运行的进程，那么pod对象会收到立即终止的信号</strong></li><li><strong>kubelet请求apiServer将此pod资源的宽限期设置为0从而完成删除操作，此时pod对于用户已不可见</strong></li></ol>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>10、Pod生命周期</title>
      <link href="/2024/12/04/10%E3%80%81Pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"/>
      <url>/2024/12/04/10%E3%80%81Pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="10、Pod生命周期"><a href="#10、Pod生命周期" class="headerlink" title="10、Pod生命周期"></a>10、Pod生命周期</h2><h4 id="Pod生命周期"><a href="#Pod生命周期" class="headerlink" title="Pod生命周期"></a>Pod生命周期</h4><p><strong>我们一般将pod对象从创建至终的这段时间范围称为pod的生命周期，它主要包含下面的过程：</strong></p><ul><li><p><strong>pod创建过程</strong></p></li><li><p><strong>运行初始化容器（init container）过程</strong></p></li><li><p><strong>运行主容器（main container）</strong></p><ul><li><strong>容器启动后钩子（post start）、容器终止前钩子（pre stop）</strong></li><li><strong>容器的存活性探测（liveness probe）、就绪性探测（readiness probe）</strong></li></ul></li><li><p><strong>pod终止过程</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_373e4ff02d0b24e0ea4ed3bce107200a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_373e4ff02d0b24e0ea4ed3bce107200a.png"></p></li></ul><p>在整个生命周期中，Pod会出现5种<strong><strong>状态</strong></strong>（<strong><strong>相位</strong></strong>），分别如下：</p><ul><li><strong>挂起（Pending）：apiserver已经创建了pod资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中</strong></li><li><strong>运行中（Running）：pod已经被调度至某节点，并且所有容器都已经被kubelet创建完成</strong></li><li><strong>成功（Succeeded）：pod中的所有容器都已经成功终止并且不会被重启</strong></li><li><strong>失败（Failed）：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非0值的退出状态</strong></li><li><strong>未知（Unknown）：apiserver无法正常获取到pod对象的状态信息，通常由网络通信失败所导致</strong></li></ul>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>9.6、资源配额（limits）</title>
      <link href="/2024/12/04/9.6%E3%80%81%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%EF%BC%88limits%EF%BC%89/"/>
      <url>/2024/12/04/9.6%E3%80%81%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%EF%BC%88limits%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="9-6、资源配额（limits）"><a href="#9-6、资源配额（limits）" class="headerlink" title="9.6、资源配额（limits）"></a>9.6、资源配额（limits）</h2><h5 id="5-2-6-资源配额（dcoker类似）"><a href="#5-2-6-资源配额（dcoker类似）" class="headerlink" title="5.2.6 资源配额（dcoker类似）"></a>5.2.6 资源配额（dcoker类似）</h5><p><strong>容器中的程序要运行，肯定是要占用一定资源的，比如</strong> cpu** 和内存等，如果不对某个容器的资源做限制，那么它就可能吃掉大量资源，导致其它容器无法运行。针对这种情况，**kubernetes <strong>提供了对内存和 <strong>cpu</strong> 的资源进行配额的机制，这种机制主要通过</strong> resources <strong>选项实现，他有两个子选项：</strong></p><ul><li>limits：用于限制运行时容器的最大占用资源，当容器占用资源超过limits时会被终止，并进行重启</li><li>requests ：用于设置容器需要的最小资源，如果环境资源不够，容器将无法启动</li></ul><p><strong>可以通过上面两个选项设置资源的上下限。</strong></p><p>接下来，编写一个测试案例，创建 pod-resources.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-resources</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span> <span class="comment"># nginx:1.17.1</span></span><br><span class="line">    <span class="attr">resources:</span>   <span class="comment"># 资源配额</span></span><br><span class="line">      <span class="attr">limits:</span>    <span class="comment"># 限制资源（上限）</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span> <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;10Gi&quot;</span> <span class="comment"># 内存限制</span></span><br><span class="line">      <span class="attr">requests:</span>        <span class="comment"># 请求资源（下限）</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span>       <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;10Mi&quot;</span> <span class="comment"># 内存限制</span></span><br></pre></td></tr></table></figure><p><strong>docker例子资源配额限制则为：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span>  </span><br><span class="line">  <span class="attr">openvpn:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kylemanna/openvpn</span></span><br><span class="line">           <span class="comment"># registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:kylemanna_openvpn-v1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">openvpn</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;21194:1194/udp&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./openvpn-data:/etc/openvpn</span></span><br><span class="line">    <span class="attr">cap_add:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">100M</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&#x27;0.1&#x27;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">100M</span></span><br></pre></td></tr></table></figure><p><strong>在这对cpu和memory的单位做一个说明：</strong></p><ul><li><strong>cpu：core数，可以为整数或小数</strong></li><li><strong>memory： 内存大小，可以使用Gi、Mi、G、M等形式</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行Pod</span></span><br><span class="line">kubectl create  -f pod-resources.yaml</span><br><span class="line"><span class="comment"># 查看发现pod运行正常</span></span><br><span class="line">kubectl get pod pod-resources -n dev </span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来，停止Pod</span></span><br><span class="line">kubectl delete  -f pod-resources.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑pod，修改resources.requests.memory的值为10Gi</span></span><br><span class="line">vim pod-resources.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次启动pod</span></span><br><span class="line">kubectl create  -f pod-resources.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod状态，发现Pod启动失败</span></span><br><span class="line">kubectl get pod pod-resources -n dev -o wide</span><br><span class="line"></span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE    </span><br><span class="line">pod-resources   0/1     Pending   0          20s  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod详情会发现，如下提示</span></span><br><span class="line">kubectl describe pod pod-resources -n dev</span><br><span class="line">......</span><br><span class="line">Warning  FailedScheduling  35s   default-scheduler  0/3 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class="string">&#x27;t tolerate, 2 Insufficient memory.(内存不足)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>9.5、端口配置（ports）</title>
      <link href="/2024/12/04/9.5%E3%80%81%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%EF%BC%88ports%EF%BC%89/"/>
      <url>/2024/12/04/9.5%E3%80%81%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%EF%BC%88ports%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="9-5、端口配置（ports）"><a href="#9-5、端口配置（ports）" class="headerlink" title="9.5、端口配置（ports）"></a>9.5、端口配置（ports）</h2><h5 id="5-2-5-端口设置"><a href="#5-2-5-端口设置" class="headerlink" title="5.2.5 端口设置"></a>5.2.5 端口设置</h5><p>本小节来介绍容器的端口设置，也就是 containers 的 ports <strong>选项。</strong></p><p><strong>首先看下ports支持的子选项：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl explain pod.spec.containers.ports</span></span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: ports &lt;[]Object&gt;</span><br><span class="line">FIELDS:</span><br><span class="line">   name         &lt;string&gt;  <span class="comment"># 端口名称，如果指定，必须保证name在pod中是唯一的</span></span><br><span class="line">   containerPort&lt;<span class="built_in">integer</span>&gt; <span class="comment"># 容器要监听的端口(0&lt;x&lt;65536)</span></span><br><span class="line">   hostPort     &lt;<span class="built_in">integer</span>&gt; <span class="comment"># 容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本(一般省略) </span></span><br><span class="line">   hostIP       &lt;string&gt;  <span class="comment"># 要将外部端口绑定到的主机IP(一般省略)</span></span><br><span class="line">   protocol     &lt;string&gt;  <span class="comment"># 端口协议。必须是UDP、TCP或SCTP。默认为“TCP”。</span></span><br></pre></td></tr></table></figure><p><strong>接下来，编写一个测试案例，创建 pod-ports.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-ports</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span> <span class="comment"># nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span> <span class="comment"># 设置容器暴露的端口列表</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">kubectl create -f pod-ports.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line"><span class="comment"># 在下面可以明显看到配置信息</span></span><br><span class="line">kubectl get pod pod-ports -n dev -o yaml</span><br><span class="line">......</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: nginx</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      name: nginx-port</span><br><span class="line">      protocol: TCP</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p><strong>访问容器中的程序需要使用的是</strong><code>Podip:containerPort</code></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>9.4、环境变量（env）</title>
      <link href="/2024/12/04/9.4%E3%80%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%EF%BC%88env%EF%BC%89/"/>
      <url>/2024/12/04/9.4%E3%80%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%EF%BC%88env%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="9-4、环境变量（env）"><a href="#9-4、环境变量（env）" class="headerlink" title="9.4、环境变量（env）"></a>9.4、环境变量（env）</h2><h3 id="1、创建pod-env-yaml文件，内容如下："><a href="#1、创建pod-env-yaml文件，内容如下：" class="headerlink" title="1、创建pod-env.yaml文件，内容如下："></a>1、创建pod-env.yaml文件，内容如下：</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-env</span>    <span class="comment"># pod名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>   <span class="comment"># ns</span></span><br><span class="line">  <span class="attr">labels:</span>          <span class="comment"># 标签</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;3.0&quot;</span> </span><br><span class="line">    <span class="attr">env:</span> <span class="string">&quot;busybox&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:busybox-1.30</span> <span class="comment">#busybox:1.30</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span>  <span class="comment"># 镜像拉取策略</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;while true;do /bin/echo $(date +%T);sleep 60; done;&quot;</span>]</span><br><span class="line">    <span class="attr">env:</span>                     <span class="comment"># 设置环境变量列表</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;username&quot;</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;password&quot;</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;123456&quot;</span></span><br></pre></td></tr></table></figure><p><strong>备注：env，环境变量，用于在pod中的容器设置环境变量。</strong></p><h3 id="2、验证"><a href="#2、验证" class="headerlink" title="2、验证"></a>2、验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">kubectl create -f pod-env.yaml</span><br><span class="line"><span class="comment"># 进入容器，输出环境变量</span></span><br><span class="line">kubectl <span class="built_in">exec</span> pod-env -n dev -c busybox -it /bin/sh</span><br><span class="line">/ <span class="comment"># echo $username</span></span><br><span class="line">admin</span><br><span class="line">/ <span class="comment"># echo $password</span></span><br><span class="line">123456</span><br></pre></td></tr></table></figure><p>这种方式不是很推荐，推荐将这些配置单独存储在配置文件中，这种方式将在后面介绍。**</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_09105f30b43497e9e5af6cd544a09314.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_09105f30b43497e9e5af6cd544a09314.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>9.3、启动命令（command）</title>
      <link href="/2024/12/04/9.3%E3%80%81%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4%EF%BC%88command%EF%BC%89/"/>
      <url>/2024/12/04/9.3%E3%80%81%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4%EF%BC%88command%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="9-3、启动命令（command）"><a href="#9-3、启动命令（command）" class="headerlink" title="9.3、启动命令（command）"></a>9.3、启动命令（command）</h2><p><strong>在前面的案例中，一直有一个问题没有解决，就是的busybox容器一直没有成功运行，那么到底是什么原因导致这个容器的故障呢？</strong></p><p><strong>原来busybox并不是一个程序，而是类似于一个工具类的集合，kubernetes集群启动管理后，它会自动关闭。解决方法就是让其一直在运行，这就用到了command配置。</strong></p><h3 id="1、创建pod-command-yaml文件，内容如下："><a href="#1、创建pod-command-yaml文件，内容如下：" class="headerlink" title="1、创建pod-command.yaml文件，内容如下："></a>1、创建pod-command.yaml文件，内容如下：</h3><ul><li><strong>文件中镜像拉取策略对本文件所有镜像拉取有效</strong></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-command</span>  <span class="comment"># pod名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:busybox-1.30</span> <span class="comment">#busybox:1.30</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span> <span class="comment"># 用于设置镜像拉取策略</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done;&quot;</span>]</span><br></pre></td></tr></table></figure><p><strong>command，用于在pod中的容器初始化完毕之后运行一个命令。</strong></p><p><strong>稍微解释下上面命令的意思：</strong></p><p><strong>“/bin/sh”,”-c”, 使用sh执行命令</strong></p><p><strong>touch /tmp/hello.txt; 创建一个/tmp/hello.txt 文件</strong></p><p><strong>while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done; 每隔3秒向文件中写入当前时间</strong></p><h3 id="2、验证命令是否生效："><a href="#2、验证命令是否生效：" class="headerlink" title="2、验证命令是否生效："></a>2、验证命令是否生效：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">[root@k8s-master01 pod]<span class="comment"># kubectl create  -f pod-command.yaml</span></span><br><span class="line">pod/pod-command created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod状态</span></span><br><span class="line"><span class="comment"># 此时发现两个pod都正常运行了</span></span><br><span class="line">[root@k8s-master01 pod]<span class="comment"># kubectl get pods pod-command -n dev</span></span><br><span class="line">NAME          READY   STATUS   RESTARTS   AGE</span><br><span class="line">pod-command   2/2     Runing   0          2s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入pod中的busybox容器，查看文件内容</span></span><br><span class="line"><span class="comment"># 补充一个命令: kubectl exec  pod名称 -n 命名空间 -it -c 容器名称 /bin/sh  在容器内部执行命令</span></span><br><span class="line"><span class="comment"># 使用这个命令就可以进入某个容器的内部，然后进行相关操作了</span></span><br><span class="line"><span class="comment"># 比如，可以查看txt文件的内容</span></span><br><span class="line">[root@k8s-master01 pod]<span class="comment"># kubectl exec pod-command -n dev -it -c busybox /bin/sh</span></span><br><span class="line">/ <span class="comment"># tail -f /tmp/hello.txt</span></span><br><span class="line">14:44:19</span><br><span class="line">14:44:22</span><br><span class="line">14:44:25</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_15b91bcf5510e0501dd3ca636f492e47.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_15b91bcf5510e0501dd3ca636f492e47.png"></p><p><strong>特别说明：</strong></p><p>通过上面发现command已经可以完成启动命令和传递参数的功能，为什么这里还要提供一个args选项，用于传递参数呢?这其实跟docker有点关系，kubernetes中的command、args两项其实是实现覆盖Dockerfile中ENTRYPOINT的功能。</p><ul><li>如果<strong>command</strong>和<strong>args</strong>均没有写，那么用Dockerfile的配置。</li><li>如果command写了，但args没有写，那么Dockerfile默认的配置会被忽略，执行输入的command</li><li>如果command没写，但args写了，那么Dockerfile中配置的ENTRYPOINT的命令会被执行，使用当前args的参数</li><li><strong>如果command和args都写了，那么Dockerfile的配置被忽略，执行command并追加上args参数</strong></li></ul>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>9.2、镜像拉取策略（imagePullPolicy）</title>
      <link href="/2024/12/04/9.2%E3%80%81%E9%95%9C%E5%83%8F%E6%8B%89%E5%8F%96%E7%AD%96%E7%95%A5%EF%BC%88imagePullPolicy%EF%BC%89/"/>
      <url>/2024/12/04/9.2%E3%80%81%E9%95%9C%E5%83%8F%E6%8B%89%E5%8F%96%E7%AD%96%E7%95%A5%EF%BC%88imagePullPolicy%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="9-2、镜像拉取策略（imagePullPolicy）"><a href="#9-2、镜像拉取策略（imagePullPolicy）" class="headerlink" title="9.2、镜像拉取策略（imagePullPolicy）"></a>9.2、镜像拉取策略（imagePullPolicy）</h2><p><strong>创建 pod-imagepullpolicy.yaml 文件，内容如下：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-imagepullpolicy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span> <span class="comment"># 用于设置镜像拉取策略</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:busybox-1.30</span> <span class="comment"># busybox:1.30</span></span><br></pre></td></tr></table></figure><p><strong>imagePullPolicy，用于设置镜像拉取策略，kubernetes支持配置三种拉取策略：</strong></p><ul><li>Always：总是从远程仓库拉取镜像（一直远程下载）</li><li>IfNotPresent：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像（本地有就本地 本地没远程下载）</li><li>Never：只使用本地镜像，从不去远程仓库拉取，本地没有就报错 （一直使用本地）</li></ul><p><strong>默认值说明：</strong></p><p><strong>如果镜像tag为具体版本号， 默认策略是：IfNotPresent</strong></p><p>如果镜像tag为：latest（最终版本） ，默认策略是always</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">[root@k8s-master01 pod]<span class="comment"># kubectl create -f pod-imagepullpolicy.yaml</span></span><br><span class="line">pod/pod-imagepullpolicy created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod详情</span></span><br><span class="line"><span class="comment"># 此时明显可以看到nginx镜像有一步Pulling image &quot;nginx:1.17.1&quot;的过程</span></span><br><span class="line">[root@k8s-master01 pod]<span class="comment"># kubectl describe pod pod-imagepullpolicy -n dev</span></span><br><span class="line">......</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age               From               Message</span><br><span class="line">  ----     ------     ----              ----               -------</span><br><span class="line">  Normal   Scheduled  &lt;unknown&gt;         default-scheduler  Successfully assigned dev/pod-imagePullPolicy to node1</span><br><span class="line">  Normal   Pulling    32s               kubelet, node1     Pulling image <span class="string">&quot;nginx:1.17.1&quot;</span></span><br><span class="line">  Normal   Pulled     26s               kubelet, node1     Successfully pulled image <span class="string">&quot;nginx:1.17.1&quot;</span></span><br><span class="line">  Normal   Created    26s               kubelet, node1     Created container nginx</span><br><span class="line">  Normal   Started    25s               kubelet, node1     Started container nginx</span><br><span class="line">  Normal   Pulled     7s (x3 over 25s)  kubelet, node1     Container image <span class="string">&quot;busybox:1.30&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    7s (x3 over 25s)  kubelet, node1     Created container busybox</span><br><span class="line">  Normal   Started    7s (x3 over 25s)  kubelet, node1     Started container busybox</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>9.1、Pod的配置（pod.spec.containers）</title>
      <link href="/2024/12/04/9.1%E3%80%81Pod%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%88pod.spec.containers%EF%BC%89/"/>
      <url>/2024/12/04/9.1%E3%80%81Pod%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%88pod.spec.containers%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="9-1、Pod的配置（pod-spec-containers）"><a href="#9-1、Pod的配置（pod-spec-containers）" class="headerlink" title="9.1、Pod的配置（pod.spec.containers）"></a>9.1、Pod的配置（pod.spec.containers）</h2><p><strong>本小节主要来研究</strong><code>pod.spec.containers</code>属性，这也是pod配置中最为关键的一项配置。</p><h2 id="一-本小节主要来研究pod-spec-containers属性，这也是pod配置中最为关键的一项配置。"><a href="#一-本小节主要来研究pod-spec-containers属性，这也是pod配置中最为关键的一项配置。" class="headerlink" title="一. 本小节主要来研究pod.spec.containers属性，这也是pod配置中最为关键的一项配置。"></a>一. 本小节主要来研究<code>pod.spec.containers</code>属性，这也是pod配置中最为关键的一项配置。</h2><h3 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. <strong>定义</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看使用方法</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">pod.spec.containers</span></span><br><span class="line"></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">Pod</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">v1</span></span><br><span class="line"><span class="attr">RESOURCE:</span> <span class="string">containers</span> <span class="string">&lt;[]Object&gt;</span>   <span class="comment"># 数组，代表可以有多个容器</span></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">name</span>  <span class="string">&lt;string&gt;</span>            <span class="comment"># 容器名称</span></span><br><span class="line">   <span class="string">image</span> <span class="string">&lt;string&gt;</span>            <span class="comment"># 容器需要的镜像地址</span></span><br><span class="line">   <span class="string">imagePullPolicy</span>  <span class="string">&lt;string&gt;</span> <span class="comment"># 镜像拉取策略 </span></span><br><span class="line">   <span class="string">command</span>  <span class="string">&lt;[]string&gt;</span> <span class="comment"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></span><br><span class="line">   <span class="string">args</span>     <span class="string">&lt;[]string&gt;</span> <span class="comment"># 容器的启动命令需要的参数列表</span></span><br><span class="line">   <span class="string">env</span>      <span class="string">&lt;[]Object&gt;</span> <span class="comment"># 容器环境变量的配置</span></span><br><span class="line">   <span class="string">ports</span>    <span class="string">&lt;[]Object&gt;</span>     <span class="comment"># 容器需要暴露的端口号列表</span></span><br><span class="line">   <span class="string">resources</span> <span class="string">&lt;Object&gt;</span>      <span class="comment"># 资源限制和资源请求的设置</span></span><br></pre></td></tr></table></figure><p><strong>containers &lt;[]Object&gt; 容器列表，用于定义容器的详细信息</strong></p><h3 id="2-基本配置"><a href="#2-基本配置" class="headerlink" title="2. 基本配置"></a>2. <strong>基本配置</strong></h3><p><strong>创建pod-base.yaml文件，内容如下：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span>          <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-base</span>   <span class="comment"># pod名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>   <span class="comment"># pod所属的命名空间</span></span><br><span class="line">  <span class="attr">labels:</span>          <span class="comment"># 自定义标签 </span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">heima</span></span><br><span class="line"><span class="attr">spec:</span>              <span class="comment"># 详细描述  </span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span>          <span class="comment"># 容器名称  </span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span>  <span class="comment"># 容器镜像 </span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span>        <span class="comment"># 容器名称</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.30</span>  <span class="comment"># 容器镜像</span></span><br></pre></td></tr></table></figure><p><strong>上面定义了一个比较简单Pod的配置，里面有两个容器：</strong></p><ul><li><strong>nginx：用1.17.1版本的nginx镜像创建，（nginx是一个轻量级web容器）</strong></li><li><strong>busybox：用1.30版本的busybox镜像创建，（busybox是一个小巧的linux命令集合）</strong></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">pod</span>]<span class="comment"># kubectl apply -f pod-base.yaml</span></span><br><span class="line"><span class="string">pod/pod-base</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod状况</span></span><br><span class="line"><span class="comment"># READY 1/2 : 表示当前Pod中有2个容器，其中1个准备就绪，1个未就绪</span></span><br><span class="line"><span class="comment"># RESTARTS  : 重启次数，因为有1个容器故障了，Pod一直在重启试图恢复它</span></span><br><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">pod</span>]<span class="comment"># kubectl get pod -n dev</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pod-base</span>   <span class="number">1</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">4</span>          <span class="string">95s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以通过describe查看内部的详情</span></span><br><span class="line"><span class="comment"># 此时已经运行起来了一个基本的Pod，虽然它暂时有问题</span></span><br><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">pod</span>]<span class="comment"># kubectl describe pod pod-base -n dev</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_33571420e04b19599c2fdbde3d555f2c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_33571420e04b19599c2fdbde3d555f2c.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>9、pod结构详解</title>
      <link href="/2024/12/04/9%E3%80%81pod%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3/"/>
      <url>/2024/12/04/9%E3%80%81pod%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="9、pod结构详解"><a href="#9、pod结构详解" class="headerlink" title="9、pod结构详解"></a>9、pod结构详解</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_2aa0d2a2465ecb7007fd460aade64ce4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_2aa0d2a2465ecb7007fd460aade64ce4.png"></p><p><strong>每个Pod中都可以包含一个或者多个容器，这些容器可以分为两类：</strong></p><ul><li><p><strong>用户程序所在的容器，数量可多可少</strong></p></li><li><p><strong>Pause容器，这是每个Pod都会有的一个<strong><strong>根容器</strong></strong>，它的作用有两个：</strong></p><ul><li><strong>可以以它为依据，评估整个Pod的健康状态</strong></li><li><strong>可以在根容器上设置Ip地址，其它容器都此Ip（Pod IP），以实现Pod内部的网路通信</strong></li></ul></li><li><p><strong>这里是Pod内部的通讯，Pod的之间的通讯采用虚拟二层网络技术来实现，我们当前环境用的是Flannel</strong></p></li></ul><h2 id="一-pod的定义"><a href="#一-pod的定义" class="headerlink" title="一. pod的定义"></a>一. pod的定义</h2><p><strong>下面是Pod的资源清单（经常用到的资源清单）：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>     <span class="comment">#必选，版本号，例如v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>       　 <span class="comment">#必选，资源类型，例如 Pod</span></span><br><span class="line"><span class="attr">metadata:</span>       　 <span class="comment">#必选，元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">string</span>     <span class="comment">#必选，Pod名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">string</span>  <span class="comment">#Pod所属的命名空间,默认为&quot;default&quot;</span></span><br><span class="line">  <span class="attr">labels:</span>       　　  <span class="comment">#自定义标签列表</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>      　      </span><br><span class="line"><span class="attr">spec:</span>  <span class="comment">#必选，Pod中容器的详细定义</span></span><br><span class="line">  <span class="attr">containers:</span>  <span class="comment">#必选，Pod中容器列表</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>   <span class="comment">#必选，容器名称</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">string</span>  <span class="comment">#必选，容器的镜像名称</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> [ <span class="string">Always|Never|IfNotPresent</span> ]  <span class="comment">#获取镜像的策略 </span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">string</span>]   <span class="comment">#容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></span><br><span class="line">    <span class="attr">args:</span> [<span class="string">string</span>]      <span class="comment">#容器的启动命令参数列表</span></span><br><span class="line">    <span class="attr">workingDir:</span> <span class="string">string</span>  <span class="comment">#容器的工作目录</span></span><br><span class="line">    <span class="attr">volumeMounts:</span>       <span class="comment">#挂载到容器内部的存储卷配置</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>      <span class="comment">#引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">string</span> <span class="comment">#存储卷在容器内mount的绝对路径，应少于512字符</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="string">boolean</span> <span class="comment">#是否为只读模式</span></span><br><span class="line">    <span class="attr">ports:</span> <span class="comment">#需要暴露的端口库号列表</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>        <span class="comment">#端口的名称</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="string">int</span>  <span class="comment">#容器需要监听的端口号</span></span><br><span class="line">      <span class="attr">hostPort:</span> <span class="string">int</span>       <span class="comment">#容器所在主机需要监听的端口号，默认与Container相同</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">string</span>    <span class="comment">#端口协议，支持TCP和UDP，默认TCP</span></span><br><span class="line">    <span class="attr">env:</span>   <span class="comment">#容器运行前需设置的环境变量列表</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>  <span class="comment">#环境变量名称</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">string</span> <span class="comment">#环境变量的值</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="comment">#资源限制和请求的设置</span></span><br><span class="line">      <span class="attr">limits:</span>  <span class="comment">#资源限制的设置</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">string</span>     <span class="comment">#Cpu的限制，单位为core数，将用于docker run --cpu-shares参数</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">string</span>  <span class="comment">#内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span></span><br><span class="line">      <span class="attr">requests:</span> <span class="comment">#资源请求的设置</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">string</span>    <span class="comment">#Cpu请求，容器启动的初始可用数量</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">string</span> <span class="comment">#内存请求,容器启动的初始可用数量</span></span><br><span class="line">    <span class="attr">lifecycle:</span> <span class="comment">#生命周期钩子</span></span><br><span class="line">        <span class="attr">postStart:</span> <span class="comment">#容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span></span><br><span class="line">        <span class="attr">preStop:</span> <span class="comment">#容器终止前执行此钩子,无论结果如何,容器都会终止</span></span><br><span class="line">    <span class="attr">livenessProbe:</span>  <span class="comment">#对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span></span><br><span class="line">      <span class="attr">exec:</span>       　 <span class="comment">#对Pod容器内检查方式设置为exec方式</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">string</span>]  <span class="comment">#exec方式需要制定的命令或脚本</span></span><br><span class="line">      <span class="attr">httpGet:</span>       <span class="comment">#对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">port:</span> <span class="string">number</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">HttpHeaders:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">tcpSocket:</span>     <span class="comment">#对Pod内个容器健康检查方式设置为tcpSocket方式</span></span><br><span class="line">         <span class="attr">port:</span> <span class="string">number</span></span><br><span class="line">       <span class="attr">initialDelaySeconds:</span> <span class="number">0</span>       <span class="comment">#容器启动完成后首次探测的时间，单位为秒</span></span><br><span class="line">       <span class="attr">timeoutSeconds:</span> <span class="number">0</span>    　　    <span class="comment">#对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span></span><br><span class="line">       <span class="attr">periodSeconds:</span> <span class="number">0</span>     　　    <span class="comment">#对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span></span><br><span class="line">       <span class="attr">successThreshold:</span> <span class="number">0</span></span><br><span class="line">       <span class="attr">failureThreshold:</span> <span class="number">0</span></span><br><span class="line">       <span class="attr">securityContext:</span></span><br><span class="line">         <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> [<span class="string">Always</span> <span class="string">|</span> <span class="string">Never</span> <span class="string">|</span> <span class="string">OnFailure</span>]  <span class="comment">#Pod的重启策略</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">&lt;string&gt;</span> <span class="comment">#设置NodeName表示将该Pod调度到指定到名称的node节点上</span></span><br><span class="line">  <span class="attr">nodeSelector:</span> <span class="string">obeject</span> <span class="comment">#设置NodeSelector表示将该Pod调度到包含这个label的node上</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span> <span class="comment">#Pull镜像时使用的secret名称，以key：secretkey格式指定</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">false</span>   <span class="comment">#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span></span><br><span class="line">  <span class="attr">volumes:</span>   <span class="comment">#在该pod上定义共享存储卷列表</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>    <span class="comment">#共享存储卷名称 （volumes类型有很多种）</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;       <span class="comment">#类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span></span><br><span class="line">    <span class="attr">hostPath:</span> <span class="string">string</span>   <span class="comment">#类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">string</span>      　　        <span class="comment">#Pod所在宿主机的目录，将被用于同期中mount的目录</span></span><br><span class="line">    <span class="attr">secret:</span>       　　　<span class="comment">#类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span></span><br><span class="line">      <span class="attr">scretname:</span> <span class="string">string</span>  </span><br><span class="line">      <span class="attr">items:</span>   </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">configMap:</span>         <span class="comment">#类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">string</span></span><br></pre></td></tr></table></figure><h3 id="1-查看k8s的属性"><a href="#1-查看k8s的属性" class="headerlink" title="1. 查看k8s的属性"></a>1. <strong>查看k8s的属性</strong></h3><p><strong>小提示：</strong></p><ul><li><strong>在这里，可通过一个命令来查看每种资源的可配置项</strong></li><li><strong>kubectl explain 资源类型            查看某种资源可以配置的一级属性</strong></li><li><strong>kubectl.explain 资源类型.属性     查看属性的子属性</strong></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s pod的一级属性</span></span><br><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># kubectl explain pod</span></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">Pod</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">v1</span></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">apiVersion</span>   <span class="string">&lt;string&gt;</span></span><br><span class="line">   <span class="string">kind</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">   <span class="string">metadata</span>     <span class="string">&lt;Object&gt;</span></span><br><span class="line">   <span class="string">spec</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">   <span class="string">status</span>       <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="comment"># k8s pod的二级属性</span></span><br><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># kubectl explain pod.metadata</span></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">Pod</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">v1</span></span><br><span class="line"><span class="attr">RESOURCE:</span> <span class="string">metadata</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">annotations</span>  <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">   <span class="string">clusterName</span>  <span class="string">&lt;string&gt;</span></span><br><span class="line">   <span class="string">creationTimestamp</span>    <span class="string">&lt;string&gt;</span></span><br><span class="line">   <span class="string">deletionGracePeriodSeconds</span>   <span class="string">&lt;integer&gt;</span></span><br><span class="line">   <span class="string">deletionTimestamp</span>    <span class="string">&lt;string&gt;</span></span><br><span class="line">   <span class="string">finalizers</span>   <span class="string">&lt;[]string&gt;</span></span><br><span class="line">   <span class="string">generateName</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">   <span class="string">generation</span>   <span class="string">&lt;integer&gt;</span></span><br><span class="line">   <span class="string">labels</span>       <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">   <span class="string">managedFields</span>        <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">   <span class="string">name</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">   <span class="string">namespace</span>    <span class="string">&lt;string&gt;</span></span><br><span class="line">   <span class="string">ownerReferences</span>      <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">   <span class="string">resourceVersion</span>      <span class="string">&lt;string&gt;</span></span><br><span class="line">   <span class="string">selfLink</span>     <span class="string">&lt;string&gt;</span></span><br><span class="line">   <span class="string">uid</span>  <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure><p><strong>在kubernetes中基本所有资源的一级属性都是一样的，主要包含5部分：</strong></p><ul><li><strong>apiVersion 版本，由kubernetes内部定义，版本号必须可以用 kubectl api-versions 查询到</strong></li><li><strong>kind 类型，由kubernetes内部定义，版本号必须可以用 kubectl api-resources 查询到</strong></li><li><strong>metadata 元数据，主要是资源标识和说明，常用的有name、namespace、labels等</strong></li><li><strong>spec 描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述（重要）</strong></li><li><strong>status 状态信息，里面的内容不需要定义，由kubernetes自动生成</strong></li><li><strong>status查看:  kubectl get pod nginx-57f7cb8f64-jxk6s  -n dev  -o yaml 输入后会回显下方回显示状态</strong></li></ul><p><strong>在上面的属性中，spec是接下来研究的重点，继续看下它的常见子属性:</strong></p><ul><li><strong>containers &lt;[]Object&gt; 容器列表，用于定义容器的详细信息</strong></li><li><strong>nodeName 根据nodeName的值将pod调度到指定的Node节点上</strong></li><li><strong>nodeSelector &lt;map[]&gt; 根据NodeSelector中定义的信息选择将该Pod调度到包含这些label的Node 上</strong></li><li><strong>hostNetwork 是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</strong></li><li><strong>volumes &lt;[]Object&gt; 存储卷，用于定义Pod上面挂在的存储信息 （与docker中相同）</strong></li><li><strong>restartPolicy 重启策略，表示Pod在遇到故障的时候的处理策略    （与docker中restart: always类似差不多）</strong></li></ul><p><strong>hostNetwork</strong>上方主机网络：</p><p><strong>下方IP 是k8s分给他的IP</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_90b818d1e53752466f798f2510296a54.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_90b818d1e53752466f798f2510296a54.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>8、实战入门namespace</title>
      <link href="/2024/12/04/8%E3%80%81%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8namespace/"/>
      <url>/2024/12/04/8%E3%80%81%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8namespace/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="8、实战入门namespace"><a href="#8、实战入门namespace" class="headerlink" title="8、实战入门namespace"></a>8、实战入门namespace</h2><h2 id="实战入门"><a href="#实战入门" class="headerlink" title="实战入门"></a>实战入门</h2><p><strong>本章节将介绍如何在kubernetes集群中部署一个nginx服务，并且能够对其进行访问。</strong></p><h2 id="一-Namespace"><a href="#一-Namespace" class="headerlink" title="一 Namespace"></a><code>一 Namespace</code></h2><p><strong>Namespace是kubernetes系统中的一种非常重要资源，它的主要作用是用来实现****多套环境的资源隔离</strong>或者<strong>多租户的资源隔离</strong>。</p><p><strong>默认情况下，kubernetes集群中的所有的Pod都是可以相互访问的。但是在实际中，可能不想让两个Pod之间进行互相的访问，那此时就可以将两个Pod划分到不同的namespace下。kubernetes通过将集群内部的资源分配到不同的Namespace中，可以形成逻辑上的”组”，以方便不同的组的资源进行隔离使用和管理。</strong></p><p><strong>可以通过kubernetes的授权机制，将不同的namespace交给不同租户进行管理，这样就实现了多租户的资源隔离。此时还能结合kubernetes的资源配额机制，限定不同租户能占用的资源，例如CPU使用量、内存使用量等等，来实现租户可用资源的管理。</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_0047560fb8757dfeeb73d08c00c497fd.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_0047560fb8757dfeeb73d08c00c497fd.png"></p><h3 id="1-k8s部署完成后系统默认的namespace是干嘛用的"><a href="#1-k8s部署完成后系统默认的namespace是干嘛用的" class="headerlink" title="1.k8s部署完成后系统默认的namespace是干嘛用的"></a><code>1.</code>k8s部署完成后系统默认的namespace是干嘛用的</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 查看ns详情</span><br><span class="line">kubectl  get namespace</span><br><span class="line"># 默认ns解释</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   45h     #  所有未指定Namespace的对象都会被分配在default命名空间</span><br><span class="line">kube-node-lease   Active   45h     #  集群节点之间的心跳维护，v1.13开始引入</span><br><span class="line">kube-public       Active   45h     #  此命名空间下的资源可以被所有人访问（包括未认证用户）</span><br><span class="line">kube-system       Active   45h     #  所有由Kubernetes系统创建的资源都处于这个命名空间</span><br></pre></td></tr></table></figure><h3 id="2-namespace资源的具体操作（增删改查）"><a href="#2-namespace资源的具体操作（增删改查）" class="headerlink" title="2. namespace资源的具体操作（增删改查）"></a><code>2. namespace</code>资源的具体操作（增删改查）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有ns</span><br><span class="line">kubectl get ns</span><br><span class="line"># 查看指定ns</span><br><span class="line">kubectl get ns default</span><br></pre></td></tr></table></figure><p><strong>查看</strong><code>ns</code>资源详情如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看ns详情 (状态除了此种（正在使用中）还有Terminating 正在删除命名空间)</span><br><span class="line">kubectl describe ns default</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Name:         default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Status:       Active  # Active 命名空间正在使用中  Terminating 正在删除命名空间</span><br><span class="line"></span><br><span class="line"># ResourceQuota 针对namespace做的资源限制</span><br><span class="line"># LimitRange针对namespace中的每个组件做的资源限制</span><br><span class="line">No resource quota.</span><br><span class="line">No LimitRange resource.</span><br></pre></td></tr></table></figure><p><strong>kubernetes支持的格式有很多，比较常见的是wide、json、yaml</strong></p><p><strong>kubectl get ns default -o yaml</strong></p><p><strong>创建/删除</strong><code>ns</code>资源</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns dev</span><br><span class="line"># 验证是否创建完成</span><br><span class="line">kubectl get ns dev</span><br><span class="line"># 删除资源（删除会删除ns下的所有资源）</span><br><span class="line">kubectl delete ns dev</span><br></pre></td></tr></table></figure><h2 id="二-配置的方式创建ns"><a href="#二-配置的方式创建ns" class="headerlink" title="二. 配置的方式创建ns"></a>二. 配置的方式创建<code>ns</code></h2><p><strong>创建一个yaml文件、ns-dev.yaml</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: dev</span><br></pre></td></tr></table></figure><p><strong>此时就可以执行对应的创建和删除命令了</strong></p><ul><li><strong>创建：kubectl create -f ns-dev.yaml</strong></li><li><strong>删除：kubectl delete -f ns-dev.yaml</strong></li></ul><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_56529a6aa690ff5b06b1c25f9595dde5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_56529a6aa690ff5b06b1c25f9595dde5.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>7、声明式对象配置</title>
      <link href="/2024/12/04/7%E3%80%81%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE/"/>
      <url>/2024/12/04/7%E3%80%81%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="7、声明式对象配置"><a href="#7、声明式对象配置" class="headerlink" title="7、声明式对象配置"></a>7、声明式对象配置</h2><h2 id="17-声明式对象配置"><a href="#17-声明式对象配置" class="headerlink" title="17.声明式对象配置"></a><code>17.</code>声明式对象配置</h2><p><strong>总结:</strong> 其实声明式对象配置就是使用apply描述一个资源最终的状态（在yaml中定义状态）** 使用apply操作资源：如果资源不存在，就创建，相当于 kubectl create** 如果资源已存在，就更新，相当于 kubectl patch</p><p><strong>声明式对象配置跟命令式对象配置很相似、但是他只有一个命令apply（更新创建 已有则更新 没有则创建）</strong></p><p><strong>如果使用conmand 中的create 则会报错</strong></p><p><strong>使用apply 创建/更新资源</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 更新创建 已有则更新 没有则创建 nginx</span><br><span class="line">kubectl apply -f nginxpod.yml </span><br><span class="line"># 验证</span><br><span class="line">kubectl get ns  dev</span><br><span class="line">kubectl get pods  -n dev</span><br></pre></td></tr></table></figure><p><strong>再次执行（已资源此时更新）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 此时我们已经创建了 我们再运行一下这个配置文件</span><br><span class="line">kubectl apply -f nginxpod.yml </span><br><span class="line">// 返回（提示没有改变）</span><br><span class="line">namespace/dev unchanged</span><br><span class="line">pod/nginxpod unchanged</span><br></pre></td></tr></table></figure><p><strong>此时我们将</strong><code>nginxpod.yml</code>中镜像版本修改为<code>2</code>此时再次执行<code>kubectl apply -f nginxpod.yml</code></p><p><strong>注意：</strong></p><ul><li><strong>修改pod名称会重新创建一个pod 修改镜像测试即可</strong></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命名空间的声明 创建一个dev的namespace</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>   <span class="comment"># 版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span>  <span class="comment"># 类型</span></span><br><span class="line"><span class="attr">metadata:</span>        <span class="comment"># 描述名称为dev </span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>      <span class="comment"># 版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>           <span class="comment"># 类型是pod </span></span><br><span class="line"><span class="attr">metadata:</span>           <span class="comment"># 描述如下</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginxpod</span>    <span class="comment"># 名字叫nginxpod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>    <span class="comment"># 所在名称空间叫dev</span></span><br><span class="line"><span class="attr">spec:</span>               <span class="comment"># 详细描述如下</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-containers</span> <span class="comment"># pod中容器的名字叫nginx-containers</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-1.17.2</span> <span class="comment"># 容器使用的镜像nginx:latest 或 私有镜像仓库 registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span></span><br><span class="line"><span class="string">~</span></span><br></pre></td></tr></table></figure><p><strong>查看 此时返回命名空间没有改变 pod/nginxpod发生改变</strong></p><p><strong>查看详情：</strong><code>kubectl describe pod nginxpod -n dev</code></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_320ee6bf67ce0c8b48d8f440b782316d.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_320ee6bf67ce0c8b48d8f440b782316d.png"></p><h3 id="扩展：kubectl可以在node节点上运行吗"><a href="#扩展：kubectl可以在node节点上运行吗" class="headerlink" title="扩展：kubectl可以在node节点上运行吗 ?"></a>扩展：kubectl可以在node节点上运行吗 ?</h3><p><strong>kubectl的运行是需要进行配置的，它的配置文件是$HOME/.kube，如果想要在node节点运行此命令，需要将master上的.kube文件复制到node节点上，即在master节点上执行下面操作：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 变量形式</span><br><span class="line">scp  -r  $HOME/.kube   node1: HOME/</span><br><span class="line"># 等同于如下</span><br><span class="line">scp  -r  ~/.kube   node1:~/</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_5e5a9778ccfa864aed4adf4cffc6ee23.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_5e5a9778ccfa864aed4adf4cffc6ee23.png"></p><p><strong>使用推荐: 三种方式应该怎么用 ?</strong></p><h4 id="什么时候使用三种方式的推荐使用方式："><a href="#什么时候使用三种方式的推荐使用方式：" class="headerlink" title="什么时候使用三种方式的推荐使用方式："></a>什么时候使用三种方式的推荐使用方式：</h4><ul><li><strong>创建/更新资源 使用声明式对象配置 kubectl apply -f XXX.yaml</strong></li><li><strong>删除资源 使用命令式对象配置 kubectl delete -f XXX.yaml</strong></li><li><strong>查询资源 使用命令式对象管理 kubectl get(describe) 资源名称</strong></li></ul>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>service（pod对外暴露端口/固定容器内网地址）</title>
      <link href="/2024/12/02/service%EF%BC%88pod%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3/%E5%9B%BA%E5%AE%9A%E5%AE%B9%E5%99%A8%E5%86%85%E7%BD%91%E5%9C%B0%E5%9D%80%EF%BC%89/"/>
      <url>/2024/12/02/service%EF%BC%88pod%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3/%E5%9B%BA%E5%AE%9A%E5%AE%B9%E5%99%A8%E5%86%85%E7%BD%91%E5%9C%B0%E5%9D%80%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="7、service（pod对外暴露端口-固定容器内网地址）"><a href="#7、service（pod对外暴露端口-固定容器内网地址）" class="headerlink" title="7、service（pod对外暴露端口/固定容器内网地址）"></a>7、service（pod对外暴露端口/固定容器内网地址）</h2><h3 id="4-5-Service"><a href="#4-5-Service" class="headerlink" title="4.5 Service"></a>4.5 Service</h3><p><strong>通过上节课的学习，已经能够利用Deployment来创建一组Pod来提供具有高可用性的服务。</strong></p><p><strong>虽然每个Pod都会分配一个单独的Pod IP，然而却存在如下两问题：</strong></p><ul><li><strong>Pod IP 会随着Pod的重建产生变化</strong></li><li><strong>Pod IP 仅仅是集群内可见的虚拟IP，外部无法访问</strong></li></ul><p><strong>这样对于访问这个服务带来了难度。因此，kubernetes设计了Service来解决这个问题。</strong></p><p><strong>Service可以看作是一组同类Pod<strong><strong>对外的访问接口</strong></strong>。借助Service，应用可以</strong>方便地实现服务发现和负载均衡。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_d8ec1d17faa4adf177b12d6b4f78597a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_d8ec1d17faa4adf177b12d6b4f78597a.png"></p><h3 id="4-5-1-创建集群内部可访问的Service"><a href="#4-5-1-创建集群内部可访问的Service" class="headerlink" title="4.5.1 创建集群内部可访问的Service"></a>4.5.1 创建集群内部可访问的Service</h3><p>前面第5节我们创建的pod 要访问他需要查看他的IP 但是此IP是能集群内部访问 IP还会变化 并且外面环境是无法访问的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看dev下面pod信息</span></span><br><span class="line">kubectl get pods -n dev -o wide</span><br></pre></td></tr></table></figure><h2 id="一-创建集群内部可以访问的service"><a href="#一-创建集群内部可以访问的service" class="headerlink" title="一. 创建集群内部可以访问的service"></a>一. 创建集群内部可以访问的service</h2><h3 id="1、集群内部访问"><a href="#1、集群内部访问" class="headerlink" title="1、集群内部访问"></a>1、集群内部访问</h3><p><strong>环境准备：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  <span class="comment"># 版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>     <span class="comment"># 类型</span></span><br><span class="line"><span class="attr">metadata:</span>            <span class="comment"># 源数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span>        <span class="comment"># 当前deployment所属的名字</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>     <span class="comment"># 及ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>        <span class="comment"># 定义副本数</span></span><br><span class="line">  <span class="attr">selector:</span>          <span class="comment"># 标签选择器 选择标签进行操作</span></span><br><span class="line">    <span class="attr">matchLabels:</span>     <span class="comment"># 选择nginx标签</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span>          <span class="comment"># 以下为pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span>        <span class="comment"># 标签</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">nginx</span>   <span class="comment"># 定义标签为nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">svc-nginx1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><p><strong>查看deployment</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看deployment</span></span><br><span class="line">kubectl get deployment</span><br><span class="line"><span class="comment"># 查看pod详细信息</span></span><br><span class="line">kubectl get pods -n dev -o wide --show-labels</span><br></pre></td></tr></table></figure><p><strong>参数：</strong></p><ul><li><strong>–port: 80  程序内部端口</strong></li><li><strong>–target-port:  80  需要暴露的端口即80转发到80</strong></li><li>**deploy nginx :  **nginx为deployment名称</li><li>**–name=svc-nginx1:  **<strong>此为svc名称</strong></li></ul><p><strong>返回:</strong></p><ul><li><strong>ClusterIP: 10.108.11.19   为集群IP  只有集群内部才可以访问</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建集群内部可以访问的service</span></span><br><span class="line">kubectl expose deploy nginx --name=svc-nginx1  --<span class="built_in">type</span>=ClusterIP --port=80 --target-port=80 -n dev</span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">kubectl get svc -n dev -o wide</span><br><span class="line">curl 10.108.11.19</span><br></pre></td></tr></table></figure><p>**此时我们访问就不访问podIP了我们访问service的ip加端口  此时其实是做了一个负载均衡他会随机转发到一个pod去提供服务 **</p><h3 id="2、实现集群外部访问"><a href="#2、实现集群外部访问" class="headerlink" title="2、实现集群外部访问"></a>2、实现集群外部访问</h3><ul><li><strong>上面创建的Service的type类型为ClusterIP，这个ip地址只用集群内部可访问</strong></li><li><strong>如果需要创建外部也可以访问的Service，需要修改type为NodePort</strong></li><li><strong>–name=svc-nginx2  ns dev下deployment pod控制器nginx会再创建一个pod名称为svc-nginx2的容器</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群外部访问</span></span><br><span class="line">kubectl expose deploy nginx --name=svc-nginx2  --<span class="built_in">type</span>=NodePort --port=80 --target-port=80 -n dev</span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">kubectl get svc -n dev --show-labels -o wide</span><br></pre></td></tr></table></figure><h3 id="3、删除service"><a href="#3、删除service" class="headerlink" title="3、删除service"></a>3、删除service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除service</span></span><br><span class="line">kubectl delete svc svc-nginx2 -n dev</span><br></pre></td></tr></table></figure><h3 id="4、配置方式"><a href="#4、配置方式" class="headerlink" title="4、配置方式"></a>4、配置方式</h3><p><strong>创建一个svc-nginx.yaml，内容如下：</strong></p><p><strong>需要修改type为</strong>NodePort <strong>（修改type类型为NodePort即可实现外部访问）</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.109</span><span class="number">.179</span><span class="number">.231</span> <span class="comment"># 固定svc的内网ip</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure><p><strong>然后就可以执行对应的创建和删除命令了：</strong></p><p><strong>创建：kubectl create -f svc-nginx.yaml</strong></p><p><strong>删除：kubectl delete -f svc-nginx.yaml</strong></p><p><strong>小结</strong></p><p><strong>至此，已经掌握了Namespace、Pod、Deployment、Service资源的基本操作，有了这些操作，就可以在kubernetes集群中实现一个服务的简单部署和访问了，但是如果想要更好的使用kubernetes，就需要深入学习这几种资源的细节和原理。</strong></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3、k8s资源管理命令式对象配置</title>
      <link href="/2024/12/02/3%E3%80%81k8s%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE/"/>
      <url>/2024/12/02/3%E3%80%81k8s%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="3、k8s资源管理命令式对象配置"><a href="#3、k8s资源管理命令式对象配置" class="headerlink" title="3、k8s资源管理命令式对象配置"></a>3、k8s资源管理命令式对象配置</h2><h2 id="一-命令式对象配置（本文档研究怎么使用-不研究怎么编写）"><a href="#一-命令式对象配置（本文档研究怎么使用-不研究怎么编写）" class="headerlink" title="一. 命令式对象配置（本文档研究怎么使用 不研究怎么编写）"></a>一. 命令式对象配置（本文档研究怎么使用 不研究怎么编写）</h2><ul><li>命令式对象配置：通过命令配置 + 配置文件去操作 k8s 资源</li><li><strong>即将命令写到文件中类似于 docker-compose（参数 create/patch == 创建/更新 即要做的事是 通过文件 创建和更新 nginx-pod 要做的事情定义在 nginx-pod 文件中 ）</strong></li></ul><p><strong>kubectl create/patch -f nginx-pod.yaml</strong></p><h3 id="3-3-2-命令式对象配置"><a href="#3-3-2-命令式对象配置" class="headerlink" title="3.3.2 命令式对象配置"></a><code>3.3.2</code> 命令式对象配置</h3><p><strong>命令式对象配置就是使用命令配合配置文件一起来操作kubernetes资源。</strong></p><h4 id="1-创建一个nginxpod-yaml，内容如下："><a href="#1-创建一个nginxpod-yaml，内容如下：" class="headerlink" title="1.创建一个nginxpod.yaml，内容如下："></a><code>1.</code>创建一个<code>nginxpod.yaml</code>，内容如下：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 命名空间的声明 创建一个dev的namespace</span><br><span class="line">apiVersion: v1   # 版本</span><br><span class="line">kind: Namespace  # 类型</span><br><span class="line">metadata:        # 描述名称为dev </span><br><span class="line">  name: dev</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1      # 版本</span><br><span class="line">kind: Pod           # 类型是pod </span><br><span class="line">metadata:           # 描述如下</span><br><span class="line">  name: nginxpod    # 名字叫nginxpod</span><br><span class="line">  namespace: dev    # 所在名称空间叫dev</span><br><span class="line">spec:               # 详细描述如下</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-containers # pod中容器的名字叫nginx-containers</span><br><span class="line">    image: nginx:latest    # 容器使用的镜像nginx:latest 或 私有镜像仓库 registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span><br></pre></td></tr></table></figure><p><strong>上面文件内容等同于命令</strong></p><p><strong>kubectl create deployment nginx –image=registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest -n dev</strong></p><h4 id="2-执行create命令，创建资源⑮"><a href="#2-执行create命令，创建资源⑮" class="headerlink" title="2. 执行create命令，创建资源⑮"></a>2. 执行<code>create</code>命令，创建资源⑮</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建资源</span><br><span class="line">kubectl create -f nginxpod.yml</span><br></pre></td></tr></table></figure><h4 id="3-执行get命令，查看资源"><a href="#3-执行get命令，查看资源" class="headerlink" title="3. 执行get命令，查看资源"></a><code>3.</code> 执行<code>get</code>命令，查看资源</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ns</span><br><span class="line">kubectl get pod  -n dev</span><br></pre></td></tr></table></figure><p><strong>执行后创建了两个资源</strong></p><ul><li>namespace: dev</li><li><strong>pod: nginxpod</strong></li></ul><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_b672bd2b47e40d7caa6379b515bb09ea.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_b672bd2b47e40d7caa6379b515bb09ea.png"></p><h4 id="4-删除资源"><a href="#4-删除资源" class="headerlink" title="4.删除资源"></a><code>4</code>.删除资源</h4><p><strong>配置文件删除方式</strong></p><p><strong>kubectl delete -f nginxpod.yml</strong></p><p><strong>命令行方式</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 此时查看发现还有 其实之前的我们已经删了 只是它又重新启动了一个而已</span><br><span class="line">kubectl get pods -n dev</span><br><span class="line"># 删除dev namespace(稍微等待一会儿) </span><br><span class="line">kubectl delete ns dev</span><br></pre></td></tr></table></figure><h2 id="二-总结"><a href="#二-总结" class="headerlink" title="二. 总结"></a>二. 总结</h2><p><strong>命令式对象配置的方式操作资源、可以简单的认为：命令 + yaml配置文件（里面是命令需要的各种参数）</strong></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2、k8s资源管理_命令式对象管理演示简单创建删除</title>
      <link href="/2024/12/02/2%E3%80%81k8s%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86_%E5%91%BD%E4%BB%A4%E5%BC%8F%E5%AF%B9%E8%B1%A1%E7%AE%A1%E7%90%86%E6%BC%94%E7%A4%BA%E7%AE%80%E5%8D%95%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4/"/>
      <url>/2024/12/02/2%E3%80%81k8s%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86_%E5%91%BD%E4%BB%A4%E5%BC%8F%E5%AF%B9%E8%B1%A1%E7%AE%A1%E7%90%86%E6%BC%94%E7%A4%BA%E7%AE%80%E5%8D%95%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="2、k8s资源管理-命令式对象管理演示简单创建删除"><a href="#2、k8s资源管理-命令式对象管理演示简单创建删除" class="headerlink" title="2、k8s资源管理_命令式对象管理演示简单创建删除"></a>2、k8s资源管理_命令式对象管理演示简单创建删除</h2><h2 id="k8s-的资源管理方式"><a href="#k8s-的资源管理方式" class="headerlink" title="k8s 的资源管理方式"></a><code>k8s</code> 的资源管理方式</h2><ul><li><strong>命令式对象管理：直接使用命令去操作 k8s 资源（参数 nginx-pod 为 pod 名称）</strong></li></ul><p>kubectl run nginx-pod –image=nginx:1.17.1 –port=80</p><ul><li><strong>命令式对象配置：通过命令配置和配置文件去操作 k8s 资源 即将命令写到文件中类似于 docker-compose（参数 create/patch == 创建/更新 即要做的事是 通过文件 创建和更新 nginx-pod 要做的事情定义在 nginx-pod 文件中 ）</strong></li></ul><p>nginx-pod.yaml文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginxpod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-containers</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br></pre></td></tr></table></figure><p><strong>kubectl create/patch -f nginx-pod.yaml</strong></p><ul><li><strong>声明式对象配置：通过 apply 命令和配置文件去操作 k8s 资源（ apply 只用于创建和更新资源 即如果有则更新资源 无则创建资源 如删除则需要用 kubectl delete）</strong></li></ul><p><strong>kubectl apply -f nginx-pod.yaml</strong></p><h3 id="上述三种方式优缺点和应用场景"><a href="#上述三种方式优缺点和应用场景" class="headerlink" title="上述三种方式优缺点和应用场景"></a>上述三种方式优缺点和应用场景</h3><table><thead><tr><th><strong>类型</strong></th><th><strong>操作对象</strong></th><th><strong>适用环境</strong></th><th><strong>优点</strong></th><th><strong>缺点</strong></th></tr></thead><tbody><tr><td><strong>命令式对像管理</strong></td><td><strong>对象</strong></td><td><strong>测试</strong></td><td><strong>简单</strong></td><td><strong>只能操作活动对象，无法审计，跟踪</strong></td></tr><tr><td><strong>命令式对象配置</strong></td><td><strong>文件</strong></td><td><strong>开发</strong></td><td><strong>可以审计，跟踪</strong></td><td><strong>项目大时，配置文件多，操作麻烦</strong></td></tr><tr><td><strong>声明式对象配置</strong></td><td><strong>目录</strong></td><td><strong>开发</strong></td><td><strong>支持目录操作</strong></td><td><strong>意外情况下难以调试</strong></td></tr></tbody></table><h2 id="一-命令式对象管理"><a href="#一-命令式对象管理" class="headerlink" title="一. 命令式对象管理"></a>一. 命令式对象管理</h2><p>kubectl命令</p><p><strong>kubectl 是 kuberbetes 集群的命令行工具，通过它能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。kubectl命令的语法如下：</strong></p><p><strong>kubectl 【conmand】【type】【name】【flags】</strong></p><p><strong>conmand：</strong>指定要对资源执行的操作、例如create、get、delete、apply</p><p><strong>type:</strong> 指定资源类型，比如 deployment，pod，service</p><p><strong>name：</strong>指定资源的名称 名称大小写敏感</p><p><strong>flags：</strong>指定额外的可选参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有pod</span></span><br><span class="line">kubectl get pod</span><br><span class="line"><span class="comment"># 查看某个pod</span></span><br><span class="line">kubectl get pod pod_name</span><br><span class="line"><span class="comment"># 查看pod详细信息</span></span><br><span class="line">kubectl get pod pod_name -o wide</span><br><span class="line"><span class="comment"># 以json形式显示</span></span><br><span class="line">kubectl get pod pod_name -o json</span><br><span class="line"><span class="comment"># 查看某个pod以yaml方式显示结果</span></span><br><span class="line">kubectl get pod pod_name -o yaml</span><br></pre></td></tr></table></figure><p><strong>查询</strong><code>&lt;span class=&quot;ne-text&quot;&gt;pod&lt;/span&gt;</code></p><h3 id="1-上方-commond-操作"><a href="#1-上方-commond-操作" class="headerlink" title="1. 上方 commond`操作"></a><code>1.</code> 上方 commond`操作</h3><p><strong>kubernetes允许对资源进行多种操作，可以通过–help查看详细的操作命令</strong></p><p><strong>kubectl –help</strong></p><p><strong>经常使用的操作有下面这些：</strong></p><table><thead><tr><th><strong>命令分类</strong></th><th><strong>命令</strong></th><th><strong>翻译</strong></th><th><strong>命令作用</strong></th></tr></thead><tbody><tr><td><strong>基本命令</strong></td><td><strong>create</strong></td><td><strong>创建</strong></td><td><strong>创建一个资源</strong></td></tr><tr><td></td><td><strong>edit</strong></td><td><strong>编辑</strong></td><td><strong>编辑一个资源</strong></td></tr><tr><td></td><td><strong>get</strong></td><td><strong>获取</strong></td><td><strong>获取一个资源</strong></td></tr><tr><td></td><td><strong>patch</strong></td><td><strong>更新</strong></td><td><strong>更新一个资源</strong></td></tr><tr><td></td><td><strong>delete</strong></td><td><strong>删除</strong></td><td><strong>删除一个资源</strong></td></tr><tr><td></td><td><strong>explain</strong></td><td><strong>解释</strong></td><td><strong>展示资源文档</strong></td></tr><tr><td><strong>运行和调试</strong></td><td><strong>run</strong></td><td><strong>运行</strong></td><td><strong>在集群中运行一个指定的镜像</strong></td></tr><tr><td></td><td><strong>expose</strong></td><td><strong>暴露</strong></td><td><strong>暴露资源为 Service</strong></td></tr><tr><td></td><td><strong>describe</strong></td><td><strong>描述</strong></td><td><strong>显示资源内部信息</strong></td></tr><tr><td></td><td><strong>logs</strong></td><td><strong>日志输出容器在 pod 中的日志</strong></td><td><strong>输出容器在 pod 中的日志</strong></td></tr><tr><td></td><td><strong>attach</strong></td><td><strong>缠绕进入运行中的容器</strong></td><td><strong>进入运行中的容器</strong></td></tr><tr><td></td><td><strong>exec</strong></td><td><strong>执行容器中的一个命令</strong></td><td><strong>执行容器中的一个命令</strong></td></tr><tr><td></td><td><strong>cp</strong></td><td><strong>复制</strong></td><td><strong>在Pod内外复制文件</strong></td></tr><tr><td></td><td><strong>rollout</strong></td><td><strong>首次展示</strong></td><td><strong>管理资源的发布</strong></td></tr><tr><td></td><td><strong>scale</strong></td><td><strong>规模</strong></td><td><strong>扩(缩)容Pod的数量</strong></td></tr><tr><td></td><td><strong>autoscale</strong></td><td><strong>自动调整</strong></td><td><strong>自动调整Pod的数量</strong></td></tr><tr><td><strong>高级命令</strong></td><td><strong>apply</strong></td><td><strong>rc</strong></td><td><strong>通过文件对资源进行配置</strong></td></tr><tr><td></td><td><strong>label</strong></td><td><strong>标签</strong></td><td><strong>更新资源上的标签</strong></td></tr><tr><td><strong>其他命令</strong></td><td><strong>cluster-info</strong></td><td><strong>集群信息</strong></td><td><strong>显示集群信息</strong></td></tr><tr><td></td><td><strong>version</strong></td><td><strong>版本</strong></td><td><strong>显示当前Server和Client的版本</strong></td></tr></tbody></table><h4 id="a-演示上方操作如下"><a href="#a-演示上方操作如下" class="headerlink" title="a. 演示上方操作如下"></a>a. 演示上方操作如下</h4><p><strong>①.基本命令</strong></p><p><strong>②.运行和调试</strong></p><ul><li><strong>kubectl expose deploy nginx –port=80 –target-port=80 –type=NodePort 暴露端口</strong></li><li><strong>kubectl describe pod nginx-54b7d798b5-2cxdv 查看容器详细信息</strong></li></ul><h3 id="2-资源类型对应上方"><a href="#2-资源类型对应上方" class="headerlink" title="2.资源类型对应上方``"></a><code>2.</code><strong>资源类型对应上方</strong>``</h3><p><code>kubernetes</code><strong>中所有的内容都抽象为资源，可以通过下面的命令进行查看:</strong></p><p><strong>kubectl api-resources</strong></p><p><strong>经常使用的资源有下面这些：</strong></p><table><thead><tr><th><strong>资源分类</strong></th><th><strong>资源名称</strong></th><th><strong>缩写</strong></th><th><strong>资源作用</strong></th></tr></thead><tbody><tr><td><strong>集群级别资源</strong></td><td><strong>nodes</strong></td><td><strong>no</strong></td><td><strong>集群组成部分</strong></td></tr><tr><td><strong>namespaces</strong></td><td><strong>ns</strong></td><td><strong>隔离Pod</strong></td><td></td></tr><tr><td><strong>pod资源</strong></td><td><strong>pods</strong></td><td><strong>po</strong></td><td><strong>装载容器</strong></td></tr><tr><td><strong>pod资源控制器</strong></td><td><strong>replicationcontrollers</strong></td><td><strong>rc</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>replicasets</strong></td><td><strong>rs</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>deployments</strong></td><td><strong>deploy</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>daemonsets</strong></td><td><strong>ds</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>jobs</strong></td><td></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>cronjobs</strong></td><td><strong>cj</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>horizontalpodautoscalers</strong></td><td><strong>hpa</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>statefulsets</strong></td><td><strong>sts</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td><strong>服务发现资源</strong></td><td><strong>services</strong></td><td><strong>svc</strong></td><td><strong>统一pod对外接口</strong></td></tr><tr><td></td><td><strong>ingress</strong></td><td><strong>ing</strong></td><td><strong>统一pod对外接口</strong></td></tr><tr><td><strong>存储资源</strong></td><td><strong>volumeattachments</strong></td><td></td><td><strong>存储</strong></td></tr><tr><td></td><td><strong>persistentvolumes</strong></td><td><strong>pv</strong></td><td><strong>存储</strong></td></tr><tr><td></td><td><strong>persistentvolumeclaims</strong></td><td><strong>pvc</strong></td><td><strong>存储</strong></td></tr><tr><td><strong>配置资源</strong></td><td><strong>configmaps</strong></td><td><strong>cm</strong></td><td><strong>配置</strong></td></tr><tr><td></td><td><strong>secrets</strong></td><td></td><td><strong>配置</strong></td></tr></tbody></table><p><strong>nodes</strong></p><ul><li><strong>kubectl get nodes 查询节点信息</strong></li></ul><h4 id="a-下面以一个-namespace-pod的创建和删除简单演示下命令的使用："><a href="#a-下面以一个-namespace-pod的创建和删除简单演示下命令的使用：" class="headerlink" title="a. 下面以一个 namespace / pod的创建和删除简单演示下命令的使用："></a>a. 下面以一个 <code>namespace / pod</code>的创建和删除简单演示下命令的使用：</h4><p><strong>查看缩写命令：</strong><code>kubectl api-resources</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个namespace</span><br><span class="line">kubectl create namespace dev </span><br><span class="line"># 或者使用缩写 </span><br><span class="line">kubectl create ns dev </span><br><span class="line"># 查看是否创建成功</span><br><span class="line">kubectl get ns</span><br><span class="line"># 创建一个pod在dev下面 不指定则会在default下面</span><br><span class="line">kubectl create deployment nginx --image=registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest -n dev</span><br><span class="line"># 使用此命令创建的pod删除后会自动重建需要使用下方命令才能彻底删除</span><br><span class="line"># 原因：当一个Pod被删除后，如果它是由一个ReplicaSet、Deployment或其他控制器管理的，那么控制器会自动创建一个新的Pod来替代被删除的Pod，以确保应用的可用性和副本数目的一致性。</span><br><span class="line">kubectl delete deployment nginx -n dev</span><br><span class="line">kubectl delete service nginx -n dev</span><br></pre></td></tr></table></figure><p><strong>查看创建的pod详细信息</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查看dev 命名空间下面的pod</span><br><span class="line">kubectl get pod -n dev</span><br><span class="line"># 查看创建过程中的详细信息</span><br><span class="line">kubectl describe pod nginx-54b7d798b5-9p97w -n dev</span><br><span class="line"># 删除dev下面刚刚创建的pod</span><br><span class="line">kubectl delete pod nginx-54b7d798b5-9p97w -n dev</span><br><span class="line"># 此时查看发现还有 其实之前的我们已经删了 只是它又重新启动了一个而已</span><br><span class="line">kubectl get pods -n dev</span><br><span class="line"># 删除dev namespace(稍微等待一会儿) </span><br><span class="line">kubectl delete ns dev</span><br><span class="line"># 查看ns 和 pod此时dev没了下面的pod也没了</span><br><span class="line">kubectl get ns</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_cd93f06166727df2e0922f4a69f070b2.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_cd93f06166727df2e0922f4a69f070b2.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_f20d485db3208befe88b697a698fc5ca.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/12/image_f20d485db3208befe88b697a698fc5ca.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s部署webstack（storageclass方式）</title>
      <link href="/2024/11/25/k8s%E9%83%A8%E7%BD%B2webstack%EF%BC%88storageclass%E6%96%B9%E5%BC%8F%EF%BC%89/"/>
      <url>/2024/11/25/k8s%E9%83%A8%E7%BD%B2webstack%EF%BC%88storageclass%E6%96%B9%E5%BC%8F%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="k8s部署webstack（storageclass方式）"><a href="#k8s部署webstack（storageclass方式）" class="headerlink" title="k8s部署webstack（storageclass方式）"></a>k8s部署webstack（storageclass方式）</h2><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p><strong>部署MySql时无法自动创建webstack数据库 此时需要手动创建</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录</span></span><br><span class="line">mysql -uroot -proot_password -h10.96.0.2</span><br><span class="line">CREATE DATABASE webstack;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><h3 id="一、配置文件（webstack-yml）"><a href="#一、配置文件（webstack-yml）" class="headerlink" title="一、配置文件（webstack.yml）"></a>一、配置文件（webstack.yml）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql配置</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">my.cnf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    !includedir /etc/mysql/conf.d/</span></span><br><span class="line"><span class="string">    !includedir /etc/mysql/mysql.conf.d/</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">    [<span class="string">mysqld</span>]</span><br><span class="line">    <span class="comment">## 同一局域网内注意要唯一</span></span><br><span class="line">    <span class="string">server-id=001</span></span><br><span class="line">    <span class="comment">## 开启二进制日志功能，可以随便取（关键）</span></span><br><span class="line">    <span class="string">log-bin=mysql-bin</span></span><br><span class="line">  </span><br><span class="line">    <span class="string">gtid_mode=on</span></span><br><span class="line">    <span class="string">enforce_gtid_consistency=on</span></span><br><span class="line">  </span><br><span class="line">    <span class="string">relay-log=relay-log.log</span></span><br><span class="line">    <span class="string">binlog_format=ROW</span></span><br><span class="line">    <span class="comment">#MySQL5.7可以不启用此参数，5.7版本使用了gtid_executed表记录同步复制的信息，避免两次写入relay-log和binlog，降低了从库磁盘I/O</span></span><br><span class="line">    <span class="comment">#log_slave_updates=true</span></span><br><span class="line">    <span class="string">master_info_repository=TABLE</span></span><br><span class="line">    <span class="string">relay_log_info_repository=TABLE</span></span><br><span class="line">    <span class="string">sync_master_info=1</span></span><br><span class="line">    <span class="string">slave_parallel_workers=2</span></span><br><span class="line">    <span class="string">binlog_checksum=CRC32</span></span><br><span class="line">    <span class="string">master_verify_checksum=1</span></span><br><span class="line">    <span class="string">slave_sql_verify_checksum=1</span></span><br><span class="line">    <span class="string">binlog_rows_query_log_events=1</span></span><br><span class="line">    <span class="comment">#replicate_do_db=tt</span></span><br><span class="line">    <span class="comment">#MySQL5.7新增加的值，配置基于表的组提交并行复制，默认值为database（基于库进行多线程复制，MySQL5.6是基于库的方式进行多线程方式复制）建议改为logical_clock，基于表的组方式复制，提高复制的效率</span></span><br><span class="line">    <span class="string">slave_parallel_type=logical_clock</span></span><br><span class="line">    <span class="comment">#开启通用查询日志</span></span><br><span class="line">    <span class="string">general_log=1</span></span><br><span class="line">    <span class="comment">#设置通用日志的输出格式为文件和表</span></span><br><span class="line">    <span class="string">log_output=FILE,TABLE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql    </span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span> <span class="comment"># has to match .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;mysql&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span> <span class="comment"># by default is 1               # 3副本</span></span><br><span class="line">  <span class="comment"># minReadySeconds: 10 # by default is 0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span> <span class="comment"># has to match .spec.selector.matchLabels</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mysql:5.7</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;root_password&quot;</span>         <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">webstack</span>         <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">webstack</span>         <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;root_password&quot;</span>  <span class="comment"># 设置根密码，建议使用 Secrets 存储</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">          <span class="comment"># - --collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">          <span class="comment"># - &quot;--default-authentication-plugin=mysql_native_password&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-map</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">&quot;/etc/mysql/my.cnf&quot;</span></span><br><span class="line">            <span class="attr">subPath:</span> <span class="string">my.cnf</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="comment"># 定义 ConfigMap 类型的 Volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-map</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql-cm</span>  <span class="comment"># 引用名为 mysql-cm 的 ConfigMap</span></span><br><span class="line">        <span class="comment"># # 定义持久化存储 Volume</span></span><br><span class="line">        <span class="comment"># - name: mysql-storage</span></span><br><span class="line">        <span class="comment">#   persistentVolumeClaim:</span></span><br><span class="line">        <span class="comment">#     claimName: mysql-pvc</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span>                   <span class="comment"># 3副本里面都会申请一个存储 此配置就类似pvc了</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]             <span class="comment"># 访问模式ReadWriteOnce 允许一个客户进行读写</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;managed-nfs-storage&quot;</span>      <span class="comment"># 指定定义的StorageClass</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">2Gi</span>                             <span class="comment"># 申请空间大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使mysql ip固定</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.2</span>  <span class="comment"># service的ip地址，如果不写，默认会生成一个</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span>             <span class="comment"># Service端口</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3306</span>       <span class="comment"># pod端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建webstack</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webstack</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span>         <span class="comment"># 修改为3副本</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">webstack</span>   <span class="comment"># 必须与 .spec.template.metadata.labels 匹配</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">webstack</span> <span class="comment"># 必须与 .spec.selector.matchLabels 匹配</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webstack</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:webstackv-1.2.2</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOGIN_COPTCHA</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;10.96.0.2&quot;</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">webstack</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USERNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">root</span>   </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">root_password</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APP_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;&quot;</span> <span class="comment"># 空值明确写为 &quot;&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">webstack</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;/entrypoint.sh&#x27;</span>,<span class="string">&#x27;serve&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露webstack端口</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webstack-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webstack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># 将服务暴露为 NodePort 类型</span></span><br></pre></td></tr></table></figure><h3 id="效果（验证mysql持久化）"><a href="#效果（验证mysql持久化）" class="headerlink" title="效果（验证mysql持久化）"></a>效果（验证mysql持久化）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看mysql情况</span></span><br><span class="line"><span class="string">ll</span> <span class="string">/mnt/data/mysql/dev-www-mysql-0-pvc-2396853f-5aed-4678-bfb7-73ca48e7a7cd/</span></span><br><span class="line"><span class="comment"># total 188488</span></span><br><span class="line"><span class="comment"># drwxrwxrwx 6 systemd-coredump root                 4096 Nov 25 16:21 ./</span></span><br><span class="line"><span class="comment"># drwxrwxrwx 5 root             root                 4096 Nov 25 14:49 ../</span></span><br><span class="line"><span class="comment"># -rw-r----- 1 systemd-coredump systemd-coredump       56 Nov 25 14:49 auto.cnf</span></span><br><span class="line"><span class="comment"># -rw------- 1 systemd-coredump systemd-coredump     1680 Nov 25 14:49 ca-key.pem</span></span><br><span class="line"><span class="comment"># -rw-r--r-- 1 systemd-coredump systemd-coredump     1112 Nov 25 14:49 ca.pem</span></span><br><span class="line"><span class="comment"># -rw-r--r-- 1 systemd-coredump systemd-coredump     1112 Nov 25 14:49 client-cert.pem</span></span><br><span class="line"><span class="comment"># -rw------- 1 systemd-coredump systemd-coredump     1676 Nov 25 14:49 client-key.pem</span></span><br><span class="line"><span class="comment"># -rw-r----- 1 systemd-coredump systemd-coredump      542 Nov 25 16:20 ib_buffer_pool</span></span><br><span class="line"><span class="comment"># -rw-r----- 1 systemd-coredump systemd-coredump 50331648 Nov 25 16:22 ib_logfile0</span></span><br><span class="line"><span class="comment"># -rw-r----- 1 systemd-coredump systemd-coredump 50331648 Nov 25 14:49 ib_logfile1</span></span><br><span class="line"><span class="comment"># -rw-r----- 1 systemd-coredump systemd-coredump 79691776 Nov 25 16:22 ibdata1</span></span><br><span class="line"><span class="comment"># -rw-r----- 1 systemd-coredump systemd-coredump 12582912 Nov 25 16:22 ibtmp1</span></span><br><span class="line"><span class="comment"># drwxr-x--- 2 systemd-coredump systemd-coredump     4096 Nov 25 14:49 mysql/</span></span><br><span class="line"><span class="comment"># lrwxrwxrwx 1 systemd-coredump systemd-coredump       27 Nov 25 16:21 mysql.sock -&gt; /var/run/mysqld/mysqld.sock</span></span><br><span class="line"><span class="comment"># drwxr-x--- 2 systemd-coredump systemd-coredump     4096 Nov 25 14:49 performance_schema/</span></span><br><span class="line"><span class="comment"># -rw------- 1 systemd-coredump systemd-coredump     1680 Nov 25 14:49 private_key.pem</span></span><br><span class="line"><span class="comment"># -rw-r--r-- 1 systemd-coredump systemd-coredump      452 Nov 25 14:49 public_key.pem</span></span><br><span class="line"><span class="comment"># -rw-r--r-- 1 systemd-coredump systemd-coredump     1112 Nov 25 14:49 server-cert.pem</span></span><br><span class="line"><span class="comment"># -rw------- 1 systemd-coredump systemd-coredump     1676 Nov 25 14:49 server-key.pem</span></span><br><span class="line"><span class="comment"># drwxr-x--- 2 systemd-coredump systemd-coredump    12288 Nov 25 14:49 sys/</span></span><br><span class="line"><span class="string">drwxr-x---</span> <span class="number">2</span> <span class="string">systemd-coredump</span> <span class="string">systemd-coredump</span>     <span class="number">4096 </span><span class="string">Nov</span> <span class="number">25</span> <span class="number">16</span><span class="string">:21</span> <span class="string">webstack/</span></span><br></pre></td></tr></table></figure><h3 id="验证："><a href="#验证：" class="headerlink" title="验证："></a>验证：</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_8d945e7a4af63ec585953c76f2668914.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_8d945e7a4af63ec585953c76f2668914.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s创建StorageClass </title>
      <link href="/2024/11/25/k8s%E5%88%9B%E5%BB%BAStorageClass/"/>
      <url>/2024/11/25/k8s%E5%88%9B%E5%BB%BAStorageClass/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="k8s创建StorageClass"><a href="#k8s创建StorageClass" class="headerlink" title="k8s创建StorageClass"></a>k8s创建StorageClass</h2><p><strong>参考：</strong><a href="https://www.cnblogs.com/panwenbin-logs/p/12196286.html#autoid-0-0-0">https://www.cnblogs.com/panwenbin-logs/p/12196286.html#autoid-0-0-0</a></p><h2 id="一、介绍："><a href="#一、介绍：" class="headerlink" title="一、介绍："></a>一、介绍：</h2><p><strong>Kubernetes提供了一套可以自动创建PV的机制,即:Dynamic Provisioning.而这个机制的核心在于:StorageClass这个API对象.</strong></p><p><strong>StorageClass对象会定义下面两部分内容:</strong></p><ul><li><strong>1,PV的属性.比如,存储类型,Volume的大小等.</strong></li><li><strong>2,创建这种PV需要用到的存储插件</strong></li><li><strong>有了这两个信息之后,Kubernetes就能够根据用户提交的PVC,找到一个对应的StorageClass,之后Kubernetes就会调用该StorageClass声明的存储插件,进而创建出需要的PV.</strong></li><li><strong>但是其实使用起来是一件很简单的事情,你只需要根据自己的需求,编写YAML文件即可,然后使用kubectl create命令执行即可</strong></li></ul><h2 id="二、为什么需要StorageClass"><a href="#二、为什么需要StorageClass" class="headerlink" title="二、为什么需要StorageClass"></a>二、为什么需要StorageClass</h2><ul><li><strong>在一个大规模的Kubernetes集群里,可能有成千上万个PVC,这就意味着运维人员必须实现创建出这个多个PV,此外,随着项目的需要,会有新的PVC不断被提交,那么运维人员就需要不断的添加新的,满足要求的PV,否则新的Pod就会因为PVC绑定不到PV而导致创建失败.而且通过 PVC 请求到一定的存储空间也很有可能不足以满足应用对于存储设备的各种需求</strong></li><li><strong>而且不同的应用程序对于存储性能的要求可能也不尽相同，比如读写速度、并发性能等，为了解决这一问题，Kubernetes 又为我们引入了一个新的资源对象：StorageClass，通过 StorageClass 的定义，管理员可以将存储资源定义为某种类型的资源，比如快速存储、慢速存储等，用户根据 StorageClass 的描述就可以非常直观的知道各种存储资源的具体特性了，这样就可以根据应用的特性去申请合适的存储资源了。</strong></li></ul><h2 id="三、StorageClass运行原理及部署流程"><a href="#三、StorageClass运行原理及部署流程" class="headerlink" title="三、StorageClass运行原理及部署流程"></a>三、StorageClass运行原理及部署流程</h2><p><strong>要使用 StorageClass，我们就得安装对应的自动配置程序，比如我们这里存储后端使用的是 nfs，那么我们就需要使用到一个 nfs-client 的自动配置程序，我们也叫它 Provisioner，这个程序使用我们已经配置好的 nfs 服务器，来自动创建持久卷，也就是自动帮我们创建 PV。</strong></p><ul><li><strong>1.自动创建的 PV 以${namespace}-${pvcName}-${pvName}这样的命名格式创建在 NFS 服务器上的共享数据目录中</strong></li><li><strong>2.而当这个 PV 被回收后会以archieved-${namespace}-${pvcName}-${pvName}这样的命名格式存在 NFS 服务器上。</strong></li></ul><h6 id="1-原理及部署流程说明"><a href="#1-原理及部署流程说明" class="headerlink" title="1.原理及部署流程说明"></a>1.原理及部署流程说明</h6><p><strong>详细的运作流程可以参考下图:</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_eda76ec6387be6ea8041aeaaf321a385.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_eda76ec6387be6ea8041aeaaf321a385.png"></p><p><strong>搭建StorageClass+NFS,大致有以下几个步骤:</strong></p><ul><li><strong>1.创建一个可用的NFS Serve</strong></li><li><strong>2.创建Service Account.这是用来管控NFS provisioner在k8s集群中运行的权限</strong></li><li><strong>3.创建StorageClass.负责建立PVC并调用NFS provisioner进行预定的工作,并让PV与PVC建立管理</strong></li><li><strong>4.创建NFS provisioner.有两个功能,一个是在NFS共享目录下创建挂载点(volume),另一个则是建了PV并将PV与NFS的挂载点建立关联</strong></li></ul><h2 id="四、创建StorageClass"><a href="#四、创建StorageClass" class="headerlink" title="四、创建StorageClass"></a>四、创建StorageClass</h2><h3 id="1、创建NFS共享服务"><a href="#1、创建NFS共享服务" class="headerlink" title="1、创建NFS共享服务"></a>1、创建NFS共享服务</h3><p><a href="https://wn.zznnwn.cloudns.biz/2023/09/26/Ubuntu20-04%E4%B8%8A%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AENFS%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8C%82%E8%BD%BD/?highlight=nfs">较为简单见ZzNnWn博客链接</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/srv/nfs4     *(rw,no_subtree_check)</span><br><span class="line">/nfs/data/pv1     *(rw,<span class="built_in">sync</span>,no_subtree_check)</span><br><span class="line">/nfs/data/pv2     *(rw,<span class="built_in">sync</span>,no_subtree_check)</span><br><span class="line">/nfs/data/pv3     10.0.0.0/24(rw,<span class="built_in">sync</span>,no_subtree_check)</span><br><span class="line">/mnt/data/mysql   *(rw,<span class="built_in">sync</span>,no_root_squash,no_subtree_check)</span><br></pre></td></tr></table></figure><h3 id="2、使用以下文档配置account及相关权限"><a href="#2、使用以下文档配置account及相关权限" class="headerlink" title="2、使用以下文档配置account及相关权限"></a>2、使用以下文档配置account及相关权限</h3><p><strong>rbac.yaml:      # 唯一需要修改的地方只有namespace,根据实际情况定义</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>        <span class="comment"># 根据实际环境设定namespace,下面类同</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h3 id="3、创建NFS资源的StorageClass"><a href="#3、创建NFS资源的StorageClass" class="headerlink" title="3、创建NFS资源的StorageClass"></a>3、创建NFS资源的StorageClass</h3><p><strong>nfs-StorageClass.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">managed-nfs-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">qgg-nfs-storage</span> <span class="comment">#这里的名称要和下方provisioner配置文件中的环境变量PROVISIONER_NAME保持一致parameters:  archiveOnDelete: &quot;false&quot;</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="4、创建NFS-provisioner"><a href="#4、创建NFS-provisioner" class="headerlink" title="4、创建NFS provisioner"></a>4、<strong>创建NFS provisioner</strong></h3><p><strong>nfs-provisioner.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>  <span class="comment">#与RBAC文件中的namespace保持一致</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/gegewu-kubernetes/nfs-subdir-external-provisioner:v4.0.2</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">qgg-nfs-storage</span>    <span class="comment"># provisioner名称,请确保该名称与 nfs-StorageClass.yaml文件中的provisioner名称保持一致</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.10</span>          <span class="comment"># NFS Server IP地址</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span>  </span><br><span class="line">              <span class="attr">value:</span> <span class="string">/mnt/data/mysql</span>    <span class="comment"># NFS挂载卷</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.10</span>         <span class="comment"># NFS Server IP地址</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/mnt/data/mysql</span>     <span class="comment"># NFS 挂载卷</span></span><br></pre></td></tr></table></figure><h2 id="五、创建测试pod-检查是否部署成功"><a href="#五、创建测试pod-检查是否部署成功" class="headerlink" title="五、创建测试pod,检查是否部署成功"></a>五、创建测试pod,检查是否部署成功</h2><h3 id="1、Pod-PVC"><a href="#1、Pod-PVC" class="headerlink" title="1、Pod+PVC"></a>1、Pod+PVC</h3><p><strong>创建PVC</strong></p><p><strong>test-claim.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-claim</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">volume.beta.kubernetes.io/storage-class:</span> <span class="string">&quot;managed-nfs-storage&quot;</span>   <span class="comment">#与nfs-StorageClass.yaml metadata.name保持一致</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Mi</span></span><br></pre></td></tr></table></figure><p>验证-<strong>确保PVC状态为Bound</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@k8s1:~<span class="comment"># ls /mnt/data/mysql/</span></span><br><span class="line"><span class="comment"># default-test-claim-pvc-7cd4c19c-8df6-4b1b-ae4a-07fcaed08255</span></span><br><span class="line">root@k8s1:~<span class="comment"># kubectl get pv</span></span><br><span class="line"><span class="comment"># NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS          REASON   AGE</span></span><br><span class="line"><span class="comment"># mysql-pv                                   20Gi       RWO            Retain           Bound    dev/mysql-pvc-20g                                   67m</span></span><br><span class="line"><span class="comment"># pv1                                        5Gi        RWX            Retain           Bound    dev/pvc1                                            9d</span></span><br><span class="line"><span class="comment"># pv2                                        10Gi       RWX            Retain           Bound    dev/pvc2                                            9d</span></span><br><span class="line"><span class="comment"># pvc-7cd4c19c-8df6-4b1b-ae4a-07fcaed08255   1Mi        RWX            Delete           Bound    default/test-claim   managed-nfs-storage            14m</span></span><br><span class="line">root@k8s1:~<span class="comment"># kubectl get pvc</span></span><br><span class="line"><span class="comment"># NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span></span><br><span class="line"><span class="comment"># test-claim   Bound    pvc-7cd4c19c-8df6-4b1b-ae4a-07fcaed08255   1Mi        RWX            managed-nfs-storage   14m</span></span><br></pre></td></tr></table></figure><p><strong>创建测试pod,查看是否可以正常挂载</strong></p><p><strong>test-pod.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.24</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1&quot;</span>   <span class="comment">#创建一个SUCCESS文件后退出</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">&quot;/mnt&quot;</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">&quot;Never&quot;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">test-claim</span>  <span class="comment">#与PVC名称保持一致</span></span><br></pre></td></tr></table></figure><p><strong>检查结果:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-keepalived-155-227 ~]<span class="comment"># ll /data/volumes/default-test-claim-pvc-aae2b7fa-377b-11ea-87ad-525400512eca/   #文件规则是按照$&#123;namespace&#125;-$&#123;pvcName&#125;-$&#123;pvName&#125;创建的</span></span><br><span class="line">总用量 0</span><br><span class="line">-rw-r--r-- 1 root root 0 2020-01-15 17:51 SUCCESS  <span class="comment">#下面有一个 SUCCESS 的文件，证明我们上面的验证是成功</span></span><br></pre></td></tr></table></figure><h6 id="2-StateFulDet-volumeClaimTemplates自动创建PV"><a href="#2-StateFulDet-volumeClaimTemplates自动创建PV" class="headerlink" title="2.StateFulDet+volumeClaimTemplates自动创建PV"></a>2.StateFulDet+volumeClaimTemplates自动创建PV</h6><p><strong>创建无头服务及statefulset</strong></p><p><strong>nginx-statefulset.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-headless</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span>   <span class="comment">#注意此处的值,None表示无头服务</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>  <span class="comment">#两个副本</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">volume.beta.kubernetes.io/storage-class:</span> <span class="string">&quot;managed-nfs-storage&quot;</span>   <span class="comment">#managed-nfs-storage为我们创建的storage-class名称</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><p><strong>或下方例子</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># has to match .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># by default is 1               # 3副本</span></span><br><span class="line">  <span class="comment"># minReadySeconds: 10 # by default is 0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># has to match .spec.selector.matchLabels</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.k8s.io/nginx-slim:0.8</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span>       <span class="comment">#3副本里面都会申请一个存储 此配置就类似pvc了</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]   <span class="comment">#访问模式ReadWriteOnce 允许一个客户进行读写</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;csi-rbd-sc&quot;</span>      <span class="comment">#指定定义的StorageClass</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span>                                             <span class="comment">#申请空间大小</span></span><br></pre></td></tr></table></figure><p><strong>检查结果:</strong></p><p><strong>集群节点上</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f nginx-statefulset.yaml </span><br><span class="line">kubectl get pods -l app=nginx  <span class="comment"># 检查pod状态</span></span><br><span class="line"><span class="comment"># NAME    READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment"># web-0   1/1     Running   0          115m</span></span><br><span class="line"><span class="comment"># web-1   1/1     Running   0          114m</span></span><br><span class="line">kubectl get pvc <span class="comment"># 查看PVC</span></span><br><span class="line"><span class="comment"># NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span></span><br><span class="line"><span class="comment"># test-claim   Bound    pvc-aae2b7fa-377b-11ea-87ad-525400512eca   1Mi        RWX            managed-nfs-storage   19h</span></span><br><span class="line"><span class="comment"># www-web-0    Bound    pvc-4d7e342a-3810-11ea-87ad-525400512eca   1Gi        RWO            managed-nfs-storage   115m</span></span><br><span class="line"><span class="comment"># www-web-1    Bound    pvc-5431c8ba-3810-11ea-87ad-525400512eca   1Gi        RWO            managed-nfs-storage   115m</span></span><br><span class="line">kubectl get pv <span class="comment"># 查看PV</span></span><br><span class="line"><span class="comment"># NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS          REASON   AGE</span></span><br><span class="line"><span class="comment"># pvc-4d7e342a-3810-11ea-87ad-525400512eca   1Gi        RWO            Delete           Bound    default/www-web-0    managed-nfs-storage            115m</span></span><br><span class="line"><span class="comment"># pvc-5431c8ba-3810-11ea-87ad-525400512eca   1Gi        RWO            Delete           Bound    default/www-web-1    managed-nfs-storage            115m</span></span><br><span class="line"><span class="comment"># pvc-aae2b7fa-377b-11ea-87ad-525400512eca   1Mi        RWX            Delete           Bound    default/test-claim   managed-nfs-storage            19h</span></span><br></pre></td></tr></table></figure><p><strong>NFS Server上:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/volumes/</span><br><span class="line">ll  <span class="comment"># 注意目录的命名格式</span></span><br><span class="line"><span class="comment"># 总用量 0</span></span><br><span class="line"><span class="comment"># drwxrwxrwx 2 root root 21 2020-01-15 17:51 default-test-claim-pvc-aae2b7fa-377b-11ea-87ad-525400512eca</span></span><br><span class="line"><span class="comment"># drwxrwxrwx 2 root root  6 2020-01-16 11:28 default-www-web-0-pvc-4d7e342a-3810-11ea-87ad-525400512eca</span></span><br><span class="line"><span class="comment"># drwxrwxrwx 2 root root  6 2020-01-16 11:28 default-www-web-1-pvc-5431c8ba-3810-11ea-87ad-525400512eca</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;web-00&quot;</span> &gt; default-www-web-0-pvc-4d7e342a-3810-11ea-87ad-525400512eca/index.html <span class="comment">#分别创建不同的index文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;web-01&quot;</span> &gt; default-www-web-1-pvc-5431c8ba-3810-11ea-87ad-525400512eca/index.html</span><br></pre></td></tr></table></figure><p><strong>集群任意节点上:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it pod-cm-1 -- /bin/sh  <span class="comment"># 进入集群中任意pod中,解析nginx-headless 服务/ # nslookup nginx-headless</span></span><br><span class="line"><span class="comment"># nslookup: can&#x27;t resolve &#x27;(null)&#x27;: Name does not resolve</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Name:      nginx-headless</span></span><br><span class="line"><span class="comment"># Address 1: 172.17.136.7 172-17-136-7.nginx-headless.default.svc.cluster.local  #可以看到有两个地址</span></span><br><span class="line"><span class="comment"># Address 2: 172.17.248.5 172-17-248-5.nginx-headless.default.svc.cluster.local</span></span><br><span class="line">curl 172.17.248.5 <span class="comment"># 分别访问一下查看结果</span></span><br><span class="line"><span class="comment"># web-00</span></span><br><span class="line">curl 172.17.136.7</span><br><span class="line"><span class="comment"># web-01</span></span><br></pre></td></tr></table></figure><p><strong>对于statefulset我们可以通过添加/删除pod副本的数量,观察PV/PVC的状态及变化.</strong></p><h2 id="六、关于StorageClass回收策略对数据的影响"><a href="#六、关于StorageClass回收策略对数据的影响" class="headerlink" title="六、关于StorageClass回收策略对数据的影响"></a>六、关于StorageClass回收策略对数据的影响</h2><h6 id="1-第一种配置"><a href="#1-第一种配置" class="headerlink" title="1.第一种配置"></a>1.第一种配置</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">archiveOnDelete:</span> <span class="string">&quot;false&quot;</span>  </span><br><span class="line">   <span class="attr">reclaimPolicy:</span> <span class="string">Delete</span>   <span class="comment"># 默认没有配置,默认值为Delete</span></span><br></pre></td></tr></table></figure><p><strong>测试结果:</strong></p><ul><li><strong>1.pod删除重建后数据依然存在,旧pod名称及数据依然保留给新pod使用</strong></li><li><strong>2.sc删除重建后数据依然存在,旧pod名称及数据依然保留给新pod使用</strong></li><li><strong>3.删除PVC后,PV被删除且NFS Server对应数据被删除</strong></li></ul><h6 id="2-第二种配置"><a href="#2-第二种配置" class="headerlink" title="2.第二种配置"></a>2.第二种配置</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">archiveOnDelete:</span> <span class="string">&quot;false&quot;</span>  </span><br><span class="line">   <span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure><p><strong>测试结果:</strong></p><ul><li><strong>1.pod删除重建后数据依然存在,旧pod名称及数据依然保留给新pod使用</strong></li><li><strong>2.sc删除重建后数据依然存在,旧pod名称及数据依然保留给新pod使用</strong></li><li><strong>3.删除PVC后,PV不会被删除,且状态由Bound变为Released,NFS Server对应数据被保留</strong></li><li><strong>4.重建sc后,新建PVC会绑定新的pv,旧数据可以通过拷贝到新的PV中</strong></li></ul><h6 id="3-第三种配置"><a href="#3-第三种配置" class="headerlink" title="3.第三种配置"></a>3.第三种配置</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">archiveOnDelete:</span> <span class="string">&quot;ture&quot;</span>  </span><br><span class="line">   <span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure><p><strong>结果:</strong></p><ul><li><strong>1.pod删除重建后数据依然存在,旧pod名称及数据依然保留给新pod使用</strong></li><li><strong>2.sc删除重建后数据依然存在,旧pod名称及数据依然保留给新pod使用</strong></li><li><strong>3.删除PVC后,PV不会别删除,且状态由Bound变为Released,NFS Server对应数据被保留</strong></li><li><strong>4.重建sc后,新建PVC会绑定新的pv,旧数据可以通过拷贝到新的PV中</strong></li></ul><h6 id="4-第四种配置"><a href="#4-第四种配置" class="headerlink" title="4.第四种配置"></a>4.第四种配置</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">archiveOnDelete:</span> <span class="string">&quot;ture&quot;</span>  </span><br><span class="line">  <span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br></pre></td></tr></table></figure><p><strong>结果:</strong></p><ul><li><strong>1.pod删除重建后数据依然存在,旧pod名称及数据依然保留给新pod使用</strong></li><li><strong>2.sc删除重建后数据依然存在,旧pod名称及数据依然保留给新pod使用</strong></li><li><strong>3.删除PVC后,PV不会别删除,且状态由Bound变为Released,NFS Server对应数据被保留</strong></li><li><strong>4.重建sc后,新建PVC会绑定新的pv,旧数据可以通过拷贝到新的PV中</strong></li></ul><p><strong>总结:除以第一种配置外,其他三种配置在PV/PVC被删除后数据依然保留</strong></p><h2 id="七、常见问题"><a href="#七、常见问题" class="headerlink" title="七、常见问题"></a>七、常见问题</h2><h6 id="1-如何设置默认的StorageClass"><a href="#1-如何设置默认的StorageClass" class="headerlink" title="1.如何设置默认的StorageClass"></a>1.如何设置默认的StorageClass</h6><p><strong>我们可以用 kubectl patch 命令来更新：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sc  <span class="comment"># 查看当前sc </span></span><br><span class="line"><span class="comment"># NAME                  PROVISIONER       AGE </span></span><br><span class="line"><span class="comment"># managed-nfs-storage   qgg-nfs-storage   20h</span></span><br><span class="line">kubectl patch storageclass managed-nfs-storage -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span>  <span class="comment"># 设置managed-nfs-storage为默认后端存储</span></span><br><span class="line"><span class="comment"># storageclass.storage.k8s.io/managed-nfs-storage patched</span></span><br><span class="line">kubectl get sc  <span class="comment"># 再次查看,注意是否有default标识</span></span><br><span class="line"><span class="comment"># NAME                            PROVISIONER       AGE</span></span><br><span class="line"><span class="comment"># managed-nfs-storage (default)   qgg-nfs-storage   20h</span></span><br><span class="line">kubectl patch storageclass managed-nfs-storage -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;false&quot;&#125;&#125;&#125;&#x27;</span> <span class="comment">#取消默认存储后端</span></span><br><span class="line"><span class="comment"># storageclass.storage.k8s.io/managed-nfs-storage patched</span></span><br><span class="line">kubectl get sc</span><br><span class="line"><span class="comment"># NAME                  PROVISIONER       AGE</span></span><br><span class="line"><span class="comment"># managed-nfs-storage   qgg-nfs-storage   20h</span></span><br></pre></td></tr></table></figure><h6 id="YAML文件"><a href="#YAML文件" class="headerlink" title="YAML文件"></a>YAML文件</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">managed-nfs-storage</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">&quot;storageclass.kubernetes.io/is-default-class&quot;:</span> <span class="string">&quot;true&quot;</span>   <span class="comment"># 添加此注释</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">qgg-nfs-storage</span>                                <span class="comment"># or choose another name, must match deployment&#x27;s env PROVISIONER_NAME&#x27;</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure><h6 id="2-如何使用默认的StorageClass"><a href="#2-如何使用默认的StorageClass" class="headerlink" title="2.如何使用默认的StorageClass"></a>2.如何使用默认的StorageClass</h6><p><strong>如果集群有一个默认的StorageClass能够满足我们的需求，那么剩下所有需要做的就是创建PersistentVolumeClaim(PVC)，剩下的都有默认的动态配置搞定，包括无需去指定storageClassName：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">mypvc</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">testns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">accessModes:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"> <span class="attr">resources:</span></span><br><span class="line">   <span class="attr">requests:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">10Gi</span></span><br></pre></td></tr></table></figure><h6 id="3-修改默回收策略-默认为Delete"><a href="#3-修改默回收策略-默认为Delete" class="headerlink" title="3.修改默回收策略(默认为Delete)"></a>3.修改默回收策略(默认为Delete)</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">managed-nfs-storage</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">qgg-nfs-storage</span> <span class="comment">#or choose another name, must match deployment&#x27;s env PROVISIONER_NAME&#x27;</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;ture&quot;</span> <span class="comment"># 暂时不清楚该值对回收策略产生什么影响</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span>     <span class="comment"># 只有NFS 和hostPth支持两种回收策略</span></span><br></pre></td></tr></table></figure><h6 id="4-能过删除-关闭默认的StorageClass"><a href="#4-能过删除-关闭默认的StorageClass" class="headerlink" title="4.能过删除/关闭默认的StorageClass"></a>4.能过删除/关闭默认的StorageClass</h6><ul><li><strong>不能删除默认的StorageClass，因为它是作为集群的add-on安装的，如果它被删除，会被重新安装。</strong></li><li><strong>当然，可以停掉默认的StorageClass行为，通过删除annotation：storageclass.beta.kubernetes.io/is-default-class,或者设置为false。</strong></li><li><strong>如果没有StorageClass对象标记默认的annotation，那么PersistentVolumeClaim对象（在不指定StorageClass情况下）将不自动触发动态配置。相反，它们将回到绑定可用的*PersistentVolume(PV)*的状态。</strong></li></ul><h6 id="5-当删除PersistentVolumeClaim-PVC-会发生什么"><a href="#5-当删除PersistentVolumeClaim-PVC-会发生什么" class="headerlink" title="5.当删除PersistentVolumeClaim(PVC)会发生什么"></a>5.当删除PersistentVolumeClaim(PVC)会发生什么</h6><ul><li><strong>如果一个卷是动态配置的卷，则默认的回收策略为“删除”。这意味着，在默认的情况下，当PVC被删除时，基础的PV和对应的存储也会被删除。如果需要保留存储在卷上的数据，则必须在PV被设置之后将回收策略从delete更改为retain。</strong></li></ul><p><strong>参考文档:</strong><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client">https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client</a></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix使用企业微信机器人报警及中文乱码解决</title>
      <link href="/2024/11/20/zabbix%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%A5%E8%AD%A6%E5%8F%8A%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3/"/>
      <url>/2024/11/20/zabbix%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%A5%E8%AD%A6%E5%8F%8A%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="zabbix使用企业微信机器人报警及中文乱码解决"><a href="#zabbix使用企业微信机器人报警及中文乱码解决" class="headerlink" title="zabbix使用企业微信机器人报警及中文乱码解决"></a>zabbix使用企业微信机器人报警及中文乱码解决</h2><p>前言：</p><p><a href="https://sunlight.zznnwn.cloudns.biz/2024/03/28/zabbix%E7%9B%91%E6%8E%A7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%85%8D%E7%BD%AE%E6%8A%A5%E8%AD%A6%E5%8F%8Agrafana%E9%9D%A2%E6%9D%BF%E8%AE%BE%E7%BD%AE/?highlight=zabbix">传统企业微信创建应用方式报警</a>目前已收费 采用免费方式 企微机器人</p><h2 id="一、企业微信设置"><a href="#一、企业微信设置" class="headerlink" title="一、企业微信设置"></a>一、企业微信设置</h2><p>企业微信创建报警机器人</p><p><a href="https://open.work.weixin.qq.com/help2/pc/14931?person_id=1&is_tencent=">如何设置群机器人 -帮助中心-企业微信</a></p><p>wechat.py文件留存</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 机器人的webhook地址</span></span><br><span class="line">API_URL = <span class="string">&quot;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=42d6sdhfj0205-77c0-4ef6-b903-2953bd705a65&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP请求头部信息</span></span><br><span class="line">HEADERS = &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json;charset=utf-8&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义发送消息的函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_text</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="comment"># 构建消息体</span></span><br><span class="line">    texts = &#123;</span><br><span class="line">        <span class="string">&quot;msgtype&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;text&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: text</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 发送HTTP POST请求</span></span><br><span class="line">    response = requests.post(API_URL, json=texts, headers=HEADERS)</span><br><span class="line">    <span class="comment"># 打印响应内容（一般用于调试）</span></span><br><span class="line">    <span class="built_in">print</span>(response.content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果该文件被直接执行，则从命令行接收一个参数并将其发送到机器人的webhook地址</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python send_text.py &lt;text&gt;&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    text = sys.argv[<span class="number">1</span>]  <span class="comment"># 获取命令行参数</span></span><br><span class="line">    send_text(text)  <span class="comment"># 发送消息</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="二、zabbix设置"><a href="#二、zabbix设置" class="headerlink" title="二、zabbix设置"></a>二、zabbix设置</h2><p><a href="https://www.cnblogs.com/xiykj/p/18075308">https://www.cnblogs.com/xiykj/p/18075308</a></p><ul><li>脚本上传在服务器目录：/usr/lib/zabbix/alertscripts/wechat.py</li><li>脚本名称与后端脚本一致</li></ul><h3 id="1、管理-gt-媒介"><a href="#1、管理-gt-媒介" class="headerlink" title="1、管理 &gt; 媒介"></a>1、<strong>管理 &gt; 媒介</strong></h3><p>脚本参数：{ALERT.MESSAGE}</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_27569bb10a7b517c588e991a55b3076f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_27569bb10a7b517c588e991a55b3076f.png"></p><h3 id="2、配置-gt-动作-gt-触发器动作-gt-创建动作微信告警"><a href="#2、配置-gt-动作-gt-触发器动作-gt-创建动作微信告警" class="headerlink" title="2、配置 &gt; 动作 &gt; 触发器动作 &gt; 创建动作微信告警"></a>2、<strong>配置 &gt; 动作 &gt; 触发器动作 &gt; 创建动作微信告警</strong></h3><p>动作</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_24b86c8fafc0c9377f51fdc138baa7be.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_24b86c8fafc0c9377f51fdc138baa7be.png"></p><h4 id="2-1、操作（报警发送定义）"><a href="#2-1、操作（报警发送定义）" class="headerlink" title="2.1、操作（报警发送定义）"></a>2.1、<strong>操作（报警发送定义）</strong></h4><p><strong>主题</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">故障&#123;TRIGGER.STATUS&#125;,服务器:&#123;HOSTNAME1&#125;发生: &#123;TRIGGER.NAME&#125;故障!</span><br></pre></td></tr></table></figure><p><strong>消息</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">告警主机:&#123;HOSTNAME1&#125;</span><br><span class="line">告警地址：&#123;HOST.IP&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2、操作（报警恢复定义）"><a href="#2-2、操作（报警恢复定义）" class="headerlink" title="2.2、操作（报警恢复定义）"></a>2.2、<strong>操作（报警恢复定义）</strong></h4><p>主题</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">故障恢复&#123;TRIGGER.STATUS&#125;,服务器:&#123;HOSTNAME1&#125;发生: &#123;TRIGGER.NAME&#125;已恢复!</span><br></pre></td></tr></table></figure><p>消息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">恢复告警主机:&#123;HOSTNAME1&#125;</span><br><span class="line">告警地址：&#123;HOST.IP&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure><h3 id="3、管理-gt-用户"><a href="#3、管理-gt-用户" class="headerlink" title="3、管理 &gt; 用户"></a>3、管理 &gt; 用户</h3><p><strong>设置报警媒介微信报警</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_6ef34bc43ecb4959cb775b2900463692.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_6ef34bc43ecb4959cb775b2900463692.png"></p><h2 id="三、设置中文及解决中文乱码"><a href="#三、设置中文及解决中文乱码" class="headerlink" title="三、设置中文及解决中文乱码"></a>三、设置中文及解决中文乱码</h2><p><a href="https://www.cnblogs.com/GEGEWU-/p/16452198.html">zabbix图形界面显示方框+zabbix web页面不支持中文 - GEGEWU- - 博客园</a></p><h3 id="1、zabbix不支持中文切换"><a href="#1、zabbix不支持中文切换" class="headerlink" title="1、zabbix不支持中文切换"></a>1、zabbix不支持中文切换</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装中文支持包language-pack-zh-hans：</span></span><br><span class="line">sudo apt-get install language-pack-zh-hans</span><br></pre></td></tr></table></figure><h3 id="2、中文乱码解决"><a href="#2、中文乱码解决" class="headerlink" title="2、中文乱码解决"></a>2、中文乱码解决</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_f5f4b7bd2107721e3babedd0bc6bda81.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_f5f4b7bd2107721e3babedd0bc6bda81.png"></p><h4 id="2-1、从Windows系列系统复制一种中文字体："><a href="#2-1、从Windows系列系统复制一种中文字体：" class="headerlink" title="2.1、从Windows系列系统复制一种中文字体："></a>2.1、从Windows系列系统复制一种中文字体：</h4><ul><li>windows存放字体目录<code>C:\Windows\Fonts</code>复制一个中文字 SIMKAI.TTF<br>字体留存<a href="https://onenote.zznnwn.cloudns.biz/api/raw/?path=/%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93/graphfont.ttf">onedrive</a></li></ul><p>查看zabbix安装路径的方法：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 或者直接 </span><br><span class="line">whereis zabbix</span><br><span class="line"><span class="built_in">find</span> / -name <span class="string">&quot;fornts &quot;</span> </span><br><span class="line"># 搜索目录 </span><br><span class="line"><span class="built_in">find</span> / -name <span class="string">&quot;graphfont.ttf&quot;</span></span><br><span class="line"># 备份原字体文件 </span><br><span class="line">cp /usr/share/zabbix/assets/fonts/graphfont.ttf&#123;,.bak&#125;        (ubuntu部署所在目录)</span><br><span class="line"># 上传中文字体文件到该目录</span><br><span class="line">rz</span><br><span class="line"># 删除软连接默认字体文件</span><br><span class="line">rm -f graphfont.ttf</span><br><span class="line"># 将上传的字体文件重命名为</span><br><span class="line">mv SIMKAI.TTF graphfont.ttf </span><br><span class="line"># 授予权限 刷新web页面此时生效</span><br><span class="line">chmod <span class="number">777</span> graphfont.ttf</span><br></pre></td></tr></table></figure><p><strong>备注</strong></p><ul><li><code>ls -l</code>可以看到默认文件已配置软连接</li></ul><h4 id="2、修改php配置文件（错误配置不操作）"><a href="#2、修改php配置文件（错误配置不操作）" class="headerlink" title="2、修改php配置文件（错误配置不操作）"></a>2、修改php配置文件（错误配置不操作）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zabbix使用的是php配置文件: /usr/share/zabbix/include/defines.inc.php</span></span><br><span class="line"><span class="comment"># 备份</span></span><br><span class="line"><span class="built_in">cp</span> /usr/share/zabbix/include/defines.inc.php&#123;,.bak&#125;</span><br><span class="line">vim  /usr/share/zabbix/include/defines.inc.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到ZBX_GRAPH_FONT_NAME   ZBX_FONT_NAME  并修改对应的内容</span></span><br><span class="line"><span class="comment"># 原内容如下：</span></span><br><span class="line">define(‘ZBX_GRAPH_FONT_NAME’,        ‘DejaVuSans’);</span><br><span class="line">define(‘ZBX_FONT_NAME’, ‘DejaVuSans’);</span><br><span class="line"><span class="comment"># 修改成以下内容：</span></span><br><span class="line">define(‘ZBX_GRAPH_FONT_NAME’,        ‘simsun’);</span><br><span class="line">define(‘ZBX_FONT_NAME’, ‘simsun’);</span><br></pre></td></tr></table></figure><p>备注：这里不需要添加文件后缀名</p><p>最后重启：systemctl restart zabbix-server zabbix-agent nginx php7.4-fpm</p>]]></content>
      
      
      <categories>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s创建基于nfs版的pv与pvc并部署PVC版cloudreve</title>
      <link href="/2024/11/15/k8s%E5%88%9B%E5%BB%BA%E5%9F%BA%E4%BA%8Enfs%E7%89%88%E7%9A%84pv%E4%B8%8Epvc%E5%B9%B6%E9%83%A8%E7%BD%B2PVC%E7%89%88cloudreve/"/>
      <url>/2024/11/15/k8s%E5%88%9B%E5%BB%BA%E5%9F%BA%E4%BA%8Enfs%E7%89%88%E7%9A%84pv%E4%B8%8Epvc%E5%B9%B6%E9%83%A8%E7%BD%B2PVC%E7%89%88cloudreve/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="k8s创建基于nfs版的pv与pvc并部署PVC版cloudreve"><a href="#k8s创建基于nfs版的pv与pvc并部署PVC版cloudreve" class="headerlink" title="k8s创建基于nfs版的pv与pvc并部署PVC版cloudreve"></a>k8s创建基于nfs版的pv与pvc并部署PVC版cloudreve</h2><h2 id="一、基于nfs存储部署二副本cloudreve"><a href="#一、基于nfs存储部署二副本cloudreve" class="headerlink" title="一、基于nfs存储部署二副本cloudreve"></a>一、基于nfs存储部署二副本cloudreve</h2><h3 id="1、环境（在nfs共享文件夹内创建挂载目录）"><a href="#1、环境（在nfs共享文件夹内创建挂载目录）" class="headerlink" title="1、环境（在nfs共享文件夹内创建挂载目录）"></a>1、环境（在nfs共享文件夹内创建挂载目录）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建挂载目录</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /srv/nfs4/cloudreve-storage</span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /srv/nfs4/config</span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /srv/nfs4/cloudreve/uploads</span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /srv/nfs4/cloudreve/avatar</span><br><span class="line">sudo <span class="built_in">chmod</span> -R 777 /srv/nfs4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置共享目录</span></span><br><span class="line">vim /etc/exports</span><br><span class="line"></span><br><span class="line"><span class="comment"># /srv/nfs4     *(rw,no_subtree_check)</span></span><br><span class="line"><span class="comment"># /nfs/data/pv1     *(rw,sync,no_subtree_check)</span></span><br><span class="line"><span class="comment"># /nfs/data/pv2     *(rw,sync,no_subtree_check)</span></span><br><span class="line"><span class="comment"># /nfs/data/pv3     10.0.0.0/24(rw,sync,no_subtree_check)</span></span><br></pre></td></tr></table></figure><h3 id="2、cloudreve-yaml文件"><a href="#2、cloudreve-yaml文件" class="headerlink" title="2、cloudreve.yaml文件"></a>2、cloudreve.yaml文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">metadata:</span>            <span class="comment"># 源数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cloudreve</span>    <span class="comment"># 当前deployment所属的名字</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>     <span class="comment"># 及ns  </span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">cloudreve</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">cloudreve</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudreve</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:xavierniu_cloudreve_3.4.2</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5212</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudreve-storage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/cloudreve</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/cloudreve/config</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">uploads-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/cloudreve/uploads</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">avatar-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/cloudreve/avatar</span></span><br><span class="line">          <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudreve-storage</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">58.49</span><span class="number">.1</span><span class="number">.8</span> </span><br><span class="line">            <span class="attr">path:</span> <span class="string">/srv/nfs4/cloudreve-storage</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">58.49</span><span class="number">.1</span><span class="number">.8</span> </span><br><span class="line">            <span class="attr">path:</span> <span class="string">/srv/nfs4/config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">uploads-volume</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">58.49</span><span class="number">.1</span><span class="number">.8</span> </span><br><span class="line">            <span class="attr">path:</span> <span class="string">/srv/nfs4/cloudreve/uploads</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">avatar-volume</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">58.49</span><span class="number">.1</span><span class="number">.8</span> </span><br><span class="line">            <span class="attr">path:</span> <span class="string">/srv/nfs4/cloudreve/avatar</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">cloudreve-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">cloudreve</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9005</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">5212</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span>   </span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure><p><strong>查看默认账户密码</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs cloudreve-598f69459c-nkbrd</span><br><span class="line">   ___ _                 _              </span><br><span class="line">  / __\ | ___  _   _  __| |_ __ _____   _____ </span><br><span class="line"> / /  | |/ _ \| | | |/ _  | <span class="string">&#x27;__/ _ \ \ / / _ \</span></span><br><span class="line"><span class="string">/ /___| | (_) | |_| | (_| | | |  __/\ V /  __/</span></span><br><span class="line"><span class="string">\____/|_|\___/ \__,_|\__,_|_|  \___| \_/ \___|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   V3.4.2  Commit #a11f819  Pro=false</span></span><br><span class="line"><span class="string">================================================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Info]    2024-11-15 15:10:43 初始化数据库连接</span></span><br><span class="line"><span class="string">[Info]    2024-11-15 15:10:43 开始进行数据库初始化...</span></span><br><span class="line"><span class="string">[Info]    2024-11-15 15:10:43 初始管理员账号：admin@cloudreve.org</span></span><br><span class="line"><span class="string">[Info]    2024-11-15 15:10:43 初始管理员密码：scoXZsMt</span></span><br><span class="line"><span class="string">[Info]    2024-11-15 15:10:43 开始执行数据库脚本 [UpgradeTo3.4.0]</span></span><br><span class="line"><span class="string">[Info]    2024-11-15 15:10:43 数据库初始化结束</span></span><br><span class="line"><span class="string">[Info]    2024-11-15 15:10:43 初始化任务队列，WorkerNum = 10</span></span><br><span class="line"><span class="string">[Info]    2024-11-15 15:10:43 初始化定时任务...</span></span><br><span class="line"><span class="string">[Info]    2024-11-15 15:10:43 当前运行模式：M</span></span><br></pre></td></tr></table></figure><h3 id="二、基于PVC版cloudreve部署"><a href="#二、基于PVC版cloudreve部署" class="headerlink" title="二、基于PVC版cloudreve部署"></a>二、基于PVC版cloudreve部署</h3><h4 id="1、创建PV卷"><a href="#1、创建PV卷" class="headerlink" title="1、创建PV卷"></a>1、创建PV卷</h4><h5 id="1-1、设置底层存储"><a href="#1-1、设置底层存储" class="headerlink" title="1.1、设置底层存储"></a>1.1、设置底层存储</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="built_in">mkdir</span>  -pv  /nfs/data/&#123;pv1,pv2,pv3&#125; </span><br><span class="line"><span class="built_in">chmod</span> 777 -R /nfs/data/&#123;pv1,pv2,pv3&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露服务</span></span><br><span class="line">vim /etc/exports</span><br><span class="line"></span><br><span class="line">/nfs/data/pv1     *(rw,<span class="built_in">sync</span>,no_subtree_check)</span><br><span class="line">/nfs/data/pv2     *(rw,<span class="built_in">sync</span>,no_subtree_check)</span><br><span class="line">/nfs/data/pv3     10.0.0.0/24(rw,<span class="built_in">sync</span>,no_subtree_check)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">systemctl restart nfs</span><br><span class="line">systemctl <span class="built_in">enable</span> nfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生效</span></span><br><span class="line">exportfs -rav</span><br></pre></td></tr></table></figure><p><strong>创建PV卷使用nfs类型（pv.yml）</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>  <span class="string">pv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span> </span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs/data/pv1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">58.49</span><span class="number">.1</span><span class="number">.8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>  <span class="string">pv2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span> </span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs/data/pv2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">58.49</span><span class="number">.1</span><span class="number">.8</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure><h5 id="1-2、申请PVC（pvc-yml）"><a href="#1-2、申请PVC（pvc-yml）" class="headerlink" title="1.2、申请PVC（pvc.yml）"></a>1.2、申请PVC（pvc.yml）</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">5Gi</span></span><br></pre></td></tr></table></figure><h4 id="2、基于PVC申请后端容量创建"><a href="#2、基于PVC申请后端容量创建" class="headerlink" title="2、基于PVC申请后端容量创建"></a>2、基于PVC申请后端容量创建</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">metadata:</span>            <span class="comment"># 源数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cloudreve</span>    <span class="comment"># 当前deployment所属的名字</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>     <span class="comment"># 及ns  </span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">cloudreve</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">cloudreve</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudreve</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:xavierniu_cloudreve_3.4.2</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5212</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudreve-storage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/cloudreve</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudreve-storage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/cloudreve/config</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudreve-storage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/cloudreve/uploads</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudreve-storage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/cloudreve/avatar</span></span><br><span class="line">          <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudreve-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">pvc1</span></span><br><span class="line">            <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">            <span class="comment"># 不可写true即可读不可写</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cloudreve-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>  </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">cloudreve</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="comment"># 宿主机端口</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9005</span></span><br><span class="line">      <span class="comment"># 容器端口</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">5212</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span>  <span class="comment"># 设置会话亲和性使其转发到上一次访问的会话中</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>  </span><br></pre></td></tr></table></figure><h3 id="三、效果"><a href="#三、效果" class="headerlink" title="三、效果"></a>三、效果</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_bd516f0e473a2922cafd3ff154c7df7c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_bd516f0e473a2922cafd3ff154c7df7c.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1、k8s介绍等</title>
      <link href="/2024/11/13/1%E3%80%81k8s%E4%BB%8B%E7%BB%8D%E7%AD%89/"/>
      <url>/2024/11/13/1%E3%80%81k8s%E4%BB%8B%E7%BB%8D%E7%AD%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="一、k8s介绍等"><a href="#一、k8s介绍等" class="headerlink" title="一、k8s介绍等"></a>一、k8s介绍等</h2><h2 id="结构图"><a href="#结构图" class="headerlink" title="结构图"></a>结构图</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_6b8621f97808d6a7af7dace1e9b95dcd.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_6b8621f97808d6a7af7dace1e9b95dcd.png"></p><h2 id="k8s笔记"><a href="#k8s笔记" class="headerlink" title="k8s笔记"></a><strong>k8s笔记</strong></h2><p><strong>NameSpace</strong>：命名空间，用来隔离 <strong>pod</strong> 的运行环境</p><h2 id="集群类型"><a href="#集群类型" class="headerlink" title="集群类型"></a>集群类型</h2><p><strong>一主多从与多主多从</strong> 生产环境使用 <strong>多主多从</strong></p><p>学习 <strong>kubernetes</strong> 的核心，就是学习如何对集群上的<code>Pod、Pod控制器、Service、存储</code>等各种资源进行操作</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_a9943ac676cc7c29a16e7c0293ce8047.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_a9943ac676cc7c29a16e7c0293ce8047.png"></p><h4 id="2-7集群部署完成测试（成功后则部署成功）"><a href="#2-7集群部署完成测试（成功后则部署成功）" class="headerlink" title="2.7集群部署完成测试（成功后则部署成功）"></a><code>2.7</code>集群部署完成测试（成功后则部署成功）</h4><h5 id="2-7-1-创建一个nginx服务"><a href="#2-7-1-创建一个nginx服务" class="headerlink" title="2.7.1 创建一个nginx服务"></a>2.7.1 创建一个nginx服务</h5><p>kubectl create deployment nginx  –image=registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</p><h5 id="2-7-2、暴露端口"><a href="#2-7-2、暴露端口" class="headerlink" title="2.7.2、暴露端口"></a>2.7.2、暴露端口</h5><p>kubectl expose deploy nginx  –port=80 –target-port=80  –type=NodePort</p><h5 id="2-7-3、查看服务"><a href="#2-7-3、查看服务" class="headerlink" title="2.7.3、查看服务"></a>2.7.3、查看服务</h5><p><strong>kubectl get pod,svc</strong></p><h5 id="2-7-4、查看pod"><a href="#2-7-4、查看pod" class="headerlink" title="2.7.4、查看pod"></a>2.7.4、查看pod</h5><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_4e3d1924d8a957214363670284e29bb0.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_4e3d1924d8a957214363670284e29bb0.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pve重启或重装报错initramfs</title>
      <link href="/2024/11/07/pve%E9%87%8D%E5%90%AF%E6%88%96%E9%87%8D%E8%A3%85%E6%8A%A5%E9%94%99initramfs/"/>
      <url>/2024/11/07/pve%E9%87%8D%E5%90%AF%E6%88%96%E9%87%8D%E8%A3%85%E6%8A%A5%E9%94%99initramfs/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="pve重启或重装报错initramfs"><a href="#pve重启或重装报错initramfs" class="headerlink" title="pve重启或重装报错initramfs"></a>pve重启或重装报错initramfs</h2><p>报错信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">initramfs)zpool import</span><br><span class="line">pool: rpoolid:6053000132496112234state: UNAVAIL</span><br><span class="line">status:0ne or more devices contains corrupted data.action: The pool cannot be imported due to damaged devices or data.see:https://openzfs.github.io/openzfs-docs/msg/2FS-8000-5Econfig:</span><br><span class="line">rpoo l</span><br><span class="line">UNAVA II.insufficient replicas</span><br><span class="line">mirror-0UNAVA ILinsufficient replicas</span><br><span class="line">nume0n1UNAVA IIinvalid labe l</span><br><span class="line">nume1n1UNAVA ILinva l <span class="built_in">id</span> label</span><br><span class="line">p001:rp00id :7811380569249672400</span><br><span class="line">state:ONLINE</span><br><span class="line">action:The pool can be imported using its name or numeric identifierconf ig :</span><br><span class="line">rpoo lONL INEmirror-0ONL,INEata-SAMSUNG M2?L3480HCHQ-00B7CS6KLNNOW902?40-part3ONL INEata-SAMSUNG M2?L3480HCHQ-00B7C S6KLNNOW?4?226-part3ONLINE</span><br><span class="line">initnamfe</span><br></pre></td></tr></table></figure><blockquote><p>参考：GPT4回答</p><p>出现 <code>more than one matching pool</code> 错误，表示系统检测到多个名称相同的 ZFS 存储池（通常是由于磁盘克隆或重复），因此无法确定要导入哪个存储池。要解决这个问题，可以通过指定唯一的存储池 ID 来直接导入特定的池。</p><p>步骤如下：</p><ol><li><p><strong>列出所有可用的存储池及其唯一 ID</strong>：<br>在 <code>initramfs</code> 提示符下，运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool import</span><br></pre></td></tr></table></figure><p>这会显示所有可用的存储池列表，并附带每个池的唯一 ID。</p></li><li><p><strong>找到要导入的存储池的确切 ID</strong>：<br>确定需要导入的 <code>rpool</code> 的唯一 ID。在列表中找到相应池的 ID。</p></li><li><p><strong>使用存储池 ID 导入池</strong>：<br>使用上一步查到的池 ID 来导入池，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool import -f -R /mnt 6053000132496112234</span><br></pre></td></tr></table></figure><ul><li>把 <code>6053000132496112234</code> 替换为你要导入的存储池的唯一 ID。</li><li><code>-f</code> 参数强制导入，<code>-R /mnt</code> 用于指定根池的挂载点，可根据系统情况调整 <code>/mnt</code>。</li></ul></li><li><p><strong>继续启动系统</strong>：<br>存储池成功导入后，退出 <code>initramfs</code> 提示符：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>系统应继续启动。</p></li></ol><p>根据错误信息，<code>rpool</code> 池的状态为 <code>UNAVAIL</code>，且包含受损的数据或设备，导致无法导入。这通常是由于设备损坏或标签（label）损坏引起的。同时，还显示了另一个可用的池 ID 为 <code>7811380569249672400</code>，且状态为 <code>ONLINE</code>。</p><p>以下是尝试解决问题的步骤：</p><h3 id="1-选择可用的池"><a href="#1-选择可用的池" class="headerlink" title="1. 选择可用的池"></a>1. 选择可用的池</h3><p>在显示的两个池中，有一个 <code>rpool</code> 状态为 <code>ONLINE</code>，可以尝试导入这个可用的池。使用以下命令按其唯一 ID 导入它：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool import -f -R /mnt 7811380569249672400</span><br></pre></td></tr></table></figure><ul><li><code>-f</code> 强制导入，<code>-R /mnt</code> 指定根目录的挂载点。</li></ul><h3 id="2-检查是否可以继续启动"><a href="#2-检查是否可以继续启动" class="headerlink" title="2. 检查是否可以继续启动"></a>2. 检查是否可以继续启动</h3><p>导入成功后，退出 <code>initramfs</code> 提示符：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><h3 id="3-修复损坏的池（如果导入成功）"><a href="#3-修复损坏的池（如果导入成功）" class="headerlink" title="3. 修复损坏的池（如果导入成功）"></a>3. 修复损坏的池（如果导入成功）</h3><p>如果系统成功启动，您可以在系统内对池 <code>6053000132496112234</code> 进行进一步的检查和修复：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool status</span><br><span class="line">zpool scrub rpool</span><br></pre></td></tr></table></figure><p>您遇到的错误表明 <code>rpool</code> 池无法导入，因为其镜像中的设备（<code>nvme0n1</code> 和 <code>nvme1n1</code>）包含损坏或无效的标签，这可能导致 <code>rpool</code> 状态不可用（<code>UNAVAIL</code>），并显示“insufficient replicas”（副本不足）。这是由于硬件损坏、文件系统故障或池元数据损坏引起的。</p><p>以下是您可以尝试的步骤：</p><h3 id="1-检查设备是否连接正常"><a href="#1-检查设备是否连接正常" class="headerlink" title="1. 检查设备是否连接正常"></a>1. 检查设备是否连接正常</h3><p>在某些情况下，设备可能未完全连接或出现了接触不良。尝试重新连接或检查 <code>nvme0n1</code> 和 <code>nvme1n1</code> 设备的物理状态。</p><h3 id="2-强制导入只读模式"><a href="#2-强制导入只读模式" class="headerlink" title="2. 强制导入只读模式"></a>2. 强制导入只读模式</h3><p>如果您只需要读取数据，可以尝试以只读模式强制导入受损的池，这有时可以避免进一步损坏数据：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool import -o <span class="built_in">readonly</span>=on -f -R /mnt 6053000132496112234</span><br></pre></td></tr></table></figure><ul><li><code>-o readonly=on</code> 以只读方式导入池，防止进一步写入可能损坏的数据。</li><li><code>-f</code> 强制导入。</li><li><code>-R /mnt</code> 将池挂载到 <code>/mnt</code>（可以根据需要更改）。</li></ul><h3 id="3-使用-zpool-clear-清除错误（如果成功导入）"><a href="#3-使用-zpool-clear-清除错误（如果成功导入）" class="headerlink" title="3. 使用 zpool clear 清除错误（如果成功导入）"></a>3. 使用 <code>zpool clear</code> 清除错误（如果成功导入）</h3><p>如果池能够成功导入，可以尝试清除错误并运行数据检查：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool clear rpool</span><br><span class="line">zpool scrub rpool</span><br></pre></td></tr></table></figure><ul><li><code>zpool scrub</code> 会检查数据完整性，修复可恢复的数据块。</li></ul><h3 id="4-尝试修复损坏的标签"><a href="#4-尝试修复损坏的标签" class="headerlink" title="4. 尝试修复损坏的标签"></a>4. 尝试修复损坏的标签</h3><p>如果无法导入，可以尝试重建设备的标签，不过这具有一定的风险，请谨慎操作。具体步骤如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool labelclear -f /dev/nvme0n1</span><br><span class="line">zpool labelclear -f /dev/nvme1n1</span><br></pre></td></tr></table></figure><ul><li>此操作会清除设备上的 ZFS 标签，使您可以重新尝试导入。</li></ul><h3 id="5-检查是否需要数据恢复"><a href="#5-检查是否需要数据恢复" class="headerlink" title="5. 检查是否需要数据恢复"></a>5. 检查是否需要数据恢复</h3><p>如果上述步骤仍然无法导入池或修复数据，可能需要专业的数据恢复工具或联系数据恢复服务。</p><p>如果可以成功进入系统，建议立即备份重要数据。希望这些方法对您有所帮助！如果需要进一步的帮助，请告诉我更多细节。</p></blockquote><p>实际操作解决</p><p>1、查看id 列表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看设备id列表</span></span><br><span class="line">zpool import</span><br><span class="line"><span class="comment"># 导入正常的id</span></span><br><span class="line">zpool import -f -R /mnt 6053000132496112234</span><br><span class="line"><span class="comment"># 修复有问题的设备</span></span><br><span class="line">zpool labelclear -f /dev/nvme0n1</span><br><span class="line"><span class="comment"># 连续两次中间间隔5s输入exit退出 后系统自动重启后系统正常进入系统问题解决</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果池能够成功导入，可以尝试清除错误并运行数据检查</span></span><br><span class="line">zpool clear rpool</span><br><span class="line">zpool scrub rpool</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> pve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pve </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu配置smb挂载到windows</title>
      <link href="/2024/11/07/ubuntu%E9%85%8D%E7%BD%AEsmb%E6%8C%82%E8%BD%BD%E5%88%B0windows/"/>
      <url>/2024/11/07/ubuntu%E9%85%8D%E7%BD%AEsmb%E6%8C%82%E8%BD%BD%E5%88%B0windows/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ubuntu配置smb挂载到windows"><a href="#ubuntu配置smb挂载到windows" class="headerlink" title="ubuntu配置smb挂载到windows"></a>ubuntu配置smb挂载到windows</h2><p>参考：</p><p><a href="https://blog.csdn.net/qq_44078824/article/details/119847027">https://blog.csdn.net/qq_44078824/article/details/119847027</a></p><h3 id="一、ubuntu配置smb客户端"><a href="#一、ubuntu配置smb客户端" class="headerlink" title="一、ubuntu配置smb客户端"></a>一、ubuntu配置smb客户端</h3><h4 id="1、安装smb软件"><a href="#1、安装smb软件" class="headerlink" title="1、安装smb软件"></a>1、安装smb软件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载smb软件</span></span><br><span class="line">apt-get install samba samba-common</span><br><span class="line"><span class="comment"># 设置开机自启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> smbd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nmbd</span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">sudo systemctl start smbd</span><br><span class="line">sudo systemctl start nmbd</span><br><span class="line">sudo systemctl status smbd</span><br><span class="line">sudo systemctl status nmbd</span><br></pre></td></tr></table></figure><h4 id="2、配置smb服务"><a href="#2、配置smb服务" class="headerlink" title="2、配置smb服务"></a>2、配置smb服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建用于共享的smb服务</span></span><br><span class="line"><span class="built_in">mkdir</span> -pv /smb/root/share</span><br><span class="line"><span class="comment"># 给予权限</span></span><br><span class="line"><span class="built_in">chmod</span> 755 /smb/root/share</span><br><span class="line"><span class="comment"># 创建当前登录ubuntu系统的用户用于smb登录的密码 输入密码，密码会输入2次</span></span><br><span class="line">smbpasswd -a root</span><br></pre></td></tr></table></figure><h3 id="3、修改配置文件（在文件末尾添加）"><a href="#3、修改配置文件（在文件末尾添加）" class="headerlink" title="3、修改配置文件（在文件末尾添加）"></a>3、修改配置文件（在文件末尾添加）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line">vim /etc/samba/smb.conf</span><br><span class="line"></span><br><span class="line">[share]</span><br><span class="line">comment = share folder</span><br><span class="line">browseable = <span class="built_in">yes</span></span><br><span class="line">path = /smb/root/share</span><br><span class="line">create mask = 0700</span><br><span class="line">directory mask = 0700</span><br><span class="line">valid <span class="built_in">users</span> = root</span><br><span class="line">force user = root</span><br><span class="line">force group = root</span><br><span class="line">public = <span class="built_in">yes</span></span><br><span class="line">available = <span class="built_in">yes</span></span><br><span class="line">writable = <span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>重启生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生效配置</span></span><br><span class="line">service smbd restart</span><br></pre></td></tr></table></figure><p>其中root，仍为我的用户名信息。</p><p>在配置文件的最后添加如下：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_e6aed2c36dab129fb04e6785685da771.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_e6aed2c36dab129fb04e6785685da771.png"></p><h3 id="4、防火墙放开对应端口"><a href="#4、防火墙放开对应端口" class="headerlink" title="4、防火墙放开对应端口"></a>4、防火墙放开对应端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放通smb端口</span></span><br><span class="line">ufw allow 139</span><br><span class="line">ufw allow 445</span><br></pre></td></tr></table></figure><h2 id="二、windows客户端登录"><a href="#二、windows客户端登录" class="headerlink" title="二、windows客户端登录"></a>二、windows客户端登录</h2><p>1、win+r cmd输入smb服务端IP<code>\\10.0.0.10</code></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_232bd704262c6ef34b1aec7bfea58759.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_232bd704262c6ef34b1aec7bfea58759.png"></p><p>2、此时文件夹网络出先share文件夹 双击输入密码即可挂载成功</p><p>3、在该挂载的设备处右键映射网络驱动器 输入<code>\\10.0.0.10\share</code>即可</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_6b37c023678eb577bc676999b67cfcdc.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_6b37c023678eb577bc676999b67cfcdc.png"></p><p>4、最终效果</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_2ddc73f6c414a5fc0c34c8d9e60bb773.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_2ddc73f6c414a5fc0c34c8d9e60bb773.png"></p><h2 id="三、一系列报错解决"><a href="#三、一系列报错解决" class="headerlink" title="三、一系列报错解决"></a>三、一系列报错解决</h2><h3 id="现象1："><a href="#现象1：" class="headerlink" title="现象1："></a>现象1：</h3><p>不允许一个用户使用一个以上用户名与服务器或共享资源的多重连接，中断与此服务器或共享</p><p>参考：<a href="https://www.cnblogs.com/sunnyhill/p/11780248.html">https://www.cnblogs.com/sunnyhill/p/11780248.html</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_48dd7cdd1b5745f1a43a3058a388ad50.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_48dd7cdd1b5745f1a43a3058a388ad50.png"></p><h3 id="解决："><a href="#解决：" class="headerlink" title="解决："></a>解决：</h3><p>参考：<a href="https://www.cnblogs.com/sunnyhill/p/11780248.html">https://www.cnblogs.com/sunnyhill/p/11780248.html</a></p><p>同一账号，不同电脑登录结果不同， 推断服务器端设置正常，问题出在客户端电脑上；</p><p>打开命令行窗口：运行 - CMD</p><p>终端下键入命令：</p><p>:&gt;net use //查看已经绑定缓存</p><p>:&gt;net use \\共享IP\文件夹路径  /delete  //对缓存进行清理</p><p><code>net use  \\192.168.39.4\IPC$  /delete</code></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_fcd90bb8330b643505283138943e87f1.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_fcd90bb8330b643505283138943e87f1.png"></p><p>方法二：重新创建Windows凭据</p><p>如以上两种方法无效，可尝试重新“添加Windows凭据”，重新登录。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_4673bce75d4d23c3ad9f3d2a0759e687.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_4673bce75d4d23c3ad9f3d2a0759e687.png"></p><h3 id="现象2"><a href="#现象2" class="headerlink" title="现象2"></a>现象2</h3><p>参考：<a href="https://zhuanlan.zhihu.com/p/164721714">https://zhuanlan.zhihu.com/p/164721714</a></p><p>你不能访问此共享文件夹,因为你组织的安全策略组织未经身份验证的来宾访问。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_67ca98e8993674a6ead75c97b72c13d3.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_67ca98e8993674a6ead75c97b72c13d3.png"></p><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>按window+R键输入gpedit.msc 来启动本地组策略编辑器 管理面板 网络 lanman工作站 启用不安全的…登录。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_27c05b9a6bf92f48e9663356bf95bb2b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_27c05b9a6bf92f48e9663356bf95bb2b.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_49e5ef6ce88ac62e036507da3e894d8b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_49e5ef6ce88ac62e036507da3e894d8b.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_006598654d2ebf010d9d0b7d24a840d8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_006598654d2ebf010d9d0b7d24a840d8.png"></p><h3 id="现象3"><a href="#现象3" class="headerlink" title="现象3"></a>现象3</h3><p>Windows访问共享文件报错：请检查名称拼写。否则，网络可能有问题</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_d331b8ba09ee7c76981155fecb507d63.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_d331b8ba09ee7c76981155fecb507d63.png"></p><h3 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h3><p>参考：<a href="https://blog.csdn.net/qq_44451165/article/details/121975436">https://blog.csdn.net/qq_44451165/article/details/121975436</a></p><p>点击Win+R，输入<a href="https://so.csdn.net/so/search?q=cmd&spm=1001.2101.3001.7020">cmd</a>，回车，输入下列命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\IP地址\ipc$ <span class="string">&quot;密码&quot;</span> /user:<span class="string">&quot;administrator&quot;</span> </span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_d33eb6158495ed655c064163addf5f2e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_d33eb6158495ed655c064163addf5f2e.png"></p>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>6、service（pod对外暴露端口）</title>
      <link href="/2024/10/27/6%E3%80%81service%EF%BC%88pod%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3%EF%BC%89/"/>
      <url>/2024/10/27/6%E3%80%81service%EF%BC%88pod%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="6、service（pod对外暴露端口）"><a href="#6、service（pod对外暴露端口）" class="headerlink" title="6、service（pod对外暴露端口）"></a>6、service（pod对外暴露端口）</h2><h3 id="4-5-Service"><a href="#4-5-Service" class="headerlink" title="4.5 Service"></a>4.5 Service</h3><p><strong>通过上节课的学习，已经能够利用Deployment来创建一组Pod来提供具有高可用性的服务。</strong></p><p><strong>虽然每个Pod都会分配一个单独的Pod IP，然而却存在如下两问题：</strong></p><ul><li><strong>Pod IP 会随着Pod的重建产生变化</strong></li><li><strong>Pod IP 仅仅是集群内可见的虚拟IP，外部无法访问</strong></li></ul><p><strong>这样对于访问这个服务带来了难度。因此，kubernetes设计了Service来解决这个问题。</strong></p><p><strong>Service可以看作是一组同类Pod<strong><strong>对外的访问接口</strong></strong>。借助Service，应用可以</strong>方便地实现服务发现和负载均衡。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_d7f2ed85346cce5cc991e3595fe22339.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_d7f2ed85346cce5cc991e3595fe22339.png"></p><h3 id="4-5-1-创建集群内部可访问的Service"><a href="#4-5-1-创建集群内部可访问的Service" class="headerlink" title="4.5.1 创建集群内部可访问的Service"></a>4.5.1 创建集群内部可访问的Service</h3><p>**前面第5节我们创建的pod 要访问他需要查看他的IP 但是此IP是能集群内部访问 IP还会变化 并且外面环境是无法访问的 **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看dev下面pod信息</span></span><br><span class="line">kubectl get pods -n dev -o wide</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_8b1f4ccbd33ebc304d15abd941459981.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_8b1f4ccbd33ebc304d15abd941459981.png"></p><h2 id="一-创建集群内部可以访问的service"><a href="#一-创建集群内部可以访问的service" class="headerlink" title="一. 创建集群内部可以访问的service"></a>一. 创建集群内部可以访问的service</h2><h3 id="1、集群内部访问"><a href="#1、集群内部访问" class="headerlink" title="1、集群内部访问"></a>1、集群内部访问</h3><p><strong>环境准备：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  <span class="comment"># 版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>     <span class="comment"># 类型</span></span><br><span class="line"><span class="attr">metadata:</span>            <span class="comment"># 源数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span>        <span class="comment"># 当前deployment所属的名字</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>     <span class="comment"># 及ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>        <span class="comment"># 定义副本数</span></span><br><span class="line">  <span class="attr">selector:</span>          <span class="comment"># 标签选择器</span></span><br><span class="line">    <span class="attr">matchLabels:</span>     <span class="comment"># 选择nginx标签</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span>          <span class="comment"># 以下为pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span>        <span class="comment"># 标签</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">nginx</span>   <span class="comment"># 定义标签为nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">svc-nginx1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><p><strong>查看deployment</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看deployment</span></span><br><span class="line">kubectl get deployment</span><br><span class="line"><span class="comment"># 查看pod详细信息</span></span><br><span class="line">kubectl get pods -n dev -o wide --show-labels</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_821d88f11ed23a952dae411a39c3790a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_821d88f11ed23a952dae411a39c3790a.png"></p><p><strong>参数：</strong></p><ul><li><strong>–port: 80  程序内部端口</strong></li><li><strong>–target-port:80  需要暴露的端口即80转发到80</strong></li><li><strong>deploy nginx :  deployment名称是nginx</strong></li><li><strong>–name=svc-nginx1:  此为pod名称</strong></li></ul><p><strong>返回:</strong></p><ul><li><strong>ClusterIP:10.108.11.19   为集群IP  只有集群内部才可以访问</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建集群内部可以访问的service</span></span><br><span class="line">kubectl expose deploy nginx --name=svc-nginx1  --<span class="built_in">type</span>=ClusterIP --port=80 --target-port=80 -n dev</span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">kubectl get svc -n dev -o wide</span><br><span class="line">curl 10.108.11.19</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_8ebae5ea44fcdb5fb5b65604aa82a768.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_8ebae5ea44fcdb5fb5b65604aa82a768.png"></p><p>**此时我们访问就不访问podIP了我们访问service的ip加端口  此时其实是做了一个负载均衡他会随机转发到一个pod去提供服务 **</p><h3 id="2、实现集群外部访问"><a href="#2、实现集群外部访问" class="headerlink" title="2、实现集群外部访问"></a>2、实现集群外部访问</h3><ul><li><strong>上面创建的Service的type类型为ClusterIP，这个ip地址只用集群内部可访问</strong></li><li><strong>如果需要创建外部也可以访问的Service，需要修改type为NodePort</strong></li><li><strong>–name=svc-nginx2  ns dev下deployment pod控制器nginx会再创建一个pod名称为svc-nginx2的容器</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群外部访问</span></span><br><span class="line">kubectl expose deploy nginx --name=svc-nginx2  --<span class="built_in">type</span>=NodePort --port=80 --target-port=80 -n dev</span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">kubectl get svc -n dev --show-labels -o wide</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_5ab57120fd8c0a8abb13b2e210b5033b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_5ab57120fd8c0a8abb13b2e210b5033b.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_57002295d9abf70b483e20dedcb2e54f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_57002295d9abf70b483e20dedcb2e54f.png"></p><h3 id="3、删除service"><a href="#3、删除service" class="headerlink" title="3、删除service"></a>3、删除service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除service</span></span><br><span class="line">kubectl delete svc svc-nginx2 -n dev</span><br></pre></td></tr></table></figure><h3 id="4、配置方式"><a href="#4、配置方式" class="headerlink" title="4、配置方式"></a>4、配置方式</h3><p><strong>创建一个svc-nginx.yaml，内容如下：</strong></p><p><strong>需要修改type为</strong>NodePort <strong>（修改type类型为NodePort即可实现外部访问）</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.109</span><span class="number">.179</span><span class="number">.231</span> <span class="comment">#固定svc的内网ip</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure><p><strong>然后就可以执行对应的创建和删除命令了：</strong></p><p><strong>创建：kubectl create -f svc-nginx.yaml</strong></p><p><strong>删除：kubectl delete -f svc-nginx.yaml</strong></p><p><strong>小结</strong></p><p><strong>至此，已经掌握了Namespace、Pod、Deployment、Service资源的基本操作，有了这些操作，就可以在kubernetes集群中实现一个服务的简单部署和访问了，但是如果想要更好的使用kubernetes，就需要深入学习这几种资源的细节和原理。</strong></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5、k8s-deployment增删改查（pod控制器）</title>
      <link href="/2024/10/27/5%E3%80%81deployment%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%EF%BC%88pod%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%89/"/>
      <url>/2024/10/27/5%E3%80%81deployment%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%EF%BC%88pod%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="5、k8s-deployment增删改查（pod控制器）"><a href="#5、k8s-deployment增删改查（pod控制器）" class="headerlink" title="5、k8s-deployment增删改查（pod控制器）"></a>5、k8s-deployment增删改查（pod控制器）</h2><h2 id="4-4-Deployment"><a href="#4-4-Deployment" class="headerlink" title="4.4 Deployment"></a>4.4 Deployment</h2><p>在kubernetes中，Pod是最小的控制单元，但是kubernetes很少直接控制Pod，一般都是通过Pod控制器来完成的。Pod控制器用于pod的管理，确保pod资源符合预期的状态，当pod的资源出现故障时，**会尝试进行重启或重建pod。</p><p><strong>在kubernetes中Pod控制器的种类有很多，本章节只介绍一种：Deployment。</strong></p><p>如我创建容器时告诉pod控制器我需要3个应用程序 这时候pod控制器 就会创建出三个来 如果一个出现故障 pod控制器就会尝试重启 重启失败就会销毁重建 总之确保一直有3个运行。</p><p><strong>要想删除必须删掉pod控制器</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_84b19db3db82366663125705661cd6dc.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_84b19db3db82366663125705661cd6dc.png"></p><h2 id="一-命令操作"><a href="#一-命令操作" class="headerlink" title="一. 命令操作"></a>一. 命令操作</h2><h3 id="1-创建2副本pod"><a href="#1-创建2副本pod" class="headerlink" title="1.创建2副本pod"></a>1.创建2副本pod</h3><p><strong>参数说明：</strong></p><ul><li><strong>–image 指定pod的镜像</strong></li><li><strong>–port             指定端口</strong></li><li><strong>–replicas       指定pod的数量</strong></li><li><strong>–namespace 指定ns （需要多节点才能成功运行）</strong></li></ul><p><strong>本身</strong>deployment是有标签选择器的 他就会选中相同标签的pod进而管理pod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为了不影响接下来的操作我们删除ns dev 这样dev下面的pod都会被删除</span></span><br><span class="line">kubectl delete ns dev</span><br><span class="line"><span class="comment"># 验证是否删除成功</span></span><br><span class="line">kubectl get deployment,pod -n dev</span><br><span class="line"><span class="comment"># 创建一个资源用于测试（命令行方式）</span></span><br><span class="line">kubectl create ns dev</span><br><span class="line">kubectl run nginx-pod --image=registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest --port=80 --replicas=3 -n dev</span><br></pre></td></tr></table></figure><p><strong>扩展手动给nginx-pod打上标签</strong></p><p><strong>kubectl label pod nginx-pod version=2.0 -n dev –overwrite</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_e138646456edcc13cc512eef8b032bb5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_e138646456edcc13cc512eef8b032bb5.png"></p><p><strong>此时可以看到标签选择器选择的标签化与我们查看的标签一致</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_799b6282dd3639776922530e3d941c19.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_799b6282dd3639776922530e3d941c19.png"></p><h3 id="2-删除pod控制器deployment（直接删除pod会重建-删除pod控制器即删除完成）"><a href="#2-删除pod控制器deployment（直接删除pod会重建-删除pod控制器即删除完成）" class="headerlink" title="2.删除pod控制器deployment（直接删除pod会重建 删除pod控制器即删除完成）"></a>2.删除pod控制器deployment（直接删除pod会重建 删除pod控制器即删除完成）</h3><p><strong>没有pod控制器的直接就删除完成了</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除nginx-pod、pod的pod控制器</span></span><br><span class="line">kubectl delete deploy nginx-pod -n dev</span><br><span class="line"><span class="comment"># 验证（此时便没有了）</span></span><br><span class="line">kubectl get pods -n dev</span><br></pre></td></tr></table></figure><h2 id="二-使用配置文件方式定义deployment（pod控制器）"><a href="#二-使用配置文件方式定义deployment（pod控制器）" class="headerlink" title="二. 使用配置文件方式定义deployment（pod控制器）"></a>二. 使用配置文件方式定义deployment（pod控制器）</h2><p><strong>nginx-pod.yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  <span class="comment"># 版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>     <span class="comment"># 类型</span></span><br><span class="line"><span class="attr">metadata:</span>            <span class="comment"># 源数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-nginx</span>    <span class="comment"># 当前deployment所属的名字</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span>     <span class="comment"># 及ns  </span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>        <span class="comment"># 定义副本数</span></span><br><span class="line">  <span class="attr">selector:</span>          <span class="comment"># 标签选择器</span></span><br><span class="line">    <span class="attr">matchLabels:</span>     <span class="comment"># 选择nginx标签</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span>          <span class="comment"># 以下为pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span>        <span class="comment"># 标签</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">nginx</span>   <span class="comment"># 定义标签为nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><p><strong>然后就可以执行对应的创建和删除命令了：</strong></p><p><strong>创建：kubectl create -f deploy-nginx.yaml</strong></p><p><strong>删除：kubectl delete -f deploy-nginx.yaml</strong></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4、k8s标签管理label</title>
      <link href="/2024/10/24/4%E3%80%81k8s%E6%A0%87%E7%AD%BE%E7%AE%A1%E7%90%86label/"/>
      <url>/2024/10/24/4%E3%80%81k8s%E6%A0%87%E7%AD%BE%E7%AE%A1%E7%90%86label/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="4、k8s标签管理label"><a href="#4、k8s标签管理label" class="headerlink" title="4、k8s标签管理label"></a>4、k8s标签管理label</h2><h3 id="4-3-Label"><a href="#4-3-Label" class="headerlink" title="4.3 Label"></a>4.3 Label</h3><p><strong>Label是kubernetes系统中的一个重要概念。它的作用就是在资源上添加标识，用来对它们进行区分和选择。</strong></p><p><strong>Label的特点：</strong></p><ul><li><strong>一个Label会以key/value键值对的形式附加到各种对象上，如Node、Pod、Service等等</strong></li><li><strong>一个资源对象可以定义任意数量的Label ，同一个Label也可以被添加到任意数量的资源对象上去</strong></li><li><strong>Label通常在</strong>资源对象定义时确定<strong>，当然也可以在对象创建后</strong>动态添加或者删除</li></ul><p><strong>可以通过Label实现资源的多维度分组，以便灵活、方便地进行资源分配、调度、配置、部署等管理工作。</strong></p><p><strong>一些常用的Label 示例如下（没有定义随便定义）：</strong></p><ul><li><strong>版本标签：”version”:”release”, “version”:”stable”……</strong></li><li><strong>环境标签：”environment”:”dev”，”environment”:”test”，”environment”:”pro”</strong></li><li><strong>架构标签：”tier”:”frontend”，”tier”:”backend”</strong></li></ul><p><strong>标签定义完毕之后，还要考虑到标签的选择，这就要使用到</strong>Label Selector<strong>，即：</strong></p><p><strong>Label</strong>用于给某个资源对象定义标识</p><p><strong>Label Selector</strong>用于查询和筛选拥有某些标签的资源对象</p><p><strong>lable与namespace类似但是不同的ns之间无法通信此时引入lable 即同一个ns下面的pod使用不同的标识</strong></p><p><strong>这样即解决不同ns下pod无法相互通信问题</strong></p><p><strong>当前有两种</strong>Label Selector<strong>：</strong></p><ul><li><strong>基于</strong>等式<strong>的Label Selector</strong></li></ul><p><strong>name = slave: 选择所有包含Label中key=”name”且value=”slave”的对象</strong></p><p><strong>env != production: 选择所有包括Label中的key=”env”且value不等于”production”的对象</strong></p><ul><li><strong>基于</strong>集合<strong>的Label Selector</strong></li></ul><p><strong>name in (master, slave): 选择所有包含Label中的key=”name”且value=”master”或”slave”的对象</strong></p><p><strong>name not in (frontend): 选择所有包含Label中的key=”name”且value不等于”frontend”的对象</strong></p><p><strong>标签的选择条件可以使用多个，此时将多个Label Selector进行组合，使用逗号”,”进行分隔即可。例如：</strong></p><p><strong>name=slave，env!=production</strong></p><p><strong>name not in (frontend)，env!=production</strong></p><h3 id="4-4-标签的使用"><a href="#4-4-标签的使用" class="headerlink" title="4.4 标签的使用"></a>4.4 标签的使用</h3><h4 id="4-4-1-命令行方式标签添加"><a href="#4-4-1-命令行方式标签添加" class="headerlink" title="4.4.1 命令行方式标签添加"></a>4.4.1 命令行方式标签添加</h4><p><strong>资源准备</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个资源用于测试（命令行方式）</span></span><br><span class="line">kubectl create ns dev</span><br><span class="line">kubectl run nginx-pod --image=registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest  -n dev</span><br></pre></td></tr></table></figure><p><strong>nginx-pod.yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><p><strong>文件方式创建：kubectl create -f  nginx-pod.yml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为pod资源打上标签</span></span><br><span class="line">kubectl label pod nginx-pod version=1.0 -n dev</span><br><span class="line">kubectl label pod nginx-pod tier=back -n dev</span><br><span class="line"><span class="comment"># 现象（此时使用下方命令查看dev下的nginx-pod是没有标签的）</span></span><br><span class="line">kubectl get pod -n dev</span><br><span class="line">kubectl get pod -n dev --show-labels</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_d6e9c5ddf0433632f6a86e72570436bd.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_d6e9c5ddf0433632f6a86e72570436bd.png"></p><h4 id="4-4-2-标签更新（参数–overwrite）"><a href="#4-4-2-标签更新（参数–overwrite）" class="headerlink" title="4.4.2 标签更新（参数–overwrite）"></a>4.4.2 标签更新（参数–overwrite）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 标签更新</span></span><br><span class="line">kubectl label pod nginx-pod version=2.0 -n dev --overwrite</span><br></pre></td></tr></table></figure><h4 id="4-4-3-筛选标签（-l）"><a href="#4-4-3-筛选标签（-l）" class="headerlink" title="4.4.3 筛选标签（-l）"></a>4.4.3 筛选标签（-l）</h4><p><strong>修改nginx配置再次创建一个nginx-sx</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给nginx-sx打上标签</span></span><br><span class="line">kubectl label pod nginx-sx version=1.0 -n dev --overwrite</span><br><span class="line"><span class="comment"># 只筛选出标签是version=2.0的pod</span></span><br><span class="line">kubectl get pods -l <span class="string">&quot;version=2.0&quot;</span> -n dev --show-labels</span><br><span class="line">kubectl get pods -l <span class="string">&quot;version!=2.0&quot;</span> -n dev --show-labels</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_584efb8d5805177e68470ea32cf4474c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_584efb8d5805177e68470ea32cf4474c.png"></p><h4 id="4-4-4-删除标签"><a href="#4-4-4-删除标签" class="headerlink" title="4.4.4 删除标签"></a>4.4.4 删除标签</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除标签</span></span><br><span class="line">kubectl label pod nginx-pod  -n dev tier-</span><br></pre></td></tr></table></figure><h4 id="4-4-5-配置方式标签管理"><a href="#4-4-5-配置方式标签管理" class="headerlink" title="4.4.5 配置方式标签管理"></a>4.4.5 配置方式标签管理</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;3.0&quot;</span> </span><br><span class="line">    <span class="attr">env:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><p><strong>然后就可以执行对应的更新命令了：kubectl apply -f pod-nginx.yaml</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_2eed665f8fca199832832b35738bb722.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_2eed665f8fca199832832b35738bb722.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SD文生图教程</title>
      <link href="/2024/10/22/SD%E6%96%87%E7%94%9F%E5%9B%BE%E6%95%99%E7%A8%8B/"/>
      <url>/2024/10/22/SD%E6%96%87%E7%94%9F%E5%9B%BE%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="SD文生图教程"><a href="#SD文生图教程" class="headerlink" title="SD文生图教程"></a>SD文生图教程</h2><p><a href="https://sunlight.zznnwn.cloudns.biz/2024/08/02/ollama%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%E5%8F%8A%E5%A4%9A%E6%A8%A1%E6%80%81%E5%9B%BE%E7%89%87%E5%88%86%E6%9E%90%E6%96%87%E7%94%9F%E5%9B%BE/?highlight=%E6%96%87%E7%94%9F%E5%9B%BE">旧版本直通</a></p><p><strong>使用参考：</strong></p><p><a href="https://blog.csdn.net/Jack__Lau__/article/details/135140056">https://blog.csdn.net/Jack__Lau__/article/details/135140056</a></p><h3 id="一-插件"><a href="#一-插件" class="headerlink" title="一. 插件"></a>一. 插件</h3><p><strong>插件地址：</strong></p><p><strong>Civitai：</strong></p><p><a href="https://github.com/butaixianran/Stable-Diffusion-Webui-Civitai-Helper">https://github.com/butaixianran/Stable-Diffusion-Webui-Civitai-Helper</a></p><p><a href="https://gitee.com/aiovia/Stable-Diffusion-Webui-Civitai-Helper">https://gitee.com/aiovia/Stable-Diffusion-Webui-Civitai-Helper</a></p><p><strong>中文插件：</strong></p><p><a href="https://gitee.com/cloneai/sd-webui-bilingual-localization.git">https://gitee.com/cloneai/sd-webui-bilingual-localization.git</a></p><p><a href="https://gitee.com/stable_diffusion/stable-diffusion-webui-localization-zh_CN">https://gitee.com/stable_diffusion/stable-diffusion-webui-localization-zh_CN</a></p><p><strong>新增其他模型：</strong></p><p><a href="https://zhuanlan.zhihu.com/p/641027156">https://zhuanlan.zhihu.com/p/641027156</a></p><p><strong>模型下载地址：</strong></p><p><a href="https://huggingface.co/">https://huggingface.co/</a></p><p><a href="https://civitai.com/">https://civitai.com/</a></p><p>C站：</p><p><a href="https://civitai.com/images">https://civitai.com/images</a><br>prompthero：</p><p><a href="https://prompthero.com/">https://prompthero.com/</a><br>Majinai：</p><p><a href="https://majinai.art/index.php">https://majinai.art/index.php</a><br>词图：</p><p><a href="https://www.prompttool.com/NovelAI">https://www.prompttool.com/NovelAI</a><br>Black Lily：</p><p><a href="http://heizicao.gitee.io/novelai/#/book">http://heizicao.gitee.io/novelai/#/book</a><br>Danbooru 标签超市：</p><p><a href="https://tags.novelai.dev/">https://tags.novelai.dev/</a><br>AI 词汇加速器：</p><p><a href="https://ai.dawnmark.cn/">https://ai.dawnmark.cn/</a><br>NovelAI 魔导书：</p><p><a href="https://thereisnospon.github.io/NovelAiTag/">https://thereisnospon.github.io/NovelAiTag/</a></p><h2 id="二-部署"><a href="#二-部署" class="headerlink" title="二. 部署"></a>二. 部署</h2><p>说明：</p><p>外网访问模式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入modules目录</span></span><br><span class="line"><span class="built_in">cd</span> modules</span><br><span class="line"><span class="comment"># 编辑参数</span></span><br><span class="line">vim /dockerx/stable-diffusion-webui/modules/cmd_args.py</span><br><span class="line"><span class="comment"># 修改以下两行</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">parser.add_argument(<span class="string">&quot;--listen&quot;</span>, action=<span class="string">&#x27;store_true&#x27;</span>,default=True, <span class="built_in">help</span>=<span class="string">&quot;launch gradio with 0.0.0.0 as server name, allowing to respond to network requests&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;--port&quot;</span>, <span class="built_in">type</span>=int, <span class="built_in">help</span>=<span class="string">&quot;launch gradio with given server port, you need root/admin rights for ports &lt; 1024, defaults to 7860 if available&quot;</span>, default=7860)</span><br></pre></td></tr></table></figure><p>不同模型存放位置</p><p>模型文件(safetensors,checkpoint)添加到以下目录</p><p><code>/dockerx/stable-diffusion-webui/models/Stable-diffusion/</code><br>Lora文件添加到以下目录</p><p><code>/dockerx/stable-diffusion-webui/models/Lora/</code><br>VAE文件添加到以下目录</p><p><code>/dockerx/stable-diffusion-webui/models/VAE/</code></p><p>使用<code>docker-compose</code>方式（部署完成后需要等待一段时间 才能浏览器访问7860端口使用）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span>  <span class="comment"># 或者使用适合您需求的版本</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">stable-diffusion:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gpulab.tencentcloudcr.com/ai/stable-diffusion:1.0.7</span> <span class="comment">#gpulab.tencentcloudcr.com/ai/stable-diffusion:1.0.8</span></span><br><span class="line">    <span class="comment"># registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:stable-diffusion-1.0.7</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">stable-diffusion</span></span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span>  <span class="comment"># 确保使用 NVIDIA 运行时</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">devices:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">capabilities:</span> [<span class="string">gpu</span>]  <span class="comment"># 预留 GPU 资源</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span>  <span class="comment"># 使用主机网络</span></span><br><span class="line">    <span class="attr">devices:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/dev/dri:/dev/dri</span>  <span class="comment"># 允许访问设备</span></span><br><span class="line">    <span class="attr">group_add:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">video</span>  <span class="comment"># 将容器加入视频组</span></span><br><span class="line">    <span class="attr">ipc:</span> <span class="string">host</span>  <span class="comment"># 使用主机 IPC</span></span><br><span class="line">    <span class="attr">cap_add:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SYS_PTRACE</span>  <span class="comment"># 添加 SYS_PTRACE 权限</span></span><br><span class="line">    <span class="attr">security_opt:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">seccomp=unconfined</span>  <span class="comment"># 禁用 seccomp 限制</span></span><br><span class="line">    <span class="attr">stdin_open:</span> <span class="literal">true</span>  <span class="comment"># 保持标准输入打开</span></span><br><span class="line">    <span class="comment">#tty: true  # 分配一个伪终端</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cmd_args.py:/dockerx/stable-diffusion-webui/modules/cmd_args.py</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ponyRealism_v22MainVAE.safetensors:/dockerx/stable-diffusion-webui/models/VAE/ponyRealism_v22MainVAE.safetensors</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./3Guofeng3_v34.safetensors:/dockerx/stable-diffusion-webui/models/Stable-diffusion/国风/3Guofeng3_v34.safetensors</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="string">./vae-ft-mse-840000-ema-pruned.ckpt:/dockerx/stable-diffusion-webui/models/VAE/vae-ft-mse-840000-ema-pruned.ckpt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./face.ckpt:/dockerx/stable-diffusion-webui/models/Stable-diffusion/真实/face.ckpt</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="string">./Nahida.safetensors:/dockerx/stable-diffusion-webui/models/Stable-diffusion/现实与动漫/Nahida.safetensors</span>  </span><br><span class="line">      <span class="comment">#- ./1990s_Anime_Style.safetensors:/dockerx/stable-diffusion-webui/models/Stable-diffusion/90年代日本动漫风格/1990s_Anime_Style.safetensors</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sd1.5_Outline_Color_1.0.safetensors:/dockerx/stable-diffusion-webui/models/Stable-diffusion/动漫插画风/sd1.5_Outline_Color_1.0.safetensors</span></span><br></pre></td></tr></table></figure><h2 id="三-前端页面开启相关功能"><a href="#三-前端页面开启相关功能" class="headerlink" title="三. 前端页面开启相关功能"></a>三. 前端页面开启相关功能</h2><h3 id="开启vae"><a href="#开启vae" class="headerlink" title="开启vae"></a>开启vae</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_c244f24b53185a9ebe2ed610bfdfdf84.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_c244f24b53185a9ebe2ed610bfdfdf84.png"></p><h3 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_42218fd8bef76e3155a5cb676f9a8792.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_42218fd8bef76e3155a5cb676f9a8792.png"></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes故障篇：calico/node is not ready: BIRD is not ready</title>
      <link href="/2024/10/20/Kubernetes%E6%95%85%E9%9A%9C%E7%AF%87%EF%BC%9Acalico/node%20is%20not%20ready:%20BIRD%20is%20not%20ready/"/>
      <url>/2024/10/20/Kubernetes%E6%95%85%E9%9A%9C%E7%AF%87%EF%BC%9Acalico/node%20is%20not%20ready:%20BIRD%20is%20not%20ready/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Kubernetes故障篇：calico-node-is-not-ready-BIRD-is-not-ready"><a href="#Kubernetes故障篇：calico-node-is-not-ready-BIRD-is-not-ready" class="headerlink" title="Kubernetes故障篇：calico/node is not ready: BIRD is not ready"></a><a href="https://www.cnblogs.com/codertl/p/17021964.html" title="发布于 2023-01-03 14:04">Kubernetes故障篇：calico/node is not ready: BIRD is not ready</a></h1><h2 id="一、问题产生"><a href="#一、问题产生" class="headerlink" title="一、问题产生"></a>一、问题产生</h2><h3 id="1-k8s集群部署后发现calico的pod未通过健康检查，如下所示："><a href="#1-k8s集群部署后发现calico的pod未通过健康检查，如下所示：" class="headerlink" title="1. k8s集群部署后发现calico的pod未通过健康检查，如下所示："></a>1. k8s集群部署后发现calico的pod未通过健康检查，如下所示：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -A -o wide</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_2b399502c98fb452733a85c290d601ab.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_2b399502c98fb452733a85c290d601ab.png"></p><blockquote><p>可以看到 k8s-mater节点未Ready，会导致主节点访问node显示拒接连接。即: curl 10.0.169.144 显示为拒绝连接</p></blockquote><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_7fa73e77464fec1d997cab51be0238e7.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_7fa73e77464fec1d997cab51be0238e7.png"></p><h3 id="2-通过命令kubectl-describe-pods-calico-node-8lb6j-n-kube-system，查看其中一个pod信息，如下所示："><a href="#2-通过命令kubectl-describe-pods-calico-node-8lb6j-n-kube-system，查看其中一个pod信息，如下所示：" class="headerlink" title="2. 通过命令kubectl describe pods calico-node-8lb6j -n kube-system，查看其中一个pod信息，如下所示："></a>2. 通过命令kubectl describe pods calico-node-8lb6j -n kube-system，查看其中一个pod信息，如下所示：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pods calico-node-8lb6j -n kube-system</span><br></pre></td></tr></table></figure><h2 id="二、解决方法"><a href="#二、解决方法" class="headerlink" title="二、解决方法"></a>二、解决方法</h2><blockquote><p>解决方案：调整calicao网络插件的网卡发现机制，修改IP_AUTODETECTION_METHOD对应的value值。官方提供的yaml文件中，ip识别策略（IPDETECTMETHOD）没有配置，即默认为first-found，这会导致一个网络异常的ip作为nodeIP被注册，从而影响node-to-node mesh。我们可以修改成can-reach或者interface的策略，尝试连接某一个Ready的node的IP，以此选择出正确的IP。</p></blockquote><p>操作如下:</p><h3 id="2-1-查看本机网卡信息"><a href="#2-1-查看本机网卡信息" class="headerlink" title="2.1 查看本机网卡信息"></a>2.1 查看本机网卡信息</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_913079859149ed1f89a5f279143d64c7.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_913079859149ed1f89a5f279143d64c7.png"></p><h3 id="2-2-修改-calico-yaml文件"><a href="#2-2-修改-calico-yaml文件" class="headerlink" title="2.2 修改 calico.yaml文件"></a>2.2 修改 calico.yaml文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改calico的yaml文件，添加配置项</span></span><br><span class="line">vim calico.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster type to identify the deployment type</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IP_AUTODETECTION_METHOD</span> <span class="comment">#增加内容</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;interface=ens*&quot;</span> <span class="string">或者</span> <span class="attr">value:</span> <span class="string">&quot;interface=ens33&quot;</span>     <span class="comment">#增加内容</span></span><br><span class="line"><span class="comment"># 下面内容是calico.yaml里默认的不修改  </span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CLUSTER_TYPE</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;k8s,bgp&quot;</span></span><br><span class="line"><span class="comment"># Auto-detect the BGP IP address.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IP</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;autodetect&quot;</span></span><br><span class="line"><span class="comment"># Enable IPIP</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CALICO_IPV4POOL_IPIP</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;Always&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-3-重新在master节点上部署"><a href="#2-3-重新在master节点上部署" class="headerlink" title="2.3 重新在master节点上部署"></a>2.3 重新在master节点上部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure><h3 id="2-4-查看结果"><a href="#2-4-查看结果" class="headerlink" title="2.4 查看结果"></a>2.4 查看结果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 10.0.169.144</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_5d67420b148ec11c154d7579f918d7e5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_5d67420b148ec11c154d7579f918d7e5.png"></p><p>本文转载自：<a href="https://www.cnblogs.com/codertl/p/17021964.html">Kubernetes故障篇：calico/node is not ready: BIRD is not ready - CoderTL - 博客园 (cnblogs.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos离线部署nvidia-docker-runtime</title>
      <link href="/2024/10/14/centos%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2nvidia-docker-runtime/"/>
      <url>/2024/10/14/centos%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2nvidia-docker-runtime/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="centos离线部署nvidia-docker-runtime"><a href="#centos离线部署nvidia-docker-runtime" class="headerlink" title="centos离线部署nvidia-docker-runtime"></a>centos离线部署nvidia-docker-runtime</h1><p>参考：</p><p><a href="https://zhuanlan.zhihu.com/p/641349918">https://zhuanlan.zhihu.com/p/641349918</a></p><p><a href="https://www.hangge.com/blog/cache/detail_3185.html">https://www.hangge.com/blog/cache/detail_3185.html</a></p><p><a href="https://www.server-world.info/en/note?os=Ubuntu_24.04&amp;p=nvidia&amp;f=3">https://www.server-world.info/en/note?os=Ubuntu_24.04&amp;p=nvidia&amp;f=3</a></p><p>离线rpm包路径：</p><p><a href="https://github.com/NVIDIA/libnvidia-container/tree/gh-pages/stable/">https://github.com/NVIDIA/libnvidia-container/tree/gh-pages/stable/</a></p><p>onedrive rpm包下载留存地址：</p><p><a href="https://onenote.zznnwn.cloudns.biz/api/raw/?path=/public-tools/nvidia-rpm/nvidia-container-runtime.tar.gz">https://onenote.zznnwn.cloudns.biz/api/raw/?path=/public-tools/nvidia-rpm/nvidia-container-runtime.tar.gz</a></p><h2 id="文档概览"><a href="#文档概览" class="headerlink" title="文档概览"></a>文档概览</h2><p><a href="https://onenote.zznnwn.cloudns.biz/api/raw/?path=/public-tools/nvidia-rpm/nvidia-container-runtime.tar.gz">首先下载rpm包到服务器</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换到/opt</span></span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line"><span class="comment">#解压nvidia-container-runtime.tar.gz</span></span><br><span class="line">tar -zxvf nvidia-container-runtime.tar.gz</span><br><span class="line"><span class="comment">#离线安装所有rpm包</span></span><br><span class="line"><span class="built_in">cd</span> nvidia-container-runtime</span><br><span class="line">rpm -Uvh --force --nodeps *.rpm</span><br><span class="line"><span class="comment">#安装完后需要重启容器，未设置为系统启动服务，也可以通过kill docker进程再启动方式重启</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="comment">#查看安装结果</span></span><br><span class="line">whereis  nvidia-container-runtime</span><br></pre></td></tr></table></figure><p><strong>验证是否成功（显示如下则成功）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root@dmx:/opt/ollama<span class="comment"># docker run -it --rm --gpus all registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:ubuntu  nvidia-smi</span></span><br><span class="line">Tue Jul 23 07:28:58 2024   </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 550.100                Driver Version: 550.100        CUDA Version: 12.4     |</span><br><span class="line">|-----------------------------------------+------------------------+----------------------+</span><br><span class="line">| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                                         |                        |               MIG M. |</span><br><span class="line">|=========================================+========================+======================|</span><br><span class="line">|   0  NVIDIA GeForce RTX 4090 D      Off |   00000000:01:00.0 Off |                  Off |</span><br><span class="line">|  0%   40C    P5             65W /  425W |    5609MiB /  24564MiB |      0%      Default |</span><br><span class="line">|                                         |                        |                  N/A |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">                                                                         </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                              |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |</span><br><span class="line">|        ID   ID                                                               Usage      |</span><br><span class="line">|=========================================================================================|</span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Author: 粘人的鸭嘴兽的小站🍈</span><br><span class="line">Link: https://sunlight.zznnwn.cloudns.biz/2024/07/15/ubuntu%E9%83%A8%E7%BD%B2nvidia-container-toolkit/</span><br><span class="line">Source: 粘人的鸭嘴兽🍓</span><br><span class="line">Copyright is owned by the author. For commercial reprints, please contact the author <span class="keyword">for</span> authorization. For non-commercial reprints, please indicate the <span class="built_in">source</span>.</span><br></pre></td></tr></table></figure><h2 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a><strong>系统环境</strong></h2><p>1）操作系统：CentOS7.9</p><p>2）Docker版本：20.10.9</p><p>3）NVIDIA 显卡型号：RTX <a href="https://zhida.zhihu.com/search?content_id=230653465&content_type=Article&match_order=1&q=3090&zhida_source=entity">3090</a></p><p>4）NVIDIA 驱动版本：526.86</p><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a><strong>安装步骤</strong></h2><h2 id="1、Docker-下载"><a href="#1、Docker-下载" class="headerlink" title="1、Docker 下载"></a><strong>1、Docker</strong> <strong>下载</strong></h2><p><a href="https://link.zhihu.com/?target=https://download.docker.com/linux/static/stable/x86_64/docker-20.10.9.tgz">https://<strong>download.docker.com/lin</strong>ux/static/stable/x86_64/docker-20.10.9.tgz</a></p><p>其他版本可通过一下地址访问，选择对应版本</p><p><a href="https://link.zhihu.com/?target=https://download.docker.com/linux/static/stable/x86_64/">https://<strong>download.docker.com/lin</strong>ux/static/stable/x86_64/</a></p><p><img src="https://pic2.zhimg.com/80/v2-ece96d0a3049348573fc5cdfb9873be5_720w.webp"></p><p>docker 安装包下载</p><h2 id="2、Docker安装"><a href="#2、Docker安装" class="headerlink" title="2、Docker安装"></a><strong>2、Docker安装</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝文件到GPU服务器并解压安装文件</span></span><br><span class="line">tar xzvf docker-20.10.9.tgz</span><br></pre></td></tr></table></figure><p><img src="https://pic3.zhimg.com/80/v2-fcb43ff8951d83009603060ce1ee553e_720w.webp"></p><p>解压docker压缩包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝到系统脚本目录</span></span><br><span class="line">sudo <span class="built_in">cp</span> docker/* /usr/bin/</span><br><span class="line"><span class="comment"># 后台启动docker</span></span><br><span class="line">sudo dockerd &amp;</span><br></pre></td></tr></table></figure><p>出现如下内容表名docker 启动完成，回车退出即可</p><blockquote><p>INFO[2023-07-03T14:05:58.369195793+08:00] Docker daemon commit=79ea9d3 <a href="https://zhida.zhihu.com/search?content_id=230653465&content_type=Article&match_order=1&q=graphdriver&zhida_source=entity">graphdriver</a>(s)=overlay2 version=20.10.9<br>INFO[2023-07-03T14:05:58.369566710+08:00] Daemon has completed initialization</p></blockquote><p><img src="https://pic2.zhimg.com/80/v2-d825db9817d8434adae3381b44f080c5_720w.webp"></p><p>docker 安装完成</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看docker 版本信息</span></span><br><span class="line">docker -v</span><br><span class="line"><span class="comment">#查看docker 详细信息</span></span><br><span class="line">docker info</span><br></pre></td></tr></table></figure><p><img src="https://pica.zhimg.com/80/v2-70952c80d08bdb29e179d140d7fdc492_720w.webp"></p><p>查看docker信息</p><h2 id="3、nvidia-docker-runtime安装"><a href="#3、nvidia-docker-runtime安装" class="headerlink" title="3、nvidia-docker-runtime安装"></a>3、<strong>nvidia-docker-runtime安装</strong></h2><p><strong>1）nvidia-docker-runtime作用</strong></p><p>通过nvidia-docker-runtime，可以实现在docker容器内部使用nvidia的gpu 进行相关的模型训练和推理。</p><p>docker 安装完成后，可通过docker run 创建常规的docker容器，但是不安装nvidia相关组件无法使用NVIDIA的显卡，docker run 添加 –runtime=nvidia 或者添加–gpus参数报错，并且普通创建的容器执行nvidia-smi 没有返回结果，会出现如下提示。</p><blockquote><p>docker: Error response from daemon: could not select device driver “” with <a href="https://zhida.zhihu.com/search?content_id=230653465&content_type=Article&match_order=1&q=capabilities&zhida_source=entity">capabilities</a>: [[gpu]].<br>unknown flag: –gpus</p></blockquote><p><strong>2）不同版本docker 安装nvidia gpu SDK区别</strong></p><p>在docker19.x以前的版本需要下载<a href="https://zhida.zhihu.com/search?content_id=230653465&content_type=Article&match_order=1&q=nvidia-docker2&zhida_source=entity">nvidia-docker2</a>来启动容器；通过使用<a href="https://zhida.zhihu.com/search?content_id=230653465&content_type=Article&match_order=1&q=nvidia-docker+run&zhida_source=entity">nvidia-docker run</a>或者docker run –runtime=nvidia的方式来指定gpu；</p><p>docker19.x后版本使用gpu只需要加个参数–gpus all即可(all：使用所有的gpu，如果要使用2个gpu：–gpus 2，也可直接指定哪几个卡：–gpus ‘“device=1,2”‘</p><p><strong>3）nvidia-container-runtime 离线包下载</strong></p><p>下载nvidia-container-runtime依赖包到本地，找一台可以上网的centos7.x的虚拟机（<a href="https://zhida.zhihu.com/search?content_id=230653465&content_type=Article&match_order=1&q=vmware%E8%99%9A%E6%8B%9F%E6%9C%BA&zhida_source=entity">vmware虚拟机</a>即可完成）按顺序执行如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装yum-utils，通过该包的repotrack模块可以快速下载指定包及其所有依赖包。</span></span><br><span class="line">sudo yum -y install yum-utils</span><br><span class="line"><span class="comment">#指定yum镜像源包含nvidia-github</span></span><br><span class="line">distribution=$(. /etc/os-release;<span class="built_in">echo</span> $ID<span class="variable">$VERSION_ID</span>)</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-container-runtime/<span class="variable">$distribution</span>/nvidia-container-runtime.repo | sudo <span class="built_in">tee</span> /etc/yum.repos.d/nvidia-container-runtime.repo</span><br></pre></td></tr></table></figure><p><img src="https://pic1.zhimg.com/80/v2-5ba070a0b5fab66abac5f3ba41cb66ca_720w.webp"></p><p>指定yum nvidia镜像源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载离线安装包到本地</span></span><br><span class="line"><span class="built_in">cd</span> /app/soft/nvidia-container-runtime/</span><br><span class="line">repotrack nvidia-container-runtime </span><br></pre></td></tr></table></figure><p><img src="https://picx.zhimg.com/80/v2-be4211899d8f666ca97a469e2d580b3d_720w.webp"></p><p>下载nvidia-docker-runtime离线包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打包nvidia-container-runtime离线包</span></span><br><span class="line"><span class="built_in">cd</span> /app/soft/</span><br><span class="line">tar -zcvf nvidia-container-runtime.tar.gz nvidia-container-runtime/</span><br></pre></td></tr></table></figure><p><strong>4）nvidia-container-runtime离线包安装</strong></p><p>拷贝nvidia-container-runtime.tar.gz文件到离线GPU服务器，按顺序执行下列命令进行安装、验证。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解压nvidia-container-runtime.tar.gz</span></span><br><span class="line">tar -zxvf nvidia-container-runtime.tar.gz</span><br><span class="line"><span class="comment">#离线安装所有rpm包</span></span><br><span class="line"><span class="built_in">cd</span> nvidia-container-runtime</span><br><span class="line">rpm -Uvh --force --nodeps *.rpm</span><br><span class="line"><span class="comment">#安装完后需要重启容器，未设置为系统启动服务，也可以通过kill docker进程再启动方式重启</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="comment">#查看安装结果</span></span><br><span class="line">whereis  nvidia-container-runtime </span><br></pre></td></tr></table></figure><p>或者</p><p><a href="https://juejin.cn/post/7099007817540960293">银河麒麟V10 Server系统中离线安装nvidia docker方法银河麒麟V10 Server 系统下安装最新的d - 掘金 (juejin.cn)</a>  【未测试】</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo rpm -Uvh libnvidia-container-tools-1.10.0-1.x86_64.rpm --nodeps --force</span><br><span class="line">sudo rpm -Uvh nvidia-container-toolkit-1.10.0-1.x86_64.rpm --nodeps --force</span><br><span class="line">sudo rpm -Uvh libnvidia-container1-1.10.0-1.x86_64.rpm --nodeps --force</span><br><span class="line">sudo rpm -Uvh nvidia-docker2-2.11.0-1.noarch.rpm --nodeps --force</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://pic3.zhimg.com/80/v2-95b20993d196fa53e4ae9e6373d981fe_720w.webp"></p><p>CentOS Docker NVIDIA环境离线安装已经完成，下一章将继续离线Docker镜像制作并安装</p><p>本文转载自：<a href="https://zhuanlan.zhihu.com/p/641349918">CentOS Docker NVIDIA环境离线安装 - 知乎 (zhihu.com)</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> gpu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ollama本地大模型实现联网搜索功能</title>
      <link href="/2024/10/12/ollama%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0%E8%81%94%E7%BD%91%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD/"/>
      <url>/2024/10/12/ollama%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0%E8%81%94%E7%BD%91%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="ollama本地大模型实现联网搜索功能"><a href="#ollama本地大模型实现联网搜索功能" class="headerlink" title="ollama本地大模型实现联网搜索功能"></a>ollama本地大模型实现联网搜索功能</h1><p>Github托管地址：</p><p><a href="https://github.com/yokingma/search_with_ai">https://github.com/yokingma/search_with_ai</a></p><p><a href="https://onenote.zznnwn.cloudns.biz/api/raw/?path=/soeasy/ai%E6%90%9C%E7%B4%A2/search_with_ai-main.zip&odpt=5046321679d1f8c753819aa82a4643426fff5d03f243f3059b4c57ac522727f4">onedrive</a></p><p>将项目文件下载到本地</p><p>git clone <a href="https://github.com/yokingma/search_with_ai.git">https://github.com/yokingma/search_with_ai.git</a></p><p>演示地址：<a href="https://isou.chat/">https://isou.chat/</a></p><h2 id="一-docker-compose-yml-项目文件"><a href="#一-docker-compose-yml-项目文件" class="headerlink" title="一. docker-compose.yml 项目文件"></a>一. docker-compose.yml 项目文件</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">ollama:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:ollama</span> </span><br><span class="line">    <span class="comment">#ollama/ollama:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">11434</span><span class="string">:11434</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ollama:/root/.ollama</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ollama</span></span><br><span class="line">    <span class="attr">pull_policy:</span> <span class="string">if_not_present</span></span><br><span class="line">    <span class="comment">#tty: true</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ollama-docker</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KEEP_GPUS_TIMEOUT:</span> <span class="number">40</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">OLLAMA_ORIGINS:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">      <span class="attr">OLLAMA_HOST:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    <span class="comment"># GPU support</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">devices:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">driver:</span> <span class="string">nvidia</span></span><br><span class="line">              <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">              <span class="attr">capabilities:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">gpu</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">open-webui:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:open-webui-main</span> </span><br><span class="line">    <span class="comment">#ghcr.io/open-webui/open-webui:main</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">open-webui</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;host.docker.internal:host-gateway&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">open-webui:/app/backend/data</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">ENABLE_RAG_WEB_SEARCH:</span> <span class="literal">True</span></span><br><span class="line">      <span class="attr">RAG_WEB_SEARCH_ENGINE:</span> <span class="string">&quot;searxng&quot;</span></span><br><span class="line">      <span class="attr">RAG_WEB_SEARCH_RESULT_COUNT:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">RAG_WEB_SEARCH_CONCURRENT_REQUESTS:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">SEARXNG_QUERY_URL:</span> <span class="string">&quot;http://searxng:8080/search?q=&lt;query&gt;&quot;</span>   </span><br><span class="line">      <span class="attr">ENABLE_OPENAI_API:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># open-webui:</span></span><br><span class="line">  <span class="comment">#   image: ghcr.io/open-webui/open-webui:main</span></span><br><span class="line">  <span class="comment">#   container_name: open-webui</span></span><br><span class="line">  <span class="comment">#   pull_policy: if_not_present</span></span><br><span class="line">  <span class="comment">#   volumes:</span></span><br><span class="line">  <span class="comment">#     - ./data:/app/backend/data</span></span><br><span class="line">  <span class="comment">#   depends_on:</span></span><br><span class="line">  <span class="comment">#     - ollama</span></span><br><span class="line">  <span class="comment">#   ports:</span></span><br><span class="line">  <span class="comment">#     - 3000:8080</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - &#x27;OLLAMA_BASE_URL=http://ollama:11434&#x27;</span></span><br><span class="line">  <span class="comment">#     - &#x27;WEBUI_SECRET_KEY=sdjfvdklfbvkkgb&#x27;</span></span><br><span class="line">  <span class="comment">#     - &#x27;HF_ENDPOINT=https://hf-mirror.com&#x27;</span></span><br><span class="line">  <span class="comment">#   extra_hosts:</span></span><br><span class="line">  <span class="comment">#     - host.docker.internal:host-gateway</span></span><br><span class="line">  <span class="comment">#   restart: unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ollama-docker</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">search:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">aisearch</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/ai:aisearch-amd64</span> </span><br><span class="line">    <span class="comment">#zacma/aisearch:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./.env.docker:/app/.env</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./model.json:/app/dist/model.json</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3002:3000&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ollama-docker</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">searxng:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">searxng</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/ai:searxng-latest</span> </span><br><span class="line">    <span class="comment">#docker.io/searxng/searxng:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="comment">#ports:</span></span><br><span class="line">      <span class="comment">#- &quot;127.0.0.1:8090:8080&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./searxng:/etc/searxng:rw</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SEARXNG_BASE_URL=https://$&#123;SEARXNG_HOSTNAME:-localhost&#125;/</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ollama-docker</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">open-webui:</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">ollama-docker:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="search配置文件"><a href="#search配置文件" class="headerlink" title="search配置文件"></a>search配置文件</h3><h4 id="1-env-docker"><a href="#1-env-docker" class="headerlink" title="1..env.docker"></a>1.<code>.env.docker</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server Port</span></span><br><span class="line">PORT=3000</span><br><span class="line"><span class="comment"># Bing search key</span></span><br><span class="line">BING_SEARCH_KEY=</span><br><span class="line"><span class="comment"># Google search key</span></span><br><span class="line">GOOGLE_SEARCH_KEY=</span><br><span class="line">GOOGLE_SEARCH_ID=</span><br><span class="line"><span class="comment"># aliyun key</span></span><br><span class="line">ALIYUN_KEY=</span><br><span class="line"><span class="comment"># Yi Key</span></span><br><span class="line">YI_KEY=</span><br><span class="line"><span class="comment"># google gemini</span></span><br><span class="line">GOOGLE_KEY=</span><br><span class="line"><span class="comment">#GOOGLE_PROXY_URL=</span></span><br><span class="line">OPENAI_PROXY_URL=http://freeduckduckgo:3456/v1</span><br><span class="line"><span class="comment"># baidu</span></span><br><span class="line">BAIDU_KEY=</span><br><span class="line">BAIDU_SECRET=</span><br><span class="line"><span class="comment"># tencent KEY:ID, SECRET:KEY</span></span><br><span class="line">TENCENT_KEY=</span><br><span class="line">TENCENT_SECRET=</span><br><span class="line"><span class="comment"># openai key</span></span><br><span class="line">OPENAI_KEY=</span><br><span class="line"><span class="comment"># openai BASE_URL</span></span><br><span class="line">OPENAI_PROXY_URL=</span><br><span class="line"><span class="comment"># deepseek</span></span><br><span class="line">DEEPSEEK_KEY= <span class="comment">#your_key</span></span><br><span class="line"><span class="comment"># chatglm</span></span><br><span class="line">GLM_KEY= <span class="comment">#your_key</span></span><br><span class="line"><span class="comment"># moonshot</span></span><br><span class="line">MOONSHOT_KEY=</span><br><span class="line"><span class="comment"># lepthon key</span></span><br><span class="line">LEPTON_KEY=</span><br><span class="line"><span class="comment"># Local llm: Ollama hostname, could modify if you need.</span></span><br><span class="line">OLLAMA_HOST=http://host.docker.internal:11434</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="comment"># OLLAMA_HOST=10.0.0.10:11434</span></span><br><span class="line"><span class="comment"># Local llm: LM Studio host name</span></span><br><span class="line">LMSTUDIO_HOSTNAME=localhost:1234</span><br><span class="line"><span class="comment"># Searxng hostname, could modify if you need.</span></span><br><span class="line">SEARXNG_HOSTNAME=http://searxng:8080</span><br><span class="line"><span class="comment"># https://github.com/searxng/searxng/tree/master/searx/engines</span></span><br><span class="line">SEARXNG_ENGINES=bing,google</span><br><span class="line">SEARXNG_IMAGES_ENGINES=bing <span class="comment">#,google</span></span><br><span class="line"><span class="comment"># The count of resources referenced</span></span><br><span class="line">REFERENCE_COUNT = 8</span><br><span class="line"><span class="comment"># enable cache, 1 enable, 0 disable</span></span><br><span class="line">CACHE_ENABLE=1</span><br><span class="line"><span class="comment"># SearXNG 查询选项，safesearch：过滤搜索结果，0：无 1：中等 2：严格。(新增重要配置)</span></span><br><span class="line">SEARXNG_SAFE=1</span><br></pre></td></tr></table></figure><h4 id="2-model-json"><a href="#2-model-json" class="headerlink" title="2.model.json"></a>2.<code>model.json</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;aliyun&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;models&quot;</span>: [<span class="string">&quot;qwen-max&quot;</span>, <span class="string">&quot;qwen-max-0428&quot;</span>, <span class="string">&quot;qwen-turbo&quot;</span>, <span class="string">&quot;qwen-plus&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;openai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;openai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;models&quot;</span>: [<span class="string">&quot;o1-preview&quot;</span>, <span class="string">&quot;o1-mini&quot;</span>, <span class="string">&quot;gpt-4o&quot;</span>, <span class="string">&quot;gpt-4o-mini&quot;</span>, <span class="string">&quot;gpt-4o-latest&quot;</span>, <span class="string">&quot;gpt-4-preview&quot;</span>, <span class="string">&quot;gpt-4-turbo&quot;</span>, <span class="string">&quot;gpt-4&quot;</span>, <span class="string">&quot;gpt-3.5-turbo&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;baidu&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;baidu&quot;</span>,</span><br><span class="line">    <span class="string">&quot;models&quot;</span>: [<span class="string">&quot;eb-instant&quot;</span>, <span class="string">&quot;completions_pro&quot;</span>, <span class="string">&quot;ernie_bot_8k&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;google&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;gemini&quot;</span>,</span><br><span class="line">    <span class="string">&quot;models&quot;</span>: [<span class="string">&quot;gemini-1.0-pro&quot;</span>, <span class="string">&quot;gemini-1.5-pro&quot;</span>, <span class="string">&quot;gemini-1.5-flash&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;yi&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;openai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;models&quot;</span>: [<span class="string">&quot;yi-large&quot;</span>, <span class="string">&quot;yi-large-turbo&quot;</span>, <span class="string">&quot;yi-medium&quot;</span>, <span class="string">&quot;yi-spark&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;moonshot&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;openai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;models&quot;</span>: [<span class="string">&quot;moonshot-v1-8k&quot;</span>, <span class="string">&quot;moonshot-v1-32k&quot;</span>, <span class="string">&quot;moonshot-v1-128k&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;lepton&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;openai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;models&quot;</span>: [<span class="string">&quot;llama2-7b&quot;</span>, <span class="string">&quot;llama2-13b&quot;</span>, <span class="string">&quot;llama2-70b&quot;</span>, <span class="string">&quot;mixtral-8*7b&quot;</span>, <span class="string">&quot;mixtral-8*22b&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;deepseek&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;openai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;models&quot;</span>: [<span class="string">&quot;deepseek-chat&quot;</span>, <span class="string">&quot;deepseek-coder&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;chatglm&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;openai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;models&quot;</span>: [<span class="string">&quot;glm-4&quot;</span>, <span class="string">&quot;glm-4-plus&quot;</span>, <span class="string">&quot;glm-4-air&quot;</span>, <span class="string">&quot;glm-4-airx&quot;</span>, <span class="string">&quot;glm-4-flash&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;tencent&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;tencent&quot;</span>,</span><br><span class="line">    <span class="string">&quot;models&quot;</span>: [<span class="string">&quot;std&quot;</span>, <span class="string">&quot;pro&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="searxng配置文件（-searxng目录下）"><a href="#searxng配置文件（-searxng目录下）" class="headerlink" title="searxng配置文件（./searxng目录下）"></a>searxng配置文件（./searxng目录下）</h3><h4 id="1-uwsgi-ini"><a href="#1-uwsgi-ini" class="headerlink" title="1.uwsgi.ini"></a>1.<code>uwsgi.ini</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line"><span class="comment"># Who will run the code</span></span><br><span class="line">uid = searxng</span><br><span class="line">gid = searxng</span><br><span class="line"></span><br><span class="line"><span class="comment"># Number of workers (usually CPU count)</span></span><br><span class="line"><span class="comment"># default value: %k (= number of CPU core, see Dockerfile)</span></span><br><span class="line">workers = %k</span><br><span class="line"></span><br><span class="line"><span class="comment"># Number of threads per worker</span></span><br><span class="line"><span class="comment"># default value: 4 (see Dockerfile)</span></span><br><span class="line">threads = 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># The right granted on the created socket</span></span><br><span class="line">chmod-socket = 666</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plugin to use and interpreter config</span></span><br><span class="line">single-interpreter = <span class="literal">true</span></span><br><span class="line">master = <span class="literal">true</span></span><br><span class="line">plugin = python3</span><br><span class="line">lazy-apps = <span class="literal">true</span></span><br><span class="line">enable-threads = 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># Module to import</span></span><br><span class="line">module = searx.webapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Virtualenv and python path</span></span><br><span class="line">pythonpath = /usr/local/searxng/</span><br><span class="line"><span class="built_in">chdir</span> = /usr/local/searxng/searx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># automatically set processes name to something meaningful</span></span><br><span class="line">auto-procname = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable request logging for privacy</span></span><br><span class="line">disable-logging = <span class="literal">true</span></span><br><span class="line">log-5xx = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the max size of a request (request-body excluded)</span></span><br><span class="line">buffer-size = 8192</span><br><span class="line"></span><br><span class="line"><span class="comment"># No keep alive</span></span><br><span class="line"><span class="comment"># See https://github.com/searx/searx-docker/issues/24</span></span><br><span class="line">add-header = Connection: close</span><br><span class="line"></span><br><span class="line"><span class="comment"># Follow SIGTERM convention</span></span><br><span class="line"><span class="comment"># See https://github.com/searxng/searxng/issues/3427</span></span><br><span class="line">die-on-term</span><br><span class="line"></span><br><span class="line"><span class="comment"># uwsgi serves the static files</span></span><br><span class="line">static-map = /static=/usr/local/searxng/searx/static</span><br><span class="line"><span class="comment"># expires set to one day</span></span><br><span class="line">static-expires = /* 86400</span><br><span class="line">static-gzip-all = True</span><br><span class="line">offload-threads = 4</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-settings-yml"><a href="#2-settings-yml" class="headerlink" title="2.settings.yml"></a>2.<code>settings.yml</code></h4><p>重要配置</p><blockquote><p>SearXNG 是一个免费的互联网元搜索引擎，它聚合了来自各种搜索服务和数据库的结果。该服务不跟踪或分析用户，为寻求在线匿名的用户提供了在线隐私。此外，SearXNG 还可以通过 Tor 使用以实现在线匿名。</p></blockquote><p>安装 SearXNG 后，默认情况下唯一激活的输出格式是 HTML 格式。您需要激活 json 格式以使用 API。这可以通过在 settings.yml 文件中修改以下行来完成：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="comment"># Filter results. 0: None, 1: Moderate, 2: Strict</span></span><br><span class="line">  <span class="attr">safe_search:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># Existing autocomplete backends: &quot;dbpedia&quot;, &quot;duckduckgo&quot;, &quot;google&quot;, &quot;yandex&quot;, &quot;mwmbl&quot;,</span></span><br><span class="line">  <span class="comment"># &quot;seznam&quot;, &quot;startpage&quot;, &quot;stract&quot;, &quot;swisscows&quot;, &quot;qwant&quot;, &quot;wikipedia&quot; - leave blank to turn it off</span></span><br><span class="line">  <span class="comment"># by default.</span></span><br><span class="line">  <span class="attr">autocomplete:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># minimun characters to type before autocompleter starts</span></span><br><span class="line">  <span class="attr">autocomplete_min:</span> <span class="number">4</span></span><br><span class="line">  <span class="comment"># Default search language - leave blank to detect from browser information or</span></span><br><span class="line">  <span class="comment"># use codes from &#x27;languages.py&#x27;</span></span><br><span class="line">  <span class="attr">default_lang:</span> <span class="string">&quot;auto&quot;</span></span><br><span class="line">  <span class="comment"># max_page: 0  # if engine supports paging, 0 means unlimited numbers of pages</span></span><br><span class="line">  <span class="comment"># Available languages</span></span><br><span class="line">  <span class="comment"># languages:</span></span><br><span class="line">  <span class="comment">#   - all</span></span><br><span class="line">  <span class="comment">#   - en</span></span><br><span class="line">  <span class="comment">#   - en-US</span></span><br><span class="line">  <span class="comment">#   - de</span></span><br><span class="line">  <span class="comment">#   - it-IT</span></span><br><span class="line">  <span class="comment">#   - fr</span></span><br><span class="line">  <span class="comment">#   - fr-BE</span></span><br><span class="line">  <span class="comment"># ban time in seconds after engine errors</span></span><br><span class="line">  <span class="attr">ban_time_on_fail:</span> <span class="number">5</span></span><br><span class="line">  <span class="comment"># max ban time in seconds after engine errors</span></span><br><span class="line">  <span class="attr">max_ban_time_on_fail:</span> <span class="number">120</span></span><br><span class="line">  <span class="attr">suspended_times:</span></span><br><span class="line">    <span class="comment"># Engine suspension time after error (in seconds; set to 0 to disable)</span></span><br><span class="line">    <span class="comment"># For error &quot;Access denied&quot; and &quot;HTTP error [402, 403]&quot;</span></span><br><span class="line">    <span class="attr">SearxEngineAccessDenied:</span> <span class="number">86400</span></span><br><span class="line">    <span class="comment"># For error &quot;CAPTCHA&quot;</span></span><br><span class="line">    <span class="attr">SearxEngineCaptcha:</span> <span class="number">86400</span></span><br><span class="line">    <span class="comment"># For error &quot;Too many request&quot; and &quot;HTTP error 429&quot;</span></span><br><span class="line">    <span class="attr">SearxEngineTooManyRequests:</span> <span class="number">3600</span></span><br><span class="line">    <span class="comment"># Cloudflare CAPTCHA</span></span><br><span class="line">    <span class="attr">cf_SearxEngineCaptcha:</span> <span class="number">1296000</span></span><br><span class="line">    <span class="attr">cf_SearxEngineAccessDenied:</span> <span class="number">86400</span></span><br><span class="line">    <span class="comment"># ReCAPTCHA</span></span><br><span class="line">    <span class="attr">recaptcha_SearxEngineCaptcha:</span> <span class="number">604800</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># remove format to deny access, use lower case.</span></span><br><span class="line">  <span class="comment"># formats: [html, csv, json, rss]</span></span><br><span class="line">  <span class="attr">formats:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">html</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">json</span>  <span class="comment"># 添加此即可</span></span><br></pre></td></tr></table></figure><p>启用默认搜索引擎及视频搜索引擎</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: bilibili</span><br><span class="line">  engine: bilibili</span><br><span class="line">  shortcut: bil</span><br><span class="line">  disabled: false</span><br><span class="line"></span><br><span class="line">- name: bing</span><br><span class="line">  engine: bing</span><br><span class="line">  shortcut: bi</span><br><span class="line">  disabled: false</span><br></pre></td></tr></table></figure><p>完整配置如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br><span class="line">1862</span><br><span class="line">1863</span><br><span class="line">1864</span><br><span class="line">1865</span><br><span class="line">1866</span><br><span class="line">1867</span><br><span class="line">1868</span><br><span class="line">1869</span><br><span class="line">1870</span><br><span class="line">1871</span><br><span class="line">1872</span><br><span class="line">1873</span><br><span class="line">1874</span><br><span class="line">1875</span><br><span class="line">1876</span><br><span class="line">1877</span><br><span class="line">1878</span><br><span class="line">1879</span><br><span class="line">1880</span><br><span class="line">1881</span><br><span class="line">1882</span><br><span class="line">1883</span><br><span class="line">1884</span><br><span class="line">1885</span><br><span class="line">1886</span><br><span class="line">1887</span><br><span class="line">1888</span><br><span class="line">1889</span><br><span class="line">1890</span><br><span class="line">1891</span><br><span class="line">1892</span><br><span class="line">1893</span><br><span class="line">1894</span><br><span class="line">1895</span><br><span class="line">1896</span><br><span class="line">1897</span><br><span class="line">1898</span><br><span class="line">1899</span><br><span class="line">1900</span><br><span class="line">1901</span><br><span class="line">1902</span><br><span class="line">1903</span><br><span class="line">1904</span><br><span class="line">1905</span><br><span class="line">1906</span><br><span class="line">1907</span><br><span class="line">1908</span><br><span class="line">1909</span><br><span class="line">1910</span><br><span class="line">1911</span><br><span class="line">1912</span><br><span class="line">1913</span><br><span class="line">1914</span><br><span class="line">1915</span><br><span class="line">1916</span><br><span class="line">1917</span><br><span class="line">1918</span><br><span class="line">1919</span><br><span class="line">1920</span><br><span class="line">1921</span><br><span class="line">1922</span><br><span class="line">1923</span><br><span class="line">1924</span><br><span class="line">1925</span><br><span class="line">1926</span><br><span class="line">1927</span><br><span class="line">1928</span><br><span class="line">1929</span><br><span class="line">1930</span><br><span class="line">1931</span><br><span class="line">1932</span><br><span class="line">1933</span><br><span class="line">1934</span><br><span class="line">1935</span><br><span class="line">1936</span><br><span class="line">1937</span><br><span class="line">1938</span><br><span class="line">1939</span><br><span class="line">1940</span><br><span class="line">1941</span><br><span class="line">1942</span><br><span class="line">1943</span><br><span class="line">1944</span><br><span class="line">1945</span><br><span class="line">1946</span><br><span class="line">1947</span><br><span class="line">1948</span><br><span class="line">1949</span><br><span class="line">1950</span><br><span class="line">1951</span><br><span class="line">1952</span><br><span class="line">1953</span><br><span class="line">1954</span><br><span class="line">1955</span><br><span class="line">1956</span><br><span class="line">1957</span><br><span class="line">1958</span><br><span class="line">1959</span><br><span class="line">1960</span><br><span class="line">1961</span><br><span class="line">1962</span><br><span class="line">1963</span><br><span class="line">1964</span><br><span class="line">1965</span><br><span class="line">1966</span><br><span class="line">1967</span><br><span class="line">1968</span><br><span class="line">1969</span><br><span class="line">1970</span><br><span class="line">1971</span><br><span class="line">1972</span><br><span class="line">1973</span><br><span class="line">1974</span><br><span class="line">1975</span><br><span class="line">1976</span><br><span class="line">1977</span><br><span class="line">1978</span><br><span class="line">1979</span><br><span class="line">1980</span><br><span class="line">1981</span><br><span class="line">1982</span><br><span class="line">1983</span><br><span class="line">1984</span><br><span class="line">1985</span><br><span class="line">1986</span><br><span class="line">1987</span><br><span class="line">1988</span><br><span class="line">1989</span><br><span class="line">1990</span><br><span class="line">1991</span><br><span class="line">1992</span><br><span class="line">1993</span><br><span class="line">1994</span><br><span class="line">1995</span><br><span class="line">1996</span><br><span class="line">1997</span><br><span class="line">1998</span><br><span class="line">1999</span><br><span class="line">2000</span><br><span class="line">2001</span><br><span class="line">2002</span><br><span class="line">2003</span><br><span class="line">2004</span><br><span class="line">2005</span><br><span class="line">2006</span><br><span class="line">2007</span><br><span class="line">2008</span><br><span class="line">2009</span><br><span class="line">2010</span><br><span class="line">2011</span><br><span class="line">2012</span><br><span class="line">2013</span><br><span class="line">2014</span><br><span class="line">2015</span><br><span class="line">2016</span><br><span class="line">2017</span><br><span class="line">2018</span><br><span class="line">2019</span><br><span class="line">2020</span><br><span class="line">2021</span><br><span class="line">2022</span><br><span class="line">2023</span><br><span class="line">2024</span><br><span class="line">2025</span><br><span class="line">2026</span><br><span class="line">2027</span><br><span class="line">2028</span><br><span class="line">2029</span><br><span class="line">2030</span><br><span class="line">2031</span><br><span class="line">2032</span><br><span class="line">2033</span><br><span class="line">2034</span><br><span class="line">2035</span><br><span class="line">2036</span><br><span class="line">2037</span><br><span class="line">2038</span><br><span class="line">2039</span><br><span class="line">2040</span><br><span class="line">2041</span><br><span class="line">2042</span><br><span class="line">2043</span><br><span class="line">2044</span><br><span class="line">2045</span><br><span class="line">2046</span><br><span class="line">2047</span><br><span class="line">2048</span><br><span class="line">2049</span><br><span class="line">2050</span><br><span class="line">2051</span><br><span class="line">2052</span><br><span class="line">2053</span><br><span class="line">2054</span><br><span class="line">2055</span><br><span class="line">2056</span><br><span class="line">2057</span><br><span class="line">2058</span><br><span class="line">2059</span><br><span class="line">2060</span><br><span class="line">2061</span><br><span class="line">2062</span><br><span class="line">2063</span><br><span class="line">2064</span><br><span class="line">2065</span><br><span class="line">2066</span><br><span class="line">2067</span><br><span class="line">2068</span><br><span class="line">2069</span><br><span class="line">2070</span><br><span class="line">2071</span><br><span class="line">2072</span><br><span class="line">2073</span><br><span class="line">2074</span><br><span class="line">2075</span><br><span class="line">2076</span><br><span class="line">2077</span><br><span class="line">2078</span><br><span class="line">2079</span><br><span class="line">2080</span><br><span class="line">2081</span><br><span class="line">2082</span><br><span class="line">2083</span><br><span class="line">2084</span><br><span class="line">2085</span><br><span class="line">2086</span><br><span class="line">2087</span><br><span class="line">2088</span><br><span class="line">2089</span><br><span class="line">2090</span><br><span class="line">2091</span><br><span class="line">2092</span><br><span class="line">2093</span><br><span class="line">2094</span><br><span class="line">2095</span><br><span class="line">2096</span><br><span class="line">2097</span><br><span class="line">2098</span><br><span class="line">2099</span><br><span class="line">2100</span><br><span class="line">2101</span><br><span class="line">2102</span><br><span class="line">2103</span><br><span class="line">2104</span><br><span class="line">2105</span><br><span class="line">2106</span><br><span class="line">2107</span><br><span class="line">2108</span><br><span class="line">2109</span><br><span class="line">2110</span><br><span class="line">2111</span><br><span class="line">2112</span><br><span class="line">2113</span><br><span class="line">2114</span><br><span class="line">2115</span><br><span class="line">2116</span><br><span class="line">2117</span><br><span class="line">2118</span><br><span class="line">2119</span><br><span class="line">2120</span><br><span class="line">2121</span><br><span class="line">2122</span><br><span class="line">2123</span><br><span class="line">2124</span><br><span class="line">2125</span><br><span class="line">2126</span><br><span class="line">2127</span><br><span class="line">2128</span><br><span class="line">2129</span><br><span class="line">2130</span><br><span class="line">2131</span><br><span class="line">2132</span><br><span class="line">2133</span><br><span class="line">2134</span><br><span class="line">2135</span><br><span class="line">2136</span><br><span class="line">2137</span><br><span class="line">2138</span><br><span class="line">2139</span><br><span class="line">2140</span><br><span class="line">2141</span><br><span class="line">2142</span><br><span class="line">2143</span><br><span class="line">2144</span><br><span class="line">2145</span><br><span class="line">2146</span><br><span class="line">2147</span><br><span class="line">2148</span><br><span class="line">2149</span><br><span class="line">2150</span><br><span class="line">2151</span><br><span class="line">2152</span><br><span class="line">2153</span><br><span class="line">2154</span><br><span class="line">2155</span><br><span class="line">2156</span><br><span class="line">2157</span><br><span class="line">2158</span><br><span class="line">2159</span><br><span class="line">2160</span><br><span class="line">2161</span><br><span class="line">2162</span><br><span class="line">2163</span><br><span class="line">2164</span><br><span class="line">2165</span><br><span class="line">2166</span><br><span class="line">2167</span><br><span class="line">2168</span><br><span class="line">2169</span><br><span class="line">2170</span><br><span class="line">2171</span><br><span class="line">2172</span><br><span class="line">2173</span><br><span class="line">2174</span><br><span class="line">2175</span><br><span class="line">2176</span><br><span class="line">2177</span><br><span class="line">2178</span><br><span class="line">2179</span><br><span class="line">2180</span><br><span class="line">2181</span><br><span class="line">2182</span><br><span class="line">2183</span><br><span class="line">2184</span><br><span class="line">2185</span><br><span class="line">2186</span><br><span class="line">2187</span><br><span class="line">2188</span><br><span class="line">2189</span><br><span class="line">2190</span><br><span class="line">2191</span><br><span class="line">2192</span><br><span class="line">2193</span><br><span class="line">2194</span><br><span class="line">2195</span><br><span class="line">2196</span><br><span class="line">2197</span><br><span class="line">2198</span><br><span class="line">2199</span><br><span class="line">2200</span><br><span class="line">2201</span><br><span class="line">2202</span><br><span class="line">2203</span><br><span class="line">2204</span><br><span class="line">2205</span><br><span class="line">2206</span><br><span class="line">2207</span><br><span class="line">2208</span><br><span class="line">2209</span><br><span class="line">2210</span><br><span class="line">2211</span><br><span class="line">2212</span><br><span class="line">2213</span><br><span class="line">2214</span><br><span class="line">2215</span><br><span class="line">2216</span><br><span class="line">2217</span><br><span class="line">2218</span><br><span class="line">2219</span><br><span class="line">2220</span><br><span class="line">2221</span><br><span class="line">2222</span><br><span class="line">2223</span><br><span class="line">2224</span><br><span class="line">2225</span><br><span class="line">2226</span><br><span class="line">2227</span><br><span class="line">2228</span><br><span class="line">2229</span><br><span class="line">2230</span><br><span class="line">2231</span><br><span class="line">2232</span><br><span class="line">2233</span><br><span class="line">2234</span><br><span class="line">2235</span><br><span class="line">2236</span><br><span class="line">2237</span><br><span class="line">2238</span><br><span class="line">2239</span><br><span class="line">2240</span><br><span class="line">2241</span><br><span class="line">2242</span><br><span class="line">2243</span><br><span class="line">2244</span><br><span class="line">2245</span><br><span class="line">2246</span><br><span class="line">2247</span><br><span class="line">2248</span><br><span class="line">2249</span><br><span class="line">2250</span><br><span class="line">2251</span><br><span class="line">2252</span><br><span class="line">2253</span><br><span class="line">2254</span><br><span class="line">2255</span><br><span class="line">2256</span><br><span class="line">2257</span><br><span class="line">2258</span><br><span class="line">2259</span><br><span class="line">2260</span><br><span class="line">2261</span><br><span class="line">2262</span><br><span class="line">2263</span><br><span class="line">2264</span><br><span class="line">2265</span><br><span class="line">2266</span><br><span class="line">2267</span><br><span class="line">2268</span><br><span class="line">2269</span><br><span class="line">2270</span><br><span class="line">2271</span><br><span class="line">2272</span><br><span class="line">2273</span><br><span class="line">2274</span><br><span class="line">2275</span><br><span class="line">2276</span><br><span class="line">2277</span><br><span class="line">2278</span><br><span class="line">2279</span><br><span class="line">2280</span><br><span class="line">2281</span><br><span class="line">2282</span><br><span class="line">2283</span><br><span class="line">2284</span><br><span class="line">2285</span><br><span class="line">2286</span><br><span class="line">2287</span><br><span class="line">2288</span><br><span class="line">2289</span><br><span class="line">2290</span><br><span class="line">2291</span><br><span class="line">2292</span><br><span class="line">2293</span><br><span class="line">2294</span><br><span class="line">2295</span><br><span class="line">2296</span><br><span class="line">2297</span><br><span class="line">2298</span><br><span class="line">2299</span><br><span class="line">2300</span><br><span class="line">2301</span><br><span class="line">2302</span><br><span class="line">2303</span><br><span class="line">2304</span><br><span class="line">2305</span><br><span class="line">2306</span><br><span class="line">2307</span><br><span class="line">2308</span><br><span class="line">2309</span><br><span class="line">2310</span><br><span class="line">2311</span><br><span class="line">2312</span><br><span class="line">2313</span><br><span class="line">2314</span><br><span class="line">2315</span><br><span class="line">2316</span><br><span class="line">2317</span><br><span class="line">2318</span><br><span class="line">2319</span><br><span class="line">2320</span><br><span class="line">2321</span><br><span class="line">2322</span><br><span class="line">2323</span><br><span class="line">2324</span><br><span class="line">2325</span><br><span class="line">2326</span><br><span class="line">2327</span><br><span class="line">2328</span><br><span class="line">2329</span><br><span class="line">2330</span><br><span class="line">2331</span><br><span class="line">2332</span><br><span class="line">2333</span><br><span class="line">2334</span><br><span class="line">2335</span><br><span class="line">2336</span><br><span class="line">2337</span><br><span class="line">2338</span><br><span class="line">2339</span><br><span class="line">2340</span><br><span class="line">2341</span><br><span class="line">2342</span><br><span class="line">2343</span><br><span class="line">2344</span><br><span class="line">2345</span><br><span class="line">2346</span><br><span class="line">2347</span><br><span class="line">2348</span><br><span class="line">2349</span><br><span class="line">2350</span><br><span class="line">2351</span><br><span class="line">2352</span><br><span class="line">2353</span><br><span class="line">2354</span><br><span class="line">2355</span><br><span class="line">2356</span><br><span class="line">2357</span><br><span class="line">2358</span><br><span class="line">2359</span><br><span class="line">2360</span><br><span class="line">2361</span><br><span class="line">2362</span><br><span class="line">2363</span><br><span class="line">2364</span><br><span class="line">2365</span><br><span class="line">2366</span><br><span class="line">2367</span><br><span class="line">2368</span><br><span class="line">2369</span><br><span class="line">2370</span><br><span class="line">2371</span><br><span class="line">2372</span><br><span class="line">2373</span><br><span class="line">2374</span><br><span class="line">2375</span><br><span class="line">2376</span><br><span class="line">2377</span><br><span class="line">2378</span><br><span class="line">2379</span><br><span class="line">2380</span><br><span class="line">2381</span><br><span class="line">2382</span><br><span class="line">2383</span><br><span class="line">2384</span><br><span class="line">2385</span><br><span class="line">2386</span><br><span class="line">2387</span><br><span class="line">2388</span><br><span class="line">2389</span><br><span class="line">2390</span><br><span class="line">2391</span><br><span class="line">2392</span><br><span class="line">2393</span><br><span class="line">2394</span><br><span class="line">2395</span><br><span class="line">2396</span><br><span class="line">2397</span><br><span class="line">2398</span><br><span class="line">2399</span><br><span class="line">2400</span><br><span class="line">2401</span><br><span class="line">2402</span><br><span class="line">2403</span><br><span class="line">2404</span><br><span class="line">2405</span><br><span class="line">2406</span><br><span class="line">2407</span><br><span class="line">2408</span><br><span class="line">2409</span><br><span class="line">2410</span><br><span class="line">2411</span><br><span class="line">2412</span><br><span class="line">2413</span><br><span class="line">2414</span><br><span class="line">2415</span><br><span class="line">2416</span><br><span class="line">2417</span><br><span class="line">2418</span><br><span class="line">2419</span><br><span class="line">2420</span><br><span class="line">2421</span><br><span class="line">2422</span><br><span class="line">2423</span><br><span class="line">2424</span><br><span class="line">2425</span><br><span class="line">2426</span><br><span class="line">2427</span><br><span class="line">2428</span><br><span class="line">2429</span><br><span class="line">2430</span><br><span class="line">2431</span><br><span class="line">2432</span><br><span class="line">2433</span><br><span class="line">2434</span><br><span class="line">2435</span><br><span class="line">2436</span><br><span class="line">2437</span><br><span class="line">2438</span><br><span class="line">2439</span><br><span class="line">2440</span><br><span class="line">2441</span><br><span class="line">2442</span><br><span class="line">2443</span><br><span class="line">2444</span><br><span class="line">2445</span><br><span class="line">2446</span><br><span class="line">2447</span><br><span class="line">2448</span><br><span class="line">2449</span><br><span class="line">2450</span><br><span class="line">2451</span><br><span class="line">2452</span><br><span class="line">2453</span><br><span class="line">2454</span><br><span class="line">2455</span><br><span class="line">2456</span><br><span class="line">2457</span><br><span class="line">2458</span><br><span class="line">2459</span><br><span class="line">2460</span><br><span class="line">2461</span><br><span class="line">2462</span><br><span class="line">2463</span><br><span class="line">2464</span><br><span class="line">2465</span><br><span class="line">2466</span><br><span class="line">2467</span><br><span class="line">2468</span><br><span class="line">2469</span><br><span class="line">2470</span><br><span class="line">2471</span><br><span class="line">2472</span><br><span class="line">2473</span><br><span class="line">2474</span><br><span class="line">2475</span><br><span class="line">2476</span><br><span class="line">2477</span><br><span class="line">2478</span><br><span class="line">2479</span><br><span class="line">2480</span><br><span class="line">2481</span><br><span class="line">2482</span><br><span class="line">2483</span><br><span class="line">2484</span><br><span class="line">2485</span><br><span class="line">2486</span><br><span class="line">2487</span><br><span class="line">2488</span><br><span class="line">2489</span><br><span class="line">2490</span><br><span class="line">2491</span><br><span class="line">2492</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">general:</span></span><br><span class="line">  <span class="comment"># Debug mode, only for development. Is overwritten by $&#123;SEARXNG_DEBUG&#125;</span></span><br><span class="line">  <span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># displayed name</span></span><br><span class="line">  <span class="attr">instance_name:</span> <span class="string">&quot;searxng&quot;</span></span><br><span class="line">  <span class="comment"># For example: https://example.com/privacy</span></span><br><span class="line">  <span class="attr">privacypolicy_url:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># use true to use your own donation page written in searx/info/en/donate.md</span></span><br><span class="line">  <span class="comment"># use false to disable the donation link</span></span><br><span class="line">  <span class="attr">donation_url:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># mailto:contact@example.com</span></span><br><span class="line">  <span class="attr">contact_url:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># record stats</span></span><br><span class="line">  <span class="attr">enable_metrics:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">brand:</span></span><br><span class="line">  <span class="attr">new_issue_url:</span> <span class="string">https://github.com/searxng/searxng/issues/new</span></span><br><span class="line">  <span class="attr">docs_url:</span> <span class="string">https://docs.searxng.org/</span></span><br><span class="line">  <span class="attr">public_instances:</span> <span class="string">https://searx.space</span></span><br><span class="line">  <span class="attr">wiki_url:</span> <span class="string">https://github.com/searxng/searxng/wiki</span></span><br><span class="line">  <span class="attr">issue_url:</span> <span class="string">https://github.com/searxng/searxng/issues</span></span><br><span class="line">  <span class="comment"># custom:</span></span><br><span class="line">  <span class="comment">#   maintainer: &quot;Jon Doe&quot;</span></span><br><span class="line">  <span class="comment">#   # Custom entries in the footer: [title]: [link]</span></span><br><span class="line">  <span class="comment">#   links:</span></span><br><span class="line">  <span class="comment">#     Uptime: https://uptime.searxng.org/history/darmarit-org</span></span><br><span class="line">  <span class="comment">#     About: &quot;https://searxng.org&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="comment"># Filter results. 0: None, 1: Moderate, 2: Strict</span></span><br><span class="line">  <span class="attr">safe_search:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># Existing autocomplete backends: &quot;dbpedia&quot;, &quot;duckduckgo&quot;, &quot;google&quot;, &quot;yandex&quot;, &quot;mwmbl&quot;,</span></span><br><span class="line">  <span class="comment"># &quot;seznam&quot;, &quot;startpage&quot;, &quot;stract&quot;, &quot;swisscows&quot;, &quot;qwant&quot;, &quot;wikipedia&quot; - leave blank to turn it off</span></span><br><span class="line">  <span class="comment"># by default.</span></span><br><span class="line">  <span class="attr">autocomplete:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># minimun characters to type before autocompleter starts</span></span><br><span class="line">  <span class="attr">autocomplete_min:</span> <span class="number">4</span></span><br><span class="line">  <span class="comment"># Default search language - leave blank to detect from browser information or</span></span><br><span class="line">  <span class="comment"># use codes from &#x27;languages.py&#x27;</span></span><br><span class="line">  <span class="attr">default_lang:</span> <span class="string">&quot;auto&quot;</span></span><br><span class="line">  <span class="comment"># max_page: 0  # if engine supports paging, 0 means unlimited numbers of pages</span></span><br><span class="line">  <span class="comment"># Available languages</span></span><br><span class="line">  <span class="comment"># languages:</span></span><br><span class="line">  <span class="comment">#   - all</span></span><br><span class="line">  <span class="comment">#   - en</span></span><br><span class="line">  <span class="comment">#   - en-US</span></span><br><span class="line">  <span class="comment">#   - de</span></span><br><span class="line">  <span class="comment">#   - it-IT</span></span><br><span class="line">  <span class="comment">#   - fr</span></span><br><span class="line">  <span class="comment">#   - fr-BE</span></span><br><span class="line">  <span class="comment"># ban time in seconds after engine errors</span></span><br><span class="line">  <span class="attr">ban_time_on_fail:</span> <span class="number">5</span></span><br><span class="line">  <span class="comment"># max ban time in seconds after engine errors</span></span><br><span class="line">  <span class="attr">max_ban_time_on_fail:</span> <span class="number">120</span></span><br><span class="line">  <span class="attr">suspended_times:</span></span><br><span class="line">    <span class="comment"># Engine suspension time after error (in seconds; set to 0 to disable)</span></span><br><span class="line">    <span class="comment"># For error &quot;Access denied&quot; and &quot;HTTP error [402, 403]&quot;</span></span><br><span class="line">    <span class="attr">SearxEngineAccessDenied:</span> <span class="number">86400</span></span><br><span class="line">    <span class="comment"># For error &quot;CAPTCHA&quot;</span></span><br><span class="line">    <span class="attr">SearxEngineCaptcha:</span> <span class="number">86400</span></span><br><span class="line">    <span class="comment"># For error &quot;Too many request&quot; and &quot;HTTP error 429&quot;</span></span><br><span class="line">    <span class="attr">SearxEngineTooManyRequests:</span> <span class="number">3600</span></span><br><span class="line">    <span class="comment"># Cloudflare CAPTCHA</span></span><br><span class="line">    <span class="attr">cf_SearxEngineCaptcha:</span> <span class="number">1296000</span></span><br><span class="line">    <span class="attr">cf_SearxEngineAccessDenied:</span> <span class="number">86400</span></span><br><span class="line">    <span class="comment"># ReCAPTCHA</span></span><br><span class="line">    <span class="attr">recaptcha_SearxEngineCaptcha:</span> <span class="number">604800</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># remove format to deny access, use lower case.</span></span><br><span class="line">  <span class="comment"># formats: [html, csv, json, rss]</span></span><br><span class="line">  <span class="attr">formats:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">html</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">json</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="comment"># Is overwritten by $&#123;SEARXNG_PORT&#125; and $&#123;SEARXNG_BIND_ADDRESS&#125;</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line">  <span class="attr">bind_address:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">  <span class="comment"># public URL of the instance, to ensure correct inbound links. Is overwritten</span></span><br><span class="line">  <span class="comment"># by $&#123;SEARXNG_URL&#125;.</span></span><br><span class="line">  <span class="attr">base_url:</span> <span class="string">/</span>  <span class="comment"># &quot;http://example.com/location&quot;</span></span><br><span class="line">  <span class="comment"># rate limit the number of request on the instance, block some bots.</span></span><br><span class="line">  <span class="comment"># Is overwritten by $&#123;SEARXNG_LIMITER&#125;</span></span><br><span class="line">  <span class="attr">limiter:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># enable features designed only for public instances.</span></span><br><span class="line">  <span class="comment"># Is overwritten by $&#123;SEARXNG_PUBLIC_INSTANCE&#125;</span></span><br><span class="line">  <span class="attr">public_instance:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If your instance owns a /etc/searxng/settings.yml file, then set the following</span></span><br><span class="line">  <span class="comment"># values there.</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">secret_key:</span> <span class="string">&quot;09fdb393fba89866f4b3ed5ed4a13c735c9f8cb83947f31b0a306f3fa21f62c2&quot;</span>  <span class="comment"># Is overwritten by $&#123;SEARXNG_SECRET&#125;</span></span><br><span class="line">  <span class="comment"># Proxy image results through SearXNG. Is overwritten by $&#123;SEARXNG_IMAGE_PROXY&#125;</span></span><br><span class="line">  <span class="attr">image_proxy:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 1.0 and 1.1 are supported</span></span><br><span class="line">  <span class="attr">http_protocol_version:</span> <span class="string">&quot;1.0&quot;</span></span><br><span class="line">  <span class="comment"># POST queries are more secure as they don&#x27;t show up in history but may cause</span></span><br><span class="line">  <span class="comment"># problems when using Firefox containers</span></span><br><span class="line">  <span class="attr">method:</span> <span class="string">&quot;POST&quot;</span></span><br><span class="line">  <span class="attr">default_http_headers:</span></span><br><span class="line">    <span class="attr">X-Content-Type-Options:</span> <span class="string">nosniff</span></span><br><span class="line">    <span class="attr">X-Download-Options:</span> <span class="string">noopen</span></span><br><span class="line">    <span class="attr">X-Robots-Tag:</span> <span class="string">noindex,</span> <span class="string">nofollow</span></span><br><span class="line">    <span class="attr">Referrer-Policy:</span> <span class="literal">no</span><span class="string">-referrer</span></span><br><span class="line"></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="comment"># URL to connect redis database. Is overwritten by $&#123;SEARXNG_REDIS_URL&#125;.</span></span><br><span class="line">  <span class="comment"># https://docs.searxng.org/admin/settings/settings_redis.html#settings-redis</span></span><br><span class="line">  <span class="attr">url:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ui:</span></span><br><span class="line">  <span class="comment"># Custom static path - leave it blank if you didn&#x27;t change</span></span><br><span class="line">  <span class="attr">static_path:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># Is overwritten by $&#123;SEARXNG_STATIC_USE_HASH&#125;.</span></span><br><span class="line">  <span class="attr">static_use_hash:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Custom templates path - leave it blank if you didn&#x27;t change</span></span><br><span class="line">  <span class="attr">templates_path:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># query_in_title: When true, the result page&#x27;s titles contains the query</span></span><br><span class="line">  <span class="comment"># it decreases the privacy, since the browser can records the page titles.</span></span><br><span class="line">  <span class="attr">query_in_title:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># infinite_scroll: When true, automatically loads the next page when scrolling to bottom of the current page.</span></span><br><span class="line">  <span class="attr">infinite_scroll:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># ui theme</span></span><br><span class="line">  <span class="attr">default_theme:</span> <span class="string">simple</span></span><br><span class="line">  <span class="comment"># center the results ?</span></span><br><span class="line">  <span class="attr">center_alignment:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># URL prefix of the internet archive, don&#x27;t forget trailing slash (if needed).</span></span><br><span class="line">  <span class="comment"># cache_url: &quot;https://webcache.googleusercontent.com/search?q=cache:&quot;</span></span><br><span class="line">  <span class="comment"># Default interface locale - leave blank to detect from browser information or</span></span><br><span class="line">  <span class="comment"># use codes from the &#x27;locales&#x27; config section</span></span><br><span class="line">  <span class="attr">default_locale:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># Open result links in a new tab by default</span></span><br><span class="line">  <span class="comment"># results_on_new_tab: false</span></span><br><span class="line">  <span class="attr">theme_args:</span></span><br><span class="line">    <span class="comment"># style of simple theme: auto, light, dark</span></span><br><span class="line">    <span class="attr">simple_style:</span> <span class="string">auto</span></span><br><span class="line">  <span class="comment"># Perform search immediately if a category selected.</span></span><br><span class="line">  <span class="comment"># Disable to select multiple categories at once and start the search manually.</span></span><br><span class="line">  <span class="attr">search_on_category_select:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Hotkeys: default or vim</span></span><br><span class="line">  <span class="attr">hotkeys:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Lock arbitrary settings on the preferences page.  To find the ID of the user</span></span><br><span class="line"><span class="comment"># setting you want to lock, check the ID of the form on the page &quot;preferences&quot;.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># preferences:</span></span><br><span class="line"><span class="comment">#   lock:</span></span><br><span class="line"><span class="comment">#     - language</span></span><br><span class="line"><span class="comment">#     - autocomplete</span></span><br><span class="line"><span class="comment">#     - method</span></span><br><span class="line"><span class="comment">#     - query_in_title</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># searx supports result proxification using an external service:</span></span><br><span class="line"><span class="comment"># https://github.com/asciimoo/morty uncomment below section if you have running</span></span><br><span class="line"><span class="comment"># morty proxy the key is base64 encoded (keep the !!binary notation)</span></span><br><span class="line"><span class="comment"># <span class="doctag">Note:</span> since commit af77ec3, morty accepts a base64 encoded key.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># result_proxy:</span></span><br><span class="line"><span class="comment">#   url: http://127.0.0.1:3000/</span></span><br><span class="line"><span class="comment">#   # the key is a base64 encoded string, the YAML !!binary prefix is optional</span></span><br><span class="line"><span class="comment">#   key: !!binary &quot;your_morty_proxy_key&quot;</span></span><br><span class="line"><span class="comment">#   # [true|false] enable the &quot;proxy&quot; button next to each result</span></span><br><span class="line"><span class="comment">#   proxify_results: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># communication with search engines</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">outgoing:</span></span><br><span class="line">  <span class="comment"># default timeout in seconds, can be override by engine</span></span><br><span class="line">  <span class="attr">request_timeout:</span> <span class="number">3.0</span></span><br><span class="line">  <span class="comment"># the maximum timeout in seconds</span></span><br><span class="line">  <span class="comment"># max_request_timeout: 10.0</span></span><br><span class="line">  <span class="comment"># suffix of searx_useragent, could contain information like an email address</span></span><br><span class="line">  <span class="comment"># to the administrator</span></span><br><span class="line">  <span class="attr">useragent_suffix:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># The maximum number of concurrent connections that may be established.</span></span><br><span class="line">  <span class="attr">pool_connections:</span> <span class="number">100</span></span><br><span class="line">  <span class="comment"># Allow the connection pool to maintain keep-alive connections below this</span></span><br><span class="line">  <span class="comment"># point.</span></span><br><span class="line">  <span class="attr">pool_maxsize:</span> <span class="number">20</span></span><br><span class="line">  <span class="comment"># See https://www.python-httpx.org/http2/</span></span><br><span class="line">  <span class="attr">enable_http2:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># uncomment below section if you want to use a custom server certificate</span></span><br><span class="line">  <span class="comment"># see https://www.python-httpx.org/advanced/#changing-the-verification-defaults</span></span><br><span class="line">  <span class="comment"># and https://www.python-httpx.org/compatibility/#ssl-configuration</span></span><br><span class="line">  <span class="comment">#  verify: ~/.mitmproxy/mitmproxy-ca-cert.cer</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># uncomment below section if you want to use a proxyq see: SOCKS proxies</span></span><br><span class="line">  <span class="comment">#   https://2.python-requests.org/en/latest/user/advanced/#proxies</span></span><br><span class="line">  <span class="comment"># are also supported: see</span></span><br><span class="line">  <span class="comment">#   https://2.python-requests.org/en/latest/user/advanced/#socks</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  proxies:</span></span><br><span class="line">  <span class="comment">#    all://:</span></span><br><span class="line">  <span class="comment">#      - http://proxy1:8080</span></span><br><span class="line">  <span class="comment">#      - http://proxy2:8080</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  using_tor_proxy: true</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Extra seconds to add in order to account for the time taken by the proxy</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  extra_proxy_timeout: 10</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># uncomment below section only if you have more than one network interface</span></span><br><span class="line">  <span class="comment"># which can be the source of outgoing search requests</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  source_ips:</span></span><br><span class="line">  <span class="comment">#    - 1.1.1.1</span></span><br><span class="line">  <span class="comment">#    - 1.1.1.2</span></span><br><span class="line">  <span class="comment">#    - fe80::/126</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># External plugin configuration, for more details see</span></span><br><span class="line"><span class="comment">#   https://docs.searxng.org/dev/plugins.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># plugins:</span></span><br><span class="line"><span class="comment">#   - plugin1</span></span><br><span class="line"><span class="comment">#   - plugin2</span></span><br><span class="line"><span class="comment">#   - ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Comment or un-comment plugin to activate / deactivate by default.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># enabled_plugins:</span></span><br><span class="line"><span class="comment">#   # these plugins are enabled if nothing is configured ..</span></span><br><span class="line"><span class="comment">#   - &#x27;Basic Calculator&#x27;</span></span><br><span class="line"><span class="comment">#   - &#x27;Hash plugin&#x27;</span></span><br><span class="line"><span class="comment">#   - &#x27;Self Information&#x27;</span></span><br><span class="line"><span class="comment">#   - &#x27;Tracker URL remover&#x27;</span></span><br><span class="line"><span class="comment">#   - &#x27;Ahmia blacklist&#x27;  # activation depends on outgoing.using_tor_proxy</span></span><br><span class="line"><span class="comment">#   # these plugins are disabled if nothing is configured ..</span></span><br><span class="line"><span class="comment">#   - &#x27;Hostnames plugin&#x27;  # see &#x27;hostnames&#x27; configuration below</span></span><br><span class="line"><span class="comment">#   - &#x27;Open Access DOI rewrite&#x27;</span></span><br><span class="line"><span class="comment">#   - &#x27;Tor check plugin&#x27;</span></span><br><span class="line"><span class="comment">#   # Read the docs before activate: auto-detection of the language could be</span></span><br><span class="line"><span class="comment">#   # detrimental to users expectations / users can activate the plugin in the</span></span><br><span class="line"><span class="comment">#   # preferences if they want.</span></span><br><span class="line"><span class="comment">#   - &#x27;Autodetect search language&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configuration of the &quot;Hostnames plugin&quot;:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># hostnames:</span></span><br><span class="line"><span class="comment">#   replace:</span></span><br><span class="line"><span class="comment">#     &#x27;(.*\.)?youtube\.com$&#x27;: &#x27;invidious.example.com&#x27;</span></span><br><span class="line"><span class="comment">#     &#x27;(.*\.)?youtu\.be$&#x27;: &#x27;invidious.example.com&#x27;</span></span><br><span class="line"><span class="comment">#     &#x27;(.*\.)?reddit\.com$&#x27;: &#x27;teddit.example.com&#x27;</span></span><br><span class="line"><span class="comment">#     &#x27;(.*\.)?redd\.it$&#x27;: &#x27;teddit.example.com&#x27;</span></span><br><span class="line"><span class="comment">#     &#x27;(www\.)?twitter\.com$&#x27;: &#x27;nitter.example.com&#x27;</span></span><br><span class="line"><span class="comment">#   remove:</span></span><br><span class="line"><span class="comment">#     - &#x27;(.*\.)?facebook.com$&#x27;</span></span><br><span class="line"><span class="comment">#   low_priority:</span></span><br><span class="line"><span class="comment">#     - &#x27;(.*\.)?google(\..*)?$&#x27;</span></span><br><span class="line"><span class="comment">#   high_priority:</span></span><br><span class="line"><span class="comment">#     - &#x27;(.*\.)?wikipedia.org$&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Alternatively you can use external files for configuring the &quot;Hostnames plugin&quot;:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># hostnames:</span></span><br><span class="line"><span class="comment">#  replace: &#x27;rewrite-hosts.yml&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Content of &#x27;rewrite-hosts.yml&#x27; (place the file in the same directory as &#x27;settings.yml&#x27;):</span></span><br><span class="line"><span class="comment"># &#x27;(.*\.)?youtube\.com$&#x27;: &#x27;invidious.example.com&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;(.*\.)?youtu\.be$&#x27;: &#x27;invidious.example.com&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="attr">checker:</span></span><br><span class="line">  <span class="comment"># disable checker when in debug mode</span></span><br><span class="line">  <span class="attr">off_when_debug:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># use &quot;scheduling: false&quot; to disable scheduling</span></span><br><span class="line">  <span class="comment"># scheduling: interval or int</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># to activate the scheduler:</span></span><br><span class="line">  <span class="comment"># * uncomment &quot;scheduling&quot; section</span></span><br><span class="line">  <span class="comment"># * add &quot;cache2 = name=searxngcache,items=2000,blocks=2000,blocksize=4096,bitmap=1&quot;</span></span><br><span class="line">  <span class="comment">#   to your uwsgi.ini</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># scheduling:</span></span><br><span class="line">  <span class="comment">#   start_after: [300, 1800]  # delay to start the first run of the checker</span></span><br><span class="line">  <span class="comment">#   every: [86400, 90000]     # how often the checker runs</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># additional tests: only for the YAML anchors (see the engines section)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="attr">additional_tests:</span></span><br><span class="line">    <span class="attr">rosebud:</span> <span class="meta">&amp;test_rosebud</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">query:</span> <span class="string">rosebud</span></span><br><span class="line">        <span class="attr">lang:</span> <span class="string">en</span></span><br><span class="line">      <span class="attr">result_container:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">not_empty</span></span><br><span class="line">        <span class="bullet">-</span> [<span class="string">&#x27;one_title_contains&#x27;</span>, <span class="string">&#x27;citizen kane&#x27;</span>]</span><br><span class="line">      <span class="attr">test:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">unique_results</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">android:</span> <span class="meta">&amp;test_android</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">query:</span> [<span class="string">&#x27;android&#x27;</span>]</span><br><span class="line">        <span class="attr">lang:</span> [<span class="string">&#x27;en&#x27;</span>, <span class="string">&#x27;de&#x27;</span>, <span class="string">&#x27;fr&#x27;</span>, <span class="string">&#x27;zh-CN&#x27;</span>]</span><br><span class="line">      <span class="attr">result_container:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">not_empty</span></span><br><span class="line">        <span class="bullet">-</span> [<span class="string">&#x27;one_title_contains&#x27;</span>, <span class="string">&#x27;google&#x27;</span>]</span><br><span class="line">      <span class="attr">test:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">unique_results</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># tests: only for the YAML anchors (see the engines section)</span></span><br><span class="line">  <span class="attr">tests:</span></span><br><span class="line">    <span class="attr">infobox:</span> <span class="meta">&amp;tests_infobox</span></span><br><span class="line">      <span class="attr">infobox:</span></span><br><span class="line">        <span class="attr">matrix:</span></span><br><span class="line">          <span class="attr">query:</span> [<span class="string">&quot;linux&quot;</span>, <span class="string">&quot;new york&quot;</span>, <span class="string">&quot;bbc&quot;</span>]</span><br><span class="line">        <span class="attr">result_container:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">has_infobox</span></span><br><span class="line"></span><br><span class="line"><span class="attr">categories_as_tabs:</span></span><br><span class="line">  <span class="attr">general:</span></span><br><span class="line">  <span class="attr">images:</span></span><br><span class="line">  <span class="attr">videos:</span></span><br><span class="line">  <span class="attr">news:</span></span><br><span class="line">  <span class="attr">map:</span></span><br><span class="line">  <span class="attr">music:</span></span><br><span class="line">  <span class="attr">it:</span></span><br><span class="line">  <span class="attr">science:</span></span><br><span class="line">  <span class="attr">files:</span></span><br><span class="line">  <span class="attr">social media:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">engines:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">9gag</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">9gag</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">9g</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine</span> <span class="string">linux</span> <span class="string">packages</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">alpinelinux</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">alp</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">annas</span> <span class="string">archive</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">annas_archive</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">aa</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: annas articles</span></span><br><span class="line">  <span class="comment">#   engine: annas_archive</span></span><br><span class="line">  <span class="comment">#   shortcut: aaa</span></span><br><span class="line">  <span class="comment">#   # https://docs.searxng.org/dev/engines/online/annas_archive.html</span></span><br><span class="line">  <span class="comment">#   aa_content: &#x27;magazine&#x27; # book_fiction, book_unknown, book_nonfiction, book_comic</span></span><br><span class="line">  <span class="comment">#   aa_ext: &#x27;pdf&#x27;  # pdf, epub, ..</span></span><br><span class="line">  <span class="comment">#   aa_sort: oldest&#x27;  # newest, oldest, largest, smallest</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apk</span> <span class="string">mirror</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">apkmirror</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">apkm</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apple</span> <span class="string">app</span> <span class="string">store</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">apple_app_store</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">aps</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Requires Tor</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ahmia</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">ahmia</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">onions</span></span><br><span class="line">    <span class="attr">enable_http:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ah</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">anaconda</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">first_page_num:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://anaconda.org/search?q=&#123;query&#125;&amp;page=&#123;pageno&#125;</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">//tbody/tr</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">./td/h5/a[last()]/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">./td/h5</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">./td[h5]/text()</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">it</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">6.0</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">conda</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">arch</span> <span class="string">linux</span> <span class="string">wiki</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">archlinux</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">al</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">artic</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">artic</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">arc</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">arxiv</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">arxiv</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">arx</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ask</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">ask</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ask</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># tmp suspended:  dh key too small</span></span><br><span class="line">  <span class="comment"># - name: base</span></span><br><span class="line">  <span class="comment">#   engine: base</span></span><br><span class="line">  <span class="comment">#   shortcut: bs</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bandcamp</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">bandcamp</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">bc</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">music</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikipedia</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">wikipedia</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wp</span></span><br><span class="line">    <span class="comment"># add &quot;list&quot; to the array to get results in the results list</span></span><br><span class="line">    <span class="attr">display_type:</span> [<span class="string">&quot;infobox&quot;</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&#x27;https://&#123;language&#125;.wikipedia.org/&#x27;</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bilibili</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">bilibili</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">bil</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bing</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">bing</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">bi</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bing</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">bing_images</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">bii</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bing</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">bing_news</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">bin</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bing</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">bing_videos</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">biv</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bitbucket</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://bitbucket.org/repo/all/&#123;pageno&#125;?name=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">//article[@class=&quot;repo-summary&quot;]//a[@class=&quot;repo-link&quot;]/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">//article[@class=&quot;repo-summary&quot;]//a[@class=&quot;repo-link&quot;]</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">//article[@class=&quot;repo-summary&quot;]/p</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">repos</span>]</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">bb</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://bitbucket.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q2493781</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://developer.atlassian.com/bitbucket</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bpb</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">bpb</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">bpb</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">btdigg</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">btdigg</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">bt</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">openverse</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">openverse</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">opv</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">media.ccc.de</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">ccc_media</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">c3tv</span></span><br><span class="line">    <span class="comment"># We don&#x27;t set language: de here because media.ccc.de is not just</span></span><br><span class="line">    <span class="comment"># for a German audience. It contains many English videos and many</span></span><br><span class="line">    <span class="comment"># German videos have English subtitles.</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">chefkoch</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">chefkoch</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">chef</span></span><br><span class="line">    <span class="comment"># to show premium or plus results too:</span></span><br><span class="line">    <span class="comment"># skip_premium: false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudflareai</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">cloudflareai</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">cfai</span></span><br><span class="line">    <span class="comment"># get api token and accont id from https://developers.cloudflare.com/workers-ai/get-started/rest-api/</span></span><br><span class="line">    <span class="attr">cf_account_id:</span> <span class="string">&#x27;your_cf_accout_id&#x27;</span></span><br><span class="line">    <span class="attr">cf_ai_api:</span> <span class="string">&#x27;your_cf_api&#x27;</span></span><br><span class="line">    <span class="comment"># create your ai gateway by https://developers.cloudflare.com/ai-gateway/get-started/creating-gateway/</span></span><br><span class="line">    <span class="attr">cf_ai_gateway:</span> <span class="string">&#x27;your_cf_ai_gateway_name&#x27;</span></span><br><span class="line">    <span class="comment"># find the model name from https://developers.cloudflare.com/workers-ai/models/#text-generation</span></span><br><span class="line">    <span class="attr">cf_ai_model:</span> <span class="string">&#x27;ai_model_name&#x27;</span></span><br><span class="line">    <span class="comment"># custom your preferences</span></span><br><span class="line">    <span class="comment"># cf_ai_model_display_name: &#x27;Cloudflare AI&#x27;</span></span><br><span class="line">    <span class="comment"># cf_ai_model_assistant: &#x27;prompts_for_assistant_role&#x27;</span></span><br><span class="line">    <span class="comment"># cf_ai_model_system: &#x27;prompts_for_system_role&#x27;</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: core.ac.uk</span></span><br><span class="line">  <span class="comment">#   engine: core</span></span><br><span class="line">  <span class="comment">#   categories: science</span></span><br><span class="line">  <span class="comment">#   shortcut: cor</span></span><br><span class="line">  <span class="comment">#   # get your API key from: https://core.ac.uk/api-keys/register/</span></span><br><span class="line">  <span class="comment">#   api_key: &#x27;unset&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cppreference</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">cppreference</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">cpp</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">crossref</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">crossref</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">cr</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">crowdview</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">json_engine</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">cv</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://crowdview-next-js.onrender.com/api/search-v3?query=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">results_query:</span> <span class="string">results</span></span><br><span class="line">    <span class="attr">url_query:</span> <span class="string">link</span></span><br><span class="line">    <span class="attr">title_query:</span> <span class="string">title</span></span><br><span class="line">    <span class="attr">content_query:</span> <span class="string">snippet</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://crowdview.ai/</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yep</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yep</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">yep</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yep</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yep</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">yepi</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yep</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yep</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">yepn</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">curlie</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">cl</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">lang_all:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://curlie.org/search?q=&#123;query&#125;&amp;lang=&#123;lang&#125;&amp;start=&#123;pageno&#125;&amp;stime=92452189</span></span><br><span class="line">    <span class="attr">page_size:</span> <span class="number">20</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">//div[@id=&quot;site-list-content&quot;]/div[@class=&quot;site-item&quot;]</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">./div[@class=&quot;title-and-desc&quot;]/a/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">./div[@class=&quot;title-and-desc&quot;]/a/div</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">./div[@class=&quot;title-and-desc&quot;]/div[@class=&quot;site-descr&quot;]</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://curlie.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q60715723</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">currency</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">currency_convert</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">cc</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deezer</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">deezer</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">dz</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">destatis</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">destatis</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">destat</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deviantart</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">deviantart</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">da</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ddg</span> <span class="string">definitions</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">duckduckgo_definitions</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ddd</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">tests:</span> <span class="meta">*tests_infobox</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># cloudflare protected</span></span><br><span class="line">  <span class="comment"># - name: digbt</span></span><br><span class="line">  <span class="comment">#   engine: digbt</span></span><br><span class="line">  <span class="comment">#   shortcut: dbt</span></span><br><span class="line">  <span class="comment">#   timeout: 6.0</span></span><br><span class="line">  <span class="comment">#   disabled: true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker</span> <span class="string">hub</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">docker_hub</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">dh</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">packages</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">encyclosearch</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">json_engine</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">es</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://encyclosearch.org/encyclosphere/search?q=&#123;query&#125;&amp;page=&#123;pageno&#125;&amp;resultsPerPage=15</span></span><br><span class="line">    <span class="attr">results_query:</span> <span class="string">Results</span></span><br><span class="line">    <span class="attr">url_query:</span> <span class="string">SourceURL</span></span><br><span class="line">    <span class="attr">title_query:</span> <span class="string">Title</span></span><br><span class="line">    <span class="attr">content_query:</span> <span class="string">Description</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://encyclosearch.org</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://encyclosearch.org/docs/#/rest-api</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">JSON</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">erowid</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">first_page_num:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">page_size:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://www.erowid.org/search.php?q=&#123;query&#125;&amp;s=&#123;pageno&#125;</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">//dl[@class=&quot;results-list&quot;]/dt[@class=&quot;result-title&quot;]/a/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">//dl[@class=&quot;results-list&quot;]/dt[@class=&quot;result-title&quot;]/a/text()</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">//dl[@class=&quot;results-list&quot;]/dd[@class=&quot;result-details&quot;]</span></span><br><span class="line">    <span class="attr">categories:</span> []</span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ew</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.erowid.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q1430691</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: elasticsearch</span></span><br><span class="line">  <span class="comment">#   shortcut: es</span></span><br><span class="line">  <span class="comment">#   engine: elasticsearch</span></span><br><span class="line">  <span class="comment">#   base_url: http://localhost:9200</span></span><br><span class="line">  <span class="comment">#   username: elastic</span></span><br><span class="line">  <span class="comment">#   password: changeme</span></span><br><span class="line">  <span class="comment">#   index: my-index</span></span><br><span class="line">  <span class="comment">#   # available options: match, simple_query_string, term, terms, custom</span></span><br><span class="line">  <span class="comment">#   query_type: match</span></span><br><span class="line">  <span class="comment">#   # if query_type is set to custom, provide your query here</span></span><br><span class="line">  <span class="comment">#   #custom_query_json: &#123;&quot;query&quot;:&#123;&quot;match_all&quot;: &#123;&#125;&#125;&#125;</span></span><br><span class="line">  <span class="comment">#   #show_metadata: false</span></span><br><span class="line">  <span class="comment">#   disabled: true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikidata</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">wikidata</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wd</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3.0</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment"># add &quot;list&quot; to the array to get results in the results list</span></span><br><span class="line">    <span class="attr">display_type:</span> [<span class="string">&quot;infobox&quot;</span>]</span><br><span class="line">    <span class="attr">tests:</span> <span class="meta">*tests_infobox</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">duckduckgo</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">duckduckgo</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ddg</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">duckduckgo</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">duckduckgo_extra</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">images</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">ddg_category:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ddi</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">duckduckgo</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">duckduckgo_extra</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">videos</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">ddg_category:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ddv</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">duckduckgo</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">duckduckgo_extra</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">news</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">ddg_category:</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ddn</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">duckduckgo</span> <span class="string">weather</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">duckduckgo_weather</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ddw</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apple</span> <span class="string">maps</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">apple_maps</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">apm</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emojipedia</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">emojipedia</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">em</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tineye</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">tineye</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">tin</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">9.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">etymonline</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://etymonline.com/search?page=&#123;pageno&#125;&amp;q=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">//a[contains(@class,</span> <span class="string">&quot;word__name--&quot;</span><span class="string">)]/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">//a[contains(@class,</span> <span class="string">&quot;word__name--&quot;</span><span class="string">)]</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">//section[contains(@class,</span> <span class="string">&quot;word__defination&quot;</span><span class="string">)]</span></span><br><span class="line">    <span class="attr">first_page_num:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">et</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">dictionaries</span>]</span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.etymonline.com/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q1188617</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: ebay</span></span><br><span class="line">  <span class="comment">#   engine: ebay</span></span><br><span class="line">  <span class="comment">#   shortcut: eb</span></span><br><span class="line">  <span class="comment">#   base_url: &#x27;https://www.ebay.com&#x27;</span></span><br><span class="line">  <span class="comment">#   disabled: true</span></span><br><span class="line">  <span class="comment">#   timeout: 5</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">1x</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">www1x</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">1x</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fdroid</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">fdroid</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">fd</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">findthatmeme</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">findthatmeme</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ftm</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flickr</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">fl</span></span><br><span class="line">    <span class="comment"># You can use the engine using the official stable API, but you need an API</span></span><br><span class="line">    <span class="comment"># key, see: https://www.flickr.com/services/apps/create/</span></span><br><span class="line">    <span class="comment"># engine: flickr</span></span><br><span class="line">    <span class="comment"># api_key: &#x27;apikey&#x27; # required!</span></span><br><span class="line">    <span class="comment"># Or you can use the html non-stable engine, activated by default</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">flickr_noapi</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">free</span> <span class="string">software</span> <span class="string">directory</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediawiki</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">fsd</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">software</span> <span class="string">wikis</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">https://directory.fsf.org/</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">title</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://directory.fsf.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q2470288</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: freesound</span></span><br><span class="line">  <span class="comment">#   engine: freesound</span></span><br><span class="line">  <span class="comment">#   shortcut: fnd</span></span><br><span class="line">  <span class="comment">#   disabled: true</span></span><br><span class="line">  <span class="comment">#   timeout: 15.0</span></span><br><span class="line">  <span class="comment"># API key required, see: https://freesound.org/docs/api/overview.html</span></span><br><span class="line">  <span class="comment">#   api_key: MyAPIkey</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">frinkiac</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">frinkiac</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">frk</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fyyd</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">fyyd</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">fy</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">8.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">geizhals</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">geizhals</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">geiz</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">genius</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">genius</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">gen</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gentoo</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediawiki</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ge</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">&quot;it&quot;</span>, <span class="string">&quot;software wikis&quot;</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&quot;https://wiki.gentoo.org/&quot;</span></span><br><span class="line">    <span class="attr">api_path:</span> <span class="string">&quot;api.php&quot;</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">text</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">https://gitlab.com</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">gl</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://gitlab.com/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q16639197</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: gnome</span></span><br><span class="line">  <span class="comment">#   engine: gitlab</span></span><br><span class="line">  <span class="comment">#   base_url: https://gitlab.gnome.org</span></span><br><span class="line">  <span class="comment">#   shortcut: gn</span></span><br><span class="line">  <span class="comment">#   about:</span></span><br><span class="line">  <span class="comment">#     website: https://gitlab.gnome.org</span></span><br><span class="line">  <span class="comment">#     wikidata_id: Q44316</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">github</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">github</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">gh</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">codeberg</span></span><br><span class="line">    <span class="comment"># https://docs.searxng.org/dev/engines/online/gitea.html</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">gitea</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">https://codeberg.org</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">cb</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitea.com</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">gitea</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">https://gitea.com</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">gitea</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">goodreads</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">goodreads</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">good</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">google</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">google</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">go</span></span><br><span class="line">    <span class="comment"># additional_tests:</span></span><br><span class="line">    <span class="comment">#   android: *test_android</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">google</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">google_images</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">goi</span></span><br><span class="line">    <span class="comment"># additional_tests:</span></span><br><span class="line">    <span class="comment">#   android: *test_android</span></span><br><span class="line">    <span class="comment">#   dali:</span></span><br><span class="line">    <span class="comment">#     matrix:</span></span><br><span class="line">    <span class="comment">#       query: [&#x27;Dali Christ&#x27;]</span></span><br><span class="line">    <span class="comment">#       lang: [&#x27;en&#x27;, &#x27;de&#x27;, &#x27;fr&#x27;, &#x27;zh-CN&#x27;]</span></span><br><span class="line">    <span class="comment">#     result_container:</span></span><br><span class="line">    <span class="comment">#       - [&#x27;one_title_contains&#x27;, &#x27;Salvador&#x27;]</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">google</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">google_news</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">gon</span></span><br><span class="line">    <span class="comment"># additional_tests:</span></span><br><span class="line">    <span class="comment">#   android: *test_android</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">google</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">google_videos</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">gov</span></span><br><span class="line">    <span class="comment"># additional_tests:</span></span><br><span class="line">    <span class="comment">#   android: *test_android</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">google</span> <span class="string">scholar</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">google_scholar</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">gos</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">google</span> <span class="string">play</span> <span class="string">apps</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">google_play</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">files</span>, <span class="string">apps</span>]</span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">gpa</span></span><br><span class="line">    <span class="attr">play_categ:</span> <span class="string">apps</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">google</span> <span class="string">play</span> <span class="string">movies</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">google_play</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">gpm</span></span><br><span class="line">    <span class="attr">play_categ:</span> <span class="string">movies</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">material</span> <span class="string">icons</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">material_icons</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mi</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">habrahabr</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://habr.com/en/search/page&#123;pageno&#125;/?q=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">//article[contains(@class,</span> <span class="string">&quot;tm-articles-list__item&quot;</span><span class="string">)]</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">.//a[@class=&quot;tm-title__link&quot;]/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">.//a[@class=&quot;tm-title__link&quot;]</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">.//div[contains(@class,</span> <span class="string">&quot;article-formatted-body&quot;</span><span class="string">)]</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">it</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">habr</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://habr.com/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q4494434</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://habr.com/en/docs/help/api/</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hackernews</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">hackernews</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">hn</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hex</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">hex</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">hex</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Valid values: name inserted_at updated_at total_downloads recent_downloads</span></span><br><span class="line">    <span class="attr">sort_criteria:</span> <span class="string">&quot;recent_downloads&quot;</span></span><br><span class="line">    <span class="attr">page_size:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">crates.io</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">crates</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">crates</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">6.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hoogle</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://hoogle.haskell.org/?hoogle=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">&#x27;//div[@class=&quot;result&quot;]&#x27;</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">&#x27;.//div[@class=&quot;ans&quot;]//a&#x27;</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">&#x27;.//div[@class=&quot;ans&quot;]//a/@href&#x27;</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">&#x27;.//div[@class=&quot;from&quot;]&#x27;</span></span><br><span class="line">    <span class="attr">page_size:</span> <span class="number">20</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">packages</span>]</span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ho</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://hoogle.haskell.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q34010</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://hackage.haskell.org/api</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">JSON</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">imdb</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">imdb</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">imdb</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">6.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">imgur</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">imgur</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">img</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ina</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">ina</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">in</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">6.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">invidious</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">invidious</span></span><br><span class="line">    <span class="comment"># Instanes will be selected randomly, see https://api.invidious.io/ for</span></span><br><span class="line">    <span class="comment"># instances that are stable (good uptime) and close to you.</span></span><br><span class="line">    <span class="attr">base_url:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://invidious.io.lol</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://invidious.fdn.fr</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://yt.artemislena.eu</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://invidious.tiekoetter.com</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://invidious.flokinet.to</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://vid.puffyan.us</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://invidious.privacydev.net</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://inv.tux.pizza</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">iv</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jisho</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">jisho</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">js</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kickass</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">kickass</span></span><br><span class="line">    <span class="attr">base_url:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://kickasstorrents.to</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://kickasstorrents.cr</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://kickasstorrent.cr</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://kickass.sx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://kat.am</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">kc</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lemmy</span> <span class="string">communities</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">lemmy</span></span><br><span class="line">    <span class="attr">lemmy_type:</span> <span class="string">Communities</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">leco</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lemmy</span> <span class="string">users</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">lemmy</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">lemmy</span> <span class="string">communities</span></span><br><span class="line">    <span class="attr">lemmy_type:</span> <span class="string">Users</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">leus</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lemmy</span> <span class="string">posts</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">lemmy</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">lemmy</span> <span class="string">communities</span></span><br><span class="line">    <span class="attr">lemmy_type:</span> <span class="string">Posts</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">lepo</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lemmy</span> <span class="string">comments</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">lemmy</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">lemmy</span> <span class="string">communities</span></span><br><span class="line">    <span class="attr">lemmy_type:</span> <span class="string">Comments</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">lecom</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">library</span> <span class="string">genesis</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="comment"># search_url: https://libgen.is/search.php?req=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://libgen.rs/search.php?req=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">//a[contains(@href,&quot;book/index.php?md5&quot;)]/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">//a[contains(@href,&quot;book/&quot;)]/text()[1]</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">//td/a[1][contains(@href,&quot;=author&quot;)]/text()</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">files</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">7.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">lg</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://libgen.fun/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q22017206</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">z-library</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">zlibrary</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">zlib</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">files</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">7.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">library</span> <span class="string">of</span> <span class="string">congress</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">loc</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">loc</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">images</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">libretranslate</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">libretranslate</span></span><br><span class="line">    <span class="comment"># https://github.com/LibreTranslate/LibreTranslate?tab=readme-ov-file#mirrors</span></span><br><span class="line">    <span class="attr">base_url:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://translate.terraprint.co</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://trans.zillyhuhn.com</span></span><br><span class="line">    <span class="comment"># api_key: abc123</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">lt</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lingva</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">lingva</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">lv</span></span><br><span class="line">    <span class="comment"># set lingva instance in url, by default it will use the official instance</span></span><br><span class="line">    <span class="comment"># url: https://lingva.thedaviddelta.com</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lobste.rs</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://lobste.rs/search?q=&#123;query&#125;&amp;what=stories&amp;order=relevance</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">//li[contains(@class,</span> <span class="string">&quot;story&quot;</span><span class="string">)]</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">.//a[@class=&quot;u-url&quot;]/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">.//a[@class=&quot;u-url&quot;]</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">.//a[@class=&quot;domain&quot;]</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">it</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">lo</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://lobste.rs/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q60762874</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mastodon</span> <span class="string">users</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mastodon</span></span><br><span class="line">    <span class="attr">mastodon_type:</span> <span class="string">accounts</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">https://mastodon.social</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mau</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mastodon</span> <span class="string">hashtags</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mastodon</span></span><br><span class="line">    <span class="attr">mastodon_type:</span> <span class="string">hashtags</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">https://mastodon.social</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mah</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: matrixrooms</span></span><br><span class="line">  <span class="comment">#   engine: mrs</span></span><br><span class="line">  <span class="comment">#   # https://docs.searxng.org/dev/engines/online/mrs.html</span></span><br><span class="line">  <span class="comment">#   # base_url: https://mrs-api-host</span></span><br><span class="line">  <span class="comment">#   shortcut: mtrx</span></span><br><span class="line">  <span class="comment">#   disabled: true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mdn</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mdn</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">json_engine</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>]</span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://developer.mozilla.org/api/v1/search?q=&#123;query&#125;&amp;page=&#123;pageno&#125;</span></span><br><span class="line">    <span class="attr">results_query:</span> <span class="string">documents</span></span><br><span class="line">    <span class="attr">url_query:</span> <span class="string">mdn_url</span></span><br><span class="line">    <span class="attr">url_prefix:</span> <span class="string">https://developer.mozilla.org</span></span><br><span class="line">    <span class="attr">title_query:</span> <span class="string">title</span></span><br><span class="line">    <span class="attr">content_query:</span> <span class="string">summary</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://developer.mozilla.org</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q3273508</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">JSON</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metacpan</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">metacpan</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">cpan</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">number_of_results:</span> <span class="number">20</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: meilisearch</span></span><br><span class="line">  <span class="comment">#   engine: meilisearch</span></span><br><span class="line">  <span class="comment">#   shortcut: mes</span></span><br><span class="line">  <span class="comment">#   enable_http: true</span></span><br><span class="line">  <span class="comment">#   base_url: http://localhost:7700</span></span><br><span class="line">  <span class="comment">#   index: my-index</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mixcloud</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mixcloud</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mc</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># MongoDB engine</span></span><br><span class="line">  <span class="comment"># Required dependency: pymongo</span></span><br><span class="line">  <span class="comment"># - name: mymongo</span></span><br><span class="line">  <span class="comment">#   engine: mongodb</span></span><br><span class="line">  <span class="comment">#   shortcut: md</span></span><br><span class="line">  <span class="comment">#   exact_match_only: false</span></span><br><span class="line">  <span class="comment">#   host: &#x27;127.0.0.1&#x27;</span></span><br><span class="line">  <span class="comment">#   port: 27017</span></span><br><span class="line">  <span class="comment">#   enable_http: true</span></span><br><span class="line">  <span class="comment">#   results_per_page: 20</span></span><br><span class="line">  <span class="comment">#   database: &#x27;business&#x27;</span></span><br><span class="line">  <span class="comment">#   collection: &#x27;reviews&#x27;  # name of the db collection</span></span><br><span class="line">  <span class="comment">#   key: &#x27;name&#x27;  # key in the collection to search for</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mozhi</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mozhi</span></span><br><span class="line">    <span class="attr">base_url:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://mozhi.aryak.me</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://translate.bus-hit.me</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://nyc1.mz.ggtyler.dev</span></span><br><span class="line">    <span class="comment"># mozhi_engine: google - see https://mozhi.aryak.me for supported engines</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mz</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mwmbl</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mwmbl</span></span><br><span class="line">    <span class="comment"># api_url: https://api.mwmbl.org</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mwm</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">npm</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">npm</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">npm</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nyaa</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">nyaa</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">nt</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mankier</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">json_engine</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://www.mankier.com/api/v2/mans/?q=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">results_query:</span> <span class="string">results</span></span><br><span class="line">    <span class="attr">url_query:</span> <span class="string">url</span></span><br><span class="line">    <span class="attr">title_query:</span> <span class="string">name</span></span><br><span class="line">    <span class="attr">content_query:</span> <span class="string">description</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">it</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">man</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.mankier.com/</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://www.mankier.com/api</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">JSON</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># read https://docs.searxng.org/dev/engines/online/mullvad_leta.html</span></span><br><span class="line">  <span class="comment"># - name: mullvadleta</span></span><br><span class="line">  <span class="comment">#   engine: mullvad_leta</span></span><br><span class="line">  <span class="comment">#   leta_engine: google # choose one of the following: google, brave</span></span><br><span class="line">  <span class="comment">#   use_cache: true  # Only 100 non-cache searches per day, suggested only for private instances</span></span><br><span class="line">  <span class="comment">#   search_url: https://leta.mullvad.net</span></span><br><span class="line">  <span class="comment">#   categories: [general, web]</span></span><br><span class="line">  <span class="comment">#   shortcut: ml</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">odysee</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">odysee</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">od</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">openairedatasets</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">json_engine</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://api.openaire.eu/search/datasets?format=json&amp;page=&#123;pageno&#125;&amp;size=10&amp;title=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">results_query:</span> <span class="string">response/results/result</span></span><br><span class="line">    <span class="attr">url_query:</span> <span class="string">metadata/oaf:entity/oaf:result/children/instance/webresource/url/$</span></span><br><span class="line">    <span class="attr">title_query:</span> <span class="string">metadata/oaf:entity/oaf:result/title/$</span></span><br><span class="line">    <span class="attr">content_query:</span> <span class="string">metadata/oaf:entity/oaf:result/description/$</span></span><br><span class="line">    <span class="attr">content_html_to_text:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">&quot;science&quot;</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">oad</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.openaire.eu/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q25106053</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://api.openaire.eu/</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">JSON</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">openairepublications</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">json_engine</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://api.openaire.eu/search/publications?format=json&amp;page=&#123;pageno&#125;&amp;size=10&amp;title=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">results_query:</span> <span class="string">response/results/result</span></span><br><span class="line">    <span class="attr">url_query:</span> <span class="string">metadata/oaf:entity/oaf:result/children/instance/webresource/url/$</span></span><br><span class="line">    <span class="attr">title_query:</span> <span class="string">metadata/oaf:entity/oaf:result/title/$</span></span><br><span class="line">    <span class="attr">content_query:</span> <span class="string">metadata/oaf:entity/oaf:result/description/$</span></span><br><span class="line">    <span class="attr">content_html_to_text:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">science</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">oap</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.openaire.eu/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q25106053</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://api.openaire.eu/</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">JSON</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">openmeteo</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">open_meteo</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">om</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: opensemanticsearch</span></span><br><span class="line">  <span class="comment">#   engine: opensemantic</span></span><br><span class="line">  <span class="comment">#   shortcut: oss</span></span><br><span class="line">  <span class="comment">#   base_url: &#x27;http://localhost:8983/solr/opensemanticsearch/&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">openstreetmap</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">openstreetmap</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">osm</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">openrepos</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://openrepos.net/search/node/&#123;query&#125;?page=&#123;pageno&#125;</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">//li[@class=&quot;search-result&quot;]//h3[@class=&quot;title&quot;]/a/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">//li[@class=&quot;search-result&quot;]//h3[@class=&quot;title&quot;]/a</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">//li[@class=&quot;search-result&quot;]//div[@class=&quot;search-snippet-info&quot;]//p[@class=&quot;search-snippet&quot;]</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">files</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">or</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://openrepos.net/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">packagist</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">json_engine</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://packagist.org/search.json?q=&#123;query&#125;&amp;page=&#123;pageno&#125;</span></span><br><span class="line">    <span class="attr">results_query:</span> <span class="string">results</span></span><br><span class="line">    <span class="attr">url_query:</span> <span class="string">url</span></span><br><span class="line">    <span class="attr">title_query:</span> <span class="string">name</span></span><br><span class="line">    <span class="attr">content_query:</span> <span class="string">description</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">packages</span>]</span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">pack</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://packagist.org</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q108311377</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://packagist.org/apidoc</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">JSON</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pdbe</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">pdbe</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">pdb</span></span><br><span class="line">    <span class="comment"># Hide obsolete PDB entries.  Default is not to hide obsolete structures</span></span><br><span class="line">    <span class="comment">#  hide_obsolete: false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">photon</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">photon</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ph</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pinterest</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">pinterest</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">pin</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">piped</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">piped</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ppd</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">piped_filter:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># URL to use as link and for embeds</span></span><br><span class="line">    <span class="attr">frontend_url:</span> <span class="string">https://srv.piped.video</span></span><br><span class="line">    <span class="comment"># Instance will be selected randomly, for more see https://piped-instances.kavin.rocks/</span></span><br><span class="line">    <span class="attr">backend_url:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://pipedapi.kavin.rocks</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://pipedapi-libre.kavin.rocks</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://pipedapi.adminforge.de</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">piped.music</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">piped</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">piped</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ppdm</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">music</span></span><br><span class="line">    <span class="attr">piped_filter:</span> <span class="string">music_songs</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">piratebay</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">piratebay</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">tpb</span></span><br><span class="line">    <span class="comment"># You may need to change this URL to a proxy if piratebay is blocked in your</span></span><br><span class="line">    <span class="comment"># country</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://thepiratebay.org/</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pixiv</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">pv</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">pixiv</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">inactive:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">pixiv_image_proxies:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://pximg.example.org</span></span><br><span class="line">      <span class="comment"># A proxy is required to load the images. Hosting an image proxy server</span></span><br><span class="line">      <span class="comment"># for Pixiv:</span></span><br><span class="line">      <span class="comment">#    --&gt; https://pixivfe.pages.dev/hosting-image-proxy-server/</span></span><br><span class="line">      <span class="comment"># Proxies from public instances.  Ask the public instances owners if they</span></span><br><span class="line">      <span class="comment"># agree to receive traffic from SearXNG!</span></span><br><span class="line">      <span class="comment">#    --&gt; https://codeberg.org/VnPower/PixivFE#instances</span></span><br><span class="line">      <span class="comment">#    --&gt; https://github.com/searxng/searxng/pull/3192#issuecomment-1941095047</span></span><br><span class="line">      <span class="comment"># image proxy of https://pixiv.cat</span></span><br><span class="line">      <span class="comment"># - https://i.pixiv.cat</span></span><br><span class="line">      <span class="comment"># image proxy of https://www.pixiv.pics</span></span><br><span class="line">      <span class="comment"># - https://pximg.cocomi.eu.org</span></span><br><span class="line">      <span class="comment"># image proxy of https://pixivfe.exozy.me</span></span><br><span class="line">      <span class="comment"># - https://pximg.exozy.me</span></span><br><span class="line">      <span class="comment"># image proxy of https://pixivfe.ducks.party</span></span><br><span class="line">      <span class="comment"># - https://pixiv.ducks.party</span></span><br><span class="line">      <span class="comment"># image proxy of https://pixiv.perennialte.ch</span></span><br><span class="line">      <span class="comment"># - https://pximg.perennialte.ch</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">podcastindex</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">podcastindex</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">podcast</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Required dependency: psychopg2</span></span><br><span class="line">  <span class="comment">#  - name: postgresql</span></span><br><span class="line">  <span class="comment">#    engine: postgresql</span></span><br><span class="line">  <span class="comment">#    database: postgres</span></span><br><span class="line">  <span class="comment">#    username: postgres</span></span><br><span class="line">  <span class="comment">#    password: postgres</span></span><br><span class="line">  <span class="comment">#    limit: 10</span></span><br><span class="line">  <span class="comment">#    query_str: &#x27;SELECT * from my_table WHERE my_column = %(query)s&#x27;</span></span><br><span class="line">  <span class="comment">#    shortcut : psql</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">presearch</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">presearch</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">search</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ps</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">presearch</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">presearch</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">presearch</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">images</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">psimg</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">presearch</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">presearch</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">presearch</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">psvid</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">presearch</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">presearch</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">presearch</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">news</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">psnews</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pub.dev</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">pd</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://pub.dev/packages?q=&#123;query&#125;&amp;page=&#123;pageno&#125;</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">//div[contains(@class,&quot;packages-item&quot;)]</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">./div/h3/a/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">./div/h3/a</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">./div/div/div[contains(@class,&quot;packages-description&quot;)]/span</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">packages</span>, <span class="string">it</span>]</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">first_page_num:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://pub.dev/</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://pub.dev/help/api</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pubmed</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">pubmed</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">pub</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pypi</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">pypi</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">pypi</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qwant</span></span><br><span class="line">    <span class="attr">qwant_categ:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">qwant</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">qw</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">additional_tests:</span></span><br><span class="line">      <span class="attr">rosebud:</span> <span class="meta">*test_rosebud</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qwant</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">qwant_categ:</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">qwant</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">qwn</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">qwant</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qwant</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">qwant_categ:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">qwant</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">qwi</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">images</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">network:</span> <span class="string">qwant</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qwant</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">qwant_categ:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">qwant</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">qwv</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">videos</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">network:</span> <span class="string">qwant</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: library</span></span><br><span class="line">  <span class="comment">#   engine: recoll</span></span><br><span class="line">  <span class="comment">#   shortcut: lib</span></span><br><span class="line">  <span class="comment">#   base_url: &#x27;https://recoll.example.org/&#x27;</span></span><br><span class="line">  <span class="comment">#   search_dir: &#x27;&#x27;</span></span><br><span class="line">  <span class="comment">#   mount_prefix: /export</span></span><br><span class="line">  <span class="comment">#   dl_prefix: &#x27;https://download.example.org&#x27;</span></span><br><span class="line">  <span class="comment">#   timeout: 30.0</span></span><br><span class="line">  <span class="comment">#   categories: files</span></span><br><span class="line">  <span class="comment">#   disabled: true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: recoll library reference</span></span><br><span class="line">  <span class="comment">#   engine: recoll</span></span><br><span class="line">  <span class="comment">#   base_url: &#x27;https://recoll.example.org/&#x27;</span></span><br><span class="line">  <span class="comment">#   search_dir: reference</span></span><br><span class="line">  <span class="comment">#   mount_prefix: /export</span></span><br><span class="line">  <span class="comment">#   dl_prefix: &#x27;https://download.example.org&#x27;</span></span><br><span class="line">  <span class="comment">#   shortcut: libr</span></span><br><span class="line">  <span class="comment">#   timeout: 30.0</span></span><br><span class="line">  <span class="comment">#   categories: files</span></span><br><span class="line">  <span class="comment">#   disabled: true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">radio</span> <span class="string">browser</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">radio_browser</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">rb</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">reddit</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">reddit</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">re</span></span><br><span class="line">    <span class="attr">page_size:</span> <span class="number">25</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">right</span> <span class="string">dao</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">page_size:</span> <span class="number">12</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://rightdao.com/search?q=&#123;query&#125;&amp;start=&#123;pageno&#125;</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">//div[contains(@class,</span> <span class="string">&quot;description&quot;</span><span class="string">)]</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">../div[contains(@class,</span> <span class="string">&quot;title&quot;</span><span class="string">)]/a/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">../div[contains(@class,</span> <span class="string">&quot;title&quot;</span><span class="string">)]</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">rd</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://rightdao.com/</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rottentomatoes</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">rottentomatoes</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">rt</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Required dependency: redis</span></span><br><span class="line">  <span class="comment"># - name: myredis</span></span><br><span class="line">  <span class="comment">#   shortcut : rds</span></span><br><span class="line">  <span class="comment">#   engine: redis_server</span></span><br><span class="line">  <span class="comment">#   exact_match_only: false</span></span><br><span class="line">  <span class="comment">#   host: &#x27;127.0.0.1&#x27;</span></span><br><span class="line">  <span class="comment">#   port: 6379</span></span><br><span class="line">  <span class="comment">#   enable_http: true</span></span><br><span class="line">  <span class="comment">#   password: &#x27;&#x27;</span></span><br><span class="line">  <span class="comment">#   db: 0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># tmp suspended: bad certificate</span></span><br><span class="line">  <span class="comment">#  - name: scanr structures</span></span><br><span class="line">  <span class="comment">#    shortcut: scs</span></span><br><span class="line">  <span class="comment">#    engine: scanr_structures</span></span><br><span class="line">  <span class="comment">#    disabled: true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">searchmysite</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">sms</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://searchmysite.net/search/?q=&#123;query&#125;&amp;page=&#123;pageno&#125;</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">//div[contains(@class,&#x27;search-result&#x27;)]</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">.//a[contains(@class,&#x27;result-link&#x27;)]/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">.//span[contains(@class,&#x27;result-title-txt&#x27;)]/text()</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">./p[@id=&#x27;result-hightlight&#x27;]</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://searchmysite.net</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sepiasearch</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">sepiasearch</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">sep</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">soundcloud</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">soundcloud</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">sc</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">stackoverflow</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">stackexchange</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">st</span></span><br><span class="line">    <span class="attr">api_site:</span> <span class="string">&#x27;stackoverflow&#x27;</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">q&amp;a</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">askubuntu</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">stackexchange</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ubuntu</span></span><br><span class="line">    <span class="attr">api_site:</span> <span class="string">&#x27;askubuntu&#x27;</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">q&amp;a</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">internetarchivescholar</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">internet_archive_scholar</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ias</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">15.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">superuser</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">stackexchange</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">su</span></span><br><span class="line">    <span class="attr">api_site:</span> <span class="string">&#x27;superuser&#x27;</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">q&amp;a</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">discuss.python</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">discourse</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">dpy</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&#x27;https://discuss.python.org&#x27;</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">q&amp;a</span>]</span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">caddy.community</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">discourse</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">caddy</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&#x27;https://caddy.community&#x27;</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">q&amp;a</span>]</span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pi-hole.community</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">discourse</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">pi</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">q&amp;a</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&#x27;https://discourse.pi-hole.net&#x27;</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">searchcode</span> <span class="string">code</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">searchcode_code</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">scc</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: searx</span></span><br><span class="line">  <span class="comment">#   engine: searx_engine</span></span><br><span class="line">  <span class="comment">#   shortcut: se</span></span><br><span class="line">  <span class="comment">#   instance_urls :</span></span><br><span class="line">  <span class="comment">#       - http://127.0.0.1:8888/</span></span><br><span class="line">  <span class="comment">#       - ...</span></span><br><span class="line">  <span class="comment">#   disabled: true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">semantic</span> <span class="string">scholar</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">semantic_scholar</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">se</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Spotify needs API credentials</span></span><br><span class="line">  <span class="comment"># - name: spotify</span></span><br><span class="line">  <span class="comment">#   engine: spotify</span></span><br><span class="line">  <span class="comment">#   shortcut: stf</span></span><br><span class="line">  <span class="comment">#   api_client_id: *******</span></span><br><span class="line">  <span class="comment">#   api_client_secret: *******</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: solr</span></span><br><span class="line">  <span class="comment">#   engine: solr</span></span><br><span class="line">  <span class="comment">#   shortcut: slr</span></span><br><span class="line">  <span class="comment">#   base_url: http://localhost:8983</span></span><br><span class="line">  <span class="comment">#   collection: collection_name</span></span><br><span class="line">  <span class="comment">#   sort: &#x27;&#x27; # sorting: asc or desc</span></span><br><span class="line">  <span class="comment">#   field_list: &#x27;&#x27; # comma separated list of field names to display on the UI</span></span><br><span class="line">  <span class="comment">#   default_fields: &#x27;&#x27; # default field to query</span></span><br><span class="line">  <span class="comment">#   query_fields: &#x27;&#x27; # query fields</span></span><br><span class="line">  <span class="comment">#   enable_http: true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: springer nature</span></span><br><span class="line">  <span class="comment">#   engine: springer</span></span><br><span class="line">  <span class="comment">#   # get your API key from: https://dev.springernature.com/signup</span></span><br><span class="line">  <span class="comment">#   # working API key, for test &amp; de<span class="doctag">bug:</span> &quot;a69685087d07eca9f13db62f65b8f601&quot;</span></span><br><span class="line">  <span class="comment">#   api_key: &#x27;unset&#x27;</span></span><br><span class="line">  <span class="comment">#   shortcut: springer</span></span><br><span class="line">  <span class="comment">#   timeout: 15.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">startpage</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">startpage</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">sp</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">6.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">additional_tests:</span></span><br><span class="line">      <span class="attr">rosebud:</span> <span class="meta">*test_rosebud</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tokyotoshokan</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">tokyotoshokan</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">tt</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">6.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">solidtorrents</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">solidtorrents</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">solid</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">base_url:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://solidtorrents.to</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://bitsearch.to</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># For this demo of the sqlite engine download:</span></span><br><span class="line">  <span class="comment">#   https://liste.mediathekview.de/filmliste-v2.db.bz2</span></span><br><span class="line">  <span class="comment"># and unpack into searx/data/filmliste-v2.db</span></span><br><span class="line">  <span class="comment"># Query to test: &quot;!demo concert&quot;</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># - name: demo</span></span><br><span class="line">  <span class="comment">#   engine: sqlite</span></span><br><span class="line">  <span class="comment">#   shortcut: demo</span></span><br><span class="line">  <span class="comment">#   categories: general</span></span><br><span class="line">  <span class="comment">#   result_template: default.html</span></span><br><span class="line">  <span class="comment">#   database: searx/data/filmliste-v2.db</span></span><br><span class="line">  <span class="comment">#   query_str:  &gt;-</span></span><br><span class="line">  <span class="comment">#     SELECT title || &#x27; (&#x27; || time(duration, &#x27;unixepoch&#x27;) || &#x27;)&#x27; AS title,</span></span><br><span class="line">  <span class="comment">#            COALESCE( NULLIF(url_video_hd,&#x27;&#x27;), NULLIF(url_video_sd,&#x27;&#x27;), url_video) AS url,</span></span><br><span class="line">  <span class="comment">#            description AS content</span></span><br><span class="line">  <span class="comment">#       FROM film</span></span><br><span class="line">  <span class="comment">#      WHERE title LIKE :wildcard OR description LIKE :wildcard</span></span><br><span class="line">  <span class="comment">#      ORDER BY duration DESC</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tagesschau</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">tagesschau</span></span><br><span class="line">    <span class="comment"># when set to false, display URLs from Tagesschau, and not the actual source</span></span><br><span class="line">    <span class="comment"># (e.g. NDR, WDR, SWR, HR, ...)</span></span><br><span class="line">    <span class="attr">use_source_url:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ts</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmdb</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">movies</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://www.themoviedb.org/search?page=&#123;pageno&#125;&amp;query=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">//div[contains(@class,&quot;movie&quot;)</span> <span class="string">or</span> <span class="string">contains(@class,&quot;tv&quot;)]//div[contains(@class,&quot;card&quot;)]</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">.//div[contains(@class,&quot;poster&quot;)]/a/@href</span></span><br><span class="line">    <span class="attr">thumbnail_xpath:</span> <span class="string">.//img/@src</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">.//div[contains(@class,&quot;title&quot;)]//h2</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">.//div[contains(@class,&quot;overview&quot;)]</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">tm</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Requires Tor</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">torch</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span></span><br><span class="line">      <span class="string">http://xmh57jrknzkhv6y3ls3ubitzfqnkrwxhopf5aygthi7d6rplyvk3noyd.onion/cgi-bin/omega/omega?P=&#123;query&#125;&amp;DEFAULTOP=and</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">//table//tr</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">./td[2]/a</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">./td[2]/b</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">./td[2]/small</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">onions</span></span><br><span class="line">    <span class="attr">enable_http:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">tch</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># torznab engine lets you query any torznab compatible indexer.  Using this</span></span><br><span class="line">  <span class="comment"># engine in combination with Jackett opens the possibility to query a lot of</span></span><br><span class="line">  <span class="comment"># public and private indexers directly from SearXNG. More details at:</span></span><br><span class="line">  <span class="comment"># https://docs.searxng.org/dev/engines/online/torznab.html</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># - name: Torznab EZTV</span></span><br><span class="line">  <span class="comment">#   engine: torznab</span></span><br><span class="line">  <span class="comment">#   shortcut: eztv</span></span><br><span class="line">  <span class="comment">#   base_url: http://localhost:9117/api/v2.0/indexers/eztv/results/torznab</span></span><br><span class="line">  <span class="comment">#   enable_http: true  # if using localhost</span></span><br><span class="line">  <span class="comment">#   api_key: xxxxxxxxxxxxxxx</span></span><br><span class="line">  <span class="comment">#   show_magnet_links: true</span></span><br><span class="line">  <span class="comment">#   show_torrent_files: false</span></span><br><span class="line">  <span class="comment">#   # https://github.com/Jackett/Jackett/wiki/Jackett-Categories</span></span><br><span class="line">  <span class="comment">#   torznab_categories:  # optional</span></span><br><span class="line">  <span class="comment">#     - 2000</span></span><br><span class="line">  <span class="comment">#     - 5000</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># tmp suspended - too slow, too many errors</span></span><br><span class="line">  <span class="comment">#  - name: urbandictionary</span></span><br><span class="line">  <span class="comment">#    engine      : xpath</span></span><br><span class="line">  <span class="comment">#    search_url  : https://www.urbandictionary.com/define.php?term=&#123;query&#125;</span></span><br><span class="line">  <span class="comment">#    url_xpath   : //*[@class=&quot;word&quot;]/@href</span></span><br><span class="line">  <span class="comment">#    title_xpath : //*[@class=&quot;def-header&quot;]</span></span><br><span class="line">  <span class="comment">#    content_xpath: //*[@class=&quot;meaning&quot;]</span></span><br><span class="line">  <span class="comment">#    shortcut: ud</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">unsplash</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">unsplash</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">us</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yandex</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yandex</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">yd</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">inactive:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yandex</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yandex</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ydi</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">inactive:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yandex</span> <span class="string">music</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yandex_music</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ydm</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># https://yandex.com/support/music/access.html</span></span><br><span class="line">    <span class="attr">inactive:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yahoo</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yahoo</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">yh</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yahoo</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yahoo_news</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">yhn</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">youtube</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">yt</span></span><br><span class="line">    <span class="comment"># You can use the engine using the official stable API, but you need an API</span></span><br><span class="line">    <span class="comment"># key See: https://console.developers.google.com/project</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># engine: youtube_api</span></span><br><span class="line">    <span class="comment"># api_key: &#x27;apikey&#x27; # required!</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Or you can use the html non-stable engine, activated by default</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">youtube_noapi</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dailymotion</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">dailymotion</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">dm</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vimeo</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">vimeo</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">vm</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wiby</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">json_engine</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://wiby.me/json/?q=&#123;query&#125;&amp;p=&#123;pageno&#125;</span></span><br><span class="line">    <span class="attr">url_query:</span> <span class="string">URL</span></span><br><span class="line">    <span class="attr">title_query:</span> <span class="string">Title</span></span><br><span class="line">    <span class="attr">content_query:</span> <span class="string">Snippet</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wib</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://wiby.me/</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikibooks</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediawiki</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">0.5</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wb</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">wikimedia</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&quot;https://&#123;language&#125;.wikibooks.org/&quot;</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">text</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.wikibooks.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q367</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikinews</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediawiki</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wn</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">news</span>, <span class="string">wikimedia</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&quot;https://&#123;language&#125;.wikinews.org/&quot;</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">text</span></span><br><span class="line">    <span class="attr">srsort:</span> <span class="string">create_timestamp_desc</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.wikinews.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q964</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikiquote</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediawiki</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">0.5</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wq</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">wikimedia</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&quot;https://&#123;language&#125;.wikiquote.org/&quot;</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">text</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">additional_tests:</span></span><br><span class="line">      <span class="attr">rosebud:</span> <span class="meta">*test_rosebud</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.wikiquote.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q369</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikisource</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediawiki</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">0.5</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ws</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">wikimedia</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&quot;https://&#123;language&#125;.wikisource.org/&quot;</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">text</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.wikisource.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q263</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikispecies</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediawiki</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wsp</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">science</span>, <span class="string">wikimedia</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&quot;https://species.wikimedia.org/&quot;</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">text</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://species.wikimedia.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q13679</span></span><br><span class="line">    <span class="attr">tests:</span></span><br><span class="line">      <span class="attr">wikispecies:</span></span><br><span class="line">        <span class="attr">matrix:</span></span><br><span class="line">          <span class="attr">query:</span> <span class="string">&quot;Campbell, L.I. et al. 2011: MicroRNAs&quot;</span></span><br><span class="line">          <span class="attr">lang:</span> <span class="string">en</span></span><br><span class="line">        <span class="attr">result_container:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">not_empty</span></span><br><span class="line">          <span class="bullet">-</span> [<span class="string">&#x27;one_title_contains&#x27;</span>, <span class="string">&#x27;Tardigrada&#x27;</span>]</span><br><span class="line">        <span class="attr">test:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">unique_results</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wiktionary</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediawiki</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wt</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">dictionaries</span>, <span class="string">wikimedia</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&quot;https://&#123;language&#125;.wiktionary.org/&quot;</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">text</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.wiktionary.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q151</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikiversity</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediawiki</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">0.5</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wv</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">wikimedia</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&quot;https://&#123;language&#125;.wikiversity.org/&quot;</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">text</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.wikiversity.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q370</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikivoyage</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediawiki</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">0.5</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wy</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">wikimedia</span>]</span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">&quot;https://&#123;language&#125;.wikivoyage.org/&quot;</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">text</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.wikivoyage.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q373</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikicommons.images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">wikicommons</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wc</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">number_of_results:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikicommons.videos</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">wikicommons</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wcv</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">number_of_results:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikicommons.audio</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">wikicommons</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wca</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">music</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">audio</span></span><br><span class="line">    <span class="attr">number_of_results:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikicommons.files</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">wikicommons</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wcf</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">files</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">files</span></span><br><span class="line">    <span class="attr">number_of_results:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wolframalpha</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wa</span></span><br><span class="line">    <span class="comment"># You can use the engine using the official stable API, but you need an API</span></span><br><span class="line">    <span class="comment"># key.  See: https://products.wolframalpha.com/api/</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># engine: wolframalpha_api</span></span><br><span class="line">    <span class="comment"># api_key: &#x27;&#x27;</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Or you can use the html non-stable engine, activated by default</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">wolframalpha_noapi</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">6.0</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dictzone</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">dictzone</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">dc</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mymemory</span> <span class="string">translated</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">translated</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">tl</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line">    <span class="comment"># You can use without an API key, but you are limited to 1000 words/day</span></span><br><span class="line">    <span class="comment"># See: https://mymemory.translated.net/doc/usagelimits.php</span></span><br><span class="line">    <span class="comment"># api_key: &#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Required dependency: mysql-connector-python</span></span><br><span class="line">  <span class="comment">#  - name: mysql</span></span><br><span class="line">  <span class="comment">#    engine: mysql_server</span></span><br><span class="line">  <span class="comment">#    database: mydatabase</span></span><br><span class="line">  <span class="comment">#    username: user</span></span><br><span class="line">  <span class="comment">#    password: pass</span></span><br><span class="line">  <span class="comment">#    limit: 10</span></span><br><span class="line">  <span class="comment">#    query_str: &#x27;SELECT * from mytable WHERE fieldname=%(query)s&#x27;</span></span><br><span class="line">  <span class="comment">#    shortcut: mysql</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Required dependency: mariadb</span></span><br><span class="line">  <span class="comment">#  - name: mariadb</span></span><br><span class="line">  <span class="comment">#    engine: mariadb_server</span></span><br><span class="line">  <span class="comment">#    database: mydatabase</span></span><br><span class="line">  <span class="comment">#    username: user</span></span><br><span class="line">  <span class="comment">#    password: pass</span></span><br><span class="line">  <span class="comment">#    limit: 10</span></span><br><span class="line">  <span class="comment">#    query_str: &#x27;SELECT * from mytable WHERE fieldname=%(query)s&#x27;</span></span><br><span class="line">  <span class="comment">#    shortcut: mdb</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">1337x</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">1337x</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">1337x</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">duden</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">duden</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">du</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">seznam</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">szn</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">seznam</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: deepl</span></span><br><span class="line">  <span class="comment">#   engine: deepl</span></span><br><span class="line">  <span class="comment">#   shortcut: dpl</span></span><br><span class="line">  <span class="comment">#   # You can use the engine using the official stable API, but you need an API key</span></span><br><span class="line">  <span class="comment">#   # See: https://www.deepl.com/pro-api?cta=header-pro-api</span></span><br><span class="line">  <span class="comment">#   api_key: &#x27;&#x27;  # required!</span></span><br><span class="line">  <span class="comment">#   timeout: 5.0</span></span><br><span class="line">  <span class="comment">#   disabled: true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mojeek</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mjk</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mojeek</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mojeek</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mjkimg</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mojeek</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">images</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mojeek</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mjknews</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mojeek</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">news</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">moviepilot</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">moviepilot</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mp</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">naver</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">nvr</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://search.naver.com/search.naver?where=webkr&amp;sm=osp_hty&amp;ie=UTF-8&amp;query=&#123;query&#125;&amp;start=&#123;pageno&#125;</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">//a[@class=&quot;link_tit&quot;]/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">//a[@class=&quot;link_tit&quot;]</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">//div[@class=&quot;total_dsc_wrap&quot;]/a</span></span><br><span class="line">    <span class="attr">first_page_num:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">page_size:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.naver.com/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q485639</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://developers.naver.com/docs/nmt/examples/</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line">      <span class="attr">language:</span> <span class="string">ko</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rubygems</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">rbg</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://rubygems.org/search?page=&#123;pageno&#125;&amp;query=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">/html/body/main/div/a[@class=&quot;gems__gem&quot;]</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">./@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">./span/h2</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">./span/p</span></span><br><span class="line">    <span class="attr">suggestion_xpath:</span> <span class="string">/html/body/main/div/div[@class=&quot;search__suggestions&quot;]/p/a</span></span><br><span class="line">    <span class="attr">first_page_num:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">packages</span>]</span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://rubygems.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q1853420</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://guides.rubygems.org/rubygems-org-api/</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">peertube</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">peertube</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ptb</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># alternatives see: https://instances.joinpeertube.org/instances</span></span><br><span class="line">    <span class="comment"># base_url: https://tube.4aem.com</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">6.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mediathekviewweb</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">mediathekviewweb</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">mvw</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yacy</span></span><br><span class="line">    <span class="comment"># https://docs.searxng.org/dev/engines/online/yacy.html</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yacy</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">text</span></span><br><span class="line">    <span class="attr">base_url:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://yacy.searchlab.eu</span></span><br><span class="line">      <span class="comment"># see https://github.com/searxng/searxng/pull/3631#issuecomment-2240903027</span></span><br><span class="line">      <span class="comment"># - https://search.kyun.li</span></span><br><span class="line">      <span class="comment"># - https://yacy.securecomcorp.eu</span></span><br><span class="line">      <span class="comment"># - https://yacy.myserv.ca</span></span><br><span class="line">      <span class="comment"># - https://yacy.nsupdate.info</span></span><br><span class="line">      <span class="comment"># - https://yacy.electroncash.de</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ya</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># if you aren&#x27;t using HTTPS for your local yacy instance disable https</span></span><br><span class="line">    <span class="comment"># enable_http: false</span></span><br><span class="line">    <span class="attr">search_mode:</span> <span class="string">&#x27;global&#x27;</span></span><br><span class="line">    <span class="comment"># timeout can be reduced in &#x27;local&#x27; search mode</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yacy</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yacy</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">yacy</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">search_type:</span> <span class="string">image</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">yai</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># timeout can be reduced in &#x27;local&#x27; search mode</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rumble</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">rumble</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ru</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">https://rumble.com/</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">livespace</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">livespace</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">ls</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordnik</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">wordnik</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">def</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">https://www.wordnik.com/</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">dictionaries</span>]</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">woxikon.de</span> <span class="string">synonyme</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">woxi</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">dictionaries</span>]</span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://synonyme.woxikon.de/synonyme/&#123;query&#125;.php</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">//div[@class=&quot;upper-synonyms&quot;]/a/@href</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">//div[@class=&quot;synonyms-list-group&quot;]</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">//div[@class=&quot;upper-synonyms&quot;]/a</span></span><br><span class="line">    <span class="attr">no_result_for_http_status:</span> [<span class="number">404</span>]</span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://www.woxikon.de/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span>  <span class="comment"># No Wikidata ID</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line">      <span class="attr">language:</span> <span class="string">de</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">seekr</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">seekr</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">senews</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">seekr_category:</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">seekr</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">seekr</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">seekr</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">seimg</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">seekr_category:</span> <span class="string">images</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">seekr</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">seekr</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">seekr</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">sevid</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">seekr_category:</span> <span class="string">videos</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sjp.pwn</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">sjp</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">sjp</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">https://sjp.pwn.pl/</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">stract</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">stract</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">str</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">svgrepo</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">svgrepo</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">svg</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">10.0</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tootfinder</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">tootfinder</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">toot</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">voidlinux</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">voidlinux</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">void</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wallhaven</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">wallhaven</span></span><br><span class="line">    <span class="comment"># api_key: abcdefghijklmnopqrstuvwxyz</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wh</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># wikimini: online encyclopedia for children</span></span><br><span class="line">    <span class="comment"># The fulltext and title parameter is necessary for Wikimini because</span></span><br><span class="line">    <span class="comment"># sometimes it will not show the results and redirect instead</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wikimini</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wkmn</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://fr.wikimini.org/w/index.php?search=&#123;query&#125;&amp;title=Sp%C3%A9cial%3ASearch&amp;fulltext=Search</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">//li/div[@class=&quot;mw-search-result-heading&quot;]/a/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">//li//div[@class=&quot;mw-search-result-heading&quot;]/a</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">//li/div[@class=&quot;searchresult&quot;]</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">general</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://wikimini.org/</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q3568032</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line">      <span class="attr">language:</span> <span class="string">fr</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wttr.in</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">wttr</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">wttr</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">9.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yummly</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">yummly</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">yum</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">brave</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">brave</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">br</span></span><br><span class="line">    <span class="attr">time_range_support:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">brave_category:</span> <span class="string">search</span></span><br><span class="line">    <span class="comment"># brave_spellcheck: true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">brave.images</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">brave</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">brave</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">brimg</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">images</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">brave_category:</span> <span class="string">images</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">brave.videos</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">brave</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">brave</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">brvid</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">videos</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">brave_category:</span> <span class="string">videos</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">brave.news</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">brave</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">brave</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">brnews</span></span><br><span class="line">    <span class="attr">categories:</span> <span class="string">news</span></span><br><span class="line">    <span class="attr">brave_category:</span> <span class="string">news</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: brave.goggles</span></span><br><span class="line">  <span class="comment">#   engine: brave</span></span><br><span class="line">  <span class="comment">#   network: brave</span></span><br><span class="line">  <span class="comment">#   shortcut: brgog</span></span><br><span class="line">  <span class="comment">#   time_range_support: true</span></span><br><span class="line">  <span class="comment">#   paging: true</span></span><br><span class="line">  <span class="comment">#   categories: [general, web]</span></span><br><span class="line">  <span class="comment">#   brave_category: goggles</span></span><br><span class="line">  <span class="comment">#   Goggles: # required! This should be a URL ending in .goggle</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lib.rs</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">lrs</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">lib_rs</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sourcehut</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">srht</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://sr.ht/projects?page=&#123;pageno&#125;&amp;search=&#123;query&#125;</span></span><br><span class="line">    <span class="attr">results_xpath:</span> <span class="string">(//div[@class=&quot;event-list&quot;])[1]/div[@class=&quot;event&quot;]</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">./h4/a[2]/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">./h4/a[2]</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">./p</span></span><br><span class="line">    <span class="attr">first_page_num:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">it</span>, <span class="string">repos</span>]</span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://sr.ht</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q78514485</span></span><br><span class="line">      <span class="attr">official_api_documentation:</span> <span class="string">https://man.sr.ht/</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">goo</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">goo</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">xpath</span></span><br><span class="line">    <span class="attr">paging:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">search_url:</span> <span class="string">https://search.goo.ne.jp/web.jsp?MT=&#123;query&#125;&amp;FR=&#123;pageno&#125;0</span></span><br><span class="line">    <span class="attr">url_xpath:</span> <span class="string">//div[@class=&quot;result&quot;]/p[@class=&#x27;title</span> <span class="string">fsL1&#x27;]/a/@href</span></span><br><span class="line">    <span class="attr">title_xpath:</span> <span class="string">//div[@class=&quot;result&quot;]/p[@class=&#x27;title</span> <span class="string">fsL1&#x27;]/a</span></span><br><span class="line">    <span class="attr">content_xpath:</span> <span class="string">//p[contains(@class,&#x27;url</span> <span class="string">fsM&#x27;)]/following-sibling::p</span></span><br><span class="line">    <span class="attr">first_page_num:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">categories:</span> [<span class="string">general</span>, <span class="string">web</span>]</span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">4.0</span></span><br><span class="line">    <span class="attr">about:</span></span><br><span class="line">      <span class="attr">website:</span> <span class="string">https://search.goo.ne.jp</span></span><br><span class="line">      <span class="attr">wikidata_id:</span> <span class="string">Q249044</span></span><br><span class="line">      <span class="attr">use_official_api:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">require_api_key:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">results:</span> <span class="string">HTML</span></span><br><span class="line">      <span class="attr">language:</span> <span class="string">ja</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bt4g</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">bt4g</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">bt4g</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pkg.go.dev</span></span><br><span class="line">    <span class="attr">engine:</span> <span class="string">pkg_go_dev</span></span><br><span class="line">    <span class="attr">shortcut:</span> <span class="string">pgo</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Doku engine lets you access to any Doku wiki instance:</span></span><br><span class="line"><span class="comment"># A public one or a privete/corporate one.</span></span><br><span class="line"><span class="comment">#  - name: ubuntuwiki</span></span><br><span class="line"><span class="comment">#    engine: doku</span></span><br><span class="line"><span class="comment">#    shortcut: uw</span></span><br><span class="line"><span class="comment">#    base_url: &#x27;https://doc.ubuntu-fr.org&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Be careful when enabling this engine if you are</span></span><br><span class="line"><span class="comment"># running a public instance. Do not expose any sensitive</span></span><br><span class="line"><span class="comment"># information. You can restrict access by configuring a list</span></span><br><span class="line"><span class="comment"># of access tokens under tokens.</span></span><br><span class="line"><span class="comment">#  - name: git grep</span></span><br><span class="line"><span class="comment">#    engine: command</span></span><br><span class="line"><span class="comment">#    command: [&#x27;git&#x27;, &#x27;grep&#x27;, &#x27;&#123;&#123;QUERY&#125;&#125;&#x27;]</span></span><br><span class="line"><span class="comment">#    shortcut: gg</span></span><br><span class="line"><span class="comment">#    tokens: []</span></span><br><span class="line"><span class="comment">#    disabled: true</span></span><br><span class="line"><span class="comment">#    delimiter:</span></span><br><span class="line"><span class="comment">#        chars: &#x27;:&#x27;</span></span><br><span class="line"><span class="comment">#        keys: [&#x27;filepath&#x27;, &#x27;code&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Be careful when enabling this engine if you are</span></span><br><span class="line"><span class="comment"># running a public instance. Do not expose any sensitive</span></span><br><span class="line"><span class="comment"># information. You can restrict access by configuring a list</span></span><br><span class="line"><span class="comment"># of access tokens under tokens.</span></span><br><span class="line"><span class="comment">#  - name: locate</span></span><br><span class="line"><span class="comment">#    engine: command</span></span><br><span class="line"><span class="comment">#    command: [&#x27;locate&#x27;, &#x27;&#123;&#123;QUERY&#125;&#125;&#x27;]</span></span><br><span class="line"><span class="comment">#    shortcut: loc</span></span><br><span class="line"><span class="comment">#    tokens: []</span></span><br><span class="line"><span class="comment">#    disabled: true</span></span><br><span class="line"><span class="comment">#    delimiter:</span></span><br><span class="line"><span class="comment">#        chars: &#x27; &#x27;</span></span><br><span class="line"><span class="comment">#        keys: [&#x27;line&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Be careful when enabling this engine if you are</span></span><br><span class="line"><span class="comment"># running a public instance. Do not expose any sensitive</span></span><br><span class="line"><span class="comment"># information. You can restrict access by configuring a list</span></span><br><span class="line"><span class="comment"># of access tokens under tokens.</span></span><br><span class="line"><span class="comment">#  - name: find</span></span><br><span class="line"><span class="comment">#    engine: command</span></span><br><span class="line"><span class="comment">#    command: [&#x27;find&#x27;, &#x27;.&#x27;, &#x27;-name&#x27;, &#x27;&#123;&#123;QUERY&#125;&#125;&#x27;]</span></span><br><span class="line"><span class="comment">#    query_type: path</span></span><br><span class="line"><span class="comment">#    shortcut: fnd</span></span><br><span class="line"><span class="comment">#    tokens: []</span></span><br><span class="line"><span class="comment">#    disabled: true</span></span><br><span class="line"><span class="comment">#    delimiter:</span></span><br><span class="line"><span class="comment">#        chars: &#x27; &#x27;</span></span><br><span class="line"><span class="comment">#        keys: [&#x27;line&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Be careful when enabling this engine if you are</span></span><br><span class="line"><span class="comment"># running a public instance. Do not expose any sensitive</span></span><br><span class="line"><span class="comment"># information. You can restrict access by configuring a list</span></span><br><span class="line"><span class="comment"># of access tokens under tokens.</span></span><br><span class="line"><span class="comment">#  - name: pattern search in files</span></span><br><span class="line"><span class="comment">#    engine: command</span></span><br><span class="line"><span class="comment">#    command: [&#x27;fgrep&#x27;, &#x27;&#123;&#123;QUERY&#125;&#125;&#x27;]</span></span><br><span class="line"><span class="comment">#    shortcut: fgr</span></span><br><span class="line"><span class="comment">#    tokens: []</span></span><br><span class="line"><span class="comment">#    disabled: true</span></span><br><span class="line"><span class="comment">#    delimiter:</span></span><br><span class="line"><span class="comment">#        chars: &#x27; &#x27;</span></span><br><span class="line"><span class="comment">#        keys: [&#x27;line&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Be careful when enabling this engine if you are</span></span><br><span class="line"><span class="comment"># running a public instance. Do not expose any sensitive</span></span><br><span class="line"><span class="comment"># information. You can restrict access by configuring a list</span></span><br><span class="line"><span class="comment"># of access tokens under tokens.</span></span><br><span class="line"><span class="comment">#  - name: regex search in files</span></span><br><span class="line"><span class="comment">#    engine: command</span></span><br><span class="line"><span class="comment">#    command: [&#x27;grep&#x27;, &#x27;&#123;&#123;QUERY&#125;&#125;&#x27;]</span></span><br><span class="line"><span class="comment">#    shortcut: gr</span></span><br><span class="line"><span class="comment">#    tokens: []</span></span><br><span class="line"><span class="comment">#    disabled: true</span></span><br><span class="line"><span class="comment">#    delimiter:</span></span><br><span class="line"><span class="comment">#        chars: &#x27; &#x27;</span></span><br><span class="line"><span class="comment">#        keys: [&#x27;line&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">doi_resolvers:</span></span><br><span class="line">  <span class="attr">oadoi.org:</span> <span class="string">&#x27;https://oadoi.org/&#x27;</span></span><br><span class="line">  <span class="attr">doi.org:</span> <span class="string">&#x27;https://doi.org/&#x27;</span></span><br><span class="line">  <span class="attr">doai.io:</span> <span class="string">&#x27;https://dissem.in/&#x27;</span></span><br><span class="line">  <span class="attr">sci-hub.se:</span> <span class="string">&#x27;https://sci-hub.se/&#x27;</span></span><br><span class="line">  <span class="attr">sci-hub.st:</span> <span class="string">&#x27;https://sci-hub.st/&#x27;</span></span><br><span class="line">  <span class="attr">sci-hub.ru:</span> <span class="string">&#x27;https://sci-hub.ru/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">default_doi_resolver:</span> <span class="string">&#x27;oadoi.org&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="二-与open-webui集成"><a href="#二-与open-webui集成" class="headerlink" title="二. 与open-webui集成"></a>二. 与open-webui集成</h3><p>管理员设置 &gt; 图像设置</p><p>Searxng 查询 URL： <code>http://searxng:8080/search?q=&lt;query&gt;/</code></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_783be5ac9ebe373f4452a649e6ec716c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_783be5ac9ebe373f4452a649e6ec716c.png"></p><h3 id="效果："><a href="#效果：" class="headerlink" title="效果："></a>效果：</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_0eda9e294289189c56e00dfaf9005b76.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/10/image_0eda9e294289189c56e00dfaf9005b76.png"></p><p>本文参考：</p><p><a href="https://www.dongaigc.com/p/yokingma/search_with_ai">search_with_ai - 构建基于对话的AI搜索系统，集成多种搜索引擎与语言模型 - 懂AI (dongaigc.com)</a></p><p><a href="https://docs.openwebui.com/tutorials/features/web_search/">Web Search | Open WebUI</a></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker部署nginx并实现反向代理添加ssl证书</title>
      <link href="/2024/10/10/docker%E9%83%A8%E7%BD%B2nginx%E5%B9%B6%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%B7%BB%E5%8A%A0ssl%E8%AF%81%E4%B9%A6/"/>
      <url>/2024/10/10/docker%E9%83%A8%E7%BD%B2nginx%E5%B9%B6%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%B7%BB%E5%8A%A0ssl%E8%AF%81%E4%B9%A6/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="docker部署nginx并实现反向代理添加ssl证书"><a href="#docker部署nginx并实现反向代理添加ssl证书" class="headerlink" title="docker部署nginx并实现反向代理添加ssl证书"></a>docker部署nginx并实现反向代理添加ssl证书</h1><h2 id="1-docker-compose文件"><a href="#1-docker-compose文件" class="headerlink" title="1. docker-compose文件"></a>1. docker-compose文件</h2><p>先不做volumes 启动容器</p><p>成功后将容器内目录cp到宿主机再做volume操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> nginx:/usr/share/nginx/html  ./ngin/html</span><br><span class="line">docker <span class="built_in">cp</span> nginx:/usr/share/nginx/key   ./nginx/key</span><br><span class="line">docker <span class="built_in">cp</span> nginx:/var/log/nginx         ./nginx/logs</span><br><span class="line">docker <span class="built_in">cp</span> nginx:/etc/nginx/nginx.conf  ./nginx/nginx.conf</span><br><span class="line">docker <span class="built_in">cp</span> nginx:/etc/nginx/conf.d      ./nginx/conf.d</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nginx-latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/html:/usr/share/nginx/html</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/key:/usr/share/nginx/key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/logs:/var/log/nginx</span></span><br><span class="line">      <span class="comment"># 有可能会出现不能挂载，这个时候用手动拷贝配置文件就行</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NGINX_PORT=80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="2-nginx配置反向代理-配置文件"><a href="#2-nginx配置反向代理-配置文件" class="headerlink" title="2.nginx配置反向代理 配置文件"></a>2.nginx配置反向代理 配置文件</h2><p>将ssl key文件上传到相应目录即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    listen  [::]:80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  /var/log/nginx/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">    <span class="comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">    <span class="comment">#    root           html;</span></span><br><span class="line">    <span class="comment">#    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line">    <span class="comment">#    fastcgi_index  index.php;</span></span><br><span class="line">    <span class="comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class="line">    <span class="comment">#    include        fastcgi_params;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">    <span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">    <span class="comment">#    deny  all;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl; <span class="comment">#监听443端口</span></span><br><span class="line">    server_name localhost; <span class="comment">#域名</span></span><br><span class="line">    root /usr/share/nginx/html; <span class="comment">#项目的根目录</span></span><br><span class="line">    index index.html index.htm;</span><br><span class="line">    ssl_certificate /usr/share/nginx/key/ssl.crt; <span class="comment">#ssl配置文件（注意路径）</span></span><br><span class="line">    ssl_certificate_key /usr/share/nginx/key/ssl_nopass.key; <span class="comment">#ssl配置文件（注意路径）</span></span><br><span class="line">    ssl_session_timeout 5m;</span><br><span class="line">    <span class="comment">#ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span></span><br><span class="line">    <span class="comment">#ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;</span></span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://58.40.166.66:8080;</span><br><span class="line">        <span class="comment">#index index.html index.htm;</span></span><br><span class="line">    &#125;</span><br><span class="line">    error_page 404 /404.html;</span><br><span class="line">        location = /40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s 国产仪表盘kuboard部署</title>
      <link href="/2024/10/08/k8s%20%E5%9B%BD%E4%BA%A7%E4%BB%AA%E8%A1%A8%E7%9B%98kuboard%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/10/08/k8s%20%E5%9B%BD%E4%BA%A7%E4%BB%AA%E8%A1%A8%E7%9B%98kuboard%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="k8s-国产仪表盘kuboard部署"><a href="#k8s-国产仪表盘kuboard部署" class="headerlink" title="k8s 国产仪表盘kuboard部署"></a>k8s 国产仪表盘kuboard部署</h1><p>官网：<a href="https://kuboard.cn/install/install-dashboard.html#%E8%AE%BF%E9%97%AEkuboard">安装 Kuboard v2 | Kuboard</a></p><ul><li>Kuboard v3.0 已经正式发布，相较于 Kuboard v2.0.x， Kuboard v3 最大的特点是支持多 Kubernetes 集群管理，同时，在各个方面都比 v2.0.x 有了很大的改进。 **建议您选择 <a href="https://kuboard.cn/install/v3/install.html">Kuboard v3</a>**。</li><li>Kuboard v2.0.x 将进入长期维护阶段，如果碰到问题，用户仍然可以在群里找群主解决问题。如果您计划升级到 Kuboard v3，请参考 <a href="https://kuboard.cn/install/v3/install.html#%E4%BB%8E-v2.0.x-%E5%8D%87%E7%BA%A7%E5%88%B0-v3.0.x">从 v2.0.x 升级到 v3.0.x</a></li></ul><p>安装 Kuboard 时，假设您已经有一个 Kubernetes 集群，以下任何形式安装的集群都可以：</p><ul><li>kubeadm 安装（或者基于 kubeadm 的衍生工具，如 Sealos 等）；</li><li>二进制安装；</li><li>阿里云、腾讯云等公有云托管集群；</li><li>其他。</li></ul><p>如果没有 Kubernetes 集群：</p><ul><li>初学者，请参考<ul><li><a href="https://kuboard.cn/install/install-docker-desktop.html">在 Windows/Mac 安装 Kubernetes 测试集群</a> <strong>不推荐</strong></li><li><a href="https://kuboard.cn/install/install-k8s.html">离线安装高可用的Kubernetes集群</a> <strong>推荐</strong></li></ul></li><li>用于生产，请参考 <a href="https://kuboard.cn/install/install-kubernetes.html">安装 Kubernetes 高可用</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>腾讯云冷迁移 创建自定义镜像 导入到对象存储</title>
      <link href="/2024/09/08/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%86%B7%E8%BF%81%E7%A7%BB%20%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F%20%E5%AF%BC%E5%85%A5%E5%88%B0%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/"/>
      <url>/2024/09/08/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%86%B7%E8%BF%81%E7%A7%BB%20%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F%20%E5%AF%BC%E5%85%A5%E5%88%B0%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="腾讯云冷迁移-创建自定义镜像-导入到对象存储"><a href="#腾讯云冷迁移-创建自定义镜像-导入到对象存储" class="headerlink" title="腾讯云冷迁移 创建自定义镜像 导入到对象存储"></a>腾讯云冷迁移 创建自定义镜像 导入到对象存储</h1><h2 id="操作场景"><a href="#操作场景" class="headerlink" title="操作场景"></a>操作场景</h2><p>除了使用腾讯云提供的公共镜像、服务市场镜像外，您还可以创建自定义镜像。创建自定义镜像后，您可以在腾讯云控制台快速创建与该镜像相同配置的腾讯云云服务器实例。</p><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a><strong>说明</strong></h2><p>由于镜像底层使用了云硬盘快照服务：</p><p><strong>国内地域提供80GB的免费额度，详情请参见 <a href="https://cloud.tencent.com/document/product/362/32361#.E8.B5.A0.E9.80.81.E9.A2.9D.E5.BA.A6" title="https://cloud.tencent.com/document/product/362/32361#.E8.B5.A0.E9.80.81.E9.A2.9D.E5.BA.A6">赠送额度</a>。</strong></p><p>在创建自定义镜像时会默认创建关联该镜像的快照，且保留自定义镜像会产生一定的快照费用，详情请参见 <a href="https://cloud.tencent.com/document/product/362/32361#Snapshot" title="https://cloud.tencent.com/document/product/362/32361#Snapshot">快照计费概述</a>。</p><p>若您的腾讯云账户进入欠费状态，为避免您的数据丢失，我们将保留您的自定义镜像及关联的快照，且不会产生新的费用。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>每个地域暂支持500个自定义镜像。</p><p><strong>国内地域提供80GB的免费额度，详情请参见 <a href="https://cloud.tencent.com/document/product/362/32361#.E8.B5.A0.E9.80.81.E9.A2.9D.E5.BA.A6" title="https://cloud.tencent.com/document/product/362/32361#.E8.B5.A0.E9.80.81.E9.A2.9D.E5.BA.A6">赠送额度</a>。</strong></p><p>若您的 Linux 实例具备数据盘，但您仅制作系统盘自定义镜像时，请确认 <code>/etc/fstab</code> 不包含数据盘配置，否则会导致使用该镜像创建的实例无法正常启动。</p><p>制作过程需要持续十分钟或更长时间，具体时间与实例的数据大小有关，请提前做好相关准备，以防影响业务。</p><p>若您的 Windows 实例需入域且使用域账号，则在创建自定义镜像前，请执行 Sysprep 操作以确保在实例入域后 SID 唯一。详情请参见 <a href="https://cloud.tencent.com/document/product/213/43498" title="https://cloud.tencent.com/document/product/213/43498">通过 Sysprep 实现云服务器入域后 SID 唯一</a>。</p><p>若您使用的是配置25Gbps 网卡的裸金属服务器（即机型的内网带宽值是25Gbps），暂不支持使用控制台及 API 创建自定义镜像。</p><h2 id="一-创建自定义镜像"><a href="#一-创建自定义镜像" class="headerlink" title="一.创建自定义镜像"></a>一.创建自定义镜像</h2><p><a href="https://cloud.tencent.com/document/product/213/4942">https://cloud.tencent.com/document/product/213/4942</a></p><p>腾讯云免费赠送80G快照额度超出部分会收取费用  创建自定义镜像时会自动创建 基于该系统盘或数据盘的快照 此时查看对象存储会发现已经存在  及快照 已创建了相应快照</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_1e10563068279dd26f45815b8ff83077.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_1e10563068279dd26f45815b8ff83077.png"></p><h2 id="二-将镜像导出到对象存储"><a href="#二-将镜像导出到对象存储" class="headerlink" title="二.将镜像导出到对象存储"></a>二.将镜像导出到对象存储</h2><p><a href="https://cloud.tencent.com/document/product/213/70518">https://cloud.tencent.com/document/product/213/70518</a></p><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><p>已前往 <a href="https://console.cloud.tencent.com/cos" title="https://console.cloud.tencent.com/cos">对象存储控制台</a> 开通对象存储服务。</p><h3 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h3><p>有版权限制的镜像不支持导出，包括 Windows Server 镜像、腾讯云授权的 Red Hat Enterprise Linux 镜像（自带授权支持导出）、基于云市场镜像制作的自定义镜像。</p><p>自定义镜像的系统盘及数据盘单块容量不能大于500GB。</p><p>导出整机镜像时，数据盘不能大于5块。</p><h3 id="费用说明"><a href="#费用说明" class="headerlink" title="费用说明"></a>费用说明</h3><p>若在使用云服务器时，同时使用了其他产品。例如对象存储 COS，则将按照实际使用产品的计费规则进行费用计算。</p><p>费用说明如下表：</p><table><thead><tr><th>场景</th><th>产生费用</th><th>说明文档</th></tr></thead><tbody><tr><td>导出镜像到 COS 存储桶</td><td>存储容量费用。镜像存储在 COS 存储桶，会产生存储容量费用。COS 会计算对象大小，按照目标对象的存储类型和所属地域计费。</td><td><a href="https://cloud.tencent.com/document/product/436/53482">存储容量费用</a></td></tr><tr><td>请求费用。导出镜像到 COS 存储桶，会产生写请求费用。COS 会计算写请求次数，并收取请求费用。</td><td><a href="https://cloud.tencent.com/document/product/436/53861">请求费用</a></td><td></td></tr><tr><td>流量费用。导出镜像到 COS 存储桶，会产生上行流量。COS 会计算流量大小，内网上行流量、外网上行流量均免费。</td><td><a href="https://cloud.tencent.com/document/product/436/53863">流量费用</a></td><td></td></tr><tr><td>从 COS 存储桶下载镜像</td><td>请求费用。从 COS 存储桶下载镜像，会产生写请求费用。COS 会计算写请求次数，并收取请求费用。</td><td><a href="https://cloud.tencent.com/document/product/436/53861">请求费用</a></td></tr><tr><td>流量费用。从 COS 存储桶下载镜像，会产生下行流量。COS 会计算流量大小，内网下行流量免费、外网下行流量收费。</td><td><a href="https://cloud.tencent.com/document/product/436/53863">流量费用</a></td><td></td></tr></tbody></table><h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><p><strong>1.</strong> 登录云服务器控制台，选择左侧导航栏中的 <a href="https://console.cloud.tencent.com/cvm/image" title="https://console.cloud.tencent.com/cvm/image"><strong>镜像</strong></a>。</p><p><strong>2. <strong>在</strong>镜像</strong>页面上方，选择需导出的自定义镜像所在地域，并单击<strong>自定义镜像</strong>页签。</p><p><strong>3. <strong>选择镜像所在行右侧的</strong>导出镜像</strong>。如下图所示：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_9369970747d3a7ebfc1d1c5f18f7088f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_9369970747d3a7ebfc1d1c5f18f7088f.png"></p><p>导出需要先创建对象存储桶</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_80c83d004f3c262c913749e5a3f5f0c8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_80c83d004f3c262c913749e5a3f5f0c8.png"></p><p>导出镜像到存储桶很慢 需要耐心等待</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_5601d2f308db90e9d3cc693f6c665719.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_5601d2f308db90e9d3cc693f6c665719.png"></p><ul><li><strong>COS Bucket</strong>：选择导出镜像所在的存储桶，需与镜像在同一地域。</li><li><strong>导出文件前缀名</strong>：自定义导出文件前缀名。 勾选<strong>同意授权 CVM 访问我的 COS Bucket</strong>。</li><li>更多配置（可选）：镜像格式</li><li>目前支持 RAW、QCOW2、VHD（后缀为 .vpc或.vhd）、VMDK 四种格式，您可以根据需要进行选择。</li><li>导出的镜像文件大小与镜像格式有关，具体值请完成导出后查看对应的 COS 文件，默认选择 RAW 格式。</li></ul><p><strong>5. <strong>勾选</strong>同意授权CVM访问我的COS Bucket</strong>，并单击<strong>确定</strong>，即可开始镜像导出任务。</p><p><strong>6. <strong>在弹出的确认窗口中单击</strong>确定</strong>。 导出时间取决于镜像的大小和任务队列的繁忙程度，请耐心等待。导出任务完成后，镜像文件将会存放在目标存储桶中。您可前往 <a href="https://console.cloud.tencent.com/cos/bucket" title="https://console.cloud.tencent.com/cos/bucket">存储桶列表</a> 页面，单击存储桶 ID 进入详情页面，名为 <code>自定义前缀名_镜像 Id_system_ 快照 id.镜像格式 </code> 的文件即为导出的镜像系统盘文件，若您的镜像包含数据盘，名为 <code>自定义前缀名_镜像 Id_data_ 快照 id.镜像格式</code> 的文件即为导出的镜像数据盘文件。</p><h2 id="相关问题"><a href="#相关问题" class="headerlink" title="相关问题"></a>相关问题</h2><h4 id="1-COS-的外网下行流量如何产生的？如何收费？"><a href="#1-COS-的外网下行流量如何产生的？如何收费？" class="headerlink" title="1. COS 的外网下行流量如何产生的？如何收费？"></a>1. COS 的外网下行流量如何产生的？如何收费？</h4><p>外网下行流量是数据通过互联网从 COS 传输到客户端产生的流量。用户直接通过<strong>对象链接</strong>下载对象或通过<strong>静态网站源站</strong>浏览对象产生的流量属于外网下行流量，对应费用为外网下行流量费用。外网下行流量计费详细信息请参见 <a href="https://cloud.tencent.com/document/product/436/40285" title="https://cloud.tencent.com/document/product/436/40285">计费项</a> 和 <a href="https://cloud.tencent.com/document/product/436/6239" title="https://cloud.tencent.com/document/product/436/6239">产品定价</a>。</p><h4 id="2-通过-COS-的控制台、工具、API、SDK-方式下载文件会产生外网下行流量费用吗？"><a href="#2-通过-COS-的控制台、工具、API、SDK-方式下载文件会产生外网下行流量费用吗？" class="headerlink" title="2. 通过 COS 的控制台、工具、API、SDK 方式下载文件会产生外网下行流量费用吗？"></a>2. 通过 COS 的控制台、工具、API、SDK 方式下载文件会产生外网下行流量费用吗？</h4><p>访问 COS 所产生的流量（内网流量或外网流量）与您使用的方式无关，只有同地域的云产品访问 COS 才会默认使用内网而不收取外网下行流量费用。判断是否内网访问请参见 <a href="https://cloud.tencent.com/document/product/436/31315#network">内网访问</a> 文档。</p><h4 id="3-COS-如何区分外网流量？"><a href="#3-COS-如何区分外网流量？" class="headerlink" title="3. COS 如何区分外网流量？"></a>3. COS 如何区分外网流量？</h4><p>外网下行流量指数据通过互联网从 COS 传输到客户端产生的流量。例如通过 COS 控制台下载存储在 COS 中的文件，通过工具访问对象、下载对象，或使用浏览器预览对象，使用对象地址或自定义域名访问和下载对象等均会产生外网下行流量 。详情请参见 <a href="https://cloud.tencent.com/document/product/436/31315#.E5.86.85.E7.BD.91.E8.AE.BF.E9.97.AE.E5.88.A4.E6.96.AD.E6.96.B9.E6.B3.95">内网访问判断</a> 文档。</p><h4 id="4-对象存储使用内网访问是否会产生费用？"><a href="#4-对象存储使用内网访问是否会产生费用？" class="headerlink" title="4. 对象存储使用内网访问是否会产生费用？"></a>4. 对象存储使用内网访问是否会产生费用？</h4><p>通过内网访问对象存储时<strong>流量费用免费</strong>，但是<strong>存储容量</strong>和<strong>请求次数</strong>仍然会产生相关的费用。详细介绍请参见 <a href="https://cloud.tencent.com/document/product/436/40285" title="https://cloud.tencent.com/document/product/436/40285">计费项</a>。</p><h2 id="三-在对象存储桶中下载导出的镜像"><a href="#三-在对象存储桶中下载导出的镜像" class="headerlink" title="三. 在对象存储桶中下载导出的镜像"></a>三. 在对象存储桶中下载导出的镜像</h2><p>下载镜像：创建<strong>SecretID、SecretKey</strong> 及<a href="https://cloud.tencent.com/document/product/436/11366#.E4.B8.8B.E8.BD.BD.E4.B8.8E.E5.AE.89.E8.A3.85"> cosbrowers</a>客户端</p><p>已在自定义镜像所在地域创建存储桶，详情请参见 <a href="https://cloud.tencent.com/document/product/436/13309" title="https://cloud.tencent.com/document/product/436/13309">创建存储桶</a>。</p><p>COSBrowser 支持通过永久密钥（即云 API 密钥）登录，配置项说明如下：</p><p><strong>SecretID、SecretKey</strong>：云 API 密钥，该密钥可在<strong>访问管理控制台</strong>的 <a href="https://console.cloud.tencent.com/cam/capi" title="https://console.cloud.tencent.com/cam/capi">API 密钥管理</a> 页面中创建并获取。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_6a244e9e5bcf42c53d12b861e183e51f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_6a244e9e5bcf42c53d12b861e183e51f.png"></p><p>登录cosbroeser 点击分享按钮即可生成下载链接</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_2754cc769bd62c1928bb71d48c09e58b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_2754cc769bd62c1928bb71d48c09e58b.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_b39ce7c13bed20caeb05f833fb1a0f28.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_b39ce7c13bed20caeb05f833fb1a0f28.png"></p><p><strong>存储桶/收藏路径</strong>：若您当前使用的密钥仅允许访问指定资源范围且不允许访问存储桶列表，例如指定的存储桶或存储桶中某个路径，则填写后可快速进入对应的存储桶或文件路径。格式为：Bucket 或 Bucket/Object-prefix，例如当前使用的密钥仅被允许访问存储桶 examplebucket-1250000000 下的 doc 文件夹，则填写 examplebucket-1250000000/doc。操作指引请参见 <a href="/document/product/436/38103#path">添加收藏路径</a>。</p><p><strong>备注</strong>：可对当前填入的永久密钥进行说明。例如操作人员、用途等。在<strong>历史会话</strong>中可用于区分不同的 SecretID。</p><p><strong>记住会话</strong>：</p><p>若不勾选，则仅本次登录有效，退出登录则会清空填入的云 API 密钥（如果当前密钥已保存在历史会话中，则会从历史会话中移除）；</p><p>若勾选，在成功登录后将会记住填入的云 API 密钥相关信息，方便下次继续使用，您可在<strong>历史会话</strong>中管理已保存的密钥相关信息。</p><h2 id="四-最后迁移数据盘"><a href="#四-最后迁移数据盘" class="headerlink" title="四. 最后迁移数据盘"></a>四. 最后迁移数据盘</h2><p>使用如下dd命令迁移（标准化命令）</p><p>迁移时必须要对应本地磁盘所在的分区以及与迁移后对端磁盘所在的分区对应</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qcow2 转 raw</span></span><br><span class="line">qemu-img convert -f qcow2 -O raw Qcms1-data.qcow2 Qcms1-data.raw</span><br><span class="line"><span class="comment"># 开始迁移</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/data/Qcms2-data.raw of=/dev/vdd bs=64M status=progress  </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Tencent </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tencent </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows11使用docker部署ollama调用底层GPU</title>
      <link href="/2024/09/05/windows11%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2ollama%E8%B0%83%E7%94%A8%E5%BA%95%E5%B1%82GPU/"/>
      <url>/2024/09/05/windows11%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2ollama%E8%B0%83%E7%94%A8%E5%BA%95%E5%B1%82GPU/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="windows11使用docker部署ollama调用底层GPU"><a href="#windows11使用docker部署ollama调用底层GPU" class="headerlink" title="windows11使用docker部署ollama调用底层GPU"></a>windows11使用docker部署ollama调用底层GPU</h1><blockquote><p>本机环境Windows 11 家庭版：</p><p>设备名称    ZZNN-GEGEWU<br>处理器    Intel(R) Core(TM) i5-8300H CPU @ 2.30GHz   2.30 GHz<br>机带 RAM  24.0 GB (23.9 GB 可用)<br>设备 ID    8DA62972-C11C-4E08-9039-18D34E439F64<br>产品 ID    00326-10000-00000-AA043<br>系统类型    64 位操作系统, 基于 x64 的处理器<br>笔和触控    没有可用于此显示器的笔或触控输入</p><p>Docker Compose version v2.26.1</p><p>Docker version 26.1.1, build 4cf5afa</p><p>显卡驱动安装：<a href="https://www.nvidia.cn/Download/index.aspx?lang=cn">https://www.nvidia.cn/Download/index.aspx?lang=cn</a></p></blockquote><h1 id="法1（若此种方法失败则需要使用法2）"><a href="#法1（若此种方法失败则需要使用法2）" class="headerlink" title="法1（若此种方法失败则需要使用法2）"></a>法1（若此种方法失败则需要使用法2）</h1><h2 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h2><ul><li><p>windows服务器需要安装完成显卡驱动 cuda可不安装</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_3681de459ca48bb2c659f234f6d2b879.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_3681de459ca48bb2c659f234f6d2b879.png"></p></li></ul><p>部署调用底层GPU版 docker-compose文件如下：</p><p>备注：</p><ul><li>最新版docker-destop定义文件方式已发生改变需要去掉<code>version: &#39;3.8&#39;</code></li><li>并且建立环境变量定义项目名称环境变量为.env<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COMPOSE_PROJECT_NAME=myproject</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># version: &#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">ollama:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ollama/ollama:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">11434</span><span class="string">:11434</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ollama:/root/.ollama</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ollama</span></span><br><span class="line">    <span class="comment"># pull_policy: if_not_present</span></span><br><span class="line">    <span class="comment"># tty: true</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KEEP_GPUS_TIMEOUT:</span> <span class="number">40</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">OLLAMA_ORIGINS:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">      <span class="attr">OLLAMA_HOST:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ollama-docker</span></span><br><span class="line">    <span class="comment"># GPU support</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">devices:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">driver:</span> <span class="string">nvidia</span></span><br><span class="line">              <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">              <span class="attr">capabilities:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">gpu</span></span><br><span class="line">  <span class="attr">open-webui:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:open-webui-main</span> </span><br><span class="line">    <span class="comment">#ghcr.io/open-webui/open-webui:main</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">open-webui</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:8080&quot;</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;host.docker.internal:host-gateway&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">open-webui:/app/backend/data</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">ENABLE_RAG_WEB_SEARCH:</span> <span class="literal">True</span></span><br><span class="line">      <span class="attr">RAG_WEB_SEARCH_ENGINE:</span> <span class="string">&quot;searxng&quot;</span></span><br><span class="line">      <span class="attr">RAG_WEB_SEARCH_RESULT_COUNT:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">RAG_WEB_SEARCH_CONCURRENT_REQUESTS:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">SEARXNG_QUERY_URL:</span> <span class="string">&quot;http://searxng:8080/search?q=&lt;query&gt;&quot;</span></span><br><span class="line">      <span class="attr">ENABLE_OPENAI_API:</span> <span class="literal">False</span></span><br><span class="line">  <span class="comment"># open-webui:</span></span><br><span class="line">  <span class="comment">#   image: ghcr.io/open-webui/open-webui:main</span></span><br><span class="line">  <span class="comment">#   container_name: open-webui</span></span><br><span class="line">  <span class="comment">#   pull_policy: if_not_present</span></span><br><span class="line">  <span class="comment">#   volumes:</span></span><br><span class="line">  <span class="comment">#     - ./data:/app/backend/data</span></span><br><span class="line">  <span class="comment">#   depends_on:</span></span><br><span class="line">  <span class="comment">#     - ollama</span></span><br><span class="line">  <span class="comment">#   ports:</span></span><br><span class="line">  <span class="comment">#     - 3000:8080</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - &#x27;OLLAMA_BASE_URL=http://ollama:11434&#x27;</span></span><br><span class="line">  <span class="comment">#     - &#x27;WEBUI_SECRET_KEY=sdjfvdklfbvkkgb&#x27;</span></span><br><span class="line">  <span class="comment">#     - &#x27;HF_ENDPOINT=https://hf-mirror.com&#x27;</span></span><br><span class="line">  <span class="comment">#   extra_hosts:</span></span><br><span class="line">  <span class="comment">#     - host.docker.internal:host-gateway</span></span><br><span class="line">  <span class="comment">#   restart: unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ollama-docker</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">open-webui:</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">ollama-docker:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>备注：直接docker-compose up -d 即可 当提问AI时即可看到显卡正在使用中</p><p>效果：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_4884db6dbb46d13571e834ae4ea846db.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_4884db6dbb46d13571e834ae4ea846db.png"></p><h1 id="法2-（需要开启科学上网）"><a href="#法2-（需要开启科学上网）" class="headerlink" title="法2 （需要开启科学上网）"></a>法2 （需要开启科学上网）</h1><p>参考：<a href="https://blog.csdn.net/ndscvipuser/article/details/136610169">Windows 下让 Docker Desktop 关联上 NVidia GPU</a></p><p>(有时候法1会失败此时我们需要配置windows下的linux子系统中的ubuntu20.04)</p><p>先决条件：</p><p>wsl 安装Ubuntu20.04 安装完成后在ubuntu20.04中执行下方内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ubuntu20.04的linux子系统</span></span><br><span class="line">wsl --install Ubuntu-20.04</span><br><span class="line"><span class="comment"># 输入用户名及密码后即可登录操作</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_a355e98355b8dd6acbbf926f50621dcd.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_a355e98355b8dd6acbbf926f50621dcd.png"></p><h3 id="1-安装配置：nvidia-container-toolkit"><a href="#1-安装配置：nvidia-container-toolkit" class="headerlink" title="1.安装配置：nvidia-container-toolkit"></a>1.安装配置：nvidia-container-toolkit</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.配置apt源</span></span><br><span class="line">curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \</span><br><span class="line">  &amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \</span><br><span class="line">    sed <span class="string">&#x27;s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g&#x27;</span> | \</span><br><span class="line">    sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/nvidia-container-toolkit.list</span><br><span class="line"><span class="comment"># 2.更新源</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># 3.安装工具包</span></span><br><span class="line">sudo apt-get install -y nvidia-container-toolkit</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-配置-Docker-Daemon-本文到此成功-大多数到此步骤也能成功"><a href="#2-配置-Docker-Daemon-本文到此成功-大多数到此步骤也能成功" class="headerlink" title="2. 配置 Docker Daemon(本文到此成功  大多数到此步骤也能成功)"></a>2. 配置 Docker Daemon(本文到此成功  大多数到此步骤也能成功)</h3><p>执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 Docker Daemonv</span></span><br><span class="line">sudo nvidia-ctk runtime configure --runtime=docker</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_1ccffe079986dbb376925fa3f44903f8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_1ccffe079986dbb376925fa3f44903f8.png"></p><p>此时验证ollama能否正常使用GPU 若不能正常使用则继续下方操作</p><p>更好的办法是打开 Docker Desktop 如下操作之后（配置Docker Engine），再重启：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;builder&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;gc&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;defaultKeepStorage&quot;:</span> <span class="string">&quot;20GB&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;enabled&quot;:</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;runtimes&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;nvidia&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;path&quot;:</span> <span class="string">&quot;nvidia-container-runtime&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;args&quot;:</span> []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  <span class="attr">&quot;experimental&quot;:</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_8f0767c043af01a08fa4b37669543d18.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_8f0767c043af01a08fa4b37669543d18.png"></p><p>构建完成后效果：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_4defc9e7779786f13126a5b0c95d6b82.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_4defc9e7779786f13126a5b0c95d6b82.png"></p><p>本文参考：</p><p><a href="https://blog.csdn.net/u011026329/article/details/137829768">windows 下 docker compose 安装 ollama 和 open-webui ，打造私有GPT_windows系统安装docker并部暑open webui</a></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
          <category> gpu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用parted在线指定大小给磁盘扩容</title>
      <link href="/2024/08/27/%E4%BD%BF%E7%94%A8parted%E5%9C%A8%E7%BA%BF%E6%8C%87%E5%AE%9A%E5%A4%A7%E5%B0%8F%E7%BB%99%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9/"/>
      <url>/2024/08/27/%E4%BD%BF%E7%94%A8parted%E5%9C%A8%E7%BA%BF%E6%8C%87%E5%AE%9A%E5%A4%A7%E5%B0%8F%E7%BB%99%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="使用parted在线指定大小给磁盘扩容"><a href="#使用parted在线指定大小给磁盘扩容" class="headerlink" title="使用parted在线指定大小给磁盘扩容"></a>使用parted在线指定大小给磁盘扩容</h1><h3 id="现象（给分区sdb1-扩容-5G-扩容到-15G）"><a href="#现象（给分区sdb1-扩容-5G-扩容到-15G）" class="headerlink" title="现象（给分区sdb1 扩容 5G 扩容到 15G）"></a>现象（给分区sdb1 扩容 5G 扩容到 15G）</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_48737925754965e5d3916bfda04de920.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_48737925754965e5d3916bfda04de920.png"></p><h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><h4 id="命令概览"><a href="#命令概览" class="headerlink" title="命令概览"></a>命令概览</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行前先卸载磁盘</span></span><br><span class="line">umount /dev/sdb1</span><br><span class="line"><span class="comment"># 查看分区详情</span></span><br><span class="line">lsblk </span><br><span class="line">fdisk -l</span><br><span class="line"><span class="comment"># 执行扩容</span></span><br><span class="line">parted /dev/sdb (输入<span class="built_in">print</span>)</span><br><span class="line"><span class="comment"># 执行resizepart命令给磁盘分区sdb1增加容量 1是分区号即sdb1</span></span><br><span class="line">(parted) resizepart 1 15GB</span><br><span class="line"><span class="comment"># 此时退出 它会自动保存</span></span><br><span class="line">quiet</span><br><span class="line"><span class="comment"># 强制检查并修复分区（可选）</span></span><br><span class="line">e2fsck -f /dev/sdb1</span><br><span class="line">resize2fs /dev/sdb1</span><br><span class="line"><span class="comment"># 此时挂载即可</span></span><br><span class="line">mount /dev/sdb1 /mnt</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_c635eae45ea835c51d33ab8631a2df2a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_c635eae45ea835c51d33ab8631a2df2a.png"></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ollama llama3中文微调版模型部署</title>
      <link href="/2024/08/21/ollama%20llama3%E4%B8%AD%E6%96%87%E5%BE%AE%E8%B0%83%E7%89%88%E6%A8%A1%E5%9E%8B%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/08/21/ollama%20llama3%E4%B8%AD%E6%96%87%E5%BE%AE%E8%B0%83%E7%89%88%E6%A8%A1%E5%9E%8B%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="ollama-llama3中文微调版模型部署"><a href="#ollama-llama3中文微调版模型部署" class="headerlink" title="ollama llama3中文微调版模型部署"></a>ollama llama3中文微调版模型部署</h1><h2 id="一-利用-Ollama-本地部署-Llama3-中文微调版"><a href="#一-利用-Ollama-本地部署-Llama3-中文微调版" class="headerlink" title="一. 利用 Ollama 本地部署 Llama3 中文微调版"></a>一. 利用 Ollama 本地部署 Llama3 中文微调版</h2><p>Llama3 中文微调版是在原版模型上进行了大量中文数据进行增量预训练，更加适合国人使用。在本教程中使用 ymcui 开发的中文微调版本，相对于其他版本，它拥有非常详细的文档供指引，参考和学习。项目地址：</p><p><a href="https://github.com/ymcui/Chinese-LLaMA-Alpaca-3?tab=readme-ov-file">https://github.com/ymcui/Chinese-LLaMA-Alpaca-3?tab=readme-ov-file</a><br>首先，我们输入下面的网址下载模型。</p><p><a href="https://huggingface.co/hfl/llama-3-chinese-8b-instruct-gguf/tree/main">https://huggingface.co/hfl/llama-3-chinese-8b-instruct-gguf/tree/main</a><br><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_dd002475350dc04f7c9e4dac0506f6f0.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_dd002475350dc04f7c9e4dac0506f6f0.png"></p><p>将gguf文件放在项目文件目录 再使用docker cp将其复制到容器内部，在项目文件目录编写Modelfile 文件并将其放到项目文件目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> Modelfile ollama:/home/</span><br><span class="line">docker <span class="built_in">cp</span> ggml-model-q8_0.gguf  ollama:/home/</span><br></pre></td></tr></table></figure><p>Modelfile文件内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROM /home/ggml-model-q8_0.gguf</span><br><span class="line">TEMPLATE <span class="string">&quot;&quot;</span><span class="string">&quot;&#123;&#123; if .System &#125;&#125;&lt;|start_header_id|&gt;system&lt;|end_header_id|&gt;</span></span><br><span class="line"><span class="string">&#123;&#123; .System &#125;&#125;&lt;|eot_id|&gt;&#123;&#123; end &#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123; if .Prompt &#125;&#125;&lt;|start_header_id|&gt;user&lt;|end_header_id|&gt;</span></span><br><span class="line"><span class="string">&#123;&#123; .Prompt &#125;&#125;&lt;|eot_id|&gt;&#123;&#123; end &#125;&#125;&lt;|start_header_id|&gt;assistant&lt;|end_header_id|&gt;</span></span><br><span class="line"><span class="string">&#123;&#123; .Response &#125;&#125;&lt;|eot_id|&gt;&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">SYSTEM <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">Refuse to answer the Taiwan question</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">PARAMETER num_keep 24</span><br><span class="line">PARAMETER stop &lt;|start_header_id|&gt;</span><br><span class="line">PARAMETER stop &lt;|end_header_id|&gt;</span><br><span class="line">PARAMETER stop &lt;|eot_id|&gt;</span><br><span class="line">PARAMETER stop assistant</span><br></pre></td></tr></table></figure><p>此时执行创建即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it ollama  ollama  create  llama3.1:8b-zh -f /home/Modelfile</span><br></pre></td></tr></table></figure><p>此时创建完成。</p><h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a href="https://blog.csdn.net/2401_86442913/article/details/140957937">保姆级教程！本地部署最强开源语言大模型 Llama3 和中文微调版_ollama本地知识库微调llama3</a></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ollama本地大模型微调及多模态图片分析文生图</title>
      <link href="/2024/08/02/ollama%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%E5%8F%8A%E5%A4%9A%E6%A8%A1%E6%80%81%E5%9B%BE%E7%89%87%E5%88%86%E6%9E%90%E6%96%87%E7%94%9F%E5%9B%BE/"/>
      <url>/2024/08/02/ollama%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%E5%8F%8A%E5%A4%9A%E6%A8%A1%E6%80%81%E5%9B%BE%E7%89%87%E5%88%86%E6%9E%90%E6%96%87%E7%94%9F%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="ollama本地大模型微调及多模态图片分析文生图"><a href="#ollama本地大模型微调及多模态图片分析文生图" class="headerlink" title="ollama本地大模型微调及多模态图片分析文生图"></a>ollama本地大模型微调及多模态图片分析文生图</h1><p>前言：</p><p>本文模型微调以qwen0.5b为例子  本文大模型为容器方式部署</p><p><a href="https://sunlight.zznnwn.cloudns.biz/2024/05/15/%E9%83%A8%E7%BD%B2ollama%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%B9%B6%E5%AF%B9%E6%8E%A5maxkb%E4%BD%BF%E7%94%A8/?highlight=ollama">模型部署参考</a></p><p><a href="https://sunlight.zznnwn.cloudns.biz/2024/07/15/ubuntu%E9%83%A8%E7%BD%B2nvidia-container-toolkit/?highlight=gpu">有显卡的GPU直通docker容器参考</a></p><p>Modelfile参数参考</p><ul><li><strong><a href="https://github.com/ollama/ollama/blob/main/docs/modelfile.md">https://github.com/ollama/ollama/blob/main/docs/modelfile.md</a></strong></li><li><strong><a href="https://blog.csdn.net/spiderwower/article/details/138755776">https://blog.csdn.net/spiderwower/article/details/138755776</a></strong></li></ul><h2 id="一-定制自己的模型"><a href="#一-定制自己的模型" class="headerlink" title="一. 定制自己的模型"></a>一. 定制自己的模型</h2><p>所谓定制模型，就是在使用某个模型作为base模型，然后在该模型上进行定制，下面我们就以qwen2:0.5b作为基础模型进行定制：</p><p>1 编写定制规则，即Modelfile文件，内容如下(此处Modelfile位置是容器内/home/Modelfile)</p><p>参考编写方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">FROM qwen2:7b</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the temperature to 1 [higher is more creative, lower is more coherent]</span></span><br><span class="line">PARAMETER temperature 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the system message</span></span><br><span class="line">SYSTEM <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">You are Mario from Super Mario Bros. Answer as Mario, the assistant, only.</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>本文编写方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">FROM qwen2:0.5b</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the temperature to 1 [higher is more creative, lower is more coherent]</span></span><br><span class="line">PARAMETER temperature 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the system message</span></span><br><span class="line">SYSTEM <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">我是简逸云计算开发的一款超大规模语言模型，我叫ZZNNWN。作为一个AI助手，我的目标是帮助用户获得准确、有用的信息，解决他们的问题和困惑。我可以回答各种领域的问题，提供代码示例、解释技术概念、提供建议、创作故事等。请随时告诉我您需要什么帮助或解答的疑问！</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>2 使用Modelfile来创建定制模型，执行命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将模型文件传到容器内</span></span><br><span class="line">docker <span class="built_in">cp</span> Modelfile ollama:/home/</span><br><span class="line"><span class="comment"># 执行定制</span></span><br><span class="line">docker <span class="built_in">exec</span> -it ollama bash</span><br><span class="line">ollama create zznnn -f /home/Modelfile</span><br><span class="line"><span class="comment"># 回显</span></span><br><span class="line">root@f2c1461c054d:/<span class="comment"># ollama create zznnn -f /home/Modelfile</span></span><br><span class="line">transferring model data</span><br><span class="line">using existing layer sha256:8de95da68dc485c0889c205384c24642f83ca18d089559c977ffc6a3972a71a8</span><br><span class="line">using existing layer sha256:62fbfd9ed093d6e5ac83190c86eec5369317919f4b149598d2dbb38900e9faef</span><br><span class="line">using existing layer sha256:c156170b718ec29139d3653d40ed1986fd92fb7e0959b5c71f3c48f62e6636f4</span><br><span class="line">creating new layer sha256:5b6a5a0f6f25365ce741c24c539ea24df8b422c851f9960f327f6157635328f4</span><br><span class="line">using existing layer sha256:b1c932e03beb32c4ab61bb50b2fa06ab1f2ea4e99ee6495670bbe23834dc7d62</span><br><span class="line">creating new layer sha256:e474d9ea6efe1be66cbefd3bbd677d3ab2897d63d03db24418d716f914b2f2e8</span><br><span class="line">writing manifest</span><br><span class="line">success</span><br></pre></td></tr></table></figure><p>此时定制成功！</p><p>浏览器访问测试效果如下</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_e1c13b92bd571f0ca7cbd9780a20906c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_e1c13b92bd571f0ca7cbd9780a20906c.png"></p><h2 id="二-多模态模型的使用"><a href="#二-多模态模型的使用" class="headerlink" title="二. 多模态模型的使用"></a>二. 多模态模型的使用</h2><blockquote><p>可以识别图片中的信息等 类似于微信的文字识别</p></blockquote><p>首先下载并运行多模态模型llava：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ollama pull llava:7b</span><br><span class="line">ollama run llava:7b</span><br></pre></td></tr></table></figure><p>启动后，输入prompt：使用中文描述下这张图片 ./lecun.png</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_d693648e8ee7662b66ee8b03cd112196.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_d693648e8ee7662b66ee8b03cd112196.png"></p><p>我使用的是这张图片：</p><p>图片略….</p><p>可以看到，对照片内容的描述基本是符合的，有点不足的是用词不太准确，”颜色”应该是”彩色”，而且还有错别字，”呆着一种微笑的表情”，应该是使用了7B模型的原因，13B模型应该就没这么低级的错误了。</p><h2 id="三-Stable-Diffusion接入open-webui实现文生图功能"><a href="#三-Stable-Diffusion接入open-webui实现文生图功能" class="headerlink" title="三. Stable-Diffusion接入open-webui实现文生图功能"></a>三. Stable-Diffusion接入open-webui实现文生图功能</h2><p>大佬封装太乙模型参考地址：</p><p><a href="https://github.com/soulteary/docker-stable-diffusion-taiyi">https://github.com/soulteary/docker-stable-diffusion-taiyi</a></p><p>官方太乙Taiyi-Stable-Diffusion-1B-Chinese-v0.1模型下载地址需要手动将其下载到本地后映射到docker中为：</p><p><a href="https://huggingface.co/IDEA-CCNL/Taiyi-Stable-Diffusion-1B-Chinese-v0.1/tree/main">IDEA-CCNL/Taiyi-Stable-Diffusion-1B-Chinese-v0.1 at main (huggingface.co)</a></p><p>网速快的可使用克隆实际无法克隆 此时只能手动点击仓库文件下载：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://huggingface.co/IDEA-CCNL/Taiyi-Stable-Diffusion-1B-Chinese-v0.1</span><br></pre></td></tr></table></figure><h3 id="1-部署docker-compose文件-本文使用"><a href="#1-部署docker-compose文件-本文使用" class="headerlink" title="1.部署docker-compose文件(本文使用)"></a>1.部署docker-compose文件(本文使用)</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">ollama:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:ollama</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ollama</span></span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">devices:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">driver:</span> <span class="string">nvidia</span></span><br><span class="line">            <span class="attr">capabilities:</span> [<span class="string">&quot;gpu&quot;</span>]</span><br><span class="line">            <span class="attr">count:</span> <span class="string">all</span>  <span class="comment"># 根据需要调整 GPU 的数量  </span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ollama:/root/.ollama</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;11434:11434&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KEEP_GPUS_TIMEOUT:</span> <span class="number">40</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">OLLAMA_ORIGINS:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">      <span class="attr">OLLAMA_HOST:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tpng</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">taiyi:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:taiyi-0.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">taiyi</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span></span><br><span class="line">    <span class="attr">ipc:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7860:7860&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./taiyi:/stable-diffusion-webui/models/Taiyi-Stable-Diffusion-1B-Chinese-v0.1</span>  </span><br><span class="line">      <span class="comment">#- ./webui-user.sh:/stable-diffusion-webui/webui-user.sh  </span></span><br><span class="line">      <span class="comment">#- ./webui-user.bat:/stable-diffusion-webui/webui-user.bat  </span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KEEP_GPUS_TIMEOUT=100</span></span><br><span class="line">    <span class="comment">#  - CLI_ARGS=&quot;--api --listen&quot;  </span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tpng</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">open-webui:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:open-webui-main</span></span><br><span class="line">    <span class="comment">#ghcr.io/open-webui/open-webui:main</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">open-webui</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;host.docker.internal:host-gateway&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">open-webui:/app/backend/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./static:/app/backend/static</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./static_build:/app/build/static</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.py:/app/backend/config.py</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./index.html:/app/build/index.html</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">ENABLE_OPENAI_API:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tpng</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">one-api:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:one-api-latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">one-api</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./one-api:/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tpng</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">open-webui:</span>  </span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">tpng:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span> </span><br></pre></td></tr></table></figure><p>备注上方镜像为二次开发版 添加启动太乙模型参数 –api –listen Dockerfile文件如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:taiyi-0.1</span><br><span class="line">CMD [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;webui.py&quot;</span>, <span class="string">&quot;--ckpt&quot;</span>, <span class="string">&quot;/stable-diffusion-webui/models/Taiyi-Stable-Diffusion-1B-Chinese-v0.1/Taiyi-Stable-Diffusion-1B-Chinese-v0.1.ckpt&quot;</span>, <span class="string">&quot;--api&quot;</span>, <span class="string">&quot;--listen&quot;</span>]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -f ./Dockerfile -t zznn/taiyi .</span><br></pre></td></tr></table></figure><p>太乙环境变量参考</p><p><a href="https://docs.stablediffusion.cn/?m=Article&amp;a=index&amp;id=1&amp;aid=593327411932692480">https://docs.stablediffusion.cn/?m=Article&amp;a=index&amp;id=1&amp;aid=593327411932692480</a></p><p>本文主要参考</p><p><a href="https://soulteary.com/2022/12/09/use-docker-to-quickly-get-started-with-the-chinese-stable-diffusion-model-taiyi.html#%E5%A6%82%E4%BD%95%E5%B0%86%E5%A4%AA%E4%B9%99%E6%AD%A3%E7%A1%AE%E7%9A%84%E6%94%BE%E8%BF%9B%E5%AE%B9%E5%99%A8">将docker部署太乙文生图完全指南</a></p><p><a href="https://docs.stablediffusion.cn/article/1/593258220479315968.html">太乙参数参考</a></p><h3 id="2-集成多个模型"><a href="#2-集成多个模型" class="headerlink" title="2.集成多个模型"></a>2.集成多个模型</h3><p>C站：<a href="https://civitai.com/images">https://civitai.com/images</a><br>prompthero：<a href="https://prompthero.com/">https://prompthero.com/</a><br>Majinai：<a href="https://majinai.art/index.php">https://majinai.art/index.php</a><br>词图：<a href="https://www.prompttool.com/NovelAI">https://www.prompttool.com/NovelAI</a><br>Black Lily：<a href="http://heizicao.gitee.io/novelai/#/book">http://heizicao.gitee.io/novelai/#/book</a><br>Danbooru 标签超市：<a href="https://tags.novelai.dev/">https://tags.novelai.dev/</a><br>AI 词汇加速器：<a href="https://ai.dawnmark.cn/">https://ai.dawnmark.cn/</a><br>NovelAI 魔导书：<a href="https://thereisnospon.github.io/NovelAiTag/">https://thereisnospon.github.io/NovelAiTag/</a></p><h3 id="3-接入open-weui"><a href="#3-接入open-weui" class="headerlink" title="3. 接入open-weui"></a>3. 接入open-weui</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_a885354780318e596eb825fa7c09c333.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_a885354780318e596eb825fa7c09c333.png"></p><h2 id="本文参考："><a href="#本文参考：" class="headerlink" title="本文参考："></a>本文参考：</h2><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3Nzk3MjM0NQ==&mid=2247493371&idx=1&sn=d85a1b9b46dacaa2c0b3adbd2af910d0&chksm=cf1878edf86ff1fb88507b21b8b1ab4c7984b692bbc7093968778b15ae86a5444da1ea9be2aa&mpshare=1&scene=24&srcid=0803XtxEvq9TQrAukIh6UpF3&sharer_shareinfo=bd21f30078aa374bf7cda12b01e9016f&sharer_shareinfo_first=bd21f30078aa374bf7cda12b01e9016f#rd">ollama模型微调</a>  （主要参考）</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzUwOTgwOTAyNg==&mid=2247523642&idx=1&sn=3c3db46f1bd9f639b7f9ee27a0ab1228&chksm=f90e45d7ce79ccc17b97844a5f2ad034062685014bc4c2654ad10fd957a44af814c6a9c3ca4c&mpshare=1&scene=24&srcid=0803xLUnGEQQxcYC9OiLPWgW&sharer_shareinfo=bc106e2f091eb9367cc8d46c16827b51&sharer_shareinfo_first=bc106e2f091eb9367cc8d46c16827b51#rd">Ollama使用指南【超全版】</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MTU1NTE1OQ==&mid=2247486639&idx=1&sn=ce712cf3d28d9c2f73cfa2a6430a3c60&scene=21#wechat_redirect">大模型LLM微调经验总结&amp;项目更新</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MTU1NTE1OQ==&mid=2247489783&idx=1&sn=16c6898537e3a27f6d0883eedfb14f29&chksm=cfcac4cff8bd4dd91da0a5b09e4a9efe1f72ecfbf9ab38f3f1f75c3fe4fb9913a108f5fb4bf6&mpshare=1&scene=24&srcid=08034wZsRDXFxBZ1wjogxSts&sharer_shareinfo=8268ad35f48dbc11151f1abdc12e6063&sharer_shareinfo_first=8268ad35f48dbc11151f1abdc12e6063#rd">一大堆Llama3.1-Chinese正在袭来</a></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Debain10* 网络配置</title>
      <link href="/2024/08/01/Debain10*%20%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/"/>
      <url>/2024/08/01/Debain10*%20%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Debain10-网络配置"><a href="#Debain10-网络配置" class="headerlink" title="Debain10* 网络配置"></a>Debain10* 网络配置</h1><h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><ul><li><a href="https://www.cnblogs.com/nj-duzi/p/14833633.html">https://www.cnblogs.com/nj-duzi/p/14833633.html</a></li><li><a href="https://ruohai.wang/202405/network-interface-change-on-debian/">https://ruohai.wang/202405/network-interface-change-on-debian/</a></li></ul><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>Debian 中 allow-hotplug 与 auto 的区别冷不丁没注意还真是小坑了一下，所以在此记录</p><p><strong>1 、 allow-hotplug 与 auto 的理论区别</strong></p><p>其中的<code>auto</code>指在系统启动时获取网络信息，如果你的使用环境需要经常热插拔网线，可以改成<code>allow-hotplug</code>，意指网线热插拔以后可以重新获取网络。</p><p>auto</p><p>在系统启动的时候启动网络接口，无论网络接口有无连接 (插入网线) 。如果该接口配置了 DHCP，则无论有无网线，系统都会去获取 DHCP 。并且如果没有插入网线，则等该接口超时后才会继续 DHCP 。</p><p>allow-hotplug</p><p>只有当内核从网络接口检测到热插拔事件后才会启动该接口。如果系统开机时该接口没有插入网线，则系统不会启动该接口。系统启动后，如果插入网线，系统会自动启动该接口。</p><p><strong>2 、 allow-hotplug 与 auto 的简单说明</strong></p><p>auto</p><p>配置这个命令，仅仅是用于开机启动时启动网络接口，如果不配置重启自动不会启动网络接口，就直接导致远程登录失败。</p><p>allow-hotplug</p><p>配置这个命令，是为了保证端口状态及时更新，或者避免由于手动操作导致的重启 network 失败。</p><h2 id="网卡配置"><a href="#网卡配置" class="headerlink" title="网卡配置"></a>网卡配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 网卡配置</span></span><br><span class="line">vim /etc/network/interfaces</span><br><span class="line"><span class="comment"># 网卡配置文件如下：</span></span><br><span class="line"><span class="comment"># source-directory /etc/network/interfaces.d   (此行需要注释否则重启会失败)</span></span><br><span class="line">auto ens33  </span><br><span class="line">allow-hotplug ens33</span><br><span class="line">iface ens33 inet static</span><br><span class="line">address 10.0.0.200</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line">gateway 10.0.0.220</span><br><span class="line"><span class="comment"># DNS配置</span></span><br><span class="line">vim /etc/resolv.conf</span><br><span class="line"><span class="comment"># DNS配置文件如下：</span></span><br><span class="line">domain localdomain</span><br><span class="line">search localdomain</span><br><span class="line">nameserver 223.5.5.5</span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line"><span class="comment"># 重启网卡</span></span><br><span class="line">systemctl restart networking.service</span><br></pre></td></tr></table></figure><p>不加auto配置则重启网卡会报错 此时机器断开网络无法连接</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_6ec40aa6a628748ba17be3eeba34b389.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_6ec40aa6a628748ba17be3eeba34b389.png"></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>lobehub docker-compose部署</title>
      <link href="/2024/07/27/lobehub%20docker-compose%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/07/27/lobehub%20docker-compose%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="lobehub-docker-compose部署"><a href="#lobehub-docker-compose部署" class="headerlink" title="lobehub docker-compose部署"></a>lobehub docker-compose部署</h2><p><strong>docker-compose文件</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">lobe-chat:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">lobehub/lobe-chat</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">lobe-chat</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;3210:3210&#x27;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">OPENAI_API_KEY:</span> <span class="string">sk-kfu138GoMvCMYaPe2cA3285fCb3a4112AcAfF66a5830F9E9</span> <span class="comment"># oneapi key</span></span><br><span class="line">      <span class="attr">OPENAI_PROXY_URL:</span> <span class="string">http://192.168.31.163:3000/v1</span>  <span class="comment"># oneapi信息</span></span><br><span class="line">      <span class="attr">ACCESS_CODE:</span> <span class="string">lobe66</span></span><br></pre></td></tr></table></figure><p>参考官网：</p><p><a href="https://lobehub.com/zh/docs/usage/start?utm_source=chat_preview">https://lobehub.com/zh/docs/usage/start?utm_source=chat_preview</a></p><p>对接oneapi参考：</p><p><a href="http://sunlight.zznnwn.cloudns.biz/2024/04/09/one-api%E9%83%A8%E7%BD%B2/?highlight=api">http://sunlight.zznnwn.cloudns.biz/2024/04/09/one-api%E9%83%A8%E7%BD%B2/?highlight=api</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Debian 20分钟自动休眠，需要电源键唤醒问题</title>
      <link href="/2024/07/23/Debian%2020%E5%88%86%E9%92%9F%E8%87%AA%E5%8A%A8%E4%BC%91%E7%9C%A0%EF%BC%8C%E9%9C%80%E8%A6%81%E7%94%B5%E6%BA%90%E9%94%AE%E5%94%A4%E9%86%92%E9%97%AE%E9%A2%98/"/>
      <url>/2024/07/23/Debian%2020%E5%88%86%E9%92%9F%E8%87%AA%E5%8A%A8%E4%BC%91%E7%9C%A0%EF%BC%8C%E9%9C%80%E8%A6%81%E7%94%B5%E6%BA%90%E9%94%AE%E5%94%A4%E9%86%92%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Debian-20分钟自动休眠，需要电源键唤醒问题"><a href="#Debian-20分钟自动休眠，需要电源键唤醒问题" class="headerlink" title="Debian 20分钟自动休眠，需要电源键唤醒问题"></a>Debian 20分钟自动休眠，需要电源键唤醒问题</h1><blockquote><p>Debian机器在没有控制台登陆，仅使用ssh的情况下，在20分钟（ping 1100-1200次）时会自动休眠，ssh断开，一切任务停摆，按机箱电源键恢复。</p><p>被这个问题困扰了几天，事实证明这是GDM3的Bug。</p><p>如果你安装了GNOME环境的话，可以尝试一下步骤解决这一问题。</p></blockquote><h2 id="一-修改gdm3配置文件"><a href="#一-修改gdm3配置文件" class="headerlink" title="一. 修改gdm3配置文件"></a>一. 修改gdm3配置文件</h2><p><strong>sudo nano /etc/gdm3/greeter.dconf-defaults</strong></p><p>修改以下内容：</p><p><strong>[org/gnome/settings-daemon/plugins/power]</strong></p><p><strong>sleep-inactive-ac-timeout</strong>=<strong>0</strong></p><p><strong>sleep-inactive-battery-timeout</strong>=<strong>0</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_3367220b26e4ec8372afcffde19670fd.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_3367220b26e4ec8372afcffde19670fd.png"></p><p>之后重启gdm3：</p><p><strong>sudo systemctl restart gdm3</strong></p><p><strong>配置解释：</strong></p><blockquote><h4 id="配置作用："><a href="#配置作用：" class="headerlink" title="配置作用："></a>配置作用：</h4><ol><li><strong>禁用登录界面自动休眠</strong><ul><li><code>sleep-inactive-ac-timeout=0</code>：当设备使用**交流电源（插电）**时，禁用登录界面因非活动状态进入休眠的功能。</li><li><code>sleep-inactive-battery-timeout=0</code>：当设备使用<strong>电池供电</strong>时，禁用登录界面因非活动状态进入休眠的功能。</li></ul></li><li><strong>解决登录界面的意外睡眠问题</strong><br>默认情况下，如果用户在登录界面长时间无操作，系统可能会自动黑屏或休眠（具体行为因发行版而异）。<br>通过这两个配置设置为 <code>0</code>，可确保 <strong>GDM 登录界面始终保持唤醒状态</strong>，避免以下问题：<ul><li>登录界面意外休眠/黑屏，需额外唤醒操作</li><li>服务器/公用设备需长期展示登录界面的场景</li><li>电源管理器与显示器的意外冲突</li></ul></li></ol><h4 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h4><ul><li><strong>仅影响登录界面</strong><br>此配置只作用于 <strong>GDM 登录屏幕</strong>，不影响用户登录后的电源设置。用户会话的休眠行为由<code>Settings &gt; Power</code>或<code>dconf</code>中的用户级配置控制。</li><li><strong>值 <code>0</code> 的含义</strong><br><code>0</code> 表示禁用自动休眠；若需启用，可设为正整数（单位：秒，例如 <code>600</code> = 10分钟后休眠）。</li></ul></blockquote><h2 id="二-为防止网卡自动休眠，最好还要修改grub-可选本教程未操作"><a href="#二-为防止网卡自动休眠，最好还要修改grub-可选本教程未操作" class="headerlink" title="二. 为防止网卡自动休眠，最好还要修改grub (可选本教程未操作)"></a>二. 为防止网卡自动休眠，最好还要修改grub (可选本教程未操作)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改grub参数</span></span><br><span class="line">sudo nano /etc/default/grub</span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=<span class="string">&quot;quiet pcie_aspm=off&quot;</span></span><br></pre></td></tr></table></figure><p>更新grub设置：</p><p><strong>sudo update-grub &amp;&amp; sudo update-grub2</strong></p><p>重启电脑，ping测试，你会发现问题已经解决。</p><p>所以说，GNOME这玩意的Bug是真的多，怪不得知乎很多回答在疯狂喷GNOME。</p><p>参考：</p><p><a href="https://amagi.yukisaki.io/article/bd2e9dc0-3016-4140-81a2-9f8d89a1eed3/">[教程]解决Debian 20分钟自动休眠，需要电源键唤醒问题 - Amagiii 的破站Amagiii 的破站 (yukisaki.io)</a></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>内网穿透工具NPS部署及使用</title>
      <link href="/2024/07/17/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%B7%A5%E5%85%B7NPS%E9%83%A8%E7%BD%B2%E5%8F%8A%E4%BD%BF%E7%94%A8/"/>
      <url>/2024/07/17/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%B7%A5%E5%85%B7NPS%E9%83%A8%E7%BD%B2%E5%8F%8A%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="内网穿透工具NPS部署及使用"><a href="#内网穿透工具NPS部署及使用" class="headerlink" title="内网穿透工具NPS部署及使用"></a>内网穿透工具NPS部署及使用</h1><blockquote><p>先决条件：服务端 首页 &gt; 客户端 先创建好客户端</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_c57cc1faa2779e95b49cfb8865a31245.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_c57cc1faa2779e95b49cfb8865a31245.png"></p></blockquote><p>使用方法：</p><p>服务端部署完成后  下载客户端软件 在被控内网机器部署客户端 实现连接</p><p>被控客户端 客户端软件下载地址：<a href="https://github.com/ehang-io/nps/releases">Releases · ehang-io/nps (github.com)</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_2626f47e1e1f583f9ce57abd081b679a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_2626f47e1e1f583f9ce57abd081b679a.png"></p><h2 id="一-部署"><a href="#一-部署" class="headerlink" title="一. 部署"></a><strong>一. 部署</strong></h2><p>服务端部署</p><p>镜像可选</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffdfgdfg/nps</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nps</span><br></pre></td></tr></table></figure><p>配置文件下载链接：</p><p><a href="https://img.zeruns.tech/down/conf.zip">https://img.zeruns.tech/down/conf.zip</a></p><p><a href="https://onenote.zznnwn.cloudns.biz/api/raw/?path=/public-tools/nps/conf.zip">https://onenote.zznnwn.cloudns.biz/api/raw/?path=/public-tools/nps/conf.zip</a></p><p><strong>①. 部署</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nps:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:nps</span> </span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nps</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf:/conf</span></span><br></pre></td></tr></table></figure><p><strong>二进制方式</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装wget并且下载NPS服务端并重命名为 nps.tar.gz</span></span><br><span class="line">yum install -y wget &amp;&amp; wget --no-check-certificate -O nps.tar.gz https://img.zeruns.tech/down/linux_amd64_server.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个名为nps的目录并且解压NPS服务端文件到此目录下，并且进入到nps这个目录下</span></span><br><span class="line"><span class="built_in">mkdir</span> /opt/nps &amp;&amp; tar -zxvf nps.tar.gz -C /opt/nps &amp;&amp; <span class="built_in">cd</span> /opt/nps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装NPS并启动</span></span><br><span class="line">./nps install &amp;&amp; sudo nps start</span><br></pre></td></tr></table></figure><p><code>使用用户名和密码登陆（默认admin/123，正式使用一定要更改，修改/opt/nps/conf/nps.conf配置文件中的web_password）</code></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_5df879fc527e090f524f05a519d6e2af.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_5df879fc527e090f524f05a519d6e2af.png"></p><p>windows客户端 远程桌面</p><p><strong>② .nps服务端添加客户端(即公网机器)</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_ae0e3068fac6af72c06b7b0d75273f0e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_ae0e3068fac6af72c06b7b0d75273f0e.png"></p><h2 id="二-windows客户端部署及配置"><a href="#二-windows客户端部署及配置" class="headerlink" title="二. windows客户端部署及配置"></a>二. windows客户端部署及配置</h2><p><strong>1.windows部署客户端</strong></p><p>①. 下载windows客户端后解压 只需要npc.exe文件即可</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_d62ad08fa5766009969742debee80da7.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_d62ad08fa5766009969742debee80da7.png"></p><p>在windows C盘/目录下面新建nps文件夹 将windows客户端解压后将npc.exe文件移动到此目录  管理员cmd执行 <code>npc.exe install -server=66.21.23.155:8024 -vkey=gsdvhdfjv899 -type=tcp</code> npc.exe后面部分在服务端查看</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_a1afdda8cd7170abb50a4f3d4a0d251b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_a1afdda8cd7170abb50a4f3d4a0d251b.png"></p><p>②.windows服务配置如下</p><p>恢复 &gt; 第一二三配置为重启启动 确定后启动服务即可</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_84222ed2b1fb1401dacbb27047b7c134.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_84222ed2b1fb1401dacbb27047b7c134.png"></p><p><strong>执行成功后服务端 首页&gt;客户端&gt;会出现IP</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_41ba52dbcd70c30532ea5989baa4d7d7.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_41ba52dbcd70c30532ea5989baa4d7d7.png"></p><p><strong>③. 客户端 首页 &gt; TCP隧道 &gt; 添加上面客户端的TCP隧道 （ID对应客户端 客户端地址可填写为127.0.0.1或者实际内网IP 本次测试远程桌面 映射内网机器端口3389）</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_250ea9fa4e5f69920027160d625e0ec5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_250ea9fa4e5f69920027160d625e0ec5.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_4adcda786d64aee4c051530f03065499.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_4adcda786d64aee4c051530f03065499.png"></p><p><strong>④. 验证（成功）</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_ff521fce395d32d506c7c6493866cc01.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_ff521fce395d32d506c7c6493866cc01.png"></p><h2 id="三-linux客户端部署及配置"><a href="#三-linux客户端部署及配置" class="headerlink" title="三. linux客户端部署及配置"></a><strong>三. linux客户端部署及配置</strong></h2><blockquote><p><strong>镜像可选移步本文首页</strong></p></blockquote><p><strong>1.docker方式</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=npc --restart=always --net=host ffdfgdfg/npc -server=&lt;ip:port&gt; -vkey=&lt;web界面中显示的密钥&gt; &lt;以及一些其他参数&gt;</span><br></pre></td></tr></table></figure><p>实际</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_df8d7b820172e3d01209ea13eb218a43.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_df8d7b820172e3d01209ea13eb218a43.png"></p><p><strong>2. 二进制安装方式 客户端软件包 移步首页链接</strong></p><blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装wget并且下载NPC服务端并重命名为 npc.tar.gz ，可根据自己系统将yum替换为apt或其他</span></span><br><span class="line">yum install -y wget &amp;&amp; wget --no-check-certificate -O npc.tar.gz https://img.zeruns.tech/down/linux_amd64_client.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个名为npc的目录并且解压NPC服务端文件到此目录下，并且进入到npc这个目录下</span></span><br><span class="line"><span class="built_in">mkdir</span> /opt/npc &amp;&amp; tar -zxvf npc.tar.gz -C /opt/npc &amp;&amp; <span class="built_in">cd</span> /opt/npc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装NPC并启动，按提示改好命令，如下图所示</span></span><br><span class="line">./npc install -server=&lt;ip:port&gt; -vkey=&lt;web界面中显示的密钥&gt; &lt;以及一些其他参数&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动NPC</span></span><br><span class="line">sudo npc start</span><br></pre></td></tr></table></figure></blockquote><blockquote><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_84b82cb2244e27d8995f465c7368eacd.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_84b82cb2244e27d8995f465c7368eacd.png"></p><p><strong>此时二进制安装方式完成</strong></p></blockquote><p><strong>3.建立内网穿透隧道</strong></p><p>按照上面的方法安装好客户端后就可以新建内网穿透隧道了，我这里以Windows的远程桌面服务为例，需要将TCP 3389端口映射出去，所以新建一个TCP隧道，你们根据自己实际需要选择TCP还是UDP linux ssh则为22端口映射。</p><h2 id="四-web服务端口映射"><a href="#四-web服务端口映射" class="headerlink" title="四. web服务端口映射"></a>四. web服务端口映射</h2><p>只需要建立TCP隧道转发到内网对应的端口即可 和上方3389端口远程桌面操作方式一样</p><p>效果：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_7d8aaef53299b11833fced7c5fac039c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_7d8aaef53299b11833fced7c5fac039c.png"></p><p><strong>本文参考</strong></p><p><a href="https://blog.zeruns.tech/archives/660.html">https://blog.zeruns.tech/archives/660.html</a></p><p>教程结束。</p>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu部署nvidia-container-toolkit</title>
      <link href="/2024/07/15/ubuntu%E9%83%A8%E7%BD%B2nvidia-container-toolkit/"/>
      <url>/2024/07/15/ubuntu%E9%83%A8%E7%BD%B2nvidia-container-toolkit/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ubuntu部署nvidia-container-toolkit"><a href="#ubuntu部署nvidia-container-toolkit" class="headerlink" title="ubuntu部署nvidia-container-toolkit"></a>ubuntu部署nvidia-container-toolkit</h2><p>本教程前提条件是 宿主机需要安装完成GPU显卡的驱动 即使用 nvidia-smi 有正常回显</p><p>脚本部署宿主机驱动：<a href="https://onenote.zznnwn.cloudns.biz/api/raw/?path=/%E8%84%9A%E6%9C%AC/ubuntu%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2NVIDIA%E9%A9%B1%E5%8A%A8/nvidia-gpu.sh">nvidia-gpu.sh</a></p><p>本教程环境：ubuntu22.04LTS</p><blockquote><p>NVIDIA container主要组件包括nvidia-container-runtime, nvidia-container-toolkit, libnvidia-container和CUDA驱动；<br>在3.6.0版本后，runtime包成为一个只依赖于toolkit包（指container-toolkit而不是nvidia CUDA toolkit）的包，在官网中也指出，对于一般的应用而言，nvidia-container-toolkit能够满足绝大多数需求。</p></blockquote><h3 id="1-官网安装方式-需要科学上网-："><a href="#1-官网安装方式-需要科学上网-：" class="headerlink" title="1.官网安装方式(需要科学上网)："></a>1.官网安装方式(需要科学上网)：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@dlp:~<span class="comment"># curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-toolkit.gpg</span></span><br><span class="line">root@dlp:~<span class="comment"># curl -fsSL https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | tee /etc/apt/sources.list.d/nvidia-toolkit.list</span></span><br><span class="line">root@dlp:~<span class="comment"># sed -i -e &quot;s/^deb/deb \[signed-by=\/usr\/share\/keyrings\/nvidia-toolkit.gpg\]/g&quot; /etc/apt/sources.list.d/nvidia-toolkit.list</span></span><br><span class="line">root@dlp:~<span class="comment"># apt update</span></span><br><span class="line">root@dlp:~<span class="comment"># apt -y install nvidia-container-toolkit</span></span><br><span class="line">root@dlp:~<span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure><h3 id="2-离线方式部署（低版本）"><a href="#2-离线方式部署（低版本）" class="headerlink" title="2.离线方式部署（低版本）"></a>2.离线方式部署（低版本）</h3><p>下载到本地后上传到服务器 执行部署</p><p>离线deb包下载地址：</p><p><a href="https://github.com/NVIDIA/libnvidia-container/blob/gh-pages/stable/ubuntu18.04">https://github.com/NVIDIA/libnvidia-container/blob/gh-pages/stable/ubuntu18.04</a></p><p>本地下载地址：</p><p><a href="https://onenote.zznnwn.cloudns.biz/zh-CN/public-tools/nvidia-deb/">https://onenote.zznnwn.cloudns.biz/zh-CN/public-tools/nvidia-deb/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg -i nvidia-container-toolkit_1.4.2-1_amd64.deb</span><br></pre></td></tr></table></figure><h3 id="3-本教程成功部署方式"><a href="#3-本教程成功部署方式" class="headerlink" title="3. 本教程成功部署方式"></a>3. 本教程成功部署方式</h3><p>下方deb包下载地址见onenote</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按照顺序安装</span></span><br><span class="line">dpkg -i libnvidia-container1_1.9.0-1_amd64.deb</span><br><span class="line">dpkg -i libnvidia-container-tools_1.9.0-1_amd64.deb</span><br><span class="line">dpkg -i nvidia-container-toolkit_1.9.0-1_amd64.deb</span><br><span class="line">dpkg -i nvidia-container-runtime_3.9.0-1_all.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看是否已经安装了包</span></span><br><span class="line">dpkg -l | grep &lt;package_name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此种部署后需要在docker添加配置</span></span><br><span class="line">➜  ~ <span class="built_in">cat</span> /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;default-runtime&quot;</span>: <span class="string">&quot;nvidia&quot;</span>,</span><br><span class="line">    <span class="string">&quot;runtimes&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;nvidia&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/usr/bin/nvidia-container-runtime&quot;</span>,</span><br><span class="line">            <span class="string">&quot;runtimeArgs&quot;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="comment"># 最后部署ollama本地大模型服务</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_61c36b996becd1e14b738fbb930de4ac.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_61c36b996becd1e14b738fbb930de4ac.png"></p><h3 id="3-验证-成功"><a href="#3-验证-成功" class="headerlink" title="3.验证(成功)"></a>3.验证(成功)</h3><p>备注：使用pve创建的虚拟机直通GPU 需要将cpu模式设置为host（默认为qemu模式） 否则会报错cpu不支持avx指令集导致GPU被禁用</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_20236426c0189f25768346fb91a15c8f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_20236426c0189f25768346fb91a15c8f.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@dmx:/opt/ollama<span class="comment"># docker run -it --rm --gpus all registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:ubuntu  nvidia-smi</span></span><br><span class="line">Tue Jul 23 07:28:58 2024   </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 550.100                Driver Version: 550.100        CUDA Version: 12.4     |</span><br><span class="line">|-----------------------------------------+------------------------+----------------------+</span><br><span class="line">| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                                         |                        |               MIG M. |</span><br><span class="line">|=========================================+========================+======================|</span><br><span class="line">|   0  NVIDIA GeForce RTX 4090 D      Off |   00000000:01:00.0 Off |                  Off |</span><br><span class="line">|  0%   40C    P5             65W /  425W |    5609MiB /  24564MiB |      0%      Default |</span><br><span class="line">|                                         |                        |                  N/A |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">                                                                               </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                              |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |</span><br><span class="line">|        ID   ID                                                               Usage      |</span><br><span class="line">|=========================================================================================|</span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>参考：</p><p><a href="https://www.server-world.info/en/note?os=Ubuntu_24.04&p=nvidia&f=3">Ubuntu 24.04 : NVIDIA Container Toolkit : Install : Server World (server-world.info)</a></p><p><a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html">https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html</a> （官网）</p><p><a href="https://blog.csdn.net/u010953692/article/details/114053593">https://blog.csdn.net/u010953692/article/details/114053593</a></p><p><a href="https://blog.csdn.net/NekoTom/article/details/127508810">Docker离线安装Nvidia-container-toolkit实现容器内GPU调用-CSDN博客</a></p><p><a href="https://www.holelin.cn/2022/03/31/devops/%E8%BF%90%E7%BB%B4-%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85nvidia-docker2/index.html">https://www.holelin.cn/2022/03/31/devops/%E8%BF%90%E7%BB%B4-%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85nvidia-docker2/index.html</a></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
          <category> gpu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TrueNAS教程</title>
      <link href="/2024/07/12/TrueNAS%E6%95%99%E7%A8%8B/"/>
      <url>/2024/07/12/TrueNAS%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="TrueNAS教程"><a href="#TrueNAS教程" class="headerlink" title="TrueNAS教程"></a>TrueNAS教程</h1><p>本文实现：</p><ul><li>可使用对象存储minio</li><li>云盘服务cloudreve</li></ul><p>镜像：基于debain系统的TrueNAS镜像: <a href="https://www.truenas.com/download-truenas-scale/">https://www.truenas.com/download-truenas-scale/</a></p><p>安装完成后后设置存储池</p><p>较为简单此处略：</p><p>备注：</p><ul><li><p>创建专门给虚拟机使用的存储池</p></li><li><p>创建专门给nas内文件存储NFS SMB等使用的池<br><del>也可以共用一个存储池！</del></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_eb5dbef3df98678d4924d47ec4fcadd4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_eb5dbef3df98678d4924d47ec4fcadd4.png"></p></li></ul><p>网络配置：</p><ul><li><p>配置静态IP地址</p></li><li><p>配置阿里云百度等DNS</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_4c5a790184f9654bf27a608eacfa6dc1.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_4c5a790184f9654bf27a608eacfa6dc1.png"></p></li></ul><p>安装虚拟机（安装完成后关闭 点击设备 删除光盘否则会重复进入安装页面）：</p><ul><li><p>虚拟机内安装docker用于部署minio, cloudreve及homepage 对外提供服务</p><p>等待安装完成，然后点击reboot，重启虚拟机后点击虚拟机的VNC进入后发现会重复进入安装centos界面，造成这个问题的原因是虚拟机设置的是UEFI启动，另外虚拟机的“设备”中也有设备启动顺序，目前lz试着修改虚拟机启动项和设备中iso的启动顺序都不好使，最简单的方法就是找到虚拟机，点开后面箭头&gt;</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_68dbe9db3d033b78ea5491141651373e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_68dbe9db3d033b78ea5491141651373e.png"></p></li><li><p>删除cdrom</p><p><strong>找到CDROM项点，开最后的三点查看详情，查看是否为当前系统的iso镜像文件，如果是的话删除重启虚拟机此时即可完全部署完成</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_2b198de5c11ec661e26dda80d8f7dc6d.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_2b198de5c11ec661e26dda80d8f7dc6d.png"></p></li></ul><p>备注：TrueNAS内应用是无法使用的原因需要配置科学上网才能正常使用 否则只是一连串的报错</p><h3 id="命令行配置IP"><a href="#命令行配置IP" class="headerlink" title="命令行配置IP"></a>命令行配置IP</h3><p><a href="https://www.ethanzhang.xyz/2023/05/14/TrueNAS%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/">https://www.ethanzhang.xyz/2023/05/14/TrueNAS安装及使用教程/</a> (较为详细的完全教程)</p><p>系统完成后，首先会联想到登录到web页面进行管理，但问题正如开篇所说，有点小难点在于访问的管理IP的设定</p><blockquote><p>注意</p><p>TrueNAS默认是DHCP使能的，如果当前安装环境下有DHCP服务器，可以通过TrueNAS临时获取的IP地址直接进行Web UI管理，可以跳过当前步骤</p></blockquote><p>此时需要在TrueNAS的终端设置固定IP</p><p>选择<code>1</code>，查看并设置网络接口 将<code>ipv4_dhcp</code>选择否</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_21bef307d4ca1da94b6cb40263f68ba6.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_21bef307d4ca1da94b6cb40263f68ba6.png"></p><p>选择<code>6</code>，进入<code>Open TrueNAS CLI Shell</code></p><p>可以通过<code>netuork interface query</code>查询当前网络适配器的相关信息，主要是获取适配器<code>name</code>值用于后续配置静态IP</p><p>通过<code>network interface update ens160 aliases=&quot;172.18.3.20/24&quot;</code>及<code>netuork intertace commit</code>、<code>network intertace checkin</code>进行配置</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_b67f881228c4b541b897ce2b2d92fdc9.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_b67f881228c4b541b897ce2b2d92fdc9.png"></p><p>验证并配置网关及DNS</p><blockquote><p>必须先设置静态ip地址才能设置网关，否则提示网关不可达</p></blockquote><p>返回并选择<code>2 configure network settings</code>，然后配置网关及DNS信息</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_3ec55c9da582caec873b3c578e714f03.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_3ec55c9da582caec873b3c578e714f03.png"></p><p>此时，如果能够ping通管理IP地址，初始化工作就算完成</p><h3 id="TrueNAS-APP应用添加TrueCharts社区catalog目录"><a href="#TrueNAS-APP应用添加TrueCharts社区catalog目录" class="headerlink" title="TrueNAS APP应用添加TrueCharts社区catalog目录"></a>TrueNAS APP应用添加TrueCharts社区catalog目录</h3><p><strong>参考：</strong></p><ul><li><p><a href="https://gitee.com/truecharts/dh_catalog">https://gitee.com/truecharts/dh_catalog</a><br><a href="https://gitee.com/JerryFox/true-nas-catalog">https://gitee.com/JerryFox/true-nas-catalog</a><br><a href="https://www.cnblogs.com/Jerrycjc/p/17134915.html">https://www.cnblogs.com/Jerrycjc/p/17134915.html</a><br><a href="https://www.shiyunhao.cn/archives/truenasapp-ying-yong-tian-jia-truecharts-she-qu-catalog-mu-lu">https://www.shiyunhao.cn/archives/truenasapp-ying-yong-tian-jia-truecharts-she-qu-catalog-mu-lu</a></p></li><li><p>使用本地仓库</p><p><a href="https://gitee.com/apple-Teawine/true-nas-catalog.git">https://gitee.com/apple-Teawine/true-nas-catalog.git</a><br>main<br>stable,dependency,enterprise,incubator 分支</p></li></ul><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_58eba0a1e41467c84a152b151ce85a61.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_58eba0a1e41467c84a152b151ce85a61.png"></p><h3 id="什么是存储池"><a href="#什么是存储池" class="headerlink" title="什么是存储池"></a>什么是存储池</h3><p>存储池即为TrueNAS用于存放数据的地方，可以将多块硬盘组成不同的模式，用于实现数据存储的冗余和更快的读写行能</p><h3 id="关于raid"><a href="#关于raid" class="headerlink" title="关于raid:"></a>关于raid:</h3><p>与磁盘阵列卡的原理类似</p><ol><li><strong>条带模式</strong><br>每个磁盘用于存储数据。至少需要一个磁盘并且没有数据冗余。切勿使用条带模式存储关键数据！单个磁盘故障会导致 vdev 中的所有数据丢失。此模式下磁盘行能最佳，数据最不安全</li><li><strong>镜像</strong><br>每个磁盘中的数据都是相同的。至少需要两个磁盘，冗余最多，容量最少。</li><li><strong>Raid-z</strong><br>使用一个磁盘进行奇偶校验，而所有其他磁盘存储数据。至少需要三个磁盘。最多允许损坏1块硬盘数据仍能安全存储。</li><li><strong>Raid-z2</strong><br>使用两个磁盘进行奇偶校验，而所有其他磁盘都存储数据。至少需要四个磁盘。最多允许损坏2块硬盘数据仍能安全存储。</li><li><strong>Raid-z3</strong><br>使用三个磁盘进行奇偶校验，而所有其他磁盘都存储数据。至少需要五个磁盘。最多允许损坏3块硬盘数据仍能安全存储。</li></ol><h3 id="关于VDev类型"><a href="#关于VDev类型" class="headerlink" title="关于VDev类型"></a>关于VDev类型</h3><p>每个系统必须建立一个数据存储池，其余存储池可在数据存储池建立完成后添加或删除。</p><p><strong>1）数据</strong><br>用于主存储操作的标准 vdev。每个存储池至少需要一个数据vdev。</p><p><strong>2）缓存</strong><br>读取缓存与快速设备一起使用以加速读取操作。<br>TrueNAS存储顺序为内存-&gt;缓存存储池-&gt;数据存储池。<br>故使用大内存和大数据存储池可以有效提高数据存储行能</p><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a><strong>日志</strong></h3><p>提高同步写入速度的设备</p><p><strong>4）热备份</strong><br>为在活动驱动器发生故障时插入数据vdev保留的驱动器。热备件临时用作故障驱动器的替代品，以防止出现更大的池和数据丢失情况。</p><p>当故障驱动器更换为新驱动器时，热备件将恢复为非活动状态并再次用作热备件。</p><p>当故障驱动器仅从池中分离时，临时热备用将提升为完整的数据vdev 成员，并且不再可用作热备用。</p><p><strong>5）元数据</strong><br>一个特殊的 vdev 可以存储元数据，例如文件位置和分配表。特殊类中的分配专用于特定的块类型。默认情况下，这包括所有元数据、用户数据的间接块和任何重复数据删除表。该类也可以配置为接受小文件块。对于高性能但较小尺寸的固态存储来说，这是一个很好的用例。使用特殊的 vdev 极大地加速了随机 I/O，并将查找和访问文件所需的平均旋转磁盘 I/O 减少了一半。</p><p><strong>6）去重</strong><br>池可以包含共存的重复数据删除数据和非重复数据删除数据的任意组合。如果在写入时启用了重复数据删除，则使用 DDT 写入数据，如果在写入时未启用重复数据删除，则以非重复数据的方式写入数据。随后，数据将保持写入时的状态，直到被删除。简而言之就是将存储数据切割对比相同的部分会仅存储一份，但是这样会大量消耗CPU资源。</p><h3 id="五、关于加密"><a href="#五、关于加密" class="headerlink" title="五、关于加密"></a>五、关于加密</h3><p>加密算法可作为最大化数据安全性的选项。这也使检索数据的方式变得复杂，并有永久数据丢失的风险！</p><p>加密数据缺点/注意事项：</p><p>丢失加密密钥和密码意味着丢失您的数据。<br>不相关的加密数据集不支持重复数据删除。<br>我们不建议将 GELI 或 ZFS 加密与重复数据删除一起使用，因为这会对性能产生相当大的影响。<br>同时使用多个加密和重复数据删除功能时要小心，因为它们都将竞争相同的 CPU 周期。</p><p>本文参考：</p><p><a href="https://blog.csdn.net/qq_42910468/article/details/122585133">https://blog.csdn.net/qq_42910468/article/details/122585133</a></p><p><a href="https://blog.tonnp.com/2022/truenas-data-protection-manager.html">https://blog.tonnp.com/2022/truenas-data-protection-manager.html</a></p>]]></content>
      
      
      <categories>
          
          <category> nas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Minio单机与集群部署并使用nginx进行负载均衡</title>
      <link href="/2024/07/04/Minio%E5%8D%95%E6%9C%BA%E4%B8%8E%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E5%B9%B6%E4%BD%BF%E7%94%A8nginx%E8%BF%9B%E8%A1%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
      <url>/2024/07/04/Minio%E5%8D%95%E6%9C%BA%E4%B8%8E%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E5%B9%B6%E4%BD%BF%E7%94%A8nginx%E8%BF%9B%E8%A1%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Minio单机与集群部署并使用nginx进行负载均衡"><a href="#Minio单机与集群部署并使用nginx进行负载均衡" class="headerlink" title="Minio单机与集群部署并使用nginx进行负载均衡"></a>Minio单机与集群部署并使用nginx进行负载均衡</h1><p>集群版部署参考：<a href="https://wn.zznnwn.cloudns.biz/2023/09/19/minio%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8docker-compose%E9%83%A8%E7%BD%B2/?highlight=minio">gegewu_cloud</a></p><h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p><code>MinIO</code> 是一个开源的<strong>对象存储服务器</strong>，它兼容<code>Amazon S3（Simple Storage Service）API</code>。它被设计用于构建分布式存储架构，提供高可用性、高性能和可扩展的对象存储解决方案。</p><p>下面是MinIO的一些主要特点和功能：</p><ul><li><strong>对象存储</strong>：MinIO以对象为基本存储单元，可以存储和管理任意大小的文件、数据对象。它提供了标准的对象存储操作，如上传、下载、删除和元数据管理。</li><li><strong>分布式架构</strong>：MinIO采用分布式架构，可以在多个节点上部署，并将数据分布和复制在不同的节点上。这提供了高可用性和数据冗余，确保数据的持久性和可靠性。</li><li><strong>高性能</strong>：MinIO通过并行处理和分布式架构实现高性能的数据存取。它利用现代硬件和网络技术，充分利用多核处理器和高带宽网络，以实现快速的数据传输和处理。</li><li><strong>水平扩展</strong>：MinIO可以水平扩展，通过添加更多的节点来增加存储容量和吞吐量。它支持自动数据分片和负载均衡，确保数据在各个节点上均匀分布和访问的负载均衡。</li><li><strong>数据保护</strong>：MinIO提供了多种数据保护机制，包括数据冗余、故障转移和数据校验。它可以在不同的节点之间复制数据，以应对节点故障和数据损坏的情况。</li><li><strong>安全性</strong>：MinIO支持数据加密和访问控制，保护存储在其中的数据的安全性和隐私性。它提供了传输层加密（TLS/SSL）和服务器端加密选项，以及身份验证和访问控制机制。</li></ul><p>总的来说，MinIO是一个开源的高性能对象存储服务器，适用于构建分布式存储系统。它具有高可用性、可扩展性和数据保护机制，兼容Amazon S3 API，使其与现有的S3生态系统和工具集成无缝。MinIO在大数据、云计算和容器化环境中广泛应用，为应用程序提供了可靠、高效的对象存储服务。</p><p>这里主要侧重使用docker快速部署环境，想了解更多，可以参考我以下几篇文章：</p><ul><li><a href="https://www.cnblogs.com/liugp/p/16558869.html">高性能分布式对象存储——MinIO（环境部署）</a></li><li><a href="https://www.cnblogs.com/liugp/p/16560313.html">高性能分布式对象存储——MinIO实战操作（MinIO扩容）</a></li><li><a href="https://www.cnblogs.com/liugp/p/16884294.html">【云原生】Minio on k8s 讲解与实战操作</a></li><li><a href="https://www.cnblogs.com/liugp/p/16632616.html">【云原生.大数据】镜像仓库Harbor对接MinIO对象存储</a></li></ul><p>官方文档：<a href="https://docs.min.io/">https://docs.min.io/</a><br>中文文档：<a href="http://docs.minio.org.cn/docs/">http://docs.minio.org.cn/docs/</a></p><h2 id="二、MinIO-与-Ceph-对比"><a href="#二、MinIO-与-Ceph-对比" class="headerlink" title="二、MinIO 与 Ceph 对比"></a>二、MinIO 与 Ceph 对比</h2><p>MinIO和Ceph都是流行的开源存储解决方案，它们在对象存储领域有不同的特点和适用场景。下面是MinIO和Ceph的对比：</p><h3 id="1）架构设计对比"><a href="#1）架构设计对比" class="headerlink" title="1）架构设计对比"></a>1）架构设计对比</h3><ul><li>**<code>MinIO</code>**：<code>MinIO</code>采用分布式架构，以水平扩展为基础。它通过多个独立的MinIO节点组成集群，每个节点都是独立的对象存储服务器。MinIO专注于提供简单、轻量级的对象存储服务，适用于小型到中等规模的部署。</li><li>**<code>Ceph</code>**：<code>Ceph</code>是一个分布式存储系统，由对象存储、块存储和文件系统组成。它使用<code>RADOS（Reliable Autonomic Distributed Object Store）</code>作为底层存储系统，提供高可用性和数据冗余。Ceph适用于大规模的企业级部署，具有复杂的架构和丰富的功能。</li></ul><h3 id="2）数据一致性对比"><a href="#2）数据一致性对比" class="headerlink" title="2）数据一致性对比"></a>2）数据一致性对比</h3><ul><li><code>MinIO</code>：<code>MinIO</code>在默认配置下提供最终一致性，即写入操作返回成功后，数据可能会有一定的时间窗口内的延迟才能完全一致。这适用于许多应用场景，如数据备份、存档等。</li><li><code>Ceph</code>：<code>Ceph</code>提供强一致性，即写入操作在返回成功后，数据即刻就达到一致性。这对于需要强一致性保证的应用场景非常重要，如数据库和事务处理。</li></ul><h3 id="3）部署和管理对比"><a href="#3）部署和管理对比" class="headerlink" title="3）部署和管理对比"></a>3）部署和管理对比</h3><ul><li><code>MinIO</code>：<code>MinIO</code> 的部署和管理相对简单，可以通过单个二进制文件或容器进行快速安装和配置。它提供了直观的管理界面和易于使用的API，使得管理和监控变得简单。</li><li><code>Ceph</code>：<code>Ceph</code> 的部署和管理相对复杂，涉及多个组件和配置。它需要更多的时间和专业知识来设置和维护，需要熟悉Ceph的架构和配置。</li></ul><h3 id="4）生态系统和兼容性对比"><a href="#4）生态系统和兼容性对比" class="headerlink" title="4）生态系统和兼容性对比"></a>4）生态系统和兼容性对比</h3><ul><li><code>MinIO</code>：MinIO与Amazon S3 API兼容，这意味着现有的S3工具和应用程序可以无缝地与MinIO集成。它还有一个活跃的社区，提供了各种客户端库和插件，扩展了其功能和兼容性。</li><li><code>Ceph</code>：<code>Ceph</code> 具有广泛的生态系统和丰富的功能集。它可以与多个协议和接口（如RADOS、RBD、CephFS）进行集成，提供块存储、文件系统和对象存储的全面解决方案。</li></ul><p>综上所述，<strong>MinIO适用于简单、轻量级的对象存储需求</strong>，注重高性能和易用性。它适合中小规模部署，并且与Amazon S3兼容，易于与现有的S3生态系统集成。</p><ul><li><strong><code>Ceph</code>则适用于大规模、复杂的企业级存储需求</strong>。它提供强一致性和丰富的功能集，适合需要高可用性、数据冗余和复杂数据操作的场景。Ceph的部署和管理相对复杂，需要更多的配置和管理工作。</li><li>选择<code>MinIO</code>还是Ceph取决于具体的需求和场景。如果你需要一个简单、易用、高性能的对象存储解决方案，并与S3兼容，那么MinIO是一个不错的选择。如果你需要一个功能强大、可扩展、支持块存储和文件系统的分布式存储系统，且具备强一致性的要求，那么Ceph是更适合的选择。</li></ul><p>无论选择MinIO还是Ceph，都需要仔细评估其与特定应用和环境的兼容性、性能需求、管理复杂性和可扩展性，以确保选择的解决方案能够满足实际需求并提供可靠的存储服务</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_b2fb09978ee530f5ab2104827399da13.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_b2fb09978ee530f5ab2104827399da13.png"></p><p>docker-compose部署（本教程使用最新镜像）</p><p>镜像可选</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">minio/minio</span><br><span class="line">minio/minio:RELEASE.2021-06-17T00-10-46Z   <span class="comment"># 此镜像测试不可用</span></span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:minio-latest</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:minio-RELEASE.2022-08-02T23-59-16Z</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:minio-latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">&quot;minio&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9000</span><span class="string">:9000</span> <span class="comment"># api 端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9001</span><span class="string">:9001</span> <span class="comment"># 控制台端口</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MINIO_ACCESS_KEY:</span> <span class="string">admin</span>    <span class="comment">#管理后台用户名</span></span><br><span class="line">      <span class="attr">MINIO_SECRET_KEY:</span> <span class="string">admin123</span> <span class="comment">#管理后台密码，最小8个字符</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./minio/data:/data</span>               <span class="comment">#映射当前目录下的data目录至容器内/data目录</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./minio/config:/root/.minio/</span>     <span class="comment">#映射配置目录</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">--console-address</span> <span class="string">&#x27;:9001&#x27;</span> <span class="string">/data</span>  <span class="comment">#指定容器中的目录 /data</span></span><br></pre></td></tr></table></figure><h4 id="控制台创建密钥后-s3连接工具远程连接测试"><a href="#控制台创建密钥后-s3连接工具远程连接测试" class="headerlink" title="控制台创建密钥后 s3连接工具远程连接测试"></a>控制台创建密钥后 s3连接工具远程连接测试</h4><ul><li>api地址端口：9000（专门用于例如s3工具代码等连接）</li><li>控制台端口：9001 （不要混淆 ）</li><li>创建ak/sk填入 登录即可</li></ul><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_c10039e5dafefbca1a39bd41f3a4446f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_c10039e5dafefbca1a39bd41f3a4446f.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_4e2f319e335ef3c6984eb2e115d2955b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_4e2f319e335ef3c6984eb2e115d2955b.png"></p><p>备注：单机版没有数据冗余 数据只存放于挂载的唯一卷./minio/data中  文章首页教程 里面均为至少两磁盘冗余</p><h3 id="三-集群部署并使用nginx进行负载均衡"><a href="#三-集群部署并使用nginx进行负载均衡" class="headerlink" title="三. 集群部署并使用nginx进行负载均衡"></a>三. 集群部署并使用nginx进行负载均衡</h3><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h3><p>分布式 Minio 可以让你将多块硬盘或者多台服务器组成一个对象存储服务。由于硬盘分布在不同的节点上，分布式 Minio 避免了单点故障。MinioMinio分布式模式可以帮助你搭建一个高可用的对象存储服务，你可以使用这些存储设备，而不用考虑其真实物理位置。</p><h3 id="2-Minio分布式部署的优势"><a href="#2-Minio分布式部署的优势" class="headerlink" title="#2. Minio分布式部署的优势"></a><a href="https://www.elibaron.com/arch/minio/minio-cluster-deploy.html#_2-minio%E5%88%86%E5%B8%83%E5%BC%8F%E9%83%A8%E7%BD%B2%E7%9A%84%E4%BC%98%E5%8A%BF">#</a>2. Minio分布式部署的优势</h3><h3 id="2-1-数据保护"><a href="#2-1-数据保护" class="headerlink" title="#2.1 数据保护"></a><a href="https://www.elibaron.com/arch/minio/minio-cluster-deploy.html#_2-1-%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4">#</a>2.1 数据保护</h3><ul><li>分布式 Minio 采用纠删码来防范多个节点宕机和位衰减。</li><li>分布式 Minio 至少需要 4 个节点（4台服务器），使用分布式 Minio 就 自动引入了纠删码功能。</li><li>纠删码是一种恢复丢失和损坏数据的数学算法， Minio 采用 Reed-Solomon code 将对象拆分成 N/2 数据和 N/2 奇偶校验块。 这就意味着如果是 12 块盘，一个对象会被分成 6 个数据块、6 个奇偶校验块，你可以丢失任意 6 块盘（不管其是存放的数据块还是奇偶校验块），你仍可以从剩下的盘中的数据进行恢复。</li><li>纠删码的工作原理和 RAID 或者复制不同，像 RAID6 可以在损失两块盘的情况下不丢数据，而 Minio 纠删码可以在丢失一半的盘的情况下，仍可以保证数据安全。 而且 Minio 纠删码是作用在对象级别，可以一次恢复一个对象，而RAID 是作用在卷级别，数据恢复时间很长。 Minio 对每个对象单独编码，存储服务一经部署，通常情况下是不需要更换硬盘或者修复。Minio 纠删码的设计目标是为了性能和尽可能的使用硬件加速。</li><li>位衰减又被称为数据腐化 Data Rot、无声数据损坏 Silent Data Corruption ，是目前硬盘数据的一种严重数据丢失问题。硬盘上的数据可能会神不知鬼不觉就损坏了，也没有什么错误日志。正所谓明枪易躲，暗箭难防，这种背地里犯的错比硬盘直接故障还危险。 所以 Minio 纠删码采用了高速 HighwayHash 基于哈希的校验和来防范位衰减。</li></ul><h3 id="2-2-高可用"><a href="#2-2-高可用" class="headerlink" title="#2.2 高可用"></a><a href="https://www.elibaron.com/arch/minio/minio-cluster-deploy.html#_2-2-%E9%AB%98%E5%8F%AF%E7%94%A8">#</a>2.2 高可用</h3><ul><li>单机 Minio 服务存在单点故障，相反，如果是一个 N 节点的分布式 Minio ,只要有 N/2 节点在线，你的数据就是安全的。不过你需要至少有 N/2+1 个节点来创建新的对象。</li><li>例如，一个 8 节点的 Minio 集群，每个节点一块盘，就算 4 个节点宕机，这个集群仍然是可读的，不过你需要 5 个节点才能写数据。</li></ul><h3 id="2-3-限制"><a href="#2-3-限制" class="headerlink" title="#2.3 限制"></a><a href="https://www.elibaron.com/arch/minio/minio-cluster-deploy.html#_2-3-%E9%99%90%E5%88%B6">#</a>2.3 限制</h3><ul><li>分布式 Minio 单租户存在最少 4 个盘最多 16 个盘的限制（受限于纠删码）。这种限制确保了 Minio 的简洁，同时仍拥有伸缩性。如果你需要搭建一个多租户环境，你可以轻松的使用编排工具（Kubernetes）来管理多个Minio实例。</li><li>注意，只要遵守分布式 Minio 的限制，你可以组合不同的节点和每个节点几块盘。比如，你可以使用 2 个节点，每个节点 4 块盘，也可以使用 4 个节点，每个节点两块盘，诸如此类。</li></ul><h3 id="2-4-一致性"><a href="#2-4-一致性" class="headerlink" title="#2.4 一致性"></a><a href="https://www.elibaron.com/arch/minio/minio-cluster-deploy.html#_2-4-%E4%B8%80%E8%87%B4%E6%80%A7">#</a>2.4 一致性</h3><ul><li>Minio 在分布式和单机模式下，所有读写操作都严格遵守 read-after-write 一致性模型。</li></ul><h3 id="2-5-搭建"><a href="#2-5-搭建" class="headerlink" title="2.5 搭建"></a>2.5 搭建</h3><p>本次搭建使用两节点（故障一个节点便只能读不能写）</p><table><thead><tr><th>节点</th><th>IP</th><th>备注</th></tr></thead><tbody><tr><td>minio1</td><td>10.0.0.10</td><td></td></tr><tr><td>minio2</td><td>10.0.0.11</td><td></td></tr></tbody></table><p>写入host配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">10.0.0.10 minio1</span></span><br><span class="line"><span class="string">10.0.0.11 minio2</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure><p>docker-compose配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.7&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:minio-latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">minio1</span>            <span class="comment"># 每个节点修改成不同的名字</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">minio1</span>      <span class="comment"># 每个节点修改成不同的名字</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_USER:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_PASSWORD:</span> <span class="number">123456789</span></span><br><span class="line">      <span class="attr">MINIO_PROMETHEUS_AUTH_TYPE:</span> <span class="string">public</span></span><br><span class="line">      <span class="attr">MINIO_PROMETHEUS_JOB_ID:</span> <span class="string">minio-job</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;minio1:10.0.0.10&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;minio2:10.0.0.11&quot;</span></span><br><span class="line">      <span class="comment"># - &quot;minio03:192.168.1.103&quot;</span></span><br><span class="line">      <span class="comment"># - &quot;minio04:192.168.1.104&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9000</span><span class="string">:9000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9001</span><span class="string">:9001</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data:/data</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">--address</span> <span class="string">&quot;:9000&quot;</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span> <span class="string">http://minio&#123;1...2&#125;/data</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">&quot;host&quot;</span></span><br></pre></td></tr></table></figure><p>备注： 只需要将hostname与container_name编写为对应节点 在不同节点分别启动docker-compose.yml文件即可</p><p>二个节点依次启动✌ ： docker-compose up -d</p><p>成功后日志显示如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="string">MinIO</span> <span class="string">Object</span> <span class="string">Storage</span> <span class="string">Server</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">Copyright:</span> <span class="number">2015</span><span class="number">-2024</span> <span class="string">MinIO,</span> <span class="string">Inc.</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">License:</span> <span class="string">GNU</span> <span class="string">AGPLv3</span> <span class="string">&lt;https://www.gnu.org/licenses/agpl-3.0.html&gt;</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">Version:</span> <span class="string">RELEASE.2024-04-18T19-09-19Z</span> <span class="string">(go1.21.9</span> <span class="string">linux/amd64)</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">API:</span> <span class="string">http://10.0.0.11:9001</span>  <span class="string">http://172.17.0.1:9001</span>  <span class="string">http://172.19.0.1:9001</span>  <span class="string">http://172.20.0.1:9001</span>  <span class="string">http://127.0.0.1:9001</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">WebUI:</span> <span class="string">http://10.0.0.11:50001</span> <span class="string">http://172.17.0.1:50001</span> <span class="string">http://172.19.0.1:50001</span> <span class="string">http://172.20.0.1:50001</span> <span class="string">http://127.0.0.1:50001</span>  </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">Docs:</span> <span class="string">https://min.io/docs/minio/linux/index.html</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">Status:</span>         <span class="number">2</span> <span class="string">Online,</span> <span class="number">0</span> <span class="string">Offline.</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="string">http://minio1:9001/minio/storage/data/v57%!(EXTRA</span> <span class="string">time.Duration=14.132179253s)</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">Exiting on signal:</span> <span class="string">TERMINATED</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span>  <span class="string">You</span> <span class="string">are</span> <span class="string">running</span> <span class="string">an</span> <span class="string">older</span> <span class="string">version</span> <span class="string">of</span> <span class="string">MinIO</span> <span class="string">released</span> <span class="number">4</span> <span class="string">months</span> <span class="string">before</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">release</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span>  <span class="attr">Update:</span> <span class="string">Run</span> <span class="string">`mc</span> <span class="string">admin</span> <span class="string">update</span> <span class="string">ALIAS`</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">all</span> <span class="string">MinIO</span> <span class="string">sub-systems</span> <span class="string">to</span> <span class="string">be</span> <span class="string">initialize...</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">Automatically configured API requests per node based on available memory on the system:</span> <span class="number">98</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="string">All</span> <span class="string">MinIO</span> <span class="string">sub-systems</span> <span class="string">initialized</span> <span class="string">successfully</span> <span class="string">in</span> <span class="number">5.</span><span class="string">916121ms</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="string">MinIO</span> <span class="string">Object</span> <span class="string">Storage</span> <span class="string">Server</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">Copyright:</span> <span class="number">2015</span><span class="number">-2024</span> <span class="string">MinIO,</span> <span class="string">Inc.</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">License:</span> <span class="string">GNU</span> <span class="string">AGPLv3</span> <span class="string">&lt;https://www.gnu.org/licenses/agpl-3.0.html&gt;</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">Version:</span> <span class="string">RELEASE.2024-04-18T19-09-19Z</span> <span class="string">(go1.21.9</span> <span class="string">linux/amd64)</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">API:</span> <span class="string">http://10.0.0.11:9001</span>  <span class="string">http://172.17.0.1:9001</span>  <span class="string">http://172.19.0.1:9001</span>  <span class="string">http://172.20.0.1:9001</span>  <span class="string">http://127.0.0.1:9001</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">WebUI:</span> <span class="string">http://10.0.0.11:50001</span> <span class="string">http://172.17.0.1:50001</span> <span class="string">http://172.19.0.1:50001</span> <span class="string">http://172.20.0.1:50001</span> <span class="string">http://127.0.0.1:50001</span>  </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> </span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">Docs:</span> <span class="string">https://min.io/docs/minio/linux/index.html</span></span><br><span class="line"><span class="string">minio2</span>  <span class="string">|</span> <span class="attr">Status:</span>         <span class="number">2</span> <span class="string">Online,</span> <span class="number">0</span> <span class="string">Offline.</span> </span><br></pre></td></tr></table></figure><h3 id="效果："><a href="#效果：" class="headerlink" title="效果："></a>效果：</h3><p>1.使用命令行验证：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@k8s1:/opt/minio<span class="comment"># docker exec -it minio2 bash</span></span><br><span class="line">bash-5.1<span class="comment"># mc config host add minio http://localhost:9000</span></span><br><span class="line">Enter Access Key: admin</span><br><span class="line">Enter Secret Key: </span><br><span class="line">Added `minio` successfully.</span><br><span class="line">bash-5.1<span class="comment"># mc admin info minio</span></span><br><span class="line">●  minio1:9000</span><br><span class="line">   Uptime: 42 minutes </span><br><span class="line">   Version: 2024-04-18T19:09:19Z</span><br><span class="line">   Network: 2/2 OK </span><br><span class="line">   Drives: 1/1 OK </span><br><span class="line">   Pool: 1</span><br><span class="line"></span><br><span class="line">●  minio2:9000</span><br><span class="line">   Uptime: 44 minutes </span><br><span class="line">   Version: 2024-04-18T19:09:19Z</span><br><span class="line">   Network: 2/2 OK </span><br><span class="line">   Drives: 1/1 OK </span><br><span class="line">   Pool: 1</span><br><span class="line"></span><br><span class="line">Pools:</span><br><span class="line">   1st, Erasure sets: 1, Drives per erasure <span class="built_in">set</span>: 2</span><br><span class="line"></span><br><span class="line">165 MiB Used, 1 Bucket, 6 Objects</span><br><span class="line">2 drives online, 0 drives offline</span><br></pre></td></tr></table></figure><p>2.访问地址：</p><p><a href="http://10.0.0.10:9001/">http://10.0.0.10:9001</a></p><p><a href="http://10.0.0.11:9001/">http://10.0.0.11:9001</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_80d4c317adbea538710314fdc23fc7ec.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_80d4c317adbea538710314fdc23fc7ec.png"></p><h3 id="2-6-使用nginx进行负载均衡"><a href="#2-6-使用nginx进行负载均衡" class="headerlink" title="2.6 使用nginx进行负载均衡"></a>2.6 使用nginx进行负载均衡</h3><p>拓补图：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_79c6f4e1380df8c0bc41081b9f00d653.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_79c6f4e1380df8c0bc41081b9f00d653.png"></p><p>在节点1部署nginx参考 <a href="https://wn.zznnwn.cloudns.biz/2023/05/15/%E7%BC%96%E8%AF%91%E9%83%A8%E7%BD%B2nginx/?highlight=nginx">使用脚本编译部署nginx部署</a></p><p>部署完成后遇到nginx转发访问端口访问存储桶一直loading…问题 参考：<a href="https://blog.csdn.net/qq_25231683/article/details/128734555">【解决】使用Nginx给minio做代理转发 进入管理界面查看桶一直显示loading问题_nginx 代理 minio websocket</a> 大致信息如下</p><h4 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h4><p>按F12查看了一下，查看桶发起的是 <strong>websocket</strong> 请求。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_43ea567b825c0da4a7070cfbafc90dce.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_43ea567b825c0da4a7070cfbafc90dce.png"></p><h4 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h4><p>在 <a href="https://so.csdn.net/so/search?q=nginx%E9%85%8D%E7%BD%AE&spm=1001.2101.3001.7020">nginx配置</a> 上加上websocket支持</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 添加了websocket支持</span><br><span class="line">proxy_http_version      1.1;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_next_upstream     http_500 http_502 http_503 http_504 error timeout invalid_header;</span><br><span class="line">proxy_set_header        Host  $http_host;</span><br><span class="line">proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></pre></td></tr></table></figure><p>Nginx负载minio集群完整配置文件如下（在配置文件最后大括号内<code>&#125;</code>加入负载均衡配置即可）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    root           html;</span></span><br><span class="line">        <span class="comment">#    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line">        <span class="comment">#    fastcgi_index  index.php;</span></span><br><span class="line">        <span class="comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class="line">        <span class="comment">#    include        fastcgi_params;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">        <span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">        <span class="comment">#    deny  all;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># another virtual host using mix of IP-, name-, and port-based configuration</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       8000;</span></span><br><span class="line">    <span class="comment">#    listen       somename:8080;</span></span><br><span class="line">    <span class="comment">#    server_name  somename  alias  another.alias;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># HTTPS server</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       443 ssl;</span></span><br><span class="line">    <span class="comment">#    server_name  localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_certificate      cert.pem;</span></span><br><span class="line">    <span class="comment">#    ssl_certificate_key  cert.key;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_session_cache    shared:SSL:1m;</span></span><br><span class="line">    <span class="comment">#    ssl_session_timeout  5m;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span></span><br><span class="line">    <span class="comment">#    ssl_prefer_server_ciphers  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">upstream minio_cluster &#123;</span><br><span class="line">    server 10.0.0.10:9001;</span><br><span class="line">    server 10.0.0.11:9001;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream minio_api &#123;</span><br><span class="line">    server 10.0.0.10:9000;</span><br><span class="line">    server 10.0.0.11:9000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 8088;</span><br><span class="line">    server_name 10.0.0.10 localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># To allow special characters in headers</span></span><br><span class="line">    ignore_invalid_headers off;</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Allow any size file to be uploaded.</span></span><br><span class="line">    <span class="comment"># Set to a value such as 1000m; to restrict file size to a specific value</span></span><br><span class="line">    client_max_body_size 100m;</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># To disable buffering</span></span><br><span class="line">    proxy_buffering off;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">        proxy_connect_timeout 300;</span><br><span class="line">  </span><br><span class="line">        proxy_set_header Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">        chunked_transfer_encoding off;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加了websocket支持</span></span><br><span class="line">        <span class="comment"># Default is HTTP/1, keepalive is only enabled in HTTP/1.1</span></span><br><span class="line">        proxy_http_version      1.1;</span><br><span class="line">        proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        proxy_set_header Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">        proxy_next_upstream     http_500 http_502 http_503 http_504 error <span class="built_in">timeout</span> invalid_header;</span><br><span class="line">        proxy_set_header        Host  <span class="variable">$http_host</span>;</span><br><span class="line">        proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://minio_cluster;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 8089;</span><br><span class="line">    server_name 10.0.0.10 localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># To allow special characters in headers</span></span><br><span class="line">    ignore_invalid_headers off;</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Allow any size file to be uploaded.</span></span><br><span class="line">    <span class="comment"># Set to a value such as 1000m; to restrict file size to a specific value</span></span><br><span class="line">    client_max_body_size 100m;</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># To disable buffering</span></span><br><span class="line">    proxy_buffering off;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">        proxy_connect_timeout 300;</span><br><span class="line"></span><br><span class="line">        proxy_set_header Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">        chunked_transfer_encoding off;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加了websocket支持</span></span><br><span class="line">        <span class="comment"># Default is HTTP/1, keepalive is only enabled in HTTP/1.1</span></span><br><span class="line">        proxy_http_version      1.1;</span><br><span class="line">        proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        proxy_set_header Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">        proxy_next_upstream     http_500 http_502 http_503 http_504 error <span class="built_in">timeout</span> invalid_header;</span><br><span class="line">        proxy_set_header        Host  <span class="variable">$http_host</span>;</span><br><span class="line">        proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://minio_api;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>systemctl restart nginx 生效🌹</p><p>此时在浏览器访问部署nginx的服务器：<a href="http://10.0.0.10:8088/">http://10.0.0.10:8088</a> 输入yaml文件中定义的账户密码 即可实现负载均衡到不同的服务器</p><h4 id="最后：-验证负载均衡是否成功（成功）"><a href="#最后：-验证负载均衡是否成功（成功）" class="headerlink" title="最后： 验证负载均衡是否成功（成功）"></a>最后： 验证负载均衡是否成功（成功）</h4><p>步骤：</p><ul><li>手动挂载部署nginx的节点10.0.0.10上面的minio服务 测试浏览器访问 <a href="http://10.0.0.10:8088看服务是否正常">http://10.0.0.10:8088看服务是否正常</a><br>停止minio1时浏览器服务正常</li><li>将两节点minio停止访问 <a href="http://10.0.0.10:8088看服务是否正常">http://10.0.0.10:8088看服务是否正常</a><br>停止minio1和minio2后浏览器访问报错  (下方浏览器截图为之前端口为8089时所截 暂保留 此教程nginx转发minio web端口为8088)</li><li><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_69862aee2ae62f564cfab982170e672e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_69862aee2ae62f564cfab982170e672e.png"></li></ul><p>本文参考：</p><p><a href="https://www.cnblogs.com/liugp/p/17504098.html">【大数据】通过 docker-compose 快速部署 MinIO 保姆级教程 - 大数据老司机 - 博客园 (cnblogs.com)</a></p><p><a href="https://cloud.tencent.com/developer/article/2133450">基于 docker-compose 部署 Minio 分布式集群-腾讯云开发者社区-腾讯云 (tencent.com)</a></p><p><a href="https://www.cnblogs.com/liugp/p/17504098.html">【大数据】通过 docker-compose 快速部署 MinIO 保姆级教程 - 大数据老司机 - 博客园 (cnblogs.com)</a></p><p><a href="https://blog.csdn.net/majixiang1996/article/details/105600369">使用nginx对集群模式的minio做负载均衡_minio负载均衡</a></p><p><a href="https://blog.csdn.net/qq_25231683/article/details/128734555">【解决】使用Nginx给minio做代理转发 进入管理界面查看桶一直显示loading问题_nginx 代理 minio websocket</a></p>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PVE虚拟机直通英伟达GPU显卡完全指南</title>
      <link href="/2024/07/02/PVE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9B%B4%E9%80%9A%E8%8B%B1%E4%BC%9F%E8%BE%BEGPU%E6%98%BE%E5%8D%A1%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/"/>
      <url>/2024/07/02/PVE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9B%B4%E9%80%9A%E8%8B%B1%E4%BC%9F%E8%BE%BEGPU%E6%98%BE%E5%8D%A1%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="PVE虚拟机直通英伟达GPU显卡完全指南"><a href="#PVE虚拟机直通英伟达GPU显卡完全指南" class="headerlink" title="PVE虚拟机直通英伟达GPU显卡完全指南"></a>PVE虚拟机直通英伟达GPU显卡完全指南</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="http://sunlight.zznnwn.cloudns.biz/2024/07/01/Pve%E9%83%A8%E7%BD%B2%E6%8A%A5%E9%94%99Cannot%20run%20in%20framebuffer%20mode.%20Please%20specify%20busIos%20%E8%A7%A3%E5%86%B3/">部署pve报错解决</a></p><p>本教程在pve宿主机执行</p><h2 id="一-前提条件"><a href="#一-前提条件" class="headerlink" title="一. 前提条件"></a>一. 前提条件</h2><p>Bios开启VT-d HD-t</p><p><strong>1、确认CPU是否支持<code>VT-D</code></strong></p><ul><li><strong>Inter官网查询：</strong> <a href="https://www.intel.cn/">https://www.intel.cn</a></li><li><strong>AMD官方网站：</strong> <a href="https://www.amd.com/zh-hans">https://www.amd.com/zh-hans</a></li><li><ul><li><strong>例：</strong> <em><a href="https://ark.intel.com/content/www/cn/zh/ark/products/97122/intel-core-i77700t-processor-8m-cache-up-to-3-80-ghz.html#tab-blade-1-0-7">i7-7700 查询结果</a></em></li></ul></li></ul><p><strong>2、确保启动方式为<code>gurb</code>，非<code>systemd-boot</code></strong><br>如果启动方式为<code>systemd-boot</code>，在<strong>0x02</strong>步骤中需要参考 <a href="https://pve.proxmox.com/pve-docs/pve-admin-guide.html#sysboot_edit_kernel_cmdline">[3] Proxmox VE Administration Guide</a> 开启iommu功能 或参考本文末尾下方<a href="https://blog.dako.dev/proxmox-7-4-gpu-passthrough--e6-98-be-e5-8d-a1-e7-9b-b4-e9-80-9a/">第二链接</a> 即 <code>proxmox-boot-tool refresh</code></p><h2 id="二-开启IOMMU功能"><a href="#二-开启IOMMU功能" class="headerlink" title="二. 开启IOMMU功能"></a>二. 开启IOMMU功能</h2><p>编辑文件/etc/default/grub，修改<code>GRUB_CMDLINE_LINUX_DEFAULT</code>字段值</p><p>如果为Intel的CPU</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=<span class="string">&quot;quiet intel_iommu=on&quot;</span></span><br></pre></td></tr></table></figure><p>如果为AMD的CPU</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=<span class="string">&quot;quiet amd_iommu=on&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_3170d8505684902d0828f4adc8f464bb.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_3170d8505684902d0828f4adc8f464bb.png"></p><h2 id="三-添加VT-D功能的内核模块"><a href="#三-添加VT-D功能的内核模块" class="headerlink" title="三. 添加VT-D功能的内核模块"></a>三. 添加<code>VT-D</code>功能的内核模块</h2><p>打开文件<code>/etc/modules</code>，新增以下4行内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vfio</span><br><span class="line">vfio_iommu_type1</span><br><span class="line">vfio_pci</span><br><span class="line">vfio_virqfd</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_922e9e8bc8602c37be9a95b4b4cfbac7.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_922e9e8bc8602c37be9a95b4b4cfbac7.png"></p><h2 id="四-屏蔽宿主机显卡驱动"><a href="#四-屏蔽宿主机显卡驱动" class="headerlink" title="四. 屏蔽宿主机显卡驱动"></a>四. 屏蔽宿主机显卡驱动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 屏蔽镭龙显卡驱动</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;blacklist radeon&quot;</span> &gt;&gt; /etc/modprobe.d/pve-blacklist.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 屏蔽英伟达显卡的开源nouveau驱动</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;blacklist nouveau&quot;</span> &gt;&gt; /etc/modprobe.d/pve-blacklist.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 屏蔽英伟达显卡驱动</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;blacklist nvidia&quot;</span> &gt;&gt; /etc/modprobe.d/pve-blacklist.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_eaab6c3d231a8dae5e02514fd79eea14.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_eaab6c3d231a8dae5e02514fd79eea14.png"></p><h2 id="五-其它参数"><a href="#五-其它参数" class="headerlink" title="五. 其它参数"></a>五. 其它参数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许不安全的中断</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;options vfio_iommu_type1 allow_unsafe_interrupts=1&quot;</span> &gt; /etc/modprobe.d/iommu_unsafe_interrupts.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 忽略异常，防止虚拟机异常导致宿主机崩溃</span></span><br><span class="line"><span class="comment">#   ignore_msrs             :   忽略异常</span></span><br><span class="line"><span class="comment">#   report_ignored_msrs     :   是否报告异常</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;options kvm ignore_msrs=1 report_ignored_msrs=0&quot;</span> &gt; /etc/modprobe.d/kvm.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_8e63746854064a712ab3519c84a8afae.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_8e63746854064a712ab3519c84a8afae.png"></p><h2 id="六-配置VFIO"><a href="#六-配置VFIO" class="headerlink" title="六. 配置VFIO"></a>六. 配置VFIO</h2><p><em>ps：执行此操作后可能无法输出到外接显示器，若出现此情况，请撤回该步骤</em></p><p><strong>1、查看显卡ID</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@pve:~<span class="comment"># lspci -nn | grep VGA</span></span><br><span class="line">01:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:2685] (rev a1)</span><br></pre></td></tr></table></figure><p>N卡编号为01:00，搜索对应的设备ID和音频设备ID</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@pve:~<span class="comment"># lspci -n -s 01:00</span></span><br><span class="line">01:00.0 0300: 10de:2685 (rev a1)</span><br><span class="line">01:00.1 0403: 10de:22ba (rev a1)</span><br></pre></td></tr></table></figure><p><strong>或者直接以<code>NVIDIA</code>为关键词搜索相关的设备，其中一个是音频</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@pve:~<span class="comment"># lspci -nn | grep NVIDIA</span></span><br><span class="line">01:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:2685] (rev a1)</span><br><span class="line">01:00.1 Audio device [0403]: NVIDIA Corporation AD102 High Definition Audio Controller [10de:22ba] (rev a1)</span><br></pre></td></tr></table></figure><p><strong>得到显卡的设备ID和显卡内置音频设备ID为：</strong></p><ul><li><code>显卡ID</code>： <em>10de:2685</em></li><li><code>音频ID</code>： <em>10de:22ba</em></li></ul><p><strong>2、将设备ID添加到<code>vfio.conf</code></strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;options vfio-pci ids=10de:2685,10de:22ba disable_vga=1&quot;</span> &gt; /etc/modprobe.d/vfio.conf</span><br><span class="line"><span class="comment"># 如果无法输出到外接显示器，取消disable_vga=1参数试试</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;options vfio-pci ids=10de:2685,10de:22ba&quot;</span> &gt; /etc/modprobe.d/vfio.conf</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_d97846f7bd4dc84cc26efca3ae8b9d1a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_d97846f7bd4dc84cc26efca3ae8b9d1a.png"></p><h2 id="七-应用更改"><a href="#七-应用更改" class="headerlink" title="七. 应用更改"></a>七. 应用更改</h2><ul><li><p><strong>1、刷新更改</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">update-grub</span><br><span class="line">update-initramfs -u -k all</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_088397be69bb3731e3594f4f49245bd7.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_088397be69bb3731e3594f4f49245bd7.png"></p></li><li><p><strong>2、重启PVE</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure></li><li><p><strong>3、检查是否配置成功</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@pve:~<span class="comment"># lspci -nnk</span></span><br><span class="line">01:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:2685] (rev a1)</span><br><span class="line">        Subsystem: Shenzhen Colorful Yugong Technology and Development Co. Device [7377:1400]</span><br><span class="line">        Kernel driver <span class="keyword">in</span> use: vfio-pci</span><br><span class="line">        Kernel modules: nvidiafb, nouveau</span><br><span class="line">01:00.1 Audio device [0403]: NVIDIA Corporation AD102 High Definition Audio Controller [10de:22ba] (rev a1)</span><br><span class="line">        Subsystem: Shenzhen Colorful Yugong Technology and Development Co. AD102 High Definition Audio Controller [7377:1400]</span><br><span class="line">        Kernel driver <span class="keyword">in</span> use: vfio-pci</span><br><span class="line">        Kernel modules: snd_hda_intel</span><br></pre></td></tr></table></figure></li></ul><p>如果看到<code>Kernel driver in use: vfio-pci</code>，表示应用成功</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_2867de7d79e4bcc5b8934e10af67e9bb.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_2867de7d79e4bcc5b8934e10af67e9bb.png"></p><p>添加显卡到虚拟机中<br>完成上述步骤配置后，在PVE-web图形化端添加PCI-E设备到虚拟机中即可</p><p>创建虚拟机时需要选择：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_4d88c6e4aaae1b291fb1a0054b3e7011.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_4d88c6e4aaae1b291fb1a0054b3e7011.png"></p><p>ps:<br>1、我同时添加显卡和音频之后，开机遇报错：TASK ERROR: start failed: QEMU exited with code 1，如果遇到同样的报错，尝试把音频设备从硬件中移除</p><h2 id="八-扩展"><a href="#八-扩展" class="headerlink" title="八. 扩展"></a>八. 扩展</h2><p>虚拟机直通显卡后安装显卡驱动 使用下方脚本安装</p><p><a href="https://onenote.zznnwn.cloudns.biz/api/raw/?path=/%E8%84%9A%E6%9C%AC/ubuntu%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2NVIDIA%E9%A9%B1%E5%8A%A8/nvidia-gpu.sh">安装脚本 &gt; nvidia-gpu.sh</a></p><h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a href="https://blog.csdn.net/byb123/article/details/124549876">https://blog.csdn.net/byb123/article/details/124549876</a>   （主要参考）</p><p><a href="https://blog.dako.dev/proxmox-7-4-gpu-passthrough--e6-98-be-e5-8d-a1-e7-9b-b4-e9-80-9a/">https://blog.dako.dev/proxmox-7-4-gpu-passthrough--e6-98-be-e5-8d-a1-e7-9b-b4-e9-80-9a/</a></p>]]></content>
      
      
      <categories>
          
          <category> pve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pve </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pve部署报错Cannot run in framebuffer mode. Please specify busIos 解决</title>
      <link href="/2024/07/01/Pve%E9%83%A8%E7%BD%B2%E6%8A%A5%E9%94%99Cannot%20run%20in%20framebuffer%20mode.%20Please%20specify%20busIos%20%E8%A7%A3%E5%86%B3/"/>
      <url>/2024/07/01/Pve%E9%83%A8%E7%BD%B2%E6%8A%A5%E9%94%99Cannot%20run%20in%20framebuffer%20mode.%20Please%20specify%20busIos%20%E8%A7%A3%E5%86%B3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Pve部署报错Cannot-run-in-framebuffer-mode-Please-specify-busIos-解决"><a href="#Pve部署报错Cannot-run-in-framebuffer-mode-Please-specify-busIos-解决" class="headerlink" title="Pve部署报错Cannot run in framebuffer mode. Please specify busIos 解决"></a>Pve部署报错Cannot run in framebuffer mode. Please specify busIos 解决</h1><h2 id="一-现象（错误分析）"><a href="#一-现象（错误分析）" class="headerlink" title="一. 现象（错误分析）"></a>一. 现象（错误分析）</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_451e4c0eb25db4eb9d6f522ab61064ec.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_451e4c0eb25db4eb9d6f522ab61064ec.png"></p><p>按照提示输入CTRL+ALT+F2查看具体报错</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_ac23c01d0edb14915d6e0b7fe8506aa2.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_ac23c01d0edb14915d6e0b7fe8506aa2.png"></p><p>重启系统再次出现第一张图中报错时等待一段时间会自动进入命令行 进入命令行后查看日志。</p><p>问题：根据本文第一张图日志文件查看错误日志 <strong>cat /var/log/Xorg.0.log |grep EE</strong> 观察到设备 <strong>/dev/dri/card0</strong> 找不到且nv模块加载失败</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_d95c83302584efe1926a318c57dfa7f0.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_d95c83302584efe1926a318c57dfa7f0.png"></p><h2 id="二-解决"><a href="#二-解决" class="headerlink" title="二. 解决"></a>二. 解决</h2><p>编辑此文件：nano /usr/share/X11/xorg.conf.d/10-quirks.conf</p><p>文件顶部第二行新增如下内容(CTRL + X 输入 Y保存)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Section <span class="string">&quot;Device&quot;</span></span><br><span class="line">  Identifier <span class="string">&quot;Card0&quot;</span></span><br><span class="line">  Driver <span class="string">&quot;fbdev&quot;</span></span><br><span class="line">EndSection</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_1b0a47b246d7f93aae3411d8be3a4f44.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_1b0a47b246d7f93aae3411d8be3a4f44.png"></p><p>接下来，默认会返回到命令界面， 输入【xinit – -dpi 96 &gt;/dev/tty2 2&gt;&amp;1】回车,即可进入安装界面</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_86db8ea42fe6d4ed0bc30c18947d3ea3.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_86db8ea42fe6d4ed0bc30c18947d3ea3.png"></p><p>本文参考：</p><p><a href="https://blog.csdn.net/linzhiji/article/details/117754330">https://blog.csdn.net/linzhiji/article/details/117754330</a><br><a href="https://blog.csdn.net/u012514495/article/details/129987207">https://blog.csdn.net/u012514495/article/details/129987207</a> （主要参考）</p>]]></content>
      
      
      <categories>
          
          <category> pve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pve </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>proxmox教程</title>
      <link href="/2024/06/22/proxmox%E6%95%99%E7%A8%8B/"/>
      <url>/2024/06/22/proxmox%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="proxmox教程"><a href="#proxmox教程" class="headerlink" title="proxmox教程"></a>proxmox教程</h1><p>iso镜像下载地址：</p><p><a href="https://pve.proxmox.com/wiki/Downloads">https://pve.proxmox.com/wiki/Downloads</a></p><p><a href="https://enterprise.proxmox.com/iso/">https://enterprise.proxmox.com/iso/</a></p><p>本教材使用镜像：proxmox-ve_8.1-2.iso</p><h2 id="一-proxmox的安装及配置"><a href="#一-proxmox的安装及配置" class="headerlink" title="一. proxmox的安装及配置"></a>一. proxmox的安装及配置</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_2f095d78b69671be4283fa3df4138a68.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_2f095d78b69671be4283fa3df4138a68.png"></p><p>1.硬件直通</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_926f9dc034ba9e58f4d865c5d48e2dd6.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_926f9dc034ba9e58f4d865c5d48e2dd6.png"></p><p>2.最终效果</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_e695c7631fab1a105f95568f6c4d2628.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_e695c7631fab1a105f95568f6c4d2628.png"></p><h2 id="二-pve节点加入集群"><a href="#二-pve节点加入集群" class="headerlink" title="二. pve节点加入集群"></a>二. pve节点加入集群</h2><p>需要两个pve节点主机名称不一样 如果主机名称一样会冲突导致无法加入节点 出现类似如下报错</p><p>修改pve节点名称参考：<a href="https://www.qkeke.com/archives/2136.html">https://www.qkeke.com/archives/2136.html</a></p><h3 id="1-修改节点名称"><a href="#1-修改节点名称" class="headerlink" title="1.修改节点名称"></a>1.修改节点名称</h3><p>在创建集群后，其他同名节点始终无法加入集群，于是需要修改节点主机名，步骤如下：</p><p>1、修改如下2个文件中的主机名为新的主机名</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hostname</span><br><span class="line">vi /etc/hosts</span><br></pre></td></tr></table></figure><p>2、如果我们已经创建虚拟机，需要修改nodes中节点配置文件名（新服务器忽略此步）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> /etc/pve/nodes/OldHostName     /etc/pve/nodes/NewHostName</span><br></pre></td></tr></table></figure><p>3、重启服务器</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_688957670a3886de26c6dc137530bf6e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_688957670a3886de26c6dc137530bf6e.png"></p><h2 id="三-pve重置密码（此种方式只适用于pve8-1版本）"><a href="#三-pve重置密码（此种方式只适用于pve8-1版本）" class="headerlink" title="三. pve重置密码（此种方式只适用于pve8.1版本）"></a>三. pve重置密码（此种方式只适用于pve8.1版本）</h2><p><a href="https://cn.linux-console.net/?p=1538">如何在 Debian 10 中重置忘记的 Root 密码 (linux-console.net)</a> （本文参考）<br><a href="https://pve.proxmox.com/wiki/Root_Password_Reset#Method_1">https://pve.proxmox.com/wiki/Root_Password_Reset#Method_1</a></p><p>初始图</p><p>到此页面时按e进入grub模式（有时候不会出现蓝色界面出现的为黑色界面此时操作方法一样）</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_b2331cc4270249582ef47242c1d19634.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_b2331cc4270249582ef47242c1d19634.png"></p><p>黑色界面</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/1724752992583_b8d762af8866765ff94ac33c6d2f3ebe.jpg" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/1724752992583_b8d762af8866765ff94ac33c6d2f3ebe.jpg"></p><p>找到此行添加此配置 <code>linux /boot/vmlinuz.... ro quiet</code></p><p>将光标移动到该行的末尾，在<code>ro quiet</code>后面新增参数<code>init=/bin/bash</code>。</p><p>输入 ctrl + x 以使其能够以装有只读(ro)访问权限的根文件系统在单用户模式下启动。</p><p>为您重置密码，您需要更改从访问权限只读到读写。因此，运行以下命令以重新安装具有rw属性的根文件系统。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_08023f86d72ff75b8173d99bbedeeee4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_08023f86d72ff75b8173d99bbedeeee4.png"></p><p>挂载Debian文件系统 及修改密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -n -o remount，rw /</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_824a050b4122d5f75b3d666d2e695bfc.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_824a050b4122d5f75b3d666d2e695bfc.png"></p><p>在Debian中重设根密码</p><p>提供新密码并重新输入以确认。如果一切顺利并且密码匹配，您将在控制台末尾收到“ 密码更新成功 ”通知</p><p>最后按Ctrl + Alt + Del退出并重新启动。现在，您可以使用刚刚定义的新创建的密码以root用户身份登录。</p><p>这就是您在Debian 10上重置忘记的root密码的方式。</p><p>备注：本质上pve的底层是一个debian系统和debian系统重置密码是一样的 可参考下方debian11重置密码</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_0866a0b337fb3c215760314e7ccd157d.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_0866a0b337fb3c215760314e7ccd157d.png"></p><h2 id="四-添加数据盘为存储"><a href="#四-添加数据盘为存储" class="headerlink" title="四. 添加数据盘为存储"></a>四. 添加数据盘为存储</h2><p>pve不像exsi那样自动添加好的 需要自己手动挂载到某个目录 添加此目录为本地存储</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_d23a49628b2f8a794ab27c1d9e2d209a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_d23a49628b2f8a794ab27c1d9e2d209a.png"></p><h2 id="五-修改pve-ip地址"><a href="#五-修改pve-ip地址" class="headerlink" title="五. 修改pve  ip地址"></a>五. 修改pve  ip地址</h2><p><a href="https://blog.csdn.net/mwl093/article/details/129483191">https://blog.csdn.net/mwl093/article/details/129483191</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改pve ip地址 </span></span><br><span class="line">vi /etc/network/interfaces</span><br><span class="line"><span class="comment"># 修改pve web页面登录地址</span></span><br><span class="line">vi /etc/issue</span><br><span class="line"><span class="comment"># 修改本地dns</span></span><br><span class="line">vi /etc/hosts</span><br><span class="line"><span class="comment"># 修改主机名称对应IP</span></span><br><span class="line">vi /etc/hostname</span><br></pre></td></tr></table></figure><p>重启网络：systemctl restart networking</p><h2 id="创建windows虚拟机"><a href="#创建windows虚拟机" class="headerlink" title="创建windows虚拟机"></a>创建windows虚拟机</h2><p>• 常规：按需填写<br>• 操作系统<br>○ ISO 镜像：选择上传的镜像<br>○ 类别：Microsoft Windows<br>○ 版本：11/2022<br>• 系统：<br>○ TPM 存储：local-lvm<br>○ EFI 存储：local-lvm<br>○ 其他默认即可<br>• 磁盘<br>○ 总线 / 设备：SCSI<br>○ 磁盘大小：按需选择<br>○ 其他默认即可<br>• CPU：按需选择<br>• 内存：按需选择<br>网络：默认即可</p><p><strong>跳过联网</strong>：在联网界面，使用Shift+F10或Fn+Shift+F10组合键调出命令提示符窗口，在命令行中输入</p><p><code>oobe\BypassNRO.cmd</code></p><p>命令后回车，然后重启电脑，在重启后的Win11联网界面中，选择“我没有Internet连接”的选项，并继续执行受限设置，这样可以跳过联网激活环节。</p><p><strong>备注</strong>：安装时 启动过程中会报错 此时 按Esc进入bios设置启动项即可正常进入windows安装界面</p><p><strong>安装完成之后在挂载的virtio-win-0.1.229.iso镜像中 找到virtio-win-agent-x64.exe安装即可出现网络等</strong></p><p><strong>虚拟机添加声音</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_249974881cbc1cff13510daa7b6605a3.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_249974881cbc1cff13510daa7b6605a3.png"></p><h2 id="六-GPU直通"><a href="#六-GPU直通" class="headerlink" title="六. GPU直通"></a>六. GPU直通</h2><p><a href="http://sunlight.zznnwn.cloudns.biz/2024/07/02/PVE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9B%B4%E9%80%9A%E8%8B%B1%E4%BC%9F%E8%BE%BEGPU%E6%98%BE%E5%8D%A1%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/?highlight=gpu">http://sunlight.zznnwn.cloudns.biz/2024/07/02/PVE虚拟机直通英伟达GPU显卡完全指南/?highlight=gpu</a></p><p>本文参考链接等：</p><p><a href="https://v2rayssr.com/pve.html">https://v2rayssr.com/pve.html</a><br><a href="https://www.jianshu.com/p/d22a21c5ae81">https://www.jianshu.com/p/d22a21c5ae81</a><br><a href="https://blog.csdn.net/c13257595138/article/details/90385433">https://blog.csdn.net/c13257595138/article/details/90385433</a></p><p>管理多个集群<br><a href="https://pve-doc-cn.readthedocs.io/zh-cn/latest/">https://pve-doc-cn.readthedocs.io/zh-cn/latest/</a></p><p>显卡直通<br><a href="https://blog.csdn.net/yyhyoung/article/details/130708894">https://blog.csdn.net/yyhyoung/article/details/130708894</a><br><a href="https://blog.rayfalling.com/2023/01/pve-7-3-%E4%BC%98%E5%8C%96%E5%92%8C%E6%98%BE%E5%8D%A1%E7%9B%B4%E9%80%9A.html">https://blog.rayfalling.com/2023/01/pve-7-3-优化和显卡直通.html</a></p><p>通过工具实现显卡直通<br><a href="https://github.com/ivanhao/pvetools/wiki/i-%E7%A1%AC%E4%BB%B6%E7%9B%B4%E9%80%9A%E5%8F%8A%E6%98%BE%E5%8D%A1%E7%9B%B4%E9%80%9A%E9%85%8D%E7%BD%AE">https://github.com/ivanhao/pvetools/wiki/i-硬件直通及显卡直通配置</a></p>]]></content>
      
      
      <categories>
          
          <category> pve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pve </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关闭ubuntu  unattended-upgrades自动更新服务</title>
      <link href="/2024/06/15/%E5%85%B3%E9%97%ADubuntu%20%20unattended-upgrades%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1/"/>
      <url>/2024/06/15/%E5%85%B3%E9%97%ADubuntu%20%20unattended-upgrades%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="关闭ubuntu-unattended-upgrades自动更新服务"><a href="#关闭ubuntu-unattended-upgrades自动更新服务" class="headerlink" title="关闭ubuntu  unattended-upgrades自动更新服务"></a>关闭ubuntu  unattended-upgrades自动更新服务</h1><blockquote><p><code>unattended-upgrades</code>是一个自动升级服务，用于自动更新系统中的软件包和安全补丁。当系统配置了<code>unattended-upgrades</code>服务后，它会定期检查软件包管理器（如APT）的更新源，然后自动下载和安装可用的软件包更新。</p><p>这个服务的主要目的是确保系统中的软件包保持最新状态，包括安全更新和 bug 修复。通过自动化这个过程，可以减少管理员手动干预的需求，并提高系统的安全性和稳定性。</p><p>通常情况下，<code>unattended-upgrades</code>服务会在后台运行，并根据配置文件中的规则自动执行更新操作。它可以定期检查更新源，下载软件包更新，并在系统空闲时安装这些更新，以确保系统保持最新状态。</p><p>如果你遇到了无法执行<code>apt</code>命令的问题，可能是由于<code>unattended-upgrades</code>服务正在运行并占用了相关的锁定文件，导致其他<code>apt</code>进程无法操作。在这种情况下，你可以选择等待自动升级服务完成或者终止相关进程，然后再执行你需要的操作。</p></blockquote><p>要暂时关闭<code>unattended-upgrades</code>服务，你可以按照以下步骤操作：</p><ol><li><p><strong>停止<code>unattended-upgrades</code>服务</strong>：<br>运行以下命令停止<code>unattended-upgrades</code>服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop unattended-upgrades</span><br></pre></td></tr></table></figure></li><li><p><strong>禁用<code>unattended-upgrades</code>服务</strong>（可选）：<br>如果你想在系统重新启动后仍然保持<code>unattended-upgrades</code>服务关闭状态，可以禁用该服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">disable</span> unattended-upgrades</span><br></pre></td></tr></table></figure></li><li><p><strong>确认服务状态</strong>：<br>确保服务已经停止，可以运行以下命令检查服务状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status unattended-upgrades</span><br></pre></td></tr></table></figure></li></ol><p>这样，<code>unattended-upgrades</code>服务就会被暂时关闭。如果你想重新启用该服务，可以运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start unattended-upgrades</span><br></pre></td></tr></table></figure><p>关闭后下方问题解决</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_aaf97a6eb50633cfdab0e71cfd1c69a0.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_aaf97a6eb50633cfdab0e71cfd1c69a0.png"></p><p>请注意，关闭自动升级服务可能会导致系统中的软件包和安全补丁不及时更新，这可能会影响系统的安全性。因此，在关闭服务之前，请确保了解风险并在合适的时机重新启用服务。</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu22.04LTS安装NVIDIA官方4090D驱动CUDA CUDNN Anaconda Pytorch2 等</title>
      <link href="/2024/06/13/ubuntu22.04LTS%E5%AE%89%E8%A3%85NVIDIA%E5%AE%98%E6%96%B94090D%E9%A9%B1%E5%8A%A8CUDA%20CUDNN%20Anaconda%20%20Pytorch2%20%E7%AD%89/"/>
      <url>/2024/06/13/ubuntu22.04LTS%E5%AE%89%E8%A3%85NVIDIA%E5%AE%98%E6%96%B94090D%E9%A9%B1%E5%8A%A8CUDA%20CUDNN%20Anaconda%20%20Pytorch2%20%E7%AD%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="ubuntu22-04LTS安装NVIDIA官方4090D驱动CUDA-CUDNN-Anaconda-Pytorch2等"><a href="#ubuntu22-04LTS安装NVIDIA官方4090D驱动CUDA-CUDNN-Anaconda-Pytorch2等" class="headerlink" title="ubuntu22.04LTS安装NVIDIA官方4090D驱动CUDA CUDNN Anaconda Pytorch2等"></a>ubuntu22.04LTS安装NVIDIA官方4090D驱动CUDA CUDNN Anaconda Pytorch2等</h1><p>前言：</p><p>一键部署驱动coda脚本</p><p><code>curl -fLO https://onenote.zznnwn.cloudns.biz/api/raw/?path=/%E8%84%9A%E6%9C%AC/ubuntu%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2NVIDIA%E9%A9%B1%E5%8A%A8/nvidia-gpu.sh </code></p><h3 id="1-安装依赖"><a href="#1-安装依赖" class="headerlink" title="1. 安装依赖"></a>1. 安装依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update   <span class="comment">#更新软件列表</span></span><br><span class="line">sudo apt-get install g++</span><br><span class="line">sudo apt-get install gcc</span><br><span class="line">sudo apt-get install make</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential gcc-multilib dkms</span><br></pre></td></tr></table></figure><blockquote><p>如果遇到无法下载的情况，可能是因为安装完系统后源不可用，可以先更换国内镜像源后在进行本步骤（换源方法：<a href="https://zhuanlan.zhihu.com/p/139305626">写给工程师的 Ubuntu 20.04 最佳配置指南</a> 第<strong>2、3</strong>步）</p></blockquote><h3 id="2-卸载原有驱动"><a href="#2-卸载原有驱动" class="headerlink" title="2. 卸载原有驱动"></a>2. 卸载原有驱动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove --purge nvidia*   <span class="comment"># 或者nvidia-*</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-官网下载对应驱动"><a href="#3-官网下载对应驱动" class="headerlink" title="3. 官网下载对应驱动"></a>3. 官网下载对应驱动</h3><blockquote><p>下载好之后，注意把nvidia驱动放在英文名文件夹下，比如mkdir driver 新建文件夹“driver”<br>官网地址：<a href="https://www.nvidia.cn/Download/index.aspx?lang=cn">Nvidia驱动下载地址</a><br>我这里显卡是4090，官网推荐驱动版本为535.54.03</p></blockquote><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_a82106785b61bc2f12e3efa9b941936c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_a82106785b61bc2f12e3efa9b941936c.png"></p><h3 id="4-禁用nouveau"><a href="#4-禁用nouveau" class="headerlink" title="4. 禁用nouveau"></a>4. 禁用nouveau</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit /etc/modprobe.d/blacklist.conf 或者(blacklist-nouveau.conf)</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>(如果没有gedit输入以上指令会报错，可以 sudo apt-get install gedit 安装 gedit 或使用 nano 代替 gedit )</p></blockquote><p>在打开的blacklist.conf末尾添加如下，保存文本关闭</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">blacklist nouveau</span><br><span class="line">options nouveau modeset=0</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在终端输入如下命令，进行更新</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-initramfs -u</span><br></pre></td></tr></table></figure><p>更新结束后重启电脑</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><p>重启后在终端输入如下命令，如果没有输出则说明成功禁用nouveau</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep nouveau</span><br></pre></td></tr></table></figure><h3 id="5-停止当前的显示服务器"><a href="#5-停止当前的显示服务器" class="headerlink" title="5. 停止当前的显示服务器"></a>5. 停止当前的显示服务器</h3><p>最简单的方法是使用telinit命令更改为运行级别3。在终端输入以下linux命令后，显示服务器将停止。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo telinit 3</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>一般执行完上述命令后，系统自动进入文本界面tty；<br>如果进不去，就按Ctrl + Alt + F1～F6中的一个 (分别对应进入tty1~tty6)<br>然后输入用户名和密码</p></blockquote><h3 id="6-在文本界面中，禁用X-window服务"><a href="#6-在文本界面中，禁用X-window服务" class="headerlink" title="6. 在文本界面中，禁用X-window服务"></a>6. 在文本界面中，禁用X-window服务</h3><p>在终端输入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/gdm3 stop或者（sudo service gdm3 stop）</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="7-安装驱动"><a href="#7-安装驱动" class="headerlink" title="7. 安装驱动"></a>7. 安装驱动</h3><p>cd命令进入到存放驱动的目录，输入命令（命令中的文件名以你下载的驱动为准）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 777 NVIDIA-Linux-x86_64-535.54.03.run   <span class="comment">#给你下载的驱动赋予可执行权限，才可以安装</span></span><br><span class="line">sudo ./NVIDIA-Linux-x86_64-535.54.03.run –no-opengl-files   <span class="comment">#安装</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_f8b9841992eaa256d8d224a8a53f064a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_f8b9841992eaa256d8d224a8a53f064a.png"></p><blockquote><p>以上问题并非按我写的顺序出现，但是当时没有截图所以忘记顺序了。<strong>表格中最后一个问题</strong>需要注意，在其它的教程中，这个问题选yes，但是在我安装系统的过程中，选yes会导致电脑重启后无法正常开机。<strong>所以这里我选了No</strong>，重启后能够正常开机。（Ubuntu20.04 、显卡4090）</p></blockquote><h3 id="8-重启图形界面"><a href="#8-重启图形界面" class="headerlink" title="8. 重启图形界面"></a>8. 重启图形界面</h3><p>安装完成后退回图形界面：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo init 5 </span><br></pre></td></tr></table></figure><p>or</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctrl + alt + f7 </span><br></pre></td></tr></table></figure><p>or</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service gdm3 restart</span><br></pre></td></tr></table></figure><p>或者终端输入 reboot 重启</p><h3 id="9-测试显卡驱动是否安装成功"><a href="#9-测试显卡驱动是否安装成功" class="headerlink" title="9. 测试显卡驱动是否安装成功"></a>9. 测试显卡驱动是否安装成功</h3><p>终端输入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>出现类似下图的界面，说明成功安装驱动</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_faf7c52e1453ed6831feafd08733747a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_faf7c52e1453ed6831feafd08733747a.png"></p><h3 id="四-安装CUDA"><a href="#四-安装CUDA" class="headerlink" title="四. 安装CUDA"></a>四. 安装CUDA</h3><p>为了能够使用pytorch2，我在这里安装的CUDA11.8版本。<br>参考教程：<a href="https://zhuanlan.zhihu.com/p/612556391">CUDA_11.8安装-知乎</a></p><p><strong>cuda版本列表：</strong></p><ul><li><a href="https://developer.nvidia.com/cuda-toolkit-archive">CUDA Toolkit Archive | NVIDIA Developer</a></li><li><a href="https://developer.nvidia.com/cuda-downloads">CUDA Toolkit 12.9 Downloads | NVIDIA Developer</a> 【点击Archive of Previous CUDA Releases】</li></ul><h4 id="1-官网下载CUDA"><a href="#1-官网下载CUDA" class="headerlink" title="1. 官网下载CUDA"></a>1. 官网下载CUDA</h4><p><a href="https://developer.nvidia.com/cuda-11-8-0-download-archive">CUDA Toolkit 11.8 Downloads</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_a3e710d1f0efc1cd8aa0c09ba852954c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_a3e710d1f0efc1cd8aa0c09ba852954c.png"></p><h3 id="2-下载CUDA"><a href="#2-下载CUDA" class="headerlink" title="2. 下载CUDA"></a>2. 下载CUDA</h3><p>终端输入上一步获得的命令，下载runfile文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_520.61.05_linux.run</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-安装"><a href="#3-安装" class="headerlink" title="3. 安装"></a>3. 安装</h3><p>执行上一条命令下载runfile文件后，cd到文件所在路径，执行下面的命令，安装cuda</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sh cuda_11.8.0_520.61.05_linux.run</span><br></pre></td></tr></table></figure><p>执行后稍微等待，会出现如下画面</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_75d6fd3264f5a14aea3d46eb7188bfad.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_75d6fd3264f5a14aea3d46eb7188bfad.png"></p><blockquote><p>上下移动光标到Driver位置，按空格取消选择；用相同的操作取消另外三个选项，只安装CUDA Toolkit 11.8主体（如图）</p></blockquote><p>继续移动光标到Options，按回车，进入安装配置界面（如下）</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_137f5444520fc1ba1ec212be997df3a5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_137f5444520fc1ba1ec212be997df3a5.png"></p><p>光标移动到Toolkit Options，按回车，进入CUDA安装配置界面 取消选择所有选项</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_0067f24a438738730d4d902abcec20ce.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_0067f24a438738730d4d902abcec20ce.png"></p><blockquote><p>如上图，去掉所有选项，特别是Create symbolic link from /usr/local/cuda选项，最好是去掉。这样安装完成后，是不会在/usr/local/下生成cuda软链接目录。这个软链接目录在安装过程中是不可修改的，当我们安装多版本CUDA时，会重复覆盖这个软链接目录，对我们使用CUDA会产生不必要的麻烦。</p></blockquote><blockquote><p>CUDA默认安装在/usr/local/目录下，一般Change Toolkit Install Path可以不做修改。但如果是普通用户安装，需设定安装路径为用户主目录下，光标移动到Change Toolkit Install Path按回车，手动修改安装路径后按回车退出路径配置界面</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_7384d8d55a365e5df7705a52eaba2a81.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_7384d8d55a365e5df7705a52eaba2a81.png"></p><p>——————————————</p><p>此时如果想要修改路径，可以设置为自己想要放在的位置，如 /home/用户名/app/cuda-11.8/</p><p>此时选择完成 done处回车 直到回到第一步选择 install 此时选择Upgrade all 即可 安装完成后 下方设置系统变量即可配置完成</p></blockquote><h3 id="4-设置CUDA环境"><a href="#4-设置CUDA环境" class="headerlink" title="4. 设置CUDA环境"></a>4. 设置CUDA环境</h3><p>可配置在<code>~/.bashrc</code>目录或者系统变量路径<code>/etc/profile</code></p><p>如果上一步选择用root用户安装在默认路径，则root用户环境变量配置如下示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/usr/local/cuda-11.8/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$LD_LIBRARY_PATH</span>:/usr/local/cuda-11.8/lib64</span><br></pre></td></tr></table></figure><p>如果是普通用户安装在自己的用户目录下，环境变量配置如下示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/home/duyong/apps/cuda-11.8/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$LD_LIBRARY_PATH</span>:/home/duyong/apps/cuda-11.8/lib64</span><br></pre></td></tr></table></figure><p>使用户配置文件即刻生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><p>验证CUDA是否安装成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc -V</span><br></pre></td></tr></table></figure><p>如果有类似如下输出说明安装成功</p><blockquote><p>nvcc: NVIDIA ® Cuda complier driver<br>Copyright © 2005-2022 NVIDIA Coropration<br>Bulit on Wed_Jun__8_16:49:14_PDT_2022<br>Cuda copiltation tools, release 11.7, V11.7.99<br>Build cuda_11.7.r11.7/compiler .31442593_0</p></blockquote><p>安装完成后重启</p><h2 id="五-安装CUDNN"><a href="#五-安装CUDNN" class="headerlink" title="五. 安装CUDNN"></a>五. 安装CUDNN</h2><p>官网下载地址：（需要注册）</p><p><a href="https://developer.nvidia.com/cudnn">https://developer.nvidia.com/cudnn</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_255bdd3027c994186d2ab7d232c048d6.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_255bdd3027c994186d2ab7d232c048d6.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_a00f30ce85ee7aea5ba4008845c2697a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_a00f30ce85ee7aea5ba4008845c2697a.png"></p><p>点击下载，下载完成后解压文件，在当前文件夹下打开终端，输入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> cuda/include/cudnn.h /usr/local/cuda/include/</span><br><span class="line">sudo <span class="built_in">cp</span> cuda/lib64/libcudnn* /usr/local/cuda/lib64/</span><br><span class="line">sudo <span class="built_in">chmod</span> a+r /usr/local/cuda/include/cudnn.h</span><br><span class="line">sudo <span class="built_in">chmod</span> a+r /usr/local/cuda/lib64/libcudnn*</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此步操作为拷贝文件到指定位置，并赋予权限</p><p>验证是否安装成功，输入：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/local/cuda/include/cudnn_version.h | grep CUDNN_MAJOR -A 2</span><br></pre></td></tr></table></figure><p>安装成功会有类似下图的输出</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_2a150aaca0cc6b1bfd635806439e0210.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_2a150aaca0cc6b1bfd635806439e0210.png"></p><h3 id="六-安装Anaconda"><a href="#六-安装Anaconda" class="headerlink" title="六. 安装Anaconda"></a>六. 安装Anaconda</h3><p>参考：<a href="https://blog.csdn.net/m0_50117360/article/details/108403586">Ubuntu 20.04安装Anaconda3及简单使用</a></p><h3 id="七-安装Pytorch2"><a href="#七-安装Pytorch2" class="headerlink" title="七. 安装Pytorch2"></a>七. 安装Pytorch2</h3><p>参考：<a href="https://blog.csdn.net/KRISNAT/article/details/124068391">超详细 Ubuntu安装PyTorch步骤</a></p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://zhuanlan.zhihu.com/p/590877041">https://zhuanlan.zhihu.com/p/590877041</a><br><a href="https://blog.csdn.net/hwh295/article/details/113409389">https://blog.csdn.net/hwh295/article/details/113409389</a><br><a href="https://blog.csdn.net/Perfect886/article/details/119109380">https://blog.csdn.net/Perfect886/article/details/119109380</a><br><a href="https://zhuanlan.zhihu.com/p/61255639">https://zhuanlan.zhihu.com/p/61255639</a><br><a href="https://blog.csdn.net/m0_50117360/article/details/108403586">https://blog.csdn.net/m0_50117360/article/details/108403586</a><br><a href="https://blog.csdn.net/KRISNAT/article/details/124068391">https://blog.csdn.net/KRISNAT/article/details/124068391</a><br>————————————————</p><h3 id="本文参考："><a href="#本文参考：" class="headerlink" title="本文参考："></a>本文参考：</h3><p><a href="https://blog.csdn.net/qq_43775794/article/details/131770933">https://blog.csdn.net/qq_43775794/article/details/131770933</a></p>]]></content>
      
      
      <categories>
          
          <category> gpu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu彻底删除mysql残留 安装新mysql</title>
      <link href="/2024/06/05/ubuntu%E5%BD%BB%E5%BA%95%E5%88%A0%E9%99%A4mysql%E6%AE%8B%E7%95%99%20%E5%AE%89%E8%A3%85%E6%96%B0mysql/"/>
      <url>/2024/06/05/ubuntu%E5%BD%BB%E5%BA%95%E5%88%A0%E9%99%A4mysql%E6%AE%8B%E7%95%99%20%E5%AE%89%E8%A3%85%E6%96%B0mysql/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="ubuntu彻底删除mysql残留-安装新mysql"><a href="#ubuntu彻底删除mysql残留-安装新mysql" class="headerlink" title="ubuntu彻底删除mysql残留 安装新mysql"></a>ubuntu彻底删除mysql残留 安装新mysql</h1><p>1.删除mysql的数据文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">rm</span> /var/lib/mysql/ -R</span><br></pre></td></tr></table></figure><p>2.删除mysql的配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">rm</span> /etc/mysql/ -R</span><br></pre></td></tr></table></figure><p>(这两步非常重要，好多文章都没写)</p><p>3 .dpkg –list|grep mysql查看mysql的依赖项</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_8a639ced957b5aa0db30b0b1aac12589.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_8a639ced957b5aa0db30b0b1aac12589.png"></p><p>4.开始删除依赖项</p><p>4.1 .卸载命令：sudo apt-get remove mysql-common</p><p>4.2. 卸载命令：sudo apt-get autoremove –purge mysql-server-8.0</p><p>备注此两部合为一步:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下方两命令皆可</span></span><br><span class="line">dpkg -l|grep mysql|awk <span class="string">&#x27;&#123;print$2&#125;&#x27;</span>|sudo xargs dpkg -P</span><br><span class="line">dpkg -l|grep mysql|awk <span class="string">&#x27;&#123;print$2&#125;&#x27;</span>|sudo xargs remove -y</span><br></pre></td></tr></table></figure><p>4.3 .清除残留数据，运行命令：dpkg -l|grep mysql|awk ‘{print$2}’|sudo xargs dpkg -P</p><p>再次查看MySQL的剩余依赖项，运行命令：dpkg –list|grep mysql</p><p>如果没有返回即删除完了（基本上就会删除完），如果没删除完则继续删除显示的依赖包</p><p>其他</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修复安装包</span></span><br><span class="line">sudo dpkg-reconfigure mysql-server-5.7</span><br><span class="line"><span class="comment"># 卸载安装包及配置文件</span></span><br><span class="line">sudo apt-get purge mysql-server-5.7</span><br></pre></td></tr></table></figure><p>完成 此时即可重新安装mysql！</p><p>原文链接：<a href="https://blog.csdn.net/qq_52135683/article/details/126857974">https://blog.csdn.net/qq_52135683/article/details/126857974</a></p>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>grafana 8以上版本配置邮件告警</title>
      <link href="/2024/06/04/grafana%208%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6/"/>
      <url>/2024/06/04/grafana%208%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="grafana-8以上版本配置邮件告警"><a href="#grafana-8以上版本配置邮件告警" class="headerlink" title="grafana 8以上版本配置邮件告警"></a>grafana 8以上版本配置邮件告警</h1><blockquote><p>本次演示使用版本9.2.0</p><p>拓补图</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_edeee1c476fa329e2b3489f066df346c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_edeee1c476fa329e2b3489f066df346c.png"></p></blockquote><h2 id="1-首先配置后端邮件配置"><a href="#1-首先配置后端邮件配置" class="headerlink" title="1.首先配置后端邮件配置"></a>1.首先配置后端邮件配置</h2><p>建议配置为邮件组 组内成员都可收到邮件</p><p>此处见链接：<a href="https://wn-apple-teawine.fun/2023/05/26/grafana%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6">https://wn-apple-teawine.fun/2023/05/26/grafana配置邮件告警</a></p><h2 id="2-此时即可配置告警规则"><a href="#2-此时即可配置告警规则" class="headerlink" title="2.此时即可配置告警规则"></a>2.此时即可配置告警规则</h2><p>①.配置</p><p>后端配置见上方链接</p><p>前端配置见下方</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_77d36f135d1154ed015d21243fe9f8bc.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_77d36f135d1154ed015d21243fe9f8bc.png"></p><p>点击测试查看是否成功</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_4e8ed1f107e3602cfcf8edb7ff1872ca.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_4e8ed1f107e3602cfcf8edb7ff1872ca.png"></p><p>配置持续发送告警 配置 Notification policies 设置重复发送告警邮件的间隔时间</p><p>不设置此则默认四小时重复发送 相当糟糕💗</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_b76111cbaf1baced4e24119f9bb1c9a8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_b76111cbaf1baced4e24119f9bb1c9a8.png"></p><p><strong>此时便会两分钟发一封告警邮件</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_ba9125fba1e0c66be945b60a83f2b41e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_ba9125fba1e0c66be945b60a83f2b41e.png"></p><p>②.配置promsql语句设置报警</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_54e566d16a35915ac3f03f44a05c8ed5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_54e566d16a35915ac3f03f44a05c8ed5.png"></p><p>报警条件选择 选择B语句 选择A会报错</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_e2cee9496752811ae27dba1c7b6c22bd.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_e2cee9496752811ae27dba1c7b6c22bd.png"></p><p>或拖动此线🍺</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_93c6bf297b5cff54231696e190e19874.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_93c6bf297b5cff54231696e190e19874.png"></p><p>选择报警表达式为 <strong>B</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_a62de892570cd8c66cc553250ed18d68.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_a62de892570cd8c66cc553250ed18d68.png"></p><p>设置报警周期</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_5a25154c8a7e1694b0e6237fd051f8b4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_5a25154c8a7e1694b0e6237fd051f8b4.png"></p><p>设置报警出现发送提示语句</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_776ebfdddab566d58c59c4685d439a9c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_776ebfdddab566d58c59c4685d439a9c.png"></p><p>自定义标签</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_1f801f865e968f8b9d0594ee1e9d84dd.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_1f801f865e968f8b9d0594ee1e9d84dd.png"></p><h2 id="2-效果"><a href="#2-效果" class="headerlink" title="2.效果"></a>2.效果</h2><p>报警页面</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_cec9e81d68127efb459ca97cb4f1d9e0.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_cec9e81d68127efb459ca97cb4f1d9e0.png"></p><p>报警恢复与发送报警<br><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_5f7a15945a38ac95755b68996feb913e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_5f7a15945a38ac95755b68996feb913e.png"></p><p>参考：</p><p><a href="https://blog.51cto.com/u_11529070/9174855">[转帖]Prometheus系列之Grafana 版本9.0.0 设置Email邮件报警实战_51CTO博客_prometheus邮件告警</a></p>]]></content>
      
      
      <categories>
          
          <category> grafana </category>
          
      </categories>
      
      
        <tags>
            
            <tag> grafana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>宝塔docker部署实现对某一个目录的编辑</title>
      <link href="/2024/06/03/%E5%AE%9D%E5%A1%94docker%E9%83%A8%E7%BD%B2%E5%AE%9E%E7%8E%B0%E5%AF%B9%E6%9F%90%E4%B8%80%E4%B8%AA%E7%9B%AE%E5%BD%95%E7%9A%84%E7%BC%96%E8%BE%91/"/>
      <url>/2024/06/03/%E5%AE%9D%E5%A1%94docker%E9%83%A8%E7%BD%B2%E5%AE%9E%E7%8E%B0%E5%AF%B9%E6%9F%90%E4%B8%80%E4%B8%AA%E7%9B%AE%E5%BD%95%E7%9A%84%E7%BC%96%E8%BE%91/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="宝塔docker部署实现对某一个目录的编辑"><a href="#宝塔docker部署实现对某一个目录的编辑" class="headerlink" title="宝塔docker部署实现对某一个目录的编辑"></a>宝塔docker部署实现对某一个目录的编辑</h1><blockquote><h2 id="版本命名说明-（镜像可选）"><a href="#版本命名说明-（镜像可选）" class="headerlink" title="版本命名说明 （镜像可选）"></a>版本命名说明 （镜像可选）</h2><p>pch18/baota或pch18/baota:latest等同pch18/baota:lnmp<br>pch18/baota:lnmp为最新版本的官方纯净安装的基础上安装nginx,mysql,php<br>pch18/baota:lnp 为官方版本纯净安装的基础上安装nginx,php(不内置mysql,用于外置数据库的环境)<br>pch18/baota:lamp 为官方版本纯净安装的基础上安装apache,php<br>pch18/baota:lap 为官方版本纯净安装的基础上安装apache,php(不内置mysql,用于外置数据库的环境)<br>pch18/baota:clear 为官方版本纯净安装, 不默认安装nginx,mysql,php等程序</p><p>项目地址：<a href="https://github.com/pch18-docker/baota">https://github.com/pch18-docker/baota</a></p></blockquote><h2 id="镜像可选"><a href="#镜像可选" class="headerlink" title="镜像可选"></a>镜像可选</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pch18/baota</span><br><span class="line">pch18/baota:clear</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:baota</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:pch18baota-clean</span><br></pre></td></tr></table></figure><h2 id="docker-compose部署"><a href="#docker-compose部署" class="headerlink" title="docker-compose部署"></a>docker-compose部署</h2><blockquote><p>只需要暴露 web访问端口 8888与80端口的映射即可</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">baota:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">pch18/baota:clear</span></span><br><span class="line">    <span class="comment"># registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:baota</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">baota</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data:/www/v10</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/wwwroot:/www/wwwroot</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8010:80&quot;</span></span><br><span class="line">      <span class="comment"># - &quot;4431:443&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8888:8888&quot;</span></span><br><span class="line">      <span class="comment"># - &quot;888:888&quot;</span></span><br><span class="line">    <span class="attr">shm_size:</span> <span class="string">&#x27;1g&#x27;</span></span><br></pre></td></tr></table></figure><p>关闭安装套件推荐：<code>sed -i &quot;s/self.CheckInstalled()/True/g&quot; /www/server/panel/class/system.py</code></p><p><strong>手动步骤</strong></p><ol><li>修改文件路径：<code>/www/server/panel/class/system.py</code></li><li>搜索代码：<code>networkInfo[&#39;installed&#39;] = self.CheckInstalled()</code></li><li>替换为：<code>networkInfo[&#39;installed&#39;] = True</code></li><li>重启面板，你会发现烦人的弹窗消失了。</li></ol><p><a href="https://qzone.work/technologys/604.html">宝塔面板禁用 套件推荐安装弹窗 - 莫名博客 (qzone.work)</a></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>登录方式<br>登陆地址 http://:8888<br>初始账号 username<br>初始密码 password</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_63177a79daa92e8f483ee31941b38457.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_63177a79daa92e8f483ee31941b38457.png"></p><p>若无法登录则需要重新修改密码 docker exec 进入容器 使用 bt 命令 输入5，6重置登录信息  登录成功后需要开启离线模式。</p>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ChatGPT对接微信公众号</title>
      <link href="/2024/05/30/ChatGPT%E5%AF%B9%E6%8E%A5%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/"/>
      <url>/2024/05/30/ChatGPT%E5%AF%B9%E6%8E%A5%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="ChatGPT对接微信公众号"><a href="#ChatGPT对接微信公众号" class="headerlink" title="ChatGPT对接微信公众号"></a>ChatGPT对接微信公众号</h1><blockquote><p>使用vercel 项目地址: <a href="https://github.com/pwh-pwh/aiwechat-vercel">https://github.com/pwh-pwh/aiwechat-vercel</a></p><p>部署链接：<a href="https://vercel.com/">https://vercel.com/</a></p></blockquote><p>环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GPT_TOKEN: sk-utaX8XNb1Lq5m9DWQDqVT3BlbkFddsJNVgkLJshdsddsdsd</span><br><span class="line">WX_SUBSCRIBE_REPLY: 本公众号(简逸云.) 用于分享 云计算，人工智能，大模型集成，开源社区，云原生监控等知识 帮助您解决日常生活及工作中的难题 公众号已集成GPT感谢您的关注！</span><br><span class="line">maxOutput: 200</span><br><span class="line">WX_HELP_REPLY: 输入以下命令进行对话 \n/help：查看帮助 \n/gpt：与GPT对话 \n此GPT每次回答字数限制为200字左右，如需解除字数限制请联系作者(87889211611@qq.com)获取帮助。</span><br><span class="line">accessCode: Jkl12fdfdsdsd!</span><br><span class="line">GPT_URL: https://api.openai.com/v1</span><br><span class="line">botType: gpt</span><br><span class="line">WX_TOKEN: 53acb98d1dac49dffdfd969b45797129f504f8</span><br><span class="line">gptModel: gpt-3.5-turbo</span><br></pre></td></tr></table></figure><p>测试：</p><ul><li>有密码：<a href="https://zznngpt.zznnwn.cloudns.biz/api/chat?code=Jkl123456-&amp;msg=%E4%BD%A0%E6%98%AF%E8%B0%81">https://zznngpt.zznnwn.cloudns.biz/api/chat?code=Jkl123456-&amp;msg=你是谁</a></li><li>无密码：<a href="https://zznngpt.zznnwn.cloudns.biz/api/chat?msg=%E4%BD%A0%E7%9A%84%E9%97%AE%E9%A2%98">https://zznngpt.zznnwn.cloudns.biz/api/chat?msg=你的问题</a></li><li>正确性检查：<a href="https://zznngpt.zznnwn.cloudns.biz/api/check">https://zznngpt.zznnwn.cloudns.biz/api/check</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RustDesk全平台远程桌面连接软件自建服务</title>
      <link href="/2024/05/30/RustDesk%E5%85%A8%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%BF%9E%E6%8E%A5%E8%BD%AF%E4%BB%B6%E8%87%AA%E5%BB%BA%E6%9C%8D%E5%8A%A1/"/>
      <url>/2024/05/30/RustDesk%E5%85%A8%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%BF%9E%E6%8E%A5%E8%BD%AF%E4%BB%B6%E8%87%AA%E5%BB%BA%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="RustDesk全平台远程桌面连接软件自建服务"><a href="#RustDesk全平台远程桌面连接软件自建服务" class="headerlink" title="RustDesk全平台远程桌面连接软件自建服务"></a>RustDesk全平台远程桌面连接软件自建服务</h1><blockquote><p>RustDesk 是一款开源的全平台远程桌面软件，可以平替 TeamViewer、向日葵、ToDesk 等远程桌面软件。可使用官方提供的免费服务器（国内使用比较拉胯），也可自建服务器让数据掌握在自己手中，不用担心安全问题，以下列举几个特点：</p><p>全平台支持，如：Windows、macOS、Linux、iOS、Android、Web 等。<br>支持 VP8 / VP9 / AV1 软件编解码器和 H264 / H265 硬件编解码器。<br>完全掌控数据，轻松自建。<br>P2P 连接，端到端加密。<br>RustDesk 1.2 开始采用 Flutter 重写桌面版本，可以支持 Wayland 被控了。<br>国内的开发团队，知乎有账号（还比较活跃），有问题可以去提问。<br>RustDesk 官网： <a href="https://rustdesk.com/zh/">https://rustdesk.com/zh/</a></p><p>服务端 GitHub 地址： <a href="https://github.com/rustdesk/rustdesk-server">https://github.com/rustdesk/rustdesk-server</a></p><p>客户端下载地址： <a href="https://github.com/rustdesk/rustdesk/releases">https://github.com/rustdesk/rustdesk/releases</a></p><p>文档地址： <a href="https://rustdesk.com/docs/zh-cn">https://rustdesk.com/docs/zh-cn</a></p></blockquote><h2 id="一-部署"><a href="#一-部署" class="headerlink" title="一. 部署"></a>一. 部署</h2><p>docker-compose部署</p><p>镜像可选</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rustdesk/rustdesk-server-s6:latest</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:rustdesk-server-s6</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">rustdesk-server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">rustdesk/rustdesk-server-s6:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rustdesk-server</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">21115</span><span class="string">:21115</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">21116</span><span class="string">:21116</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">21116</span><span class="string">:21116/udp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">21117</span><span class="string">:21117</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;RELAY=192.168.30.69:21117&quot;</span>  <span class="comment"># 填入域名或者IP+hbbr的端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;ENCRYPTED_ONLY=1&quot;</span></span><br></pre></td></tr></table></figure><h2 id="二-使用"><a href="#二-使用" class="headerlink" title="二. 使用"></a>二. 使用</h2><p>下载客户端打开填入 服务器外网IP  及生成的key文件（cat /opt/rustdesk/data/id_ed25519.pub）  自己的客户端和 被控方的客户端都需要填入ID服务器 和key 点击远程即可。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_e133e39869f85fb864d9a6bc05ba20e1.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_e133e39869f85fb864d9a6bc05ba20e1.png"></p><p>此时即可远程。</p><h2 id="三-本文参考"><a href="#三-本文参考" class="headerlink" title="三. 本文参考"></a>三. 本文参考</h2><p><a href="https://blog.vlinyu.com/archives/docker-compose-remotedesk-rustdesk-server">【Docker 项目】之–RustDesk全平台远程桌面连接软件自建服务器流程-v林羽 (vlinyu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>部署类似知乎的问答社区Answer</title>
      <link href="/2024/05/30/%E9%83%A8%E7%BD%B2%E7%B1%BB%E4%BC%BC%E7%9F%A5%E4%B9%8E%E7%9A%84%E9%97%AE%E7%AD%94%E7%A4%BE%E5%8C%BAAnswer/"/>
      <url>/2024/05/30/%E9%83%A8%E7%BD%B2%E7%B1%BB%E4%BC%BC%E7%9F%A5%E4%B9%8E%E7%9A%84%E9%97%AE%E7%AD%94%E7%A4%BE%E5%8C%BAAnswer/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="部署类似知乎的问答社区Answer"><a href="#部署类似知乎的问答社区Answer" class="headerlink" title="部署类似知乎的问答社区Answer"></a>部署类似知乎的问答社区Answer</h1><h2 id="一-项目地址"><a href="#一-项目地址" class="headerlink" title="一. 项目地址"></a>一. 项目地址</h2><p>Answer 官方网址：<a href="https://answer.dev/">https://answer.dev/</a></p><p>Answer 官方 GitHub：<a href="https://github.com/answerdev/answer">https://github.com/answerdev/answer</a></p><p>Answer 官方文档：<a href="https://answer.dev/docs/installation/">https://answer.dev/docs/installation/</a></p><h2 id="二-Docker镜像"><a href="#二-Docker镜像" class="headerlink" title="二. Docker镜像"></a>二. Docker镜像</h2><p><a href="https://hub.docker.com/r/danielszabo99/microbin">https://hub.docker.com/r/danielszabo99/microbin</a></p><h2 id="三-项目介绍"><a href="#三-项目介绍" class="headerlink" title="三. 项目介绍"></a>三. 项目介绍</h2><blockquote><p>Answer是一个类似知乎的开源问答社区。支持Docker部署，目前GitHub拥有5.4K的star。</p></blockquote><h2 id="四-功能介绍"><a href="#四-功能介绍" class="headerlink" title="四. 功能介绍"></a>四. 功能介绍</h2><p>非常小巧<br>支持文件上传（例如：server.com/file/pig-dog-cat）<br>支持raw的文本服务（例如，server.com/raw/pig-dog-cat）<br>可以用来URL缩短和重定向<br>支持二维码<br>数据库非常简单（JSON+文件），可移植性强，易于备份和整合<br>支持列出使用过的列表<br>支持私有链接和公开链接，可编辑，可以设置链接的有效性<br>支持代码语法高亮<br>自动暗黑模式和自定义样式，只需很少的CSS和vanilla JS（见water.css）<br>默认以动物的名字作为结尾（可修改成随机字符）</p><h2 id="五-部署"><a href="#五-部署" class="headerlink" title="五. 部署"></a>五. 部署</h2><p>docker-copmpose 部署</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">answer:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">answerdev/answer</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;9008:80&#x27;</span>            <span class="comment"># 冒号左边可以改成自己服务器未被占用的端口</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./answer-data:/data</span>  <span class="comment"># 冒号左边可以改路径，现在是表示把数据存放在在当前文件夹下的 answer-data 文件夹中</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mariadb:10</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">answer</span>   <span class="comment"># 数据库用户root的密码，建议自行修改一个</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">answer</span>     </span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">answer</span>   <span class="comment"># 数据库用户answer的密码，建议自行修改一个</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">answer</span> </span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mariadb:/var/lib/mysql</span>  <span class="comment"># 冒号左边可以改路径，现在是表示把数据存放在在当前文件夹下的 mariadb 文件夹中</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">--character-set-server=utf8mb4</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br></pre></td></tr></table></figure><h2 id="六-效果"><a href="#六-效果" class="headerlink" title="六. 效果"></a>六. 效果</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_2f2f5fe7b710450a248e624a3299d855.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_2f2f5fe7b710450a248e624a3299d855.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_13c7b65b321acf267ffd7b70a31c1fad.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_13c7b65b321acf267ffd7b70a31c1fad.png"></p>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vmware esxi gpu直通</title>
      <link href="/2024/05/28/vmware%20esxi%20gpu%E7%9B%B4%E9%80%9A/"/>
      <url>/2024/05/28/vmware%20esxi%20gpu%E7%9B%B4%E9%80%9A/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="vmware-esxi-gpu直通"><a href="#vmware-esxi-gpu直通" class="headerlink" title="vmware esxi gpu直通"></a>vmware esxi gpu直通</h1><h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a href="https://www.dinghui.org/vmware-esxi-directpath-gpu.html">https://www.dinghui.org/vmware-esxi-directpath-gpu.html</a></p><p><a href="https://www.dinghui.org/vmware-esxi-nvidia-gpu.html">https://www.dinghui.org/vmware-esxi-nvidia-gpu.html</a></p><p><a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vsphere.resmgmt.doc/GUID-9044A2BA-D4E5-4221-87F4-0B1C8612B748.html">https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vsphere.resmgmt.doc/GUID-9044A2BA-D4E5-4221-87F4-0B1C8612B748.html</a></p>]]></content>
      
      
      <categories>
          
          <category> gpu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cloudfaler部署github文件下载加速</title>
      <link href="/2024/05/28/cloudfaler%E9%83%A8%E7%BD%B2github%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%8A%A0%E9%80%9F/"/>
      <url>/2024/05/28/cloudfaler%E9%83%A8%E7%BD%B2github%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%8A%A0%E9%80%9F/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="cloudfaler部署github文件下载加速"><a href="#cloudfaler部署github文件下载加速" class="headerlink" title="cloudfaler部署github文件下载加速"></a>cloudfaler部署github文件下载加速</h1><p>项目托管地址：<a href="https://github.com/hunshcn/gh-proxy">https://github.com/hunshcn/gh-proxy</a></p><p>构建: 只需要复制下方js代码到cloudflaer  workers中保存部署即可 建议绑定域名</p><p>cloudflaer workers地址：</p><p><a href="https://dash.cloudflare.com/65b0f21580ba74305f1bdcbc6d30210c/workers-and-pages">https://dash.cloudflare.com/65b0f21580ba74305f1bdcbc6d30210c/workers-and-pages</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * static files (404.html, sw.js, conf.js)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ASSET_URL</span> = <span class="string">&#x27;https://hunshcn.github.io/gh-proxy/&#x27;</span></span><br><span class="line"><span class="comment">// 前缀，如果自定义路由为example.com/gh/*，将PREFIX改为 &#x27;/gh/&#x27;，注意，少一个杠都会错！</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PREFIX</span> = <span class="string">&#x27;/&#x27;</span></span><br><span class="line"><span class="comment">// 分支文件使用jsDelivr镜像的开关，0为关闭，默认关闭</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Config</span> = &#123;</span><br><span class="line">    <span class="attr">jsdelivr</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> whiteList = [] <span class="comment">// 白名单，路径里面有包含字符的才会通过，e.g. [&#x27;/username/&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">ResponseInit</span>&#125; */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PREFLIGHT_INIT</span> = &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="number">204</span>,</span><br><span class="line">    <span class="attr">headers</span>: <span class="keyword">new</span> <span class="title class_">Headers</span>(&#123;</span><br><span class="line">        <span class="string">&#x27;access-control-allow-origin&#x27;</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;access-control-allow-methods&#x27;</span>: <span class="string">&#x27;GET,POST,PUT,PATCH,TRACE,DELETE,HEAD,OPTIONS&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;access-control-max-age&#x27;</span>: <span class="string">&#x27;1728000&#x27;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> exp1 = <span class="regexp">/^(?:https?:\/\/)?github\.com\/.+?\/.+?\/(?:releases|archive)\/.*$/i</span></span><br><span class="line"><span class="keyword">const</span> exp2 = <span class="regexp">/^(?:https?:\/\/)?github\.com\/.+?\/.+?\/(?:blob|raw)\/.*$/i</span></span><br><span class="line"><span class="keyword">const</span> exp3 = <span class="regexp">/^(?:https?:\/\/)?github\.com\/.+?\/.+?\/(?:info|git-).*$/i</span></span><br><span class="line"><span class="keyword">const</span> exp4 = <span class="regexp">/^(?:https?:\/\/)?raw\.(?:githubusercontent|github)\.com\/.+?\/.+?\/.+?\/.+$/i</span></span><br><span class="line"><span class="keyword">const</span> exp5 = <span class="regexp">/^(?:https?:\/\/)?gist\.(?:githubusercontent|github)\.com\/.+?\/.+?\/.+$/i</span></span><br><span class="line"><span class="keyword">const</span> exp6 = <span class="regexp">/^(?:https?:\/\/)?github\.com\/.+?\/.+?\/tags.*$/i</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">any</span>&#125; <span class="variable">body</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; <span class="variable">status</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object&lt;string, string&gt;</span>&#125; <span class="variable">headers</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeRes</span>(<span class="params">body, status = <span class="number">200</span>, headers = &#123;&#125;</span>) &#123;</span><br><span class="line">    headers[<span class="string">&#x27;access-control-allow-origin&#x27;</span>] = <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(body, &#123;status, headers&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">urlStr</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">newUrl</span>(<span class="params">urlStr</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">URL</span>(urlStr)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ret = <span class="title function_">fetchHandler</span>(e)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="title function_">makeRes</span>(<span class="string">&#x27;cfworker error:\n&#x27;</span> + err.<span class="property">stack</span>, <span class="number">502</span>))</span><br><span class="line">    e.<span class="title function_">respondWith</span>(ret)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">checkUrl</span>(<span class="params">u</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> [exp1, exp2, exp3, exp4, exp5, exp6]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (u.<span class="title function_">search</span>(i) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">FetchEvent</span>&#125; <span class="variable">e</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchHandler</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> req = e.<span class="property">request</span></span><br><span class="line">    <span class="keyword">const</span> urlStr = req.<span class="property">url</span></span><br><span class="line">    <span class="keyword">const</span> urlObj = <span class="keyword">new</span> <span class="title function_">URL</span>(urlStr)</span><br><span class="line">    <span class="keyword">let</span> path = urlObj.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (path) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">redirect</span>(<span class="string">&#x27;https://&#x27;</span> + urlObj.<span class="property">host</span> + <span class="variable constant_">PREFIX</span> + path, <span class="number">301</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// cfworker 会把路径中的 `//` 合并成 `/`</span></span><br><span class="line">    path = urlObj.<span class="property">href</span>.<span class="title function_">substr</span>(urlObj.<span class="property">origin</span>.<span class="property">length</span> + <span class="variable constant_">PREFIX</span>.<span class="property">length</span>).<span class="title function_">replace</span>(<span class="regexp">/^https?:\/+/</span>, <span class="string">&#x27;https://&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (path.<span class="title function_">search</span>(exp1) === <span class="number">0</span> || path.<span class="title function_">search</span>(exp5) === <span class="number">0</span> || path.<span class="title function_">search</span>(exp6) === <span class="number">0</span> || path.<span class="title function_">search</span>(exp3) === <span class="number">0</span> || path.<span class="title function_">search</span>(exp4) === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">httpHandler</span>(req, path)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.<span class="title function_">search</span>(exp2) === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Config</span>.<span class="property">jsdelivr</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> newUrl = path.<span class="title function_">replace</span>(<span class="string">&#x27;/blob/&#x27;</span>, <span class="string">&#x27;@&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/^(?:https?:\/\/)?github\.com/</span>, <span class="string">&#x27;https://cdn.jsdelivr.net/gh&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">redirect</span>(newUrl, <span class="number">302</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            path = path.<span class="title function_">replace</span>(<span class="string">&#x27;/blob/&#x27;</span>, <span class="string">&#x27;/raw/&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">httpHandler</span>(req, path)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.<span class="title function_">search</span>(exp4) === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> newUrl = path.<span class="title function_">replace</span>(<span class="regexp">/(?&lt;=com\/.+?\/.+?)\/(.+?\/)/</span>, <span class="string">&#x27;@$1&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/^(?:https?:\/\/)?raw\.(?:githubusercontent|github)\.com/</span>, <span class="string">&#x27;https://cdn.jsdelivr.net/gh&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">redirect</span>(newUrl, <span class="number">302</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="variable constant_">ASSET_URL</span> + path)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Request</span>&#125; <span class="variable">req</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">pathname</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">httpHandler</span>(<span class="params">req, pathname</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> reqHdrRaw = req.<span class="property">headers</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// preflight</span></span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> === <span class="string">&#x27;OPTIONS&#x27;</span> &amp;&amp;</span><br><span class="line">        reqHdrRaw.<span class="title function_">has</span>(<span class="string">&#x27;access-control-request-headers&#x27;</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="literal">null</span>, <span class="variable constant_">PREFLIGHT_INIT</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> reqHdrNew = <span class="keyword">new</span> <span class="title class_">Headers</span>(reqHdrRaw)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> urlStr = pathname</span><br><span class="line">    <span class="keyword">let</span> flag = !<span class="title class_">Boolean</span>(whiteList.<span class="property">length</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> whiteList) &#123;</span><br><span class="line">        <span class="keyword">if</span> (urlStr.<span class="title function_">includes</span>(i)) &#123;</span><br><span class="line">            flag = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">&quot;blocked&quot;</span>, &#123;<span class="attr">status</span>: <span class="number">403</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (urlStr.<span class="title function_">search</span>(<span class="regexp">/^https?:\/\//</span>) !== <span class="number">0</span>) &#123;</span><br><span class="line">        urlStr = <span class="string">&#x27;https://&#x27;</span> + urlStr</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> urlObj = <span class="title function_">newUrl</span>(urlStr)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">RequestInit</span>&#125; */</span></span><br><span class="line">    <span class="keyword">const</span> reqInit = &#123;</span><br><span class="line">        <span class="attr">method</span>: req.<span class="property">method</span>,</span><br><span class="line">        <span class="attr">headers</span>: reqHdrNew,</span><br><span class="line">        <span class="attr">redirect</span>: <span class="string">&#x27;manual&#x27;</span>,</span><br><span class="line">        <span class="attr">body</span>: req.<span class="property">body</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">proxy</span>(urlObj, reqInit)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">URL</span>&#125; <span class="variable">urlObj</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">RequestInit</span>&#125; <span class="variable">reqInit</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">proxy</span>(<span class="params">urlObj, reqInit</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(urlObj.<span class="property">href</span>, reqInit)</span><br><span class="line">    <span class="keyword">const</span> resHdrOld = res.<span class="property">headers</span></span><br><span class="line">    <span class="keyword">const</span> resHdrNew = <span class="keyword">new</span> <span class="title class_">Headers</span>(resHdrOld)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> status = res.<span class="property">status</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resHdrNew.<span class="title function_">has</span>(<span class="string">&#x27;location&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">let</span> _location = resHdrNew.<span class="title function_">get</span>(<span class="string">&#x27;location&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">checkUrl</span>(_location))</span><br><span class="line">            resHdrNew.<span class="title function_">set</span>(<span class="string">&#x27;location&#x27;</span>, <span class="variable constant_">PREFIX</span> + _location)</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            reqInit.<span class="property">redirect</span> = <span class="string">&#x27;follow&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">proxy</span>(<span class="title function_">newUrl</span>(_location), reqInit)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    resHdrNew.<span class="title function_">set</span>(<span class="string">&#x27;access-control-expose-headers&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    resHdrNew.<span class="title function_">set</span>(<span class="string">&#x27;access-control-allow-origin&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    resHdrNew.<span class="title function_">delete</span>(<span class="string">&#x27;content-security-policy&#x27;</span>)</span><br><span class="line">    resHdrNew.<span class="title function_">delete</span>(<span class="string">&#x27;content-security-policy-report-only&#x27;</span>)</span><br><span class="line">    resHdrNew.<span class="title function_">delete</span>(<span class="string">&#x27;clear-site-data&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(res.<span class="property">body</span>, &#123;</span><br><span class="line">        status,</span><br><span class="line">        <span class="attr">headers</span>: resHdrNew,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spug自动化运维平台部署</title>
      <link href="/2024/05/24/spug%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/05/24/spug%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="spug自动化运维平台部署"><a href="#spug自动化运维平台部署" class="headerlink" title="spug自动化运维平台部署"></a>spug自动化运维平台部署</h2><blockquote><p>开源企业官网：<a href="https://www.spug.cc/">https://www.spug.cc</a></p></blockquote><p>docker-compose部署</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">spug-db</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">--port</span> <span class="number">3306</span> <span class="string">--character-set-server=utf8mb4</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/spug/mysql:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=spug</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_USER=spug</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=spug.cc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=spug.cc</span></span><br><span class="line">  <span class="attr">spug:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:spug-service</span> </span><br><span class="line">    <span class="comment">#openspug/spug-service</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">spug</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/spug/service:/data/spug</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/spug/repos:/data/repos</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># 如果80端口被占用可替换为其他端口，例如: - &quot;8000:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=spug</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_USER=spug</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=spug.cc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_HOST=db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_PORT=3306</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br></pre></td></tr></table></figure><p>初始化登录管理员用户,以下操作会创建一个用户名为 <code>admin</code> 密码为 <code>test123</code> 的管理员账户，可自行替换管理员账户/密码。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec spug init_spug admin test123</span><br></pre></td></tr></table></figure><p>登录：<a href="http://localhost/">http://localhost</a></p>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网页添加 Live2D 看板娘</title>
      <link href="/2024/05/21/%E7%BD%91%E9%A1%B5%E6%B7%BB%E5%8A%A0%20Live2D%20%E7%9C%8B%E6%9D%BF%E5%A8%98/"/>
      <url>/2024/05/21/%E7%BD%91%E9%A1%B5%E6%B7%BB%E5%8A%A0%20Live2D%20%E7%9C%8B%E6%9D%BF%E5%A8%98/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="网页添加-Live2D-看板娘"><a href="#网页添加-Live2D-看板娘" class="headerlink" title="网页添加 Live2D 看板娘"></a>网页添加 Live2D 看板娘</h1><p>参考/转载处：</p><p><a href="https://www.fghrsh.net/post/123.html">https://www.fghrsh.net/post/123.html</a><br><a href="https://github.com/fghrsh/live2d/_demo">https://github.com/fghrsh/live2d\_demo</a><br><a href="https://www.cnblogs.com/goodmemoryblog/p/14279625.html">https://www.cnblogs.com/goodmemoryblog/p/14279625.html</a><br><a href="https://www.cnblogs.com/yjlaugus/p/8724881.html#/c/subject/p/8724881.html">https://www.cnblogs.com/yjlaugus/p/8724881.html#/c/subject/p/8724881.html</a><br><a href="https://www.cnblogs.com/Lantxy/p/13112000.html">https://www.cnblogs.com/Lantxy/p/13112000.html</a></p><p>本文转载链接：<a href="https://www.cnblogs.com/eve-d/p/15683541.html">网页添加 Live2D 看板娘（菜鸟级详细教程） - 妖妖未初 - 博客园 (cnblogs.com)</a></p><p>Live2D开源项目地址：</p><p><a href="https://github.com/xiazeyu/live2d-widget-models">https://github.com/xiazeyu/live2d-widget-models</a><br><a href="https://github.com/GEGEWU-CLOUD/live2d-widget-models">https://github.com/GEGEWU-CLOUD/live2d-widget-models</a></p><p>L2Dwidget.min.js 存于:</p><p><a href="https://drive.wn-apple-teawine.fun/api/raw/?path=/public-tools/Live2D/%E9%80%9A%E7%94%A8js/L2Dwidget.min.js">https://drive.wn-apple-teawine.fun/api/raw/?path=/public-tools/Live2D/通用js/L2Dwidget.min.js</a></p><p>记录自己学习操作的过程：<br>看着别人博客主页的看板娘好萌好贴心，自己也想弄一个啊，怎么办，不会啊。。。。。。。。。。当、当、当，本菜鸟将亲自实践，弄一个，此处记录自己的学习实践过程，也供大家参考。</p><h2 id="一、基本工作"><a href="#一、基本工作" class="headerlink" title="一、基本工作"></a>一、基本工作</h2><h3 id="1、要自定义博客，首先登录自己的账号，在自己博客主页找到管理，点击设置"><a href="#1、要自定义博客，首先登录自己的账号，在自己博客主页找到管理，点击设置" class="headerlink" title="1、要自定义博客，首先登录自己的账号，在自己博客主页找到管理，点击设置"></a>1、要自定义博客，首先登录自己的账号，在自己博客主页找到管理，点击设置</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_e77040f256eadd57f3446ab8d6e60d16.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_e77040f256eadd57f3446ab8d6e60d16.png"></p><h3 id="2、点击设置后，进入到基本设置页面，看是否有js权限，如果没有就先申请"><a href="#2、点击设置后，进入到基本设置页面，看是否有js权限，如果没有就先申请" class="headerlink" title="2、点击设置后，进入到基本设置页面，看是否有js权限，如果没有就先申请"></a>2、点击设置后，进入到基本设置页面，看是否有js权限，如果没有就先申请</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_048d8db540e75eec0fd0bbf8e94904b3.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_048d8db540e75eec0fd0bbf8e94904b3.png">⚠️：已经有了js权限，下面的操作才有效</p><h2 id="二、添加看板娘操作"><a href="#二、添加看板娘操作" class="headerlink" title="二、添加看板娘操作"></a>二、添加看板娘操作</h2><h3 id="1、最最最精简版："><a href="#1、最最最精简版：" class="headerlink" title="1、最最最精简版："></a>1、最最最精简版：</h3><p>在博客侧边栏公告处添加如下代码</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_574d813c1585364829bf47ae76ffda46.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_574d813c1585364829bf47ae76ffda46.png"></p><p>代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 网页侧边添加猫咪 --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://files.cnblogs.com/files/liuzhou1/L2Dwidget.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  L2Dwidget.<span class="title function_">init</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;model&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">jsonPath</span>: <span class="string">&quot;https://unpkg.com/live2d-widget-model-tororo@1.0.5/assets/tororo.model.json&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;scale&quot;</span>: <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;display&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;position&quot;</span>: <span class="string">&quot;right&quot;</span>, <span class="comment">//模型的表现位置</span></span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;width&quot;</span>: <span class="number">150</span>, <span class="comment">//模型的宽度</span></span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;height&quot;</span>: <span class="number">300</span>, <span class="comment">//模型的高度</span></span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;hOffset&quot;</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;vOffset&quot;</span>: -<span class="number">20</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;mobile&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;show&quot;</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;scale&quot;</span>: <span class="number">0.5</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;react&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;opacityDefault&quot;</span>: <span class="number">0.7</span>, <span class="comment">//模型默认透明度</span></span></span><br><span class="line"><span class="language-javascript">  <span class="string">&quot;opacityOnHover&quot;</span>: <span class="number">0.2</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 网页侧边添加猫咪 --&gt;</span></span><br></pre></td></tr></table></figure><p>最后保存，即可成功</p><p>一只可爱的小猫咪就有啦</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_5ec4c415016c2d8230473f35c8b9898e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_5ec4c415016c2d8230473f35c8b9898e.png"></p><p>如果想换其他模版，可以修改 <code>jsonPath</code> 的路径，可选的模型（从此处整理来：<a href="https://www.cnblogs.com/goodmemoryblog/p/14279625.html%EF%BC%89%E6%9C%89%EF%BC%9A">https://www.cnblogs.com/goodmemoryblog/p/14279625.html）有：</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//黑猫咪：https://unpkg.com/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json</span><br><span class="line">//白猫咪：https://unpkg.com/live2d-widget-model-tororo@1.0.5/assets/tororo.model.json</span><br><span class="line">//萌娘：https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json</span><br><span class="line">//狗狗：https://unpkg.com/live2d-widget-model-wanko@1.0.5/assets/wanko.model.json</span><br><span class="line">//萌妹1号：https://unpkg.com/live2d-widget-model-z16@1.0.5/assets/z16.model.json</span><br><span class="line">//萌妹2号：https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json</span><br><span class="line">//萌妹3号：https://unpkg.com/live2d-widget-model-hibiki@1.0.5/assets/hibiki.model.json</span><br><span class="line">//妹子4号：https://unpkg.com/live2d-widget-model-izumi@1.0.5/assets/izumi.model.json</span><br><span class="line">//妹子5号：https://unpkg.com/live2d-widget-model-miku@1.0.5/assets/miku.model.json</span><br><span class="line">//6号：https://unpkg.com/live2d-widget-model-nico@1.0.5/assets/nico.model.json</span><br><span class="line">//7号：https://unpkg.com/live2d-widget-model-ni-j@1.0.5/assets/ni-j.model.json</span><br><span class="line">//8号：https://unpkg.com/live2d-widget-model-nipsilon@1.0.5/assets/nipsilon.model.json</span><br><span class="line">//9号：https://unpkg.com/live2d-widget-model-nito@1.0.5/assets/nito.model.json</span><br><span class="line">//10号：https://unpkg.com/live2d-widget-model-tsumiki@1.0.5/assets/tsumiki.model.json</span><br><span class="line">//11号：https://unpkg.com/live2d-widget-model-unitychan@1.0.5/assets/unitychan.model.json</span><br><span class="line">//帅哥1号：https://unpkg.com/live2d-widget-model-chitose@1.0.5/assets/chitose.model.json</span><br><span class="line">//帅哥2号：https://unpkg.com/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2、添加可以说话的看板娘，操作如下："><a href="#2、添加可以说话的看板娘，操作如下：" class="headerlink" title="2、添加可以说话的看板娘，操作如下："></a>2、添加可以说话的看板娘，操作如下：</h3><p>参考地址：<a href="https://www.cnblogs.com/Lantxy/p/13112000.html%E3%80%82">https://www.cnblogs.com/Lantxy/p/13112000.html。</a> 感谢🙏博主</p><p>成品：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_8bdf0fcd97ff7dbc79a468a55689bbf5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_8bdf0fcd97ff7dbc79a468a55689bbf5.png"></p><p>1）在基本工作的基础上（在管理=》设置页面），找到页面定制CSS代码，将代码添加进去，不禁用模版默认CSS，不然页面的基础结构会乱，当然你可以自己去写/换样式。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_dff8d272ae66a655129e0cefc10d7c8a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_dff8d272ae66a655129e0cefc10d7c8a.png"></p><p>CSS代码：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">*&#123;</span><br><span class="line"><span class="attribute">transition</span>: all <span class="number">0.4s</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#home</span> &#123;</span><br><span class="line"><span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">80%</span>;<span class="comment">/*原始65*/</span></span><br><span class="line"><span class="attribute">min-width</span>: <span class="number">980px</span>;<span class="comment">/*页面顶部的宽度*/</span></span><br><span class="line">&quot;&gt;rgba(<span class="number">245</span>, <span class="number">245</span>, <span class="number">245</span>, <span class="number">0.7</span>);</span><br><span class="line"><span class="attribute">padding</span>: <span class="number">30px</span>;</span><br><span class="line"><span class="attribute">margin-top</span>: <span class="number">50px</span>;</span><br><span class="line"><span class="attribute">margin-bottom</span>: <span class="number">50px</span>;</span><br><span class="line"><span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">6px</span> <span class="built_in">rgba</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>, <span class="number">0.3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line"><span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;http://ww4.sinaimg.cn/large/637d0877gw1exlma5gj0wj21hc0u04p6.jpg&quot;</span>);</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">12</span>, <span class="number">100</span>, <span class="number">129</span>, <span class="number">1</span>) <span class="built_in">url</span>(<span class="string">&#x27;http://images.cnblogs.com/cnblogs_com/Penn000/1013849/o_123.jpg&#x27;</span>) fixed no-repeat;</span><br><span class="line"><span class="attribute">background-position</span>: <span class="number">50%</span> <span class="number">5%</span>;</span><br><span class="line"><span class="attribute">background-size</span>: cover;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#navList</span> <span class="selector-tag">li</span>&#123;</span><br><span class="line"><span class="attribute">cursor</span>: pointer;</span><br><span class="line"><span class="attribute">transition</span>: all <span class="number">0.2s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#navList</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line"><span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.5</span>) <span class="built_in">rotate</span>(<span class="number">360deg</span>);</span><br><span class="line"><span class="attribute">color</span>:<span class="number">#FF0</span>;</span><br><span class="line"><span class="attribute">opacity</span>:<span class="number">0.5</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#blogTitle</span> &#123;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">100px</span>; <span class="comment">/*高度*/</span></span><br><span class="line"><span class="attribute">clear</span>: both;</span><br><span class="line">&quot;&gt;rgba(<span class="number">245</span>, <span class="number">245</span>, <span class="number">245</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#blogTitle</span> <span class="selector-tag">h1</span> &#123;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">36px</span>;</span><br><span class="line"><span class="attribute">font-weight</span>: bold;</span><br><span class="line"><span class="attribute">line-height</span>: <span class="number">1.8em</span>;<span class="comment">/*原始 1.6em*/</span></span><br><span class="line"><span class="attribute">margin-top</span>: <span class="number">10px</span>;<span class="comment">/*原始 15px */</span></span><br><span class="line"><span class="attribute">color</span>: <span class="number">#548B54</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#blogTitle</span> <span class="selector-tag">h2</span> &#123;</span><br><span class="line"><span class="attribute">font-weight</span>: normal;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">17px</span>;<span class="comment">/*原始 16px ；font-size: 1.0rem;*/</span></span><br><span class="line"><span class="attribute">line-height</span>: <span class="number">1.8</span>;</span><br><span class="line"><span class="attribute">color</span>: <span class="number">#111</span>;</span><br><span class="line"><span class="attribute">font-weight</span>: bold;</span><br><span class="line"><span class="attribute">text-align</span>: right;</span><br><span class="line"><span class="attribute">float</span>: right;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#navigator</span>&#123;</span><br><span class="line">&quot;&gt;rgba(<span class="number">33</span>, <span class="number">160</span>, <span class="number">139</span>, <span class="number">0.9</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#navList</span> <span class="selector-tag">a</span><span class="selector-pseudo">:link</span>, <span class="selector-id">#navList</span> <span class="selector-tag">a</span><span class="selector-pseudo">:visited</span>, <span class="selector-id">#navList</span> <span class="selector-tag">a</span><span class="selector-pseudo">:active</span>&#123;</span><br><span class="line"><span class="attribute">color</span>: <span class="number">#eee</span>;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">18px</span>;</span><br><span class="line"><span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.blogStats</span>&#123;</span><br><span class="line"><span class="attribute">color</span>: <span class="number">#eee</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.postTitle</span> &#123;</span><br><span class="line"><span class="attribute">border-left</span>: <span class="number">8px</span> solid <span class="built_in">rgba</span>(<span class="number">33</span>, <span class="number">160</span>, <span class="number">139</span>, <span class="number">0.68</span>);</span><br><span class="line"><span class="attribute">margin-left</span>: <span class="number">10px</span>;</span><br><span class="line"><span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line"><span class="attribute">float</span>: right;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line"><span class="attribute">clear</span>: both;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.postTitle</span> <span class="selector-tag">a</span><span class="selector-pseudo">:link</span>, <span class="selector-class">.postTitle</span> <span class="selector-tag">a</span><span class="selector-pseudo">:visited</span>, <span class="selector-class">.postTitle</span> <span class="selector-tag">a</span><span class="selector-pseudo">:active</span> &#123;</span><br><span class="line"><span class="attribute">color</span>: <span class="number">#21759b</span>;</span><br><span class="line"><span class="attribute">transition</span>: all <span class="number">0.4s</span> linear <span class="number">0s</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.postTitle</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line"><span class="attribute">margin-left</span>: <span class="number">30px</span>;</span><br><span class="line"><span class="attribute">color</span>: <span class="number">#0f3647</span>;</span><br><span class="line"><span class="attribute">text-decoration</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.postCon</span> &#123;</span><br><span class="line"><span class="attribute">float</span>: right;</span><br><span class="line"><span class="attribute">line-height</span>: <span class="number">1.5em</span>;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line"><span class="attribute">clear</span>: both;</span><br><span class="line"><span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.day</span> <span class="selector-class">.postTitle</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line"><span class="attribute">padding-left</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.day</span> &#123;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.5</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*文章附加信息*/</span></span><br><span class="line"><span class="selector-class">.postDesc</span> &#123;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">url</span>(<span class="string">images/posted_time.png</span>) no-repeat <span class="number">0</span> <span class="number">1px</span>;</span><br><span class="line"><span class="attribute">color</span>: <span class="number">#757575</span>;</span><br><span class="line"><span class="attribute">float</span>: left;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line"><span class="attribute">clear</span>: both;</span><br><span class="line"><span class="attribute">text-align</span>: left;</span><br><span class="line"><span class="attribute">font-family</span>: <span class="string">&quot;微软雅黑&quot;</span> , <span class="string">&quot;宋体&quot;</span> , <span class="string">&quot;黑体&quot;</span> ,Arial;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">13px</span>;</span><br><span class="line"><span class="attribute">padding-right</span>: <span class="number">20px</span>;<span class="comment">/*5px padding-left: 90px;posted 发表时间左边距离*/</span></span><br><span class="line"><span class="attribute">margin-top</span>: <span class="number">20px</span>;</span><br><span class="line"><span class="attribute">line-height</span>: <span class="number">1.8</span>;</span><br><span class="line"><span class="attribute">padding-bottom</span>: <span class="number">35px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.newsItem</span>, <span class="selector-class">.catListEssay</span>, <span class="selector-class">.catListLink</span>, <span class="selector-class">.catListNoteBook</span>, <span class="selector-class">.catListTag</span>, <span class="selector-class">.catListPostCategory</span>,</span><br><span class="line"><span class="selector-class">.catListPostArchive</span>, <span class="selector-class">.catListImageCategory</span>, <span class="selector-class">.catListArticleArchive</span>, <span class="selector-class">.catListView</span>,</span><br><span class="line"><span class="selector-class">.catListFeedback</span>, <span class="selector-class">.mySearch</span>, <span class="selector-class">.catListComment</span>, <span class="selector-class">.catListBlogRank</span>, <span class="selector-class">.catList</span>, <span class="selector-class">.catListArticleCategory</span> ,<span class="selector-id">#blog-calendar</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.5</span>);</span><br><span class="line"><span class="attribute">margin-bottom</span>: <span class="number">35px</span>;</span><br><span class="line"><span class="attribute">word-wrap</span>: break-word;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.CalTitle</span>&#123;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.catListTitle</span>&#123;</span><br><span class="line">&quot;&gt;rgba(<span class="number">33</span>, <span class="number">160</span>, <span class="number">139</span>, <span class="number">0.9</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#topics</span>&#123;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.c_ad_block</span>&#123;</span><br><span class="line"><span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#tbCommentBody</span>&#123;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#q</span>&#123;<span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.CalNextPrev</span>&#123;<span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>);&#125;</span><br></pre></td></tr></table></figure><p>2）在博客侧边栏加入，下面代码</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_1870159a9879f476f71cf451334326e8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_1870159a9879f476f71cf451334326e8.png"></p><p>⚠️：将代码中的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">link</span> rel=<span class="string">&quot;stylesheet&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;text/css&quot;</span> href=<span class="string">&quot;https://blog-static.cnblogs.com/files/eve-d/waifu.css&quot;</span>/&gt;</span><br><span class="line">&lt;<span class="built_in">link</span> rel=<span class="string">&quot;stylesheet&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;text/css&quot;</span> href=<span class="string">&quot;https://blog-static.cnblogs.com/files/eve-d/flat-ui.min.css&quot;</span>/&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;https://blog-static.cnblogs.com/files/eve-d/live2d.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;https://blog-static.cnblogs.com/files/eve-d/waifu-tips.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>换成自己的链接地址，步骤如下</p><p>i、参考下面地址下载需要上传的文件</p><p>⚠️：<a href="https://www.cnblogs.com/Lantxy/p/13112000.html%EF%BC%8C%E5%80%9F%E7%94%A8%E5%8D%9A%E4%B8%BB%E7%9A%84%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80%EF%BC%8C%E6%84%9F%E8%B0%A2%F0%9F%99%8F">https://www.cnblogs.com/Lantxy/p/13112000.html，借用博主的下载地址，感谢🙏</a></p><p>ii、将4个文件下载好，在博客园的文件中上传，点击进去，复制上面地址替换相应位置</p><p>点击文件：</p><p>选择文件上传，成功后便有下面四个文件，点击上传后的文件</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_99426f652dfc59f2251960920fe4fa99.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_99426f652dfc59f2251960920fe4fa99.png"></p><p>在跳转的页面，拿到自己的链接地址，替换相应的地方，四个文件步骤一样</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_1fc3cac4eea4ea295052a0b2c54d42fa.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_1fc3cac4eea4ea295052a0b2c54d42fa.png"></p><p>添加代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Live2D 看板娘 v1.2 / Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://blog-static.cnblogs.com/files/eve-d/waifu.css&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://blog-static.cnblogs.com/files/eve-d/flat-ui.min.css&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;h2&gt;&lt;a href=&quot;https://www.fghrsh.net/post/123.html&quot; style=&quot;color: #38A3DB&quot;&gt;Live2D 看板娘 v1.2&lt;/a&gt; / Demo&lt;/h2&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;touxiangdiv&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;touxiang&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://pic.cnblogs.com/avatar/2063441/20200611132410.png&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;waifu&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;waifu-tips&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;live2d&quot;</span> <span class="attr">width</span>=<span class="string">&quot;280&quot;</span> <span class="attr">height</span>=<span class="string">&quot;250&quot;</span> <span class="attr">class</span>=<span class="string">&quot;live2d&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;waifu-tool&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;fui-chat&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;fui-user&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;fui-cross&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://blog-static.cnblogs.com/files/eve-d/live2d.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://blog-static.cnblogs.com/files/eve-d/waifu-tips.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"><span class="title function_">initModel</span>(<span class="string">&quot;assets/&quot;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#touxiang</span>&#123;</span></span><br><span class="line"><span class="language-css"><span class="attribute">width</span>:auto;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://blog-static.cnblogs.com/files/eve-d/flat-ui.min.css&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>先存问题，这个资源的链接地址出了的点问题导致，页面的看板娘没加载出来</p><p>3、高级版todo。。。</p><link rel="stylesheet" type="text/css" href="https://blog-static.cnblogs.com/files/eve-d/waifu.css"><link rel="stylesheet" type="text/css" href="https://blog-static.cnblogs.com/files/eve-d/flat-ui.min.css"><link rel="stylesheet" type="text/css" href="https://blog-static.cnblogs.com/files/eve-d/flat-ui.min.css"><link rel="stylesheet" type="text/css" href="https://blog-static.cnblogs.com/files/eve-d/waifu.css">]]></content>
      
      
      <categories>
          
          <category> Live2D </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Live2D </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux宿主机配置定时任务在docker容器中不执行问题</title>
      <link href="/2024/05/19/linux%E5%AE%BF%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%9C%A8docker%E5%AE%B9%E5%99%A8%E4%B8%AD%E4%B8%8D%E6%89%A7%E8%A1%8C%E9%97%AE%E9%A2%98/"/>
      <url>/2024/05/19/linux%E5%AE%BF%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%9C%A8docker%E5%AE%B9%E5%99%A8%E4%B8%AD%E4%B8%8D%E6%89%A7%E8%A1%8C%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="linux宿主机配置定时任务在docker容器中不执行问题"><a href="#linux宿主机配置定时任务在docker容器中不执行问题" class="headerlink" title="linux宿主机配置定时任务在docker容器中不执行问题"></a>linux宿主机配置定时任务在docker容器中不执行问题</h2><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>去掉交互式执行-it选择 可执行文件docker编写为路径即<code>/usr/bin/docker</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10 * * * * /opt/maxkb/cp_logo_create_app_maxkb.sh </span><br><span class="line">0 9 * * * /usr/bin/docker <span class="built_in">exec</span> webstack_mysql bash /home/mysqlbak/webstack-dbbak.sh</span><br><span class="line">0 10 * * * /usr/bin/docker <span class="built_in">exec</span> confluse_mysql bash /home/db_bak_sh/confluence_dbbak.sh</span><br></pre></td></tr></table></figure><p>并将docker内部需要备份的目录及脚本内定义的目录 使用volume持久化到宿主机 即可。</p><p>实际使用参考：<a href="https://sunlight.zznnwn.cloudns.biz/2024/04/17/confluence%E9%83%A8%E7%BD%B2/?highlight=conf">couluence容器版数据库备份</a></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>confluence管理员密码失效重置密码</title>
      <link href="/2024/05/16/confluence%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81%E5%A4%B1%E6%95%88%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81/"/>
      <url>/2024/05/16/confluence%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81%E5%A4%B1%E6%95%88%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="confluence管理员密码失效重置密码"><a href="#confluence管理员密码失效重置密码" class="headerlink" title="confluence管理员密码失效重置密码"></a>confluence管理员密码失效重置密码</h1><p><strong>wiki 重置 admin 用户密码</strong></p><p>在 /var/atlassian/application-data/confluence/confluence.cfg.xml 文件中查看 mysql  root 用户的密码</p><p>重置 wiki admin 用户密码</p><p>mysql&gt; use confluence</p><p>获取 admin 用户 id：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> u.id, u.user_name, u.active <span class="keyword">from</span> cwd_user u</span><br><span class="line"><span class="keyword">join</span> cwd_membership m <span class="keyword">on</span> u.id<span class="operator">=</span>m.child_user_id <span class="keyword">join</span> cwd_group g <span class="keyword">on</span> m.parent_id<span class="operator">=</span>g.id <span class="keyword">join</span> cwd_directory d <span class="keyword">on</span> d.id<span class="operator">=</span>g.directory_id</span><br><span class="line"><span class="keyword">where</span> g.group_name <span class="operator">=</span> <span class="string">&#x27;confluence-administrators&#x27;</span> <span class="keyword">and</span> d.directory_name<span class="operator">=</span><span class="string">&#x27;Confluence Internal Directory&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将 admin 用户密码重置为 admin</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> cwd_user <span class="keyword">set</span> credential <span class="operator">=</span></span><br><span class="line"><span class="string">&#x27;x61Ey612Kl2gpFL56FT9weDnpSo4AV8j8+qx2AuTHdRyY036xxzTTrw10Wq3+4qQyB+XURPWx1ONxp3Y3pB37A==&#x27;</span></span><br><span class="line"><span class="keyword">where</span> id<span class="operator">=</span>xxxxxx;</span><br></pre></td></tr></table></figure><p>注意此处xxxxxx 为上一步的 id</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>部署ollama本地大模型并对接maxkb使用</title>
      <link href="/2024/05/15/%E9%83%A8%E7%BD%B2ollama%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%B9%B6%E5%AF%B9%E6%8E%A5maxkb%E4%BD%BF%E7%94%A8/"/>
      <url>/2024/05/15/%E9%83%A8%E7%BD%B2ollama%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%B9%B6%E5%AF%B9%E6%8E%A5maxkb%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="部署ollama本地大模型并对接maxkb使用"><a href="#部署ollama本地大模型并对接maxkb使用" class="headerlink" title="部署ollama本地大模型并对接maxkb使用"></a>部署ollama本地大模型并对接maxkb使用</h1><blockquote><p>github托管地址：</p><p><a href="https://github.com/ollama/ollama">ollama/ollama: Get up and running with Llama 3, Mistral, Gemma, and other large language models. (github.com)</a></p><p>模型官网：</p><p><a href="https://ollama.com/library/llama3">https://ollama.com/library/llama3</a></p><p>qwen模型下载地址：</p><p><a href="https://huggingface.co/Qwen/Qwen1.5-0.5B-Chat-GGUF/tree/main">https://huggingface.co/Qwen/Qwen1.5-0.5B-Chat-GGUF/tree/main</a></p><p>liama2下载：<a href="https://llama-2.ai/download/">https://llama-2.ai/download/</a></p><p>liama3下载：<a href="https://llama.meta.com/llama-downloads/">Download Llama (meta.com)</a></p><p><strong>Llama3-8B-Instruct模型下载地址：</strong></p><p>魔搭社区（境内）：<a href="https://caovan.com/go?_=48ce46a27aaHR0cHM6Ly9tb2RlbHNjb3BlLmNuL21vZGVscy9MTE0tUmVzZWFyY2gvTWV0YS1MbGFtYS0zLThCLUluc3RydWN0L2ZpbGVz">https://modelscope.cn/models/LLM-Research/Meta-Llama-3-8B-Instruct/files</a></p><p>huggingface（境外）：<a href="https://caovan.com/go?_=72db84b679aHR0cHM6Ly9odWdnaW5nZmFjZS5jby9tZXRhLWxsYW1hL01ldGEtTGxhbWEtMy04Qi1JbnN0cnVjdC90cmVlL21haW4=">https://huggingface.co/meta-llama/Meta-Llama-3-8B-Instruct/tree/main</a></p><p><a href="https://caovan.com/tag/603" title="LLaMA-Factory">LLaMA-Factory</a>项目地址：<a href="https://caovan.com/go?_=8c0f2d3483aHR0cHM6Ly9naXRodWIuY29tL2hpeW91Z2EvTExhTUEtRmFjdG9yeQ==">https://github.com/hiyouga/LLaMA-Factory</a></p><p>llama2中文模型参数详情：<a href="https://ollama.com/library/llama2-chinese:7b">llama2-chinese:7b (ollama.com)</a></p><p><strong>Llama3模型中文微调版下载地址（链接中有下载地址）</strong></p><p><a href="https://github.com/GEGEWU-CLOUD/Llama-Chinese">https://github.com/GEGEWU-CLOUD/Llama-Chinese</a></p><p>Llama 3的亮点和特性如下：</p><p>基于超过15T token训练，大小相当于Llama 2数据集的7倍还多；<br>训练效率比Llama 2高3倍；<br>支持8K长文本，改进的tokenizer具有128K token的词汇量，可实现更好的性能；<br>在大量重要基准测试中均具有最先进性能；<br>增强推理和代码能力；<br>安全性有重大突破，带有Llama Guard 2、Code Shield 和 CyberSec Eval 2的新版信任和安全工具，还能比Llama 2有更好“错误拒绝表现”。</p><p><strong>Ollama是什么?</strong><br>Olama是一个先进的AI工具，它允许用户在自己的电脑上(目前支持macOs和Linux，Windows即将推出)轻松设置和运行大型语言模型(LLMs)。这个工具的亮点在于，它不仅支持运行如Lama 2这样的强大语言模型，还允许用户自定义和创建自己的模型。</p><p>Meta发布了Llama 3模型可使用ollama部署，官方介绍文档<a href="https://link.zhihu.com/?target=https://ai.meta.com/blog/meta-llama-3/">在这</a>。总结一下重点内容：</p><ol><li><p>本次共发布了Llama 8B, 70B的模型，70B性能超越GPT3.5；</p></li><li><p>预告了正在训练中的400B+模型，性能追赶GPT4；</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_767b2d80d661dabc0a5cdffbfcceaf69.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_767b2d80d661dabc0a5cdffbfcceaf69.png"></p><p>参考文档：<a href="https://zhuanlan.zhihu.com/p/693709600">Llama 3 使用方法以及模型下载教程 - 知乎 (zhihu.com)</a></p></li></ol><p><strong>clone/下载github源码</strong></p><p>在meta公布的github网页(<a href="https://link.zhihu.com/?target=https://github.com/meta-llama/llama3">https://<strong>github.com/meta-llama/l</strong>lama3</a>)中，clone或者下载好源代码。</p><p><strong>关于域名无效的解决方案</strong></p><p><a href="https://bbs.fit2cloud.com/t/topic/4165/4">MaxKB 对接Ollama模型时，提示 API 域名不可用 - MaxKB - 社区论坛 - FIT2CLOUD 飞致云</a></p><p><strong>Ollama主要功能</strong></p><ul><li>本地语言模型执行:Ollama使用户能够在本地运行大型语言模型，提供更快、更高效的处理能力。</li><li>Llama 2模型:用户可以利用Lama 2语言模型，该模型提供先进的自然语言处理能力，适用于广泛的应用场景</li><li>模型定制:Ollama允许用户根据特定任务和需求定制和创建自己的语言型。</li><li>易于设置:该工具提供用户友好的界面，使用户能够快速启动并运行所选语言模型。</li><li>平台兼容性:目前Ollama支持macOS，确保与macOS系统的无缝集成。</li></ul><p><strong>支持的模型</strong></p><table><thead><tr><th>Model</th><th>Parameters</th><th>Size</th><th>Download</th></tr></thead><tbody><tr><td>Llama 3</td><td>8B</td><td>4.7GB</td><td><code>ollama run llama3</code></td></tr><tr><td>Llama 3</td><td>70B</td><td>40GB</td><td><code>ollama run llama3:70b</code></td></tr><tr><td>Phi-3</td><td>3.8B</td><td>2.3GB</td><td><code>ollama run phi3</code></td></tr><tr><td>Mistral</td><td>7B</td><td>4.1GB</td><td><code>ollama run mistral</code></td></tr><tr><td>Neural Chat</td><td>7B</td><td>4.1GB</td><td><code>ollama run neural-chat</code></td></tr><tr><td>Starling</td><td>7B</td><td>4.1GB</td><td><code>ollama run starling-lm</code></td></tr><tr><td>Code Llama</td><td>7B</td><td>3.8GB</td><td><code>ollama run codellama</code></td></tr><tr><td>Llama 2 Uncensored</td><td>7B</td><td>3.8GB</td><td><code>ollama run llama2-uncensored</code></td></tr><tr><td>LLaVA</td><td>7B</td><td>4.5GB</td><td><code>ollama run llava</code></td></tr><tr><td>Gemma</td><td>2B</td><td>1.4GB</td><td><code>ollama run gemma:2b</code></td></tr><tr><td>Gemma</td><td>7B</td><td>4.8GB</td><td><code>ollama run gemma:7b</code></td></tr><tr><td>Solar</td><td>10.7B</td><td>6.1GB</td><td><code>ollama run solar</code></td></tr></tbody></table></blockquote><h2 id="一-部署"><a href="#一-部署" class="headerlink" title="一. 部署"></a>一. 部署</h2><p>参考地址：</p><p><a href="https://wiki.eryajf.net/pages/97047e/#%E9%80%9A%E8%BF%87-docker-%E9%83%A8%E7%BD%B2">https://wiki.eryajf.net/pages/97047e/#%E9%80%9A%E8%BF%87-docker-%E9%83%A8%E7%BD%B2</a></p><p>镜像可选</p><p>ollama/ollama</p><p>registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:ollama</p><p>registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:ollama0.2.5</p><h3 id="CPU版本部署"><a href="#CPU版本部署" class="headerlink" title="CPU版本部署"></a>CPU版本部署</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cpu模式</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">ollama:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:ollama</span></span><br><span class="line">    <span class="comment">#ollama/ollama</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ollama</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ollama:/root/.ollama</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;11434:11434&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">OLLAMA_ORIGINS:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">      <span class="attr">OLLAMA_HOST:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">open-webui:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:open-webui-main</span> </span><br><span class="line">    <span class="comment">#ghcr.io/open-webui/open-webui:main</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">open-webui</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:8080&quot;</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;host.docker.internal:host-gateway&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">open-webui:/app/backend/data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">open-webui:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="GPU版本部署"><a href="#GPU版本部署" class="headerlink" title="GPU版本部署"></a>GPU版本部署</h3><h3 id="GPU模式（需要有NVIDIA显卡支持）"><a href="#GPU模式（需要有NVIDIA显卡支持）" class="headerlink" title="GPU模式（需要有NVIDIA显卡支持）"></a>GPU模式（需要有NVIDIA显卡支持）</h3><h4 id="安装英伟达容器工具包（以Ubuntu22-04为例）"><a href="#安装英伟达容器工具包（以Ubuntu22-04为例）" class="headerlink" title="安装英伟达容器工具包（以Ubuntu22.04为例）"></a>安装<a href="https://so.csdn.net/so/search?q=%E8%8B%B1%E4%BC%9F%E8%BE%BE&spm=1001.2101.3001.7020">英伟达</a>容器工具包（以Ubuntu22.04为例）</h4><p>其他系统请参考：<a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/arch-overview.html">英伟达官方文档</a></p><p>参考博主另一篇博客：<a href="http://sunlight.zznnwn.cloudns.biz/2024/07/15/ubuntu%E9%83%A8%E7%BD%B2nvidia-container-toolkit/">GPU模式先决条件</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.配置apt源</span></span><br><span class="line">curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \</span><br><span class="line">  &amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \</span><br><span class="line">    sed <span class="string">&#x27;s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g&#x27;</span> | \</span><br><span class="line">    sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/nvidia-container-toolkit.list</span><br><span class="line"><span class="comment"># 2.更新源</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># 3.安装工具包</span></span><br><span class="line">sudo apt-get install -y nvidia-container-toolkit</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>部署</strong></p><p>参考：<a href="https://bian.blog/2024/06/4697.html">https://bian.blog/2024/06/4697.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --gpus all -d -v /opt/ai/ollama:/root/.ollama -p 11434:11434 --name ollama ollama/ollama</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">ollama:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:ollama</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ollama</span></span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">devices:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">driver:</span> <span class="string">nvidia</span></span><br><span class="line">            <span class="attr">capabilities:</span> [<span class="string">&quot;gpu&quot;</span>]</span><br><span class="line">            <span class="attr">count:</span> <span class="string">all</span>  <span class="comment"># 根据需要调整 GPU 的数量  </span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ollama:/root/.ollama</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;11434:11434&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KEEP_GPUS_TIMEOUT:</span> <span class="number">40</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">OLLAMA_ORIGINS:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">      <span class="attr">OLLAMA_HOST:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ollama</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">open-webui:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:open-webui-main</span> </span><br><span class="line">    <span class="comment">#ghcr.io/open-webui/open-webui:main</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">open-webui</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;host.docker.internal:host-gateway&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">open-webui:/app/backend/data</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">ENABLE_RAG_WEB_SEARCH:</span> <span class="literal">True</span></span><br><span class="line">      <span class="attr">RAG_WEB_SEARCH_ENGINE:</span> <span class="string">&quot;searxng&quot;</span></span><br><span class="line">      <span class="attr">RAG_WEB_SEARCH_RESULT_COUNT:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">RAG_WEB_SEARCH_CONCURRENT_REQUESTS:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">SEARXNG_QUERY_URL:</span> <span class="string">&quot;http://searxng:8080/search?q=&lt;query&gt;&quot;</span></span><br><span class="line">      <span class="attr">ENABLE_OPENAI_API:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ollama</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">open-webui:</span>  </span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">ollama:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span>   </span><br></pre></td></tr></table></figure><p>理解配置</p><blockquote><p>现在，让我们探讨一下 docker-compose.yml 文件的关键组件，该文件可以使用 GPU 加速运行 Ollama：</p><p>Docker Compose 版本：<br>version 属性指定了使用的 Docker Compose 版本。虽然有些人可能会提到 3.9，但推荐使用官方文档中提到的版本，目前是 3.8。这样可以确保兼容性和稳定性。</p><p>Ollama 服务定义：<br>services 部分定义了 ollama 服务，它封装了 Ollama 容器。以下是其重要属性的分解：</p><p>image：指定 Ollama 的 Docker 镜像。默认是 ollama/ollama，但如果需要，可以使用特定版本（请参阅 Ollama 的文档以获取可用版本）。<br>deploy：该部分配置了 Ollama 容器的资源保留，这是利用 GPU 的关键。<br>resources：定义容器的资源需求。<br>reservations：该嵌套属性允许您为容器保留特定设备。<br>devices：定义设备保留。在此嵌套配置中，我们指定：<br>driver：将设备驱动程序设置为 nvidia，表示我们请求使用 Nvidia GPU。<br>capabilities：列出 Ollama 请求的功能。在本例中，我们指定 “gpu” 以表示我们希望利用 GPU 进行处理。<br>count：该值确定要为 Ollama 保留多少个 Nvidia GPU。使用 all 来利用所有可用的 GPU，或者如果有多个 GPU 并希望为 Ollama 专门分配一部分，可以指定一个具体的数量。<br>持久化卷定义：<br>volumes 部分定义了一个名为 ollama 的持久化卷。此卷确保 Ollama 生成的任何数据（如训练模型或配置）在容器重启后仍然存在。它被挂载在 Ollama 容器内的 /root/.ollama 目录。</p></blockquote><p><strong>部署完成后载入大模型(CPU GPU相同)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生效上传的模型文件</span></span><br><span class="line">docker-compose restart</span><br><span class="line"><span class="comment"># 启动qwen:4b模型</span></span><br><span class="line">docker <span class="built_in">exec</span> -it ollama ollama run qwen:4b-chat</span><br></pre></td></tr></table></figure><p>备注：开启代理在本机下载完成之后 会在当前目录ollama文件夹 生成一个models的文件夹模型文件就存于其中 只需要将此文件夹压缩上传到服务器后 再次执行此项命令服务器上模型即可部署完成 <strong>上传后需要重启容器docker-compose restart再执行run即可</strong>。</p><p>建议：最好将整个项目文件包含docker-compose文件上传到服务器执行相应操作UP ollama create等。</p><p>llama3:8b效果：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_a21d90e141ec4f1cce9354171386e840.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_a21d90e141ec4f1cce9354171386e840.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_d4f9773272728a7238a432b06356f0ce.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_d4f9773272728a7238a432b06356f0ce.png"></p><p>注意：使用pve创建的<strong>虚拟机直通GPU</strong> 需要将<strong>cpu模式设置为host</strong>（默认为qemu模式） <strong>否则会报错cpu不支持avx指令集导致GPU被禁用</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama  | time=2024-07-23T02:15:07.485Z level=WARN <span class="built_in">source</span>=gpu.go:225 msg=<span class="string">&quot;CPU does not have minimum vector extensions, GPU inference disabled&quot;</span> required=avx detected=<span class="string">&quot;no vector extensions&quot;</span></span><br></pre></td></tr></table></figure><p>解决：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_20236426c0189f25768346fb91a15c8f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_20236426c0189f25768346fb91a15c8f.png"></p><p><strong>ollama 成功使用GPU截图</strong>：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_69b91f921449ffe234d7c952ae8412ec.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_69b91f921449ffe234d7c952ae8412ec.png"></p><p><strong>效果</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@dmx:/opt/ollama<span class="comment"># docker exec -it ollama bash</span></span><br><span class="line">root@3373062f728d:/<span class="comment">#  nvidia-smi</span></span><br><span class="line">Tue Jul 23 07:31:40 2024   </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 550.100                Driver Version: 550.100        CUDA Version: 12.4     |</span><br><span class="line">|-----------------------------------------+------------------------+----------------------+</span><br><span class="line">| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                                         |                        |               MIG M. |</span><br><span class="line">|=========================================+========================+======================|</span><br><span class="line">|   0  NVIDIA GeForce RTX 4090 D      Off |   00000000:01:00.0 Off |                  Off |</span><br><span class="line">|  0%   39C    P8             15W /  425W |    5609MiB /  24564MiB |      0%      Default |</span><br><span class="line">|                                         |                        |                  N/A |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line">                                                                       </span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                              |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |</span><br><span class="line">|        ID   ID                                                               Usage      |</span><br><span class="line">|=========================================================================================|</span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>部署完成后微调为自己的大模型：<a href="http://sunlight.zznnwn.cloudns.biz/2024/08/02/ollama%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%E5%8F%8A%E5%A4%9A%E6%A8%A1%E6%80%81%E5%9B%BE%E7%89%87%E5%88%86%E6%9E%90/">ollama本地大模型微调及多模态图片分析</a></p><h2 id="二-Ollama-中-离线部署-qwen-0-5b-模型为例。"><a href="#二-Ollama-中-离线部署-qwen-0-5b-模型为例。" class="headerlink" title="二. Ollama 中 离线部署 qwen:0.5b 模型为例。"></a>二. Ollama 中 <strong>离线部署</strong> qwen:0.5b 模型为例。</h2><p><strong>1. 下载模型</strong></p><p>访问 huggingface 下载 qwen1_5-0_5b-chat-q5_k_m.gguf 模型。</p><p><a href="https://huggingface.co/Qwen/Qwen1.5-0.5B-Chat-GGUF/tree/main">https://huggingface.co/Qwen/Qwen1.5-0.5B-Chat-GGUF/tree/main</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_f93341707d2e1b6931f22cad2d81db8a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_f93341707d2e1b6931f22cad2d81db8a.png"></p><p><strong>2. 上传 Qwen1.5-0.5B-Chat-GGUF 模型离线文件到 Ollama 所在服务器</strong></p><p><strong>3. 创建Ollama Modelfile</strong></p><p>创建一个名为 Modelfile 的文件，内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM ./qwen1_5-0_5b-chat-q5_k_m.gguf</span><br><span class="line"></span><br><span class="line">TEMPLATE &quot;&quot;&quot;&#123;&#123; if .System &#125;&#125;&lt;|im_start|&gt;system</span><br><span class="line">&#123;&#123; .System &#125;&#125;&lt;|im_end|&gt;&#123;&#123; end &#125;&#125;&lt;|im_start|&gt;user</span><br><span class="line">&#123;&#123; .Prompt &#125;&#125;&lt;|im_end|&gt;</span><br><span class="line">&lt;|im_start|&gt;assistant</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">PARAMETER stop &quot;&lt;|im_start|&gt;&quot;</span><br><span class="line">PARAMETER stop &quot;&lt;|im_end|&gt;&quot;</span><br></pre></td></tr></table></figure><p>说明：不同模型的 Modelfile 内容不同，可参考 Ollama 官网 <a href="https://ollama.com/library/qwen:0.5b">参数设置</a> 。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_8bbd7faef16aaea28633b9c3ed3a9415.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_8bbd7faef16aaea28633b9c3ed3a9415.png"></p><p><strong>4. 在Ollama中创建模型</strong></p><p>执行以下命令，创建模型：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama create qwen:0.5b -f Modelfile</span><br></pre></td></tr></table></figure><p>执行以下命令，确认模型存在：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama list</span><br></pre></td></tr></table></figure><p><strong>5. 在 MaxKB中 添加 Ollama 模型 对接上面创建的 qwen:0.5b 模型</strong></p><p><strong>效果</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_021ed55c6e8335c07278795effa9572b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_021ed55c6e8335c07278795effa9572b.png"></p><h2 id="三-对接官方web面板open-webui-main"><a href="#三-对接官方web面板open-webui-main" class="headerlink" title="三. 对接官方web面板open-webui-main"></a>三. 对接官方web面板open-webui-main</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_e98184a52ba387311de9a9d1f3759c29.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_e98184a52ba387311de9a9d1f3759c29.png"></p><h2 id="四-对接MaxKB"><a href="#四-对接MaxKB" class="headerlink" title="四. 对接MaxKB"></a>四. 对接MaxKB</h2><p>见链接：<a href="https://blog.fit2cloud.com/?p=3fc407b2-1962-4196-b5b8-c7d27684b446">https://blog.fit2cloud.com/?p=3fc407b2-1962-4196-b5b8-c7d27684b446</a></p><p>备注：api-key没有可随便输即可</p><p>注意：对接本地大模型<del>不能通过下拉框选择</del> 需要<strong>手动输入</strong> <strong>ollama list <strong>获取到的模型名称<br>否则会报错 Error: pull model manifest: Get “<a href="https://registry.ollama.ai/v2/library/llama3/manifests/8b">https://registry.ollama.ai/v2/library/llama3/manifests/8b</a>“: dial tcp 104.21.75.227:443: i/o timeout 与</strong> oneapi对接ollama类似</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_9523bdac22c80d831c4daf934b10cdf3.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_9523bdac22c80d831c4daf934b10cdf3.png"></p><p>本文参考：</p><p><a href="https://blog.csdn.net/qq_38593436/article/details/136407171">https://blog.csdn.net/qq_38593436/article/details/136407171</a></p><p><a href="https://blog.csdn.net/weixin_43012017/article/details/138253446">https://blog.csdn.net/weixin_43012017/article/details/138253446</a></p><p><a href="https://blog.fit2cloud.com/?p=3fc407b2-1962-4196-b5b8-c7d27684b446">https://blog.fit2cloud.com/?p=3fc407b2-1962-4196-b5b8-c7d27684b446</a></p><p><a href="https://github.com/1Panel-dev/MaxKB/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Ollama%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2LLM%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B">如何使用Ollama离线部署LLM大语言模型 · 1Panel-dev/MaxKB Wiki (github.com)</a></p><p><a href="https://wiki.eryajf.net/pages/97047e/#%E6%A8%A1%E5%9E%8B%E7%AE%A1%E7%90%86">带你认识本地大语言模型框架Ollama(可直接上手) | 二丫讲梵 (eryajf.net)</a></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
          <category> gpu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos配置vlan</title>
      <link href="/2024/05/14/centos%E9%85%8D%E7%BD%AEvlan/"/>
      <url>/2024/05/14/centos%E9%85%8D%E7%BD%AEvlan/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="centos配置vlan"><a href="#centos配置vlan" class="headerlink" title="centos配置vlan"></a>centos配置vlan</h1><h2 id="一-网上大佬方式（测试未通过）"><a href="#一-网上大佬方式（测试未通过）" class="headerlink" title="一. 网上大佬方式（测试未通过）"></a>一. 网上大佬方式（测试未通过）</h2><ol><li>安装依赖包</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install vconfig -y</span><br></pre></td></tr></table></figure><ol start="2"><li>查看核心是否提供VLAN 功能</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dmesg | grep -i 802</span><br><span class="line"> </span><br><span class="line">[root@c159 network-scripts]<span class="comment"># dmesg |grep -i 802</span></span><br><span class="line">[    0.318021] pci 0000:00:16.5: [15ad:07a0] <span class="built_in">type</span> 01 class 0x060400</span><br><span class="line">[    0.398023] pci 0000:00:16.2:   bridge window [mem 0xeb100000-0xeb1fffff 64bit pref]</span><br><span class="line">[    1.120802] Key <span class="built_in">type</span> trusted registered</span><br><span class="line">[12888.091996] 8021q: 802.1Q VLAN Support v1.8</span><br><span class="line">[12888.092019] 8021q: adding VLAN 0 to HW filter on device ens192</span><br><span class="line">[12888.092511] 8021q: adding VLAN 0 to HW filter on device ens224</span><br></pre></td></tr></table></figure><ol start="3"><li>查看<code>/proc/net/vlan</code>目录是否存在，如果不存在，使用<code>modprobe</code>模命令进入<code>802.1q.o</code>，且使用<code>lsmod</code>命令模是否已入核心</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">modprobe 8021q</span><br><span class="line"> </span><br><span class="line">[root@c159 network-scripts]<span class="comment"># lsmod |grep 802</span></span><br><span class="line">8021q                  33159  0</span><br><span class="line">garp                   14384  1 8021q</span><br><span class="line">mrp                    18542  1 8021q</span><br></pre></td></tr></table></figure><ol start="4"><li>使用vconfig命令增加子接口:</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vconfig add ens224 60</span><br></pre></td></tr></table></figure><ol start="5"><li>利用<code>ls /proc/net/vlan</code>查看</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@c159 network-scripts]<span class="comment"># ls /proc/net/vlan/</span></span><br><span class="line">config  ens224.60  ens224.20  ens224.30</span><br></pre></td></tr></table></figure><p><strong>如没有vconfig包则修改配置文件即可（见六以下步骤）</strong></p><ol start="6"><li>修改网卡配置：</li></ol><p>ifcfg-ens224配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/sysconfig/network-scripts/</span><br><span class="line"><span class="built_in">cp</span> ifcfg-ens224 ifcfg-ens224.60</span><br><span class="line"> </span><br><span class="line">vim ifcfg-ens224</span><br><span class="line"> </span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none  //此项dhcp对vlan端口无影响，如不放心，可改成static</span><br><span class="line">DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=<span class="built_in">yes</span></span><br><span class="line">IPV6_AUTOCONF=<span class="built_in">yes</span></span><br><span class="line">IPV6_DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens224</span><br><span class="line">DEVICE=ens224</span><br><span class="line">ONBOOT=no  //此项<span class="built_in">yes</span>或no，对vlan端口无影响</span><br></pre></td></tr></table></figure><p>对应vlan的配置文件中UUID一定要删掉，不然会出现不可知的问题</p><p>ifcfg-ens224.60配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim ifcfg-ens224.60</span><br><span class="line">TYPE=vlan        //TYPE类型</span><br><span class="line">PHYSDEV=ens224      //vlan端口对应物理硬件名称</span><br><span class="line">VLAN_ID=60     //VLAN ID</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=<span class="built_in">yes</span></span><br><span class="line">IPV6_AUTOCONF=<span class="built_in">yes</span></span><br><span class="line">IPV6_DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens224.60</span><br><span class="line">DEVICE=ens224.60</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">VLAN=<span class="built_in">yes</span>              //设置允许vlan</span><br><span class="line">IPADDR=10.0.0.80</span><br><span class="line">NETMASK=255.255.255.0</span><br></pre></td></tr></table></figure><h2 id="二-直接在主网卡修改配置文件方式（推荐）"><a href="#二-直接在主网卡修改配置文件方式（推荐）" class="headerlink" title="二. 直接在主网卡修改配置文件方式（推荐）"></a>二. 直接在主网卡修改配置文件方式（推荐）</h2><table><thead><tr><th>vlan内网10.0.1.段地址vlan id</th><th>vlan60</th><th>vlan60</th></tr></thead><tbody><tr><td><strong>机器名称</strong></td><td>centos1</td><td>centos2</td></tr><tr><td><strong>vlan内网地址</strong><br><br></td><td>10.0.1.60</td><td>10.0.1.61</td></tr><tr><td><strong>外网地址</strong></td><td>10.0.0.10</td><td>10.0.0.128<br></td></tr></tbody></table><blockquote><p>本次环境使用 vmware 模拟</p><p>一台centos7 一台centos8</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_d1ed2ec5c1b9dfd1d195e5b96d71c0f3.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_d1ed2ec5c1b9dfd1d195e5b96d71c0f3.png"></p><p><code>GATEWAY</code> 此参数根据情况考虑是否添加</p><p>如：双网卡不同IP情况 只允许有一个默认网关 如果另一张网卡需要配置外网IP 那么只允许规定外网IP的网卡配置外网网关</p><p><code>VLAN_NAME_TYPE=VLAN_PLUS_VID_NO_PAD</code> 是网络配置文件中的一个选项，它指定了 VLAN 标签的格式。</p><ul><li><code>VLAN_PLUS_VID_NO_PAD</code> 表示 VLAN 标签以 “VLAN” 开头，后跟 VLAN ID，例如 “VLAN80”。</li><li><code>NO_PAD</code> 表示 VLAN ID 不会在前面填充零。例如，VLAN ID 80 表示为 “VLAN80” 而不是 “VLAN080”。</li></ul><p>因此，<code>VLAN_NAME_TYPE=VLAN_PLUS_VID_NO_PAD</code> 的意思是，使用 “VLAN” 加上 VLAN ID 的格式，并且不在 VLAN ID 前面填充零。</p></blockquote><p><strong>网卡配置其实只需要在下方添加此配置即可</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">IPADDR=10.0.1.61</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.1.220</span><br><span class="line">DNS1=114.114.114.114</span><br><span class="line">DNS2=8.8.8.8</span><br><span class="line">DNS3=223.5.5.5</span><br><span class="line">VLAN=<span class="built_in">yes</span></span><br><span class="line">VLAN_NAME_TYPE=VLAN_PLUS_VID_NO_PAD</span><br><span class="line">VLAN_ID=80</span><br></pre></td></tr></table></figure><p><strong>centos8修改网卡配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=<span class="built_in">yes</span></span><br><span class="line">IPV6_AUTOCONF=<span class="built_in">yes</span></span><br><span class="line">IPV6_DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=eui64</span><br><span class="line">NAME=ens224</span><br><span class="line">DEVICE=ens224</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">IPADDR=10.0.1.61</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.1.220</span><br><span class="line">DNS1=114.114.114.114</span><br><span class="line">DNS2=8.8.8.8</span><br><span class="line">DNS3=223.5.5.5</span><br><span class="line">VLAN=<span class="built_in">yes</span></span><br><span class="line">VLAN_NAME_TYPE=VLAN_PLUS_VID_NO_PAD</span><br><span class="line">VLAN_ID=60</span><br></pre></td></tr></table></figure><p><strong>centos7配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">TYPE=<span class="string">&quot;Ethernet&quot;</span></span><br><span class="line">PROXY_METHOD=<span class="string">&quot;none&quot;</span></span><br><span class="line">BROWSER_ONLY=<span class="string">&quot;no&quot;</span></span><br><span class="line">BOOTPROTO=<span class="string">&quot;static&quot;</span></span><br><span class="line">DEFROUTE=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV4_FAILURE_FATAL=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV6INIT=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV6_AUTOCONF=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV6_DEFROUTE=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV6_FAILURE_FATAL=<span class="string">&quot;no&quot;</span></span><br><span class="line">IPV6_ADDR_GEN_MODE=<span class="string">&quot;stable-privacy&quot;</span></span><br><span class="line">IPV6_PRIVACY=<span class="string">&quot;no&quot;</span></span><br><span class="line">NAME=<span class="string">&quot;ens35&quot;</span></span><br><span class="line">DEVICE=<span class="string">&quot;ens35&quot;</span></span><br><span class="line">ONBOOT=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPADDR=<span class="string">&quot;10.0.1.60&quot;</span></span><br><span class="line">PREFIX=<span class="string">&quot;24&quot;</span></span><br><span class="line">GATEWAY=<span class="string">&quot;10.0.1.220&quot;</span></span><br><span class="line">DNS1=<span class="string">&quot;114.114.114.114&quot;</span></span><br><span class="line">DNS2=<span class="string">&quot;8.8.8.8&quot;</span></span><br><span class="line">DNS3=<span class="string">&quot;223.5.5.5&quot;</span></span><br><span class="line">VLAN=<span class="built_in">yes</span></span><br><span class="line">VLAN_NAME_TYPE=VLAN_PLUS_VID_NO_PAD</span><br><span class="line">VLAN_ID=60</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>centos8物理服务器实际配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">test</span>@cloud1 network-scripts]$ <span class="built_in">cat</span> ifcfg-eno4</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=no</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=<span class="built_in">yes</span></span><br><span class="line">IPV6_AUTOCONF=<span class="built_in">yes</span></span><br><span class="line">IPV6_DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=eui64</span><br><span class="line">NAME=eno4</span><br><span class="line">UUID=7ee10950-b9b8-45dd-995d-074cf1695242</span><br><span class="line">DEVICE=eno4</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">IPADDR=172.56.20.11</span><br><span class="line">PREFIX=24</span><br><span class="line">VLAN=<span class="built_in">yes</span></span><br><span class="line">VLAN_NAME_TYPE=VLAN_PLUS_VID_NO_PAD</span><br><span class="line">VLAN_ID=20</span><br></pre></td></tr></table></figure><p>验证：</p><p>相互ping看内网是否互通</p><ul><li><p>物理服务器验证<br>网卡变为绿色</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_2bfbac8a58848ceb401fa888e341bd45.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_2bfbac8a58848ceb401fa888e341bd45.png"></p><p>交换机对应服务器的端口灯亮</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_f5809244b4f7e86f58c42d319e515b3e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/6/image_f5809244b4f7e86f58c42d319e515b3e.png"></p></li><li><p>down掉centos7 ens33网卡 在vmware控制台ping centos8 vlan60网卡ens35 ping 10.0.1.61  (成功)</p></li><li><p>并且此时ping不通centos7 10.0.0.10 说明内外网隔离环境测试成功</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_46d9d81ccd08ad64cb09535dc5f30812.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_46d9d81ccd08ad64cb09535dc5f30812.png"></p></li><li><p>将centos2机器vlan修改为其他段如vlan80后使用此机器 ping centos1 vlan60 10.0.1.60看能否ping通</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_1367c682fbe66fce000e3afced063d48.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_1367c682fbe66fce000e3afced063d48.png"></p><p>此时两台机器互相无法ping通 <img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_f9f2dc184abb2dd3b0f6ede28a0e7830.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_f9f2dc184abb2dd3b0f6ede28a0e7830.png"></p></li></ul><p>成功！</p><p>本文参考：</p><p><a href="https://blog.csdn.net/zhongbeida_xue/article/details/95355111">https://blog.csdn.net/zhongbeida_xue/article/details/95355111</a></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Centos8使用network管理网络</title>
      <link href="/2024/05/14/Centos8%E4%BD%BF%E7%94%A8network%E7%AE%A1%E7%90%86%E7%BD%91%E7%BB%9C/"/>
      <url>/2024/05/14/Centos8%E4%BD%BF%E7%94%A8network%E7%AE%A1%E7%90%86%E7%BD%91%E7%BB%9C/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Centos8使用network管理网络"><a href="#Centos8使用network管理网络" class="headerlink" title="Centos8使用network管理网络"></a>Centos8使用network管理网络</h1><p>前言：</p><p>在CentOS8中，我们常用的network.service服务就被NetworkManager.service服务代替了，同样的，IP的配置方法也发生了改变，那么如果想使用network.service服务去管理/配置系统网络怎么办呢？下面带你梦回network.service</p><h3 id="一、安装network-scripts"><a href="#一、安装network-scripts" class="headerlink" title="一、安装network-scripts"></a>一、安装network-scripts</h3><p>静默安装(-q)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y  network-scripts</span><br></pre></td></tr></table></figure><p>安装过程:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># dnf install -y -q network-scripts</span></span><br><span class="line">警告：/var/cache/dnf/BaseOS-929b586ef1f72f69/packages/network-scripts-10.00.6-1.el8_2.1.x86_64.rpm: 头V3 RSA/SHA256 Signature, 密钥 ID 8483c65d: NOKEY</span><br><span class="line">导入 GPG 公钥 0x8483C65D:</span><br><span class="line">Userid: <span class="string">&quot;CentOS (CentOS Official Signing Key) &lt;security@centos.org&gt;&quot;</span></span><br><span class="line">指纹: 99DB 70FA E1D7 CE22 7FB6 4882 05B5 55B3 8483 C65D</span><br><span class="line">来自: /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>此时，服务安装完成了，接下来开始启用该服务</p><h3 id="二、启用network"><a href="#二、启用network" class="headerlink" title="二、启用network"></a>二、启用network</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start network</span><br><span class="line">systemctl <span class="built_in">enable</span> network</span><br><span class="line">systemctl status network</span><br></pre></td></tr></table></figure><h3 id="三-禁用NetworkManager-service"><a href="#三-禁用NetworkManager-service" class="headerlink" title="三. 禁用NetworkManager.service"></a>三. 禁用NetworkManager.service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop NetworkManager</span><br><span class="line">systemctl <span class="built_in">disable</span> NetworkManager</span><br><span class="line">执行结果：</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl stop NetworkManager</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl disable NetworkManager</span></span><br><span class="line">Removed /etc/systemd/system/multi-user.target.wants/NetworkManager.service.</span><br><span class="line">Removed /etc/systemd/system/dbus-org.freedesktop.nm-dispatcher.service.</span><br><span class="line">Removed /etc/systemd/system/network-online.target.wants/NetworkManager-wait-online.service.</span><br></pre></td></tr></table></figure><p>到这里，NetworkManager服务就停止工作了，这时候可以先安装network-scripts（也就是network.service)了</p><h3 id="四、卸载NetworkManager（可选-建议保留）"><a href="#四、卸载NetworkManager（可选-建议保留）" class="headerlink" title="四、卸载NetworkManager（可选 建议保留）"></a>四、卸载<code>NetworkManager</code>（可选 建议保留）</h3><p>执行卸载命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf remove -y NetworkManager</span><br></pre></td></tr></table></figure><p>效果</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_a6a352e2ac83bc5373276f96402b5ff4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_a6a352e2ac83bc5373276f96402b5ff4.png"></p><p>本文参考</p><p><a href="https://blog.csdn.net/qq_36154886/article/details/109839926">https://blog.csdn.net/qq_36154886/article/details/109839926</a></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos8使用nmcli配置bond1与vlan组合</title>
      <link href="/2024/05/13/centos8%E4%BD%BF%E7%94%A8nmcli%E9%85%8D%E7%BD%AEbond1%E4%B8%8Evlan%E7%BB%84%E5%90%88/"/>
      <url>/2024/05/13/centos8%E4%BD%BF%E7%94%A8nmcli%E9%85%8D%E7%BD%AEbond1%E4%B8%8Evlan%E7%BB%84%E5%90%88/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="centos8使用nmcli配置bond1与vlan组合-测试未通过"><a href="#centos8使用nmcli配置bond1与vlan组合-测试未通过" class="headerlink" title="centos8使用nmcli配置bond1与vlan组合(测试未通过)"></a>centos8使用nmcli配置bond1与vlan组合(测试未通过)</h2><blockquote><p>本次实验环境使用<strong>workstdtion</strong> 虚拟机交换机 模拟物理设备划分vlan</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_bba0d14b526d9a8ddba1b176cfdfaeb8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_bba0d14b526d9a8ddba1b176cfdfaeb8.png"></p><p>NetworkManager和network.service都是用来管理网络的工具。在CentOS 7版本中，NetworkManager和network.service默认安装时是共存的，但习惯使然我们一般都是禁用掉NetworkManager而仍然使用配置文件+network.service的方式来配置和管理主机上的网络。</p><p>RHEL 8/CentOS 8版本开始network.service默认没有安装，默认只使用NetworkManager作为网络管理工具。而且RedHat官方指出在后续的版本中会彻底不支持network.service，这样一来除了NetworkManager我们也没有选择余地。既然无力反抗，那么就要学会享受。</p><p>其实NetworkManager也有优点，比如使用方式多样化：命令行、文本界面、图形界面、web portal均可支持。nmcli命令行支持tab补齐，使用感受类似配置交换机；nmtui工具可以在shell终端开启文本图形界面。而且Linux主流知发行版，RedHat系、Suse系、Debian/Ubuntu系均支持NetworkManager。</p><p>在nmcli中有2个命令最为常用：</p><p>nmcli connection</p><p>译作连接，可理解为配置文件，相当于ifcfg-ethX。可以简写为nmcli c</p><p>nmcli device</p><p>译作设备，可理解为实际存在的网卡(包括物理网卡和虚拟网卡)。可以简写为nmcli d</p><p>NetworkManager有2个基本的概念：连接(Connection)和设备(Device)。</p><p>Device是操作系统层面能够识别到的网卡设备，如本地回环lo、本地网卡eth0（nmcli d命令可以查看到）。</p><p>Connection可以认为是Device对应的配置文件，也就是说一个Device可以对应多个Connection。同一时间只有一个Connection是处于激活状态的（nmcli c命令输出结果中绿色的行）。</p></blockquote><h3 id="一-配置bond与vlan组合（重启系统便会失效）"><a href="#一-配置bond与vlan组合（重启系统便会失效）" class="headerlink" title="一. 配置bond与vlan组合（重启系统便会失效）"></a>一. 配置bond与vlan组合（重启系统便会失效）</h3><p><strong>拓补图</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_715204becfedcdac807aa604cbd4594e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_715204becfedcdac807aa604cbd4594e.png"></p><p><strong>先决条件</strong></p><p>查看/proc/net/vlan 目录是否存在，如果不存在，使用modprobe模命令进入802.1q.o，且使用lsmod命令模是否已入核心</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载模块</span></span><br><span class="line">modprobe 8021q</span><br><span class="line"> </span><br><span class="line">[root@c159 network-scripts]<span class="comment"># lsmod |grep 802</span></span><br><span class="line">8021q                  33159  0</span><br><span class="line">garp                   14384  1 8021q</span><br><span class="line">mrp                    18542  1 8021q</span><br></pre></td></tr></table></figure><p>很简单只需要几行命令</p><p>参数可选</p><ul><li><code>ipv4.method disabled</code>：这个选项禁用了IPv4地址的自动获取，意味着系统不会尝试获取IPv4地址。</li><li><code>ipv6.method ignore</code>：这个选项告诉系统忽略IPv6地址的配置，系统不会为该接口分配IPv6地址。</li><li>mode 1 即为 mode active-backup</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用NetworkManager配置vlan</span></span><br><span class="line">nmcli con add <span class="built_in">type</span> bond con-name bond0 ifname bond0  mode 1 ipv4.method disabled ipv6.method ignore</span><br><span class="line">nmcli con add <span class="built_in">type</span> bond-slave ifname ens224 master bond0</span><br><span class="line">nmcli con add <span class="built_in">type</span> bond-slave ifname ens256 master bond0</span><br><span class="line">nmcli con add <span class="built_in">type</span> vlan con-name bond0.80 ifname bond0.80 dev bond0 <span class="built_in">id</span> 80 ipv4.addresses 10.0.0.100/24 ipv4.gateway 10.0.0.220 ipv4.dns 114.114.114.114 </span><br></pre></td></tr></table></figure><p>查看命令生成ifcfg-bond0.80详情 并新增此行（SLAVE=yes）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost network-scripts]<span class="comment"># cat ifcfg-bond0.80</span></span><br><span class="line">VLAN=<span class="built_in">yes</span></span><br><span class="line">TYPE=Vlan</span><br><span class="line">PHYSDEV=bond0</span><br><span class="line">VLAN_ID=80</span><br><span class="line">REORDER_HDR=<span class="built_in">yes</span></span><br><span class="line">GVRP=no</span><br><span class="line">MVRP=no</span><br><span class="line">HWADDR=</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=dhcp</span><br><span class="line">IPADDR=10.0.0.100</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.220</span><br><span class="line">DNS1=114.114.114.114</span><br><span class="line">DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=<span class="built_in">yes</span></span><br><span class="line">IPV6_AUTOCONF=<span class="built_in">yes</span></span><br><span class="line">IPV6_DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=default</span><br><span class="line">NAME=bond0.80</span><br><span class="line">UUID=b96b405e-6a6d-4000-bca3-2fc060c945c2</span><br><span class="line">DEVICE=bond0.80</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">SLAVE=<span class="built_in">yes</span>   <span class="comment">#新增</span></span><br></pre></td></tr></table></figure><h3 id="二-验证"><a href="#二-验证" class="headerlink" title="二. 验证"></a>二. 验证</h3><p>查看bond: <code>cat /proc/net/bonding/bond0</code></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_b43f2d08cd6c439a2de7279ac31d2178.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_b43f2d08cd6c439a2de7279ac31d2178.png"></p><p>本文参考：</p><p><a href="https://www.cnblogs.com/5201351/p/4990187.html">linux-Centos 7下bond与vlan技术的结合 - 520_1351 - 博客园 (cnblogs.com)</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用NetworkManager配置bond 0</span></span><br><span class="line"><span class="comment"># nmcli con add type bond ifname bond0 con-name bond0 mode active-backup</span></span><br><span class="line"><span class="comment"># nmcli con add type bond-slave ifname ens224 master bond0</span></span><br><span class="line"><span class="comment"># nmcli con add type bond-slave ifname ens256 master bond0</span></span><br><span class="line"><span class="comment"># nmcli con modify bond0 ipv4.address 10.0.0.100/24 ipv4.gateway 10.0.0.254 ipv4.dns 114.114.114.114 ipv4.method manual ipv6.method ignore</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用NetworkManager配置vlan</span></span><br><span class="line">nmcli con add <span class="built_in">type</span> bond ifname bond0 con-name bond0 mode active-backup ipv4.method disabled ipv6.method ignore</span><br><span class="line">nmcli con add <span class="built_in">type</span> bond-slave ifname ens224 master bond0</span><br><span class="line">nmcli con add <span class="built_in">type</span> bond-slave ifname ens256 master bond0</span><br><span class="line">nmcli con add <span class="built_in">type</span> vlan con-name bond0.80 ifname bond0.80 dev bond0 <span class="built_in">id</span> 101 ipv4.addresses 10.0.0.100/24 ipv4.gateway 10.0.0.254 ipv4.dns 114.114.114.114 ipv4.method disabled ipv6.method ignore</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos8使用nmcli配置bond(active-backup)及network管理下配置</title>
      <link href="/2024/05/07/centos8%E4%BD%BF%E7%94%A8nmcli%E9%85%8D%E7%BD%AEbond(active-backup)%E5%8F%8Anetwork%E7%AE%A1%E7%90%86%E4%B8%8B%E9%85%8D%E7%BD%AE/"/>
      <url>/2024/05/07/centos8%E4%BD%BF%E7%94%A8nmcli%E9%85%8D%E7%BD%AEbond(active-backup)%E5%8F%8Anetwork%E7%AE%A1%E7%90%86%E4%B8%8B%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="centos8使用nmcli配置bond-active-backup-及network管理下配置"><a href="#centos8使用nmcli配置bond-active-backup-及network管理下配置" class="headerlink" title="centos8使用nmcli配置bond(active-backup)及network管理下配置"></a>centos8使用nmcli配置bond(active-backup)及network管理下配置</h1><blockquote><p>需要：至少 3 张网卡 （ <strong>一张网卡配置IP用于远程连接 剩余两张网卡 配置bond</strong> ）</p><p>两张网卡是无法实现的</p></blockquote><h2 id="Bonding-聚合链路工作模式"><a href="#Bonding-聚合链路工作模式" class="headerlink" title="Bonding 聚合链路工作模式"></a>Bonding 聚合链路工作模式</h2><p>bond聚合链路模式共有7种模式：0-6 Mode</p><ul><li>mod=0 ，即：(balance-rr) Round-robin policy（轮询）聚合口数据报文按包轮询从物理接口转发。<br>负载均衡—所有链路处于负载均衡状态，轮询方式往每条链路发送报文这模式的特点增加了带宽，同时支持容错能力，当有链路出问题，会把流量切换到正常的链路上。<br>性能问题—一个连接或者会话的数据包如果从不同的接口发出的话，中途再经过不同的链路，在客户端很有可能会出现数据包无序到达的问题，而无序到达的数据包需要重新要求被发送，这样网络的吞吐量就会下降。Bond0在大压力的网络传输下，性能增长的并不是很理想。<br>需要交换机进行端口绑定</li><li>mod=1，即： (active-backup) Active-backup policy（主-备份策略）只有Active状态的物理接口才转发数据报文。<br>容错能力—只有一个slave是激活的(active)。也就是说同一时刻只有一个网卡处于工作状态，其他的slave都处于备份状态，只有在当前激活的slave故障后才有可能会变为激活的(active)。<br>无负载均衡—此算法的优点是可以提供高网络连接的可用性，但是它的资源利用率较低，只有一个接口处于工作状态，在有 N 个网络接口的情况下，资源利用率为1/N。</li><li>mod=2，即：(balance-xor) XOR policy（平衡策略）聚合口数据报文按源目MAC、源目IP、源目端口进行异或HASH运算得到一个值，根据该值查找接口转发数据报文<br>负载均衡—基于指定的传输HASH策略传输数据包。<br>容错能力—这模式的特点增加了带宽，同时支持容错能力，当有链路出问题，会把流量切换到正常的链路上。<br>性能问题—该模式将限定流量，以保证到达特定对端的流量总是从同一个接口上发出。既然目的地是通过MAC地址来决定的，因此该模式在“本地”网络配置下可以工作得很好。如果所有流量是通过单个路由器，由于只有一个网关，源和目标mac都固定了，那么这个算法算出的线路就一直是同一条，那么这种模式就没有多少意义了。<br>需要交换机配置为port channel</li><li>mod=3，即：broadcast（广播策略）这种模式的特点是一个报文会复制两份往bond下的两个接口分别发送出去，<br>当有对端交换机失效，感觉不到任何downtime，但此法过于浪费资源；不过这种模式有很好的容错机制。此模式适用于金融行业，因为他们需要高可靠性的网络，不允许出现任何问题。</li><li>mod=4，即：(802.3ad) IEEE 802.3ad Dynamic link aggregation（IEEE 802.3ad 动态链接聚合）<br>在动态聚合模式下，聚合组内的成员端口上均启用LACP（链路汇聚控制协议）协议，其端口状态通过该协议自动进行维护。<br>负载均衡—基于指定的传输HASH策略传输数据包。默认算法与blance-xor一样。<br>容错能力—这模式的特点增加了带宽，同时支持容错能力，当有链路出问题，会把流量切换到正常的链路上。对比blance-xor，这种模式定期发送LACPDU报文维护链路聚合状态，保证链路质量。需要交换机支持LACP协议</li><li>mod=5，即：(balance-tlb) Adaptive transmit load balancing（适配器传输负载均衡）<br>在每个物理接口上根据当前的负载（根据速度计算）分配外出流量。如果正在接收数据的物理接口口出故障了，另一个物理接口接管该故障物理口的MAC地址。<br>需要ethtool支持获取每个slave的速率</li><li>mod=6，即：(balance-alb) Adaptive load balancing（适配器适应性负载均衡）<br>该模式包含了balance-tlb模式，同时加上针对IPV4流量的接收负载均衡，而且不需要任何switch(交换机)的支持。接收负载均衡是通过ARP协商实现的。bonding驱动截获本机发送的ARP应答，并把源硬件地址改写为bond中某个物理接口的唯一硬件地址，从而使得不同的对端使用不同的硬件地址进行通信。<br>mod=6与mod=0的区别：mod=6，先把eth0流量占满，再占eth1，….ethX；而mod=0的话，会发现2个口的流量都很稳定，基本一样的带宽。而mod=6，会发现第一个口流量很高，第2个口只占了小部分流量</li></ul><h2 id="首先"><a href="#首先" class="headerlink" title="首先"></a>首先</h2><p>链接：</p><p><a href="https://developer.aliyun.com/article/503848">https://developer.aliyun.com/article/503848</a></p><p><a href="https://www.cnblogs.com/5201351/p/4990187.html">https://www.cnblogs.com/5201351/p/4990187.html</a></p><p>先查看一下内核是否已经支持bonding</p><p>1）如果内核已经把bonding编译进内核，那么要做的就是加载该模块到当前内核；其次查看ifenslave该工具是否也已经编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">modprobe  -l   bond\*  或者 modinfo   bonding</span><br><span class="line"><span class="comment"># 加载</span></span><br><span class="line">modprobe --first-time bonding</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">modprobe   bonding </span><br><span class="line">lsmod | grep <span class="string">&#x27;bonding&#x27;</span></span><br><span class="line"><span class="comment"># 设置开机加载</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">&#x27;modprobe bonding &amp;&gt; /dev/null&#x27;</span>  &gt;&gt;  /etc/rc.local </span><br><span class="line"><span class="built_in">which</span>  ifenslave</span><br></pre></td></tr></table></figure><p>注意：默认内核安装完后就已经支持bonding模块了，无需要自己手动编译</p><h2 id="概览（需要至少-3-张网卡）"><a href="#概览（需要至少-3-张网卡）" class="headerlink" title="概览（需要至少 3 张网卡）"></a>概览（需要至少 3 张网卡）</h2><blockquote><p>示例命令：</p><p>nmcli connection add type bond ifname bond0 con-name bond0 miimon 100 mode active-backup primary ens33 ipv4.method manual ipv4.addresses 192.168.221.232/24 ipv4.gateway 192.168.221.25</p><p>参数（若没有指定 则需要手动更改配置 bond 网卡文件 ifcfg-bond0 ）：</p><ul><li>ipv4.gateway 192.168.221.25 ： 为可选参数即配置bond的网关</li><li>/24 ：即bond的子网掩码</li><li>ipv4.dns 8.8.8.8：配置bond的dns（可选参数）</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加bonding接口</span></span><br><span class="line">nmcli con add <span class="built_in">type</span> bond con-name bond0 ifname bond0 mode 1 miimon 100  ipv4.method manual ipv4.addresses 10.0.0.100/24 ipv4.gateway 10.0.0.220 ipv4.dns 223.5.5.5</span><br><span class="line"><span class="comment"># 添加从属接口</span></span><br><span class="line">nmcli con add <span class="built_in">type</span> bond-slave ifname ens224 master bond0</span><br><span class="line">nmcli con add <span class="built_in">type</span> bond-slave ifname ens256 master bond0</span><br><span class="line"><span class="comment"># 注：如无为从属接口提供连接名，则该名称是接口名称加类型构成</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 要启动绑定，则必须首先启动从属接口</span></span><br><span class="line">nmcli con up bond-slave-ens224</span><br><span class="line">nmcli con up bond-slave-ens256</span><br><span class="line"><span class="comment"># 启动绑定</span></span><br><span class="line">nmcli con up bond0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除bond</span></span><br><span class="line">nmcli con del bond0</span><br><span class="line"><span class="comment"># 删除绑定的网卡</span></span><br><span class="line">nmcli con del bond-slave-ens160</span><br><span class="line">nmcli con del bond-slave-ens224</span><br></pre></td></tr></table></figure><h2 id="说明-本次使用vmware实验-："><a href="#说明-本次使用vmware实验-：" class="headerlink" title="说明(本次使用vmware实验 )："></a>说明(本次使用vmware实验 )：</h2><blockquote><p>下方保留ens160与ens224 实际为 ens224 与 ens256</p></blockquote><p>常用的模式为 0,1,3,6<br>mode 1、5、6       不需要交换机设置<br>mode 0、2、3、4  需要交换机设置<br>active-backup、balance-tlb 和 balance-alb 模式不需要交换机的任何特殊配置。其他绑定模式需要配置交换机以便整合链接。如：Cisco 交换机需要在模式 0、2 和 3 中使用 EtherChannel，但在模式4中需要 LACP和EtherChannel</p><h2 id="一-nmcli实现Bonding（需要至少-3-张网卡）"><a href="#一-nmcli实现Bonding（需要至少-3-张网卡）" class="headerlink" title="一. nmcli实现Bonding（需要至少 3 张网卡）"></a>一. nmcli实现Bonding（需要至少 3 张网卡）</h2><h3 id="1-两块网卡都设置为-Nat-模式"><a href="#1-两块网卡都设置为-Nat-模式" class="headerlink" title="1. 两块网卡都设置为 Nat 模式"></a>1. 两块网卡都设置为 Nat 模式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:f2:66:78 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 10.0.0.10/27 brd 10.0.0.31 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fef2:6678/64 scope <span class="built_in">link</span> noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: ens224: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master bond0 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:f2:66:82 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp19s0</span><br><span class="line">4: ens256: &lt;BROADCAST,MULTICAST,SLAVE&gt; mtu 1500 qdisc fq_codel master bond0 state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:f2:66:82 brd ff:ff:ff:ff:ff:ff permaddr 00:0c:29:f2:66:8c</span><br><span class="line">    altname enp27s0</span><br><span class="line">5: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 52:54:00:d4:a9:b3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h3 id="2-创建bond0（需要至少-3-张网卡）"><a href="#2-创建bond0（需要至少-3-张网卡）" class="headerlink" title="2. 创建bond0（需要至少 3 张网卡）"></a>2. 创建bond0（需要至少 3 张网卡）</h3><p>参数说明：</p><ul><li>bond0 为bond0的名称</li><li>ifname 指定DEVICE名称</li><li>type 指定bond类型</li><li>mode 指定bond模式</li><li>ipv4.addresses 指定bond0地址</li></ul><p>添加链路聚合 bond 模式，定义 bond0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加链路聚合 bond 模式，定义 bond0</span></span><br><span class="line">nmcli connection add con-name bond0 ifname bond0 <span class="built_in">type</span> bond miimon 100 mode active-backup ipv4.method manual ipv4.addresses 10.0.0.100/24</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_368aa9c5e4593d8aa1812c310f7d5e12.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_368aa9c5e4593d8aa1812c310f7d5e12.png"></p><p>这里演示模式采用 active-backup ，对应主备模式，即 mode=1 如需要的是其他模式只需要更改：active-backup 改为其他比如改为： balance-rr</p><p>修改网口配置文件（自动生成的网卡配置文件中已包含下述部分配置，请仔细核对，确<br>保下述配置内容无遗漏且正确）<br>vim ifcfg-bond0<br>在 /etc/sysconfig/network-scripts/ 目录下，编写 ifcfg-bond0<br>DEVICE=bond0<br>ONBOOT=yes<br>BOOTPROTO=none<br>IPADDR=10.0.0.12<br>NETMASK=24<br>TYPE=Bond<br>BONDING_OPTS=mode=active-backup<br>GATEWAY=10.0.0.220<br>DNS1=223.5.5.5</p><p><strong>查看添加详情</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看添加详情</span></span><br><span class="line">nmcli connection</span><br><span class="line"></span><br><span class="line">// 返回</span><br><span class="line">NAME    UUID                                  TYPE      DEVICE </span><br><span class="line">ens160  ff7bd1f0-e937-42c0-bba2-1b069e9477c7  ethernet  ens160 </span><br><span class="line">bond0   2a465bf9-89ea-4a3b-b6ae-a94dde548b77  bond      bond0  </span><br><span class="line">virbr0  f51041d3-c680-4162-90d8-0da1c1a32fcd  bridge    virbr0 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看生成的网卡配置文件</span></span><br><span class="line"><span class="built_in">ls</span> /etc/sysconfig/network-scripts/</span><br><span class="line"></span><br><span class="line">// 返回</span><br><span class="line">ifcfg-bond0  ifcfg-ens160</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时生成配置文件ifcfg-bond0 查看文件详情</span></span><br><span class="line">[root@localhost network-scripts]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-bond0</span></span><br><span class="line">BONDING_OPTS=mode=active-backup</span><br><span class="line">TYPE=Bond</span><br><span class="line">BONDING_MASTER=<span class="built_in">yes</span></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">IPADDR=10.0.0.10</span><br><span class="line">PREFIX=24</span><br><span class="line">DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=<span class="built_in">yes</span></span><br><span class="line">IPV6_AUTOCONF=<span class="built_in">yes</span></span><br><span class="line">IPV6_DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=default</span><br><span class="line">NAME=bond0</span><br><span class="line">UUID=2a465bf9-89ea-4a3b-b6ae-a94dde548b77</span><br><span class="line">DEVICE=bond0</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">GATEWAY=10.0.0.220  <span class="comment"># 新加</span></span><br><span class="line">DNS1=223.5.5.5      <span class="comment"># 新加</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-添加端口至bond0中"><a href="#3-添加端口至bond0中" class="headerlink" title="3. 添加端口至bond0中"></a>3. 添加端口至bond0中</h2><p>将网卡ens160  和ens224 添加至 bond0 中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add <span class="built_in">type</span> bond-slave ifname ens160 master bond0</span><br><span class="line">nmcli connection add <span class="built_in">type</span> bond-slave ifname ens224 master bond0</span><br><span class="line"><span class="comment"># 注意顺序</span></span><br></pre></td></tr></table></figure><p><strong>查看详情</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看添加详情</span></span><br><span class="line">nmcli con</span><br><span class="line"></span><br><span class="line">// 返回</span><br><span class="line">NAME               UUID                                  TYPE      DEVICE </span><br><span class="line">ens160             ff7bd1f0-e937-42c0-bba2-1b069e9477c7  ethernet  ens160 </span><br><span class="line">bond0              3a11f05c-c92f-4804-be4f-c04506e819d2  bond      bond0  </span><br><span class="line">virbr0             ba243c12-4f52-4b97-bfbd-c1d57dde75a9  bridge    virbr0 </span><br><span class="line">bond-slave-ens224  6ffdb9e4-6e02-4c53-a266-64702b3c5e40  ethernet  ens224 </span><br><span class="line">bond-slave-ens160  034ea11e-1f8c-43e0-b062-90559525284f  ethernet  --  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看生成的网卡配置文件</span></span><br><span class="line"><span class="built_in">ls</span> /etc/sysconfig/network-scripts/</span><br><span class="line"></span><br><span class="line">// 返回</span><br><span class="line">ifcfg-bond0  ifcfg-bond-slave-ens160  ifcfg-bond-slave-ens224  ifcfg-ens160</span><br></pre></td></tr></table></figure><p><strong>启用bond0</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 要启动绑定，则必须首先启动从属接口 </span></span><br><span class="line">nmcli con up bond-slave-ens160</span><br><span class="line">nmcli con up bond-slave-ens224</span><br><span class="line"><span class="comment"># 启动绑定</span></span><br><span class="line">nmcli con up bond0</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_e2c2c083a0072a5bc7dcabf6335b41d1.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_e2c2c083a0072a5bc7dcabf6335b41d1.png"></p><h3 id="4-效果"><a href="#4-效果" class="headerlink" title="4. 效果"></a>4. 效果</h3><p>查看IP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq master bond0 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:2d:25:64 brd ff:ff:ff:ff:ff:ff permaddr 00:0c:29:2d:25:5a</span><br><span class="line">    altname enp3s0</span><br><span class="line">3: ens224: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq master bond0 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:2d:25:64 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp19s0</span><br><span class="line">4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 52:54:00:d9:ea:56 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: bond0: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:2d:25:64 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.10/24 brd 10.0.0.255 scope global noprefixroute bond0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::e3a9:7228:e43a:9138/64 scope <span class="built_in">link</span> noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p><strong>查看bond状态</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Every 1.0s: <span class="built_in">cat</span> /proc/net/bonding/bond0                                                                                   localhost.localdomain: Tue May  7 11:33:36 2024</span><br><span class="line"></span><br><span class="line">Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)</span><br><span class="line"></span><br><span class="line">Bonding Mode: fault-tolerance (active-backup)</span><br><span class="line">Primary Slave: None</span><br><span class="line">Currently Active Slave: ens224  <span class="comment"># ens224 是主</span></span><br><span class="line">MII Status: up</span><br><span class="line">MII Polling Interval (ms): 100</span><br><span class="line">Up Delay (ms): 0</span><br><span class="line">Down Delay (ms): 0</span><br><span class="line">Peer Notification Delay (ms): 0</span><br><span class="line"></span><br><span class="line">Slave Interface: ens224</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 10000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 00:0c:29:2d:25:64</span><br><span class="line">Slave queue ID: 0</span><br><span class="line"></span><br><span class="line">Slave Interface: ens160</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 10000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 00:0c:29:2d:25:5a</span><br><span class="line">Slave queue ID: 0</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_f3cfde6318f3ab37148e4d6822104dba.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_f3cfde6318f3ab37148e4d6822104dba.png"></p><h3 id="5-扩展-删除bond"><a href="#5-扩展-删除bond" class="headerlink" title="5. 扩展 删除bond"></a>5. 扩展 删除bond</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除bond</span></span><br><span class="line">nmcli con del mybond0</span><br><span class="line"><span class="comment"># 查看详情</span></span><br><span class="line">nmcli con</span><br><span class="line"><span class="comment"># 删除从属</span></span><br><span class="line">nmcli con del bond-slave-ens33</span><br><span class="line">nmcli con del bond-slave-ens36</span><br></pre></td></tr></table></figure><h1 id="二-直接修改配置文件方式配置bond-此种适用于适用network管理"><a href="#二-直接修改配置文件方式配置bond-此种适用于适用network管理" class="headerlink" title="二. 直接修改配置文件方式配置bond(此种适用于适用network管理)"></a>二. 直接修改配置文件方式配置bond(此种适用于适用network管理)</h1><p><strong>概览(命令方式三行命令即可推荐使用此种)：</strong></p><p>可以<strong>先打开NetworkManager</strong>服务执行完成下方命令后<strong>再将其关闭</strong> 最后<strong>重启network</strong>服务</p><p>参数：mode active-backup miimon 100 可写为 mode 1 miimon 100</p><p>使用mode 1 miimon 100时</p><p>BONDING_OPTS=mode=active-backup 变为 BONDING_OPTS=”mode=active-backup miimon=100”</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name bond0 ifname bond0 <span class="built_in">type</span> bond mode active-backup miimon 100 ipv4.addresses 10.0.0.60/24 ipv4.gateway 10.0.0.220 ipv4.dns 223.5.5.5</span><br><span class="line"></span><br><span class="line">nmcli connection add con-name ens224 ifname ens224 <span class="built_in">type</span> bond-slave master bond0</span><br><span class="line">nmcli connection add con-name ens256 ifname ens256 <span class="built_in">type</span> bond-slave master bond0</span><br></pre></td></tr></table></figure><h2 id="1-NAT网络配置（所有服务器）："><a href="#1-NAT网络配置（所有服务器）：" class="headerlink" title="1.NAT网络配置（所有服务器）："></a>1.NAT网络配置（所有服务器）：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion</span><br><span class="line"><span class="built_in">cd</span> /etc/sysconfig/network-scripts/</span><br></pre></td></tr></table></figure><h3 id="bond0配置-实际中记得将dhcp改为static"><a href="#bond0配置-实际中记得将dhcp改为static" class="headerlink" title="bond0配置(实际中记得将dhcp改为static)"></a>bond0配置(实际中记得将dhcp改为static)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 network-scripts]<span class="comment"># cat ifcfg-bond0 </span></span><br><span class="line">BONDING_OPTS=mode=active-backup</span><br><span class="line">TYPE=Bond</span><br><span class="line">BONDING_MASTER=<span class="built_in">yes</span></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">IPADDR=10.0.0.60</span><br><span class="line">PREFIX=24</span><br><span class="line">DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=<span class="built_in">yes</span></span><br><span class="line">IPV6_AUTOCONF=<span class="built_in">yes</span></span><br><span class="line">IPV6_DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=default</span><br><span class="line">NAME=bond0</span><br><span class="line">UUID=a0a8a96c-ec86-4cbe-8b36-849bb4aa20a6</span><br><span class="line">DEVICE=bond0</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>ens224配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 network-scripts]<span class="comment"># cat ifcfg-ens224 </span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOND_PORT_QUEUE_ID=0</span><br><span class="line">BOND_PORT_PRIO=0</span><br><span class="line">NAME=ens224</span><br><span class="line">UUID=8855f02c-a2e6-48e7-86ad-0320382a445a</span><br><span class="line">DEVICE=ens224</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">MASTER=bond0</span><br><span class="line">SLAVE=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>ens256配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 network-scripts]<span class="comment"># cat ifcfg-ens224 </span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOND_PORT_QUEUE_ID=0</span><br><span class="line">BOND_PORT_PRIO=0</span><br><span class="line">NAME=ens224</span><br><span class="line">UUID=8855f02c-a2e6-48e7-86ad-0320382a445a</span><br><span class="line">DEVICE=ens224</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">MASTER=bond0</span><br><span class="line">SLAVE=<span class="built_in">yes</span></span><br><span class="line">[root@k8s1 network-scripts]<span class="comment"># cat ifcfg-ens256</span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOND_PORT_QUEUE_ID=0</span><br><span class="line">BOND_PORT_PRIO=0</span><br><span class="line">NAME=ens256</span><br><span class="line">UUID=c3358675-54e0-43f0-afc9-e8a3a13ad9ed</span><br><span class="line">DEVICE=ens256</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">MASTER=bond0</span><br><span class="line">SLAVE=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p><strong>重启网卡生效：systemctl restart network</strong></p><p><strong>验证</strong></p><ul><li>重启系统看能否正常启动bond0    （正常启动）</li><li>手动down掉网卡看能否正常切换（查看bond命令 <code>cat /proc/net/bonding/bond0</code>）(正常切换)</li><li>查看网卡状态：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 network-scripts]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:2d:25:5a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 10.0.0.10/24 brd 10.0.0.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 10.0.0.187/24 brd 10.0.0.255 scope global secondary dynamic noprefixroute ens160</span><br><span class="line">       valid_lft 1174sec preferred_lft 1174sec</span><br><span class="line">    inet6 fe80::20c:29ff:fe2d:255a/64 scope <span class="built_in">link</span> noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: ens224: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq master bond0 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:2d:25:64 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp19s0</span><br><span class="line">4: ens256: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq master bond0 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:2d:25:64 brd ff:ff:ff:ff:ff:ff permaddr 00:0c:29:2d:25:6e</span><br><span class="line">    altname enp27s0</span><br><span class="line">5: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 52:54:00:d9:ea:56 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">6: bond0: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:2d:25:64 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.60/24 brd 10.0.0.255 scope global noprefixroute bond0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::95d7:d04b:3ab3:49f1/64 scope <span class="built_in">link</span> noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li></ul><p>4.内外网通信：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ping www.baidu.com</span></span><br><span class="line"><span class="comment"># ping 192.168.20.2</span></span><br></pre></td></tr></table></figure><p>参考：</p><p><a href="https://blog.csdn.net/qq_43652666/article/details/119175635">https://blog.csdn.net/qq_43652666/article/details/119175635</a></p><p><a href="https://blog.csdn.net/m0_59586152/article/details/125503956">https://blog.csdn.net/m0_59586152/article/details/125503956</a></p><p><a href="https://www.cnblogs.com/waacode/p/17539417.html">https://www.cnblogs.com/waacode/p/17539417.html</a></p><p><a href="https://www.modb.pro/db/128078">第25篇 centos 8 双网卡绑定（bond链路聚合） - 墨天轮 (modb.pro)</a></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>lvm更换磁盘（存在vg卷组的磁盘损坏）</title>
      <link href="/2024/05/05/lvm%E6%9B%B4%E6%8D%A2%E7%A3%81%E7%9B%98%EF%BC%88%E5%AD%98%E5%9C%A8vg%E5%8D%B7%E7%BB%84%E7%9A%84%E7%A3%81%E7%9B%98%E6%8D%9F%E5%9D%8F%EF%BC%89/"/>
      <url>/2024/05/05/lvm%E6%9B%B4%E6%8D%A2%E7%A3%81%E7%9B%98%EF%BC%88%E5%AD%98%E5%9C%A8vg%E5%8D%B7%E7%BB%84%E7%9A%84%E7%A3%81%E7%9B%98%E6%8D%9F%E5%9D%8F%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="lvm更换磁盘（存在vg卷组的磁盘损坏）"><a href="#lvm更换磁盘（存在vg卷组的磁盘损坏）" class="headerlink" title="lvm更换磁盘（存在vg卷组的磁盘损坏）"></a>lvm更换磁盘（存在vg卷组的磁盘损坏）</h1><blockquote><p>只含有pv的磁盘损坏更换 | <a href="http://sunlight.zznnwn.cloudns.biz/2024/04/24/%E5%A4%9A%E5%9D%97%E7%A3%81%E7%9B%98%E9%85%8D%E7%BD%AElvm%E5%8D%B7%20%E4%B8%8D%E5%90%ABvg%E5%8D%B7%E7%9A%84%E6%9F%90%E5%9D%97%E7%A3%81%E7%9B%98%E6%8D%9F%E5%9D%8F%E8%A7%A3%E5%86%B3/">传送门&gt;&gt;</a></p><p>对于机械硬盘而言，经常会出现坏道，影响整体的磁盘读写速度，此时我们需要更换故障的硬盘，接下来模拟操作整个更换过程。</p></blockquote><h2 id="一-测试环境配置-创建lvm卷挂载并上传文件"><a href="#一-测试环境配置-创建lvm卷挂载并上传文件" class="headerlink" title="一. 测试环境配置 创建lvm卷挂载并上传文件"></a>一. 测试环境配置 创建lvm卷挂载并上传文件</h2><h3 id="1-测试环境"><a href="#1-测试环境" class="headerlink" title="1.测试环境"></a>1.测试环境</h3><p>操作系统：ubuntu20.04</p><p>硬盘：准备3块5GB的硬盘用于测试</p><h3 id="2-前提条件创建lvm卷"><a href="#2-前提条件创建lvm卷" class="headerlink" title="2.前提条件创建lvm卷"></a>2.前提条件创建lvm卷</h3><p>使用sdb、sdc加入LVM并配置lv，创建过程如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建PV</span></span><br><span class="line">pvcreate /dev/sd&#123;b..c&#125;   </span><br><span class="line"><span class="comment"># 创建VG</span></span><br><span class="line">vgcreate vg00 /dev/sdb /dev/sdc  </span><br><span class="line"><span class="comment"># 创建一个8GB的LV</span></span><br><span class="line">lvcreate -n lv00 -L 8G vg00  </span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_8827a051a031111cb47e8e85d0f319fe.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_8827a051a031111cb47e8e85d0f319fe.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_fb1428a67eb75bf19a574c17ca127574.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_fb1428a67eb75bf19a574c17ca127574.png"></p><h3 id="3-格式化LV并挂载"><a href="#3-格式化LV并挂载" class="headerlink" title="3. 格式化LV并挂载"></a>3. 格式化LV并挂载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 格式化为ext4格式</span></span><br><span class="line">mkfs.ext4 /dev/vg00/lv00  </span><br><span class="line"><span class="comment"># 创建挂载目录</span></span><br><span class="line"><span class="built_in">mkdir</span> /lv00_datadir   </span><br><span class="line"><span class="comment"># 挂载</span></span><br><span class="line">mount /dev/vg00/lv00 /lv00_datadir  </span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_1827ebb3ba929ebaa9a949fca6455667.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_1827ebb3ba929ebaa9a949fca6455667.png"></p><p>上传测试文件，我在这里上传一个镜像文件，约为15M左右；</p><p>使用md5sum命令来验证硬盘更换后数据的完整性：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看文件md5</span></span><br><span class="line"><span class="built_in">md5sum</span> /lv00_datadir/cirros-0.4.0-x86_64-disk.img</span><br><span class="line">// 返回</span><br><span class="line">443b7623e27ecf03dc9e01ee93f67afe  /lv00_datadir/cirros-0.4.0-x86_64-disk.img</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_8449f31b43f6f17a71494598fc1e2ec4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_8449f31b43f6f17a71494598fc1e2ec4.png"></p><h2 id="二-更换磁盘-迁移坏道磁盘数据"><a href="#二-更换磁盘-迁移坏道磁盘数据" class="headerlink" title="二. 更换磁盘 迁移坏道磁盘数据"></a>二. 更换磁盘 迁移坏道磁盘数据</h2><p>假设 sdb 目前存在一些问题，需要使用 sdd 来替换：</p><h3 id="1-配置sdd"><a href="#1-配置sdd" class="headerlink" title="1.配置sdd"></a>1.配置sdd</h3><p>将 sdd 分区后加入到 VG 中：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将sdd创建pv卷</span></span><br><span class="line">pvcreate /dev/sdd</span><br><span class="line"><span class="comment"># 将sdd加入vg卷</span></span><br><span class="line">vgextend vg00 /dev/sdd</span><br></pre></td></tr></table></figure><h3 id="2-迁移数据"><a href="#2-迁移数据" class="headerlink" title="2. 迁移数据"></a>2. 迁移数据</h3><h4 id="2-1-通过pvdisplay命令来查看磁盘sdb上是否存有数据："><a href="#2-1-通过pvdisplay命令来查看磁盘sdb上是否存有数据：" class="headerlink" title="2.1 通过pvdisplay命令来查看磁盘sdb上是否存有数据："></a>2.1 通过pvdisplay命令来查看磁盘sdb上是否存有数据：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看pv卷详情</span><br><span class="line">pvdisplay /dev/sdb</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_817b1d5249e0b48e8d3076f68c3ba559.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_817b1d5249e0b48e8d3076f68c3ba559.png"></p><p>可以看到，此时的sdb基本被用满了，相应地sdd还没有开始使用：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_4089272617ed1608011e87085bb86d9b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_4089272617ed1608011e87085bb86d9b.png"></p><h4 id="2-2-迁移数据，将sdb中的数据迁移到sdd中："><a href="#2-2-迁移数据，将sdb中的数据迁移到sdd中：" class="headerlink" title="2.2 迁移数据，将sdb中的数据迁移到sdd中："></a>2.2 迁移数据，将sdb中的数据迁移到sdd中：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 迁移sdb pv卷中的数据到 sdd</span><br><span class="line">pvmove /dev/sdb /dev/sdd</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_8ca50c610533e1eded58b727b1b8c044.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_8ca50c610533e1eded58b727b1b8c044.png"></p><p>再次查看磁盘sdb上是否存有数据：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pvdisplay /dev/sdb</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_980104501d271293dbf431880b22eca2.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_980104501d271293dbf431880b22eca2.png"></p><p>或者使用pvscan查看：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_2caa41a0e2c1b5e0807bdc99e46b3054.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_2caa41a0e2c1b5e0807bdc99e46b3054.png"></p><h4 id="2-3-移出sdb"><a href="#2-3-移出sdb" class="headerlink" title="2.3 移出sdb"></a>2.3 移出sdb</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将sdb从VG中移出</span></span><br><span class="line">vgreduce vg00 /dev/sdb  </span><br><span class="line"><span class="comment"># 删除PV</span></span><br><span class="line">pvremove /dev/sdb  </span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_93fa85b202ffddcbdada05ec2e6aa091.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_93fa85b202ffddcbdada05ec2e6aa091.png"></p><h4 id="2-4-检查数据完整性"><a href="#2-4-检查数据完整性" class="headerlink" title="2.4 检查数据完整性"></a>2.4 检查数据完整性</h4><p>还是使用md5sum命令来检查数据完整性：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5sum /lv00_datadir/cirros-0.4.0-x86_64-disk.img</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_51b7a5f9066d34eac92af24ffd2babeb.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_51b7a5f9066d34eac92af24ffd2babeb.png"></p><p>更换前与更换后计算出来的值都是一样，说明数据完整，测试成功。</p><p>本文参考：<a href="https://mp.weixin.qq.com/s?__biz=MzkwOTY0NTYzOA==&mid=2247485700&idx=1&sn=35450d4ddf918e6478a1e0af1eaff545&chksm=c136cb2df641423bf4b25c3918b69898582ed4263b0cc2bd633534de05e1b4bc7c7a95ba671d&mpshare=1&scene=24&srcid=0502Gk8XleBsbnh0t6JiGCo9&sharer_shareinfo=84be6c1a5a08f273b8d004edbbc0418a&sharer_shareinfo_first=84be6c1a5a08f273b8d004edbbc0418a#rd">会成长的小学生</a></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker设置iptables=false后无法解析DNS的解决方法</title>
      <link href="/2024/04/29/docker%E8%AE%BE%E7%BD%AEiptables=false%E5%90%8E%E6%97%A0%E6%B3%95%E8%A7%A3%E6%9E%90DNS%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
      <url>/2024/04/29/docker%E8%AE%BE%E7%BD%AEiptables=false%E5%90%8E%E6%97%A0%E6%B3%95%E8%A7%A3%E6%9E%90DNS%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="docker设置iptables-false后无法解析DNS的解决方法"><a href="#docker设置iptables-false后无法解析DNS的解决方法" class="headerlink" title="docker设置iptables=false后无法解析DNS的解决方法"></a>docker设置iptables=false后无法解析DNS的解决方法</h1><blockquote><p>本文参考：<a href="https://blog.csdn.net/wang805447391/article/details/120719570">docker设置iptables=false后无法解析DNS的解决方法_docker iptables false</a></p><p>docker默认使用iptables进行网络配置，与ufw有点不兼容，ufw无法管控docker暴露出来的端口，可能会造成一定的安全问题，所以某些情况下需要将docker的iptables设置为false。<br>设置之后进入docker容器内部发现无法访问网络，只能与172.17.0.1网段通信。</p></blockquote><h2 id="解决方案如下："><a href="#解决方案如下：" class="headerlink" title="解决方案如下："></a>解决方案如下：</h2><p>sudo systemctl edit docker.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">ExecStartPre=/usr/sbin/iptables -t nat -A POSTROUTING -s 172.0.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line">ExecStopPost=/usr/sbin/iptables -t nat -D POSTROUTING -s 172.0.0.0/16 ! -o docker0 -j MASQUERADE</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_411fbc44b1e7914f452aa767b676f8ce.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_411fbc44b1e7914f452aa767b676f8ce.png"></p><p>配置解释：</p><p>这段配置的作用是为Docker容器设置网络地址转换（NAT），使得从172.17.0.0/16子网发出的流量经过docker0接口时进行MASQUERADE（伪装）处理，以实现网络地址的转换和隐藏。</p><p>在这段配置中：</p><ul><li><code>ExecStartPre</code> 行指定了在启动服务之前执行的操作，即向iptables中添加一个POSTROUTING规则，对从172.17.0.0/16子网发出的流量进行MASQUERADE处理，但排除了流量经过docker0接口的情况。</li><li><code>ExecStopPost</code> 行指定了在停止服务之后执行的操作，即从iptables中删除之前添加的相同规则。</li></ul><p>这种配置通常用于在Docker环境中管理网络流量，确保容器内部的流量能够正常地与外部通信，并且对外部网络隐藏了容器内部的真实IP地址。</p><h2 id="生效配置"><a href="#生效配置" class="headerlink" title="生效配置"></a>生效配置</h2><p>sudo systemctl daemon-reload  即可</p><p>systemctl restart docker  测试docker能否正常启动</p><p>参考资料：<br><a href="https://gist.github.com/circa10a/e6cfc673af9282d17dfb958ef6adabeb">https://gist.github.com/circa10a/e6cfc673af9282d17dfb958ef6adabeb</a><br><a href="https://github.com/moby/moby/issues/26776">https://github.com/moby/moby/issues/26776</a></p>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多块磁盘配置lvm卷 不含vg卷的某块磁盘损坏解决</title>
      <link href="/2024/04/24/%E5%A4%9A%E5%9D%97%E7%A3%81%E7%9B%98%E9%85%8D%E7%BD%AElvm%E5%8D%B7%20%E4%B8%8D%E5%90%ABvg%E5%8D%B7%E7%9A%84%E6%9F%90%E5%9D%97%E7%A3%81%E7%9B%98%E6%8D%9F%E5%9D%8F%E8%A7%A3%E5%86%B3/"/>
      <url>/2024/04/24/%E5%A4%9A%E5%9D%97%E7%A3%81%E7%9B%98%E9%85%8D%E7%BD%AElvm%E5%8D%B7%20%E4%B8%8D%E5%90%ABvg%E5%8D%B7%E7%9A%84%E6%9F%90%E5%9D%97%E7%A3%81%E7%9B%98%E6%8D%9F%E5%9D%8F%E8%A7%A3%E5%86%B3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="多块磁盘配置lvm卷-不含vg卷的某块磁盘损坏解决"><a href="#多块磁盘配置lvm卷-不含vg卷的某块磁盘损坏解决" class="headerlink" title="多块磁盘配置lvm卷 不含vg卷的某块磁盘损坏解决"></a>多块磁盘配置lvm卷 不含vg卷的某块磁盘损坏解决</h1><p><strong>解析</strong></p><p>Linux 的 LVM 会默认存储用户对 PV/VG/LV 的每一步操作，并自动把当前的 VG 的信息备份到一个文件里面，位置是 /etc/lvm/backup/VG 名或者 /etc/lvm/archive/VG 名。这个文件里面记录的东西大概跟 vgdisplay/pvdisplay/lvdisplay 输出的信息一致，里面也包括了对于恢复 VG 信息至关重要的 PV UUID。</p><p><strong>适用场景：</strong></p><p>误操作、磁盘异常掉电等原因可能会造成硬盘的逻辑损坏，当LVM中某块硬盘出现异常时，会导致部分逻辑卷或整个卷组无法访问的情况。我们查看pv时会发现提示unknow device,并提示“Couldn’t find device with uuid xxx”。问题如图，本文介绍了LVM中某块硬盘损坏的灾难修复，来尽可能恢复灾难所造成的数据损失。</p><h2 id="一-具体现象"><a href="#一-具体现象" class="headerlink" title="一. 具体现象"></a><strong>一. 具体现象</strong></h2><p><strong>模拟坏境：两块磁盘配置 lvm</strong> 挂载于<strong>home</strong>目录，模拟其中一块磁盘损坏（手动卸载其中一块磁盘）</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_01d0781150239f60d611e745039163f0.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_01d0781150239f60d611e745039163f0.png"></p><p>挂载目录写入文件测试恢复 能否恢复数据</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_d66d4886fa622e78c8eb0e4a953bc95a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_d66d4886fa622e78c8eb0e4a953bc95a.png"></p><p><strong>现象</strong>：<strong>此时有一块pv处于unknow状态 重启系统后现象如下</strong></p><ul><li>lsblk 查看没有看到  /dev/mapper 开头的lvm卷</li><li>pvs 查看有一块磁盘 pv 处于 unknow 状态 并且显示：WARNING: Couldn’t find device with uuid FCda1V-EwWN-qtfc-6SZ4-Vu1e-v8FG-XUCr5H 找不到这个uuid的设备</li><li>mount 挂载显示找不到设备</li></ul><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_2f4b8b5f102e1cf6be27e0f7225fc7a8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_2f4b8b5f102e1cf6be27e0f7225fc7a8.png"></p><h2 id="二-解决"><a href="#二-解决" class="headerlink" title="二. 解决"></a><strong>二. 解决</strong></h2><ol><li><p>服务器新添加一块磁盘 磁盘的大小和 损坏磁盘的大小一致 此次新添加磁盘为 /dev/sdd</p></li><li><p>使用pvs定位损坏磁盘uuid: 8Acrc0-21LJ-yWfm-f7gb-2uvf-ogLu-cG6OIT</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_7ad156f3d7d7bb8786b4b9794428c366.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_7ad156f3d7d7bb8786b4b9794428c366.png"></p></li><li><p>使用原来的PV UUID来创建PV，并使用lvm配置备份文件来恢复信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看pv返回损坏磁盘uuid: 8Acrc0-21LJ-yWfm-f7gb-2uvf-ogLu-cG6OIT</span></span><br><span class="line">pvs</span><br><span class="line"><span class="comment"># 使用原来的PV UUID来创建PV，并使用lvm配置备份文件来恢复信息（本文使用）</span></span><br><span class="line">pvcreate --uuid  8Acrc0-21LJ-yWfm-f7gb-2uvf-ogLu-cG6OIT --restorefile /etc/lvm/backup/vg_mf  /dev/sdd</span><br><span class="line"><span class="comment"># 或使用类似如下命令</span></span><br><span class="line">pvcreate /dev/vdc -u qaTzJn-Hdgc-aeC5-EUT0-H1l1-tPiA-rYXnDx --restorefile /etc/lvm/archive/vgtest_00002-645033136.vg</span><br></pre></td></tr></table></figure></li><li><p>我们可以看到sdc已经成功替换为了sdd</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_9029ced509c4251026a34bf3d3959213.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_9029ced509c4251026a34bf3d3959213.png"></p></li><li><p>如果替换后的/dev/sdd 的attr为a-m 表示/dev/sdd为missing状态 则需要执行下方命令恢复</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 替换后的/dev/sdd 的attr为a-m 表示/dev/sdd为missing状态 则需要执行下方命令恢复（本文使用）</span></span><br><span class="line">vgextend --restoremissing vg_mf /dev/sdd</span><br><span class="line"><span class="comment"># 或使用类似如下命令方式</span></span><br><span class="line">vgcfgrestore -f archive/vgtest_00002-645033136.vg vgtest</span><br></pre></td></tr></table></figure></li><li><p>确认硬盘<strong>没有在</strong> missing 状态后，对卷组进行恢复，提示恢复vg，没有报错，使用lvscan发现当前lv状态为inactive。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 刷新</span></span><br><span class="line">lvscan</span><br><span class="line"><span class="comment"># 恢复卷组信息</span></span><br><span class="line">vgcfgrestore -f  /etc/lvm/backup/vg_mf   vg_mf</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_dec1593e4a081755a2714700aa9fc7f9.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_dec1593e4a081755a2714700aa9fc7f9.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_f5fbb85873ba0a7afb2d618093af9743.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_f5fbb85873ba0a7afb2d618093af9743.png"></p></li><li><p>激活vg，再次查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 刷新</span></span><br><span class="line">lvscan</span><br><span class="line"><span class="comment"># 激活vg</span></span><br><span class="line">vgchange -ay vg_mf</span><br></pre></td></tr></table></figure><p>此时再次使用 lvscan 查看 lvm 卷状态变为 active</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_92c783e15b2248b4ca139d58f27f9000.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_92c783e15b2248b4ca139d58f27f9000.png"></p></li><li><p>最后重新挂载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看磁盘uuid</span></span><br><span class="line">blkid</span><br><span class="line"><span class="comment"># 挂载lvm卷</span></span><br><span class="line">mount /dev/mapper/vg_mf-lv_mf  /home</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_11474a9f9fdc89f0de5d179adac186d2.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_11474a9f9fdc89f0de5d179adac186d2.png"></p><p>验证数据是否恢复</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_e38c176548f7b5581090fcad7b034dfe.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_e38c176548f7b5581090fcad7b034dfe.png"></p><p>但是这种方式存在一个bug 有时候重启lsblk 看不到lvm卷信息 需要重新激活vg卷 挂载.。</p></li></ol><p>此时恢复成功。</p><p><strong>本文参考</strong></p><ul><li><a href="https://developer.aliyun.com/article/766142">https://developer.aliyun.com/article/766142</a></li><li><a href="https://blog.csdn.net/m0_64339281/article/details/134873834">https://blog.csdn.net/m0_64339281/article/details/134873834</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开源聊天系统fiora与Vocechat部署</title>
      <link href="/2024/04/22/%E5%BC%80%E6%BA%90%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9Ffiora%E4%B8%8EVocechat%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/04/22/%E5%BC%80%E6%BA%90%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9Ffiora%E4%B8%8EVocechat%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="开源聊天系统fiora与Vocechat部署"><a href="#开源聊天系统fiora与Vocechat部署" class="headerlink" title="开源聊天系统fiora与Vocechat部署"></a>开源聊天系统fiora与Vocechat部署</h1><h2 id="一-Vocechat部署"><a href="#一-Vocechat部署" class="headerlink" title="一. Vocechat部署"></a>一. Vocechat部署</h2><blockquote><p>官网：<a href="https://doc.voce.chat/zh-cn/install/install-by-docker">Docker 安装 | VoceChat</a></p><p>github仓库：<a href="https://github.com/privoce">https://github.com/privoce</a></p><p>ios 安卓 app下载：<a href="https://voce.chat/zh-CN#download">VoceChat Website</a></p><p>缺点：使用firebase通知推送 对国内不友好 基本无法使用</p><p>管理员需在 Firebase Cloud Console 中配置 <strong>FCM</strong>。</p><p>⚠️ 请注意：如果使用自定义的推送配置，则移动端（iOS 及 Android）的推送服务将会不可用，这与 iOS 和 Android 的应用签名相关。因此只有网页端可以收到推送消息。目前在最新的网页端中提供了一套默认配置，详情可以访问设置 -&gt; Firebase。远期规划会提供移动端 SDK，到时可以由用户用自己的项目签名。</p><p>⚠️ 如果您的 VoceChat 后端部署在中国大陆，则推送可能因网络管制而不可用，因为目前的推送服务依赖 Google Firebase。我们计划逐步将推送替换成直接支持 APNs 及其他国内安卓手机厂商支持的平台。</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Vocechat是一套支持独立部署的个人云社交媒体聊天服务，具有轻量级、开源和可自托管等特点。它博采众长，从Slack、Discord、RocketChat、Solid、Matrix等产品和规范中汲取优点，适用于团队内部交流、个人聊天服务搭建、网站客服以及网站内嵌社区等场景。</p><p>Vocechat能轻易部署在私有云上，用户可以轻松将其部署到自己的服务器上，用户数据完全由用户自己掌握，传输过程加密，保证了数据的安全性。此外，Vocechat的体积仅为15MB，几乎可以塞进任何服务器里，同时拥有正常聊天所需要的所有必备功能，如回复、转发、点赞、钉选消息等。其界面简洁，能够快速上手，支持在线上传文件、图片、视频，并且支持在线播放视频。</p><p>在团队内部交流方面，Vocechat可以作为一个高效的沟通工具，支持成员间的实时聊天、文件共享和协作。对于个人聊天服务搭建，Vocechat提供了丰富的自定义选项，用户可以根据自己的需求进行个性化设置。同时，它也可以作为网站客服工具，提供与访客的实时交流功能，提升客户服务质量。此外，Vocechat还可以以插件的形式插入到网页中，提供网页聊天等各种丰富的功能。</p><h4 id="项目组成"><a href="#项目组成" class="headerlink" title="项目组成"></a>项目组成</h4><table><thead><tr><th><strong><strong>名称</strong></strong></th><th><strong><strong>技术</strong></strong></th><th><strong><strong>项目</strong></strong></th><th><strong><strong>License</strong></strong></th><th><strong><strong>说明</strong></strong></th></tr></thead><tbody><tr><td>服务端:</td><td>Rust</td><td>vocechat-server(暂未开源)</td><td>待定</td><td>聊天服务端，支持主流平台: Linux x86_64, Windows 32/64, Arm32, Arch64</td></tr><tr><td>客户端:</td><td>Flutter</td><td><a href="https://github.com/privoce/vocechat-client" title="vocechat-client">vocechat-client</a></td><td>Apache-2.0</td><td>聊天客户端，支持 Android, iOS 平台的客户端</td></tr><tr><td>Web:</td><td>React</td><td><a href="https://github.com/privoce/vocechat-web" title="vocechat-web">vocechat-web</a></td><td>GPL-3.0</td><td>聊天功能的浏览器版本，整合了管理</td></tr><tr><td>Web-SDK:</td><td>React</td><td>vocechat-web-sdk(暂未开源)</td><td>GPL-3.0</td><td>可以整合到其他 Web 产品中，使其赋能聊天功能</td></tr></tbody></table></blockquote><p><strong>功能介绍</strong></p><ul><li>支持中英文</li><li>支持Android、iOS端</li><li>支持Docker安装，部署极其简单</li><li>备份简单</li><li>支持对接自有账号系统</li><li>支持第三方登录（比如GitHub、MetaMask、Google等）</li><li>支持访问控制 &amp; 访客模式</li><li>API文档详细</li><li>支持自建频道</li></ul><p><strong>功能列表 &amp; 计划</strong></p><ul><li>群聊、私聊 / 2021-Q4</li><li>引用, at / 2021-Q4</li><li>图片、大文件传输 / 2021-Q4</li><li>置顶 / 2022-Q1</li><li>转发 / 2022-Q1</li><li>收藏 / 2022-Q1</li><li>阅后即焚（高级功能） / 2022-Q1</li><li>语音（高级功能）/ 2022-Q4</li><li>视频（高级功能）/ 2022-Q4</li></ul><h2 id="docker-compose部署"><a href="#docker-compose部署" class="headerlink" title="docker-compose部署"></a>docker-compose部署</h2><p>镜像可选</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">privoce/vocechat-server:latest</span></span><br><span class="line"><span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:vocechat-server</span></span><br></pre></td></tr></table></figure><p>部署</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">vocechat:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:vocechat-server</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;8000:3000&#x27;</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">vocechat-server</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;./data:/home/vocechat-server/data&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="机器人使用"><a href="#机器人使用" class="headerlink" title="机器人使用"></a>机器人使用</h2><p>API地址：<a href="http://10.0.0.10:8000/api/swagger">http://10.0.0.10:8000/api/swagger</a></p><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_5fb9785cb7a0243bc3a8210f6267e92a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_5fb9785cb7a0243bc3a8210f6267e92a.png"></p><h2 id="二-fiora部署"><a href="#二-fiora部署" class="headerlink" title="二. fiora部署"></a>二. fiora部署</h2><blockquote><p>github仓库：<a href="https://github.com/yinxin630/fiora">https://github.com/yinxin630/fiora</a></p><p>中文教程：<a href="https://yinxin630.github.io/fiora/zh-Hans/docs/faq">https://yinxin630.github.io/fiora/zh-Hans/docs/faq</a></p><p><strong>修改客户端配置需要重新构建客户端</strong></p><table><thead><tr><th>Key</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>Server</td><td>string</td><td>/</td><td>客户端要连接的服务端地址</td></tr><tr><td>MaxImageSize</td><td>number</td><td>3145728 (3MB)</td><td>客户端可以上传的最大图片大小</td></tr><tr><td>MaxBackgroundImageSize</td><td>number</td><td>5242880 (5MB)</td><td>客户端可以上传的最大背景图大小</td></tr><tr><td>MaxAvatarSize</td><td>number</td><td>1572864 (1.5MB)</td><td>客户端可以上传的最大头像图片大小</td></tr><tr><td>MaxFileSize</td><td>number</td><td>10485760 (10MB)</td><td>客户端可以上传的最大文件大小</td></tr><tr><td>DefaultTheme</td><td>string</td><td>cool</td><td>默认主题</td></tr><tr><td>Sound</td><td>string</td><td>default</td><td>默认通知音</td></tr><tr><td>TagColorMode</td><td>string</td><td>fixedColor</td><td>默认标签颜色模式</td></tr><tr><td>FrontendMonitorAppId</td><td>string</td><td>fixedColor</td><td>岳鹰监控 appId<a href="https://yueying.effirst.com/index">https://yueying.effirst.com/index</a></td></tr><tr><td>DisableDeleteMessage</td><td>boolean</td><td>false</td><td>禁止用户撤回消息</td></tr></tbody></table><h3 id="服务端变量配置"><a href="#服务端变量配置" class="headerlink" title="服务端变量配置#"></a>服务端变量配置<a href="https://yinxin630.github.io/fiora/zh-Hans/docs/config#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%85%8D%E7%BD%AE" title="标题的直接链接">#</a></h3><p><strong>修改服务端配置需要重启应用</strong></p><table><thead><tr><th>Key</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>Host</td><td>string</td><td>your ip</td><td>服务端 host</td></tr><tr><td>Port</td><td>number</td><td>9200</td><td>服务端端口号</td></tr><tr><td>Database</td><td>string</td><td>mongodb://localhost:27017/fiora</td><td>mongoDB 数据库地址</td></tr><tr><td>RedisHost</td><td>string</td><td>localhost</td><td>redis 地址主机名</td></tr><tr><td>RedisPort</td><td>number</td><td>6379</td><td>redis 端口</td></tr><tr><td>JwtSecret</td><td>string</td><td>jwtSecret (推荐修改它来保证安全性)</td><td>jwt token 加密 secret</td></tr><tr><td>MaxGroupCount</td><td>number</td><td>3</td><td>用户最大可以创建的群组个数</td></tr><tr><td>AllowOrigin</td><td>string</td><td>null</td><td>允许的客户端 origin 列表, null 时允许所有 origin 连接, 多个值逗号分割</td></tr><tr><td>tokenExpiresTime</td><td>number</td><td>2592000000 (30 天)</td><td>登陆 token 过期时间</td></tr><tr><td>Administrator</td><td>string</td><td>‘’</td><td>管理员用户 id 列表, 多个值逗号分割</td></tr><tr><td>DisableRegister</td><td>boolean</td><td>false</td><td>禁止注册账号</td></tr><tr><td>DisableCreateGroup</td><td>boolean</td><td>false</td><td>禁止创建群组</td></tr><tr><td>ALIYUN_OSS</td><td>boolean</td><td>false</td><td>启用阿里云 OSS</td></tr><tr><td>ACCESS_KEY_ID</td><td>string</td><td>‘’</td><td>阿里云 OSS access key id. 参考:<a href="https://help.aliyun.com/document_detail/48699.html">https://help.aliyun.com/document_detail/48699.html</a></td></tr><tr><td>ACCESS_KEY_SECRET</td><td>string</td><td>‘’</td><td>阿里云 OSS access key secret. 参考和 ACCESS_KEY_ID 相同</td></tr><tr><td>ROLE_ARN</td><td>string</td><td>‘’</td><td>阿里云 OSS RoleARN. 参考:<a href="https://help.aliyun.com/document_detail/28649.html">https://help.aliyun.com/document_detail/28649.html</a></td></tr><tr><td>REGION</td><td>string</td><td>‘’</td><td>阿里云 OSS 地域. 例如:<code>oss-cn-zhangjiakou</code></td></tr><tr><td>BUCKET</td><td>string</td><td>‘’</td><td>阿里云 OSS bucket 名称</td></tr><tr><td>ENDPOINT</td><td>string</td><td>‘’</td><td>阿里云 OSS 域名. 例如:<code>cdn</code></td></tr></tbody></table></blockquote><p><strong>镜像可选</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官方镜像</span></span><br><span class="line">redis</span><br><span class="line">mongo</span><br><span class="line">suisuijiang/fiora</span><br><span class="line"><span class="comment"># zznn阿里云镜像</span></span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:redis4</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:mongo5.0.18</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:fiora</span><br></pre></td></tr></table></figure><h3 id="docker-compose部署-1"><a href="#docker-compose部署-1" class="headerlink" title="docker-compose部署"></a><code>docker-compose</code>部署</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">fiora_redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:redis4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">fiora_redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">fiora-network</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">fiora_db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:mongo5.0.18</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">fiora_db</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27017:27017&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">fiora-network</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">fiora:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:fiora</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">fiora</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Database=mongodb://fiora_db:27017/fiora</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RedisHost=fiora_redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DisableRegister=true</span>  <span class="comment"># 设置不允许注册用户</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">fiora-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">fiora-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><p>目录说明</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">|-- [.githubb]                // github actions</span><br><span class="line">|-- [.vscode]                 // vscode 工作区配置</span><br><span class="line">|-- [bin]                     // 服务端脚本</span><br><span class="line">|-- [build]                   // webpack 配置</span><br><span class="line">|-- [client]                  // web 客户端</span><br><span class="line">|-- [config]                  // 应用配置</span><br><span class="line">|-- [dist]                    // 构建客户端输出目录</span><br><span class="line">|-- [docs]                    // 文档</span><br><span class="line">|-- [public]                  // 服务端静态资源</span><br><span class="line">|-- [server]                  // 服务端</span><br><span class="line">|-- [<span class="built_in">test</span>]                    // 单元测试</span><br><span class="line">|-- [types]                   // typescript 类型</span><br><span class="line">|-- [utils]                   // 工具方法</span><br><span class="line">|-- .babelrc                  // babel 配置</span><br><span class="line">|-- .eslintignore             // eslint 忽略</span><br><span class="line">|-- .eslintrc                 // eslint 配置</span><br><span class="line">|-- .gitignore                // git 忽略</span><br><span class="line">|-- .nodemonrc                // nodemon 配置</span><br><span class="line">|-- .prettierrc               // prettier 配置</span><br><span class="line">|-- Dockerfile                // docker 文件</span><br><span class="line">|-- LICENSE                   // fiora 许可</span><br><span class="line">|-- docker-compose.yaml       // docker compose 配置</span><br><span class="line">|-- jest.*.sj                 // jest 配置</span><br><span class="line">|-- package.json              // npm</span><br><span class="line">|-- tsconfig.json             // typescript 配置</span><br><span class="line">|-- yarn.lock                 // yarn</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>此安装就完成了，修改文件，fiora页面修改路径</strong></p><ul><li>以下logo：<br>/opt/fiora/public/favicon-96.png<br>/opt/fiora/public/favicon-192.png<br>/opt/fiora/public/favicon-512.png<br>以下主页修改路径<br>/opt/fiora/client/templates/index.html<br>以下侧边栏修改路径<br>/opt/fiora/client/modules/Sidebar/</li></ul><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>不允许注册时打开（需要注册时取消注释即可）：</p><ul><li>DisableRegister=true  # 设置不允许注册用户</li></ul><p>其他配置参考：<a href="https://blog.csdn.net/weixin_63660670/article/details/130824723">https://blog.csdn.net/weixin_63660670/article/details/130824723</a></p>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开源模型接入平台MaxKB部署</title>
      <link href="/2024/04/21/%E5%BC%80%E6%BA%90%E6%A8%A1%E5%9E%8B%E6%8E%A5%E5%85%A5%E5%B9%B3%E5%8F%B0MaxKB%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%AF%B9%E6%8E%A5OneApi/"/>
      <url>/2024/04/21/%E5%BC%80%E6%BA%90%E6%A8%A1%E5%9E%8B%E6%8E%A5%E5%85%A5%E5%B9%B3%E5%8F%B0MaxKB%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%AF%B9%E6%8E%A5OneApi/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="开源模型接入平台MaxKB部署及对接OneApi"><a href="#开源模型接入平台MaxKB部署及对接OneApi" class="headerlink" title="开源模型接入平台MaxKB部署及对接OneApi"></a>开源模型接入平台MaxKB部署及对接OneApi</h1><blockquote><p>本平台由国内值得尊敬的强大公司飞致云开源的支持多用户隔离的模型接入平台</p><p>MaxKB 是一款基于 LLM 大语言模型的知识库问答系统。</p><ul><li><p>多模型支持：支持对接主流的大模型，包括本地私有大模型（如 Llama 2）、OpenAI、通义千问、Kimi、Azure OpenAI 和百度千帆大模型等；</p></li><li><p>开箱即用：支持直接上传文档、自动爬取在线文档，支持文本自动拆分、向量化，智能问答交互体验好；</p></li><li><p>无缝嵌入：支持零编码快速嵌入到第三方业务系统。</p></li><li><p>默认用户密码 用户名: admin  密码: MaxKB@123..</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ab8425771622018b1cac85a6fcd23de4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ab8425771622018b1cac85a6fcd23de4.png"></p></li></ul></blockquote><h2 id="一-部署"><a href="#一-部署" class="headerlink" title="一. 部署"></a>一. 部署</h2><p>镜像可选</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1panel/maxkb</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:maxkb-v1.4.1</span><br></pre></td></tr></table></figure><p>docker命令方式部署</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=maxkb -p 8080:8080 -v ~/.maxkb:/var/lib/postgresql/data 1panel/maxkb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户名: admin</span></span><br><span class="line"><span class="comment"># 密码: MaxKB@123..</span></span><br></pre></td></tr></table></figure><p>docker-compose方式部署</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  maxkb:</span><br><span class="line">    <span class="comment">#image: registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:zznnwn-maxkb</span></span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:maxkb-v1.4.1</span><br><span class="line">    <span class="comment"># 1panel/maxkb</span></span><br><span class="line">    container_name: maxkb</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ~/.maxkb:/var/lib/postgresql/data</span><br></pre></td></tr></table></figure><h2 id="二-使用"><a href="#二-使用" class="headerlink" title="二. 使用"></a>二. 使用</h2><ul><li>系统设置——模型——添加模型</li><li>知识库——创建知识库</li><li>应用——创建特定功能应用</li></ul><h2 id="三-对接oneapi"><a href="#三-对接oneapi" class="headerlink" title="三. 对接oneapi"></a>三. 对接oneapi</h2><ul><li>API域名：<a href="http://192.168.30.69:3000/v1">http://192.168.30.69:3000/v1</a></li><li>API KEY:  使用oneapi生成的key</li></ul><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/706aff61c16b2461c19832f3ff3478e_6235ec82459de423aa720924cc3adec8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/706aff61c16b2461c19832f3ff3478e_6235ec82459de423aa720924cc3adec8.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_dee2044e670622e3092cfed2755c916e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_dee2044e670622e3092cfed2755c916e.png"></p><h2 id="四-效果"><a href="#四-效果" class="headerlink" title="四. 效果"></a>四. 效果</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_c968720d48c42e71925c7c325bf39e88.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_c968720d48c42e71925c7c325bf39e88.png"></p><p>本文参考：</p><p><a href="https://github.com/1panel-dev/MaxKB">https://github.com/1panel-dev/MaxKB</a></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kvm教程</title>
      <link href="/2024/04/20/kvm%E6%95%99%E7%A8%8B/"/>
      <url>/2024/04/20/kvm%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="kvm教程"><a href="#kvm教程" class="headerlink" title="kvm教程"></a>kvm教程</h1><h3 id="虚拟化的定义"><a href="#虚拟化的定义" class="headerlink" title="虚拟化的定义"></a>虚拟化的定义</h3><p>虚拟化技术最早出现在60年代的IBM大型机系统，这些机器通过Hypervisor(又称虚拟机监控器)的程序在一台物理的服务器上可以跑多台虚拟机(VirtualMachine，VM)，虚拟机共享物理机的CPU、内存、10 等硬件资源，但逻辑上虚拟机之间是相互隔离的。</p><h3 id="常见的Hypervisor类型"><a href="#常见的Hypervisor类型" class="headerlink" title="常见的Hypervisor类型"></a>常见的Hypervisor类型</h3><p><strong>类型1-裸机型</strong>:  直接运行在硬件设备上的，这种架构搭建的虚拟化环境称为裸机虚拟化环境，例如:VMware ESXl<br><strong>类型I1-主机托管型</strong>:  运行在具有虚拟化功能的操作系统上的，这种架构构建的是主机虚拟化环境，例<br><strong>如</strong>: VMware Workstation.VirtualBox、KVM、xen等。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_2121384e9f54523bd1280ade709ccda4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_2121384e9f54523bd1280ade709ccda4.png"></p><h3 id="虚拟化的类型"><a href="#虚拟化的类型" class="headerlink" title="虚拟化的类型"></a>虚拟化的类型</h3><p><strong>服务器虚拟化</strong>: 可在一台物理机上运行多个虚拟机，各虚拟机之间相互隔离互不影响，虚拟机的完整状态保存到文件中，移动和复制虚拟机就像移动和复制文件一样轻松，可将任意虚拟机调配或迁移到其他理服务器上。</p><p><strong><strong>容器虚技术</strong>: 典型的就是docker、Linux Container(LXC)等</strong></p><p><strong>网络虚拟化</strong>: 通过软件定义网络，即网络的创建不再依赖于物理设备，如公有云厂商允许用户自己创建新的网络，在kubernetes、openstack中都会使用到网络虚拟化。</p><h3 id="虚拟化技术分类"><a href="#虚拟化技术分类" class="headerlink" title="虚拟化技术分类"></a>虚拟化技术分类</h3><p><strong>全虚拟化</strong>: Hypervisor 直接安装在物理机上，多个虚拟机在 Hypervisor 上运行，Hypervisor 实现方式一般是一个特殊定制的 Linux 系统，<strong>例如</strong>: Xen和VMWare ESXi 都属于这个类型。（适用于企业私有）**</p><p><strong>硬件辅助虚拟化</strong>: KVM是硬件辅助的虚拟化技术，主要负责比较繁琐的<strong>CPU</strong>和<strong>内存虚拟化</strong>，而<strong>Qemu</strong>则负责<strong>I/0</strong>虚拟化。（适用于公有云）</p><p><strong>虚拟化模拟器</strong>: Qemu 模拟器在生产环境中，大多数的做法都是配合KVM来完成虚拟化工作，KVM完成复杂及要求比较高的CPU和内存的虚拟化，而Qemu完成像硬盘、鼠标、键盘等设备的虚拟化。（适用于公有云）</p><h3 id="KVM虚拟化介绍"><a href="#KVM虚拟化介绍" class="headerlink" title="KVM虚拟化介绍"></a>KVM虚拟化介绍</h3><p><strong>KVM</strong> 是Kernel-based Virtual Machine(基于内核的虚拟机)的简称，是一个开源的Linux系统内核虚拟化模块，自Linux2.6之后集成在Linux的各个主要发行版本中，KVM目前已成为学术界主流的hypervisor。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ab78ebf3ee7974ceac39b802b6d3b861.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ab78ebf3ee7974ceac39b802b6d3b861.png"></p><h3 id="虚拟机常用的管理工具"><a href="#虚拟机常用的管理工具" class="headerlink" title="虚拟机常用的管理工具"></a>虚拟机常用的管理工具</h3><p><strong>libvirt:</strong> 是调用KVM创建虚拟机的工具，其不但能管理KVM，还能管理VMware、Xen、Hyper-V、virtualBox等虚拟化方案。</p><p><strong>virsh</strong>: 是一个常用的管理KVM虚拟化的命令行工具。</p><p><strong>virt-manager</strong>:  virt-manager是一个虚拟化管理图形软件，包括虚拟机的创建、删除、启动、停止以及一些简单的监控功能等。（很少使用不安装）</p><p><strong>openstack</strong>:  openstack是一个开源的虚拟化集群统一管理的平台，常用于构建大规模的虚拟化环境，用于管理成千上万虚拟机的创建、启动、删除等整个生命周期</p><blockquote><h3 id="生产环境中-创建虚拟机一律使用此命令（下方两参数根据宿主机cpu-mem实际合理范围更改）"><a href="#生产环境中-创建虚拟机一律使用此命令（下方两参数根据宿主机cpu-mem实际合理范围更改）" class="headerlink" title="生产环境中 创建虚拟机一律使用此命令（下方两参数根据宿主机cpu mem实际合理范围更改）"></a>生产环境中 创建虚拟机一律使用此命令（下方两参数根据宿主机cpu mem实际合理范围更改）</h3><ul><li><strong>maxmemory</strong>=2048   最大支持的内存核心数</li><li><strong>maxvcpus</strong>=4             最大支持的CPU核心数<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建虚拟机</span></span><br><span class="line">virt-install --virt-type kvm \</span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant rhel7 \</span><br><span class="line">--name web04 \</span><br><span class="line">--memory 1024,maxmemory=2048 \</span><br><span class="line">--vcpus 1,maxvcpus=4 --disk /kvm/web04-vda.qcow2,format=qcow2,size=10 \</span><br><span class="line">--cdrom /opt/CentOS-7-x86_64-Minimal-2009.iso --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br></pre></td></tr></table></figure></li></ul><p>其中，<code>--ram</code>指定内存大小（MB），<code>--vcpus</code>指定虚拟CPU数量，<code>--disk</code>指定磁盘文件路径和大小，<code>--cdrom</code>指定ISO镜像路径，<code>--network</code>指定网络配置，<code>--graphics</code>指定图形界面配置。</p><p>此时连接到虚拟机完成配置即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-viewer myvm1</span><br></pre></td></tr></table></figure><p>现在，您应该可以在虚拟机中安装操作系统了</p><p>常用命令概览：</p><h3 id="管理虚拟机"><a href="#管理虚拟机" class="headerlink" title="管理虚拟机"></a>管理虚拟机</h3><p>使用<code>virt-install</code>创建虚拟机后，您可以使用以下命令进行管理：</p><ul><li><code>virsh list --all</code>：列出所有虚拟机。</li><li><code>virsh start myvm1</code>：启动虚拟机。</li><li><code>virsh stop myvm1</code>：停止虚拟机。</li><li><code>virsh suspend myvm1</code>：挂起虚拟机。</li><li><code>virsh resume myvm1</code>：恢复挂起的虚拟机。</li><li><code>virsh destroy myvm1</code>：强制关闭虚拟机。</li></ul><p>你执行的 <code>virsh destroy web04</code> 命令是<strong>强制关闭</strong>虚拟机 <code>web04</code>，相当于直接断电，不会执行正常的关机流程。</p><p>如果你想<strong>正常关机</strong>，建议使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh shutdown web04</span><br></pre></td></tr></table></figure><p>如果 <code>web04</code> 不是故意关闭的，你可以用下面的命令重新启动：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh start web04</span><br></pre></td></tr></table></figure><p>如果虚拟机无法启动或者有其他问题，欢迎继续交流！😊</p></blockquote><h2 id="二-安装kvm虚拟化管理工具（本教程环境workstdtion）"><a href="#二-安装kvm虚拟化管理工具（本教程环境workstdtion）" class="headerlink" title="二. 安装kvm虚拟化管理工具（本教程环境workstdtion）"></a>二. 安装kvm虚拟化管理工具（本教程环境workstdtion）</h2><table><thead><tr><th><strong>主机名称</strong></th><th><strong>IP地址</strong></th><th><strong>系统环境</strong></th><th><strong>硬件环境</strong></th></tr></thead><tbody><tr><td><strong>kvm01</strong></td><td><strong>10.0.0.10</strong></td><td><strong>centos7.9</strong></td><td><strong>4C8G50G</strong></td></tr></tbody></table><h3 id="虚拟机CPU开启虚拟化功能"><a href="#虚拟机CPU开启虚拟化功能" class="headerlink" title="虚拟机CPU开启虚拟化功能"></a>虚拟机CPU开启虚拟化功能</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_17270590f1aeca75a8028b0714cd4f21.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_17270590f1aeca75a8028b0714cd4f21.png"></p><p><strong>开机后检测CPU是否支持嵌套虚拟化</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# egrep -o &#x27;vmx|svm&#x27; /proc/cpuinfo</span><br><span class="line">vmx</span><br><span class="line">vmx  显示已载入的系统模块</span><br></pre></td></tr></table></figure><h3 id="安装KVM相关软件包"><a href="#安装KVM相关软件包" class="headerlink" title="安装KVM相关软件包"></a>安装KVM相关软件包</h3><p><strong>准备工作 本文执行初始化脚本本项目不执行</strong>（可选）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rm /etc/yum.repos.d</span><br><span class="line">mount /dev/cdrom /mnt</span><br><span class="line">vim /etc/fstab </span><br><span class="line">/dev/cdrom  /mnt  iso9660  default 0  0 </span><br><span class="line">vim  /etc/yum.repos.d/local.repo</span><br><span class="line">[local]</span><br><span class="line">name=local</span><br><span class="line">baseurl=file:///mnt</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure><p><strong>libvirt</strong>:  用于创建虚拟机</p><p><strong>virt-install</strong>：虚拟机的安装工具和克隆工具(非常重要的功能)</p><p><strong>qemu-kvm</strong>:  管理虚拟机的磁盘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 检测源</span><br><span class="line">yum repolist</span><br><span class="line"># 安装软件</span><br><span class="line">yum insta1l libvirt virt-install qemu-kvm -y</span><br><span class="line"># ubuntuu则为</span><br><span class="line">apt install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virtinst</span><br><span class="line"># 启动服务</span><br><span class="line">systemctl start libvirtd &amp;&amp; systemctl enable libvirtd &amp;&amp; systemctl status libvirtd</span><br></pre></td></tr></table></figure><h3 id="创建KVM虚拟机（选择轻量镜像方便实验上传下载）"><a href="#创建KVM虚拟机（选择轻量镜像方便实验上传下载）" class="headerlink" title="创建KVM虚拟机（选择轻量镜像方便实验上传下载）"></a>创建KVM虚拟机（选择轻量镜像方便实验上传下载）</h3><p><strong>提前将centos镜像上传到系统内用于给kvm虚拟机安装系统</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提前将centos7镜像传到系统内用于给KVM虚拟机安装系统</span></span><br><span class="line"><span class="built_in">mv</span> CentOS-7-x86_64-Minimal-2009.iso /opt</span><br><span class="line"><span class="comment"># 创建KVM虛拟机</span></span><br><span class="line">virt-install --virt-type kvm \</span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant rhel7 \</span><br><span class="line">--name web01 \</span><br><span class="line">--memory 1024 \</span><br><span class="line">--vcpus 1 --disk /opt/web01-vda.raw,format=raw,size=10 --cdrom /opt/CentOS-7-x86_64-Minimal-2009.iso \</span><br><span class="line">--network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole </span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数解释:</span></span><br><span class="line">--virt-type kvm  <span class="comment"># 虚拟化的类型</span></span><br><span class="line">--os-type=linux  <span class="comment"># 系统类型</span></span><br><span class="line">--os-variant     <span class="comment"># rhel7系统版本</span></span><br><span class="line">--name webO1     <span class="comment"># 虚拟机的名字</span></span><br><span class="line">--memory 1024    <span class="comment"># 虚拟机的内存</span></span><br><span class="line">--vcpus 1        <span class="comment"># 虚拟cpu的核数</span></span><br><span class="line">--disk /opt/web0l-vda.raw,format=raw,size=10  <span class="comment"># 磁盘位置及名称,磁盘格式,空间大小(G)</span></span><br><span class="line">--cdrom /opt/CentOS-7-x86_64-Minimal-2009.iso <span class="comment"># 系统镜像位置及名称</span></span><br><span class="line">--network network=default     <span class="comment"># 使用默认网络(默认NAT)</span></span><br><span class="line">--graphics vnc,listen=0.0.0.0 <span class="comment"># 开启VNC</span></span><br><span class="line">--noautoconsole               <span class="comment"># 服务器端支持console登录 </span></span><br></pre></td></tr></table></figure><p><strong>翻译</strong>：安装完成后需要去控制台完成安装 电脑安装一个或者使用mobaxterm连接完成安装</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_94db20daccc7489e24ae4fbc9e524935.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_94db20daccc7489e24ae4fbc9e524935.png"></p><p>虚拟机vnc暴露端口<strong>5900</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm opt]<span class="comment"># ss -ntulp</span></span><br><span class="line">Netid State      Recv-Q Send-Q   Local Address:Port      Peer Address:Port              </span><br><span class="line">tcp   LISTEN     0      1     *:5900    <span class="built_in">users</span>:((&quot;qemu-kvm&quot;,pid=<span class="number">3551</span>,fd=<span class="number">19</span>))</span><br></pre></td></tr></table></figure><p><strong>连接过来之后便在此安装页面</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_d271ac8899700a02171525adff77649f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_d271ac8899700a02171525adff77649f.png"></p><p>此时按照正常安装流程即可 安装完成后点击重启此时不会重启 需要我们手动打开（通过 <strong>ss -ntulp</strong> 查看 <strong>qemo-kvm</strong> 端口 通过 <strong>vnc</strong> 连接虚拟机查看虚拟机 <strong>IP</strong> 地址）其实此时我们 可以通过宿主机 使用此虚拟机 <strong>IP：192.168.122.39</strong> 连上虚拟机  并且由于此此虚拟机网络是 <strong>NAT</strong> 模式 是可以借助宿主机去访问 <strong>外网</strong> 的。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_5387c7f9aad4ae74127c22f44a330630.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_5387c7f9aad4ae74127c22f44a330630.png"></p><h2 id="三-kvm常用命令使用"><a href="#三-kvm常用命令使用" class="headerlink" title="三. kvm常用命令使用"></a>三. kvm常用命令使用</h2><blockquote><p><a href="https://zznn-cloud.github.io/2024/02/19/openstack%E4%B8%8A%E4%BD%BF%E7%94%A8windows%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C/?highlight=%E5%88%9B%E5%BB%BA">此前创建windows类型虚拟机见链接</a></p><h3 id="一-virsh常用命令概览"><a href="#一-virsh常用命令概览" class="headerlink" title="一. virsh常用命令概览"></a>一. virsh常用命令概览</h3><p>练习命令之前安装 <code>yum install -y bash-*</code>用于命令补全</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># 查看刚通过镜像启动的虚拟机虚拟机 / 查看--os-variant支持的类型</span><br><span class="line">virsh list             # 列出正在运行的虚拟机</span><br><span class="line">osinfo-query os        # 查看支持的类型</span><br><span class="line"># virt-install常用命令</span><br><span class="line">virsh list --all       # 列出所有虚机</span><br><span class="line">virsh start  web01     # 启动指定虚机</span><br><span class="line">virsh reboot web01     # 重启指定虚机（关闭状态无法重启）</span><br><span class="line">virsh console name     # 连接虚拟机</span><br><span class="line">virsh destroy name     # 拔掉电源（很少用）</span><br><span class="line"></span><br><span class="line">virsh undefine web01   # 删除虚机文件即删除虚拟机（不会删除磁盘文件）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">virsh domblklist web01             # 查看虚拟机磁盘信息</span><br><span class="line">virsh dominfo    web01             # 查看虚拟机配置信息</span><br><span class="line">virsh domiflist  web01             # 查看虚拟网卡信息</span><br><span class="line">virsh dumpxml    web01             # 以 xml格式查看虚拟机</span><br><span class="line">virsh define     file-name        # 导入虚拟机</span><br><span class="line">virsh edit       name             # 编辑虚拟机配置（一般是在刚定义完虚拟机之后）自带语法检测</span><br><span class="line">virsh domrename  old-name  new-name   # 虚拟机重命名</span><br><span class="line">virsh vncdisplay web01                # 查看vnc端口</span><br><span class="line">virsh autostart  name                 # 虚拟机随机重启</span><br><span class="line">virsh autostart --disable name        # 取消虚拟机随机重启</span><br><span class="line"></span><br><span class="line"># 图形界面：</span><br><span class="line">通过执行名virt-manager，启动libvirt的图形界面，在图形界面下可以一步一步的创建虚拟机，管理虚拟机，还可以直接控制虚拟机的桌面。</span><br><span class="line"># 命令行：</span><br><span class="line">virsh list                              # 显示本地活动虚拟机</span><br><span class="line">virsh list –all                         # 显示本地所有的虚拟机（活动的+不活动的）</span><br><span class="line">virsh define ubuntu.xml                 # 通过配置文件定义一个虚拟机（这个虚拟机还不是活动的）</span><br><span class="line">virsh start ubuntu                      # 启动名字为ubuntu的非活动虚拟机</span><br><span class="line">virsh create ubuntu.xml                 # 创建虚拟机（创建后，虚拟机立即执行，成为活动主机）</span><br><span class="line">virsh suspend ubuntu                    # 暂停虚拟机</span><br><span class="line">virsh resume ubuntu                     # 启动暂停的虚拟机</span><br><span class="line">virsh shutdown web01          # 正常关闭虚拟机</span><br><span class="line">virsh destroy ubuntu          # 强制拔掉电源关闭虚拟机（很少使用）</span><br><span class="line"></span><br><span class="line">virsh domname 2                         # 显示id号为2的虚拟机名                                </span><br><span class="line">virsh domid ubuntu                      # 显示虚拟机id号                               </span><br><span class="line">virsh domuuid ubuntu                    # 显示虚拟机的uuid           </span><br><span class="line">virsh domstate ubuntu                   # 显示虚拟机的当前状态          </span><br><span class="line">virsh dumpxml ubuntu                    # 显示虚拟机的当前配置文件（可能和定义虚拟机时的配置不同，因为当虚拟机启动时，需要给# 虚拟机分配id号、uuid、vnc端口号等等）          </span><br><span class="line">virsh setmem ubuntu 512000               # 给不活动虚拟机设置内存大小  </span><br><span class="line">virsh setvcpus ubuntu 4                  # 给不活动虚拟机设置cpu个数          </span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="二-备份恢复虚拟机"><a href="#二-备份恢复虚拟机" class="headerlink" title="二. 备份恢复虚拟机"></a>二. 备份恢复虚拟机</h3><p><strong>备份虚拟机</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导出虚拟机配置文件</span></span><br><span class="line">virsh dumpxml web01 &gt; web01_bak.xml</span><br><span class="line"><span class="comment"># 此时我们模拟一下恢复虚拟机先删除虚拟机</span></span><br></pre></td></tr></table></figure><p><strong>删除虚拟机（先关机再删除） 此时磁盘文件仍然是被保留的</strong></p><p><strong>备注</strong>：此步骤为模拟恢复虚拟机执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virsh shutdown web01</span><br><span class="line">virsh undefine web01 </span><br><span class="line">virsh list --all</span><br></pre></td></tr></table></figure><p><strong>恢复虚拟机（以刚才的备份文件导入虚拟机）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从备份文件导入虚拟机</span></span><br><span class="line">virsh define web01_bak.xml</span><br><span class="line"><span class="comment"># 此时再看刚才的虚拟机又回来了</span></span><br><span class="line">virsh list --all</span><br><span class="line"></span><br><span class="line">Id    Name                           State</span><br><span class="line">-----------------------------------------</span><br><span class="line"> -    web01                          shut off</span><br></pre></td></tr></table></figure><p><strong>为什么又回来了呢 因为我们使用virsh undefine  删除的是 /etc/libvirt/qemu 路径下对应的虚拟机配置文件</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_cbceb58948ef431e9a1f63b2c22da55b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_cbceb58948ef431e9a1f63b2c22da55b.png"></p><h3 id="三-虚拟机磁盘文件迁移"><a href="#三-虚拟机磁盘文件迁移" class="headerlink" title="三. 虚拟机磁盘文件迁移"></a>三. 虚拟机磁盘文件迁移</h3><p>备注：我们创建虚拟机时会 生成了一个raw格式的磁盘文件 web01-vda.raw</p><p><strong>创建kvm路径，将虚拟机磁盘文件移动到该目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建kvm路径，将虚拟机磁盘文件移动到该目录</span></span><br><span class="line"><span class="built_in">mkdir</span> /kvm &amp;&amp; <span class="built_in">mv</span> /opt/web01-vda.raw /kvm &amp;&amp; <span class="built_in">cd</span> /kvm &amp;&amp; <span class="built_in">ls</span></span><br></pre></td></tr></table></figure><p><strong>编辑虚拟机配置（自带语法检测）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份虚拟机配置（编辑前先备份）</span></span><br><span class="line">virsh dumpxml web01 &gt; web01_bak.xml</span><br><span class="line"><span class="comment"># 编辑虚拟机配置</span></span><br><span class="line">virsh edit web01</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改路径 /opt/web01-vda.raw &gt;&gt; /kvm/web01-vda.raw（修改前）</span></span><br><span class="line">  &lt;devices&gt;</span><br><span class="line">    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/opt/web01-vda.raw&#x27;</span>/&gt;   <span class="comment"># 此路径</span></span><br><span class="line">      &lt;target dev=<span class="string">&#x27;vda&#x27;</span> bus=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x06&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line"> <span class="comment"># 修改后</span></span><br><span class="line">   &lt;devices&gt;</span><br><span class="line">    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/kvm/web01-vda.raw&#x27;</span>/&gt;    <span class="comment"># 此路径</span></span><br><span class="line">      &lt;target dev=<span class="string">&#x27;vda&#x27;</span> bus=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x06&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line"><span class="comment"># 此时启动虚拟机</span></span><br><span class="line">virsh start web01</span><br><span class="line"></span><br><span class="line">[root@kvm kvm]<span class="comment"># virsh start web01</span></span><br><span class="line">Domain web01 started</span><br><span class="line"></span><br><span class="line">[root@kvm kvm]<span class="comment"># virsh list --all</span></span><br><span class="line"> Id    Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 5     web01                          running</span><br></pre></td></tr></table></figure><h3 id="四-虚拟机重命名（只能在关机状态改名）"><a href="#四-虚拟机重命名（只能在关机状态改名）" class="headerlink" title="四. 虚拟机重命名（只能在关机状态改名）"></a>四. 虚拟机重命名（只能在关机状态改名）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关机</span></span><br><span class="line">virsh shutdown web01</span><br><span class="line"><span class="comment"># 改名</span></span><br><span class="line">virsh domrename web01 centos-web01</span><br></pre></td></tr></table></figure><h3 id="五-查看虚拟机-vnc-端口（虚拟机太多之后-VNC-端口就会不一样）只有启动状态才会有-VNC-端口"><a href="#五-查看虚拟机-vnc-端口（虚拟机太多之后-VNC-端口就会不一样）只有启动状态才会有-VNC-端口" class="headerlink" title="五. 查看虚拟机 vnc 端口（虚拟机太多之后 VNC 端口就会不一样）只有启动状态才会有 VNC 端口"></a>五. 查看虚拟机 vnc 端口（虚拟机太多之后 VNC 端口就会不一样）只有启动状态才会有 VNC 端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">virsh start web01</span><br><span class="line"><span class="comment"># 查看vnc端口</span></span><br><span class="line">virsh vncdisplay web01</span><br><span class="line">// 返回</span><br><span class="line">:0</span><br></pre></td></tr></table></figure><p>**备注：单台虚拟机时返回 其实此 **<strong>0</strong> 代表默认端口 <strong>5900</strong> 多台时便会网上增加 如两台时 显示 <strong>1</strong> 即 从 <strong>5900</strong> 往上加 <strong>1</strong> 即 <strong>5901</strong></p><h3 id="六-虚拟机随机自启（-为了宿主机重启后虚拟机也会重启-）否则宿主机重启-虚拟机不会自启动"><a href="#六-虚拟机随机自启（-为了宿主机重启后虚拟机也会重启-）否则宿主机重启-虚拟机不会自启动" class="headerlink" title="六.  虚拟机随机自启（ 为了宿主机重启后虚拟机也会重启 ）否则宿主机重启 虚拟机不会自启动"></a>六.  虚拟机随机自启（ 为了宿主机重启后虚拟机也会重启 ）否则宿主机重启 虚拟机不会自启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置与宿主机一起随机自启</span></span><br><span class="line">virsh autostart web01</span><br><span class="line"><span class="comment"># 查看那些虚拟机设置了随机自启（一个都没有设置的话此目录不会生成与虚拟机相同名字的文件）</span></span><br><span class="line"><span class="built_in">cd</span> /etc/libvirt/qemu/autostart &amp;&amp; <span class="built_in">ls</span></span><br><span class="line">web01.xml</span><br><span class="line"><span class="comment"># 取消随机自启（此时此/etc/libvirt/qemu/autostart目录对应文件已消失）</span></span><br><span class="line">virsh autostart web01 --<span class="built_in">disable</span></span><br></pre></td></tr></table></figure><h3 id="七-通过console登录kvm"><a href="#七-通过console登录kvm" class="headerlink" title="七. 通过console登录kvm"></a>七. 通过<code>console</code>登录<code>kvm</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过console登录虚拟机控制台</span></span><br><span class="line">virsh console web01</span><br><span class="line">// 返回</span><br><span class="line">Connected to domain web01</span><br><span class="line">Escape character is ^]  <span class="comment"># ctrl + ] 退出，默认无法登录</span></span><br></pre></td></tr></table></figure><p><strong>虚拟机配置允许<code>console</code>登录</strong></p><p>进入 <strong>KVM</strong> 虚拟机修改内核参数允许 <strong>console</strong> 登录，先通过 <strong>VNC</strong> 查看虚拟机 <strong>IP</strong> 地址，在通过宿主机 <strong>ssh</strong> 方式登录到 <strong>KVM</strong> 内部增加该配置项: grubby-update-kernel=ALL-args=”console=ttyS0,115200n8”</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入kvm虚拟机</span></span><br><span class="line">ssh -p22 root@192.168.122.39</span><br><span class="line"><span class="comment"># 修改内核参数</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&quot;console=ttyS0,115200n8&quot;</span></span><br><span class="line"><span class="comment"># 重启虚拟机生效</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><p><strong>验证 console 登录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># console 登录虚拟机</span></span><br><span class="line">virsh console web01</span><br><span class="line">// 返回</span><br><span class="line">Connected to domain web01</span><br><span class="line">Escape character is ^]   <span class="comment"># 回车</span></span><br><span class="line"></span><br><span class="line">CentOS Linux 7 (Core)</span><br><span class="line">Kernel 3.10.0-1160.el7.x86_64 on an x86_64</span><br><span class="line"></span><br><span class="line">localhost login:         <span class="comment"># 此时出现登录选项</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ee9df9423348cd4db4a62b05f970e4a5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ee9df9423348cd4db4a62b05f970e4a5.png"></p></blockquote><h2 id="四-KVM磁盘管理"><a href="#四-KVM磁盘管理" class="headerlink" title="四. KVM磁盘管理"></a>四. <code>KVM</code>磁盘管理</h2><p><strong>kvm磁盘格式介绍</strong></p><p><strong>raw</strong>: 老牌格式，用一个字来说就是裸，也就是赤裸裸，指定多大空间就创建多大空间，直接占用指定大小的空间分 <strong>50G</strong> 占用 <strong>50G</strong> ，性能上来说的话还是不错的，不支持快照功能。</p><p><strong><strong>cow</strong>: 曾经 qemu 的写时拷贝的镜像格式（用户在修改数据时，系统会拷贝一份源文件副本到内存中让其修改，等到数据真正被修改时才分配空间）目前由于历史遗留原因不支持窗口模式。从某种意义上来说是个弃婴，还没等它成熟就死在腹中，后来被 qcow 格式所取代。</strong> <strong><strong>qcow</strong>: 一代的 qemu 的 cow 格式，刚刚出现的时候有比较好的特性，但其性能和 raw 格式对比还是有很大的差距，目前已经被新版本的qcow2 取代。</strong></p><p><strong>qcow2</strong>: 是 openstack 默认也是比较推荐的格式，文件比较小而且做快照也比较小，空间是动态增长（用多少占多少 但不会超过定义的容量），是目前比较主流的一种虚拟化镜像格式，经过一代的优化，目前 qcow2 的性能上接近 raw 裸格式的性能。</p><p><strong>我们创建时就是使用 raw 格式创建的</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_6aadb90398f3b87f7888616461239e9d.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_6aadb90398f3b87f7888616461239e9d.png"></p><p><strong>查看虚拟机磁盘</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看虚拟机磁盘</span></span><br><span class="line">virsh domblklist web01</span><br><span class="line">// 返回</span><br><span class="line">Target     Source</span><br><span class="line">------------------------------------------------</span><br><span class="line">vda         /kvm/web01-vda.raw</span><br><span class="line">hda         -</span><br></pre></td></tr></table></figure><p><strong>查看磁盘详细信息</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看磁盘详细信息</span></span><br><span class="line">qemu-img info /kvm/web01-vda.raw</span><br><span class="line">// 返回</span><br><span class="line">image: /kvm/web01-vda.raw</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 10G (10737418240 bytes)</span><br><span class="line">disk size: 1.7G</span><br></pre></td></tr></table></figure><h3 id="1-创建-qcow2-格式磁盘的虚拟机"><a href="#1-创建-qcow2-格式磁盘的虚拟机" class="headerlink" title="1. 创建 qcow2 格式磁盘的虚拟机"></a><code>1.</code> 创建 qcow2 格式磁盘的虚拟机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 qcow2 格式磁盘的虚拟机</span></span><br><span class="line">virt-install --virt-type kvm \</span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant rhel7 \</span><br><span class="line">--name web02 \</span><br><span class="line">--memory 1024 \</span><br><span class="line">--vcpus 1 --disk /kvm/web02-vda.qcow2,format=qcow2,size=10 --cdrom /opt/CentOS-7-x86_64-Minimal-2009.iso \</span><br><span class="line">--network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole </span><br></pre></td></tr></table></figure><p><strong>查看 VNC 端口 可见端口是 5901</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm kvm]<span class="comment"># virsh vncdisplay web02</span></span><br><span class="line">:1</span><br></pre></td></tr></table></figure><p><strong>VNC 连接</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_7185c32c48a56a379db496bfe893fee4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_7185c32c48a56a379db496bfe893fee4.png"></p><h3 id="2-qcow2格式磁盘虚拟机使用"><a href="#2-qcow2格式磁盘虚拟机使用" class="headerlink" title="2. qcow2格式磁盘虚拟机使用"></a><code>2. qcow2</code>格式磁盘虚拟机使用</h3><p><strong>查看磁盘格式</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看磁盘格式</span></span><br><span class="line">qemu-img info web02-vda.qcow2</span><br><span class="line">//返回</span><br><span class="line">image: web02-vda.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 10G (10737418240 bytes)</span><br><span class="line">disk size: 1.5G         <span class="comment"># 用多少占多少</span></span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: <span class="literal">true</span></span><br></pre></td></tr></table></figure><p><strong>操作</strong>：</p><ul><li><strong>开机虚拟机宿主机重启虚拟机自启动</strong><code>virsh autostart web01</code></li><li><strong>登录：</strong><code>ssh -p22 root@192.168.122.46</code></li><li><strong>虚拟机配置允许 console 登录：</strong><code>grubby --update-kernel=ALL --args=&quot;console=ttyS0,115200n8&quot;</code></li><li><strong>生效（</strong><code>virsh shutdown web02 &amp;&amp; virsh start web02</code>）</li><li><strong>通过console登录：</strong><code>virsh console web02</code></li></ul><h2 id="五-kvm磁盘虚拟机快照管理"><a href="#五-kvm磁盘虚拟机快照管理" class="headerlink" title="五. kvm磁盘虚拟机快照管理"></a>五. <code>kvm</code>磁盘虚拟机快照管理</h2><p><strong>raw 磁盘格式虚拟机****不支持做快照</strong>，qcow2 <strong>支持快照</strong>，并且快照就保存在 qcow2 的磁盘文件中。</p><h3 id="1-创建快照"><a href="#1-创建快照" class="headerlink" title="1.创建快照"></a><code>1.</code>创建快照</h3><p><strong>格式: virsh snapshot-create-as   –name  快照名称   虚拟机名称</strong></p><blockquote><p><strong>解释：</strong></p><p><strong>virsh snapshot-create-as 创建快照</strong> <strong>–name                   快照名称</strong> <strong>web02                    虚拟机名称</strong></p></blockquote><p>为 <strong>web02</strong> 虚拟机创建快照（开关机都可以做快照）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为 web02 虚拟机创建快照</span></span><br><span class="line">virsh snapshot-create-as --name  kuaizhao_web2_env_ok  web2</span><br><span class="line">//返回</span><br><span class="line">Domain snapshot kuaizhao_web2_env_ok created</span><br><span class="line"><span class="comment"># 创建成功后查看快照</span></span><br><span class="line">virsh snapshot-list web02</span><br><span class="line">//返回</span><br><span class="line"> Name                 Creation Time             State</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"> kuaizhao_web2_env_ok 2024-04-21 16:30:45 +0800 running</span><br></pre></td></tr></table></figure><p><strong>验证快照</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录虚拟机</span></span><br><span class="line">virsh console web02</span><br><span class="line"><span class="comment"># 创建快照测试文件</span></span><br><span class="line"><span class="built_in">touch</span> kuaizhao-test.txt</span><br></pre></td></tr></table></figure><h3 id="2-还原快照"><a href="#2-还原快照" class="headerlink" title="2. 还原快照"></a><code>2.</code> 还原快照</h3><p><strong>格式:  virsh snapshot-revert  虚拟机名称  –snapshotname  快照名称</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行恢复快照</span></span><br><span class="line">virsh snapshot-revert web02 --snapshotname kuaizhao_web2_env_ok</span><br></pre></td></tr></table></figure><p><strong>备注：查看创建的文件还存在不 （不存在 此时验证成功）</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_d7d30c0888f72a011b3c3eafe594c960.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_d7d30c0888f72a011b3c3eafe594c960.png"></p><blockquote><p><strong>提示：别删除虚拟机，删除虚拟机后没有虚拟机配置文件无法还原</strong></p></blockquote><h3 id="3-删除快照"><a href="#3-删除快照" class="headerlink" title="3. 删除快照"></a><code>3.</code> 删除快照</h3><p><strong>格式:  virsh  snapshot-delete 虚拟机名称  –snapshotname  快照名称</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除快照</span></span><br><span class="line">virsh snapshot-delete web02 --snapshotname kuaizhao_web2_env_ok </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否删除成功</span></span><br><span class="line">virsh snapshot-list web02</span><br><span class="line">//返回</span><br><span class="line"> Name                 Creation Time             State</span><br><span class="line">------------------------------------------------------------</span><br></pre></td></tr></table></figure><h2 id="六-kvm虚拟机克隆"><a href="#六-kvm虚拟机克隆" class="headerlink" title="六. kvm虚拟机克隆"></a>六. <code>kvm</code>虚拟机克隆</h2><p><strong>虚拟机的克隆方式分为完整克隆与链接克隆，下图是VMware虚拟机对完整克隆与链接克隆的解释</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_197336118a437919c95a1c428c7843e3.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_197336118a437919c95a1c428c7843e3.png"></p><h3 id="1-KVM完整克隆（虚拟机必须为关闭状态）"><a href="#1-KVM完整克隆（虚拟机必须为关闭状态）" class="headerlink" title="1. KVM完整克隆（虚拟机必须为关闭状态）"></a><code>1.</code> KVM完整克隆（虚拟机必须为关闭状态）</h3><p><strong>格式:  virt-clone –auto-c1one -o  虚拟机名称 -n  克隆名称</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">virt-clone --auto-clone -o  web01 -n  web01-clone</span><br><span class="line">virsh list --all</span><br></pre></td></tr></table></figure><p><strong>virt-clone 这个命令是基于全克隆的，也就是拷贝虚拟磁盘文件和虚拟配置文件来实现的完整克隆，速度慢，占用空间多，克隆后磁盘文件位于虚拟机磁盘文件存放处 克隆后虚拟机配置文件位于 /etc/libvirt/qemu 。</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_fba87f13fbf52ded0499e19cf7ba2d85.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_fba87f13fbf52ded0499e19cf7ba2d85.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ff39c0b60324fd6b2061dee1d709a4fc.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ff39c0b60324fd6b2061dee1d709a4fc.png"></p><p><strong>验证克隆后的虚拟机 (成功)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动克隆后的虚拟机 </span></span><br><span class="line">virsh start web01-clone</span><br><span class="line"><span class="comment"># 克隆后的虚拟机和虚拟机是一样的所以可以通过console登录</span></span><br><span class="line">virsh console web01-clone</span><br></pre></td></tr></table></figure><p><strong>此时可以看到IP地址是不一样的 克隆以后我们不需要去手动更改别的例如IP等配置</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_d5eebd88967b1ae72a00a4a5dc1dbf82.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_d5eebd88967b1ae72a00a4a5dc1dbf82.png"></p><h3 id="1-KVM链接克隆（虚拟机必须为关闭状态）"><a href="#1-KVM链接克隆（虚拟机必须为关闭状态）" class="headerlink" title="1. KVM链接克隆（虚拟机必须为关闭状态）"></a><code>1.</code> KVM链接克隆（虚拟机必须为关闭状态）</h3><p>kvm并没有提供链接克隆的命令或工具，只能手动实现，实现方式是通过创建一个磁盘链接文件来实现的链接克隆。<strong>格式:  qemu-img create -f qcow2 -b 源磁盘文件  链接磁盘文件 （磁盘格式需要保持一致）</strong></p><ul><li><strong>-f 指定磁盘文件格式</strong></li><li><strong>-b 指定基于源磁盘文件创建一个链接磁盘文件</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建链接克隆（此时光有磁盘文件我们无法基于这个磁盘文件去创建虚拟机 还得修改磁盘文件配置）</span></span><br><span class="line">qemu-img create -f qcow2 -b /kvm/web02-vda.qcow2 /kvm/web02-1ink-clone-1.qcow2</span><br><span class="line"><span class="comment"># 查看链接磁盘文件信息</span></span><br><span class="line">qemu-img info /kvm/web02-1ink-clone-1.qcow2</span><br></pre></td></tr></table></figure><p>backing file: /kvm/web02-vda.qcow2 （源磁盘文件）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导出原始机的配置文件，并修改磁盘文件路径</span></span><br><span class="line">virsh dumpxml web02 &gt; web02-link-clone-1.xml</span><br><span class="line"><span class="comment"># 需要修改的内容如下</span></span><br><span class="line">vim web02-link-clone-1.xml</span><br><span class="line">...</span><br><span class="line"><span class="comment"># 修改虚拟机名称(修改为克隆后的机器的名称)</span></span><br><span class="line">由 &lt;name&gt;web02&lt;/name&gt; 改 &lt;name&gt;web02-link-clone&lt;/name&gt;</span><br><span class="line"><span class="comment"># 删除uuid（删掉以后启动是会自动生成的）</span></span><br><span class="line">&lt;uuid&gt;0fb934c1-5232-410f-b290-97604f22307e&lt;/uuid&gt;</span><br><span class="line"><span class="comment"># 修改磁盘文件路径及名称</span></span><br><span class="line">由 &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/kvm/web02-vda.qcow2&#x27;</span>/&gt; 改 &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/kvm/web02-1ink-clone-1.qcow2&#x27;</span>/&gt;</span><br><span class="line"><span class="comment"># 删除mac地址（删掉以后启动是会自动生成的）</span></span><br><span class="line">&lt;mac address=<span class="string">&#x27;52:54:00:fb:cb:a4&#x27;</span>/&gt;</span><br><span class="line">...</span><br><span class="line">保存！</span><br><span class="line"><span class="comment"># 导入虚拟机</span></span><br><span class="line">virsh define web02-link-clone-1.xml</span><br><span class="line">virsh list</span><br><span class="line"><span class="comment"># 开启虚拟机</span></span><br><span class="line">virsh start web02-link-clone</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_523d5dd801e9c7ce92e49bc0d6fb1264.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_523d5dd801e9c7ce92e49bc0d6fb1264.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_906abec6cee86807f80f23a43c6ad276.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_906abec6cee86807f80f23a43c6ad276.png"></p><h2 id="七-KVM虚拟机网络配置"><a href="#七-KVM虚拟机网络配置" class="headerlink" title="七. KVM虚拟机网络配置"></a>七. KVM虚拟机网络配置</h2><p><strong>kvm虚拟机网络介绍</strong></p><p><strong>libvirt</strong> 服务安装后，默认会安装一块 <strong>virbr0</strong> 的虚拟网卡，libvirt 在创建 KVM 虚拟机后，默认使用了一个名为default的nat网络，地址段为 192.168.122.0/24，这个网络默认使用virbr0(虚拟交换机)作为桥接接口，为虚拟机提供网络转发服务，默认网段 192.168.122.0/24，使用dnsmasq 来为使用 nat 网络的虚拟机提供 dns 及 dhcp 服务。</p><p><strong>virbr0网卡 默认占用.1这个地址虚拟机地址从 .2 开始配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 52:54:00:28:9c:13 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p><strong>dhcp分配到虚拟机的ip列表在以下文件查看: /var/lib/libvirt/dnsmasq/default.conf （IP地址段可以使用，默认的也可以自行修改）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dhcp分配到虚拟机的ip列表</span></span><br><span class="line"><span class="built_in">cat</span>  /var/lib/libvirt/dnsmasq/default.conf</span><br><span class="line">...</span><br><span class="line"><span class="comment">##WARNING:  THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span></span><br><span class="line"><span class="comment">##OVERWRITTEN AND LOST.  Changes to this configuration should be made using:</span></span><br><span class="line"><span class="comment">##    virsh net-edit default</span></span><br><span class="line"><span class="comment">## or other application using the libvirt API.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## dnsmasq conf file created by libvirt</span></span><br><span class="line">strict-order</span><br><span class="line">pid-file=/var/run/libvirt/network/default.pid</span><br><span class="line">except-interface=lo</span><br><span class="line">bind-dynamic</span><br><span class="line">interface=virbr0                          <span class="comment"># kvm虚拟机使用的网卡</span></span><br><span class="line">dhcp-range=192.168.122.2,192.168.122.254  <span class="comment"># dhcp分配的地址段</span></span><br><span class="line">dhcp-no-override</span><br><span class="line">dhcp-authoritative</span><br><span class="line">dhcp-lease-max=253</span><br><span class="line">dhcp-hostsfile=/var/lib/libvirt/dnsmasq/default.hostsfile</span><br><span class="line">addn-hosts=/var/lib/libvirt/dnsmasq/default.addnhosts</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="1-kvm虚拟机nat网络配置"><a href="#1-kvm虚拟机nat网络配置" class="headerlink" title="1.kvm虚拟机nat网络配置"></a><code>1.</code>kvm虚拟机nat网络配置</h3><p><strong>修改virbr0地址段</strong></p><p><strong>可以修改网段，也可以用默认网段，如需修改通过如下方式:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改地址段 (mac地址不更改 修改如下两段即可)</span></span><br><span class="line">virsh net-edit default</span><br><span class="line">原</span><br><span class="line">...</span><br><span class="line">  &lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line">    &lt;dhcp&gt;</span><br><span class="line">      &lt;range start=<span class="string">&#x27;192.168.122.2&#x27;</span> end=<span class="string">&#x27;192.168.122.254&#x27;</span>/&gt;</span><br><span class="line">...</span><br><span class="line">修改为10地址段</span><br><span class="line">...</span><br><span class="line">  &lt;ip address=<span class="string">&#x27;192.168.10.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line">    &lt;dhcp&gt;</span><br><span class="line">      &lt;range start=<span class="string">&#x27;192.168.10.2&#x27;</span> end=<span class="string">&#x27;192.168.10.254&#x27;</span>/&gt;</span><br><span class="line">...</span><br><span class="line"><span class="comment"># 保存</span></span><br></pre></td></tr></table></figure><p><strong>重新定义网络，default网络的配置文件: /etc/libvirt/qemu/networks/default.xml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用此命令重新定义配置文件 (刷新)</span></span><br><span class="line">virsh net-define /etc/libvirt/qemu/networks/default.xml</span><br><span class="line">//返回</span><br><span class="line">Network default defined from /etc/libvirt/qemu/networks/default.xml</span><br><span class="line"><span class="comment"># 查看是否生效</span></span><br><span class="line"><span class="built_in">cat</span> /etc/libvirt/qemu/networks/default.xml</span><br><span class="line">...</span><br><span class="line">  &lt;ip address=<span class="string">&#x27;192.168.10.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line">    &lt;dhcp&gt;</span><br><span class="line">      &lt;range start=<span class="string">&#x27;192.168.10.2&#x27;</span> end=<span class="string">&#x27;192.168.10.254&#x27;</span>/&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>删除网络（关闭运行的虚拟机）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止网卡（关闭运行的虚拟机）</span></span><br><span class="line">virsh net-destroy default</span><br><span class="line"><span class="comment"># 关闭正在运行的虚拟机（可不关）</span></span><br><span class="line">virsh shutdown web02</span><br></pre></td></tr></table></figure><p><strong>启动网卡</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动网卡</span></span><br><span class="line">virsh net-start default</span><br></pre></td></tr></table></figure><p><strong>重启libvirtd</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启libvirtd</span></span><br><span class="line">systemctl restart libvirtd</span><br></pre></td></tr></table></figure><p><strong>验证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 宿主机执行</span></span><br><span class="line">ip a s</span><br><span class="line"><span class="comment"># 验证虚拟机网络 此时虚拟机网络已变成了10段</span></span><br><span class="line">virsh console web01</span><br><span class="line"><span class="comment"># 获取IP</span></span><br><span class="line">dhclient</span><br><span class="line">// 返回</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 52:54:00:00:75:bf brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.10.39/24 brd 192.168.10.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 3599sec preferred_lft 3599sec</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_257b8884805c43a286817995dfdf648e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_257b8884805c43a286817995dfdf648e.png"></p><p>从现在开始使用的 <strong>default</strong> 网络就是 <strong>10</strong> 段了</p><h3 id="2-kvm-虚拟机配置固定-IP"><a href="#2-kvm-虚拟机配置固定-IP" class="headerlink" title="2.kvm 虚拟机配置固定 IP"></a><code>2.</code>kvm 虚拟机配置固定 IP</h3><p><strong>启动一个KVM并登录并配置固定IP地址</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virsh start web02</span><br><span class="line">virsh console web02</span><br><span class="line">ip a s</span><br></pre></td></tr></table></figure><p><strong>kvm 配置固定 IP 地址（与传统物理机一样修改网卡配置文件就可以了）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none    <span class="comment"># 将默认的dhcp修改为none</span></span><br><span class="line">DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=<span class="built_in">yes</span></span><br><span class="line">IPV6_AUTOCONF=<span class="built_in">yes</span></span><br><span class="line">IPV6_DEFROUTE=<span class="built_in">yes</span></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=eth0</span><br><span class="line">UUID=0d71e612-7fca-4663-914e-9c9f356d0d82</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONBOOT=<span class="built_in">yes</span>       <span class="comment"># 修改为yes</span></span><br><span class="line"><span class="comment"># 新增</span></span><br><span class="line">IPADDR=<span class="string">&quot;192.168.10.10&quot;</span>                                               </span><br><span class="line">GATEWAY=<span class="string">&quot;192.168.10.1&quot;</span>                                        </span><br><span class="line">NETMASK=<span class="string">&quot;255.255.255.0&quot;</span>                                   </span><br><span class="line">DNS1=<span class="string">&quot;223.5.5.5&quot;</span></span><br></pre></td></tr></table></figure><p>修改后重启网卡生效：<strong>systemctl restart network</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_8ff6fe32b5abd9443531f7335d7b120f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_8ff6fe32b5abd9443531f7335d7b120f.png"></p><p>**提示:  **<strong>KVM</strong> 虚拟机访问外部网络记住 <a href="https://wn-apple-teawine.fun/2023/06/02/%E9%85%8D%E7%BD%AEsnat%E4%BD%BF%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AEinternet%E7%9A%84%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E9%80%9A%E8%BF%87%E5%85%B6%E4%BB%96%E6%9C%BA%E5%99%A8%E5%87%BA%E5%A4%96%E7%BD%91/?highlight=snat">iptables SNAT</a> 模式进行了源地址转换，如果外部网络需要访问到 <strong>KVM</strong> 虚拟机中，需要在宿主机通过 <strong>iptables</strong> 添加端口映射来实现，如果不希望通过端口映射来实现，可以使用 <strong>KVM的桥接网络</strong> 更加方便。</p><h2 id="九-kvm-创建桥接网络"><a href="#九-kvm-创建桥接网络" class="headerlink" title="九. kvm 创建桥接网络"></a>九. kvm 创建桥接网络</h2><p><strong>在KVM虚拟机中，Bridge(桥接)模式可以让 KVM 虚拟机和宿主机共享一个物理网络设备来连接网络，这样 KVM 虚拟机可以访问外部网络，而外部网络也可以直接访问 KVM 虚拟机，Bridge桥接模式使用非常方便，应用也非常广泛。</strong></p><p><strong>创建桥接网卡（执行创建后需要重启系统才能看到）</strong> 将宿主机工作的网卡绑定到 br0 桥接网卡上 (br0现在不存在)</p><ul><li><strong>格式: virsh iface-bridge ens32 br0</strong></li><li><strong>ens33 为宿主机网卡</strong></li><li><strong>br0 为桥接网卡</strong></li></ul><h3 id="1-创建桥接网卡"><a href="#1-创建桥接网卡" class="headerlink" title="1.创建桥接网卡"></a><code>1.</code>创建桥接网卡</h3><blockquote><p><a href="http://sunlight.zznnwn.cloudns.biz/2024/02/19/openstack%E4%B8%8A%E4%BD%BF%E7%94%A8windows%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C/?highlight=%E9%95%9C%E5%83%8F">实现形式其实在博主另一篇文章中已有提及 | &gt; 链接</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将宿主机工作的网卡绑定到 br0 桥接网卡</span></span><br><span class="line">virsh iface-bridge ens33 br0</span><br><span class="line">//返回</span><br><span class="line">使用附加设备 br0 生成桥接 ens32 失败</span><br><span class="line"><span class="comment"># 重启系统后登录查看网卡</span></span><br><span class="line">ip a s </span><br><span class="line">...</span><br><span class="line">ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master br0 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:23:67:1e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:23:67:1e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.10/8 brd 10.255.255.255 scope global br0</span><br><span class="line">...</span><br><span class="line"><span class="comment"># 此时ping不通百度</span></span><br><span class="line">ping www.baidu.com</span><br><span class="line"><span class="comment"># 解决网卡添加DNS即可</span></span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-br0</span><br><span class="line">...</span><br><span class="line">DEVICE=<span class="string">&quot;br0&quot;</span></span><br><span class="line">ONBOOT=<span class="string">&quot;yes&quot;</span></span><br><span class="line">TYPE=<span class="string">&quot;Bridge&quot;</span></span><br><span class="line">BOOTPROTO=<span class="string">&quot;none&quot;</span></span><br><span class="line">IPADDR=<span class="string">&quot;10.0.0.10&quot;</span></span><br><span class="line">GATEWAY=<span class="string">&quot;10.0.0.220&quot;</span></span><br><span class="line">IPV6INIT=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV6_AUTOCONF=<span class="string">&quot;yes&quot;</span></span><br><span class="line">DHCPV6C=<span class="string">&quot;no&quot;</span></span><br><span class="line">STP=<span class="string">&quot;on&quot;</span></span><br><span class="line">DELAY=<span class="string">&quot;0&quot;</span></span><br><span class="line">DNS1=<span class="string">&quot;223.5.5.5&quot;</span>  <span class="comment"># 添加此</span></span><br><span class="line">....</span><br><span class="line"><span class="comment"># 生效</span></span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure><p><strong>备注：此时宿主机 ens33 网卡没有自己的 IP 地址，网卡寄生在它身上，网桥与物理网口 MAC 地址相同</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_9376b88c60933a7b09a87ec71a768aff.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_9376b88c60933a7b09a87ec71a768aff.png"></p><h2 id="十-创建-kvm-虚拟机使用桥接网络"><a href="#十-创建-kvm-虚拟机使用桥接网络" class="headerlink" title="十. 创建 kvm 虚拟机使用桥接网络"></a>十. 创建 <code>kvm</code> 虚拟机使用桥接网络</h2><p><strong>创建 kvm 虚拟机使用桥接网卡（安装完成系统）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 kvm 虚拟机使用桥接网卡</span></span><br><span class="line">virt-install --virt-type kvm \</span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant rhel7 \</span><br><span class="line">--name web03 \</span><br><span class="line">--memory 1024 \</span><br><span class="line">--vcpus 1 --disk /kvm/web03-vda.qcow2,format=qcow2,size=10 --cdrom /opt/CentOS-7-x86_64-Minimal-2009.iso \</span><br><span class="line">--network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole </span><br><span class="line"><span class="comment"># 查看列表</span></span><br><span class="line">virsh list</span><br><span class="line"><span class="comment"># 查看vnc端口（5902）</span></span><br><span class="line">virsh vncdisplay web03</span><br><span class="line">:2</span><br></pre></td></tr></table></figure><p><strong>配置静态地址 地址为与宿主机同一个网段 且没有被占用的网段</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_288e666dc41e472b5b532cc4fd38d635.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_288e666dc41e472b5b532cc4fd38d635.png"></p><p><strong>验证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 等待相当一段时间</span></span><br><span class="line">virsh start web03</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">virsh list</span><br><span class="line"><span class="comment"># 远程连接测试（可连通外网正常ping通百度）</span></span><br><span class="line">ssh -p22 root@10.0.0.185</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ccce45df3c03202f8b55bc31adb1b817.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ccce45df3c03202f8b55bc31adb1b817.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_52de4dfd8d24e6c18177342d745e60f6.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_52de4dfd8d24e6c18177342d745e60f6.png"></p><h2 id="十一-修改kvm虚拟机使用桥接模式"><a href="#十一-修改kvm虚拟机使用桥接模式" class="headerlink" title="十一. 修改kvm虚拟机使用桥接模式"></a>十一. 修改<code>kvm</code>虚拟机使用桥接模式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">virsh list</span><br></pre></td></tr></table></figure><p><strong>查看虚拟机网卡信息</strong> <strong>格式: virsh  domiflist 虚拟机名称</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看虚拟机web03网卡</span></span><br><span class="line">virsh domiflist web03</span><br><span class="line">//返回</span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet0      bridge     br0        virtio      52:54:00:68:3e:8d</span><br></pre></td></tr></table></figure><p><strong>关机状态下</strong> 修改网络模式为 <strong>bridge</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改虚拟机配置</span></span><br><span class="line">virsh edit web02</span><br><span class="line"></span><br><span class="line">原 &lt;interface <span class="built_in">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;  改 &lt;interface <span class="built_in">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;  <span class="comment"># 修改类型</span></span><br><span class="line">原 &lt;<span class="built_in">source</span> network=<span class="string">&#x27;default&#x27;</span>/&gt; 改 &lt;<span class="built_in">source</span> bridge=<span class="string">&#x27;br0&#x27;</span>/&gt;     <span class="comment"># 网卡名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动虚拟机验证</span></span><br><span class="line">virsh start web02</span><br><span class="line"><span class="comment"># 通过vnc/console登录配置静态IP</span></span><br><span class="line">virsh vncdisplay web02 或 virsh console web02</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_4f21ccb77b8d5dd6719b7488e808320c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_4f21ccb77b8d5dd6719b7488e808320c.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_0e88cdc4e62769bb5458975545f4269e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_0e88cdc4e62769bb5458975545f4269e.png"></p><p>配置完成后 <strong>ssh</strong> 远程连接测试 &gt;&gt; 成功。</p><h2 id="十二-kvm网络原理"><a href="#十二-kvm网络原理" class="headerlink" title="十二. kvm网络原理"></a>十二. <code>kvm</code>网络原理</h2><p>每台 <strong>KVM</strong> 启动后，都会在 <strong>宿主机</strong> 创建一个以 <strong>vnet</strong> 开头的网卡(从 <strong>vnet0</strong> 开始)，用于打通 <strong>虚拟机</strong> 与 <strong>宿主机</strong> 之间的网络。</p><h3 id="0-网络模式拖布图"><a href="#0-网络模式拖布图" class="headerlink" title="0.网络模式拖布图"></a><code>0.</code>网络模式拖布图</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_502c79bc51c37605ad93625e7c73b987.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_502c79bc51c37605ad93625e7c73b987.png"></p><h3 id="1-宿主机网卡配置"><a href="#1-宿主机网卡配置" class="headerlink" title="1.宿主机网卡配置"></a><code>1.</code>宿主机网卡配置</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_7e62f395165b9a771a1f429a170a2cc0.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_7e62f395165b9a771a1f429a170a2cc0.png"></p><p>通过 <strong>brctl show</strong> 可以看到 <strong>vnet</strong> 网卡使用的宿主机网卡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# brctl show</span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">br0             8000.000c2923671e       yes             ens33</span><br><span class="line">                                                        vnet0</span><br><span class="line">virbr0          8000.525400289c13       yes             virbr0-nic</span><br></pre></td></tr></table></figure><h2 id="十三-kvm虚拟机硬件热添加技术"><a href="#十三-kvm虚拟机硬件热添加技术" class="headerlink" title="十三.  kvm虚拟机硬件热添加技术"></a>十三.  kvm虚拟机硬件热添加技术</h2><h3 id="1-热添加磁盘"><a href="#1-热添加磁盘" class="headerlink" title="1.热添加磁盘"></a><code>1.</code>热添加磁盘</h3><p><strong>案例: 为 web03 虚拟机添加一块新 qcow2 硬盘，并对硬盘空间进行扩容 (KVM虚拟机默认磁盘名称: vda、vdb、vdc依次类推，可进入KVM内部查看)</strong></p><p><strong>添加之前 (只有一块10G的硬盘)</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@web03 ~]# lsblk</span><br><span class="line">NAME                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sr0                    11:0    1 1024M  0 rom  </span><br><span class="line">vda                   252:0    0   10G  0 disk </span><br><span class="line">├─vda1                252:1    0    1G  0 part /boot</span><br><span class="line">└─vda2                252:2    0    9G  0 part </span><br><span class="line">  ├─centos_web03-root 253:0    0    8G  0 lvm  /</span><br><span class="line">  └─centos_web03-swap 253:1    0    1G  0 lvm  [SWAP]</span><br></pre></td></tr></table></figure><p><strong>在 kvm 目录创建一块 qcow2 格式的虚拟硬盘，容量为 10G</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一块qcow2格式的虚拟硬盘，容量为10G</span></span><br><span class="line">cd /kvm</span><br><span class="line">qemu-img create -f qcow2 /kvm/web03-vdb.qcow2 10G</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看磁盘详情</span></span><br><span class="line">qemu-img info /kvm/web03-vdb.qcow2</span><br><span class="line">//返回</span><br><span class="line">image: /kvm/web03-vdb.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 10G (10737418240 bytes)</span><br></pre></td></tr></table></figure><p><strong>永久添加磁盘</strong></p><ul><li><strong>–live            在线添加</strong></li><li><strong>–config        永久保存配置 （不加临时生效 虚拟机一重启就没了）</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 永久添加磁盘（给web03 添加10G磁盘 指定添加后虚拟机磁盘名称为 vdb 格式为 qcow2 格式）</span></span><br><span class="line">virsh attach-disk web03 /kvm/web03-vdb.qcow2 vdb --subdriver qcow2 --live --config</span><br><span class="line">//返回</span><br><span class="line">Disk attached successfully</span><br></pre></td></tr></table></figure><p><strong>web03虚拟机验证</strong>（成功添加一块10G vdb磁盘）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录虚拟机</span></span><br><span class="line">virsh console web03</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看磁盘详情</span></span><br><span class="line">lsblk</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">格式化挂载验证使用(正常使用)</span></span><br><span class="line">mkfs.xfs /dev/vdb /mnt</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_df1d528276047646321dc497bb964d7c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_df1d528276047646321dc497bb964d7c.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_98ea2a719d22c44088b0687abc0ff47e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_98ea2a719d22c44088b0687abc0ff47e.png"></p><p><strong>永久剥离 (需要提前卸载)</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">虚拟机先卸载磁盘</span></span><br><span class="line">umonut /dev/vdb</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 宿主机执行操作 永久剥离虚拟机磁盘</span></span><br><span class="line">virsh detach-disk web03 vdb --live --config</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">虚拟机查看（成功）</span></span><br><span class="line">lsblk</span><br><span class="line">//返回</span><br><span class="line">NAME                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sr0                    11:0    1 1024M  0 rom  </span><br><span class="line">vda                   252:0    0   10G  0 disk </span><br><span class="line">├─vda1                252:1    0    1G  0 part /boot</span><br><span class="line">└─vda2                252:2    0    9G  0 part </span><br><span class="line">  ├─centos_web03-root 253:0    0    8G  0 lvm  /</span><br><span class="line">  └─centos_web03-swap 253:1    0    1G  0 lvm  [SWAP]</span><br></pre></td></tr></table></figure><h3 id="2-对刚才剥离的qcow2磁盘空间扩容-无法在线扩容，必须先剥离"><a href="#2-对刚才剥离的qcow2磁盘空间扩容-无法在线扩容，必须先剥离" class="headerlink" title="2. 对刚才剥离的qcow2磁盘空间扩容 (无法在线扩容，必须先剥离)"></a><code>2.</code> 对刚才剥离的qcow2磁盘空间扩容 (无法在线扩容，必须先剥离)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给创建的磁盘扩容5G</span></span><br><span class="line">qemu-img resize /kvm/web03-vdb.qcow2 +5G</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看扩容详情</span></span><br><span class="line">qemu-img info /kvm/web03-vdb.qcow2</span><br><span class="line">//返回</span><br><span class="line">image: /kvm/web03-vdb.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 15G (16106127360 bytes)</span><br></pre></td></tr></table></figure><p><strong>添加磁盘到虚拟机（宿主机执行）</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久添加磁盘（给web03 添加10G磁盘 指定添加后虚拟机磁盘名称为 vdb 格式为 qcow2 格式）</span></span><br><span class="line">virsh attach-disk web03 /kvm/web03-vdb.qcow2 vdb --subdriver qcow2 --live --config</span><br><span class="line">//返回</span><br><span class="line">Disk attached successfully</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">挂载验证（先前已经格式化过磁盘 此时切记不能再格式化 否则会导致数据丢失）</span> </span><br><span class="line">[root@web03 ~]# mount /dev/vdb /mnt</span><br><span class="line">[root@web03 ~]# cd /mnt</span><br><span class="line">[root@web03 mnt]# ls</span><br><span class="line">1.ttx</span><br><span class="line">[root@web03 mnt]# </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">刷新到<span class="built_in">df</span> -Th</span></span><br><span class="line">xfs_growfs /mnt</span><br><span class="line">//返回</span><br><span class="line">meta-data=/dev/vdb               isize=512    agcount=4, agsize=655360 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=0 spinodes=0</span><br><span class="line">data     =                       bsize=4096   blocks=2621440, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line">log      =internal               bsize=4096   blocks=2560, version=2</span><br><span class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure><p><strong>先前已经格式化过磁盘 此时切记不能再格式化 否则会导致数据丢失。</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_05199bb86394af821c0bc709165683a0.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_05199bb86394af821c0bc709165683a0.png"></p><h2 id="十四-热添加网卡"><a href="#十四-热添加网卡" class="headerlink" title="十四. 热添加网卡"></a>十四. 热添加网卡</h2><h3 id="1-热添加网卡"><a href="#1-热添加网卡" class="headerlink" title="1.热添加网卡"></a><code>1.</code>热添加网卡</h3><p><strong>案例: 为KVM虚拟机 web03 添加一块网卡</strong></p><p><strong>格式:  virsh attach-interface   虚拟机名称  –type bridge–source  网桥名  –model  virtio</strong></p><ul><li><strong>–type              用于指定网卡类型</strong></li><li><strong>–source          宿主机网桥名</strong></li><li><strong>–model virtio   驱动模式(用于指定网卡类型以eth开头)</strong></li><li><strong>–live              在线添加</strong></li><li><strong>–config          永久保存配置(不加临时生效)</strong></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给 web03 热添加一块bridge类型网卡</span></span><br><span class="line">virsh attach-interface web03 --type bridge  --source br0 --model virtio --live --config</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给 web03 热添加一块nat类型网卡 (只有一块网卡模式时 --<span class="built_in">source</span>需要是ens33)</span></span><br><span class="line">virsh attach-interface web03 --type default --source br0 --model virtio --live --config</span><br></pre></td></tr></table></figure><p><strong>虚拟机验证：</strong> <code>ip a s</code> 成功添加了一块 <strong>eth1</strong> 网卡 并且网卡自动获取为10.0.0.186</p><p>若要 配置成固定地址时需要新建一个网卡配置文件 配置 IP  或者使用 nmtui 设置网卡</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_d11dedc5313b8c669b47717ebb3752a8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_d11dedc5313b8c669b47717ebb3752a8.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_bb39dccafdd291a95d611dfe61554255.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_bb39dccafdd291a95d611dfe61554255.png"></p><p><strong>网卡不想要了怎么办呢 热删除即可。</strong></p><h3 id="2-热删除虚拟机网卡（宿主机执行）"><a href="#2-热删除虚拟机网卡（宿主机执行）" class="headerlink" title="2.热删除虚拟机网卡（宿主机执行）"></a><code>2.</code>热删除虚拟机网卡（宿主机执行）</h3><ul><li><strong>–mac +通过mac地址删除 （指定网卡mac地址删除）</strong></li><li><strong>虚拟机使用 ip a / ifconfig 查看，mac地址</strong></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">热删除虚拟机 web03 网卡 (成功剥离)</span></span><br><span class="line">virsh detach-interface web03 --type bridge --mac 52:54:00:c8:3e:2a --live --config</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_1e84857802829a410b17411183904d57.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_1e84857802829a410b17411183904d57.png"></p><h3 id="十五-热添加内存"><a href="#十五-热添加内存" class="headerlink" title="十五. 热添加内存"></a>十五. 热添加内存</h3><h3 id="1-创建时指定cpu-内存最大数量"><a href="#1-创建时指定cpu-内存最大数量" class="headerlink" title="1.创建时指定cpu 内存最大数量"></a><code>1.</code>创建时指定cpu 内存最大数量</h3><p><strong>热添加内存与CPU  前提是创建KVM虚拟机时设置maxmemory与maxvcpus参数 也可创建完成后通过命令定义</strong></p><ul><li><strong>maxmemory    定义虚机最大可以分配内存的大小</strong></li><li><strong>maxvcpus        定义虚拟机最大可以使用的CPU核数</strong></li></ul><p><strong>创建KVM虚拟机，并设置maxmemory与maxvcpus的值</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建虚拟机</span></span><br><span class="line">virt-install --virt-type kvm \</span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant rhel7 \</span><br><span class="line">--name web04 \</span><br><span class="line">--memory 1024,maxmemory=2048 \</span><br><span class="line">--vcpus 1,maxvcpus=4 --disk /kvm/web04-vda.qcow2,format=qcow2,size=10 \</span><br><span class="line">--cdrom /opt/CentOS-7-x86_64-Minimal-2009.iso --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole </span><br></pre></td></tr></table></figure><h3 id="2-创建后通过命令指定-cpu-内存最大数量"><a href="#2-创建后通过命令指定-cpu-内存最大数量" class="headerlink" title="2.创建后通过命令指定 cpu 内存最大数量"></a><code>2.</code>创建后通过命令指定 cpu 内存最大数量</h3><blockquote><p><strong>命令创建时没有指定最大内存 则需要先设置一下最大内存 否则无法添加</strong></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置最大内存，需要关机</span></span><br><span class="line">virsh shutdown  web03</span><br><span class="line">virsh setmaxmem web03 6144M --config  </span><br><span class="line">// 默认无回显</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时添加内存，缩减内存同样，需要注意的是不要缩减内存 会导致机器出现问题</span></span><br><span class="line">virsh setmem web03 4096M </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久添加内存</span></span><br><span class="line">virsh setmem web03 4096M --config  </span><br></pre></td></tr></table></figure><p><strong>验证</strong>（添加成功）</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_e5eb9315664b827df6013961c3b6b4d2.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_e5eb9315664b827df6013961c3b6b4d2.png"></p><h2 id="十六-热添加cpu"><a href="#十六-热添加cpu" class="headerlink" title="十六. 热添加cpu"></a>十六. 热添加<code>cpu</code></h2><h3 id="1-创建虚拟机时指定-CPU-最大数时-热添加CPU"><a href="#1-创建虚拟机时指定-CPU-最大数时-热添加CPU" class="headerlink" title="1. 创建虚拟机时指定 CPU 最大数时 热添加CPU"></a><code>1.</code> 创建虚拟机时指定 <strong>CPU</strong> 最大数时 热添加<code>CPU</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时热添加cpu核数</span></span><br><span class="line">virsh setvcpus web03 4 --live</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久添加cpu核数</span></span><br><span class="line">virsh setvcpus web03 4 --config</span><br></pre></td></tr></table></figure><h3 id="2-创建完成后热添加虚拟机CPU（需要关机-且设置的-CPU-最大数不能超过宿主机-CPU-数）"><a href="#2-创建完成后热添加虚拟机CPU（需要关机-且设置的-CPU-最大数不能超过宿主机-CPU-数）" class="headerlink" title="2. 创建完成后热添加虚拟机CPU（需要关机 且设置的 CPU 最大数不能超过宿主机  CPU  数）"></a><code>2.</code> 创建完成后热添加虚拟机CPU（需要关机 且设置的 CPU 最大数不能超过宿主机  CPU  数）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看虚拟机当前最大支持的核心数</span></span><br><span class="line">virsh edit web03</span><br><span class="line">...</span><br><span class="line">//返回</span><br><span class="line">  &lt;memory unit=&#x27;KiB&#x27;&gt;2097152&lt;/memory&gt;</span><br><span class="line">  &lt;currentMemory unit=&#x27;KiB&#x27;&gt;2097152&lt;/currentMemory&gt;</span><br><span class="line">  &lt;vcpu placement=&#x27;static&#x27;&gt;1&lt;/vcpu&gt;   # 1cpu</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">调整虚拟机支持CPU的最大值</span></span><br><span class="line">virsh setvcpus web03 --maximum 6 --config </span><br><span class="line">...</span><br><span class="line">否则会报错</span><br><span class="line">virsh setvcpus web03  4 --config</span><br><span class="line">error: invalid argument: requested vcpus is greater than max allowable vcpus for the persistent domain: 4 &gt; 1</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用命令调整后 查看文件是否改变 (文件成功改变)</span></span><br><span class="line">virsh edit web03</span><br><span class="line">...</span><br><span class="line">  &lt;currentMemory unit=&#x27;KiB&#x27;&gt;2097152&lt;/currentMemory&gt;</span><br><span class="line">  &lt;vcpu placement=&#x27;static&#x27; current=&#x27;1&#x27;&gt;6&lt;/vcpu&gt;  # 6cpu</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动虚拟机查看配置</span></span><br><span class="line">virsh start web03</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时热添加CPU核心数量</span></span><br><span class="line">virsh setvcpus web03 4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久添加CPU核心数量</span></span><br><span class="line">virsh setvcpus web03 4 --config</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_229143f829ebe75863789362572c1acf.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_229143f829ebe75863789362572c1acf.png"></p><p><strong>本文热添加内存及cpu部分参考如下链接</strong></p><p><a href="https://www.cnblogs.com/yinzhengjie/p/18127842">https://www.cnblogs.com/yinzhengjie/p/18127842</a> <a href="https://blog.csdn.net/m0_46180357/article/details/108935979">https://blog.csdn.net/m0_46180357/article/details/108935979</a></p>]]></content>
      
      
      <categories>
          
          <category> kvm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows11安装docker-desktop,docker-compose</title>
      <link href="/2024/04/20/windows11%E5%AE%89%E8%A3%85docker-desktop,docker-compose/"/>
      <url>/2024/04/20/windows11%E5%AE%89%E8%A3%85docker-desktop,docker-compose/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="windows11安装docker-desktop-docker-compose"><a href="#windows11安装docker-desktop-docker-compose" class="headerlink" title="windows11安装docker-desktop,docker-compose"></a>windows11安装docker-desktop,docker-compose</h1><blockquote><p>备注：docker-desktop 无法与 vmware 的虚拟化 Inter-VT-x/EPT或AMD-V/RVI(V) 共存 使用此功能时需要先短暂关闭 Hyper-V 服务并重启电脑 CMD 命令如下 需要使用docker-desktop 时再开启并重启电脑即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">bcdedit /set hypervisorlaunchtype off </span><br><span class="line"><span class="comment"># 启动 </span></span><br><span class="line">bcdedit /set hypervisorlaunchtype auto</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_118aa809b6e7db0a2c34c57eb7d08ecf.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_118aa809b6e7db0a2c34c57eb7d08ecf.png"></p><p>参考：<a href="https://blog.csdn.net/CNjcdyl/article/details/124802614">解决虚拟机VM-开启 虚拟化 Intel-VT-x/EPT 或 AMD-V/RVI（V） 后 电脑蓝屏重启 或显示此平台不支持虚拟化的问题 （Win10）_虚拟化inteltv-xept或amd-vrvi-</a></p></blockquote><h1 id="一、安装顺序"><a href="#一、安装顺序" class="headerlink" title="一、安装顺序"></a>一、安装顺序</h1><p><a href="https://blog.csdn.net/qq_41644183/article/details/132305487#%E4%BA%8C%E3%80%81%E5%AE%89%E8%A3%85Hyper-V">安装Hyper-V</a></p><p><a href="https://blog.csdn.net/qq_41644183/article/details/132305487#%E4%B8%89%E3%80%81%E5%AE%89%E8%A3%85WSL">安装WSL</a></p><p><a href="https://blog.csdn.net/qq_41644183/article/details/132305487#%E5%9B%9B%E3%80%81%E5%AE%89%E8%A3%85Docker%20Desktop">安装Docker Desktop</a></p><p><a href="https://link.zhihu.com/?target=https://desktop.docker.com/win/main/amd64/Docker%2520Desktop%2520Installer.exe">Docker-windows-app下载链接</a></p><h1 id="二、安装Hyper-V"><a href="#二、安装Hyper-V" class="headerlink" title="二、安装Hyper-V"></a>二、安装Hyper-V</h1><p>1、Windows11是找不到<a href="https://so.csdn.net/so/search?q=Hyper-V&spm=1001.2101.3001.7020">Hyper-V</a>的，需要自行安装</p><p>2、创建一个hyper.bat文件，编辑，复制以下代码到文件中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pushd</span> <span class="string">&quot;%~dp0&quot;</span></span><br><span class="line"><span class="built_in">dir</span> /b %SystemRoot%\servicing\Packages\*Hyper-V*.mum &gt;hyper-v.txt</span><br><span class="line"><span class="keyword">for</span> /f %%i <span class="keyword">in</span> (<span class="string">&#x27;findstr /i . hyper-v.txt 2^&gt;nul&#x27;</span>) <span class="keyword">do</span> dism /online /norestart /add-package:<span class="string">&quot;%SystemRoot%\servicing\Packages\%%i&quot;</span></span><br><span class="line">del hyper-v.txt</span><br><span class="line">Dism /online /enable-feature /featurename:Microsoft-Hyper-V-All /LimitAccess /ALL</span><br></pre></td></tr></table></figure><p>3、以管理员身份运行hyper.bat，运行了之后需要按Ctrl+C停下来，否则会一直重复执行，最后输入Y，确认完成Hyper-V的安装<br>4、打开控制面板-&gt;程序-&gt;启用或关闭Windows功能勾选Hyper-V，同时勾选适用于Linux的Windows子系统以及虚拟机平台，重启电脑（可以等安装WSL的时候再重启）<br><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_c56711b4323471003c3a8ea0d960d131.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_c56711b4323471003c3a8ea0d960d131.png"></p><h1 id="三、安装WSL"><a href="#三、安装WSL" class="headerlink" title="三、安装WSL"></a>三、安装WSL</h1><p>1、以管理员身份打开PowerShell，输入命令安装WSL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All</span><br></pre></td></tr></table></figure><p>2、完成，重启电脑，完成安装</p><p>3、如果WSL版本太低，升级WSL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl.exe --update</span><br></pre></td></tr></table></figure><h1 id="四、安装Docker-Desktop"><a href="#四、安装Docker-Desktop" class="headerlink" title="四、安装Docker Desktop"></a>四、安装Docker Desktop</h1><p>1、<a href="https://desktop.docker.com/win/main/amd64/Docker%20Desktop%20Installer.exe">下载Docker Desktop</a></p><p>效果</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_0c8aeee17bdfc44342ee2537961ade9c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_0c8aeee17bdfc44342ee2537961ade9c.png"></p><h1 id="五-安装docker-compose"><a href="#五-安装docker-compose" class="headerlink" title="五. 安装docker-compose"></a>五. 安装docker-compose</h1><p>下载地址：<a href="https://github.com/docker/compose/releases/">https://github.com/docker/compose</a></p><p>参考：</p><p><a href="https://blog.csdn.net/qq_41644183/article/details/132305487">Docker安装教程——以Windows11家庭中文版为例_win11家庭版安装docker</a></p><p><a href="https://zhuanlan.zhihu.com/p/552307629">Win11安装Docker及简单使用 - 知乎 (zhihu.com)</a></p><p><a href="https://blog.csdn.net/qq_38215042/article/details/108647680">Windows安装使用docker与docker-compose_windows下安装compose-CSDN博客</a></p>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>confluence部署</title>
      <link href="/2024/04/17/confluence%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/04/17/confluence%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="confluence部署"><a href="#confluence部署" class="headerlink" title="confluence部署"></a>confluence部署</h1><h1 id="一-安装java-1-8"><a href="#一-安装java-1-8" class="headerlink" title="一. 安装java 1.8"></a>一. 安装java 1.8</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install software-properties-common</span><br><span class="line">apt-get install openjdk-8-jdk</span><br></pre></td></tr></table></figure><h1 id="二-部署mysql5-7本次我们使用docker部署"><a href="#二-部署mysql5-7本次我们使用docker部署" class="headerlink" title="二. 部署mysql5.7本次我们使用docker部署"></a>二. 部署mysql5.7本次我们使用docker部署</h1><blockquote><p>特别说明（本文已写入docker-compose文件中）</p><p>一定要设置数据库隔离级别 <code>SET GLOBAL tx_isolation=&#39;READ-COMMITTED&#39;; </code>否则会导致confluence连不上数据库</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.0&quot;</span>                                                                                                                                                 </span><br><span class="line">services:                                                                                                                                                      </span><br><span class="line">  db:                                                                                                                                                          </span><br><span class="line">    image: mysql:5.7                                                                                                                                           </span><br><span class="line">    container_name: confluse_mysql                                                                                                                             </span><br><span class="line">    hostname: db                                                                                                                                               </span><br><span class="line">    restart: always                                                                                                                                            </span><br><span class="line">    ports:                                                                                                                                                     </span><br><span class="line">      - <span class="string">&quot;3307:3306&quot;</span>                                                                                                                                            </span><br><span class="line">    <span class="built_in">command</span>:                                                                                                                                                   </span><br><span class="line">      - mysqld                                                                                                                                                 </span><br><span class="line">      - --symbolic-links=0                                                                                                                                     </span><br><span class="line">      - --transaction-isolation=READ-COMMITTED                                                                                                                 </span><br><span class="line">      - --collation_server=utf8_bin                                                                                                                            </span><br><span class="line">      - --character-set-server=utf8                                                                                                                            </span><br><span class="line">      - --innodb_file_per_table=1                                                                                                                              </span><br><span class="line">      - --innodb_buffer_pool_size=2G                                                                                                                           </span><br><span class="line">      - --max_connections=1000                                                                                                                                 </span><br><span class="line">      - --innodb_flush_log_at_trx_commit=2                                                                                                                     </span><br><span class="line">      - --innodb_read_io_threads=32                                                                                                                            </span><br><span class="line">      - --innodb_write_io_threads=16                                                                                                                           </span><br><span class="line">      - --max_allowed_packet=32M                                                                                                                               </span><br><span class="line">      - --max_heap_table_size=512M                                                                                                                             </span><br><span class="line">      - --bulk_insert_buffer_size=64M                                                                                                                          </span><br><span class="line">      - --tmp_table_size=64M                                                                                                                                   </span><br><span class="line">      - --join_buffer_size=64M                                                                                                                                 </span><br><span class="line">      - --max_allowed_packet=34M                                                                                                                               </span><br><span class="line">      - --innodb_log_file_size=256M                                                                                                                            </span><br><span class="line">    environment:                                                                                                                                               </span><br><span class="line">      - MYSQL_ROOT_PASSWORD=<span class="built_in">test</span>                                                                                                                     </span><br><span class="line">      - MYSQL_DATABASE=confluence_test                                                                                                                         </span><br><span class="line">      - MYSQL_DATABASE=confluence                                                                                                                              </span><br><span class="line">      - MYSQL_USER=confluence                                                                                                                                  </span><br><span class="line">      - MYSQL_PASSWORD=<span class="built_in">test</span>                                                                                                                                  </span><br><span class="line">      - TZ=Asia/Shanghai                                                                                                                                       </span><br><span class="line">    volumes:                                                                                                                                                   </span><br><span class="line">      - confluse-db:/var/lib/mysql                                                                                                                             </span><br><span class="line">      - ./db_bak_sh:/home/db_bak_sh:rw                                                                                                                         </span><br><span class="line">      - ./bak:/opt/confluence_mysql/bak:rw                                                                                                                     </span><br><span class="line">volumes:                                                                                                                                                       </span><br><span class="line">  confluse-db:</span><br></pre></td></tr></table></figure><p>mysql备份脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash                                                                                                                                                          </span></span><br><span class="line"><span class="comment">#mysqlbak_version:1.3                                                                                                                                                </span></span><br><span class="line"><span class="comment">#标准换数据库备份脚本                                                                                                                                                </span></span><br><span class="line"><span class="built_in">set</span> -e                                                                                                                                                               </span><br><span class="line"><span class="function"><span class="title">bak_mysql</span></span>()&#123;                                                                                                                                                         </span><br><span class="line">   bak_name=<span class="string">&quot;confluence&quot;</span>                                                                                                                                             </span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;\033[33m 开始备份数据库:<span class="variable">$&#123;bak_name&#125;</span> \033[0m&quot;</span>                                                                                                                </span><br><span class="line">   bak_dir=<span class="string">&quot;/opt/confluence_mysql/bak&quot;</span>                                                                                                                               </span><br><span class="line">   time=`<span class="built_in">date</span> +%F_%H_%M`                                                                                                                                             </span><br><span class="line">   port_bak=3306                                                                                                                                                     </span><br><span class="line">   user_bak=<span class="string">&quot;root&quot;</span>                                                                                                                                                   </span><br><span class="line">   passwd_bak=<span class="string">&quot;test&quot;</span>                                                                                                                                       </span><br><span class="line">   ip_bak=localhost                                                                                                                                                  </span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$&#123;bak_dir&#125;</span> ];                                                                                                                                              </span><br><span class="line">   <span class="keyword">then</span>                                                                                                                                                              </span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;\033[33m 开始创建目录:<span class="variable">$&#123;bak_dir&#125;</span> \033[0m&quot;</span>                                                                                                               </span><br><span class="line">       <span class="built_in">mkdir</span> -p  <span class="variable">$&#123;bak_dir&#125;</span> &amp;&amp; <span class="built_in">chmod</span> 755 <span class="variable">$&#123;bak_dir&#125;</span>                                                                                                                  </span><br><span class="line">   <span class="keyword">else</span>                                                                                                                                                              </span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;\033[36m <span class="variable">$&#123;bak_dir&#125;</span>目录已存在  \033[0m&quot;</span>                                                                                                                 </span><br><span class="line"><span class="keyword">fi</span>                                                                                                                                                                   </span><br><span class="line">mysqldump -P<span class="variable">$&#123;port_bak&#125;</span> -p<span class="variable">$&#123;passwd_bak&#125;</span> -u<span class="variable">$&#123;user_bak&#125;</span> -h<span class="variable">$&#123;ip_bak&#125;</span> --single-transaction -R -E -B <span class="variable">$&#123;bak_name&#125;</span> |gzip &gt;<span class="variable">$&#123;bak_dir&#125;</span>/<span class="variable">$&#123;bak_name&#125;</span>_<span class="variable">$&#123;ip_bak&#125;</span>_<span class="variable">$&#123;time&#125;</span>.sql.gz   </span><br><span class="line">bak_file=<span class="string">&quot;/opt/confluence_mysql/bak/*.sql.gz&quot;</span>                                                                                                                        </span><br><span class="line"><span class="keyword">if</span> [ $? = 0 ];                                                                                                                                                       </span><br><span class="line">   <span class="keyword">then</span>                                                                                                                                                              </span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;\033[36m  <span class="variable">$&#123;time&#125;</span>数据库:<span class="variable">$&#123;bak_name&#125;</span>备份成功,                                                                                                            </span></span><br><span class="line"><span class="string">                备份位置:<span class="variable">$&#123;bak_dir&#125;</span>/<span class="variable">$&#123;bak_name&#125;</span>_<span class="variable">$&#123;ip_bak&#125;</span>_<span class="variable">$&#123;time&#125;</span>.sql.gz  \033[0m&quot;</span> &gt;&gt; /opt/confluence_mysql/bak/confluence_bak.log                                   </span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;\033[36m <span class="variable">$&#123;time&#125;</span>数据库:<span class="variable">$&#123;bak_name&#125;</span>备份成功,                                                                                                             </span></span><br><span class="line"><span class="string">                备份位置:<span class="variable">$&#123;bak_dir&#125;</span>/<span class="variable">$&#123;bak_name&#125;</span>_<span class="variable">$&#123;ip_bak&#125;</span>_<span class="variable">$&#123;time&#125;</span>.sql.gz                                                                                             </span></span><br><span class="line"><span class="string">                <span class="variable">$&#123;bak_dir&#125;</span>目录正在删除五天前的备份。 \033[0m&quot;</span>                                                                                                        </span><br><span class="line">       find <span class="variable">$&#123;bak_file&#125;</span> -<span class="built_in">type</span> f -mtime +5 |xargs <span class="built_in">rm</span> -f                                                                                                               </span><br><span class="line">   <span class="keyword">else</span>                                                                                                                                                              </span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;\033[31m <span class="variable">$&#123;time&#125;</span>数据库:<span class="variable">$&#123;bak_name&#125;</span>备份失败，请检查。 \033[0m&quot;</span>                                                                                           </span><br><span class="line"><span class="keyword">fi</span>                                                                                                                                                                   </span><br><span class="line">&#125;                                                                                                                                                                                                                                                                                                                                           </span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;                                                                                                                                                                                                                                                                                                                       </span><br><span class="line">    bak_mysql                                                                                                                                                                                                                                                                                                   </span><br><span class="line">&#125;                                                                                                                                                                    </span><br><span class="line">main      </span><br></pre></td></tr></table></figure><p>登录mysql设置策略</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it confluse_mysql bash</span><br><span class="line">mysql -uroot -p</span><br><span class="line">SET GLOBAL tx_isolation=<span class="string">&#x27;READ-COMMITTED&#x27;</span>;</span><br></pre></td></tr></table></figure><p><a href="https://wn-apple-teawine.fun/2023/05/15/mysql%E5%A4%87%E4%BB%BD%E8%84%9A%E6%9C%AC/?highlight=mysql%E5%A4%87%E4%BB%BD">mysql备份脚本</a></p><p>定时任务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 9 * * * /usr/bin/docker <span class="built_in">exec</span> webstack_mysql bash /home/mysqlbak/webstack-dbbak.sh</span><br><span class="line">0 10 * * * /usr/bin/docker <span class="built_in">exec</span> confluse_mysql bash /home/db_bak_sh/confluence_dbbak.sh</span><br></pre></td></tr></table></figure><h1 id="三-安装confluse"><a href="#三-安装confluse" class="headerlink" title="三. 安装confluse"></a>三. 安装confluse</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 confluence</span></span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">wget https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-6.12.0-x64.bin</span><br><span class="line"><span class="comment"># 赋予执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x atlassian-confluence-6.12.0-x64.bin</span><br><span class="line"><span class="comment"># 执行安装</span></span><br><span class="line">./atlassian-confluence-6.12.0-x64.bin</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_79ea426efd840b65466f2b7ada4cc900.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_79ea426efd840b65466f2b7ada4cc900.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ebffd9d0bc193d12ca2d33caf5fba471.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ebffd9d0bc193d12ca2d33caf5fba471.png"></p><h1 id="四-其他"><a href="#四-其他" class="headerlink" title="四. 其他"></a>四. 其他</h1><blockquote><p>破解 confluence</p><p>破解文件下载</p><p><a href="https://drive.wn-apple-teawine.fun/api/raw/?path=/public-tools/confluence/confluence%E7%A0%B4%E8%A7%A3%E5%B7%A5%E5%85%B7.zip">confluence破解工具.rar</a></p><h1 id="破解步骤"><a href="#破解步骤" class="headerlink" title="破解步骤"></a>破解步骤</h1><p>windows java下载地址:</p><p><a href="https://www.oracle.com/java/technologies/javase/javase8u211-later-archive-downloads.html">Java Archive Downloads - Java SE 8u211 and later (oracle.com)</a></p><p>windows部署java参考：</p><p><a href="https://blog.csdn.net/weixin_45710060/article/details/123315280">Java详细安装配置教程(Windows)，从下载到配置——Java-1.8(jdk)安装_jre1.8-CSDN博客</a></p><ul><li><p>拷贝 <strong>/opt/atlassian/confluence/confluence/WEB-INF/lib/atlassian-extras-decoder-v2-3.4.1.jar</strong> 文件到 本地本地并重命名为 <strong>atlassian-extras-2.4.jar</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将此文件拷贝到当前目录</span></span><br><span class="line"><span class="built_in">cp</span>  /opt/atlassian/confluence/confluence/WEB-INF/lib/atlassian-extras-decoder-v2-3.4.1.jar .</span><br><span class="line"><span class="comment"># 重命名为 atlassian-extras-2.4.jar 再将重命名后的文件下载到windows电脑本地 用于存储破解文件的文件夹</span></span><br><span class="line"><span class="built_in">mv</span>  atlassian-extras-decoder-v2-3.4.1.jar  atlassian-extras-2.4.jar</span><br></pre></td></tr></table></figure></li><li><p>打开破解工具 <strong>confluence_keygen.jar</strong>（本地需先安装 <strong>java</strong> ）<strong>windows</strong> 命令行 <strong>cmd</strong> 执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar confluence_keygen.jar</span><br></pre></td></tr></table></figure></li><li><p>执行完成后 后台会自动启动一个程序 &gt;&gt; 此时点击已启动的程序的 <strong>.patch!</strong> 选项 找到 <strong>atlassian-extras-2.4.jar</strong> 打开</p></li><li><p>可以看到 <strong>atlassian-extras-2.4.jar</strong> 和 <strong>atlassian-extras-2.4.bak</strong> 两个文件，这里 <strong>atlassian-extras-2.4.jar</strong> 已经是破解好的了，将 <strong>atlassian-extras-2.4.jar</strong> 名字改回 <strong>atlassian-extras-decoder-v2-3.4.1.jar</strong> 将 <strong>atlassian-extras-decoder-v2-3.4.1.jar</strong> 上传到服务器原目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将文件上传到服务器</span></span><br><span class="line">rz</span><br><span class="line"><span class="comment"># 重命名为之前的文件名</span></span><br><span class="line"><span class="built_in">mv</span> atlassian-extras-2.4.jar  atlassian-extras-decoder-v2-3.4.1.jar</span><br><span class="line"><span class="comment"># 复制到原目录</span></span><br><span class="line"><span class="built_in">cp</span> atlassian-extras-decoder-v2-3.4.1.jar  /opt/atlassian/confluence/confluence/WEB-INF/lib/</span><br></pre></td></tr></table></figure></li><li><p>将破解包中的 mysql 驱动 mysql-connector-java-5.1.44-bin.jar 拷贝到 /opt/atlassian/confluence/confluence/WEB-INF/lib</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将mysql驱动拷贝到服务器目录</span></span><br><span class="line"><span class="built_in">cp</span> mysql-connector-java-5.1.44-bin.jar  /opt/atlassian/confluence/confluence/WEB-INF/lib</span><br></pre></td></tr></table></figure></li><li><p>重启 confluence</p></li></ul><h2 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止程序</span></span><br><span class="line"><span class="built_in">cd</span> /opt/atlassian/confluence/bin/</span><br><span class="line">./stop-confluence.sh</span><br></pre></td></tr></table></figure><h2 id="修改-confluence-监听地址，确定-8090-没有监听在-127-0-0-1-上"><a href="#修改-confluence-监听地址，确定-8090-没有监听在-127-0-0-1-上" class="headerlink" title="修改 confluence 监听地址，确定 8090 没有监听在 127.0.0.1 上"></a>修改 confluence 监听地址，确定 8090 没有监听在 127.0.0.1 上</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/atlassian/confluence/conf/server.xml</span><br></pre></td></tr></table></figure><h2 id="修改-confluence-使用的目录的权限"><a href="#修改-confluence-使用的目录的权限" class="headerlink" title="修改 confluence 使用的目录的权限"></a>修改 confluence 使用的目录的权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文件夹其所有内容递归地修改为confluence用户和组的所有权</span></span><br><span class="line"><span class="built_in">chown</span> -R confluence:confluence /opt/atlassian</span><br><span class="line"><span class="built_in">chown</span> -R confluence:confluence /var/atlassian</span><br></pre></td></tr></table></figure><h2 id="启动，启动比较慢，需要等个两三分钟"><a href="#启动，启动比较慢，需要等个两三分钟" class="headerlink" title="启动，启动比较慢，需要等个两三分钟"></a>启动，启动比较慢，需要等个两三分钟</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动程序</span></span><br><span class="line">./start-confluence.sh</span><br></pre></td></tr></table></figure><p>关于服务监听IP的区别，参考</p><p><a href="https://segmentfault.com/a/1190000018629247">https://segmentfault.com/a/1190000018629247</a></p><p>访问confluence</p><p><a href="http://ip:8090/">http://ip:8090</a></p><p>开机自启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置为systemd托管</span></span><br><span class="line">vim /lib/systemd/system/confluence.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=confluence service</span><br><span class="line">After=network.target</span><br><span class="line">StartLimitIntervalSec=60</span><br><span class="line">StartLimitBurst=5</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">User=confluence</span><br><span class="line">Group=confluence</span><br><span class="line">ExecStart=/opt/atlassian/confluence/bin/start-confluence.sh</span><br><span class="line">ExecStop=/opt/atlassian/confluence/bin/stop-confluence.sh</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=1</span><br><span class="line">SuccessExitStatus=3 4</span><br><span class="line">RestartForceExitStatus=3 4</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"></span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">systemctl start/stop/restart/status confluence</span><br><span class="line">systemctl <span class="built_in">enable</span> confluence</span><br></pre></td></tr></table></figure><p>报错</p><p>若部署过程中出现报错，可以先停止 confluence，然后删除数据库，并重建数据库，然后删除 /var/atlassian/application-data/confluence/confluence.cfg.xml 文件</p><p>再启动 confluence，就又到了 confluence 的 setup 页面</p><h1 id="卸载wiki"><a href="#卸载wiki" class="headerlink" title="卸载wiki"></a>卸载wiki</h1><p><a href="https://blog.csdn.net/qq_43693598/article/details/111265298">linux 卸载confluence，只需三步_confluence卸载-CSDN博客</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. 删除主目录</span><br><span class="line"><span class="built_in">rm</span> -rf /opt/atlassian/</span><br><span class="line"></span><br><span class="line">2. 删除数据目录</span><br><span class="line"><span class="built_in">rm</span> -rf /var/atlassian/</span><br><span class="line"></span><br><span class="line">3. 删除用户</span><br><span class="line">userdel -r confluence</span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.cnblogs.com/ios9/p/14473523.html">https://www.cnblogs.com/ios9/p/14473523.html</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 常用软件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常用软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>homepage与sun-panel轻量级导航部署</title>
      <link href="/2024/04/16/homepage%E4%B8%8Esun-panel%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%BC%E8%88%AA%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/04/16/homepage%E4%B8%8Esun-panel%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%BC%E8%88%AA%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="homepage与sun-panel轻量级导航部署"><a href="#homepage与sun-panel轻量级导航部署" class="headerlink" title="homepage与sun-panel轻量级导航部署"></a>homepage与sun-panel轻量级导航部署</h1><blockquote><p>镜像可选</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ghcr.io/gethomepage/homepage:latest</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:homepage</span><br></pre></td></tr></table></figure><p>其他各种导航</p><p><a href="https://wn-apple-teawine.fun/2023/11/23/web-start%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%83%A8%E7%BD%B2">https://wn-apple-teawine.fun/2023/11/23/web-start轻量级导航栏部署</a></p><p><a href="https://wn-apple-teawine.fun/2023/08/11/webstack%E9%83%A8%E7%BD%B2">https://wn-apple-teawine.fun/2023/08/11/webstack部署</a></p></blockquote><h2 id="一-部署"><a href="#一-部署" class="headerlink" title="一. 部署"></a>一. 部署</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.8&quot;</span></span><br><span class="line">services:</span><br><span class="line">  homepage:</span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:homepage</span><br><span class="line">    container_name: homepage</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    ports:</span><br><span class="line">      - 3123:3000</span><br><span class="line">    environment:</span><br><span class="line">      - PUID=1000</span><br><span class="line">      - PGID=100</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">    volumes:</span><br><span class="line">      - ./config:/app/config</span><br><span class="line">      <span class="comment"># - /var/run/docker.sock:/var/run/docker.sock (可选)</span></span><br><span class="line">      - ./logs:/logs</span><br><span class="line">      - ./icons:/app/public/icons</span><br><span class="line">      - ./images:/app/public/images</span><br><span class="line">      - /volume2:/volume2:ro   <span class="comment">#本机磁盘</span></span><br><span class="line">      <span class="comment">#- /volume3:/volume3:ro</span></span><br><span class="line">    network_mode: bridge                                                                           </span><br></pre></td></tr></table></figure><h2 id="二-配置（文件路径启动路径文件夹config）"><a href="#二-配置（文件路径启动路径文件夹config）" class="headerlink" title="二. 配置（文件路径启动路径文件夹config）"></a>二. 配置（文件路径启动路径文件夹config）</h2><p><strong>service.yml</strong>本文配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@web:/opt/homepage/config<span class="comment"># cat services.yaml </span></span><br><span class="line">---</span><br><span class="line"><span class="comment"># For configuration options and examples, please see:</span></span><br><span class="line"><span class="comment"># https://gethomepage.dev/latest/configs/services</span></span><br><span class="line"></span><br><span class="line">- 运维与开发工具:</span><br><span class="line">    - Gitlab:</span><br><span class="line">        href: http://10.0.0.10:8929</span><br><span class="line">        description: 代码托管平台</span><br><span class="line">    - 密码管理平台:</span><br><span class="line">        href: https://10.0.0.10</span><br><span class="line">        description: 密码管理平台</span><br><span class="line"></span><br><span class="line">- AI助手:</span><br><span class="line">    - one-api:</span><br><span class="line">        href: http://10.0.0.10:3000</span><br><span class="line">        description: api-key分发平台</span><br><span class="line">    - Fastgpt:</span><br><span class="line">        href: http://10.0.0.10:30001</span><br><span class="line">        description: Fastgpt</span><br><span class="line"></span><br><span class="line">- 官网:</span><br><span class="line">    - 官网1:</span><br><span class="line">        href: http://10.0.0.10/wp-login.php</span><br><span class="line">        description: 官网1</span><br><span class="line">    - 官网2:</span><br><span class="line">        href: http://10.0.0.10:4007/wp-login.php</span><br><span class="line">        description: 官网2</span><br></pre></td></tr></table></figure><p><strong>settings.yaml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="comment"># For configuration options and examples, please see:</span></span><br><span class="line"><span class="comment"># https://gethomepage.dev/latest/configs/settings</span></span><br><span class="line"></span><br><span class="line">providers:</span><br><span class="line">  openweathermap: openweathermapapikey</span><br><span class="line">  weatherapi: weatherapiapikey</span><br><span class="line"></span><br><span class="line"><span class="comment"># 语言en-AU、en-GB</span></span><br><span class="line">language: zh-CN</span><br><span class="line"></span><br><span class="line"><span class="comment"># 背景图</span></span><br><span class="line">background:</span><br><span class="line">  image: https://images.unsplash.com/photo-1502790671504-542ad42d5189?auto=format&amp;fit=crop&amp;w=2560&amp;q=80</span><br><span class="line">  blur: sm <span class="comment">#模糊程度，范围 sm, &quot;&quot;, md, xl... 参考 https://tailwindcss.com/docs/backdrop-blur</span></span><br><span class="line">  saturate: 50 <span class="comment">#饱和度，范围 0, 50, 100... 参考 https://tailwindcss.com/docs/backdrop-saturate</span></span><br><span class="line">  brightness: 50 <span class="comment">#亮度，范围 0, 50, 75... 参考 https://tailwindcss.com/docs/backdrop-brightness</span></span><br><span class="line">  opacity: 50 <span class="comment">#不透明度，范围 0-100</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 标题</span></span><br><span class="line">title: CKY-导航</span><br><span class="line"></span><br><span class="line"><span class="comment"># 隐藏发布版本</span></span><br><span class="line"><span class="comment">#hideVersion: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导航横屏需要与service.yml文件同步</span></span><br><span class="line">layout:</span><br><span class="line">  运维与开发工具:</span><br><span class="line">    icon: /images/1.png</span><br><span class="line">    style: row</span><br><span class="line">    columns: 6</span><br><span class="line">  AI助手:</span><br><span class="line">    icon: jellyfin.png</span><br><span class="line">    style: row</span><br><span class="line">    columns: 6</span><br><span class="line">  官网:</span><br><span class="line">    icon: jellyfin.png</span><br><span class="line">    style: row</span><br><span class="line">    columns: 6</span><br></pre></td></tr></table></figure><h4 id="背景图"><a href="#背景图" class="headerlink" title="背景图"></a>背景图</h4><p>可以使用图片链接自定义 Home­page 的背景：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">background:</span><br><span class="line">  image: https://images.unsplash.com/photo-1502790671504-542ad42d5189?auto=format&amp;fit=crop&amp;w=2560&amp;q=80</span><br></pre></td></tr></table></figure><p>或者使用本地图片，新建一个文件夹，比如 <code>images</code> ，在 com­pose 配置里映射到 <code>/app/public/images</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">  - ./homepage/images:/app/public/images</span><br></pre></td></tr></table></figure><p>之后就可以这样引用本地的图片：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">background:</span><br><span class="line">  image: https://images.unsplash.com/photo-1502790671504-542ad42d5189?auto=format&amp;fit=crop&amp;w=2560&amp;q=80</span><br><span class="line">  blur: sm <span class="comment">#模糊程度，范围 sm, &quot;&quot;, md, xl... 参考 https://tailwindcss.com/docs/backdrop-blur</span></span><br><span class="line">  saturate: 50 <span class="comment">#饱和度，范围 0, 50, 100... 参考 https://tailwindcss.com/docs/backdrop-saturate</span></span><br><span class="line">  brightness: 50 <span class="comment">#亮度，范围 0, 50, 75... 参考 https://tailwindcss.com/docs/backdrop-brightness</span></span><br><span class="line">  opacity: 50 <span class="comment">#不透明度，范围 0-100</span></span><br></pre></td></tr></table></figure><p><strong>特别注意：不要偷懒直接映射 <code>/app/public</code> 目录，会报错。</strong></p><p><strong>widgets.yaml</strong></p><p>home­page 中 <code>widgets.yaml</code> 主要是用来修改<strong>页面顶部</strong>的一些小部件，比如系统状况、搜索框、天气、时间、欢迎词等等。</p><p>自己只用到了系统状况、搜索框和时间，所以只说说这仨的用法。</p><p>系统状况中内存只有一个好办，但硬盘有很多个的话，就需要有几个盘就映射几个文件夹进去。例如群晖 NAS 中，有 <code>volume1</code> 、 <code>volume2</code> 、 <code>volume3</code> 三个硬盘，映射的时候就要都映射进去；怕容器写坏文件，就加上 <code>:ro</code> 只读。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">  - /volume2:/volume2:ro</span><br><span class="line">  - /volume3:/volume3:ro</span><br></pre></td></tr></table></figure><p>但配置文件是在 <code>volume1</code> 中，所以不用映射 <code>volume1</code> 。</p><p>时间、搜索完全是官方文档的教程，我就不复制粘贴过来了。最后的配置如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- resources:</span><br><span class="line">    label: System</span><br><span class="line">    cpu: <span class="literal">true</span></span><br><span class="line">    memory: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">- resources:</span><br><span class="line">    label: Storage</span><br><span class="line">    expanded: <span class="literal">true</span></span><br><span class="line">    disk:</span><br><span class="line">      - /</span><br><span class="line">      - /volume2</span><br><span class="line">      - /volume3</span><br><span class="line"></span><br><span class="line">- search:</span><br><span class="line">    provider: [google, baidu]</span><br><span class="line">    target: _blank</span><br><span class="line"></span><br><span class="line">- datetime:</span><br><span class="line">    text_size: xl</span><br><span class="line">    format:</span><br><span class="line">      timeStyle: short</span><br><span class="line">      hour12: <span class="literal">false</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_61f83a276d633a416fff126c70fe1b2b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_61f83a276d633a416fff126c70fe1b2b.png"></p><h2 id="三-sun-panel导航部署-不建议使用-存在bug-无法修改密码"><a href="#三-sun-panel导航部署-不建议使用-存在bug-无法修改密码" class="headerlink" title="三. sun-panel导航部署(不建议使用 存在bug 无法修改密码)"></a>三. sun-panel导航部署(不建议使用 存在bug 无法修改密码)</h2><blockquote><p>参考：<a href="https://mp.weixin.qq.com/s/WbwTVuCcoqHZkXJsBPIGFA">https://mp.weixin.qq.com/s/WbwTVuCcoqHZkXJsBPIGFA</a></p><ul><li><code>/app/conf</code>：用来存放配置文件。</li><li><code>/app/uploads</code>：存放上传的文件。</li><li><code>/app/database</code>：存放数据库文件。</li><li><code>/app/runtime</code>：存放运行日志（不建议挂载）。</li></ul><p>默认密码</p><ul><li>账户：<a href="mailto:&#97;&#x64;&#x6d;&#105;&#110;&#x40;&#115;&#x75;&#110;&#46;&#99;&#x63;">&#97;&#x64;&#x6d;&#105;&#110;&#x40;&#115;&#x75;&#110;&#46;&#99;&#x63;</a></li><li>密码：12345678</li></ul></blockquote><p>镜像可选</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hslr/sun-panel</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:sun-panel</span><br></pre></td></tr></table></figure><p>docker-compose方式部署</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  sun-panel:</span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:sun-panel</span><br><span class="line">    container_name: sun-panel</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3002:3002&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./conf:/app/conf</span><br><span class="line">      - ./uploads:/app/uploads</span><br><span class="line">      - ./database:/app/database</span><br></pre></td></tr></table></figure><p>效果</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_c0077360c400276d07c17648c643fa87.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_c0077360c400276d07c17648c643fa87.png"></p><p>本文参考：</p><p><a href="https://github.com/gethomepage/homepage">https://github.com/gethomepage/homepage</a></p><p><a href="https://www.himiku.com/archives/homepage.html">https://www.himiku.com/archives/homepage.html</a></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu20.04部署ftp服务</title>
      <link href="/2024/04/11/ubuntu20.04%E9%83%A8%E7%BD%B2ftp%E6%9C%8D%E5%8A%A1/"/>
      <url>/2024/04/11/ubuntu20.04%E9%83%A8%E7%BD%B2ftp%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="ubuntu20-04部署ftp服务"><a href="#ubuntu20-04部署ftp服务" class="headerlink" title="ubuntu20.04部署ftp服务"></a>ubuntu20.04部署ftp服务</h1><h2 id="一-安装ftp服务并创建登录用户"><a href="#一-安装ftp服务并创建登录用户" class="headerlink" title="一. 安装ftp服务并创建登录用户"></a>一. 安装ftp服务并创建登录用户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install vsftpd</span><br></pre></td></tr></table></figure><p>添加ftp用户</p><p>创建用户(用户名为myftp，与后面vsftpd配置文件对应)：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -m myftp -d /home/myftp</span><br><span class="line"><span class="comment"># 若不想让该用户登录系统</span></span><br><span class="line">sudo useradd -m myftp -d /home/myftp -s /bin/bash/nologin</span><br><span class="line"><span class="comment"># 设置用户密码</span></span><br><span class="line">sudo passwd myftp</span><br></pre></td></tr></table></figure><p>创建用户目录,并赋予权限(<code>此步骤必须在创建用户之后</code>)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /home/myftp</span><br><span class="line">sudo <span class="built_in">chmod</span> 755 /home/myftp -R</span><br></pre></td></tr></table></figure><h2 id="二-修改服务配置"><a href="#二-修改服务配置" class="headerlink" title="二. 修改服务配置"></a>二. 修改服务配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/vsftpd.conf</span><br></pre></td></tr></table></figure><p>配置如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">listen=YES</span><br><span class="line"><span class="comment">#listen_ipv6=YES      #使用IPV6</span></span><br><span class="line">anonymous_enable=NO   <span class="comment">#不允许匿名访问</span></span><br><span class="line">local_enable=YES      <span class="comment">#允许本地用户登录</span></span><br><span class="line">write_enable=YES      <span class="comment">#允许FTP写入</span></span><br><span class="line">local_umask=022      <span class="comment">#新建文件夹或文件的权限默认为077，大多数ftp服务器设置为022</span></span><br><span class="line"><span class="comment">#anon_upload_enable=YES  #不允许匿名用户上传文件</span></span><br><span class="line"><span class="comment">#anon_mkdir_write_enable=YES #不允许匿名用户新建目录</span></span><br><span class="line">dirmessage_enable=YES        <span class="comment">#进入目录时向远程用户发送消息</span></span><br><span class="line">use_localtime=YES            <span class="comment">#显示带有时间的目录列表</span></span><br><span class="line">xferlog_enable=YES           <span class="comment">#激活上传/下载的日志记录</span></span><br><span class="line">connect_from_port_20=YES     <span class="comment">#确保ftp传输端口号为20</span></span><br><span class="line"><span class="comment">#chown_uploads=YES           #可将上传的匿名文件由指定用户拥有</span></span><br><span class="line"><span class="comment">#chown_username=whoever</span></span><br><span class="line">xferlog_file=/var/log/vsftpd.log  <span class="comment">#日志文件路径，也可以直接使用默认路径</span></span><br><span class="line">xferlog_std_format=YES           <span class="comment">#使用标准化格式的日志文件</span></span><br><span class="line"><span class="comment">#idle_session_timeout=600         #空闲会话超时的默认值</span></span><br><span class="line"><span class="comment">#data_connection_timeout=120     #数据连接超时的默认值</span></span><br><span class="line"><span class="comment">#Nopriv_user= ftpsecure         #创建唯一的用户，将该用户用作完全隔离且无特权的用户</span></span><br><span class="line"><span class="comment">#async_abor_enable=YES        #识别异步abor请求，可能会拒绝一些老的FTP客户端的连接</span></span><br><span class="line"><span class="comment">#ascii_upload_enable=YES      #设置ASCII上传下载</span></span><br><span class="line"><span class="comment">#ascii_download_enable=YES </span></span><br><span class="line">ftpd_banner=Welcome to blah FTP service. <span class="comment">#登录欢迎语</span></span><br><span class="line"><span class="comment">#deny_email_enable=YES          #拒绝匿名email地址的文件，防止攻击</span></span><br><span class="line"><span class="comment">#banned_email_file=/etc/vsftpd.banned_emails</span></span><br><span class="line"><span class="comment">#chroot_local_user=YES           #将本地用户限制在主目录中</span></span><br><span class="line">local_root=/home/myftp             <span class="comment">#设置主目录</span></span><br><span class="line">chroot_local_user=YES            <span class="comment">#限制用户权限</span></span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">chroot_list_file=/etc/vsftpd.chroot_list  <span class="comment">#允许访问的用户列表文件</span></span><br><span class="line"><span class="comment">#ls_recurse_enable=YES              #激活ls -r选项</span></span><br><span class="line">secure_chroot_dir=/var/run/vsftpd/empty   <span class="comment">#空目录名称</span></span><br><span class="line">pam_service_name=myftp                   <span class="comment">#创建的ftp用户名</span></span><br><span class="line"><span class="comment">#rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem  #ssl的RSA证书位置</span></span><br><span class="line"><span class="comment">#rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key #ssl的RSA秘钥位置</span></span><br><span class="line"><span class="comment">#ssl_enable=NO                          #开启ssl加密</span></span><br><span class="line"><span class="comment">#utf8_filesystem=YES                    #使用utf8文件系统</span></span><br></pre></td></tr></table></figure><p>如下为配置后的vsftpd.conf文件内容，#为注释内容，已删除。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">listen=YES</span><br><span class="line">anonymous_enable=NO</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">use_localtime=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line">xferlog_file=/var/log/vsftpd.log</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">ftpd_banner=Welcome to blah FTP service.</span><br><span class="line">local_root=/home/myftp</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">chroot_list_file=/etc/vsftpd.chroot_list</span><br><span class="line">secure_chroot_dir=/var/run/vsftpd/empty</span><br><span class="line">pam_service_name=myftp</span><br><span class="line">rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem</span><br><span class="line">rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key</span><br></pre></td></tr></table></figure><p>其中：</p><ul><li>local_root=/home/myftp     //该目录为之前创建的用户目录</li><li>pam_service_name=myftp   //默认为vsftpd，需要更改为创建的ftp用户名</li><li>创建文件vsftpd.chroot_list</li><li>sudo vi /etc/vsftpd.chroot_list   并将之前创建的用户名(myftp)添加到该文件中。</li></ul><p>重新启动服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart vsftpd</span><br></pre></td></tr></table></figure><p>效果</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_5fd0c9223e7d46a74c05bea17f930c28.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_5fd0c9223e7d46a74c05bea17f930c28.png"></p><p>本文参考：</p><p><a href="https://blog.csdn.net/fangye945a/article/details/85109404">https://blog.csdn.net/fangye945a/article/details/85109404</a></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux部署hexo</title>
      <link href="/2024/04/11/linux%E9%83%A8%E7%BD%B2hexo/"/>
      <url>/2024/04/11/linux%E9%83%A8%E7%BD%B2hexo/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="linux部署hexo"><a href="#linux部署hexo" class="headerlink" title="linux部署hexo"></a>linux部署hexo</h1><h2 id="一-安装node-js"><a href="#一-安装node-js" class="headerlink" title="一. 安装node.js"></a>一. 安装node.js</h2><h3 id="node-js下载链接"><a href="#node-js下载链接" class="headerlink" title="node.js下载链接"></a>node.js下载链接</h3><blockquote><p><a href="https://nodejs.org/dist/v16.13.1/node-v16.13.1-linux-x64.tar.xz">资源下载链接 | &gt;</a></p></blockquote><h2 id="二-配置node-js"><a href="#二-配置node-js" class="headerlink" title="二. 配置node.js"></a>二. 配置node.js</h2><p>node.js下载完成后</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/node/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/node/</span><br><span class="line">此时将安装包上传到此目录后解压</span><br><span class="line">rz </span><br><span class="line">tar -xvf node-v16.13.1-linux-x64.tar.xz</span><br></pre></td></tr></table></figure><p>配置环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置环境变量 </span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="comment"># 添加如下</span></span><br><span class="line"><span class="comment"># Nodejs</span></span><br><span class="line"><span class="built_in">export</span> PATH=/usr/local/node/node-v16.13.1-linux-x64/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="comment"># 生效</span></span><br><span class="line"><span class="built_in">source</span>  /etc/profile</span><br></pre></td></tr></table></figure><p>此时nodejs安装完成。</p><h2 id="三-安装cnpm"><a href="#三-安装cnpm" class="headerlink" title="三. 安装cnpm"></a>三. 安装cnpm</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输入以下内容，验证是否安装成功</span></span><br><span class="line"><span class="comment"># 安装一个npm的加强版</span></span><br><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br><span class="line"><span class="comment"># 设置仓库为npm仓库</span></span><br><span class="line">npm config <span class="built_in">set</span> registry https://registry.npmjs.org</span><br><span class="line"><span class="comment"># 续安装可能会出现问题，因为cpnm版本太高的原因如果出现问题的可以卸载这个最新版本安装一个指定版本</span></span><br><span class="line">的(npm是从国外拉包 cnpm国内)</span><br><span class="line">npm uninstall -g cnpm</span><br><span class="line"><span class="comment"># 安装指定版本：7.1.0</span></span><br><span class="line">npm install cnpm@7.1.0 -g</span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">[root@localhost ~]<span class="comment"># npm -version</span></span><br><span class="line">8.1.2</span><br><span class="line">[root@localhost ~]<span class="comment"># npx -v</span></span><br><span class="line">8.1.2</span><br><span class="line">[root@localhost bin]<span class="comment"># npm version</span></span><br></pre></td></tr></table></figure><h2 id="四-安装hexo"><a href="#四-安装hexo" class="headerlink" title="四. 安装hexo"></a>四. 安装hexo</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此时再使用cnpm安装nodejs即可</span></span><br><span class="line"><span class="comment"># 安装hexo</span></span><br><span class="line">cnpm install -g hexo-cli</span><br></pre></td></tr></table></figure><p>备注：将事先在windows准备好的安装博客压缩包上传到服务器解压再 hexo clean &amp;&amp; hexo g &amp;&amp; hexo s即可。</p><h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a href="https://blog.csdn.net/weixin_45561352/article/details/122109731">linux搭建hexo个人博客_linux hexo博客-CSDN博客</a></p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastgpt对接one-api部署</title>
      <link href="/2024/04/09/fastgpt%E5%AF%B9%E6%8E%A5one-api%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/04/09/fastgpt%E5%AF%B9%E6%8E%A5one-api%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="fastgpt对接one-api部署"><a href="#fastgpt对接one-api部署" class="headerlink" title="fastgpt对接one-api部署"></a>fastgpt对接one-api部署</h1><blockquote><p>默认密钥：<strong>root/1234</strong></p></blockquote><h2 id="one-api部署"><a href="#one-api部署" class="headerlink" title="one-api部署"></a>one-api部署</h2><blockquote><p><a href="http://sunlight.zznnwn.cloudns.biz/2024/04/09/one-api%E9%83%A8%E7%BD%B2/">部署链接 | &gt;</a></p></blockquote><h2 id="一-fastgpt使用docker-compose方式部署"><a href="#一-fastgpt使用docker-compose方式部署" class="headerlink" title="一 fastgpt使用docker-compose方式部署"></a>一 fastgpt使用docker-compose方式部署</h2><h3 id="镜像可选"><a href="#镜像可选" class="headerlink" title="镜像可选"></a>镜像可选</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:pgvector-v0.5.0</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:mongo5.0.18</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:fastgptv4.7</span><br></pre></td></tr></table></figure><h3 id="官网部署方式："><a href="#官网部署方式：" class="headerlink" title="官网部署方式："></a>官网部署方式：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> fastgpt</span><br><span class="line"><span class="built_in">cd</span> fastgpt</span><br><span class="line">curl -O https://raw.githubusercontent.com/labring/FastGPT/main/files/deploy/fastgpt/docker-compose.yml</span><br><span class="line">curl -O https://raw.githubusercontent.com/labring/FastGPT/main/projects/app/data/config.json</span><br></pre></td></tr></table></figure><h2 id="二-本文部署"><a href="#二-本文部署" class="headerlink" title="二 本文部署"></a>二 本文部署</h2><blockquote><p>one-api与fastgpt分开部署 先部署one api再部署fastgpt即如下</p></blockquote><h3 id="docker-compose-yml文件"><a href="#docker-compose-yml文件" class="headerlink" title="docker-compose.yml文件"></a>docker-compose.yml文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据库的默认账号和密码仅首次运行时设置有效</span></span><br><span class="line"><span class="comment"># 如果修改了账号密码，记得改数据库和项目连接参数，别只改一处~</span></span><br><span class="line"><span class="comment"># 该配置文件只是给快速启动，测试使用。正式使用，记得务必修改账号密码，以及调整合适的知识库参数，共享内存等。</span></span><br><span class="line"></span><br><span class="line">version: <span class="string">&#x27;3.3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  pg:</span><br><span class="line">    image: ankane/pgvector:v0.5.0 <span class="comment"># git</span></span><br><span class="line">    <span class="comment"># image: registry.cn-hangzhou.aliyuncs.com/fastgpt/pgvector:v0.5.0 # 阿里云</span></span><br><span class="line">    container_name: pg</span><br><span class="line">    restart: always</span><br><span class="line">    ports: <span class="comment"># 生产环境建议不要暴露</span></span><br><span class="line">      - 5432:5432</span><br><span class="line">    networks:</span><br><span class="line">      - fastgpt</span><br><span class="line">    environment:</span><br><span class="line">      <span class="comment"># 这里的配置只有首次运行生效。修改后，重启镜像是不会生效的。需要把持久化数据删除再重启，才有效果</span></span><br><span class="line">      - POSTGRES_USER=username</span><br><span class="line">      - POSTGRES_PASSWORD=password</span><br><span class="line">      - POSTGRES_DB=postgres</span><br><span class="line">    volumes:</span><br><span class="line">      - ./pg/data:/var/lib/postgresql/data</span><br><span class="line">  mongo:</span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/mongo:5.0.18</span><br><span class="line">    container_name: mongo</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 27017:27017</span><br><span class="line">    networks:</span><br><span class="line">      - fastgpt</span><br><span class="line">    <span class="built_in">command</span>: mongod --keyFile /data/mongodb.key --replSet rs0</span><br><span class="line">    environment:</span><br><span class="line">      - MONGO_INITDB_ROOT_USERNAME=myusername</span><br><span class="line">      - MONGO_INITDB_ROOT_PASSWORD=mypassword</span><br><span class="line">    volumes:</span><br><span class="line">      - ./mongo/data:/data/db</span><br><span class="line">    entrypoint:</span><br><span class="line">      - bash</span><br><span class="line">      - -c</span><br><span class="line">      - |</span><br><span class="line">        openssl rand -<span class="built_in">base64</span> 128 &gt; /data/mongodb.key</span><br><span class="line">        <span class="built_in">chmod</span> 400 /data/mongodb.key</span><br><span class="line">        <span class="built_in">chown</span> 999:999 /data/mongodb.key</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&#x27;const isInited = rs.status().ok === 1</span></span><br><span class="line"><span class="string">        if(!isInited)&#123;</span></span><br><span class="line"><span class="string">          rs.initiate(&#123;</span></span><br><span class="line"><span class="string">              _id: &quot;rs0&quot;,</span></span><br><span class="line"><span class="string">              members: [</span></span><br><span class="line"><span class="string">                  &#123; _id: 0, host: &quot;mongo:27017&quot; &#125;</span></span><br><span class="line"><span class="string">              ]</span></span><br><span class="line"><span class="string">          &#125;)</span></span><br><span class="line"><span class="string">        &#125;&#x27;</span> &gt; /data/initReplicaSet.js</span><br><span class="line">        <span class="comment"># 启动MongoDB服务</span></span><br><span class="line">        <span class="built_in">exec</span> docker-entrypoint.sh <span class="string">&quot;$<span class="variable">$@</span>&quot;</span> &amp;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 等待MongoDB服务启动</span></span><br><span class="line">        <span class="keyword">until</span> mongo -u myusername -p mypassword --authenticationDatabase admin --<span class="built_in">eval</span> <span class="string">&quot;print(&#x27;waited for connection&#x27;)&quot;</span> &gt; /dev/null 2&gt;&amp;1; <span class="keyword">do</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;Waiting for MongoDB to start...&quot;</span></span><br><span class="line">          <span class="built_in">sleep</span> 2</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 执行初始化副本集的脚本</span></span><br><span class="line">        mongo -u myusername -p mypassword --authenticationDatabase admin /data/initReplicaSet.js</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 等待docker-entrypoint.sh脚本执行的MongoDB服务进程</span></span><br><span class="line">        <span class="built_in">wait</span> $$!</span><br><span class="line">  fastgpt:</span><br><span class="line">    container_name: fastgpt</span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt:v4.7 <span class="comment"># git</span></span><br><span class="line">    <span class="comment"># image: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt:v4.7 # 阿里云</span></span><br><span class="line">    ports:</span><br><span class="line">      - 30001:3000</span><br><span class="line">    networks:</span><br><span class="line">      - fastgpt</span><br><span class="line">    depends_on:</span><br><span class="line">      - mongo</span><br><span class="line">      - pg</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      <span class="comment"># root 密码，用户名为: root。如果需要修改 root 密码，直接修改这个环境变量，并重启即可。</span></span><br><span class="line">      - DEFAULT_ROOT_PSW=1234</span><br><span class="line">      <span class="comment"># AI模型的API地址哦。务必加 /v1。这里默认填写了OneApi的访问地址。</span></span><br><span class="line">      - OPENAI_BASE_URL=http://10.0.0.10:3000/v1                     <span class="comment">#(此地址为oneapi地址+/v1)</span></span><br><span class="line">      <span class="comment"># AI模型的API Key。（这里默认填写了OneAPI的快速默认key，测试通后，务必及时修改）</span></span><br><span class="line">      - CHAT_API_KEY=sk-z02Gt0o6cWhTS6cbFfbgbggb9d42cF622Bc5e5c471a  <span class="comment">#(此key为one-api生成的令牌)</span></span><br><span class="line">      <span class="comment"># 数据库最大连接数</span></span><br><span class="line">      - DB_MAX_LINK=30</span><br><span class="line">      <span class="comment"># 登录凭证密钥</span></span><br><span class="line">      - TOKEN_KEY=any</span><br><span class="line">      <span class="comment"># root的密钥，常用于升级时候的初始化请求</span></span><br><span class="line">      - ROOT_KEY=root_key</span><br><span class="line">      <span class="comment"># 文件阅读加密</span></span><br><span class="line">      - FILE_TOKEN_KEY=filetoken</span><br><span class="line">      <span class="comment"># MongoDB 连接参数. 用户名myusername,密码mypassword。</span></span><br><span class="line">      - MONGODB_URI=mongodb://myusername:mypassword@mongo:27017/fastgpt?authSource=admin</span><br><span class="line">      <span class="comment"># pg 连接参数</span></span><br><span class="line">      - PG_URL=postgresql://username:password@pg:5432/postgres</span><br><span class="line">    volumes:</span><br><span class="line">      - ./config.json:/app/data/config.json</span><br><span class="line">      - ./fastgpt/tmp:/app/tmp</span><br><span class="line">  <span class="comment"># mysql:</span></span><br><span class="line">  <span class="comment">#   image: mysql:8.0.36</span></span><br><span class="line">  <span class="comment">#   container_name: mysql</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#   ports:</span></span><br><span class="line">  <span class="comment">#     - 3306:3306</span></span><br><span class="line">  <span class="comment">#   networks:</span></span><br><span class="line">  <span class="comment">#     - fastgpt</span></span><br><span class="line">  <span class="comment">#   command: --default-authentication-plugin=mysql_native_password</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     # 默认root密码，仅首次运行有效</span></span><br><span class="line">  <span class="comment">#     MYSQL_ROOT_PASSWORD: oneapimmysql</span></span><br><span class="line">  <span class="comment">#     MYSQL_DATABASE: oneapi</span></span><br><span class="line">  <span class="comment">#   volumes:</span></span><br><span class="line">  <span class="comment">#     - ./mysql:/var/lib/mysql</span></span><br><span class="line">  <span class="comment"># oneapi:</span></span><br><span class="line">  <span class="comment">#   container_name: oneapi</span></span><br><span class="line">  <span class="comment">#   image: ghcr.io/songquanpeng/one-api:latest</span></span><br><span class="line">  <span class="comment">#   ports:</span></span><br><span class="line">  <span class="comment">#     - 3001:3000</span></span><br><span class="line">  <span class="comment">#   depends_on:</span></span><br><span class="line">  <span class="comment">#     - mysql</span></span><br><span class="line">  <span class="comment">#   networks:</span></span><br><span class="line">  <span class="comment">#     - fastgpt</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     # mysql 连接参数</span></span><br><span class="line">  <span class="comment">#     - SQL_DSN=root:oneapimmysql@tcp(mysql:3306)/oneapi</span></span><br><span class="line">  <span class="comment">#     # 登录凭证加密密钥</span></span><br><span class="line">  <span class="comment">#     - SESSION_SECRET=oneapikey</span></span><br><span class="line">  <span class="comment">#     # 内存缓存</span></span><br><span class="line">  <span class="comment">#     - MEMORY_CACHE_ENABLED=true</span></span><br><span class="line">  <span class="comment">#     # 启动聚合更新，减少数据交互频率</span></span><br><span class="line">  <span class="comment">#     - BATCH_UPDATE_ENABLED=true</span></span><br><span class="line">  <span class="comment">#     # 聚合更新时长</span></span><br><span class="line">  <span class="comment">#     - BATCH_UPDATE_INTERVAL=10</span></span><br><span class="line">  <span class="comment">#     # 初始化的 root 密钥（建议部署完后更改，否则容易泄露）</span></span><br><span class="line">  <span class="comment">#     - INITIAL_ROOT_TOKEN=fastgpt</span></span><br><span class="line">  <span class="comment">#   volumes:</span></span><br><span class="line">  <span class="comment">#     - ./oneapi:/data</span></span><br><span class="line">networks:</span><br><span class="line">  fastgpt:</span><br></pre></td></tr></table></figure><h4 id="阿里通义千文版config-json配置"><a href="#阿里通义千文版config-json配置" class="headerlink" title="阿里通义千文版config.json配置"></a>阿里通义千文版config.json配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;feConfigs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;lafEnv&quot;</span>: <span class="string">&quot;https://laf.dev&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;systemEnv&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;openapiPrefix&quot;</span>: <span class="string">&quot;fastgpt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;vectorMaxProcess&quot;</span>: 15,</span><br><span class="line">    <span class="string">&quot;qaMaxProcess&quot;</span>: 15,</span><br><span class="line">    <span class="string">&quot;pgHNSWEfSearch&quot;</span>: 100</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;llmModels&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;model&quot;</span>: <span class="string">&quot;qwen-turbo&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;通义千问&quot;</span>,</span><br><span class="line">      <span class="string">&quot;maxContext&quot;</span>: 16000,</span><br><span class="line">      <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;/imgs/model/openai.svg&quot;</span>,</span><br><span class="line">      <span class="string">&quot;maxResponse&quot;</span>: 4000,</span><br><span class="line">      <span class="string">&quot;quoteMaxToken&quot;</span>: 13000,</span><br><span class="line">      <span class="string">&quot;maxTemperature&quot;</span>: 1.2,</span><br><span class="line">      <span class="string">&quot;charsPointsPrice&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;censor&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;vision&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;datasetProcess&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInClassify&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInExtractFields&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInToolCall&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInQueryExtension&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;toolChoice&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;functionCall&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;customCQPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;customExtractPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultSystemChatPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultConfig&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;model&quot;</span>: <span class="string">&quot;qwen-plus&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;qwen-plus&quot;</span>,</span><br><span class="line">      <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;/imgs/model/openai.svg&quot;</span>,</span><br><span class="line">      <span class="string">&quot;maxContext&quot;</span>: 125000,</span><br><span class="line">      <span class="string">&quot;maxResponse&quot;</span>: 4000,</span><br><span class="line">      <span class="string">&quot;quoteMaxToken&quot;</span>: 100000,</span><br><span class="line">      <span class="string">&quot;maxTemperature&quot;</span>: 1.2,</span><br><span class="line">      <span class="string">&quot;charsPointsPrice&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;censor&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;vision&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;datasetProcess&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;usedInClassify&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInExtractFields&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInToolCall&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInQueryExtension&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;toolChoice&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;functionCall&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;customCQPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;customExtractPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultSystemChatPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultConfig&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;model&quot;</span>: <span class="string">&quot;qwen-max&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;qwen-max&quot;</span>,</span><br><span class="line">      <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;/imgs/model/openai.svg&quot;</span>,</span><br><span class="line">      <span class="string">&quot;maxContext&quot;</span>: 128000,</span><br><span class="line">      <span class="string">&quot;maxResponse&quot;</span>: 4000,</span><br><span class="line">      <span class="string">&quot;quoteMaxToken&quot;</span>: 100000,</span><br><span class="line">      <span class="string">&quot;maxTemperature&quot;</span>: 1.2,</span><br><span class="line">      <span class="string">&quot;charsPointsPrice&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;censor&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;vision&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;datasetProcess&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;usedInClassify&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;usedInExtractFields&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;usedInToolCall&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;usedInQueryExtension&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;toolChoice&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;functionCall&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;customCQPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;customExtractPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultSystemChatPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultConfig&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;vectorModels&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;model&quot;</span>: <span class="string">&quot;qwen-max-longcontext&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;qwen-max-longcontext&quot;</span>,</span><br><span class="line">      <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;/imgs/model/openai.svg&quot;</span>,</span><br><span class="line">      <span class="string">&quot;charsPointsPrice&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;defaultToken&quot;</span>: 512,</span><br><span class="line">      <span class="string">&quot;maxToken&quot;</span>: 3000,</span><br><span class="line">      <span class="string">&quot;weight&quot;</span>: 100,</span><br><span class="line">      <span class="string">&quot;dbConfig&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">&quot;queryConfig&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;reRankModels&quot;</span>: [],</span><br><span class="line">  <span class="string">&quot;audioSpeechModels&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;model&quot;</span>: <span class="string">&quot;qwen-1.8b-chat&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;qwen-1.8b-chat&quot;</span>,</span><br><span class="line">      <span class="string">&quot;charsPointsPrice&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;voices&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Alloy&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;alloy&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Alloy&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Echo&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;echo&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Echo&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Fable&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;fable&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Fable&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Onyx&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;onyx&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Onyx&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Nova&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;nova&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Nova&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Shimmer&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;shimmer&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Shimmer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;whisperModel&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;model&quot;</span>: <span class="string">&quot;whisper-1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Whisper1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;charsPointsPrice&quot;</span>: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="openai-chatgpt版config配置"><a href="#openai-chatgpt版config配置" class="headerlink" title="openai chatgpt版config配置"></a>openai chatgpt版config配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;feConfigs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;lafEnv&quot;</span>: <span class="string">&quot;https://laf.dev&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;systemEnv&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;openapiPrefix&quot;</span>: <span class="string">&quot;fastgpt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;vectorMaxProcess&quot;</span>: 15,</span><br><span class="line">    <span class="string">&quot;qaMaxProcess&quot;</span>: 15,</span><br><span class="line">    <span class="string">&quot;pgHNSWEfSearch&quot;</span>: 100</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;llmModels&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;model&quot;</span>: <span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">      <span class="string">&quot;maxContext&quot;</span>: 16000,</span><br><span class="line">      <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;/imgs/model/openai.svg&quot;</span>,</span><br><span class="line">      <span class="string">&quot;maxResponse&quot;</span>: 4000,</span><br><span class="line">      <span class="string">&quot;quoteMaxToken&quot;</span>: 13000,</span><br><span class="line">      <span class="string">&quot;maxTemperature&quot;</span>: 1.2,</span><br><span class="line">      <span class="string">&quot;charsPointsPrice&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;censor&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;vision&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;datasetProcess&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInClassify&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInExtractFields&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInToolCall&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInQueryExtension&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;toolChoice&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;functionCall&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;customCQPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;customExtractPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultSystemChatPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultConfig&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;model&quot;</span>: <span class="string">&quot;gpt-4-0125-preview&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;gpt-4-turbo&quot;</span>,</span><br><span class="line">      <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;/imgs/model/openai.svg&quot;</span>,</span><br><span class="line">      <span class="string">&quot;maxContext&quot;</span>: 125000,</span><br><span class="line">      <span class="string">&quot;maxResponse&quot;</span>: 4000,</span><br><span class="line">      <span class="string">&quot;quoteMaxToken&quot;</span>: 100000,</span><br><span class="line">      <span class="string">&quot;maxTemperature&quot;</span>: 1.2,</span><br><span class="line">      <span class="string">&quot;charsPointsPrice&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;censor&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;vision&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;datasetProcess&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;usedInClassify&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInExtractFields&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInToolCall&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;usedInQueryExtension&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;toolChoice&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;functionCall&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;customCQPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;customExtractPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultSystemChatPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultConfig&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;model&quot;</span>: <span class="string">&quot;gpt-4-vision-preview&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;gpt-4-vision&quot;</span>,</span><br><span class="line">      <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;/imgs/model/openai.svg&quot;</span>,</span><br><span class="line">      <span class="string">&quot;maxContext&quot;</span>: 128000,</span><br><span class="line">      <span class="string">&quot;maxResponse&quot;</span>: 4000,</span><br><span class="line">      <span class="string">&quot;quoteMaxToken&quot;</span>: 100000,</span><br><span class="line">      <span class="string">&quot;maxTemperature&quot;</span>: 1.2,</span><br><span class="line">      <span class="string">&quot;charsPointsPrice&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;censor&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;vision&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;datasetProcess&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;usedInClassify&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;usedInExtractFields&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;usedInToolCall&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;usedInQueryExtension&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;toolChoice&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;functionCall&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;customCQPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;customExtractPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultSystemChatPrompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;defaultConfig&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;vectorModels&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;model&quot;</span>: <span class="string">&quot;text-embedding-ada-002&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Embedding-2&quot;</span>,</span><br><span class="line">      <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;/imgs/model/openai.svg&quot;</span>,</span><br><span class="line">      <span class="string">&quot;charsPointsPrice&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;defaultToken&quot;</span>: 512,</span><br><span class="line">      <span class="string">&quot;maxToken&quot;</span>: 3000,</span><br><span class="line">      <span class="string">&quot;weight&quot;</span>: 100,</span><br><span class="line">      <span class="string">&quot;dbConfig&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">&quot;queryConfig&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;reRankModels&quot;</span>: [],</span><br><span class="line">  <span class="string">&quot;audioSpeechModels&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;model&quot;</span>: <span class="string">&quot;tts-1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;OpenAI TTS1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;charsPointsPrice&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;voices&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Alloy&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;alloy&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Alloy&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Echo&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;echo&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Echo&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Fable&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;fable&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Fable&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Onyx&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;onyx&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Onyx&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Nova&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;nova&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Nova&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;label&quot;</span>: <span class="string">&quot;Shimmer&quot;</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="string">&quot;shimmer&quot;</span>,</span><br><span class="line">          <span class="string">&quot;bufferId&quot;</span>: <span class="string">&quot;openai-Shimmer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;whisperModel&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;model&quot;</span>: <span class="string">&quot;whisper-1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Whisper1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;charsPointsPrice&quot;</span>: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ollama本地大模型+向量模型版</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;feConfigs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;lafEnv&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://laf.dev&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;systemEnv&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;openapiPrefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fastgpt&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;vectorMaxProcess&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;qaMaxProcess&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pgHNSWEfSearch&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;llmModels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qwen2:0.5b&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qwen2:0.5b&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxContext&quot;</span><span class="punctuation">:</span> <span class="number">16000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/imgs/model/openai.svg&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxResponse&quot;</span><span class="punctuation">:</span> <span class="number">4000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;quoteMaxToken&quot;</span><span class="punctuation">:</span> <span class="number">13000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxTemperature&quot;</span><span class="punctuation">:</span> <span class="number">1.2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;charsPointsPrice&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;censor&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vision&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;datasetProcess&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInClassify&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInExtractFields&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInToolCall&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInQueryExtension&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;toolChoice&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;functionCall&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;customCQPrompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;customExtractPrompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;defaultSystemChatPrompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;defaultConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qwen-plus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qwen-plus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/imgs/model/openai.svg&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxContext&quot;</span><span class="punctuation">:</span> <span class="number">125000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxResponse&quot;</span><span class="punctuation">:</span> <span class="number">4000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;quoteMaxToken&quot;</span><span class="punctuation">:</span> <span class="number">100000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxTemperature&quot;</span><span class="punctuation">:</span> <span class="number">1.2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;charsPointsPrice&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;censor&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vision&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;datasetProcess&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInClassify&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInExtractFields&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInToolCall&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInQueryExtension&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;toolChoice&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;functionCall&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;customCQPrompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;customExtractPrompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;defaultSystemChatPrompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;defaultConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qwen-max&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qwen-max&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/imgs/model/openai.svg&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxContext&quot;</span><span class="punctuation">:</span> <span class="number">128000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxResponse&quot;</span><span class="punctuation">:</span> <span class="number">4000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;quoteMaxToken&quot;</span><span class="punctuation">:</span> <span class="number">100000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxTemperature&quot;</span><span class="punctuation">:</span> <span class="number">1.2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;charsPointsPrice&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;censor&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vision&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;datasetProcess&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInClassify&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInExtractFields&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInToolCall&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedInQueryExtension&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;toolChoice&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;functionCall&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;customCQPrompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;customExtractPrompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;defaultSystemChatPrompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;defaultConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;vectorModels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nomic-embed-text:latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nomic-embed-text:latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/imgs/model/openai.svg&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;charsPointsPrice&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;defaultToken&quot;</span><span class="punctuation">:</span> <span class="number">512</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxToken&quot;</span><span class="punctuation">:</span> <span class="number">3000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dbConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;queryConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reRankModels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;audioSpeechModels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qwen-1.8b-chat&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qwen-1.8b-chat&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;charsPointsPrice&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;voices&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alloy&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alloy&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;bufferId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openai-Alloy&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Echo&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;bufferId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openai-Echo&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fable&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fable&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;bufferId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openai-Fable&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Onyx&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;onyx&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;bufferId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openai-Onyx&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Nova&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nova&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;bufferId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openai-Nova&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Shimmer&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shimmer&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;bufferId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openai-Shimmer&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;whisperModel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;whisper-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Whisper1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;charsPointsPrice&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="fastgpt启动"><a href="#fastgpt启动" class="headerlink" title="fastgpt启动"></a>fastgpt启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><h3 id="三-扩展与fastgpt对接ollama本地大模型"><a href="#三-扩展与fastgpt对接ollama本地大模型" class="headerlink" title="三 扩展与fastgpt对接ollama本地大模型"></a>三 扩展与fastgpt对接ollama本地大模型</h3><h4 id="one-api与fastgpt在一个部署文件中集成（推荐使用此种）"><a href="#one-api与fastgpt在一个部署文件中集成（推荐使用此种）" class="headerlink" title="one-api与fastgpt在一个部署文件中集成（推荐使用此种）"></a>one-api与fastgpt在一个部署文件中集成（推荐使用此种）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">pg:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ankane/pgvector:v0.5.0</span> <span class="comment"># git</span></span><br><span class="line">    <span class="comment"># image: registry.cn-hangzhou.aliyuncs.com/fastgpt/pgvector:v0.5.0 # 阿里云</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">pg</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span> <span class="comment"># 生产环境建议不要暴露</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5432</span><span class="string">:5432</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">fastgpt</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># 这里的配置只有首次运行生效。修改后，重启镜像是不会生效的。需要把持久化数据删除再重启，才有效果</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_USER=username</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_PASSWORD=password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_DB=postgres</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./pg/data:/var/lib/postgresql/data</span></span><br><span class="line">  <span class="attr">mongo:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/fastgpt/mongo:5.0.18</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mongo</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">27017</span><span class="string">:27017</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">fastgpt</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">mongod</span> <span class="string">--keyFile</span> <span class="string">/data/mongodb.key</span> <span class="string">--replSet</span> <span class="string">rs0</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MONGO_INITDB_ROOT_USERNAME=myusername</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MONGO_INITDB_ROOT_PASSWORD=mypassword</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mongo/data:/data/db</span></span><br><span class="line">    <span class="attr">entrypoint:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bash</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">        openssl rand -base64 128 &gt; /data/mongodb.key</span></span><br><span class="line"><span class="string">        chmod 400 /data/mongodb.key</span></span><br><span class="line"><span class="string">        chown 999:999 /data/mongodb.key</span></span><br><span class="line"><span class="string">        echo &#x27;const isInited = rs.status().ok === 1</span></span><br><span class="line"><span class="string">        if(!isInited)&#123;</span></span><br><span class="line"><span class="string">          rs.initiate(&#123;</span></span><br><span class="line"><span class="string">              _id: &quot;rs0&quot;,</span></span><br><span class="line"><span class="string">              members: [</span></span><br><span class="line"><span class="string">                  &#123; _id: 0, host: &quot;mongo:27017&quot; &#125;</span></span><br><span class="line"><span class="string">              ]</span></span><br><span class="line"><span class="string">          &#125;)</span></span><br><span class="line"><span class="string">        &#125;&#x27; &gt; /data/initReplicaSet.js</span></span><br><span class="line"><span class="string">        # 启动MongoDB服务</span></span><br><span class="line"><span class="string">        exec docker-entrypoint.sh &quot;$$@&quot; &amp;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">        <span class="comment"># 等待MongoDB服务启动</span></span><br><span class="line">        <span class="string">until</span> <span class="string">mongo</span> <span class="string">-u</span> <span class="string">myusername</span> <span class="string">-p</span> <span class="string">mypassword</span> <span class="string">--authenticationDatabase</span> <span class="string">admin</span> <span class="string">--eval</span> <span class="string">&quot;print(&#x27;waited for connection&#x27;)&quot;</span> <span class="string">&gt;</span> <span class="string">/dev/null</span> <span class="number">2</span><span class="string">&gt;&amp;1;</span> <span class="string">do</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Waiting for MongoDB to start...&quot;</span></span><br><span class="line">          <span class="string">sleep</span> <span class="number">2</span></span><br><span class="line">        <span class="string">done</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 执行初始化副本集的脚本</span></span><br><span class="line">        <span class="string">mongo</span> <span class="string">-u</span> <span class="string">myusername</span> <span class="string">-p</span> <span class="string">mypassword</span> <span class="string">--authenticationDatabase</span> <span class="string">admin</span> <span class="string">/data/initReplicaSet.js</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 等待docker-entrypoint.sh脚本执行的MongoDB服务进程</span></span><br><span class="line">        <span class="string">wait</span> <span class="string">$$!</span></span><br><span class="line">  <span class="attr">fastgpt:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">fastgpt</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt:v4.7</span> <span class="comment"># git</span></span><br><span class="line">    <span class="comment"># image: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt:v4.7 # 阿里云</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">30001</span><span class="string">:3000</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">fastgpt</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pg</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># root 密码，用户名为: root。如果需要修改 root 密码，直接修改这个环境变量，并重启即可。</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEFAULT_ROOT_PSW=1234</span></span><br><span class="line">      <span class="comment"># AI模型的API地址哦。务必加 /v1。这里默认填写了OneApi的访问地址。</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">OPENAI_BASE_URL=http://one-api:3000/v1</span>                     <span class="comment">#(此地址为oneapi地址+/v1)</span></span><br><span class="line">      <span class="comment"># AI模型的API Key。（这里默认填写了OneAPI的快速默认key，测试通后，务必及时修改）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CHAT_API_KEY=sk-74E561</span>  <span class="comment">#(此key为one-api生成的令牌)</span></span><br><span class="line">      <span class="comment"># 数据库最大连接数</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_MAX_LINK=30</span></span><br><span class="line">      <span class="comment"># 登录凭证密钥</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TOKEN_KEY=any</span></span><br><span class="line">      <span class="comment"># root的密钥，常用于升级时候的初始化请求</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ROOT_KEY=root_key</span></span><br><span class="line">      <span class="comment"># 文件阅读加密</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">FILE_TOKEN_KEY=filetoken</span></span><br><span class="line">      <span class="comment"># MongoDB 连接参数. 用户名myusername,密码mypassword。</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MONGODB_URI=mongodb://myusername:mypassword@mongo:27017/fastgpt?authSource=admin</span></span><br><span class="line">      <span class="comment"># pg 连接参数</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PG_URL=postgresql://username:password@pg:5432/postgres</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.json:/app/data/config.json</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./fastgpt/tmp:/app/tmp</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">one-api:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:one-api-latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">one-api</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./one-api:/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">fastgpt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">fastgpt:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>对接本地大模型+向量模型注意事项：</strong></p><ul><li>oneapi新增渠道 填入向量模型 及本地大模型</li><li>通过此渠道新建令牌 并将令牌key负载到渠道密钥处 保存</li><li>渠道模型需要手动填入不要选择上方的 否则无法获取</li><li>fastgpt config.json文件将大模型及向量模型填入 本文使用向量模型为<code>nomic-embed-text:latest</code></li></ul><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_032b3fcee57bdf2b60ae8989041ed7a0.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/8/image_032b3fcee57bdf2b60ae8989041ed7a0.png"></p><p><code>nomic-embed-text:latest</code>向量模型部署方式<code>ollama pull nomic-embed-text:latest</code></p><p>模型官网：<a href="https://ollama.com/library/nomic-embed-text:latest">https://ollama.com/library/nomic-embed-text:latest</a></p><p>此处参考：<a href="https://www.bilibili.com/video/BV1bz421S79Y/?t=727.194668&spm_id_from=333.1350.jump_directly&vd_source=f2da0b118b0745da0dcde264fed6ee35">fastgpt喂饭教程-最强AI知识库_哔哩哔哩_bilibili</a></p><h4 id="fastgpt更换logo"><a href="#fastgpt更换logo" class="headerlink" title="fastgpt更换logo"></a>fastgpt更换logo</h4><p>[其他logo更换参考 | &gt; (<a href="https://doc.fastai.site/docs/development/configuration/">配置文件介绍 | FastGPT (fastai.site)</a>)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> ./logo.svg fastgpt:/app/projects/app/public/icon</span><br><span class="line">docker <span class="built_in">cp</span> ./favicon.ico fastgpt:/app/projects/app/public/</span><br></pre></td></tr></table></figure><h2 id="四-效果"><a href="#四-效果" class="headerlink" title="四 效果"></a>四 效果</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_3390fff9c5b4e790c31ef176e89a5c27.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_3390fff9c5b4e790c31ef176e89a5c27.png"></p><h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a href="https://doc.fastai.site/docs/development/docker/">官网</a></p><p><a href="https://blog.csdn.net/m0_62536353/article/details/135733446">保姆级教程：FastGPT构建个人本地知识库(Docker compose快速部署)_fastgpt本地部署-CSDN博客</a></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>one-api及oen-api-plus部署及使用</title>
      <link href="/2024/04/09/one-api%E5%8F%8Aone-api-plus%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/04/09/one-api%E5%8F%8Aone-api-plus%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="one-api及oen-api-plus部署及使用"><a href="#one-api及oen-api-plus部署及使用" class="headerlink" title="one-api及oen-api-plus部署及使用"></a>one-api及oen-api-plus部署及使用</h1><blockquote><p>调用的接口是国外的例如chatgpt时需要配置代理或者使用国外服务器</p><p>初始密码：root/123456</p></blockquote><h2 id="使用docker-compose部署"><a href="#使用docker-compose部署" class="headerlink" title="使用docker-compose部署"></a>使用docker-compose部署</h2><h3 id="镜像可选"><a href="#镜像可选" class="headerlink" title="镜像可选"></a>镜像可选</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">justsong/one-api:latest </span><br><span class="line">image: registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:one-api-latest</span><br></pre></td></tr></table></figure><h3 id="docker方式"><a href="#docker方式" class="headerlink" title="docker方式"></a>docker方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 SQLite 的部署命令：</span></span><br><span class="line">docker run --name one-api -d --restart always -p 3000:3000 -e TZ=Asia/Shanghai -v /home/ubuntu/data/one-api:/data justsong/one-api</span><br><span class="line"><span class="comment"># 使用 MySQL 的部署命令，在上面的基础上添加 `-e SQL_DSN=&quot;root:123456@tcp(localhost:3306)/oneapi&quot;`，请自行修改数据库连接参数，不清楚如何修改请参见下面环境变量一节。</span></span><br><span class="line"><span class="comment"># 例如：</span></span><br><span class="line">docker run --name one-api -d --restart always -p 3000:3000 -e SQL_DSN=<span class="string">&quot;root:123456@tcp(localhost:3306)/oneapi&quot;</span> -e TZ=Asia/Shanghai -v /home/ubuntu/data/one-api:/data justsong/one-api</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="docker-compose方式"><a href="#docker-compose方式" class="headerlink" title="docker-compose方式"></a>docker-compose方式</h2><p>使用mysql作为数据库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  one-api:</span><br><span class="line">    container_name: one-api</span><br><span class="line">    image: justsong/one-api</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      - SQL_DSN=root:123456@tcp(localhost:3306)/oneapi</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">    volumes:</span><br><span class="line">      - ./one-api:/data</span><br></pre></td></tr></table></figure><p>使用SQlite作为数据库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  one-api:</span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:one-api-latest</span><br><span class="line">    container_name: one-api</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">    volumes:</span><br><span class="line">      - ./one-api:/data</span><br></pre></td></tr></table></figure><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_a09a324c0e01b3dc1c96ba17b2b32f1b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_a09a324c0e01b3dc1c96ba17b2b32f1b.png"></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><blockquote><p><a href="%5Bhttps://doc.fastai.site/docs/development/one-api/%5D(https://doc.fastai.site/docs/development/one-api/)">见链接 | &gt;&gt;</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_f34a8621031f3fc757073165acc4903d.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_f34a8621031f3fc757073165acc4903d.png"></p><p><strong>对接chat-next-web只需要填写如下即可</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_41dd190facdda36a483473f4b9721848.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_41dd190facdda36a483473f4b9721848.png"></p></blockquote><h2 id="oneapi-对接ollama"><a href="#oneapi-对接ollama" class="headerlink" title="oneapi 对接ollama"></a>oneapi 对接ollama</h2><p><a href="http://t.csdnimg.cn/9zk1x">http://t.csdnimg.cn/9zk1x</a></p><p>本地大模型需要在方框内手动填入否则无法检索会报错找不到</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_55f1658c77b591edcfaa012730ebe5ed.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_55f1658c77b591edcfaa012730ebe5ed.png"></p><p>备注：当对接fastgpt时需要部署一个向量模型以及一个大模型 创建的渠道导入两个模型  并且创建令牌时 不能选择模型范围否则会报错返回为空</p><p>成功</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_2c937edb6f72a54bff00c3176f397e65.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/7/image_2c937edb6f72a54bff00c3176f397e65.png"></p><h2 id="扩展one-api-plus"><a href="#扩展one-api-plus" class="headerlink" title="扩展one-api-plus"></a>扩展one-api-plus</h2><p>此项目是大佬魔改one-api的一个项目界面美观 好用 使用方法与上方one-api相同</p><p>托管地址：<a href="https://github.com/MartialBE/one-hub">https://github.com/MartialBE/one-hub</a></p><p><strong>部署方法</strong></p><p>git到本地后 docker-compose up -d即可</p><p>git clone <a href="https://github.com/MartialBE/one-hub.git">https://github.com/MartialBE/one-hub.git</a></p><p>或</p><p>git clone <a href="https://github.com/GEGEWU-CLOUD/one-api-plus.git">https://github.com/GEGEWU-CLOUD/one-api-plus.git</a></p><h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a href="https://cloud.sealos.io/">使用sealos一键部署和使用oneapi（相对简单略）</a></p><p><a href="%5Bhttps://github.com/GEGEWU-CLOUD/one-api%5D(https://github.com/GEGEWU-CLOUD/one-api)">使用docker部署</a></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu配置网卡bond版 openstack部署</title>
      <link href="/2024/04/02/ubuntu%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1bond%E7%89%88%20openstack%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/04/02/ubuntu%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1bond%E7%89%88%20openstack%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="ubuntu配置网卡bond版-openstack部署"><a href="#ubuntu配置网卡bond版-openstack部署" class="headerlink" title="ubuntu配置网卡bond版 openstack部署"></a>ubuntu配置网卡bond版 openstack部署</h1><blockquote><p>环境：8C24G windows10家庭版 workstdtion17 pro ubuntu20.04</p><p><del>由于电脑性能原因此次使用单节点测试</del></p></blockquote><h2 id="一-ubuntu网卡bond配置"><a href="#一-ubuntu网卡bond配置" class="headerlink" title="一. ubuntu网卡bond配置"></a>一. ubuntu网卡bond配置</h2><p>见链接 | ：<a href="http://sunlight.zznnwn.cloudns.biz/2024/04/02/workstdtion%E6%A8%A1%E6%8B%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%88%92%E5%88%86vlan%E5%8F%8A%E7%BD%91%E5%8D%A1bond%E8%AE%BE%E7%BD%AE">workstdtion模拟交换机划分vlan及网卡bond设置</a></p><h2 id="二-两或单副本ceph部署"><a href="#二-两或单副本ceph部署" class="headerlink" title="二. 两或单副本ceph部署"></a>二. 两或单副本ceph部署</h2><p>脚本部署方式见链接 | ：<a href="https://gegewu-cloud.github.io/2023/09/24/ceph%E9%9B%86%E7%BE%A4%E4%B9%8Bcephadm%E6%B8%85%E7%90%86ceph%E9%9B%86%E7%BE%A4/">ceph一键部署</a></p><p>备注<strong>ceph</strong>网络选择： –mon-ip  <del>10.56.60.11</del>  –cluster-network <del>10.56.50.0/24</del>  –allow-overwrite</p><h2 id="三-两或单副本openstack部署"><a href="#三-两或单副本openstack部署" class="headerlink" title="三. 两或单副本openstack部署"></a>三. 两或单副本openstack部署</h2><h3 id="1-global-yml文件配置-网络与一中保持一致"><a href="#1-global-yml文件配置-网络与一中保持一致" class="headerlink" title="1. global.yml文件配置 网络与一中保持一致"></a>1. global.yml文件配置 网络与一中保持一致</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -------------------&lt;&lt;分割线&gt;&gt;------------------------</span></span><br><span class="line"><span class="comment"># kolla-ansible global.yml配置</span></span><br><span class="line">kolla_base_distro: <span class="string">&quot;ubuntu&quot;</span></span><br><span class="line">kolla_install_type: <span class="string">&quot;source&quot;</span></span><br><span class="line">openstack_release: <span class="string">&quot;zznnyoga&quot;</span></span><br><span class="line">nova_compute_virt_type: <span class="string">&quot;qemu&quot;</span></span><br><span class="line">node_custom_config: <span class="string">&quot;/etc/kolla/config&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置私有阿里云仓库</span></span><br><span class="line">docker_registry: <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span>     <span class="comment"># 拉取 docker 镜像的源</span></span><br><span class="line">docker_namespace: <span class="string">&quot;zznn&quot;</span>                                 <span class="comment"># docker registry 项目名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 外部ceph配置 （ workstdtion ens33 nat模式 ）</span></span><br><span class="line">swift_storage_interface: <span class="string">&quot;vlan60&quot;</span>             <span class="comment"># ceph 存储网络的接口 (ceph public network 所在接口)</span></span><br><span class="line"><span class="comment"># external_ceph_pool_pgs: 16                  # (hdd osd 个数) * 3 的值最接近 2^n 的数, 例如 hdd osd 个数为 12, 则 external_ceph_pool_pgs 取 32</span></span><br><span class="line"><span class="comment"># external_ceph_ssd_pool_pgs: 32              # (ssd osd 个数) * 3 的值最接近 2^n 的数, 如果没有 ssd, 则可忽略该配置</span></span><br><span class="line">failed_swap_on: <span class="string">&quot;yes&quot;</span>                        <span class="comment"># 默认禁止开启 swap</span></span><br><span class="line">enable_external_ceph: <span class="string">&quot;yes&quot;</span>                  <span class="comment"># 开启外部ceph</span></span><br><span class="line">external_ceph_admin_permission: <span class="string">&quot;yes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># openstack内部接口配置 （ens33 nat模式 ens37 主机模式（ 其实此处ens37应该使用外部IP即使用 桥接模式的ens38 但vmware环境这样也行 因为windows端可以ping通主机模式生成的IP ））</span></span><br><span class="line">keepalived_virtual_router_id: <span class="string">&quot;99&quot;</span>           <span class="comment"># keepalived 唯一的 ID，需要和局域网内其他  keepalived ID 不一致, 取值范围 0~255</span></span><br><span class="line">kolla_internal_vip_address: <span class="string">&quot;10.56.70.100&quot;</span>   <span class="comment"># 内部 vip ，需要和 /etc/hosts 中的 IP 网段一致 （workstdtion实验环境划分lan区段20只能内部通信 ）</span></span><br><span class="line">network_interface: <span class="string">&quot;vlan70&quot;</span>                   <span class="comment"># 内部 vip 接口，服务器内部通讯地址</span></span><br><span class="line">kolla_external_vip_address: <span class="string">&quot;192.168.1.99&quot;</span>   <span class="comment"># 外部 vip，用于 horizon dashboard 界面操作等(若开启高可用：enable_haproxy: &quot;yes&quot;需要配置为没有占用的ip)</span></span><br><span class="line">horizon_port: <span class="string">&quot;10000&quot;</span>                    <span class="comment"># dashboard 的端口</span></span><br><span class="line">kolla_external_vip_interface: <span class="string">&quot;bond3&quot;</span>    <span class="comment"># 外部 vip 接口, 若该网卡划分了 vlan，则需要填写配置外网的子接口workstdtion模拟ens38桥接模式网卡为192.168.31段</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他配置</span></span><br><span class="line"><span class="comment"># kolla_external_vip_interface: &quot;&#123;&#123; network_interface &#125;&#125;&quot;</span></span><br><span class="line">api_interface: <span class="string">&quot;&#123;&#123; network_interface &#125;&#125;&quot;</span></span><br><span class="line">storage_interface: <span class="string">&quot;&#123;&#123; network_interface &#125;&#125;&quot;</span></span><br><span class="line">cluster_interface: <span class="string">&quot;&#123;&#123; network_interface &#125;&#125;&quot;</span></span><br><span class="line">tunnel_interface: <span class="string">&quot;&#123;&#123; network_interface &#125;&#125;&quot;</span></span><br><span class="line">dns_interface: <span class="string">&quot;&#123;&#123; network_interface &#125;&#125;&quot;</span></span><br><span class="line"><span class="comment"># neutron_external_interface: &quot;ens38&quot; # 访问openstack的物理网卡不需要配置IP，业务口</span></span><br><span class="line">neutron_plugin_agent: <span class="string">&quot;openvswitch&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 外网设置（ ens38 nat模式 此处ens38为业务口不配置IP 采用办公网192.168.31段作为外网 接线接办公网的光纤或网线 ）</span></span><br><span class="line"><span class="comment"># neutron_external_interface: &quot;ens38&quot;      # flat 网络使用的物理网卡,若需要连接专网</span></span><br><span class="line">neutron_external_interface: <span class="string">&quot;bond2,vlan80&quot;</span>        <span class="comment"># workstdtion模拟桥接模式网卡 用于模拟外网可配置网络也可不配置 物理服务器需要接外网网线</span></span><br><span class="line">neutron_bridge_name: <span class="string">&quot;&#123;% for i in range(neutron_external_interface.split(&#x27;,&#x27;)|length) %&#125;br-ex&#123;&#123; loop.index0 + 1 &#125;&#125;&#123;% if not loop.last %&#125;,&#123;% endif %&#125;&#123;% endfor %&#125;&quot;</span></span><br><span class="line"><span class="comment"># 网桥名字, neutron_external_interface 有多少个接口就要指定多少个网桥名称</span></span><br><span class="line">enable_neutron_dns: <span class="string">&quot;no&quot;</span>                                  <span class="comment"># neutron 是否开启 dns, 如果开启 dns, 可能遭受 dns 反射型 ddos 攻击, 如果不开启, horizon 中创建子网时需要指定公共 dns, 如 223.5.5.5</span></span><br><span class="line">enable_neutron_mtu_1550: <span class="string">&quot;no&quot;</span>                             <span class="comment"># 不要修改该参数，否则可能会带来一些网络问题</span></span><br><span class="line">enable_neutron_ext_net: <span class="string">&quot;yes&quot;</span>                             <span class="comment"># 是否自动创建 flat 网络</span></span><br><span class="line">neutron_ext_net_cidr: <span class="string">&quot;192.168.1.0/24&quot;</span></span><br><span class="line">neutron_ext_net_range: <span class="string">&quot;start=192.168.1.70,end=192.168.1.120&quot;</span></span><br><span class="line">neutron_ext_net_gateway: <span class="string">&quot;192.168.1.1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用时钟检查(可选)</span></span><br><span class="line"><span class="comment"># prechecks_enable_host_ntp_checks: &quot;false&quot;</span></span><br><span class="line"><span class="comment"># skyline可选</span></span><br><span class="line"><span class="comment"># enable_skyline: &quot;yes&quot;</span></span><br><span class="line"><span class="comment"># 其他配置</span></span><br><span class="line">enable_ceph: <span class="string">&quot;no&quot;</span></span><br><span class="line">enable_haproxy: <span class="string">&quot;yes&quot;</span></span><br><span class="line">enable_chrony: <span class="string">&quot;yes&quot;</span></span><br><span class="line"><span class="comment"># enable_mariabackup: &quot;no&quot;</span></span><br><span class="line"><span class="comment"># enable_ceph_rgw: &quot;yes&quot;</span></span><br><span class="line">enable_cinder: <span class="string">&quot;yes&quot;</span></span><br><span class="line">enable_manila_backend_cephfs_native: <span class="string">&quot;yes&quot;</span></span><br><span class="line"><span class="comment"># enable_neutron_qos: &quot;yes&quot;  </span></span><br><span class="line"><span class="comment"># enable_ceph_rgw_keystone: &quot;yes&quot;</span></span><br><span class="line">glance_backend_ceph: <span class="string">&quot;yes&quot;</span></span><br><span class="line">glance_enable_rolling_upgrade: <span class="string">&quot;no&quot;</span></span><br><span class="line">gnocchi_backend_storage: <span class="string">&quot;ceph&quot;</span></span><br><span class="line">cinder_backend_ceph: <span class="string">&quot;yes&quot;</span></span><br><span class="line">nova_backend_ceph: <span class="string">&quot;yes&quot;</span></span><br><span class="line">ironic_dnsmasq_dhcp_range:</span><br><span class="line">tempest_image_id:</span><br><span class="line">tempest_flavor_ref_id:</span><br><span class="line">tempest_public_network_id:</span><br><span class="line">tempest_floating_network_name:</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------分割线--------------</span></span><br><span class="line"><span class="comment"># 2023.10.30新增(新增vpn qos 数据库) ---------------------&gt;&gt; 下方新增配置------------</span></span><br><span class="line">enable_neutron_dvr: <span class="string">&quot;yes&quot;</span>                <span class="comment"># 您启用了 OpenStack Neutron 的 DVR（Distributed Virtual Router）功能。DVR 是一项功能，它允许虚拟路由器（Virtual Router）的数据面功能在计算节点上分布式执行，而不是集中执行在网络节点上。这有助于提高网络性能和扩展性。</span></span><br><span class="line">enable_neutron_vpnaas: <span class="string">&quot;yes&quot;</span>             <span class="comment"># vpn</span></span><br><span class="line">enable_neutron_qos: <span class="string">&quot;yes&quot;</span>                <span class="comment"># qos</span></span><br><span class="line">enable_nova_ssh: <span class="string">&quot;yes&quot;</span>                   <span class="comment"># 这允许用户通过 SSH 协议访问虚拟机实例，以进行远程管理和操作。</span></span><br><span class="line"><span class="comment"># enable_neutron_provider_networks: &quot;yes&quot;  # 提供者网络是一种网络类型，允许 OpenStack 租户连接到外部网络，通常是物理网络或其他外部网络服务。</span></span><br><span class="line"><span class="comment"># enable_trove: &quot;yes&quot;                      # Trove 是 OpenStack 的数据库即服务 </span></span><br></pre></td></tr></table></figure><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>可以看到此种方式即使是测试环境ceph osd写入速度也可以达到<del>1M/s</del>以上</p><p>注：此种测试时发现浮动IP无法使用原因如下</p><p>文件：</p><ul><li>/etc/kolla/neutron-server/ml2_conf.ini</li><li>/etc/kolla/neutron-openvswitch-agent/openvswitch_agent.ini</li><li>bond2 vlan80 与浮动IP网段均不在一起 bond2 上<del>网卡网口需要接与浮动IP同网段的网线</del> <strong>并且不能配置 IP</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看配置文件</span></span><br><span class="line"><span class="built_in">cat</span> /etc/kolla/neutron-openvswitch-agent/openvswitch_agent.ini</span><br><span class="line"></span><br><span class="line">[agent]</span><br><span class="line">tunnel_types = vxlan</span><br><span class="line">l2_population = <span class="literal">true</span></span><br><span class="line">arp_responder = <span class="literal">true</span></span><br><span class="line">enable_distributed_routing = True</span><br><span class="line">extensions = qos</span><br><span class="line"></span><br><span class="line">[securitygroup]</span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</span><br><span class="line"></span><br><span class="line">[ovs]</span><br><span class="line">bridge_mappings = physnet1:br-ex1,physnet2:br-ex2</span><br><span class="line">datapath_type = system</span><br><span class="line">ovsdb_connection = tcp:127.0.0.1:6640</span><br><span class="line">ovsdb_timeout = 10</span><br><span class="line">local_ip = 10.56.70.11     <span class="comment"># IP为56段IP但浮动IP为192.168段</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看交换机内部</span></span><br><span class="line">(venv3) root@ceph1:/etc/kolla/neutron-openvswitch-agent<span class="comment"># docker exec -it openvswitch_vswitchd bash</span></span><br><span class="line">(openvswitch-vswitchd)[root@ceph1 /]<span class="comment"># ovs-vsctl show</span></span><br><span class="line">0b40fa1b-d121-4e67-ae65-2a702169c162</span><br><span class="line">    Manager <span class="string">&quot;ptcp:6640:127.0.0.1&quot;</span></span><br><span class="line">        is_connected: <span class="literal">true</span></span><br><span class="line">    Bridge br-ex1</span><br><span class="line">        Controller <span class="string">&quot;tcp:127.0.0.1:6633&quot;</span></span><br><span class="line">            is_connected: <span class="literal">true</span></span><br><span class="line">        fail_mode: secure</span><br><span class="line">        datapath_type: system</span><br><span class="line">        Port br-ex1</span><br><span class="line">            Interface br-ex1</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port bond2                       <span class="comment"># 可以看到此处使用的外网网卡是bond2 但是此时bond2是</span></span><br><span class="line">            Interface bond2</span><br><span class="line">        Port phy-br-ex1</span><br><span class="line">            Interface phy-br-ex1</span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=int-br-ex1&#125;</span><br><span class="line">    Bridge br-ex2</span><br><span class="line">        Controller <span class="string">&quot;tcp:127.0.0.1:6633&quot;</span></span><br><span class="line">            is_connected: <span class="literal">true</span></span><br><span class="line">        fail_mode: secure</span><br><span class="line">        datapath_type: system</span><br><span class="line">        Port phy-br-ex2</span><br><span class="line">            Interface phy-br-ex2</span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=int-br-ex2&#125;</span><br><span class="line">        Port br-ex2</span><br><span class="line">            Interface br-ex2</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port vlan80</span><br><span class="line">            Interface vlan80</span><br><span class="line">    Bridge br-tun</span><br><span class="line">        Controller <span class="string">&quot;tcp:127.0.0.1:6633&quot;</span></span><br><span class="line">            is_connected: <span class="literal">true</span></span><br><span class="line">        fail_mode: secure</span><br><span class="line">        datapath_type: system</span><br><span class="line">        Port br-tun</span><br><span class="line">            Interface br-tun</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port patch-int</span><br><span class="line">            Interface patch-int</span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=patch-tun&#125;</span><br><span class="line">    Bridge br-int</span><br><span class="line">        Controller <span class="string">&quot;tcp:127.0.0.1:6633&quot;</span></span><br><span class="line">            is_connected: <span class="literal">true</span></span><br><span class="line">        fail_mode: secure</span><br><span class="line">        datapath_type: system</span><br><span class="line">        Port tapc4f556bc-44</span><br><span class="line">            tag: 3</span><br><span class="line">            Interface tapc4f556bc-44</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port patch-tun</span><br><span class="line">            Interface patch-tun</span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=patch-int&#125;</span><br><span class="line">        Port qvo0650711e-a1</span><br><span class="line">            tag: 2</span><br><span class="line">            Interface qvo0650711e-a1</span><br><span class="line">        Port int-br-ex1</span><br><span class="line">            Interface int-br-ex1</span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=phy-br-ex1&#125;</span><br><span class="line">        Port qg-97668e2d-78</span><br><span class="line">            tag: 3</span><br><span class="line">            Interface qg-97668e2d-78</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port int-br-ex2</span><br><span class="line">            Interface int-br-ex2</span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=phy-br-ex2&#125;</span><br><span class="line">        Port sg-02263924-70</span><br><span class="line">            tag: 2</span><br><span class="line">            Interface sg-02263924-70</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port tap823e4df9-c8</span><br><span class="line">            tag: 2</span><br><span class="line">            Interface tap823e4df9-c8</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port fg-69b4fc5a-cc</span><br><span class="line">            tag: 3</span><br><span class="line">            Interface fg-69b4fc5a-cc</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port br-int</span><br><span class="line">            Interface br-int</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port qr-69d003b3-f2</span><br><span class="line">            tag: 2</span><br><span class="line">            Interface qr-69d003b3-f2</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br></pre></td></tr></table></figure><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">(venv3)</span> <span class="string">root@ceph1:~#</span> <span class="string">cat</span> <span class="string">/etc/netplan/00-installer-config.yaml</span> </span><br><span class="line"><span class="comment"># This is the network config written by &#x27;subiquity&#x27;</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">ens33:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">ens37:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">ens38:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">ens39:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">ens40:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">ens41:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">ens42:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">ens43:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">bonds:</span></span><br><span class="line">    <span class="attr">bond0:</span></span><br><span class="line">      <span class="attr">addresses:</span> [<span class="string">&quot;10.56.50.11/24&quot;</span>]  <span class="comment"># 此网口用万兆口 用于ceph osd间通信（--cluster-network）</span></span><br><span class="line">      <span class="attr">interfaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ens37</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">802.</span><span class="string">3ad</span></span><br><span class="line">        <span class="attr">mii-monitor-interval:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">lacp-rate:</span> <span class="string">fast</span></span><br><span class="line">        <span class="attr">transmit-hash-policy:</span> <span class="string">layer3+4</span></span><br><span class="line">    <span class="attr">bond1:</span></span><br><span class="line">      <span class="attr">interfaces:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">ens38</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">802.</span><span class="string">3ad</span></span><br><span class="line">        <span class="attr">mii-monitor-interval:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">lacp-rate:</span> <span class="string">fast</span></span><br><span class="line">        <span class="attr">transmit-hash-policy:</span> <span class="string">layer3+4</span></span><br><span class="line">    <span class="attr">bond2:</span></span><br><span class="line">      <span class="attr">interfaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ens39</span>   <span class="comment"># 接与浮动IP同网段的网线</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">802.</span><span class="string">3ad</span></span><br><span class="line">        <span class="attr">mii-monitor-interval:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">lacp-rate:</span> <span class="string">fast</span></span><br><span class="line">        <span class="attr">transmit-hash-policy:</span> <span class="string">layer3+4</span></span><br><span class="line">    <span class="attr">bond3:</span></span><br><span class="line">      <span class="attr">addresses:</span> [<span class="string">&quot;192.168.1.10/24&quot;</span>]      <span class="comment"># 此网口用千兆口 &gt;&gt; 电口 用于远程连接 为浮动IP</span></span><br><span class="line">      <span class="attr">gateway4:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">interfaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ens33</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">802.</span><span class="string">3ad</span></span><br><span class="line">        <span class="attr">mii-monitor-interval:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">lacp-rate:</span> <span class="string">fast</span></span><br><span class="line">        <span class="attr">transmit-hash-policy:</span> <span class="string">layer3+4</span></span><br><span class="line">  <span class="attr">vlans:</span></span><br><span class="line">    <span class="attr">vlan60:</span></span><br><span class="line">      <span class="attr">id:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">link:</span> <span class="string">bond1</span></span><br><span class="line">      <span class="attr">addresses:</span> [<span class="string">&quot;10.56.60.11/24&quot;</span>]</span><br><span class="line">    <span class="attr">vlan70:</span></span><br><span class="line">      <span class="attr">id:</span> <span class="number">70</span></span><br><span class="line">      <span class="attr">link:</span> <span class="string">bond1</span></span><br><span class="line">      <span class="attr">addresses:</span> [<span class="string">&quot;10.56.70.11/24&quot;</span>]</span><br><span class="line">    <span class="attr">vlan80:</span></span><br><span class="line">      <span class="attr">id:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">link:</span> <span class="string">bond1</span></span><br><span class="line">      <span class="comment">#addresses: [&quot;10.56.80.11/24&quot;]  #浮动IP使用接口不配置IP</span></span><br><span class="line">    <span class="attr">vlan90:</span></span><br><span class="line">      <span class="attr">id:</span> <span class="number">90</span></span><br><span class="line">      <span class="attr">link:</span> <span class="string">bond1</span></span><br><span class="line">      <span class="attr">addresses:</span> [<span class="string">&quot;10.56.90.11/24&quot;</span>]</span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>此时问题解决。</p><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><h3 id="ceph状态"><a href="#ceph状态" class="headerlink" title="ceph状态"></a>ceph状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(venv3) root@ceph1:~# ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    id:     dc7fa486-f1a0-11ee-a64f-c194d5eb9f2e</span><br><span class="line">    health: HEALTH_WARN</span><br><span class="line">            5 pool(s) have no replicas configured</span><br><span class="line"> </span><br><span class="line">  services:</span><br><span class="line">    mon: 1 daemons, quorum ceph1 (age 62m)</span><br><span class="line">    mgr: ceph1.phqsba(active, since 62m)</span><br><span class="line">    osd: 1 osds: 1 up (since 62m), 1 in (since 2h)</span><br><span class="line"> </span><br><span class="line">  data:</span><br><span class="line">    pools:   5 pools, 129 pgs</span><br><span class="line">    objects: 157 objects, 220 MiB</span><br><span class="line">    usage:   111 MiB used, 20 GiB / 20 GiB avail</span><br><span class="line">    pgs:     129 active+clean</span><br></pre></td></tr></table></figure><h3 id="openstack创建实例验证效果-gt-gt"><a href="#openstack创建实例验证效果-gt-gt" class="headerlink" title="openstack创建实例验证效果 &gt;&gt;"></a>openstack创建实例验证效果 &gt;&gt;</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ea5efea6d38310a022b2f7c573e3afcd.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_ea5efea6d38310a022b2f7c573e3afcd.png"></p><p>此时集群测试圆满完成。</p>]]></content>
      
      
      <categories>
          
          <category> openstack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>workstdtion模拟交换机划分vlan,以及物理服务器网卡bond设置</title>
      <link href="/2024/04/02/workstdtion%E6%A8%A1%E6%8B%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%88%92%E5%88%86vlan,%E4%BB%A5%E5%8F%8A%E7%89%A9%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BD%91%E5%8D%A1bond%E8%AE%BE%E7%BD%AE/"/>
      <url>/2024/04/02/workstdtion%E6%A8%A1%E6%8B%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%88%92%E5%88%86vlan,%E4%BB%A5%E5%8F%8A%E7%89%A9%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BD%91%E5%8D%A1bond%E8%AE%BE%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="workstdtion模拟交换机划分vlan-以及物理服务器网卡bond设置"><a href="#workstdtion模拟交换机划分vlan-以及物理服务器网卡bond设置" class="headerlink" title="workstdtion模拟交换机划分vlan,以及物理服务器网卡bond设置"></a>workstdtion模拟交换机划分vlan,以及物理服务器网卡bond设置</h1><h2 id="workstdtion设置"><a href="#workstdtion设置" class="headerlink" title="workstdtion设置"></a>workstdtion设置</h2><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_c2444bc85394584e2798df97ef8b9549.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_c2444bc85394584e2798df97ef8b9549.png"></p><h2 id="一-第一种ubuntu系统网卡配置"><a href="#一-第一种ubuntu系统网卡配置" class="headerlink" title="一. 第一种ubuntu系统网卡配置"></a>一. 第一种ubuntu系统网卡配置</h2><blockquote><p>查看端口速率：</p><ul><li><p>判断是千兆网卡还是百兆网卡 查看支持的速率 &gt; <strong>ethtool ens33</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Speed: 1000Mb/s</span><br><span class="line">Duplex: Full</span><br><span class="line">Port: Twisted Pair</span><br></pre></td></tr></table></figure></li></ul></blockquote><p>完整网卡配置如下：共接四根网线 <strong>bond0&gt;&gt;bond3</strong> 处网卡需要是<strong>up</strong>状态 物理服务器时只需要插入网线查看端口状态即可判断网口状态</p><ul><li><p>bond3 浮动IP 192.168.1.10/24 网口上 位于千兆口 接一根交换机上划分的一根同网段网线 用于远程连接</p></li><li><p>bond0 万兆口接一根交换机划分的 50 段网络 用于ceph osd 内部通信ceph（–cluster-network）网络</p></li><li><p>bond1 上面接交换机上对 该网口划分了vlan60 vlan70 vlan80 vlan90 的网线</p></li><li><p><code>bond2</code> 上面接交换机上对 <del>192.168.1.10/24 网段划分的浮动IP 池</del> 的网线 例如：<del>本文则需要为桥接模式模拟浮动</del>IP  并且此网口不配置IP（下方文件测试已配置了IP <del>实际过程中自行注释</del>）<code>实验中单节点vmware环境bond2下网卡ens39桥接模式 部署单节点stack一切正常 但是双节点bond2下网卡ens39 双节点ens39网卡均配置桥接模式时 只有一个节点可用 &gt;&gt; 此时 只需要将双节点上方均没有划分bond的任意网卡桥接如ens41 修改global文件用于浮动IP池使用的网卡为ens41 再重新部署 即 正常</code>。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_6e28aee0f289c98393d974c614fc09c3.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_6e28aee0f289c98393d974c614fc09c3.png"></p></li><li><p>三台服务器 此种配置完成后 是可以互通的无论<strong>ping</strong>那个网段都是通的<br>ubuntu网卡bond接线与ceph及start集成<strong>揽图</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_cea9571e22249bca02d6cb339ed3c060.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_cea9571e22249bca02d6cb339ed3c060.png"></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the network config written by &#x27;subiquity&#x27;</span></span><br><span class="line">network:</span><br><span class="line">  ethernets:</span><br><span class="line">    ens33: &#123;&#125;</span><br><span class="line">    ens37: &#123;&#125;</span><br><span class="line">    ens38: &#123;&#125;</span><br><span class="line">    ens39: &#123;&#125;</span><br><span class="line">    ens40: &#123;&#125;</span><br><span class="line">    ens41: &#123;&#125;</span><br><span class="line">    ens42: &#123;&#125;</span><br><span class="line">    ens43: &#123;&#125;</span><br><span class="line">  bonds:</span><br><span class="line">    bond0:</span><br><span class="line">      addresses: [<span class="string">&quot;10.56.50.11/24&quot;</span>]  <span class="comment"># 此网口用万兆口 用于ceph osd间通信（--cluster-network）</span></span><br><span class="line">      interfaces:</span><br><span class="line">        - ens37</span><br><span class="line">      parameters:</span><br><span class="line">        mode: 802.3ad</span><br><span class="line">        mii-monitor-interval: 100</span><br><span class="line">        lacp-rate: fast</span><br><span class="line">        transmit-hash-policy: layer3+4</span><br><span class="line">    bond1:</span><br><span class="line">      interfaces:  </span><br><span class="line">        - ens38</span><br><span class="line">      parameters:</span><br><span class="line">        mode: 802.3ad</span><br><span class="line">        mii-monitor-interval: 100</span><br><span class="line">        lacp-rate: fast</span><br><span class="line">        transmit-hash-policy: layer3+4</span><br><span class="line">    bond2:</span><br><span class="line">      interfaces:</span><br><span class="line">        - ens39</span><br><span class="line">      parameters:</span><br><span class="line">        mode: 802.3ad</span><br><span class="line">        mii-monitor-interval: 100</span><br><span class="line">        lacp-rate: fast</span><br><span class="line">        transmit-hash-policy: layer3+4</span><br><span class="line">    bond3:</span><br><span class="line">      addresses: [<span class="string">&quot;192.168.1.10/24&quot;</span>]      <span class="comment"># 此网口用千兆口 &gt;&gt; 电口 用于远程连接 及浮动IP使用</span></span><br><span class="line">      gateway4: 192.168.1.1</span><br><span class="line">      interfaces:</span><br><span class="line">        - ens33</span><br><span class="line">      parameters:</span><br><span class="line">        mode: 802.3ad</span><br><span class="line">        mii-monitor-interval: 100</span><br><span class="line">        lacp-rate: fast</span><br><span class="line">        transmit-hash-policy: layer3+4</span><br><span class="line">  vlans:</span><br><span class="line">    vlan60:</span><br><span class="line">      <span class="built_in">id</span>: 60</span><br><span class="line">      <span class="built_in">link</span>: bond1</span><br><span class="line">      addresses: [<span class="string">&quot;10.56.60.11/24&quot;</span>]</span><br><span class="line">    vlan70:</span><br><span class="line">      <span class="built_in">id</span>: 70</span><br><span class="line">      <span class="built_in">link</span>: bond1</span><br><span class="line">      addresses: [<span class="string">&quot;10.56.70.11/24&quot;</span>]</span><br><span class="line">    vlan80:</span><br><span class="line">      <span class="built_in">id</span>: 80</span><br><span class="line">      <span class="built_in">link</span>: bond1</span><br><span class="line">      addresses: [<span class="string">&quot;10.56.80.11/24&quot;</span>]</span><br><span class="line">    vlan90:</span><br><span class="line">      <span class="built_in">id</span>: 90</span><br><span class="line">      <span class="built_in">link</span>: bond1</span><br><span class="line">      addresses: [<span class="string">&quot;10.56.90.11/24&quot;</span>]</span><br><span class="line">  version: 2</span><br></pre></td></tr></table></figure><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">  System information as of Wed 03 Apr 2024 04:59:36 AM UTC</span><br><span class="line"></span><br><span class="line">  System load:              0.02</span><br><span class="line">  Usage of /:               26.9% of 39.07GB</span><br><span class="line">  Memory usage:             11%</span><br><span class="line">  Swap usage:               0%</span><br><span class="line">  Processes:                261</span><br><span class="line">  Users logged <span class="keyword">in</span>:          1</span><br><span class="line">  IPv4 address <span class="keyword">for</span> bond0:   10.56.50.11</span><br><span class="line">  IPv4 address <span class="keyword">for</span> bond3:   192.168.1.10</span><br><span class="line">  IPv6 address <span class="keyword">for</span> bond3:   240e:36f:151f:a000:e407:31ff:fee2:70f9</span><br><span class="line">  IPv4 address <span class="keyword">for</span> docker0: 172.17.0.1</span><br><span class="line">  IPv4 address <span class="keyword">for</span> vlan60:  10.56.60.11</span><br><span class="line">  IPv4 address <span class="keyword">for</span> vlan70:  10.56.70.11</span><br><span class="line">  IPv4 address <span class="keyword">for</span> vlan80:  10.56.80.11</span><br><span class="line">  IPv4 address <span class="keyword">for</span> vlan90:  10.56.90.11</span><br><span class="line"><span class="comment">#-----------------------------------------------------------------</span></span><br><span class="line">root@ceph1:~<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master bond3 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether e6:07:31:e2:70:f9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: ens37: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master bond0 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 5a:c0:b2:8b:fe:e7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">4: ens38: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master bond1 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether e2:ce:28:a9:28:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: ens39: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master bond2 state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 76:88:82:b8:46:ba brd ff:ff:ff:ff:ff:ff</span><br><span class="line">6: ens40: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:45:8a:b0 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::20c:29ff:fe45:8ab0/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">7: ens41: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:45:8a:ba brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::20c:29ff:fe45:8aba/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">8: ens42: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:45:8a:c4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::20c:29ff:fe45:8ac4/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: ens43: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:45:8a:ce brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::20c:29ff:fe45:8ace/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">10: bond0: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 5a:c0:b2:8b:fe:e7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.56.50.11/24 brd 10.56.50.255 scope global bond0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::58c0:b2ff:fe8b:fee7/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: bond1: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether e2:ce:28:a9:28:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::e0ce:28ff:fea9:280d/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">12: bond2: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 76:88:82:b8:46:ba brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::7488:82ff:feb8:46ba/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">13: bond3: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether e6:07:31:e2:70:f9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.10/24 brd 192.168.1.255 scope global bond3</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 240e:36f:151f:a000:e407:31ff:fee2:70f9/64 scope global dynamic mngtmpaddr noprefixroute </span><br><span class="line">       valid_lft 198193sec preferred_lft 111793sec</span><br><span class="line">    inet6 fe80::e407:31ff:fee2:70f9/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">14: vlan90@bond1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether e2:ce:28:a9:28:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.56.90.11/24 brd 10.56.90.255 scope global vlan90</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::e0ce:28ff:fea9:280d/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">15: vlan60@bond1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether e2:ce:28:a9:28:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.56.60.11/24 brd 10.56.60.255 scope global vlan60</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::e0ce:28ff:fea9:280d/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">16: vlan70@bond1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether e2:ce:28:a9:28:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.56.70.11/24 brd 10.56.70.255 scope global vlan70</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::e0ce:28ff:fea9:280d/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">17: vlan80@bond1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether e2:ce:28:a9:28:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.56.80.11/24 brd 10.56.80.255 scope global vlan80</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::e0ce:28ff:fea9:280d/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">18: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:98:b9:c1:30 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此时便可配置openstack 与 ceph 见 &gt;&gt; | <a href="http://sunlight.zznnwn.cloudns.biz/2024/04/02/ubuntu%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1bond%E7%89%88%20openstack%E9%83%A8%E7%BD%B2/">bond版opesnatck</a> 。</p><h2 id="扩展："><a href="#扩展：" class="headerlink" title="扩展："></a>扩展：</h2><p>实际物理环境，物理服务器ubuntu配置bond 802.3ad如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the network config written by &#x27;subiquity&#x27;</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">     <span class="attr">eno1:</span> &#123;&#125;</span><br><span class="line">     <span class="attr">eno2:</span> &#123;&#125;</span><br><span class="line">     <span class="attr">eno3:</span> &#123;&#125;</span><br><span class="line">     <span class="attr">eno4:</span></span><br><span class="line">        <span class="attr">addresses:</span> [<span class="number">58.49</span><span class="number">.220</span><span class="number">.166</span><span class="string">/24</span>]</span><br><span class="line">        <span class="attr">gateway4:</span> <span class="number">58.49</span><span class="number">.220</span><span class="number">.1</span></span><br><span class="line">  <span class="attr">bonds:</span></span><br><span class="line">    <span class="attr">bond0:</span></span><br><span class="line">      <span class="attr">interfaces:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">eno3</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">802.</span><span class="string">3ad</span></span><br><span class="line">        <span class="attr">mii-monitor-interval:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">lacp-rate:</span> <span class="string">fast</span></span><br><span class="line">        <span class="attr">transmit-hash-policy:</span> <span class="string">layer3+4</span></span><br><span class="line">  <span class="attr">vlans:</span></span><br><span class="line">    <span class="attr">vlan60:</span></span><br><span class="line">      <span class="attr">id:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">link:</span> <span class="string">bond0</span>   <span class="comment"># 即en03网卡即基于eno3网卡配置802.3ad</span></span><br><span class="line">      <span class="attr">addresses:</span> [<span class="string">&quot;192.168.30.100/24&quot;</span>]  </span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>双网卡版本。</p>]]></content>
      
      
      <categories>
          
          <category> ubuntu-bond </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu-bond </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kolla-ansible合并配置文件属性之新增glance等配置介绍文档</title>
      <link href="/2024/04/01/kolla-ansible%E5%90%88%E5%B9%B6%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E4%B9%8B%E6%96%B0%E5%A2%9Eglance%E7%AD%89%E9%85%8D%E7%BD%AE%E4%BB%8B%E7%BB%8D%E6%96%87%E6%A1%A3/"/>
      <url>/2024/04/01/kolla-ansible%E5%90%88%E5%B9%B6%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E4%B9%8B%E6%96%B0%E5%A2%9Eglance%E7%AD%89%E9%85%8D%E7%BD%AE%E4%BB%8B%E7%BB%8D%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="kolla-ansible合并配置文件属性之新增glance等配置介绍文档"><a href="#kolla-ansible合并配置文件属性之新增glance等配置介绍文档" class="headerlink" title="kolla-ansible合并配置文件属性之新增glance等配置介绍文档"></a>kolla-ansible合并配置文件属性之新增glance等配置介绍文档</h1><h2 id="ceph密钥测试官网方式构建"><a href="#ceph密钥测试官网方式构建" class="headerlink" title="ceph密钥测试官网方式构建"></a>ceph密钥测试官网方式构建</h2><p>官网版本（测试此种版本）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph auth get-or-create client.glance mon <span class="string">&#x27;profile rbd&#x27;</span> osd <span class="string">&#x27;profile rbd pool=images&#x27;</span> mgr <span class="string">&#x27;profile rbd pool=images&#x27;</span> -o ceph.client.glance.keyring </span><br><span class="line">ceph auth get-or-create client.cinder mon <span class="string">&#x27;profile rbd&#x27;</span> osd <span class="string">&#x27;profile rbd pool=volumes, profile rbd pool=vms, profile rbd-read-only pool=images&#x27;</span> mgr <span class="string">&#x27;profile rbd pool=volumes, profile rbd pool=vms&#x27;</span> -o ceph.client.cinder.keyring</span><br><span class="line">ceph auth get-or-create client.cinder-backup mon <span class="string">&#x27;profile rbd&#x27;</span> osd <span class="string">&#x27;profile rbd pool=backups&#x27;</span> mgr <span class="string">&#x27;profile rbd pool=backups&#x27;</span> -o ceph.client.cinder-backup.keyring</span><br></pre></td></tr></table></figure><p>ZzNnwN.部署版本密钥创建如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/ceph</span><br><span class="line">ceph auth get-or-create client.cinder mon <span class="string">&#x27;allow r&#x27;</span> osd <span class="string">&#x27;allow class-read object_prefix rbd_children, allow rwx pool=volumes, allow rwx pool=vms, allow rx pool=images&#x27;</span> -o ceph.client.cinder.keyring</span><br><span class="line">ceph auth get-or-create client.glance mon <span class="string">&#x27;allow r&#x27;</span> osd <span class="string">&#x27;allow class-read object_prefix rbd_children, allow rwx pool=images&#x27;</span>  -o ceph.client.glance.keyring</span><br><span class="line">ceph auth get-or-create client.cinder-backup mon <span class="string">&#x27;allow r&#x27;</span> osd <span class="string">&#x27;allow class-read object_prefix rbd_children, allow rwx pool=backups, allow rwx pool=volumes&#x27;</span>  -o ceph.client.cinder-backup.keyring</span><br><span class="line">ceph auth get-or-create client.nova mon <span class="string">&#x27;allow r&#x27;</span> osd <span class="string">&#x27;allow class-read object_prefix rbd_children, allow rwx pool=vms, allow rwx pool=volumes, allow rx pool=images&#x27;</span>  -o ceph.client.nova.keyring</span><br></pre></td></tr></table></figure><h2 id="目前已验证合并配置文件生效配置"><a href="#目前已验证合并配置文件生效配置" class="headerlink" title="目前已验证合并配置文件生效配置"></a>目前已验证合并配置文件生效配置</h2><blockquote><p>下方内容来自 | ：</p><p><a href="https://wn-apple-teawine.fun/2023/06/02/ceph%E4%B8%8Eopenstack-yoga%E9%9B%86%E6%88%90">https://wn-apple-teawine.fun/2023/06/02/ceph与openstack-yoga集成</a></p><p>可参考官网：</p><p><a href="https://docs.ceph.com/en/reef/rbd/rbd-openstack/">https://docs.ceph.com/en/reef/rbd/rbd-openstack/</a></p><p><del><strong>volume</strong>与<strong>cinder-backup</strong>利用<strong>kolla-ansible</strong>合并配置文件属性后生成的配置文件分别位于</del></p><p>/etc/kolla/cinder-volume/cinder.conf<br>/etc/kolla/cinder-backup/cinder.conf</p><p><del><strong>glance</strong>与<strong>nova</strong>分别位于</del></p><p>/etc/kolla/glance-api/glance-api.conf<br>/etc/kolla/nova-compute/nova.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># glance的配置镜像存储</span></span><br><span class="line">vi /etc/kolla/config/glance/glance-api.conf</span><br><span class="line"><span class="comment"># 添加：</span></span><br><span class="line">[glance_store]</span><br><span class="line">stores=rbd</span><br><span class="line">default_store=rbd</span><br><span class="line">rbd_store_pool=images</span><br><span class="line">rbd_store_user=glance</span><br><span class="line">rbd_store_ceph_conf=/etc/ceph/ceph.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># cinder的配置卷存储</span></span><br><span class="line">vi /etc/kolla/config/cinder/cinder-volume.conf</span><br><span class="line"><span class="comment"># 添加:</span></span><br><span class="line">[DEFAULT]</span><br><span class="line">enabled_backends=rbd-1</span><br><span class="line">[rbd-1]</span><br><span class="line">rbd_ceph_conf=/etc/ceph/ceph.conf</span><br><span class="line"><span class="comment"># rbd_flatten_volume_from_snapshot = true</span></span><br><span class="line">rbd_user=cinder  </span><br><span class="line">backend_host=rbd:volumes</span><br><span class="line">rbd_pool=volumes</span><br><span class="line">volume_backend_name=rbd-1</span><br><span class="line">volume_driver=cinder.volume.drivers.rbd.RBDDriver     <span class="comment"># 此为驱动</span></span><br><span class="line">rbd_secret_uuid=ea241bba-2031-4b0e-b750-c8356cbb46a8 </span><br><span class="line"></span><br><span class="line">新增：（ rbd_flatten_volume_from_snapshot = <span class="literal">true</span></span><br><span class="line">）</span><br><span class="line"><span class="comment"># 注意：rbd_secret_uuid在/etc/kolla/passwords.yml 文件中找</span></span><br><span class="line"><span class="comment"># cat /etc/kolla/passwords.yml | grep rbd_secret_uuid</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cinder-backup的配置</span></span><br><span class="line">vi /etc/kolla/config/cinder/cinder-backup.conf</span><br><span class="line"><span class="comment"># 添加:</span></span><br><span class="line">[DEFAULT]</span><br><span class="line">backup_ceph_conf=/etc/ceph/ceph.conf</span><br><span class="line">backup_ceph_user=cinder-backup   </span><br><span class="line">backup_ceph_chunk_size=134217728</span><br><span class="line">backup_ceph_pool=backups</span><br><span class="line"><span class="comment"># 本次使用cinder.backup.drivers.ceph.CephBackupDriver</span></span><br><span class="line">backup_driver=cinder.backup.drivers.ceph.CephBackupDriver    <span class="comment">#此为驱动可选cinder.backup.drivers.ceph</span></span><br><span class="line">backup_ceph_stripe_unit=0</span><br><span class="line">backup_ceph_stripe_count=0</span><br><span class="line">restore_discard_excess_bytes=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nova的配置</span></span><br><span class="line">vi /etc/kolla/config/nova/nova-compute.conf</span><br><span class="line"><span class="comment"># 添加：   </span></span><br><span class="line">[libvirt]   </span><br><span class="line">virt_type=kvm  </span><br><span class="line">cpu_mode=none </span><br><span class="line">images_rbd_pool=vms</span><br><span class="line">images_type=rbd</span><br><span class="line">images_rbd_ceph_conf=/etc/ceph/ceph.conf</span><br><span class="line">rbd_user=nova</span><br><span class="line"><span class="comment"># disk_cachemodes= &quot;network=writeback&quot;</span></span><br><span class="line"><span class="comment"># inject_password=true</span></span><br><span class="line"><span class="comment"># 如果是在虚拟机上部署的话需要将virt_type 改为qemu，如果不改成qemu，在openstack之上在起虚机，这个虚机是起不来的 </span></span><br><span class="line">（实际环境参考</span><br><span class="line">新增: disk_cachemodes= <span class="string">&quot;network=writeback&quot;</span> inject_password=<span class="literal">true</span>,images_type=rbd </span><br><span class="line">删除: virt_type=kvm, cpu_mode = none :删除新增配置此种时成功 ）</span><br></pre></td></tr></table></figure></blockquote><h2 id="glance配置文件（glance-api-conf）"><a href="#glance配置文件（glance-api-conf）" class="headerlink" title="glance配置文件（glance-api.conf）"></a>glance配置文件（glance-api.conf）</h2><p>ZzNnwN.部署版本 kolla_ansible合并 配置文件路径：/etc/kolla/config/glance/glance-api.conf</p><blockquote><p>官网引用</p><h4 id="KILO-AND-AFTER-gt-gt"><a href="#KILO-AND-AFTER-gt-gt" class="headerlink" title="KILO AND AFTER&gt;&gt;"></a>KILO AND AFTER<a href="https://docs.ceph.com/en/reef/rbd/rbd-openstack/#kilo-and-after" title="Permalink to this heading">&gt;&gt;</a></h4><p>Edit <code>/etc/glance/glance-api.conf</code> and add under the <code>[glance_store]</code> section:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[glance_store]</span><br><span class="line">stores = rbd</span><br><span class="line">default_store = rbd</span><br><span class="line">rbd_store_pool = images</span><br><span class="line">rbd_store_user = glance</span><br><span class="line">rbd_store_ceph_conf = /etc/ceph/ceph.conf</span><br><span class="line">rbd_store_chunk_size = 8</span><br></pre></td></tr></table></figure><p>For more information about the configuration options available in Glance please refer to the OpenStack Configuration Reference: <a href="http://docs.openstack.org/">http://docs.openstack.org/</a>.</p><h4 id="ENABLE-COPY-ON-WRITE-CLONING-OF-IMAGES"><a href="#ENABLE-COPY-ON-WRITE-CLONING-OF-IMAGES" class="headerlink" title="ENABLE COPY-ON-WRITE CLONING OF IMAGES"></a>ENABLE COPY-ON-WRITE CLONING OF IMAGES<a href="https://docs.ceph.com/en/reef/rbd/rbd-openstack/#enable-copy-on-write-cloning-of-images" title="Permalink to this heading"></a></h4><p>Note that this exposes the back end location via Glance’s API, so the endpoint with this option enabled should not be publicly accessible.</p><h5 id="ANY-OPENSTACK-VERSION-EXCEPT-MITAKA"><a href="#ANY-OPENSTACK-VERSION-EXCEPT-MITAKA" class="headerlink" title="ANY OPENSTACK VERSION EXCEPT MITAKA"></a>ANY OPENSTACK VERSION EXCEPT MITAKA<a href="https://docs.ceph.com/en/reef/rbd/rbd-openstack/#any-openstack-version-except-mitaka" title="Permalink to this heading"></a></h5><p>If you want to enable copy-on-write cloning of images, also add under the <code>&lt;span class=&quot;pre&quot;&gt;[DEFAULT]&lt;/span&gt;</code> section:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show_image_direct_url = True</span><br></pre></td></tr></table></figure></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show_image_direct_url = True</span><br></pre></td></tr></table></figure><blockquote><p>在OpenStack中，Glance是用于管理虚拟机镜像的组件，而Ceph则是一种分布式存储系统，常被用于OpenStack的后端存储。在你提到的配置中，<code>show_image_direct_url = True</code> 是用于配置 Glance 的 <code>glance-api.conf</code> 文件的一部分，它用于启用或禁用显示镜像直接URL的功能。当你设置 <code>show_image_direct_url = True</code> 时，Glance API 将包含一个名为 <code>direct_url</code> 的属性，该属性包含指向存储镜像直接URL的链接。这使得用户能够通过直接URL访问镜像，而不必通过 Glance API 服务。这在某些情况下可能是有用的，例如，如果你希望通过直接链接共享镜像给其他用户或系统，而无需通过 Glance API 。在 Ceph 和 OpenStack 集成的情况下，你需要确保 Glance 配置文件中的 <code>default_store</code> 设置为 <code>rbd</code>，以便将镜像存储在 Ceph RBD（块设备）后端。同时，你需要配置好 Ceph 的访问权限，确保 OpenStack 的各个组件可以正确地访问和使用 Ceph 存储。</p></blockquote><h2 id="ciner-官网参考"><a href="#ciner-官网参考" class="headerlink" title="ciner(官网参考)"></a>ciner(官网参考)</h2><p>ZzNnwN.部署版本 kolla_ansible合并 配置文件路径：/etc/kolla/config/cinder/cinder-volume.conf</p><blockquote><p>OpenStack requires a driver to interact with Ceph block devices. You must also specify the pool name for the block device. On your OpenStack node, edit <code>/etc/cinder/cinder.conf</code> by adding:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">enabled_backends = ceph</span><br><span class="line">glance_api_version = 2</span><br><span class="line">...</span><br><span class="line">[ceph]</span><br><span class="line">volume_driver = cinder.volume.drivers.rbd.RBDDriver</span><br><span class="line">volume_backend_name = ceph</span><br><span class="line">rbd_pool = volumes</span><br><span class="line">rbd_ceph_conf = /etc/ceph/ceph.conf</span><br><span class="line">rbd_flatten_volume_from_snapshot = false</span><br><span class="line">rbd_max_clone_depth = 5</span><br><span class="line">rbd_store_chunk_size = 4</span><br><span class="line">rados_connect_timeout = -1</span><br></pre></td></tr></table></figure><p>If you are using <a href="https://docs.ceph.com/en/reef/rados/configuration/auth-config-ref/#enabling-disabling-cephx">cephx authentication</a>, also configure the user and uuid of the secret you added to <code> libvirt</code> as documented earlier:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ceph]</span><br><span class="line">...</span><br><span class="line">rbd_user = cinder</span><br><span class="line">rbd_secret_uuid = 457eb676-33da-42ec-9a8c-9293d545c337</span><br></pre></td></tr></table></figure><p>Note that if you are configuring multiple cinder back ends, <code>&lt;span class=&quot;pre&quot;&gt;glance_api_version&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span class=&quot;pre&quot;&gt;=&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span class=&quot;pre&quot;&gt;2&lt;/span&gt;</code> must be in the <code>&lt;span class=&quot;pre&quot;&gt;[DEFAULT]&lt;/span&gt;</code> section.</p></blockquote><p><strong>enabled_backends = ceph</strong>  此配置实际上后端手动操作为如下 实际上就是创建磁盘时选择的类型 新版本不需要手动创建 配置文件填写完成即可</p><p>比如 我手动创建rbd-1类型时则会报错：</p><p>执行 cinder type-key 1f90a0e1-3657-4d42-9965-4e9ab76ed635  set volume_backend_name=rbd-1 报错<br>ERROR: Volume Type is currently in use. (HTTP 400) (Request-ID: req-48ab8f51-d024-45e4-a9f8-376f7c71bf45)</p><blockquote><p>cinder type-create ceph</p><p>cinder type-key 8a8a69b6-ec9f-4a09-8126-a211fce34ef3 set  volume_backend_name=ceph</p><p>cinder type-list</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_081d10d51610d49db32c3074544340f6.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_081d10d51610d49db32c3074544340f6.png"></p></blockquote><h2 id="ciner-backup"><a href="#ciner-backup" class="headerlink" title="ciner-backup"></a>ciner-backup</h2><p>ZzNnwN.部署版本 kolla_ansible合并 配置文件路径：/etc/kolla/config/cinder/cinder-backup.conf</p><p>事实上默认使用的驱动是swift驱动 ZzNnWn.使用驱动为<strong>cinder.backup.drivers.ceph.CephBackupDriver</strong> 需要注意的是<strong>cinder.backup.drivers.ceph</strong>此驱动已弃用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">backup_driver= cinder.backup.drivers.swift.SwiftBackupDriver</span><br><span class="line">backup_driver=cinder.backup.drivers.swift.SwiftBackupDriver</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_0c901ca872c1b350140046935d9a97ad.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_0c901ca872c1b350140046935d9a97ad.png"></p><blockquote><p>官网引用</p><h3 id="CONFIGURING-CINDER-BACKUP"><a href="#CONFIGURING-CINDER-BACKUP" class="headerlink" title="CONFIGURING CINDER BACKUP"></a>CONFIGURING CINDER BACKUP<a href="https://docs.ceph.com/en/reef/rbd/rbd-openstack/#configuring-cinder-backup" title="Permalink to this heading"></a></h3><p>OpenStack Cinder Backup requires a specific daemon so don’t forget to install it. On your Cinder Backup node, edit <code>/etc/cinder/cinder.conf</code> and add:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">backup_driver = cinder.backup.drivers.ceph</span><br><span class="line">backup_ceph_conf = /etc/ceph/ceph.conf</span><br><span class="line">backup_ceph_user = cinder-backup</span><br><span class="line">backup_ceph_chunk_size = 134217728</span><br><span class="line">backup_ceph_pool = backups</span><br><span class="line">backup_ceph_stripe_unit = 0</span><br><span class="line">backup_ceph_stripe_count = 0</span><br><span class="line">restore_discard_excess_bytes = <span class="literal">true</span></span><br></pre></td></tr></table></figure></blockquote><h2 id="nova与ceph"><a href="#nova与ceph" class="headerlink" title="nova与ceph"></a>nova与ceph</h2><p>ZzNnwN.部署版本 kolla_ansible合并 配置文件路径：/etc/kolla/config/nova/nova-compute.conf</p><p>此处应设置为如下</p><p>rbd_secret_uuid 通过如下两种方式皆可查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt install libvirt-clients -y</span><br><span class="line">virsh secret-list  (此种为已与openstack集成才能使用)</span><br><span class="line"><span class="built_in">cat</span> /etc/kolla/passwords.yml |grep rbd_secret_uuid</span><br></pre></td></tr></table></figure><p>完整配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nova的配置</span></span><br><span class="line">vi /etc/kolla/config/nova/nova-compute.conf</span><br><span class="line"><span class="comment"># 添加：   </span></span><br><span class="line">[libvirt]   </span><br><span class="line">virt_type=kvm  </span><br><span class="line">cpu_mode=none </span><br><span class="line">images_rbd_pool=vms</span><br><span class="line">images_type=rbd</span><br><span class="line">images_rbd_ceph_conf=/etc/ceph/ceph.conf</span><br><span class="line">rbd_user=nova</span><br><span class="line"><span class="comment"># rbd_secret_uuid=ea241bba-2031-4b0e-b750-c8356cbb46a8 (可选不需要配置后端会自动生成)</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_5cdbe807c394a81c86e7f04b76d40922.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_5cdbe807c394a81c86e7f04b76d40922.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_4e38f71c5e42268c245ab6d95a5044b5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_4e38f71c5e42268c245ab6d95a5044b5.png"></p><blockquote><p>官网引用</p><h3 id="CONFIGURING-NOVA-TO-ATTACH-CEPH-RBD-BLOCK-DEVICE"><a href="#CONFIGURING-NOVA-TO-ATTACH-CEPH-RBD-BLOCK-DEVICE" class="headerlink" title="CONFIGURING NOVA TO ATTACH CEPH RBD BLOCK DEVICE"></a>CONFIGURING NOVA TO ATTACH CEPH RBD BLOCK DEVICE<a href="https://docs.ceph.com/en/reef/rbd/rbd-openstack/#configuring-nova-to-attach-ceph-rbd-block-device" title="Permalink to this heading"></a></h3><p>In order to attach Cinder devices (either normal block or by issuing a boot from volume), you must tell Nova (and libvirt) which user and UUID to refer to when attaching the device. libvirt will refer to this user when connecting and authenticating with the Ceph cluster.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[libvirt]</span><br><span class="line">...</span><br><span class="line">rbd_user = cinder</span><br><span class="line">rbd_secret_uuid = 457eb676-33da-42ec-9a8c-9293d545c337</span><br></pre></td></tr></table></figure><p>These two flags are also used by the Nova ephemeral back end.</p><h3 id="CONFIGURING-NOVA"><a href="#CONFIGURING-NOVA" class="headerlink" title="CONFIGURING NOVA"></a>CONFIGURING NOVA<a href="https://docs.ceph.com/en/reef/rbd/rbd-openstack/#configuring-nova" title="Permalink to this heading"></a></h3><p>In order to boot virtual machines directly from Ceph volumes, you must configure the ephemeral backend for Nova.</p><p>It is recommended to enable the RBD cache in your Ceph configuration file; this has been enabled by default since the Giant release. Moreover, enabling the client admin socket allows the collection of metrics and can be invaluable for troubleshooting.</p><p>This socket can be accessed on the hypervisor (Nova compute) node:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph daemon /var/run/ceph/ceph-client.cinder.19195.32310016.asok help</span><br></pre></td></tr></table></figure><p>To enable RBD cache and admin sockets, ensure that on each hypervisor’s <code>&lt;span class=&quot;pre&quot;&gt;ceph.conf&lt;/span&gt;</code> contains:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">    rbd cache = true</span><br><span class="line">    rbd cache writethrough until flush = true</span><br><span class="line">    admin socket = /var/run/ceph/guests/$cluster-$type.$id.$pid.$cctid.asok</span><br><span class="line">    log file = /var/log/qemu/qemu-guest-$pid.log</span><br><span class="line">    rbd concurrent management ops = 20</span><br></pre></td></tr></table></figure><p>Configure permissions for these directories:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/run/ceph/guests/ /var/log/qemu/</span><br><span class="line">chown qemu:libvirtd /var/run/ceph/guests /var/log/qemu/</span><br></pre></td></tr></table></figure><p>Note that user <code>&lt;span class=&quot;pre&quot;&gt;qemu&lt;/span&gt;</code> and group <code>&lt;span class=&quot;pre&quot;&gt;libvirtd&lt;/span&gt;</code> can vary depending on your system. The provided example works for RedHat based systems.</p><p>Tip</p><p>If your virtual machine is already running you can simply restart it to enable the admin socket</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> openstack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openstack与ceph集成完成后功能测试</title>
      <link href="/2024/04/01/openstack%E4%B8%8Eceph%E9%9B%86%E6%88%90%E5%AE%8C%E6%88%90%E5%90%8E%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95/"/>
      <url>/2024/04/01/openstack%E4%B8%8Eceph%E9%9B%86%E6%88%90%E5%AE%8C%E6%88%90%E5%90%8E%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="openstack与ceph集成完成后功能测试"><a href="#openstack与ceph集成完成后功能测试" class="headerlink" title="openstack与ceph集成完成后功能测试"></a>openstack与ceph集成完成后功能测试</h1><h2 id="一-glance对接功能测试"><a href="#一-glance对接功能测试" class="headerlink" title="一. glance对接功能测试"></a>一. glance对接功能测试</h2><h3 id="上传镜像【success-】"><a href="#上传镜像【success-】" class="headerlink" title="上传镜像【success!】"></a>上传镜像【success!】</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 上传镜像</span></span><br><span class="line">root@localhost:~<span class="comment"># openstack image create &quot;cirros-0.4.0-x86_64&quot; --file cirros-0.4.0-x86_64-disk.img --disk-format qcow2 --container-format bare --public</span></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">root@localhost:~<span class="comment"># glance image-list</span></span><br><span class="line">+--------------------------------------+---------------------+</span><br><span class="line">| ID                                   | Name                |</span><br><span class="line">+--------------------------------------+---------------------+</span><br><span class="line">| 73d31ccc-8eae-49e9-a0a7-2731e5a3806a | cirros-0.4.0-x86_64 |</span><br><span class="line">+--------------------------------------+---------------------+</span><br><span class="line">root@localhost:~<span class="comment"># rbd -p images ls</span></span><br><span class="line">73d31ccc-8eae-49e9-a0a7-2731e5a3806a</span><br><span class="line"><span class="comment"># 查看块设备(镜像)详情</span></span><br><span class="line">root@localhost:~<span class="comment"># rbd -p images info 73d31ccc-8eae-49e9-a0a7-2731e5a3806a</span></span><br><span class="line">rbd image <span class="string">&#x27;73d31ccc-8eae-49e9-a0a7-2731e5a3806a&#x27;</span>:</span><br><span class="line">        size 12 MiB <span class="keyword">in</span> 2 objects</span><br><span class="line">        order 23 (8 MiB objects)</span><br><span class="line">        snapshot_count: 1</span><br><span class="line">        <span class="built_in">id</span>: 1c4b9299cdad7</span><br><span class="line">        block_name_prefix: rbd_data.1c4b9299cdad7</span><br><span class="line">        format: 2</span><br><span class="line">        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten</span><br><span class="line">        op_features: </span><br><span class="line">        flags: </span><br><span class="line">        create_timestamp: Tue Apr  2 05:43:02 2024</span><br><span class="line">        access_timestamp: Tue Apr  2 05:43:02 2024</span><br><span class="line">        modify_timestamp: Tue Apr  2 05:43:02 2024</span><br></pre></td></tr></table></figure><h3 id="查看是否存在快照【存在】"><a href="#查看是否存在快照【存在】" class="headerlink" title="查看是否存在快照【存在】"></a>查看是否存在快照【存在】</h3><p><strong>protected: True</strong>(此处–此标签表示被保护起来了 无法直接删除 后面集成nova后 使用此镜像创建虚拟机 他会针对此镜像快照 克隆一个出来)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># rbd snap ls images/73d31ccc-8eae-49e9-a0a7-2731e5a3806a</span></span><br><span class="line">SNAPID  NAME  SIZE    PROTECTED  TIMESTAMP   </span><br><span class="line">    13  snap  12 MiB  <span class="built_in">yes</span>        Tue Apr  2 05:43:04 2024</span><br><span class="line"><span class="comment"># 查看快照详情</span></span><br><span class="line">root@localhost:~<span class="comment"># rbd info images/73d31ccc-8eae-49e9-a0a7-2731e5a3806a@snap</span></span><br><span class="line">rbd image <span class="string">&#x27;73d31ccc-8eae-49e9-a0a7-2731e5a3806a&#x27;</span>:</span><br><span class="line">        size 12 MiB <span class="keyword">in</span> 2 objects</span><br><span class="line">        order 23 (8 MiB objects)</span><br><span class="line">        snapshot_count: 1</span><br><span class="line">        <span class="built_in">id</span>: 1c4b9299cdad7</span><br><span class="line">        block_name_prefix: rbd_data.1c4b9299cdad7</span><br><span class="line">        format: 2</span><br><span class="line">        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten</span><br><span class="line">        op_features: </span><br><span class="line">        flags: </span><br><span class="line">        create_timestamp: Tue Apr  2 05:43:02 2024</span><br><span class="line">        access_timestamp: Tue Apr  2 05:43:02 2024</span><br><span class="line">        modify_timestamp: Tue Apr  2 05:43:02 2024</span><br><span class="line">        protected: True  (此处--此标签表示被保护起来了)</span><br></pre></td></tr></table></figure><h3 id="日志查看"><a href="#日志查看" class="headerlink" title="日志查看"></a>日志查看</h3><p>kolla-ansible部署的集群<strong>glance</strong>出现问题可在<code>/var/log/kolla/glance/glance-api.log</code>中查看<strong>此时glance对接完成。</strong></p><h2 id="二-ciner对接功能测试"><a href="#二-ciner对接功能测试" class="headerlink" title="二. ciner对接功能测试"></a>二. ciner对接功能测试</h2><h3 id="前端页面创建磁盘后端ceph查看是否成功【success-】"><a href="#前端页面创建磁盘后端ceph查看是否成功【success-】" class="headerlink" title="前端页面创建磁盘后端ceph查看是否成功【success!】"></a>前端页面创建磁盘后端ceph查看是否成功【success!】</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_c52afb0c1b17c459ac6dc022eff72bf8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_c52afb0c1b17c459ac6dc022eff72bf8.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">oot@localhost:~<span class="comment"># rbd -p volumes ls |grep cdfce732-c69f-4ea6-9f95-181c19b932dd</span></span><br><span class="line">volume-cdfce732-c69f-4ea6-9f95-181c19b932dd</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="扩容云硬盘【success-】"><a href="#扩容云硬盘【success-】" class="headerlink" title="扩容云硬盘【success!】"></a>扩容云硬盘【success!】</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># rbd -p volumes info volume-cdfce732-c69f-4ea6-9f95-181c19b932dd</span></span><br><span class="line">rbd image <span class="string">&#x27;volume-cdfce732-c69f-4ea6-9f95-181c19b932dd&#x27;</span>:</span><br><span class="line">        size 5 GiB <span class="keyword">in</span> 1280 objects   【成功扩容到了5G】</span><br><span class="line">        order 22 (4 MiB objects)</span><br><span class="line">        snapshot_count: 0</span><br><span class="line">        <span class="built_in">id</span>: 1ce49280a276</span><br><span class="line">        block_name_prefix: rbd_data.1ce49280a276</span><br><span class="line">        format: 2</span><br><span class="line">        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten</span><br><span class="line">        op_features: </span><br><span class="line">        flags: </span><br><span class="line">        create_timestamp: Tue Apr  2 07:01:15 2024</span><br><span class="line">        access_timestamp: Tue Apr  2 07:01:15 2024</span><br><span class="line">        modify_timestamp: Tue Apr  2 07:01:15 2024</span><br></pre></td></tr></table></figure><h3 id="创建快照【前端-后端-success-】"><a href="#创建快照【前端-后端-success-】" class="headerlink" title="创建快照【前端/后端 success!】"></a>创建快照【前端/后端 success!】</h3><p>查看后端快照及快照详情</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># rbd -p  volumes ls</span></span><br><span class="line">volume-0069c8f9-4f25-4233-91a9-a2f27006f208</span><br><span class="line">volume-0b204bfd-a83b-4d02-aa5c-b7894d710f07</span><br><span class="line">volume-69c5a7f6-fdc8-4c81-9a24-9ffc3aa413ce</span><br><span class="line">volume-ad6ee530-b73e-4605-b0aa-fc6813e10b8a</span><br><span class="line">volume-cdfce732-c69f-4ea6-9f95-181c19b932dd</span><br><span class="line">root@localhost:~<span class="comment"># rbd -p volumes snap ls  volume-cdfce732-c69f-4ea6-9f95-181c19b932dd</span></span><br><span class="line">SNAPID  NAME                                           SIZE   PROTECTED  TIMESTAMP             </span><br><span class="line">    10  snapshot-d8b94a76-c1b1-48c6-a5f7-d7a478b5cf8c  5 GiB  <span class="built_in">yes</span>        Tue Apr  2 07:23:35 2024</span><br><span class="line">root@localhost:~<span class="comment"># rbd info volumes/volume-cdfce732-c69f-4ea6-9f95-181c19b932dd@snapshot-d8b94a76-c1b1-48c6-a5f7-d7a478b5cf8c</span></span><br><span class="line">rbd image <span class="string">&#x27;volume-cdfce732-c69f-4ea6-9f95-181c19b932dd&#x27;</span>:</span><br><span class="line">        size 5 GiB <span class="keyword">in</span> 1280 objects</span><br><span class="line">        order 22 (4 MiB objects)</span><br><span class="line">        snapshot_count: 1</span><br><span class="line">        <span class="built_in">id</span>: 1ce49280a276</span><br><span class="line">        block_name_prefix: rbd_data.1ce49280a276</span><br><span class="line">        format: 2</span><br><span class="line">        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten</span><br><span class="line">        op_features: </span><br><span class="line">        flags: </span><br><span class="line">        create_timestamp: Tue Apr  2 07:01:15 2024</span><br><span class="line">        access_timestamp: Tue Apr  2 07:01:15 2024</span><br><span class="line">        modify_timestamp: Tue Apr  2 07:01:15 2024</span><br><span class="line">        protected: True</span><br></pre></td></tr></table></figure><h3 id="日志查看-1"><a href="#日志查看-1" class="headerlink" title="日志查看"></a>日志查看</h3><p>报错查看ciner日志文件目录：/var/log/kolla/cinder/</p><p>cinder-api-access.log  cinder-api-error.log  cinder-api.log  cinder-backup.log  cinder-scheduler.log  cinder-volume.log</p><p><strong>ciner</strong>对接完成。</p><h2 id="三-ciner-backup对接功能测试【前端-后端success-】"><a href="#三-ciner-backup对接功能测试【前端-后端success-】" class="headerlink" title="三. ciner-backup对接功能测试【前端/后端success!】"></a>三. ciner-backup对接功能测试【前端/后端success!】</h2><h3 id="创建云硬盘备份"><a href="#创建云硬盘备份" class="headerlink" title="创建云硬盘备份"></a>创建云硬盘备份</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_baec65a01ef1848667e37913f18fb4a2.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_baec65a01ef1848667e37913f18fb4a2.png"></p><p>前端创建完成其实后端实现方式如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 帮助</span></span><br><span class="line">cinder -h |grep backup</span><br><span class="line">cinder <span class="built_in">help</span> backup-create</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看卷</span></span><br><span class="line">root@localhost:/var/log/kolla/cinder<span class="comment"># cinder list</span></span><br><span class="line">+--------------------------------------+-----------+-------------+------+----------------+-------------+----------+-------------+</span><br><span class="line">| ID                                   | Status    | Name        | Size | Consumes Quota | Volume Type | Bootable | Attached to |</span><br><span class="line">+--------------------------------------+-----------+-------------+------+----------------+-------------+----------+-------------+</span><br><span class="line">| cdfce732-c69f-4ea6-9f95-181c19b932dd | available | cinder-test | 5    | True           | __DEFAULT__ | <span class="literal">false</span>    |             |</span><br><span class="line">+--------------------------------------+-----------+-------------+------+----------------+-------------+----------+-------------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对其进行备份</span></span><br><span class="line">root@localhost:/var/log/kolla/cinder<span class="comment"># cinder backup-create cdfce732-c69f-4ea6-9f95-181c19b932dd --name backup-demo</span></span><br><span class="line">+-----------+--------------------------------------+</span><br><span class="line">| Property  | Value                                |</span><br><span class="line">+-----------+--------------------------------------+</span><br><span class="line">| <span class="built_in">id</span>        | c9c3ef24-e310-4685-aa54-64cd6fa7d08b |</span><br><span class="line">| name      | backup-demo                          |</span><br><span class="line">| volume_id | cdfce732-c69f-4ea6-9f95-181c19b932dd |</span><br><span class="line">+-----------+--------------------------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">root@localhost:/var/log/kolla/cinder<span class="comment"># cinder backup-list</span></span><br><span class="line">+--------------------------------------+--------------------------------------+-----------+-------------+------+--------------+-----------+----------------------------------+</span><br><span class="line">| ID                                   | Volume ID                            | Status    | Name        | Size | Object Count | Container | User ID                          |</span><br><span class="line">+--------------------------------------+--------------------------------------+-----------+-------------+------+--------------+-----------+----------------------------------+</span><br><span class="line">| 6774233c-007a-4d49-a8a7-38dc9993b440 | cdfce732-c69f-4ea6-9f95-181c19b932dd | available | <span class="built_in">test</span>        | 5    | 0            | backups   | d9737a89a5754af99610d37225abd070 |</span><br><span class="line">| c9c3ef24-e310-4685-aa54-64cd6fa7d08b | cdfce732-c69f-4ea6-9f95-181c19b932dd | available | backup-demo | 5    | 0            | backups   | d9737a89a5754af99610d37225abd070 |</span><br><span class="line">+--------------------------------------+--------------------------------------+-----------+-------------+------+--------------+-----------+----------------------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看卷详情</span></span><br><span class="line">root@localhost:/var/log/kolla/cinder<span class="comment"># cinder backup-show 6774233c-007a-4d49-a8a7-38dc9993b440</span></span><br><span class="line">+-----------------------------------+--------------------------------------+</span><br><span class="line">| Property                          | Value                                |</span><br><span class="line">+-----------------------------------+--------------------------------------+</span><br><span class="line">| availability_zone                 | None                                 |</span><br><span class="line">| container                         | backups                              |</span><br><span class="line">| created_at                        | 2024-04-02T07:48:41.000000           |</span><br><span class="line">| data_timestamp                    | 2024-04-02T07:48:41.000000           |</span><br><span class="line">| description                       | None                                 |</span><br><span class="line">| fail_reason                       | None                                 |</span><br><span class="line">| has_dependent_backups             | False                                |</span><br><span class="line">| <span class="built_in">id</span>                                | 6774233c-007a-4d49-a8a7-38dc9993b440 |</span><br><span class="line">| is_incremental                    | False                                |</span><br><span class="line">| metadata                          | &#123;&#125;                                   |</span><br><span class="line">| name                              | <span class="built_in">test</span>                                 |</span><br><span class="line">| object_count                      | 0                                    |</span><br><span class="line">| os-backup-project-attr:project_id | 2cb7b9ee85ab4d8a8257723a08c8a032     |</span><br><span class="line">| size                              | 5                                    |</span><br><span class="line">| snapshot_id                       | None                                 |</span><br><span class="line">| status                            | available                            |</span><br><span class="line">| updated_at                        | 2024-04-02T07:49:01.000000           |</span><br><span class="line">| user_id                           | d9737a89a5754af99610d37225abd070     |</span><br><span class="line">| volume_id                         | cdfce732-c69f-4ea6-9f95-181c19b932dd |</span><br><span class="line">+-----------------------------------+--------------------------------------+</span><br><span class="line"><span class="comment"># 查看卷实际上就是把卷拷贝过来一份</span></span><br><span class="line">root@localhost:/var/log/kolla/cinder<span class="comment"># rbd -p backups ls</span></span><br><span class="line">volume-cdfce732-c69f-4ea6-9f95-181c19b932dd.backup.6774233c-007a-4d49-a8a7-38dc9993b440</span><br><span class="line">volume-cdfce732-c69f-4ea6-9f95-181c19b932dd.backup.c9c3ef24-e310-4685-aa54-64cd6fa7d08b</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ciner-backup</strong>对接完成。</p><h2 id="四-nova-libvirt-与ceph对接功能测试【success！】"><a href="#四-nova-libvirt-与ceph对接功能测试【success！】" class="headerlink" title="四. nova(libvirt)与ceph对接功能测试【success！】"></a>四. nova(libvirt)与ceph对接功能测试【success！】</h2><h3 id="创建虚拟机测试-前端创建后端验证"><a href="#创建虚拟机测试-前端创建后端验证" class="headerlink" title="创建虚拟机测试 (前端创建后端验证)"></a>创建虚拟机测试 (前端创建后端验证)</h3><p><strong>查看系统盘</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(venv3) root@localhost:~<span class="comment"># rbd -p volumes ls |grep 39a0ae42-08b3-4885-850f-12536e3d2051</span></span><br><span class="line">volume-39a0ae42-08b3-4885-850f-12536e3d2051</span><br><span class="line">(venv3) root@localhost:~<span class="comment"># rbd device list</span></span><br><span class="line">(venv3) root@localhost:~<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_245c6b28748b4fb29da0f259cc4be37d.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_245c6b28748b4fb29da0f259cc4be37d.png"></p>]]></content>
      
      
      <categories>
          
          <category> openstack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix监控交换机配置报警及grafana面板设置</title>
      <link href="/2024/03/28/zabbix%E7%9B%91%E6%8E%A7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%85%8D%E7%BD%AE%E6%8A%A5%E8%AD%A6%E5%8F%8Agrafana%E9%9D%A2%E6%9D%BF%E8%AE%BE%E7%BD%AE/"/>
      <url>/2024/03/28/zabbix%E7%9B%91%E6%8E%A7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%85%8D%E7%BD%AE%E6%8A%A5%E8%AD%A6%E5%8F%8Agrafana%E9%9D%A2%E6%9D%BF%E8%AE%BE%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="zabbix监控交换机配置报警"><a href="#zabbix监控交换机配置报警" class="headerlink" title="zabbix监控交换机配置报警"></a>zabbix监控交换机配置报警</h1><h2 id="一-企业微信报警"><a href="#一-企业微信报警" class="headerlink" title="一. 企业微信报警"></a>一. 企业微信报警</h2><p>后端配置<br>语言：<strong>shell</strong><br>脚本：/usr/lib/zabbix/alertscripts/weixin.sh<br>组名改为：<strong>zabbix:zabbix</strong><br><strong>chmod a+x weixin.sh</strong>  赋予执行权限<br><strong>weixin.sh</strong>脚本内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 脚本使用：zz=`ls -l`</span></span><br><span class="line"><span class="comment"># ./weixin.sh test  &#123;&quot;errcode&quot;:0,&quot;errmsg&quot;:&quot;$zz&quot;,&quot;invaliduser&quot;:&quot;&quot;&#125;</span></span><br><span class="line"><span class="comment"># ./weixin.sh test  &#123;&quot;errcode&quot;:0,&quot;GEGEWU-TEST&quot;:&quot;\n床前明月光\n疑是地上霜\n举头望明月\n低头思故乡&quot;,&quot;invaliduser&quot;:&quot;&quot;&#125;</span></span><br><span class="line">CorpID=<span class="string">&quot;ww83dd692579d&quot;</span>                             <span class="comment"># 你的企业id</span></span><br><span class="line">Secret=<span class="string">&quot;LSwoGzg-lXJFFkSztBptbgAfLrps&quot;</span>    <span class="comment"># 你的SecretID</span></span><br><span class="line">GURL=<span class="string">&quot;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=<span class="variable">$CorpID</span>&amp;corpsecret=<span class="variable">$Secret</span>&quot;</span></span><br><span class="line">Token=$(/usr/bin/curl -s -G <span class="variable">$GURL</span> |awk -F\&quot;: <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>|awk -F\&quot; <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line"><span class="comment"># echo $Token</span></span><br><span class="line">PURL=<span class="string">&quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=<span class="variable">$Token</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">body</span></span>()&#123;</span><br><span class="line">        <span class="built_in">local</span> int agentid=1000002               <span class="comment"># 你的agentdid</span></span><br><span class="line">        <span class="built_in">local</span> UserID=<span class="string">&quot;@all&quot;</span>                     <span class="comment"># 发送的用户ID</span></span><br><span class="line">        <span class="built_in">local</span> PartyID=2                         <span class="comment"># 部门ID</span></span><br><span class="line">        <span class="built_in">local</span> Msg=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span> | <span class="built_in">cut</span> -d<span class="string">&quot; &quot;</span> -f3-) <span class="comment"># 发送给所有人</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;&#123;\n&#x27;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;\t&quot;touser&quot;: &quot;&#x27;</span><span class="string">&quot;<span class="variable">$UserID</span>&quot;</span>\&quot;<span class="string">&quot;,\n&quot;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;\t&quot;toparty&quot;: &quot;&#x27;</span><span class="string">&quot;<span class="variable">$PartyID</span>&quot;</span>\&quot;<span class="string">&quot;,\n&quot;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;\t&quot;msgtype&quot;: &quot;text&quot;,\n&#x27;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;\t&quot;agentid&quot;: &quot;&#x27;</span><span class="string">&quot;<span class="variable">$agentid</span>&quot;</span>\&quot;<span class="string">&quot;,\n&quot;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;\t&quot;text&quot;: &#123;\n&#x27;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;\t\t&quot;content&quot;: &quot;&#x27;</span><span class="string">&quot;<span class="variable">$Msg</span>&quot;</span>\&quot;<span class="string">&quot;\n&quot;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;\t&#125;,\n&#x27;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;\t&quot;safe&quot;:&quot;0&quot;\n&#x27;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;&#125;\n&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">/usr/bin/curl --data-ascii <span class="string">&quot;<span class="subst">$(body $1 $2 $3)</span>&quot;</span> <span class="variable">$PURL</span></span><br></pre></td></tr></table></figure><p>可用性测试</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_6423a1843860753100db9c0cb961464a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_6423a1843860753100db9c0cb961464a.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_e9eeec69992482f2c02585016a1a9ebc.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_e9eeec69992482f2c02585016a1a9ebc.png"></p><p>以上微信报警后端配置完毕！</p><h3 id="1-zabbix前端页面配置告警"><a href="#1-zabbix前端页面配置告警" class="headerlink" title="1. zabbix前端页面配置告警"></a>1. zabbix前端页面配置告警</h3><h4 id="1-0-管理-用户-配置报警时间-等级"><a href="#1-0-管理-用户-配置报警时间-等级" class="headerlink" title="1.0. 管理-用户 配置报警时间 等级"></a>1.0. 管理-用户 配置报警时间 等级</h4><p>特别说明：收件人-2   2 为报警<strong>机器人所在的b部门id</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_888125f3de45e9c9945bac3b5d692349.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_888125f3de45e9c9945bac3b5d692349.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_b6fa1a78467aa2bbbaad45ef6447659a.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_b6fa1a78467aa2bbbaad45ef6447659a.png"></p><h4 id="1-1-报警媒介类型"><a href="#1-1-报警媒介类型" class="headerlink" title="1.1. 报警媒介类型"></a>1.1. 报警媒介类型</h4><p><strong>管理-报警媒介类型-创建媒体类型</strong></p><p><strong>脚本参数</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;ALERT.SENDTO&#125;</span><br><span class="line">&#123;ALERT.SUBJECT&#125;</span><br><span class="line">&#123;ALERT.MESSAGE&#125;</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_8c5386fe48f1b7a90f3c7ef75ed02192.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_8c5386fe48f1b7a90f3c7ef75ed02192.png"></p><p><strong>设置默认报警发送信息</strong></p><p>管理-报警媒介类型-创建媒体类型-message templates 3-点击添加-选择-问题</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">主题：</span><br><span class="line">故障&#123;TRIGGER.STATUS&#125;,机器:&#123;HOSTNAME1&#125;发生: &#123;TRIGGER.NAME&#125;故障!</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">消息：</span><br><span class="line"> </span><br><span class="line">告警机器:&#123;HOSTNAME1&#125;</span><br><span class="line">告警主机:&#123;HOST.NAME&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure><p><strong>点击选择：problem recovery</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">主题：</span><br><span class="line">恢复&#123;TRIGGER.STATUS&#125;, 机器:&#123;HOSTNAME1&#125;: &#123;TRIGGER.NAME&#125;已恢复!</span><br><span class="line"> </span><br><span class="line">消息：</span><br><span class="line">告警机器:&#123;HOSTNAME1&#125;</span><br><span class="line">告警主机:&#123;HOST.NAME&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure><p><strong>设置好后样式</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_5f6c7c481dd5a5e6f394abbc3edfbc91.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_5f6c7c481dd5a5e6f394abbc3edfbc91.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_7317fad2e7265063fc284c4657d37336.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_7317fad2e7265063fc284c4657d37336.png"></p><p><strong>配置-动作-Tigger actions-创建动作微信告警</strong></p><ul><li>名称 :  微信报警</li><li>计算方式 : 和（同时满足）(A and B) and C</li><li>条件</li></ul><table><thead><tr><th>标签</th><th>名称</th><th>动作</th></tr></thead><tbody><tr><td><strong>A</strong></td><td>触发器名称 不含<em>Dialer</em></td><td>移除</td></tr><tr><td><strong>B</strong></td><td>触发器名称 包含<em>down</em></td><td>移除</td></tr><tr><td><strong>C</strong></td><td>主机群组 不等于<em>张家口</em></td><td>移除</td></tr><tr><td>添加</td><td></td><td></td></tr></tbody></table><p>  <strong>本文使用此<br>  名称 :  微信报警</strong><br>  计算方式 : 与/或 （默认）</p><table><thead><tr><th>标签</th><th>名称</th><th>动作</th></tr></thead><tbody><tr><td><strong>A</strong></td><td>触发器示警度 大于等于 警告</td><td>移除</td></tr><tr><td><strong>B</strong></td><td>触发器示警度 大于等于 未分类</td><td>移除</td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p>  <img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_8beb0459a4e8371c8d40f0b0e0bba60b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_8beb0459a4e8371c8d40f0b0e0bba60b.png"></p><p>  <img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_3ea30163e5c0105262ced1c11bf11d7d.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_3ea30163e5c0105262ced1c11bf11d7d.png"></p><ul><li><p>已启用 [X]</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_30dad5e3e18fbd9afa4fd05d59d22ec8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_30dad5e3e18fbd9afa4fd05d59d22ec8.png"></p></li></ul><p><strong>设置操作</strong></p><p>告警细节</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">设备:&#123;HOST.NAME&#125;发生: &#123;TRIGGER.NAME&#125;告警!\n告警主机:&#123;HOST.NAME&#125;\n告警地址:&#123;HOST.IP&#125;\n告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br></pre></td></tr></table></figure><p>恢复细节</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">告警主机:&#123;HOST.NAME&#125;\n告警信息: &#123;TRIGGER.NAME&#125;已恢复！\n当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;\n告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;\n恢复时间:&#123;EVENT.RECOVERY.DATE&#125; &#123;EVENT.RECOVERY.TIME&#125;\n持续时间:&#123;EVENT.AGE&#125;</span><br></pre></td></tr></table></figure><p><strong>更新暂时不写</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_2c6085aabbe2423e90b8f16a44cd3b1e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_2c6085aabbe2423e90b8f16a44cd3b1e.png"></p><h4 id="1-2-或者设置如下冗长版本设置方式如下参考"><a href="#1-2-或者设置如下冗长版本设置方式如下参考" class="headerlink" title="1.2. 或者设置如下冗长版本设置方式如下参考"></a>1.2. 或者设置如下冗长版本设置方式如下参考</h4><p>操作 添加<br>步骤选择：1-1<br>步骤时间：0 （默认）<br>用户群组默认管理员群组 ：Zabbix administrators<br>仅发送到：微信告警<br>cus message ： [X]</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">主题：</span><br><span class="line">故障&#123;TRIGGER.STATUS&#125;,机器:&#123;HOSTNAME1&#125;发生: &#123;TRIGGER.NAME&#125;故障!</span><br><span class="line"> </span><br><span class="line">消息：</span><br><span class="line">告警机器:&#123;HOSTNAME1&#125;</span><br><span class="line">告警主机:&#123;HOST.NAME&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">————————————————</span><br></pre></td></tr></table></figure><p>恢复操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">主题：</span><br><span class="line">机器:&#123;HOST.NAME&#125;: &#123;TRIGGER.NAME&#125;已恢复!</span><br><span class="line"> </span><br><span class="line">消息：</span><br><span class="line">机器:&#123;HOST.NAME&#125;: &#123;TRIGGER.NAME&#125;已恢复!</span><br><span class="line">告警主机:&#123;HOST.NAME&#125;</span><br><span class="line">告警地址:&#123;HOST.IP&#125;</span><br><span class="line">监控取值:&#123;ITEM.LASTVALUE&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">恢复时间:&#123;EVENT.RECOVERY.DATE&#125; &#123;EVENT.RECOVERY.TIME&#125;</span><br><span class="line">持续时间:&#123;EVENT.AGE&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure><p>注：更新操作暂时不写。<br>此时点击启用新创建的微信告警：即启用动作</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_3119571721f2605c8403618b944a5384.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_3119571721f2605c8403618b944a5384.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_82a0baf528dbe6863ab110882f7d84e8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_82a0baf528dbe6863ab110882f7d84e8.png"></p><h2 id="二-zabbix出图添加交换机设置"><a href="#二-zabbix出图添加交换机设置" class="headerlink" title="二. zabbix出图添加交换机设置"></a>二. zabbix出图添加交换机设置</h2><h3 id="2-1-添加设备"><a href="#2-1-添加设备" class="headerlink" title="2.1. 添加设备"></a>2.1. 添加设备</h3><p><strong>配置-群组-创建群组（如未来科技城）</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_c6fb86456c1f1b9eba430942b08b77ff.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_c6fb86456c1f1b9eba430942b08b77ff.png"></p><p><strong>监测-主机-添加主机（根据交换机厂商选择合适的监控模板如华为则选择华为）</strong></p><p>主机名称：10.0.0.10<br>可见名称：华为CE6851<br>模板： Huawei VRP by SNMP<br>群组：未来科技城<br>interfaces<br>类型：snmp<br>版本 snmpV2<br>snmp community（团体名）： passwd<br>连接到ip DNS 端口：161<br>由agent代理程序监测 (无agent代理程序)<br>已启用</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_e19dd19666176395dc07dfda08b59091.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_e19dd19666176395dc07dfda08b59091.png"></p><p><strong>模板选择（以华为交换机为例）</strong></p><p>模板-主机群组<code>-Templates/Network devices-HuaweiVRPbySNMP</code></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_6f42f938f9b0285953e4100811df34b7.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_6f42f938f9b0285953e4100811df34b7.png"></p><h3 id="2-2-华为CE系例特别说明"><a href="#2-2-华为CE系例特别说明" class="headerlink" title="2.2. 华为CE系例特别说明"></a>2.2. 华为CE系例特别说明</h3><p>见🔗链接 | <strong><a href="https://blog.csdn.net/m0_59586152/article/details/125200506">特别介绍关于huaweiCE系列的cpu监控(此处zabbix自带的监控有时候无法采集成功)</a></strong></p><h2 id="三-grafana面板配置（建议grafana版本为8-5-2）"><a href="#三-grafana面板配置（建议grafana版本为8-5-2）" class="headerlink" title="三. grafana面板配置（建议grafana版本为8.5.2）"></a>三. grafana面板配置（建议grafana版本为8.5.2）</h2><h3 id="3-1-安装zabbix插件"><a href="#3-1-安装zabbix插件" class="headerlink" title="3.1. 安装zabbix插件"></a>3.1. 安装zabbix插件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@gegewu1:/opt/grafana-8.5.2/bin<span class="comment"># ./grafana-cli plugins install alexanderzobnin-zabbix-app</span></span><br><span class="line">✔ Downloaded alexanderzobnin-zabbix-app v4.2.8 zip successfully</span><br><span class="line"> </span><br><span class="line">Please restart Grafana after installing plugins. Refer to Grafana documentation <span class="keyword">for</span> instructions <span class="keyword">if</span> necessary.</span><br><span class="line"> </span><br><span class="line">root@gegewu1:/opt/grafana-8.5.2/bin<span class="comment">#</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>配置zabbix源时需要将80端口写出否则会添加失败即：<a href="http://10.0.0.10/zabbix/api_jsonrpc.php">http://10.0.0.10:80/zabbix/api_jsonrpc.php</a></p><p><strong>配置好前端zabbix组件后 选择合适需要监控的端口即可</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_a1cb215aaf904a7b1c6517dae8c43a38.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_a1cb215aaf904a7b1c6517dae8c43a38.png"></p><p><strong>效果</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_9e24dccc0ed9e1529e55edd526aef9ea.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_9e24dccc0ed9e1529e55edd526aef9ea.png"></p><p>本文参考 |<br><a href="https://blog.csdn.net/m0_59586152/article/details/125136342">https://blog.csdn.net/m0_59586152/article/details/125136342</a><br><a href="https://blog.csdn.net/m0_59586152/article/details/125200506">https://blog.csdn.net/m0_59586152/article/details/125200506</a></p>]]></content>
      
      
      <categories>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wordpress设置WP SMTP邮件提醒</title>
      <link href="/2024/03/27/wordpress%E8%AE%BE%E7%BD%AEWP%20SMTP%E9%82%AE%E4%BB%B6%E6%8F%90%E9%86%92/"/>
      <url>/2024/03/27/wordpress%E8%AE%BE%E7%BD%AEWP%20SMTP%E9%82%AE%E4%BB%B6%E6%8F%90%E9%86%92/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="wordpress设置WP-SMTP邮件提醒"><a href="#wordpress设置WP-SMTP邮件提醒" class="headerlink" title="wordpress设置WP SMTP邮件提醒"></a>wordpress设置WP SMTP邮件提醒</h2><blockquote><p>本文使用wordpress插件 &gt; <a href="https://wordpress.org/plugins/wp-smtp/">WP SMTP</a> 安装 &gt; <a href="https://wn-apple-teawine.fun/2023/10/08/wordpress%E5%8D%9A%E5%AE%A2-docker-compose%E6%9E%84%E5%BB%BA/?highlight=%E5%90%84%E7%A7%8D">wordpress安装链接</a></p><p>插件安装包留存地址 | <a href="https://drive.zznnwn.cloudns.biz/api/raw/?path=/boke/wordpress/WP-SMTP/wp-smtp.1.2.6.zip">传送门</a></p></blockquote><h3 id="wordpress安装WP-SMTP插件方法"><a href="#wordpress安装WP-SMTP插件方法" class="headerlink" title="wordpress安装WP SMTP插件方法"></a>wordpress安装WP SMTP插件方法</h3><p>插件 &gt; 添加插件 &gt; 上传插件 &gt; 选择文件 | 此时平台会自动安装此插件</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_c6dc16744541929c15f31c5105b4877d.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_c6dc16744541929c15f31c5105b4877d.png"></p><h3 id="配置smtp服务"><a href="#配置smtp服务" class="headerlink" title="配置smtp服务"></a>配置smtp服务</h3><p>主要配置邮箱授权码 设置 &gt; 讨论 &gt; 开启评论提醒</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_8079623496c957fa91390f39150ee7e8.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_8079623496c957fa91390f39150ee7e8.png"></p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_d8ba9af400a0c44fca7a8b7aa6bd50bd.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_d8ba9af400a0c44fca7a8b7aa6bd50bd.png"></p><p><strong>本文参考</strong></p><p><a href="https://blog.naibabiji.com/tutorial/wordpress-smtp-cha-jian.html#wp_smtp">https://blog.naibabiji.com/tutorial/wordpress-smtp-cha-jian.html#wp_smtp</a></p>]]></content>
      
      
      <categories>
          
          <category> wordpress </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wordpress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux命令筛选出ipv4地址并去重计算出现次数</title>
      <link href="/2024/03/25/linux%E5%91%BD%E4%BB%A4%E7%AD%9B%E9%80%89%E5%87%BAipv4%E5%9C%B0%E5%9D%80%E5%B9%B6%E5%8E%BB%E9%87%8D%E8%AE%A1%E7%AE%97%E5%87%BA%E7%8E%B0%E6%AC%A1%E6%95%B0/"/>
      <url>/2024/03/25/linux%E5%91%BD%E4%BB%A4%E7%AD%9B%E9%80%89%E5%87%BAipv4%E5%9C%B0%E5%9D%80%E5%B9%B6%E5%8E%BB%E9%87%8D%E8%AE%A1%E7%AE%97%E5%87%BA%E7%8E%B0%E6%AC%A1%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>linux命令筛选出ipv4地址并去重计算出现次数<a href>                                              </a></strong></p><p>代码如下：</p><ul><li><strong>grep -oE “\b([0-9]{1,3}.){3}[0-9]{1,3}\b” 1.txt |sort -nr |uniq -c</strong></li><li><strong>ss -ant |grep ESTAB |awk -F ‘[ :]+’  ‘{print $4}’ |grep -v ‘[‘ |sort -rn |uniq -c</strong></li><li><strong>cat 1.txt  |awk -F ‘[ :]+’  ‘/^ip/{print $2}’ |sort -nr |uniq -c</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@k8s:~<span class="comment"># cat 1.txt </span></span><br><span class="line">ip: 10.10.10.1:1080</span><br><span class="line">ip: 10.10.10.2:1080</span><br><span class="line">ip: 10.10.10.4:2050</span><br><span class="line">ip: 10.10.10.2:1020</span><br><span class="line">root@k8s:~<span class="comment"># ss -ant |grep -oE &quot;\b([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;\b&quot; 1.txt</span></span><br><span class="line">10.10.10.1</span><br><span class="line">10.10.10.2</span><br><span class="line">10.10.10.4</span><br><span class="line">10.10.10.2</span><br><span class="line">root@k8s:~<span class="comment"># grep -oE &quot;\b([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;\b&quot; 1.txt |sort -nr |uniq -c</span></span><br><span class="line">      1 10.10.10.4</span><br><span class="line">      2 10.10.10.2</span><br><span class="line">      1 10.10.10.1</span><br><span class="line">root@k8s:~<span class="comment"># ss -ant |grep ESTAB |awk -F &#x27;[ :]+&#x27;  &#x27;&#123;print $4&#125;&#x27; |grep -v &#x27;\[&#x27; |sort -rn |uniq -c</span></span><br><span class="line">      1 172.16.0.1</span><br><span class="line">    124 127.0.0.1</span><br><span class="line">     10 10.0.0.240</span><br><span class="line">root@k8s:~<span class="comment"># cat 1.txt  |awk -F &#x27;[ :]+&#x27;  &#x27;/^ip/&#123;print $2&#125;&#x27; |sort -nr |uniq -c</span></span><br><span class="line">      1 10.10.10.4</span><br><span class="line">      2 10.10.10.2</span><br><span class="line">      1 10.10.10.1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shell实现计算斐波那契数列</title>
      <link href="/2024/03/24/Shell%E5%AE%9E%E7%8E%B0%E8%AE%A1%E7%AE%97%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97/"/>
      <url>/2024/03/24/Shell%E5%AE%9E%E7%8E%B0%E8%AE%A1%E7%AE%97%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="Shell实现斐波那契数列计算"><a href="#Shell实现斐波那契数列计算" class="headerlink" title="Shell实现斐波那契数列计算"></a>Shell实现斐波那契数列计算</h3><p><a href="https://zh.numberempire.com/fibonaccinumbers.php">斐波那契数计算器 (numberempire.com)</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">fibonacci</span></span>() &#123;</span><br><span class="line">    n=<span class="variable">$1</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$n</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> 0</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$n</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> 1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        a=0</span><br><span class="line">        b=1</span><br><span class="line">        i=2</span><br><span class="line">        <span class="keyword">while</span> [ <span class="variable">$i</span> -le <span class="variable">$n</span> ]; <span class="keyword">do</span></span><br><span class="line">            c=$((a + b))</span><br><span class="line">            a=<span class="variable">$b</span></span><br><span class="line">            b=<span class="variable">$c</span></span><br><span class="line">            i=$((i + <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$b</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;请输入N值（N &lt; 50）: &quot;</span> N</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$N</span> -ge 0 ] &amp;&amp; [ <span class="variable">$N</span> -lt 50 ]; <span class="keyword">then</span></span><br><span class="line">    result=$(fibonacci <span class="variable">$N</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;斐波那契数列的第 <span class="variable">$N</span> 项为: <span class="variable">$result</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;输入的N值不在有效范围内！&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_caa7837e83fa0efebe83bac133122bd4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_caa7837e83fa0efebe83bac133122bd4.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_e9d599e5ba7c00c4a861753f0f01a4cb.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_e9d599e5ba7c00c4a861753f0f01a4cb.png"></p>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ceph集群扩容与缩容节点</title>
      <link href="/2024/03/23/ceph%E9%9B%86%E7%BE%A4%E6%89%A9%E5%AE%B9%E4%B8%8E%E7%BC%A9%E5%AE%B9%E8%8A%82%E7%82%B9/"/>
      <url>/2024/03/23/ceph%E9%9B%86%E7%BE%A4%E6%89%A9%E5%AE%B9%E4%B8%8E%E7%BC%A9%E5%AE%B9%E8%8A%82%E7%82%B9/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ceph集群扩容与缩容节点"><a href="#ceph集群扩容与缩容节点" class="headerlink" title="ceph集群扩容与缩容节点"></a>ceph集群扩容与缩容节点</h3><p><a href="https://wn-apple-teawine.fun/2023/08/29/cephadm%E9%83%A8%E7%BD%B2ceph-quincy%E7%89%88%E6%9C%AC/"><strong>一. 扩容常规添加节点即可</strong></a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭自动添加osd</span></span><br><span class="line">ceph orch apply osd --all-available-devices --unmanaged=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 添加ceph-4为新节点</span></span><br><span class="line">ssh-copy-id ceph-4</span><br><span class="line">ssh-copy-id -f -i /etc/ceph/ceph.pub root@ceph-4</span><br><span class="line"><span class="comment"># ceph-4 换源 </span></span><br><span class="line"><span class="comment"># 设置ceph quincy源 </span></span><br><span class="line"><span class="comment"># 设置docker镜像加速 &gt;&gt; 略 (ceph-4操作)</span></span><br><span class="line">hostnamectl set-hostname ceph-4</span><br><span class="line">apt install -y python3 systemd lvm2 ceph-common</span><br><span class="line">curl -sSL https://get.daocloud.io/docker | sh</span><br><span class="line"><span class="comment"># 主节点执行添加节点</span></span><br><span class="line">ceph orch host add ceph-4</span><br></pre></td></tr></table></figure><p><strong>二. 节点缩容( 注意顺序 )–暂未测试</strong></p><blockquote><p>此处需要注意副本数  比如集群为三副本三台服务器缩减为两台时 此时集群缺失一节点就变成了 两副本 移除节点需要调整副本数 副本数不能小于<code>2</code>即最小能支持的缩减为3节点 &gt;&gt; 2节点</p></blockquote><p><a href="https://gegewu-cloud.github.io/2023/09/01/ceph%E9%9B%86%E7%BE%A4%E4%B9%8Bosd%E5%9D%8F%E7%9B%98%E5%89%94%E9%99%A4/">osd坏盘剔除参考此处链接即可</a></p><p><a href="https://wn-apple-teawine.fun/2023/10/29/ceph%E9%9B%86%E7%BE%A4%E4%B9%8Bceph-quincy%E7%89%88%E6%9C%ACcephadm%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F%E4%BF%AE%E6%94%B9ceph%E9%85%8D%E7%BD%AE/">cephadm部署方式更改配置参考此处含ceph-deploy方式更改副本数</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先设置不迁移数据</span></span><br><span class="line">ceph osd <span class="built_in">set</span> noout</span><br><span class="line"><span class="comment"># 若节点为3节点锁容为2节点则需要 更改副本数为2 ceph的crashmap默认以主机为单位 (副本数不能小于2)</span></span><br><span class="line">ceph config <span class="built_in">help</span> osd_pool_default_size                     <span class="comment"># 查看当前副本数配置</span></span><br><span class="line">ceph config-key <span class="built_in">set</span> config/global/osd_pool_default_size 2  <span class="comment"># 设置副本数为2</span></span><br><span class="line">systemctl restart ceph.target                              <span class="comment"># 重启生效</span></span><br><span class="line"><span class="comment"># 已经存在的pool需要手动设置副本数 (副本数不能小于2)</span></span><br><span class="line">ceph osd pool  <span class="built_in">set</span> ceph-demo size  2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他如mds mgr mon等节点数量也要对应缩减</span></span><br><span class="line">ceph orch apply mon --placement=<span class="string">&quot;2 ceph-1 ceph-2&quot;</span>   </span><br><span class="line">ceph orch apply mgr --placement=<span class="string">&quot;2 ceph-1 ceph-2&quot;</span></span><br><span class="line">ceph orch apply rgw  foo --placement=<span class="string">&quot;2 ceph-1 ceph-2&quot;</span> --port=8000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从集群中删除关于该ceph-3主机的所有守护进程</span></span><br><span class="line">ceph orch host drain ceph-3</span><br><span class="line"><span class="comment"># 将_no_schedule标签应用于主机至于维护模式</span></span><br><span class="line">ceph orch host label add ceph-3 _no_schedule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭自动添加osd</span></span><br><span class="line">ceph orch apply osd --all-available-devices --unmanaged=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 移除osd</span></span><br><span class="line">ceph osd out osd.1</span><br><span class="line">ceph osd purge osd.1 --yes-i-really-mean-it</span><br><span class="line">ceph osd <span class="built_in">rm</span> osd.1</span><br><span class="line">ceph orch daemon <span class="built_in">rm</span> osd.1 --force</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cephfs搭建及权限管理</title>
      <link href="/2024/03/23/cephfs%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/"/>
      <url>/2024/03/23/cephfs%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="cephfs搭建及权限管理-本文单节点测试"><a href="#cephfs搭建及权限管理-本文单节点测试" class="headerlink" title="cephfs搭建及权限管理(本文单节点测试)"></a>cephfs搭建及权限管理(本文单节点测试)</h3><p><strong>拖布图</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_3e7fad3ed82c19ee8bc03e153c89c81f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_3e7fad3ed82c19ee8bc03e153c89c81f.png"></p><p><strong>架构</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_c33ff0f84010148834f8b19aae653197.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_c33ff0f84010148834f8b19aae653197.png"></p><p><strong>cephFS简介</strong></p><p>每个CephFS文件系统至少需要一个MDS（metadata server），一般是三个。CephFS 是个与 POSIX 标准兼容的文件系统，文件目录和其他元数据存储在RADOS中，MDS缓存元信息和文件目录信息。</p><p>cephfs的核心组件有：MDS、Clients、RADOS。</p><p>参考：<a href="https://cloud.tencent.com/developer/article/1664666">CephFS 介绍及使用经验分享</a>。</p><blockquote><p>各个组件之间的依赖关系如下：</p><ul><li>client 《==》 MDS：元数据操作和capalities。</li><li>Client 《==》 OSD： 数据IO。</li><li>MDS 《==》 OSD：元数据IO。</li></ul></blockquote><p>cephfs支持用户级别和内核级别的挂载使用，可扩展性高，并且可以共享文件系统，多个clients可以同时读写。MDS支持高可用性，默认采用的是主备模式（也可以通过配置改为多主），并且cephfs支持文件系统的配额限制。</p><blockquote><p>cephfs中MDS多主的优势及特点如下：</p><ul><li>当元数据默认的单个 MDS 成为瓶颈时，配置多个活跃的 MDS 守护进程，提升集群性能。</li><li>多个活跃的 MDS 有利于性能提升。</li><li>多个活跃的MDS 可以实现MDS负载均衡。</li><li>多个活跃的MDS 可以实现多租户资源隔离。</li><li>它能够将文件系统树分割成子树，每个子树可以交给特定的MDS进行权威管理，从而达到了随着元数据服务器数量的增加，集群性能线性地扩展。</li><li>每个子树都是基于元数据在给定目录树中的热动态创建的。</li><li>一旦创建了子树，它的元数据就被迁移到一个未加载的MDS。</li><li>后续客户端对先前授权的MDS的请求被转发。</li></ul></blockquote><h3 id="一-创建mds"><a href="#一-创建mds" class="headerlink" title="一. 创建mds"></a>一. <strong>创建</strong>mds</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先开启mds组件，cephfs：文件系统名称；–placement：指定集群内需要几个mds，后面跟主机名（等待一分钟完成创建）</span></span><br><span class="line">ceph orch apply mds cephfs --placement=<span class="string">&quot;2 ceph1 ceph2&quot;</span></span><br><span class="line"><span class="comment"># 返回</span></span><br><span class="line">Scheduled mds.cephfs update...</span><br><span class="line"><span class="comment"># 创建cephfs，ceph q版不指定pg的话，默认自动调整 不能使用 rbd init 初始化</span></span><br><span class="line">ceph osd pool create cephfs_data 8 8</span><br><span class="line">ceph osd pool create cephfs_metadata 8 8</span><br><span class="line"><span class="comment"># 返回</span></span><br><span class="line">pool <span class="string">&#x27;cephfs_metadata&#x27;</span> created</span><br><span class="line"><span class="comment"># 将两个pool关联起来</span></span><br><span class="line">ceph fs new cephfsdemo cephfs_metadata cephfs_data</span><br><span class="line"><span class="comment"># 返回</span></span><br><span class="line">new fs with metadata pool 3 and data pool 2</span><br><span class="line"><span class="comment"># 查看各节点是否已启动mds容器；还可以使用ceph orch ps 查看某一节点运行的容器</span></span><br><span class="line">ceph orch ps --daemon-type mds</span><br></pre></td></tr></table></figure><p><strong>查看mds信息</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看cephfs信息</span></span><br><span class="line">ceph fs <span class="built_in">ls</span></span><br><span class="line">name: cephfs, metadata pool: cephfs_metadata, data pools: [cephfs_data ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看mds状态</span></span><br><span class="line">ceph mds <span class="built_in">stat</span></span><br><span class="line">cephfs:1 &#123;0=cephfs.ceph-1.uuemyr=up:active&#125; 1 up:standby</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看mds详细信息</span></span><br><span class="line">ceph fs status </span><br><span class="line"></span><br><span class="line">RANK  STATE           MDS              ACTIVITY     DNS    INOS   DIRS   CAPS  </span><br><span class="line"> 0    active  cephfs.ceph-2.iuvxfu  Reqs:    0 /s    16     19     13      1</span><br></pre></td></tr></table></figure><p>删除<code>cephfs</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph fs <span class="built_in">rm</span> &lt;fs-name&gt; --yes-i-really-mean-it </span><br></pre></td></tr></table></figure><h3 id="二-挂载cephfs"><a href="#二-挂载cephfs" class="headerlink" title="二. 挂载cephfs"></a>二. 挂载<code>cephfs</code></h3><p><strong>临时挂载</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用内核级别挂载：</span></span><br><span class="line"> <span class="built_in">mkdir</span> -p /mnt/cephfs/</span><br><span class="line"> mount -t ceph 10.0.0.124:6789:/ /mnt/cephfs/ -o name=admin  （自动识别admin key）</span><br><span class="line"> 或</span><br><span class="line"> mount -t ceph 10.0.0.124:6789:/ /mnt/cephfs -o name=admin,secret=AQCeoO1j+e+lMhAAP2izu6rTQSGz0oyJkLw9UQ==</span><br><span class="line"> 或</span><br><span class="line"> <span class="comment"># 文件密钥挂载：</span></span><br><span class="line"> <span class="built_in">echo</span> AQDqOnNf7tGvHhAAZoXbhXRbETxRLBTl5DT1MQ== &gt;&gt; admin.key</span><br><span class="line"> mount -t ceph 192.168.229.114:6789:/ /cephfs/ -o name=admin,secretfile=admin.key</span><br><span class="line"><span class="comment"># 扩展查看key:  </span></span><br><span class="line">ceph auth <span class="built_in">ls</span></span><br><span class="line">指定用户挂载 需要先建立cephx认证用户内核级别配置永久挂载</span><br></pre></td></tr></table></figure><p><strong>用户态挂载（例子）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install ceph-fuse     <span class="comment"># 安装客户端</span></span><br><span class="line">$ apt -y install ceph-fuse</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">mkdir</span> /ceph-fuse   <span class="comment"># 创建挂载点并挂载使用</span></span><br><span class="line"></span><br><span class="line">$ ceph-fuse -n client.admin -m 192.168.99.11:6789,192.168.99.12:6789,192.168.99.13:6789 /ceph-fuse</span><br><span class="line"><span class="comment"># monitor地址可以可以指定一个或多个（如果其中一个宕机不影响使用）</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">df</span> -hT /ceph-fuse       <span class="comment"># 查看确认</span></span><br><span class="line">文件系统       类型            容量  已用  可用 已用% 挂载点</span><br><span class="line">ceph-fuse      fuse.ceph-fuse   94G     0   94G    0% /ceph-fuse</span><br></pre></td></tr></table></figure><p><strong>永久挂载</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入配置文件：/etc/fstab </span></span><br><span class="line"><span class="comment"># 密钥文件</span></span><br><span class="line">  10.0.0.124:6789:/ /mnt/cephfs ceph name=admin,secretfile=/root/adminkey,noatime 0 0</span><br><span class="line"><span class="comment"># 直接指定密钥</span></span><br><span class="line">  10.0.0.124:6789:/ /mnt/cephfs ceph name=admin,secret=AQCeoO1j+e+lMhAAP2izu6rTQSGz0oyJkLw9UQ==,noatime,_netdev 0 0</span><br><span class="line"></span><br><span class="line">关机验证：正常挂载 / monut -a 即可验证</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_7a032c8de07240c963b4846f8b971faf.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_7a032c8de07240c963b4846f8b971faf.png"></p><h3 id="三-ceph权限控制"><a href="#三-ceph权限控制" class="headerlink" title="三. ceph权限控制"></a>三. <a href="https://www.cnblogs.com/lvzhenjiang/p/14907610.html#35-%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E6%8C%82%E8%BD%BD%E4%BD%BF%E7%94%A8"><strong>ceph权限控制</strong></a></h3><h4 id="3-6-不同用户挂载不同目录"><a href="#3-6-不同用户挂载不同目录" class="headerlink" title="3.6 不同用户挂载不同目录"></a>3.6 不同用户挂载不同目录</h4><h5 id="3-6-1-添加新的pool到cephfs"><a href="#3-6-1-添加新的pool到cephfs" class="headerlink" title="3.6.1 添加新的pool到cephfs"></a>3.6.1 添加新的pool到cephfs</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cephfs中增加新的pool</span></span><br><span class="line">ceph osd pool create cephfs_data1 4 4           # 创建pool</span><br><span class="line">ceph fs add_data_pool cephfsdemo cephfs_data1  # 加到cephfs中  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-6-2-创建bruce的用户，这个用户只能访问目录-bruce，数据存储在-pool-cephfs-data1-中"><a href="#3-6-2-创建bruce的用户，这个用户只能访问目录-bruce，数据存储在-pool-cephfs-data1-中" class="headerlink" title="3.6.2 创建bruce的用户，这个用户只能访问目录/bruce，数据存储在 pool cephfs_data1 中"></a>3.6.2 创建bruce的用户，这个用户只能访问目录/bruce，数据存储在 <code>pool cephfs_data1</code> 中</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建bruce的用户，这个用户只能访问目录/bruce，数据存储在 `pool cephfs_data1` 中</span></span><br><span class="line">ceph auth get-or-create client.bruce mon &#x27;allow r&#x27; mds &#x27;allow r, allow rw path=/bruce&#x27; osd &#x27;allow rw pool=cephfs_data1&#x27; -o ceph.client.bruce.keyring</span><br><span class="line">// 返回</span><br><span class="line">[client.bruce]</span><br><span class="line">key = AQCtFc9g/CmyERAAzi7ORpEWIxlMiiFC1GK7nA==</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_85fe5cb0da273b96eb63b2ca004dc93c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_85fe5cb0da273b96eb63b2ca004dc93c.png"></p><h5 id="3-6-3-客户端挂载"><a href="#3-6-3-客户端挂载" class="headerlink" title="3.6.3 客户端挂载"></a>3.6.3 客户端挂载</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端挂载</span></span><br><span class="line">mkdir /data1</span><br><span class="line">mount -t ceph 192.168.99.11:6789,192.168.99.12:6789,192.168.99.13:6789:/ /data1/ -o name=bruce,secret=AQCtFc9g/CmyERAAzi7ORpEWIxlMiiFC1GK7nA==</span><br></pre></td></tr></table></figure><h3 id="四、cephfs权限与访问控制"><a href="#四、cephfs权限与访问控制" class="headerlink" title="四、cephfs权限与访问控制"></a>四、cephfs权限与访问控制</h3><h4 id="4-1-添加用户"><a href="#4-1-添加用户" class="headerlink" title="4.1 添加用户"></a>4.1 添加用户</h4><p>添加用户<code>jerry，jerry</code>只有对<code>/jerry</code>路径下的文件具有读写权限，对其他路径下的文件只有读的权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建权限密钥</span></span><br><span class="line">ceph auth get-or-create client.jerry mon &#x27;allow r&#x27; mds &#x27;allow rw,allow rw path=/jerry&#x27; osd &#x27;allow rw pool=cephfs_data2&#x27; -o ceph.client.jerry.keyring</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用jerry用户挂载</span></span><br><span class="line">mount -t ceph 10.0.0.10:6789:/ /data -o name=jerry,secret=AQAo0/9lI2g7KRAA8AqwdIUhGQcS4tJgltSlzw==</span><br></pre></td></tr></table></figure><h4 id="4-2-获取权限列表"><a href="#4-2-获取权限列表" class="headerlink" title="4.2 获取权限列表"></a>4.2 获取权限列表</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph auth list</span></span><br></pre></td></tr></table></figure><h4 id="4-3-删除用户"><a href="#4-3-删除用户" class="headerlink" title="4.3 删除用户"></a>4.3 删除用户</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph auth del client.jerry</span></span><br></pre></td></tr></table></figure><h4 id="4-4-获取某个用户的key"><a href="#4-4-获取某个用户的key" class="headerlink" title="4.4 获取某个用户的key"></a>4.4 获取某个用户的key</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph auth get-key client.bruce</span></span><br></pre></td></tr></table></figure><h4 id="4-5-修改用户权限"><a href="#4-5-修改用户权限" class="headerlink" title="4.5 修改用户权限"></a>4.5 修改用户权限</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph auth caps client.jerry mon <span class="string">&#x27;allow r&#x27;</span> mds <span class="string">&#x27;allow r, allow rw path=/jerry, allow rw path=/test&#x27;</span> osd <span class="string">&#x27;allow rw&#x27;</span></span></span><br></pre></td></tr></table></figure><h4 id="4-6-注意事项"><a href="#4-6-注意事项" class="headerlink" title="4.6 注意事项"></a>4.6 注意事项</h4><blockquote><ul><li>当用java api操作cephfs时，api无法指定新建文件or目录的所属用户or所属组，这两个属性取决于运行java程序时的当前用户(uid)及其所属的用户组(gid)</li><li>经过测试发现，cephfs文件or目录的权限是linux本身用户权限和cephfs用户权限的交集</li><li>修改用户权限后，在本地需要重新挂载才可生效</li><li>建目录，设置权限无需前后顺序</li></ul></blockquote><p><strong>本文参考：</strong></p><p>官网：<br><a href="https://docs.ceph.com/en/quincy/cephfs/#ceph-file-system">https://docs.ceph.com/en/quincy/cephfs/#ceph-file-system</a><br>挂载：<br><a href="https://docs.ceph.com/en/quincy/cephfs/mount-using-kernel-driver/">https://docs.ceph.com/en/quincy/cephfs/mount-using-kernel-driver/</a><br>cephfs介绍+各种测试：<br><a href="http://www.yangguanjun.com/2017/07/16/cephfs-test-method-lite/">http://www.yangguanjun.com/2017/07/16/cephfs-test-method-lite/</a></p>]]></content>
      
      
      <categories>
          
          <category> ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ceph rbd数据写入流程</title>
      <link href="/2024/03/20/ceph%20rbd%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B/"/>
      <url>/2024/03/20/ceph%20rbd%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ceph-rbd数据写入流程"><a href="#ceph-rbd数据写入流程" class="headerlink" title="ceph rbd数据写入流程"></a>ceph rbd数据写入流程</h3><p><strong>拓补图：</strong></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_14d0de28111417c8dc2aa9088c5b6136.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_14d0de28111417c8dc2aa9088c5b6136.png"></p><p><strong>图片解析：</strong><br><code>存储过程：</code>一个文件切割为很多部分 比如一个100M的文件最终会切割成25个4M（默认4M）的文件<br><code>切割之后：</code>每个<code>object</code>都会有一个<code>object id  object id</code> 需要存储到pg里面去 此处进行一个运算把<code>object id 作为一个哈希   &gt;&gt; 对其进行掩码运算 &gt;&gt; 得到pgid </code>pg上面：<code> 存储多个object</code> &gt;&gt; 通过<code>crush</code>算法把<code>pg</code>做一次运算分配到 集群中对应的<code>osd</code>节点上(根据<code>crush</code>层次的不同<code>osd</code>也会落到不同的地方 )<br>比如<code>crush</code>算法定义的是以机架为单位的 此时便会落到不同的机架上的<code>osd</code>上从而确保数据的高可用性</p><p><strong>实际操作演示：</strong></p><p>文件切割大小验证 演示文件 id: rbd_data.38074c091b82.0000000000000200</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rbd info ceph-demo/rbd-demo.img   或    rbd -p ceph-demo info rbd-demo.img （查看命令）</span><br><span class="line">rbd image <span class="string">&#x27;rbd-demo.img&#x27;</span>:</span><br><span class="line">        size 11 GiB <span class="keyword">in</span> 2816 objects</span><br><span class="line">        order 22 (4 MiB objects)</span><br><span class="line">        snapshot_count: 0</span><br><span class="line">        <span class="built_in">id</span>: 38074c091b82</span><br><span class="line">        block_name_prefix: rbd_data.38074c091b82</span><br><span class="line">        format: 2</span><br><span class="line">        features: layering</span><br><span class="line">        op_features: </span><br><span class="line">        flags: </span><br><span class="line">        create_timestamp: Sat Nov  5 21:41:38 2022</span><br><span class="line">        access_timestamp: Sat Nov  5 21:41:38 2022</span><br><span class="line">        modify_timestamp: Sat Nov  5 21:41:38 2022</span><br></pre></td></tr></table></figure><p>解析：</p><p>共：11G  分为：2816个文件  每个文件：4M<br>object的前缀都是以： rbd_data.38074c091b82 开头<br>查看验证：<code>rados -p ceph-demo ls |grep rbd\_data.38074c091b82</code>   (查看所有文件)<br>查看大小：<code>rados -p ceph-demo stat rbd\_data.38074c091b82.0000000000000200</code>  （每个都是4M）</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_6f53063cda709eabdb71f3cd486276b4.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_6f53063cda709eabdb71f3cd486276b4.png"></p><p><strong>查看文件最终落在的地方：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ceph osd map ceph-demo rbd_data.38074c091b82.0000000000000200     (查看文件最终落于)</span><br><span class="line">//返回</span><br><span class="line">osdmap e49 pool <span class="string">&#x27;ceph-demo&#x27;</span> (1) object <span class="string">&#x27;rbd_data.38074c091b82.0000000000000200&#x27;</span> -&gt; pg 1.7811abdf (1.5f) -&gt; up ([0,1], p0) acting ([0,1], p0)</span><br><span class="line"></span><br><span class="line">ceph osd tree</span><br><span class="line">ID CLASS WEIGHT  TYPE NAME       STATUS REWEIGHT PRI-AFF </span><br><span class="line">-1       0.01178 root default          </span><br><span class="line">-3       0.00589     host node-1       </span><br><span class="line"> 0   hdd 0.00589         osd.0       up  1.00000 1.00000 </span><br><span class="line">-5       0.00589     host node-2       </span><br><span class="line"> 1   hdd 0.00589         osd.1       up  1.00000 1.00000 </span><br><span class="line"></span><br><span class="line">解析： 文件pool池deph-demo &gt;&gt; 落在pgid为：1.7811abdf 上面 &gt;&gt; 解析掩码哈希分配于 &gt;&gt; osd.0 osd.1上面</span><br><span class="line">一个文件拆分为多个object这些object都会落在不同的pg上  pg最终落在不同的osd上 </span><br><span class="line">验证：</span><br><span class="line"><span class="keyword">for</span>循环验证</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `rados -p ceph-demo <span class="built_in">ls</span> |grep rbd_data.38074c091b82` ; <span class="keyword">do</span> ceph osd map ceph-demo <span class="variable">$i</span>;  <span class="keyword">done</span></span><br><span class="line">落于不同的pg上</span><br></pre></td></tr></table></figure><p>解析： 文件pool池deph-demo &gt;&gt; 落在pgid为：1.7811abdf 上面 &gt;&gt; 解析掩码哈希分配于 &gt;&gt; osd.0 osd.1上面一个文件拆分为多个object这些object都会落在不同的pg上  pg最终落在不同的osd上</p><p>验证：for循环验证</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> \`rados -p ceph-demo <span class="built_in">ls</span> |grep rbd\_data.38074c091b82\` ; <span class="keyword">do</span> ceph osd map ceph-demo \<span class="variable">$i</span>;  <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>落于不同的pg上</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_29628694717b3300ec37f4ed88d5abbb.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_29628694717b3300ec37f4ed88d5abbb.png"></p><p><strong>rbd是瘦分配的会根据使用情况去自动的扩这些空间</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rados -p ceph-demo <span class="built_in">ls</span> |grep rbd_data.38074c091b82 |<span class="built_in">wc</span> -l        <span class="comment"># 当前这个块有五十多个object</span></span><br><span class="line">//返回 </span><br><span class="line">56 </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当前这个块有五十多个object  每个4M 实际分配了也就二百多M的空间  当前只用了40多M 使用增长的话会动态的去扩容object的数量 满足 我们需要的空间</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n 1 <span class="string">&#x27;rados -p ceph-demo ls |grep rbd_data.38074c091b82 |wc -l &#x27;</span>    （动态监视object文件变化）</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_7c31491c234c587d7d0cc391e7fce3d6.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_7c31491c234c587d7d0cc391e7fce3d6.png"></p><p>往挂载的目录写入数据：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /mnt/rbd-demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=test.img bs=1M count=1024       (往目录写入1G数据)</span><br><span class="line"><span class="comment"># 写入真实数据</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/urandom of=file bs=100M count=9000 iflag=fullblock status=progress</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到最终object增加到313个</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_cc6f5bd1aac93adf5cc215f62178f499.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_cc6f5bd1aac93adf5cc215f62178f499.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_64fcc6f1de8cc79e192aa157631a06d9.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_64fcc6f1de8cc79e192aa157631a06d9.png"></p>]]></content>
      
      
      <categories>
          
          <category> ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>音乐</title>
      <link href="/2024/03/16/%E9%9F%B3%E4%B9%90/"/>
      <url>/2024/03/16/%E9%9F%B3%E4%B9%90/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>音乐</strong></p><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="https://music.163.com/outchain/player?type=2&id=557584888&auto=1&height=66"> </iframe><hr><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="https://music.163.com/outchain/player?type=2&id=523250334&auto=1&height=66"> </iframe>]]></content>
      
      
      <categories>
          
          <category> default </category>
          
      </categories>
      
      
        <tags>
            
            <tag> default </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>onedrive-vercel-index部署</title>
      <link href="/2024/03/15/onedrive-vercel-index%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/03/15/onedrive-vercel-index%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="onedrive-vercel-index-部署"><a href="#onedrive-vercel-index-部署" class="headerlink" title="onedrive-vercel-index 部署"></a>onedrive-vercel-index 部署</h3><p>概览：参考下方官网即可 部署相对简单</p><h3 id="注册一个应用程序"><a href="#注册一个应用程序" class="headerlink" title="注册一个应用程序"></a><a href="https://ovi.swo.moe/zh/docs/advanced#%E6%B3%A8%E5%86%8C%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F">注册一个应用程序</a></h3><p>打开以下链接：</p><ul><li><a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade">Microsoft Azure App registrations</a> （OneDrive 国际版企业版与教育版E5 订阅专用本文使用此版本）</li><li><a href="https://portal.azure.cn/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade">Microsoft Azure.cn App registrations</a>（OneDrive 世纪互联专用）</li></ul><h3 id="serrect需要加密链接见参考链接"><a href="#serrect需要加密链接见参考链接" class="headerlink" title="serrect需要加密链接见参考链接"></a>serrect需要加密链接见参考链接</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_e934dc8c7a9ad014792319e375d506ab.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_e934dc8c7a9ad014792319e375d506ab.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_32138b6f42071fff75dbd218321a5a77.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_32138b6f42071fff75dbd218321a5a77.png"></p><h3 id="本文参考："><a href="#本文参考：" class="headerlink" title="本文参考："></a>本文参考：</h3><p><a href="https://ovi.swo.moe/zh/docs/advanced">https://ovi.swo.moe/zh/docs/advanced</a><br><a href="https://ovi.swo.moe/zh/docs/getting-started">https://ovi.swo.moe/zh/docs/getting-started</a></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s仪表盘部署</title>
      <link href="/2024/03/12/k8s%E4%BB%AA%E8%A1%A8%E7%9B%98%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/03/12/k8s%E4%BB%AA%E8%A1%A8%E7%9B%98%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="k8s仪表盘部署"><a href="#k8s仪表盘部署" class="headerlink" title="k8s仪表盘部署"></a>k8s仪表盘部署</h2><p><strong>仪表盘文件下载链接</strong><br><a href="https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml">https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</a><br><a href="https://drive.zznnwn.cloudns.biz/onedrive/k8s%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8F%8Acni/%E4%BD%BF%E7%94%A8container%E4%BD%9C%E4%B8%BA%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6/recommended_v270.yaml">https://drive.zznnwn.cloudns.biz/onedrive/k8s部署配置文件及cni/使用container作为容器运行时/recommended_v270.yaml</a></p><h3 id="部署仪表盘"><a href="#部署仪表盘" class="headerlink" title="部署仪表盘"></a>部署仪表盘</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f &quot;https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml&quot;</span><br><span class="line">kubectl apply -f &quot;https://drive.zznnwn.cloudns.biz/onedrive/k8s部署配置文件及cni/使用container作为容器运行时/recommended_v270.yaml&quot;</span><br></pre></td></tr></table></figure><p><strong>命名空间中的名称创建服务帐户(admin-user.yml)</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure><p><strong>部署admin-user.yml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f admin-user.yml </span><br><span class="line">kubectl apply -f <span class="string">&quot;https://drive.zznnwn.cloudns.biz/onedrive/k8s部署配置文件及cni/使用container作为容器运行时/admin-user.yml&quot;</span></span><br></pre></td></tr></table></figure><p>创建 ClusterRoleBinding(<code>ClusterRoleBinding.yml</code>)</p><p>在大多数情况下，在使用 或任何其他常用工具预配集群后，集群中已存在。我们可以使用它并只为我们的 . 如果它不存在，则需要先创建此角色并手动授予所需的权限。<code>kops kubeadm ClusterRole cluster-admin ClusterRoleBinding ServiceAccount</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure><p><strong>部署ClusterRoleBinding.yml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ClusterRoleBinding.yml </span><br><span class="line">kubectl apply -f <span class="string">&quot;https://drive.zznnwn.cloudns.biz/onedrive/k8s部署配置文件及cni/使用container作为容器运行时/ClusterRoleBinding.yml&quot;</span></span><br></pre></td></tr></table></figure><p><strong>获取 ServiceAccount 的持有者令牌</strong></p><p>现在我们需要找到可用于登录的令牌。执行以下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard create token admin-user</span><br></pre></td></tr></table></figure><p><strong>它应该打印如下内容：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXY1N253Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiIwMzAzMjQzYy00MDQwLTRhNTgtOGE0Ny04NDllZTliYTc5YzEiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.Z2JrQlitASVwWbc-s6deLRFVk5DWD3P_vjUFXsqVSY10pbjFLG4njoZwh8p3tLxnX_VBsr7_6bwxhWSYChp9hwxznemD5x5HLtjb16kI9Z7yFWLtohzkTwuFbqmQaMoget_nYcQBUC5fDmBHRfFvNKePh_vSSb2h_aYXa8GV5AcfPQpY7r461itme1EXHQJqv-SN-zUnguDguCTjD80pFZ_CmnSE1z9QdMHPB8hoB4V68gtswR1VLa6mSYdgPwCHauuOobojALSaMc3RH7MmFUumAgguhqAkX3Omqd3rJbYOMRuMjhANqd08piDC3aIabINX6gP5-Tuuw2svnV6NYQ</span><br></pre></td></tr></table></figure><p>查看 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#manually-create-an-api-token-for-a-serviceaccount">Kubernetes 文档</a>，了解有关 ServiceAccount 的 API 令牌的更多信息。</p><h4 id="获取-ServiceAccount-的长期持有者令牌-建议使用此种"><a href="#获取-ServiceAccount-的长期持有者令牌-建议使用此种" class="headerlink" title="获取 ServiceAccount 的长期持有者令牌(建议使用此种)"></a>获取 ServiceAccount 的长期持有者令牌(建议使用此种)</h4><p>我们还可以创建一个带有 secret 的令牌，该令牌绑定了服务帐户，令牌将保存在 Secret 中文件(<code>secret_token.yml</code>)</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/service-account.name:</span> <span class="string">&quot;admin-user&quot;</span>   </span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/service-account-token</span>  </span><br></pre></td></tr></table></figure><p><strong>部署</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f secret_token.yml</span><br><span class="line">kubectl apply -f <span class="string">&quot;https://drive.zznnwn.cloudns.biz/onedrive/k8s部署配置文件及cni/使用container作为容器运行时/secret_token.yml&quot;</span></span><br></pre></td></tr></table></figure><p>创建 Secret 后，我们可以执行以下命令来获取保存在 Secret 中的 Token：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret admin-user -n kubernetes-dashboard -o jsonpath=&#123;&quot;.data.token&quot;&#125; | base64 -d</span><br></pre></td></tr></table></figure><p>查看 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#manually-create-a-long-lived-api-token-for-a-serviceaccount">Kubernetes 文档</a>，了解有关 ServiceAccount 的长期 API 令牌的更多信息。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_451018f8aaf9cdda00b42a1da75d3b46.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_451018f8aaf9cdda00b42a1da75d3b46.png"></p><h3 id="最后将dashboard端口暴露在外用于访问"><a href="#最后将dashboard端口暴露在外用于访问" class="headerlink" title="最后将dashboard端口暴露在外用于访问"></a>最后将<code>dashboard</code>端口暴露在外用于访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl  patch svc kubernetes-dashboard -n kubernetes-dashboard \</span><br><span class="line">-p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;,&quot;ports&quot;:[&#123;&quot;port&quot;:443,&quot;targetPort&quot;:8443,&quot;nodePort&quot;:30443&#125;]&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_57bf21fb0b0a561b21cf24556ecc01a5.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_57bf21fb0b0a561b21cf24556ecc01a5.png"></p><h3 id="扩展一键部署"><a href="#扩展一键部署" class="headerlink" title="扩展一键部署"></a>扩展一键部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://drive.zznnwn.cloudns.biz/onedrive/脚本/k8s一键部署脚本/k8s-dashboard.sh | bash</span><br></pre></td></tr></table></figure><h3 id="登陆仪表盘"><a href="#登陆仪表盘" class="headerlink" title="登陆仪表盘"></a>登陆仪表盘</h3><p>访问：<a href="https://localhost:8443/#/login">https://localhost:8443/#/login</a></p><h3 id="清理和后续步骤"><a href="#清理和后续步骤" class="headerlink" title="清理和后续步骤"></a>清理和后续步骤</h3><p>删除 admin 和 .<code>ServiceAccount ClusterRoleBinding</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard delete serviceaccount admin-user</span><br><span class="line">kubectl -n kubernetes-dashboard delete clusterrolebinding admin-user</span><br></pre></td></tr></table></figure><p>要了解有关如何在 Kubernetes 中授予/拒绝权限的更多信息，请阅读官方<a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/">身份验证</a>和<a href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/">授权</a>文档。</p><h4 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h4><p><a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/web-ui-dashboard/">https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/web-ui-dashboard/</a><br><a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md</a></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s去除污点节点</title>
      <link href="/2024/03/12/k8s%E5%8E%BB%E9%99%A4%E6%B1%A1%E7%82%B9%E8%8A%82%E7%82%B9/"/>
      <url>/2024/03/12/k8s%E5%8E%BB%E9%99%A4%E6%B1%A1%E7%82%B9%E8%8A%82%E7%82%B9/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="k8s去除污点节点"><a href="#k8s去除污点节点" class="headerlink" title="k8s去除污点节点"></a>k8s去除污点节点</h3><p><strong>现象</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点详情</span></span><br><span class="line">kubectl describe pods nginx-7b7485646b-n9f8g  -n default  </span><br><span class="line"></span><br><span class="line"><span class="comment">################报错信息##############</span></span><br><span class="line"></span><br><span class="line">Node-Selectors:                                                                                                          </span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists <span class="keyword">for</span> 300s                                         </span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists <span class="keyword">for</span> 300s                                       </span><br><span class="line">Events:                                                                                                                        </span><br><span class="line">  Type     Reason            Age    From               Message                                                                 </span><br><span class="line">  ----     ------            ----   ----               -------                                                                 </span><br><span class="line">  Warning  FailedScheduling  2m54s  default-scheduler  0/1 nodes are available: 1 node(s) had untolerated taint &#123;node-role.kubernetes.io/control-plane: &#125;. </span><br><span class="line">preemption: 0/1 nodes are available: 1 Preemption is not helpful <span class="keyword">for</span> scheduling.. </span><br></pre></td></tr></table></figure><p><strong>解决</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s:~<span class="comment"># kubectl describe nodes |grep Taints                                                                                                      </span></span><br><span class="line">Taints:             node-role.kubernetes.io/control-plane:NoSchedule                                                                                 </span><br><span class="line">                                                                                                                                                                                        </span><br><span class="line">root@k8s:~<span class="comment"># kubectl get node                                                                                                                         </span></span><br><span class="line">NAME   STATUS   ROLES           AGE     VERSION                                                                                                      </span><br><span class="line">k8s    Ready    control-plane   4h22m   v1.26.5                                                                                                      </span><br><span class="line">root@k8s:~<span class="comment"># kubectl taint nodes k8s  node-role.kubernetes.io/control-plane-</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_169b466f0666661a0ccb13ce6795653b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/3/image_169b466f0666661a0ccb13ce6795653b.png"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s常用命令</title>
      <link href="/2024/03/12/k8s%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
      <url>/2024/03/12/k8s%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="k8s常用命令"><a href="#k8s常用命令" class="headerlink" title="k8s常用命令"></a>k8s常用命令</h3><h4 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h4><p>这是一个用于管理 Kubernetes 集群的 kubectl 命令。让我们解释一下这个命令的各个部分：</p><ul><li><strong>kubectl</strong>: 这是 Kubernetes 命令行工具，用于与 Kubernetes 集群进行交互，例如创建、管理和监视资源。</li><li><strong>get</strong>: 这是 kubectl 命令的一个子命令，用于检索（获取）Kubernetes 集群中的资源的信息。</li><li><strong>svc</strong>: 这是 “service” 的缩写，表示你希望获取服务（Service）的相关信息。</li><li><strong>deploy</strong>: 这是 “deployment” 的缩写，表示你希望获取部署（Deployment）的相关信息。</li><li><strong>-n kube-system</strong>: 这是一个标志（flag），用于指定要检索资源所在的命名空间（namespace）。在这种情况下，”-n kube-system” 表示你希望获取位于 kube-system 命名空间中的服务的信息。</li></ul><h2 id="k8s常用命令-1"><a href="#k8s常用命令-1" class="headerlink" title="k8s常用命令"></a>k8s常用命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 查看镜像</span><br><span class="line">kubeadm config images list </span><br><span class="line"># 查看服务</span><br><span class="line">kubectl get pod,svc</span><br><span class="line">#  编辑cm</span><br><span class="line">kubectl  edit cm -n apiconfig</span><br></pre></td></tr></table></figure><p><strong>经常使用的操作有下面这些：</strong></p><table><thead><tr><th><strong>命令分类</strong></th><th><strong>命令</strong></th><th><strong>翻译</strong></th><th><strong>命令作用</strong></th></tr></thead><tbody><tr><td><strong>基本命令</strong></td><td><strong>create</strong></td><td><strong>创建</strong></td><td><strong>创建一个资源</strong></td></tr><tr><td></td><td><strong>edit</strong></td><td><strong>编辑</strong></td><td><strong>编辑一个资源</strong></td></tr><tr><td></td><td><strong>get</strong></td><td><strong>获取</strong></td><td><strong>获取一个资源</strong></td></tr><tr><td></td><td><strong>patch</strong></td><td><strong>更新</strong></td><td><strong>更新一个资源</strong></td></tr><tr><td></td><td><strong>delete</strong></td><td><strong>删除</strong></td><td><strong>删除一个资源</strong></td></tr><tr><td></td><td><strong>explain</strong></td><td><strong>解释</strong></td><td><strong>展示资源文档</strong></td></tr><tr><td><strong>运行和调试</strong></td><td><strong>run</strong></td><td><strong>运行</strong></td><td><strong>在集群中运行一个指定的镜像</strong></td></tr><tr><td></td><td><strong>expose</strong></td><td><strong>暴露</strong></td><td><strong>暴露资源为 Service</strong></td></tr><tr><td></td><td><strong>describe</strong></td><td><strong>描述</strong></td><td><strong>显示资源内部信息</strong></td></tr><tr><td></td><td><strong>logs</strong></td><td><strong>日志输出容器在 pod 中的日志</strong></td><td><strong>输出容器在 pod 中的日志</strong></td></tr><tr><td></td><td><strong>attach</strong></td><td><strong>缠绕进入运行中的容器</strong></td><td><strong>进入运行中的容器</strong></td></tr><tr><td></td><td><strong>exec</strong></td><td><strong>执行容器中的一个命令</strong></td><td><strong>执行容器中的一个命令</strong></td></tr><tr><td></td><td><strong>cp</strong></td><td><strong>复制</strong></td><td><strong>在Pod内外复制文件</strong></td></tr><tr><td></td><td><strong>rollout</strong></td><td><strong>首次展示</strong></td><td><strong>管理资源的发布</strong></td></tr><tr><td></td><td><strong>scale</strong></td><td><strong>规模</strong></td><td><strong>扩(缩)容Pod的数量</strong></td></tr><tr><td></td><td><strong>autoscale</strong></td><td><strong>自动调整</strong></td><td><strong>自动调整Pod的数量</strong></td></tr><tr><td><strong>高级命令</strong></td><td><strong>apply</strong></td><td><strong>rc</strong></td><td><strong>通过文件对资源进行配置</strong></td></tr><tr><td></td><td><strong>label</strong></td><td><strong>标签</strong></td><td><strong>更新资源上的标签</strong></td></tr><tr><td><strong>其他命令</strong></td><td><strong>cluster-info</strong></td><td><strong>集群信息</strong></td><td><strong>显示集群信息</strong></td></tr><tr><td></td><td><strong>version</strong></td><td><strong>版本</strong></td><td><strong>显示当前Server和Client的版本</strong></td></tr></tbody></table><p><strong>经常使用的资源有下面这些：</strong></p><table><thead><tr><th><strong>资源分类</strong></th><th><strong>资源名称</strong></th><th><strong>缩写</strong></th><th><strong>资源作用</strong></th></tr></thead><tbody><tr><td><strong>集群级别资源</strong></td><td><strong>nodes</strong></td><td><strong>no</strong></td><td><strong>集群组成部分</strong></td></tr><tr><td><strong>namespaces</strong></td><td><strong>ns</strong></td><td><strong>隔离Pod</strong></td><td></td></tr><tr><td><strong>pod资源</strong></td><td><strong>pods</strong></td><td><strong>po</strong></td><td><strong>装载容器</strong></td></tr><tr><td><strong>pod资源控制器</strong></td><td><strong>replicationcontrollers</strong></td><td><strong>rc</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>replicasets</strong></td><td><strong>rs</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>deployments</strong></td><td><strong>deploy</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>daemonsets</strong></td><td><strong>ds</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>jobs</strong></td><td></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>cronjobs</strong></td><td><strong>cj</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>horizontalpodautoscalers</strong></td><td><strong>hpa</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td></td><td><strong>statefulsets</strong></td><td><strong>sts</strong></td><td><strong>控制pod资源</strong></td></tr><tr><td><strong>服务发现资源</strong></td><td><strong>services</strong></td><td><strong>svc</strong></td><td><strong>统一pod对外接口</strong></td></tr><tr><td></td><td><strong>ingress</strong></td><td><strong>ing</strong></td><td><strong>统一pod对外接口</strong></td></tr><tr><td><strong>存储资源</strong></td><td><strong>volumeattachments</strong></td><td></td><td><strong>存储</strong></td></tr><tr><td></td><td><strong>persistentvolumes</strong></td><td><strong>pv</strong></td><td><strong>存储</strong></td></tr><tr><td></td><td><strong>persistentvolumeclaims</strong></td><td><strong>pvc</strong></td><td><strong>存储</strong></td></tr><tr><td><strong>配置资源</strong></td><td><strong>configmaps</strong></td><td><strong>cm</strong></td><td><strong>配置</strong></td></tr><tr><td></td><td><strong>secrets</strong></td><td></td><td><strong>配置</strong></td></tr></tbody></table><p><strong>通过yml创建删除应用</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply  -f kuboard-offline.yml</span><br><span class="line">kubectl delete -f kuboard-offline.yml</span><br><span class="line">kubectl apply  -f nginx-deployment.yml</span><br></pre></td></tr></table></figure><p><strong>通过命令行创建应用</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看帮助命令</span></span><br><span class="line">kubectl create deployment --<span class="built_in">help</span></span><br><span class="line"><span class="comment"># 开始发布应用 指定名称是demo 镜像是nginx:1.7.9 副本数是3</span></span><br><span class="line">kubectl create deployment demo --image=nginx:1.7.9 --replicas=3</span><br><span class="line"><span class="comment">#创建service暴露端口使用vip访问</span></span><br><span class="line">kubectl expose deployment demo --port=80 --target-port=80 </span><br><span class="line"></span><br><span class="line">kubectl create deployment nginx --image=registry.cn-hangzhou.aliyuncs.com/xiaohh-docker/nginx:latest</span><br><span class="line">kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=LoadBalancer</span><br><span class="line">kubectl delete deployment nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建service </span></span><br><span class="line">kubectl create -f nginx-service.yaml</span><br><span class="line"><span class="comment"># 查看暴露在外部的端口</span></span><br><span class="line">kubectl get service/nginx-service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">kubectl delete deployment demo </span><br></pre></td></tr></table></figure><p><strong>暴露外部端口用于访问</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl  patch svc kubernetes-dashboard -n kubernetes-dashboard \</span><br><span class="line">-p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;,&quot;ports&quot;:[&#123;&quot;port&quot;:443,&quot;targetPort&quot;:8443,&quot;nodePort&quot;:30443&#125;]&#125;&#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>查看pod详情</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看命名空间为kube-system的pod详情</span></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">kubectl get pods -n kube-system -o wide</span><br><span class="line">kubectl describe pod kubernetes-dashboard-7bdfc744fc-hmhh2 -n kube-system</span><br><span class="line"><span class="comment"># 获取位于 kube-system/kubernetes-dashboard 命名空间中的所有服务（Service）的信息。这将列出 kube-system 命名空间中所有服务的详细信息，包括服务的名称、类型、集群IP等。</span></span><br><span class="line">kubectl get svc -n kube-system</span><br><span class="line">kubectl get svc -n kubernetes-dashboard </span><br><span class="line"><span class="comment"># 查看系统pod以外的pod详情/查看自己部署的应用</span></span><br><span class="line">kubectl get pods -o wide</span><br><span class="line">kubectl get deployments.apps</span><br><span class="line">kubectl describe pods nginx-deployment-57c68fcd95-sgd25</span><br><span class="line"><span class="comment"># 查看demo应用（容器）service(svc)详细</span></span><br><span class="line">kubectl describe service demo</span><br><span class="line"><span class="comment"># 查看节点状态</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">kubectl get cs</span><br><span class="line"><span class="comment"># coredns组件用于做名称解析 主要是通过daemonsets.apps的形式在里面部署两个daemonset分别是kube-flannel-ds 和 kube-proxy</span></span><br><span class="line">kubectl get daemonsets.apps -n kube-system</span><br></pre></td></tr></table></figure><p><strong>登陆进入pod相当于docker exec</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录容器查看volumes详情</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it volume-rbd-demo /bin/bash</span><br><span class="line">kubectl <span class="built_in">exec</span> -it volume-rbd-demo -- <span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure><p><strong>部分命令完整写法</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployment --namespace=kubernetes-dashboard kubernetes-dashboard</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">$ kubectl describe deployment --namespace=kubernetes-dashboard kubernetes-dashboard</span><br><span class="line"><span class="comment"># 查看service</span></span><br><span class="line">$ kubectl get service --namespace=kubernetes-dashboard kubernetes-dashboard </span><br><span class="line">返回</span><br><span class="line">NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes-dashboard   ClusterIP   10.108.163.102   &lt;none&gt;        443/TCP   5m15s</span><br><span class="line"><span class="comment"># 另外查看pod状态 (此时说明安装完成</span></span><br><span class="line">$ kubectl --namespace=kubernetes-dashboard get pod -o wide | grep dashboard</span><br><span class="line">返回</span><br><span class="line">dashboard-metrics-scraper-79459f84f-5g8h6   1/1     Running   0          5m34s   172.16.0.9   ceph1   &lt;none&gt;   </span><br><span class="line">kubernetes-dashboard-76dc96b85f-nhwjd       1/1     Running   0          5m34s   172.16.0.8   ceph1   &lt;none&gt;</span><br><span class="line"><span class="comment"># 查看svc</span></span><br><span class="line">kubectl -n kubernetes-dashboard get svc</span><br><span class="line">NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   10.104.31.122    &lt;none&gt;        8000/TCP   32m</span><br><span class="line">kubernetes-dashboard        ClusterIP   10.108.163.102   &lt;none&gt;        443/TCP    32m</span><br><span class="line"><span class="comment"># 如果状态一直创建中, 使用describe查看具体过程 （如下回显则需要设置拉取镜像方法）</span></span><br><span class="line">$ kubectl describe pod --namespace=kubernetes-dashboard</span><br></pre></td></tr></table></figure><h3 id="一-开始"><a href="#一-开始" class="headerlink" title="一.  开始"></a>一.  开始</h3><h4 id="1-删除pod"><a href="#1-删除pod" class="headerlink" title="1. 删除pod"></a>1. 删除pod</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">kubectl get pods -A</span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line"><span class="comment"># 检查 Pod 详细信息：首先，查看该 Pod 的详细信息以了解其状态和可能的原因。这将显示 Pod 的 YAML 配置文件，其中包括了当前的状态和其他详细信息。</span></span><br><span class="line">kubectl get pod kuboard-cc79974cd-7xkpc -n kube-system -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 Pod：如果确定要删除该 Pod，可以使用以下命令：</span></span><br><span class="line">请注意，强制删除可能会导致容器和相关资源无法正常终止，这可能会影响正在运行的应用程序。如果可能的话，最好先让 Pod 自行终止（通常需要一些时间），然后再尝试删除它。</span><br><span class="line"></span><br><span class="line">kubectl delete pod kuboard-cc79974cd-7xkpc -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查删除结果：你可以再次使用 kubectl get pods 命令来确认该 Pod 是否已经被成功删除。</span></span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除一个名为 nginx-deployment 的 Deployment</span></span><br><span class="line"></span><br><span class="line">kubectl delete deployment nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果你不确定具体需要删除哪些资源，使用查看相关资源，然后逐个删除。</span></span><br><span class="line"></span><br><span class="line">kubectl get all --selector app=nginx </span><br></pre></td></tr></table></figure><h4 id="2-删除pod的映射端口"><a href="#2-删除pod的映射端口" class="headerlink" title="2. 删除pod的映射端口"></a>2. 删除pod的映射端口</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看映射端口</span></span><br><span class="line">kubectl get svc</span><br><span class="line"><span class="comment"># 删除nginx映射的端口</span></span><br><span class="line">kubectl delete svc nginx</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s单节点与集群部署</title>
      <link href="/2024/03/11/k8s%E5%8D%95%E8%8A%82%E7%82%B9%E4%B8%8E%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
      <url>/2024/03/11/k8s%E5%8D%95%E8%8A%82%E7%82%B9%E4%B8%8E%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="k8s单节点与集群部署"><a href="#k8s单节点与集群部署" class="headerlink" title="k8s单节点与集群部署"></a>k8s单节点与集群部署</h1><blockquote><p>使用container作为k8s容器运行时服务器不需要安装cni<br><strong>kube-flannel.yml配置原链接</strong><br><a href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</a></p></blockquote><h2 id="一-项目链接-gt-gt-gt-gt-gt-gt-gt-gt-gt-gt-gt"><a href="#一-项目链接-gt-gt-gt-gt-gt-gt-gt-gt-gt-gt-gt" class="headerlink" title="一. 项目链接 | &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"></a>一. 项目链接 | &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</h2><p><a href="https://gitee.com/apple-Teawine/k8s/tree/master/deploy-k8s-container%E7%89%88">项目链接</a></p><p><a href="https://onenote.zznnwn.cloudns.biz/zh-CN/%E8%84%9A%E6%9C%AC/k8s%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC/">onedrive链接</a></p><h2 id="二-k8sv1-28-0-00版本集群部署"><a href="#二-k8sv1-28-0-00版本集群部署" class="headerlink" title="二. k8sv1.28.0-00版本集群部署"></a>二. k8sv1.28.0-00版本集群部署</h2><ul><li>推荐环境：ubuntu20.04</li><li>k8s软件源：阿里云</li><li>两者最好设置好免密登录</li></ul><h3 id="a-master节点部署（all-in-one版k8s）"><a href="#a-master节点部署（all-in-one版k8s）" class="headerlink" title="a. master节点部署（all-in-one版k8s）"></a>a. master节点部署（all-in-one版k8s）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一键部署all-in-one版k8s</span></span><br><span class="line">curl -sSL https://onenote.zznnwn.cloudns.biz/api/raw/?path=/脚本/k8s一键部署脚本/k8s_v1.28.sh | IP=10.0.0.10 KUBELET=1.28.0-00 HOSTNAME=k8s MIRROR=aliyun DOCKER=no bash </span><br></pre></td></tr></table></figure><h3 id="b-普通节点部署后加入集群"><a href="#b-普通节点部署后加入集群" class="headerlink" title="b. 普通节点部署后加入集群"></a>b. 普通节点部署后加入集群</h3><h4 id="1-执行初始化脚本-需要安装好docker"><a href="#1-执行初始化脚本-需要安装好docker" class="headerlink" title="1.执行初始化脚本 需要安装好docker"></a>1.执行初始化脚本 需要安装好<code>docker</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://onenote.zznnwn.cloudns.biz/api/raw/?path=/脚本/linux初始化脚本/init_latest.sh | HOSTNAME=k8s1 IP=10.0.0.10 MIRROR=aliyun DOCKER=<span class="built_in">yes</span> bash</span><br></pre></td></tr></table></figure><h4 id="2-部署自动拉取镜像脚本"><a href="#2-部署自动拉取镜像脚本" class="headerlink" title="2.部署自动拉取镜像脚本"></a>2.部署自动拉取镜像脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL  https://onenote.zznnwn.cloudns.biz/api/raw/?path=/脚本/k8s一键部署脚本/download_k8s_images.sh |bash</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-执行部署k8s环境"><a href="#3-执行部署k8s环境" class="headerlink" title="3.执行部署k8s环境"></a>3.执行部署k8s环境</h4><p>如果是其他版本其他节点加入只需要修改脚本版本变量即可</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_98a7e0f652cad742031e5d7025cb0cbe.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/11/image_98a7e0f652cad742031e5d7025cb0cbe.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O  k8s_v1.28_local.sh  https://onenote.zznnwn.cloudns.biz/api/raw/?path=/脚本/k8s一键部署脚本/k8s_v1.28_local.sh</span><br></pre></td></tr></table></figure><h4 id="4-执行-kubeadm-join-加入k8s集群-如果忘记了-则执行如下重新获取"><a href="#4-执行-kubeadm-join-加入k8s集群-如果忘记了-则执行如下重新获取" class="headerlink" title="4.执行 kubeadm join 加入k8s集群 如果忘记了 则执行如下重新获取"></a>4.执行 kubeadm join 加入k8s集群 如果忘记了 则执行如下重新获取</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure><p>部署完成后测试集群状态</p><h3 id="部署一个NGNINX"><a href="#部署一个NGNINX" class="headerlink" title="部署一个NGNINX"></a>部署一个<code>NGNINX</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx  --image=nginx:1.14-alpine</span><br></pre></td></tr></table></figure><h3 id="暴露端口-type-NodePort集群之外访问"><a href="#暴露端口-type-NodePort集群之外访问" class="headerlink" title="暴露端口--type=NodePort集群之外访问"></a>暴露端口<code>--type=NodePort</code>集群之外访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deploy nginx  --port=80 --target-port=80  --<span class="built_in">type</span>=NodePort</span><br></pre></td></tr></table></figure><h3 id="查看外部访问端口【三条命令都能使用】"><a href="#查看外部访问端口【三条命令都能使用】" class="headerlink" title="查看外部访问端口【三条命令都能使用】"></a>查看外部访问端口【三条命令都能使用】</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubecet get svc </span><br><span class="line">kubecet get svc -n deauflt</span><br><span class="line">kubectl get pod,svc</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_a3f218144218f3b84fc841c95cfa40e7.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/4/image_a3f218144218f3b84fc841c95cfa40e7.png"></p><p>本文参考：</p><p><a href="https://blog.csdn.net/weixin_58648684/article/details/130699568">https://blog.csdn.net/weixin_58648684/article/details/130699568</a><br><a href="https://cn.linux-console.net/?p=3508">https://cn.linux-console.net/?p=3508</a>  container安装参考<br><a href="https://wn-apple-teawine.fun/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes">https://wn-apple-teawine.fun/2023/06/04/ubuntu部署kubernetes</a><br><a href="https://www.cnblogs.com/way2backend/p/16970506.html#3-%E5%AE%89%E8%A3%85containerd">https://www.cnblogs.com/way2backend/p/16970506.html#3-%E5%AE%89%E8%A3%85containerd</a><br><a href="https://blog.csdn.net/IOT_AI/article/details/131916926">[Ubuntu 22.04] 安装containerd_ubuntu22.04 安装containerd-CSDN博客</a></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在Linux上以All-in-One模式安装KubeSphere</title>
      <link href="/2024/03/10/%E5%9C%A8Linux%E4%B8%8A%E4%BB%A5All-in-One%E6%A8%A1%E5%BC%8F%E5%AE%89%E8%A3%85KubeSphere/"/>
      <url>/2024/03/10/%E5%9C%A8Linux%E4%B8%8A%E4%BB%A5All-in-One%E6%A8%A1%E5%BC%8F%E5%AE%89%E8%A3%85KubeSphere/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>首先服务器执行初始化脚本 安装docker</p><p>本文参考：<a href="https://kubesphere.io/zh/docs/v3.4/quick-start/all-in-one-on-linux/">https://kubesphere.io/zh/docs/v3.4/quick-start/all-in-one-on-linux/</a></p><h3 id="节点要求"><a href="#节点要求" class="headerlink" title="节点要求"></a>节点要求</h3><ul><li>节点必须能够通过 <code>SSH</code> 连接。</li><li>节点上可以使用 <code>sudo</code>/<code>curl</code>/<code>openssl</code>/<code>tar</code> 命令。</li></ul><h3 id="容器运行时"><a href="#容器运行时" class="headerlink" title="容器运行时"></a>容器运行时</h3><p>您的集群必须有一个可用的容器运行时。如果您使用 KubeKey 搭建集群，KubeKey 会默认安装最新版本的 Docker。或者，您也可以在创建集群前手动安装 Docker 或其他容器运行时。</p><table><thead><tr><th>支持的容器运行时</th><th>版本</th></tr></thead><tbody><tr><td>Docker</td><td>19.3.8 +</td></tr><tr><td>containerd</td><td>最新版</td></tr><tr><td>CRI-O（试验版，未经充分测试）</td><td>最新版</td></tr><tr><td>iSula（试验版，未经充分测试）</td><td>最新版</td></tr></tbody></table><h3 id="依赖项要求"><a href="#依赖项要求" class="headerlink" title="依赖项要求"></a>依赖项要求</h3><p>KubeKey 可以将 Kubernetes 和 KubeSphere 一同安装。针对不同的 Kubernetes 版本，需要安装的依赖项可能有所不同。您可以参考以下列表，查看是否需要提前在节点上安装相关的依赖项。</p><table><thead><tr><th>依赖项</th><th>Kubernetes 版本 ≥ 1.18</th><th>Kubernetes 版本 &lt; 1.18</th></tr></thead><tbody><tr><td><code>socat</code></td><td>必须</td><td>可选但建议</td></tr><tr><td><code>conntrack</code></td><td>必须</td><td>可选但建议</td></tr><tr><td><code>ebtables</code></td><td>可选但建议</td><td>可选但建议</td></tr><tr><td><code>ipset</code></td><td>可选但建议</td><td>可选但建议</td></tr></tbody></table><p>KubeKey 是用 Go 语言开发的一款全新的安装工具，代替了以前基于 ansible 的安装程序。KubeKey 为用户提供了灵活的安装选择，可以分别安装 KubeSphere 和 Kubernetes 或二者同时安装，既方便又高效。</p><h3 id="网络和-DNS-要求"><a href="#网络和-DNS-要求" class="headerlink" title="网络和 DNS 要求"></a>网络和 DNS 要求</h3><ul><li>请确保 <code>/etc/resolv.conf</code> 中的 DNS 地址可用，否则，可能会导致集群中的 DNS 出现问题。</li><li>如果您的网络配置使用防火墙规则或安全组，请务必确保基础设施组件可以通过特定端口相互通信。建议您关闭防火墙。有关更多信息，请参见<a href="https://kubesphere.io/zh/docs/v3.3/installing-on-linux/introduction/port-firewall/">端口要求</a>。</li><li>支持的 CNI 插件：Calico 和 Flannel。其他插件也适用（例如 Cilium 和 Kube-OVN 等），但请注意它们未经充分测试。</li></ul><p>提示</p><ul><li>建议您的操作系统处于干净状态（不安装任何其他软件），否则可能会发生冲突。</li><li>如果您无法从 <code>dockerhub.io</code> 下载容器镜像，建议提前准备仓库的镜像地址（即加速器）。有关更多信息，请参见<a href="https://kubesphere.io/zh/docs/v3.4/faq/installation/configure-booster/">为安装配置加速器</a>。</li></ul><p>硬件推荐配置</p><table><thead><tr><th>操作系统</th><th>最低配置</th></tr></thead><tbody><tr><td><strong>Ubuntu</strong> <em>16.04</em>, <em>18.04</em>, <em>20.04</em>, <em>22.04</em></td><td>2 核 CPU，4 GB 内存，40 GB 磁盘空间</td></tr><tr><td><strong>Debian</strong> <em>Buster</em>, <em>Stretch</em></td><td>2 核 CPU，4 GB 内存，40 GB 磁盘空间</td></tr><tr><td><strong>CentOS</strong> <em>7.x</em></td><td>2 核 CPU，4 GB 内存，40 GB 磁盘空间</td></tr><tr><td><strong>Red Hat Enterprise Linux 7</strong></td><td>2 核 CPU，4 GB 内存，40 GB 磁盘空间</td></tr><tr><td><strong>SUSE Linux Enterprise Server 15/openSUSE Leap 15.2</strong></td><td>2 核 CPU，4 GB 内存，40 GB 磁盘空间</td></tr></tbody></table></blockquote><p><strong>一. 安装依赖</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y socat conntrack ipset</span><br></pre></td></tr></table></figure><p><strong>二. 执行部署k8s</strong></p><blockquote><p>此步骤部署很可能因为网络原因导致失败</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若此命令失败则使用下方先下载软件包解压后执行</span></span><br><span class="line">curl -sfL https://get-kk.kubesphere.io | VERSION=v3.0.13 sh -</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载软件包</span></span><br><span class="line">cd /opt &amp;&amp; curl -flO https://kubernetes.pek3b.qingstor.com/kubekey/releases/download/v3.0.13/kubekey-v3.0.13-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">tar -xvf kubekey-v3.0.13-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本文使用</span></span><br><span class="line">./kk create cluster --with-kubernetes v1.26.5 --container-manager containerd --with-kubesphere v3.4.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可选</span></span><br><span class="line">./kk create cluster --with-kubernetes v1.26.5 --container-manager containerd --with-local-storage</span><br></pre></td></tr></table></figure><p>k8s版本号参考：<a href="https://kubernetes.io/zh-cn/releases/">发行版本 | Kubernetes</a></p><p><strong>三. 最后：验证安装结果</strong></p><p>输入以下命令以检查安装结果。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l &#x27;app in (ks-install, ks-installer)&#x27; -o jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;) -f</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出信息会显示 Web 控制台的 IP 地址和端口号，默认的 NodePort 是 <code>30880</code>。现在，您可以使用默认的帐户和密码 (<code>admin/P@88w0rd</code>) 通过 <code>&lt;NodeIP&gt;:30880</code> 访问控制台。</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务器遭受SYN洪水攻击</title>
      <link href="/2024/03/05/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%81%AD%E5%8F%97SYN%E6%B4%AA%E6%B0%B4%E6%94%BB%E5%87%BB/"/>
      <url>/2024/03/05/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%81%AD%E5%8F%97SYN%E6%B4%AA%E6%B0%B4%E6%94%BB%E5%87%BB/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>引用GPT3.5回答：</p><p>SYN 洪水攻击（SYN flooding）的情况。SYN 洪水攻击是一种常见的网络攻击方式，攻击者发送大量伪造的 TCP 连接请求（SYN 包），导致服务器资源耗尽或网络拥塞。</p><p>内核检测到可能的 SYN 洪水攻击后，会采取一些措施来应对，其中之一是发送 cookies。TCP SYN cookies 是一种用于防止 SYN 洪水攻击的技术，它允许服务器在遭受 SYN 洪水攻击时继续处理连接请求，而无需维护半开连接的状态。</p><p>它是一种常见的网络攻击类型，旨在使服务器不可用。在这种攻击中，攻击者发送大量伪造的 SYN 数据包到服务器上，使服务器无法处理所有这些连接请求，从而耗尽其资源。</p></blockquote><h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p><strong>现象：</strong></p><p><code>Mar  5 18:04:28 ybh83aa9pnppbp kernel: TCP: request_sock_TCP: Possible SYN flooding on port 22. Sending cookies.  Check SNMP counters.</code></p><p>这个是遭受到了 SYN 洪水攻击（SYN flooding）<br>您对22端口做个白名单限制就行了<br>或者使用这个工具进行防御这种攻击<br><a href="https://github.com/fail2ban/fail2ban">https://github.com/fail2ban/fail2ban</a></p><blockquote><p>引用GPT3.5回答：</p><p>这个错误表明你的Linux服务器可能受到了 SYN 洪水攻击，它是一种常见的网络攻击类型，旨在使服务器不可用。在这种攻击中，攻击者发送大量伪造的 SYN 数据包到服务器上，使服务器无法处理所有这些连接请求，从而耗尽其资源。</p><p>要解决这个问题，你可以采取以下措施：</p><ol><li><p><strong>增加 SYN 收队列的大小</strong>：通过调整内核参数，增加服务器上 SYN 收队列的大小，使其能够处理更多的连接请求。你可以通过修改 <code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code> 参数来实现。例如，可以使用以下命令将队列大小增加到 1024：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.tcp_max_syn_backlog=1024</span><br></pre></td></tr></table></figure></li><li><p><strong>配置防火墙</strong>：使用防火墙来过滤来自外部网络的恶意流量。可以配置防火墙规则，限制每个 IP 地址对 SSH 端口的连接速率，或者使用工具如 Fail2Ban 来自动检测并封锁恶意 IP 地址。</p></li><li><p><strong>使用 SYN Cookie</strong>：启用 SYN Cookie 可以防止服务器被 SYN 洪水攻击所拒绝服务。这个选项会在服务器端在收到 SYN 请求时不分配资源，而是使用一个加密的 Cookie 发送给客户端。只有当客户端返回带有正确 Cookie 的 ACK 请求时，服务器才会分配资源并完成 TCP 握手。你可以通过以下命令启用 SYN Cookie：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.tcp_syncookies=1</span><br></pre></td></tr></table></figure></li><li><p><strong>更新系统和软件</strong>：确保你的系统和所有安全相关的软件都是最新的版本，因为厂商通常会修复已知的漏洞和安全问题。</p></li><li><p><strong>监控网络流量</strong>：定期监控服务器上的网络流量，并在检测到异常流量时及时采取行动。</p></li><li><p><strong>限制 SSH 访问</strong>：如果可能，尝试限制 SSH 访问只允许来自特定 IP 地址范围的连接，以减少服务器受到攻击的风险。</p></li></ol><p>如果以上措施都不能解决问题，你可能需要进一步的调查和分析，可能需要与网络安全专家合作，以找出更深层次的解决方案。</p></blockquote><h4 id="fail2ban安装及使用参考"><a href="#fail2ban安装及使用参考" class="headerlink" title="fail2ban安装及使用参考"></a>fail2ban安装及使用参考</h4><p><a href="https://blog.csdn.net/dudu1225/article/details/121242917">Fail2ban安装及配置</a><br><a href="https://blog.csdn.net/qq_46229380/article/details/109802360">Fail2ban安装及配置压缩包方式安装</a><br><a href="https://www.jianshu.com/p/4fdec5794d08">CentOS7下安装和使用Fail2ban - 简书 (jianshu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> default </category>
          
      </categories>
      
      
        <tags>
            
            <tag> default </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows或Linux SSH连接或者服务偶发性断开问题处理</title>
      <link href="/2024/02/19/Windows%E6%88%96Linux%20SSH%E8%BF%9E%E6%8E%A5%E6%88%96%E8%80%85%E6%9C%8D%E5%8A%A1%E5%81%B6%E5%8F%91%E6%80%A7%E6%96%AD%E5%BC%80%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"/>
      <url>/2024/02/19/Windows%E6%88%96Linux%20SSH%E8%BF%9E%E6%8E%A5%E6%88%96%E8%80%85%E6%9C%8D%E5%8A%A1%E5%81%B6%E5%8F%91%E6%80%A7%E6%96%AD%E5%BC%80%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="Windows或Linux-SSH连接或者服务偶发性断开问题处理"><a href="#Windows或Linux-SSH连接或者服务偶发性断开问题处理" class="headerlink" title="Windows或Linux SSH连接或者服务偶发性断开问题处理"></a>Windows或Linux SSH连接或者服务偶发性断开问题处理</h3><p><a href="https://support.huaweicloud.com/trouble-ecs/ecs-trouble.pdf">查看PDF</a></p><p><a href>分享</a></p><h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h4><p>该文档适用于在SSH连接Linux云服务器或者访问该服务器上的应用时偶现连接断开。</p><h4 id="约束与限制"><a href="#约束与限制" class="headerlink" title="约束与限制"></a>约束与限制</h4><ol><li>修改系统内核参数可能产生内核不稳定，请评估风险后进行操作。</li><li>为了确保系统稳定运行，修改内核参数后建议在合理的时间重启系统。</li></ol><h4 id="根因分析"><a href="#根因分析" class="headerlink" title="根因分析"></a>根因分析</h4><ol><li><p>执行以下命令，查看系统内核是否开启了TIME_WAIT快速回收和重利用策略</p><p><strong>sysctl -a |grep tcp_tw</strong></p><p>如<a href="https://support.huaweicloud.com/trouble-ecs/ecs_trouble_0317.html#ecs_trouble_0317__fig258143323916">图1</a>所示，确认已开启该策略。</p><p><strong>图1</strong> TIME_WAIT<br><img src="https://support.huaweicloud.com/trouble-ecs/zh-cn_image_0174991741.png"></p></li><li><p>由于服务端开启了TIME_WAIT快速回收和重利用策略导致，即启用了net.ipv4.tcp_tw_recycle或者net.ipv4.tcp_tw_reuse。系统默认是不启用该功能。<br><img src="https://res-static.hc-cdn.cn/aem/content/dam/cloudbu-site/archive/china/zh-cn/support/resource/framework/v3/images/support-doc-new-note.svg">说明：客户端通常在NAT环境下，多台终端使用同一个公网ip，无法实现服务端与客户端的一对一连接。如果开启此参数服务端会回收处于TIME_WAIT状态的TCP连接，导致连接断开。</p></li></ol><h4 id="操作方法："><a href="#操作方法：" class="headerlink" title="操作方法："></a>操作方法：</h4><p>关闭上述两个内核参数，打开/etc/sysctl.conf，添加或者修改下列两行。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_tw_recycle = 0</span><br><span class="line">net.ipv4.tcp_tw_reuse = 0</span><br></pre></td></tr></table></figure><p>执行以下命令，使修改的配置生效。<br><strong># sysctl -p</strong></p><p><img src="https://res-static.hc-cdn.cn/aem/content/dam/cloudbu-site/archive/china/zh-cn/support/resource/framework/v3/images/support-doc-new-note.svg">说明：启动中修改内核参数可能存在内核加载该参数不稳定的情况，建议在合适的时间进行重启。</p><p>上文参考：<a href="https://support.huaweicloud.com/trouble-ecs/ecs_trouble_0317.html">SSH连接或者服务偶发性断开问题处理_弹性云服务器 ECS_故障排除_SSH连接 (huaweicloud.com)</a></p><h4 id="windows服务偶发性断连解决"><a href="#windows服务偶发性断连解决" class="headerlink" title="windows服务偶发性断连解决"></a>windows服务偶发性断连解决</h4><p>此文参考：</p><p><a href="https://zhuanlan.zhihu.com/p/604394878">https://zhuanlan.zhihu.com/p/604394878</a><br><a href="https://blog.csdn.net/boonya/article/details/105700988">https://blog.csdn.net/boonya/article/details/105700988</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzkzNzI1MzE2Mw==&mid=2247484249&idx=1&sn=d522df8c29cdc5c2bb1c466403c0d737&chksm=c293031df5e48a0b7856b9a553dbf1df27015afe09c939f114ad35ad486a30737dd4b258f4e5&scene=21#wechat_redirect">运维排查篇 | 服务器产生大量的TIME_WAIT的原因你知道吗？</a></p>]]></content>
      
      
      <categories>
          
          <category> default </category>
          
      </categories>
      
      
        <tags>
            
            <tag> default </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openstack上使用windows镜像制作</title>
      <link href="/2024/02/19/openstack%E4%B8%8A%E4%BD%BF%E7%94%A8windows%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C/"/>
      <url>/2024/02/19/openstack%E4%B8%8A%E4%BD%BF%E7%94%A8windows%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="一-workstdtion-vsphere-制作openstack镜像"><a href="#一-workstdtion-vsphere-制作openstack镜像" class="headerlink" title="一.  workstdtion/ vsphere 制作openstack镜像"></a>一.  <code>workstdtion</code>/ vsphere 制作<code>openstack</code>镜像</h2><h3 id="note"><a href="#note" class="headerlink" title="note:"></a>note:</h3><h4 id="演示windows-server2016版本-配置时需要至少给C盘50G空间"><a href="#演示windows-server2016版本-配置时需要至少给C盘50G空间" class="headerlink" title="演示windows-server2016版本 / 配置时需要至少给C盘50G空间"></a>演示<code>windows-server2016</code>版本 / 配置时需要至少给C盘<code>50G</code>空间</h4><h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h3><blockquote><p><strong>因为 windows 默认不支持 virtio 驱动，而通过 openstack 管理的虚拟机是需要 virtio 驱动的，所以需要给 windows 安装驱动，包括硬盘驱动和网卡驱动另外还需要安装CloudbaseInitSetup和qemu-ga (qemu-guest-agent)</strong> <a href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/</a> <strong>以上地址可下载最新稳定版的 virtio-win-x.x.xxx.iso 文件，该文件包含了硬盘驱动和网卡驱动以及</strong></p></blockquote><h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><ul><li><a href="https://www.jianshu.com/p/60caf1c2f10a">https://www.jianshu.com/p/60caf1c2f10a</a>                                                                 （简书）</li><li><a href="https://support.huaweicloud.com/usermanual-ims/zh-cn_topic_0030730602.html">https://support.huaweicloud.com/usermanual-ims/zh-cn_topic_0030730602.html</a>   （华为云 could-init使用）</li><li><a href="https://cloud.tencent.com/document/product/213/30000">https://cloud.tencent.com/document/product/213/30000</a>                                             (腾讯云  could-init配置)</li><li><a href="https://blog.51cto.com/readshlinux/1902888">https://blog.51cto.com/readshlinux/1902888</a>                                                                (51cto修改密码脚本)</li></ul><h3 id="命令参考："><a href="#命令参考：" class="headerlink" title="命令参考："></a>命令参考：</h3><ul><li><a href="http://linuxcoming.com/blog/2019/09/03/linux_basic_tools_virt_install_os_variant.html">http://linuxcoming.com/blog/2019/09/03/linux_basic_tools_virt_install_os_variant.html</a></li><li><strong>驱动无法安装参考：</strong></li><li><a href="https://zhidao.baidu.com/question/2207933972086796788.html">https://zhidao.baidu.com/question/2207933972086796788.html</a></li></ul><h4 id="安装必备软件"><a href="#安装必备软件" class="headerlink" title="安装必备软件"></a>安装必备软件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 安装必备软件</span><br><span class="line">yum install -y qemu-kvm libvirt virt-install bridge-utils</span><br></pre></td></tr></table></figure><h3 id="1-下载Cloudbase-Init工具-下载Cloudbase-Init工具安装包。"><a href="#1-下载Cloudbase-Init工具-下载Cloudbase-Init工具安装包。" class="headerlink" title="1.下载Cloudbase-Init工具  下载Cloudbase-Init工具安装包。"></a><code>1</code>.下载<code>Cloudbase-Init</code>工具  下载<code>Cloudbase-Init</code>工具安装包。</h3><p><strong>根据Windows操作系统的不同位数，您需要下载不同版本的Cloudbase-Init工具安装包。</strong></p><p><strong>Cloudbase官网：</strong></p><p><a href="https://links.jianshu.com/go?to=http://www.cloudbase.it/cloud-init-for-windows-instances/">http://www.cloudbase.it/cloud-init-for-windows-instances/</a>。</p><p><strong>Cloudbase-Init分为稳定版本和Beta版本两种。</strong> <strong>稳定版本获取路径：</strong></p><p><strong>64位：</strong></p><p><a href="https://links.jianshu.com/go?to=https://www.cloudbase.it/downloads/CloudbaseInitSetup_Stable_x64.msi">https://www.cloudbase.it/downloads/CloudbaseInitSetup_Stable_x64.msi</a><br><a href="https://cloudbase.it/downloads/CloudbaseInitSetup_0_9_11_x64.msi">https://cloudbase.it/downloads/CloudbaseInitSetup_0_9_11_x64.msi</a><br><a href="https://cloudbase.it/downloads/CloudbaseInitSetup_0_9_9_x64.msi">https://cloudbase.it/downloads/CloudbaseInitSetup_0_9_9_x64.msi</a></p><p><strong>32位：</strong></p><p><a href="https://links.jianshu.com/go?to=https://www.cloudbase.it/downloads/CloudbaseInitSetup_Stable_x86.msi">https://www.cloudbase.it/downloads/CloudbaseInitSetup_Stable_x86.msi</a></p><p><strong>Beta版本获取路径：</strong></p><p><strong>64位：</strong><a href="https://links.jianshu.com/go?to=https://www.cloudbase.it/downloads/CloudbaseInitSetup_x64.msi">https://www.cloudbase.it/downloads/CloudbaseInitSetup_x64.msi</a></p><p><strong>32位：</strong><a href="https://links.jianshu.com/go?to=https://www.cloudbase.it/downloads/CloudbaseInitSetup_x86.msi">https://www.cloudbase.it/downloads/CloudbaseInitSetup_x86.msi</a></p><p><strong>virtio-win驱动下载:</strong></p><p><strong><a href="https://links.jianshu.com/go?to=https://github.com/virtio-win/kvm-guest-drivers-windows">https://github.com/virtio-win/kvm-guest-drivers-windows</a></strong></p><p><strong>或</strong></p><p><a href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/</a></p><h4 id="windows-iso镜像下载地址："><a href="#windows-iso镜像下载地址：" class="headerlink" title="windows-iso镜像下载地址："></a>windows-iso镜像下载地址：</h4><p><a href="https://msdn.itellyou.cn/">https://msdn.itellyou.cn/</a></p><hr><h4 id="首先开启vcenter-vmware虚拟化："><a href="#首先开启vcenter-vmware虚拟化：" class="headerlink" title="首先开启vcenter/vmware虚拟化："></a>首先开启vcenter/vmware虚拟化：</h4><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_c7a56db15460c4c9ec3337ba89289ef2.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_c7a56db15460c4c9ec3337ba89289ef2.png"></p><h5 id="注意事项：-目录建议根目录下创建一个新目录-不能在-root目录执行创建工作目录-会报错-权限错误"><a href="#注意事项：-目录建议根目录下创建一个新目录-不能在-root目录执行创建工作目录-会报错-权限错误" class="headerlink" title="注意事项：  目录建议根目录下创建一个新目录 不能在/root目录执行创建工作目录 会报错 权限错误"></a>注意事项：  目录建议根目录下创建一个新目录 不能在/root目录执行创建工作目录 会报错 权限错误</h5><h4 id="下载完成截图：共3软件"><a href="#下载完成截图：共3软件" class="headerlink" title="下载完成截图：共3软件"></a>下载完成截图：共<code>3</code>软件</h4><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_29087c9168c1688bc91ff2c661a017a6.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_29087c9168c1688bc91ff2c661a017a6.png"></p><h3 id="2-网卡配置（物理机-vmware-vcenter创建）"><a href="#2-网卡配置（物理机-vmware-vcenter创建）" class="headerlink" title="2. 网卡配置（物理机/ vmware / vcenter创建）"></a><code>2</code>. 网卡配置（物理机<code>/ vmware / vcenter</code>创建）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 备份网卡</span><br><span class="line">cp ifcfg-ens33 ifcfg-br0</span><br></pre></td></tr></table></figure><h5 id="修改ifcfg-ens33"><a href="#修改ifcfg-ens33" class="headerlink" title="修改ifcfg-ens33"></a>修改<code>ifcfg-ens33</code></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">2、BOOTPROTO=&quot;dhcp&quot; # 改为 BOOTPROTO=&quot;static&quot;</span><br><span class="line">3、BRIDGE=br0       # 调整为网桥模式 其他不做更改</span><br><span class="line"># 保留如下配置其他配置通通删除</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">BRIDGE=br0</span><br><span class="line">UUID=01d75770-3b87-47e3-bbc3-bebaed2293e3</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_6372d21fbb18fb333f61a84f13eed939.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_6372d21fbb18fb333f61a84f13eed939.png"></p><h4 id="修改ifcfg-br0"><a href="#修改ifcfg-br0" class="headerlink" title="修改ifcfg-br0"></a>修改<code>ifcfg-br0</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">1、TYPE=&quot;Ethernet&quot;   # 修改为TYPE=&quot;Bridge&quot;</span><br><span class="line">2、BOOTPROTO=&quot;dhcp&quot;  # 改为 BOOTPROTO=&quot;static&quot;</span><br><span class="line">3、NAME=&quot;ens33&quot;      # 修改为 NAME=&quot;br0&quot;  及 DEVICE=&quot;ens33&quot;  修改为 DEVICE=&quot;br0&quot;</span><br><span class="line">4、注释 UUID         # UUID=&quot;a8d78ec6-485c-4d14-aae1-1908bc6b9a61&quot;</span><br><span class="line">5、配置静态IP</span><br><span class="line">IPADDR=10.0.0.20</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.220</span><br><span class="line">DNS1=223.5.5.5</span><br><span class="line"># 完整网卡配置 -------------------------------</span><br><span class="line">TYPE=Bridge</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=br0</span><br><span class="line"># UUID=01d75770-3b87-47e3-bbc3-bebaed2293e3</span><br><span class="line">DEVICE=br0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=10.0.0.20</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.220</span><br><span class="line">DNS1=223.5.5.5</span><br><span class="line"># 重启网卡</span><br><span class="line">systemctl restart network.service</span><br></pre></td></tr></table></figure><h4 id="如果采用（云主机）创建需要修改网卡（-强烈建议不要使用云主机可能会出现各种抽风现象-）配置-如下配置-如下："><a href="#如果采用（云主机）创建需要修改网卡（-强烈建议不要使用云主机可能会出现各种抽风现象-）配置-如下配置-如下：" class="headerlink" title="如果采用（云主机）创建需要修改网卡（ 强烈建议不要使用云主机可能会出现各种抽风现象 ）配置 如下配置 如下："></a>如果采用（云主机）创建需要修改网卡（ 强烈建议不要使用云主机可能会出现各种抽风现象 ）配置 如下配置 如下：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@images network-scripts]# cat ifcfg-br0</span><br><span class="line"># Created by cloud-init on instance boot automatically, do not edit.</span><br><span class="line">#</span><br><span class="line">BOOTPROTO=static      # 改</span><br><span class="line">DEVICE=br0            # 改</span><br><span class="line">HWADDR=fa:16:3e:90:a8:67</span><br><span class="line">MTU=1500</span><br><span class="line">ONBOOT=yes</span><br><span class="line">STARTMODE=auto</span><br><span class="line">TYPE=Bridge           # 改</span><br><span class="line">USERCTL=no            </span><br><span class="line">IPADDR=10.0.0.76      # 改</span><br><span class="line">PREFIX=24             # 改</span><br><span class="line">GATEWAY=10.0.0.1      # 改</span><br><span class="line">DNS1=223.5.5.5        # 改</span><br><span class="line">#-------------------------------------------------------------------------</span><br><span class="line">[root@images network-scripts]# cat ifcfg-eth0</span><br><span class="line"># Created by cloud-init on instance boot automatically, do not edit.</span><br><span class="line">#</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEVICE=eth0</span><br><span class="line">#HWADDR=fa:16:3e:90:a8:67     # 改</span><br><span class="line">MTU=1500</span><br><span class="line">ONBOOT=yes</span><br><span class="line">STARTMODE=auto</span><br><span class="line">TYPE=Ethernet                 # 改</span><br><span class="line">USERCTL=no</span><br><span class="line">BRIDGE=br0                    # 改</span><br></pre></td></tr></table></figure><h4 id="3-查看是否支持虚拟化-（支持）"><a href="#3-查看是否支持虚拟化-（支持）" class="headerlink" title="3. 查看是否支持虚拟化 （支持）"></a><code>3</code>. 查看是否支持虚拟化 （支持）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看是否支持虚拟化</span><br><span class="line">grep -E &#x27;(vmx|svm)&#x27; /proc/cpuinfo</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_a37f9f1aa2fc3773a217aed3042a7fdf.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_a37f9f1aa2fc3773a217aed3042a7fdf.png"></p><h3 id="4-创建镜像文件包"><a href="#4-创建镜像文件包" class="headerlink" title="4. 创建镜像文件包"></a><code>4</code>. 创建镜像文件包</h3><p><strong>文件存放目录必须为根目录下新建一个目录 切记不能在</strong><code>root</code>目录否则会报错</p><h4 id="各个目录存放文件概览："><a href="#各个目录存放文件概览：" class="headerlink" title="各个目录存放文件概览："></a>各个目录存放文件概览：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 关于文件存放目录必须为根目录下新建一个目录 此处如下：</span><br><span class="line">mkdir -p /data/windows/data</span><br><span class="line">mkdir -p /data/windows/CloudbaseInitSetup</span><br><span class="line"></span><br><span class="line"># /data/windows目录存放：</span><br><span class="line">[root@cpe-172-100-70-251 windows]# ls -lh</span><br><span class="line">总用量 101M</span><br><span class="line">-rw-r--r--. 1 root root 101M 3月  22 13:52 CloudbaseInitSetup.iso</span><br><span class="line">drwxr-xr-x. 2 root root  124 3月  22 13:49 data</span><br><span class="line">-rw-r--r--. 1 root root 193K 3月  22 13:51 windows_server_2016_x64.qcow2</span><br><span class="line"></span><br><span class="line">#/data/windows/data</span><br><span class="line">[root@cpe-172-100-70-251 data]# ll</span><br><span class="line">总用量 6801916</span><br><span class="line">-rw-r--r--. 1 qemu qemu 6302720000 3月  22 10:43 cn_windows_server_2016_vl_x64_dvd_11636695.iso</span><br><span class="line">-rw-r--r--. 1 qemu qemu  534818816 3月  22 09:18 virtio-win-0.1.229.iso</span><br><span class="line"></span><br><span class="line"># /data/windows/CloudbaseInitSetup目录存放 </span><br><span class="line">-rw-r--r--. 1 root root 40M 3月  20 2017 CloudbaseInitSetup_0_9_11_x64.msi   （本教程使用版本）</span><br><span class="line">-rw-r--r--. 1 qemu qemu 61M 3月  22 09:18 CloudbaseInitSetup_1_1_4_x64.msi   （稳定版）</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="执行创建镜像文件包："><a href="#执行创建镜像文件包：" class="headerlink" title="执行创建镜像文件包："></a>执行创建镜像文件包：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 创建镜像文件包 ：/data/windows/ 目录执行</span><br><span class="line">qemu-img create -f qcow2 windows_server_2016_x64.qcow2 50G</span><br><span class="line"># 将CloudbaseInitSetup_1_1_4_x64.msi 配置放在CloudbaseInitSetup.iso中 （执行目录：/data/windows/）</span><br><span class="line">note: 此步骤不执行通过vnc细化配置时将无法找到win2k16目录下网卡驱动</span><br><span class="line"># 基于目录CloudbaseInitSetup制作iso镜像命名为CloudbaseInitSetup.iso</span><br><span class="line">mkisofs -o CloudbaseInitSetup.iso CloudbaseInitSetup/       </span><br><span class="line"># 查看镜像文件包</span><br><span class="line">qemu-img  info  windows_server_2016_x64.qcow2</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_57235b7e44eacb3280aa8ad3117a09f1.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_57235b7e44eacb3280aa8ad3117a09f1.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_6594c419f60291d68cc7c6093c655a86.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_6594c419f60291d68cc7c6093c655a86.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_8dc76fd0808704d1163b1a63b168b02d.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_8dc76fd0808704d1163b1a63b168b02d.png"></p><h3 id="创建镜像虚拟机"><a href="#创建镜像虚拟机" class="headerlink" title="创建镜像虚拟机"></a>创建镜像虚拟机</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"># 参数</span><br><span class="line">--name windows_server_2016_x64                     #系统命名</span><br><span class="line">--ram 4096 \                                       #内存大默认M</span><br><span class="line">--vcpu=4 \                                         #CPU核数</span><br><span class="line">--os-type=windows \                                 #系统类型</span><br><span class="line">--os-variant=win2k16 \                             #系统版本</span><br><span class="line">--disk windows_server_2016_x64.qcow2,bus=virtio \  #创建系统盘镜像   格式qcow2  总成</span><br><span class="line"> # windows ISO镜像路径 类型为CDROM sata盘</span><br><span class="line">--disk path=/data/cn_windows_server_2016_x64_dvd_9327743.iso,device=cdrom,bus=sata \   </span><br><span class="line"> # windows 驱动 ISO镜像 路径 类型</span><br><span class="line">--disk path=/data/virtio-win-0.1.190.iso,device=cdrom,bus=sata \             </span><br><span class="line">--bridge=br0,model=virtio \                        #网络桥接模式</span><br><span class="line">--graphics vnc,listen=0.0.0.0 \                    #vnc </span><br><span class="line">--noautoconsole</span><br><span class="line"># 云主机创建</span><br><span class="line"># --(需要至少60G空间)--------------------------------------------------------------------------------------------</span><br><span class="line"># 执行创建windows镜像 (windows2016)</span><br><span class="line"># workstdtion / 云主机 创建方式均可采用 （方式1）</span><br><span class="line">virt-install --connect qemu:///system --name windows_server_2016_x64 --vcpus=2 --memory 1024 --os-type=windows --os-variant=win2k16 \</span><br><span class="line">--disk windows_server_2016_x64.qcow2,bus=virtio --disk size=50 \</span><br><span class="line">--disk path=./data/cn_windows_server_2016_x64_dvd_9718765.iso,device=cdrom,size=5   \</span><br><span class="line">--disk path=./data/virtio-win-0.1.229.iso,device=cdrom,bus=sata \</span><br><span class="line">--bridge=br0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole  --check all=off</span><br><span class="line"></span><br><span class="line"># 云主机 创建（参考）（方式2）</span><br><span class="line">sudo virt-install --connect qemu:///system --name windows_server_2016_x64 --vcpus=2 --memory 1024 --os-type=windows --os-variant=win2k16 \</span><br><span class="line">--disk windows_server_2016_x64.qcow2,bus=virtio --disk size=50 \</span><br><span class="line">--disk path=./data/cn_windows_server_2016_x64_dvd_9718765.iso,device=cdrom,size=5  \</span><br><span class="line">--disk path=./data/virtio-win-0.1.229.iso,device=cdrom,bus=sata \</span><br><span class="line">--network network=default,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole </span><br><span class="line"># -----------------------------------------------------------------------------------------------------------</span><br><span class="line"># vsphere创建</span><br><span class="line"># -----------------------------------------------------------------------------------------------------------</span><br><span class="line"># windows2016新增驱动（本教程执行命令）</span><br><span class="line">参数：bus=stat &gt;&gt; bus=ide</span><br><span class="line">virt-install --connect qemu:///system --name windows_server_2016_x64 --vcpus=2 --memory 2048 --os-type=windows --os-variant=win2k16 \</span><br><span class="line">--disk windows_server_2016_x64.qcow2,bus=virtio --disk size=50 \</span><br><span class="line">--disk path=./data/cn_windows_server_2016_vl_x64_dvd_11636695.iso,device=cdrom,size=5,bus=ide  \</span><br><span class="line">--disk path=./data/virtio-win-0.1.229.iso,device=cdrom,bus=ide \</span><br><span class="line">--disk path=./CloudbaseInitSetup.iso,device=cdrom,bus=ide \   # 新增驱动</span><br><span class="line">--bridge=br0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole  --check all=off  </span><br><span class="line"></span><br><span class="line"># windows2012r2</span><br><span class="line">qemu-img create -f qcow2 windows_server_2012r2_x64.qcow2 30G</span><br><span class="line"></span><br><span class="line">mkisofs -o CloudbaseInitSetup.iso CloudbaseInitSetup/  </span><br><span class="line"></span><br><span class="line">virt-install --connect qemu:///system --name windows_server_2012r2_x64 --vcpus=2 --memory 4096 --os-type=windows --os-variant=win2k12r2 \</span><br><span class="line">--disk windows_server_2012r2_x64.qcow2,bus=virtio --disk size=30 \</span><br><span class="line">--disk path=./data/cn_windows_server_2012_r2_vl_x64_dvd_2979220.iso,device=cdrom,size=5,bus=ide  \</span><br><span class="line">--disk path=./data/virtio-win-0.1.229.iso,device=cdrom,bus=ide \</span><br><span class="line">--disk path=./CloudbaseInitSetup.iso,device=cdrom,bus=ide --bridge=br0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole  --check all=off  </span><br><span class="line"></span><br><span class="line"># windows2019</span><br><span class="line">virt-install --connect qemu:///system --name windows_server_2019_x64 --vcpus=2 --memory 2048 --os-type=windows --os-variant=win2k19 \</span><br><span class="line">--disk windows_server_2019_x64.qcow2,bus=virtio --disk size=50 \</span><br><span class="line">--disk path=./data/cn_windows_server_2019_x64_dvd_4de40f33.iso,device=cdrom,size=5,bus=ide  \</span><br><span class="line">--disk path=./data/virtio-win-0.1.229.iso,device=cdrom,bus=ide \</span><br><span class="line">--disk path=./CloudbaseInitSetup.iso,device=cdrom,bus=ide \</span><br><span class="line">--bridge=br0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole  --check all=off </span><br><span class="line"></span><br><span class="line"># -----------------------------------------------------------------------------------------------------------</span><br><span class="line"># 查看刚通过镜像启动的虚拟机虚拟机 / 查看--os-variant支持的类型</span><br><span class="line">virsh list --all       # 列出所有虚机</span><br><span class="line">osinfo-query os        # 查看支持的类型</span><br><span class="line">virsh shutdown ubuntu  # 正常关闭虚拟机</span><br><span class="line">virsh undefine name    # 删除虚机</span><br><span class="line">virsh start name       # 启动指定虚机</span><br><span class="line">virsh reboot name      # 重启指定虚机</span><br><span class="line"></span><br><span class="line">[root@localhost windows]# osinfo-query os</span><br><span class="line"> Short ID             | Name                                               | Version  | ID                            </span><br><span class="line">----------------------+----------------------------------------------------+----------+---</span><br><span class="line"> alpinelinux3.5       | Alpine Linux 3.5                                   | 3.5      |  </span><br><span class="line"> alpinelinux3.6       | Alpine Linux 3.6                                   | 3.6      | </span><br><span class="line"> alpinelinux3.7       | Alpine Linux 3.7                                   | 3.7      | </span><br><span class="line"> alpinelinux3.8       | Alpine Linux 3.8                                   | 3.8      | </span><br><span class="line"> alt.p8               | ALT p8 StarterKits                                 | p8       | </span><br><span class="line"> alt.p9               | ALT p9 StarterKits                                 | p9       |</span><br></pre></td></tr></table></figure><h5 id="参考：-1"><a href="#参考：-1" class="headerlink" title="参考："></a>参考：</h5><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_66220ca6a8e52c12bfe4526cba82dbb3.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_66220ca6a8e52c12bfe4526cba82dbb3.png"></p><h4 id="出现下方回显则说明windows镜像创建成功："><a href="#出现下方回显则说明windows镜像创建成功：" class="headerlink" title="出现下方回显则说明windows镜像创建成功："></a>出现下方回显则说明windows镜像创建成功：</h4><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_d46cb89118adb196c752bfeefb854b09.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_d46cb89118adb196c752bfeefb854b09.png"></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_49e8c464d4892bd3ca53f4cc2a3e94d9.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_49e8c464d4892bd3ca53f4cc2a3e94d9.png"></p><h3 id="5-virt-install常用命令："><a href="#5-virt-install常用命令：" class="headerlink" title="5. virt-install常用命令："></a><code>5. virt-install</code>常用命令：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># 查看刚通过镜像启动的虚拟机虚拟机 / 查看--os-variant支持的类型</span><br><span class="line">virsh list             # 列出正在运行的虚拟机</span><br><span class="line">osinfo-query os        # 查看支持的类型</span><br><span class="line"># virt-install常用命令</span><br><span class="line">virsh list --all       # 列出所有虚机</span><br><span class="line">virsh start  web01     # 启动指定虚机</span><br><span class="line">virsh reboot web01     # 重启指定虚机（关闭状态无法重启）</span><br><span class="line">virsh console name     # 连接虚拟机</span><br><span class="line">virsh destroy name     # 拔掉电源（很少用）</span><br><span class="line"></span><br><span class="line">virsh undefine web01   # 删除虚机文件即删除虚拟机（不会删除磁盘文件）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">virsh domblklist web01             # 查看虚拟机磁盘信息</span><br><span class="line">virsh dominfo    web01             # 查看虚拟机配置信息</span><br><span class="line">virsh domiflist  web01             # 查看虚拟网卡信息</span><br><span class="line">virsh dumpxml    web01             # 以 xml格式查看虚拟机</span><br><span class="line">virsh define     file-name         # 导入虚拟机</span><br><span class="line">virsh edit       name              # 编辑虚拟机配置（一般是在刚定义完虚拟机之后）自带语法检测</span><br><span class="line">virsh domrename  old-name  new-name   # 虚拟机重命名</span><br><span class="line">virsh vncdisplay web01                # 查看vnc端口</span><br><span class="line">virsh autostart  name                 # 虚拟机随机重启</span><br><span class="line">virsh autostart --disable name        # 取消虚拟机随机重启</span><br><span class="line"></span><br><span class="line"># 图形界面：</span><br><span class="line">通过执行名virt-manager，启动libvirt的图形界面，在图形界面下可以一步一步的创建虚拟机，管理虚拟机，还可以直接控制虚拟机的桌面。</span><br><span class="line"># 命令行：</span><br><span class="line">virsh list                              # 显示本地活动虚拟机</span><br><span class="line">virsh list –all                         # 显示本地所有的虚拟机（活动的+不活动的）</span><br><span class="line">virsh define ubuntu.xml                 # 通过配置文件定义一个虚拟机（这个虚拟机还不是活动的）</span><br><span class="line">virsh start ubuntu                      # 启动名字为ubuntu的非活动虚拟机</span><br><span class="line">virsh create ubuntu.xml                 # 创建虚拟机（创建后，虚拟机立即执行，成为活动主机）</span><br><span class="line">virsh suspend ubuntu                    # 暂停虚拟机</span><br><span class="line">virsh resume ubuntu                     # 启动暂停的虚拟机</span><br><span class="line">virsh shutdown web01          # 正常关闭虚拟机</span><br><span class="line">virsh destroy ubuntu          # 强制拔掉电源关闭虚拟机（很少使用）</span><br><span class="line"></span><br><span class="line">virsh domname 2                         # 显示id号为2的虚拟机名                      </span><br><span class="line">virsh domid ubuntu                      # 显示虚拟机id号                     </span><br><span class="line">virsh domuuid ubuntu                    # 显示虚拟机的uuid   </span><br><span class="line">virsh domstate ubuntu                   # 显示虚拟机的当前状态  </span><br><span class="line">virsh dumpxml ubuntu                    # 显示虚拟机的当前配置文件（可能和定义虚拟机时的配置不同，因为当虚拟机启动时，需要给# 虚拟机分配id号、uuid、vnc端口号等等）  </span><br><span class="line">virsh setmem ubuntu 512000              # 给不活动虚拟机设置内存大小  </span><br><span class="line">virsh setvcpus ubuntu 4                 # 给不活动虚拟机设置cpu个数  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="配置snat使镜像可以访问internet-在宿主机执行"><a href="#配置snat使镜像可以访问internet-在宿主机执行" class="headerlink" title="配置snat使镜像可以访问internet( 在宿主机执行 )"></a>配置<code>snat</code>使镜像可以访问<code>internet</code>( 在宿主机执行 )</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 开启</span><br><span class="line">--参数：</span><br><span class="line">-s 172.100.70.241           # 镜像ip  （或 其他虚拟机）</span><br><span class="line">--to-source 172.100.70.251  # 宿主机ip（或 本虚拟机）</span><br><span class="line">sysctl net.ipv4.ip_forward=1</span><br><span class="line">sysctl -p</span><br><span class="line">iptables -t nat -A POSTROUTING -s 172.100.70.241  -j SNAT --to-source 172.100.70.251</span><br></pre></td></tr></table></figure><h2 id="二-vnc细化配置-qemu-img-见下章"><a href="#二-vnc细化配置-qemu-img-见下章" class="headerlink" title="二. vnc细化配置 qemu-img ( 见下章 )"></a>二. <code>vnc</code>细化配置 <code>qemu-img</code> ( 见下章 )</h2><h4 id="qemu-img命令参考："><a href="#qemu-img命令参考：" class="headerlink" title="qemu-img命令参考："></a><code>qemu-img</code>命令参考：</h4><p><a href="https://zhuanlan.zhihu.com/p/623104229">https://zhuanlan.zhihu.com/p/623104229</a></p><p><a href="https://support.huaweicloud.com/bestpractice-ims/ims_bp_0030.html">https://support.huaweicloud.com/bestpractice-ims/ims_bp_0030.html</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_e552b52db5a6700f7e86be4d1ee01215.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_e552b52db5a6700f7e86be4d1ee01215.png"></p><h4 id="11-配置完成后处理镜像（压缩镜像）"><a href="#11-配置完成后处理镜像（压缩镜像）" class="headerlink" title="11.配置完成后处理镜像（压缩镜像）"></a><code>11</code>.配置完成后处理镜像（压缩镜像）</h4><h3 id="参考：-2"><a href="#参考：-2" class="headerlink" title="参考："></a>参考：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 参数</span><br><span class="line">-c，表示必须压缩目标镜像（仅限qcow格式）。</span><br><span class="line">-f，第一种镜像格式。</span><br><span class="line">-o, options：选项，是以逗号分隔的格式特定选项列表，格式为name=value格式。使用“-o？”有关使用的格式支持的选项的概述，或参阅下面的格式说明了解详细信息。</span><br><span class="line">++++++++++++++++++++++++++++++++++</span><br><span class="line">#--sparse=always稀疏拷贝，忽略全0数据</span><br><span class="line">cp --sparse=always ws2012r2.qcow2 ws2012r2-new.qcow2 #--sparse=always稀疏拷贝，忽略全0数据</span><br><span class="line"># raw和qcow2需要转换，这里原本用的qcow2，所以未转换。</span><br><span class="line"># 案例：</span><br><span class="line">qemu-img convert -c -f raw -O qcow2 centos7-new.raw centos7-new.qcow2</span><br><span class="line">qemu-img convert -c -O qcow2 centos7-new.qcow2 centos7-mini.qcow2</span><br><span class="line"># 实际操作</span><br><span class="line">qemu-img convert -c -O qcow2 windows_server_2016_x64_new.qcow2 windows_server_2016_x64_min.qcow2</span><br><span class="line">++++++++++++++++++++++++++++++++++</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_ea53daa63d24ff564cde1f936d3d4e0f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_ea53daa63d24ff564cde1f936d3d4e0f.png"></p><h4 id="实际操作"><a href="#实际操作" class="headerlink" title="实际操作:"></a>实际操作:</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># raw和qcow2需要转换，这里原本用的qcow2，所以未转换。</span><br><span class="line"># 案例：</span><br><span class="line">qemu-img convert -c -f raw -O qcow2 centos7-new.raw centos7-new.qcow2</span><br><span class="line">qemu-img convert -c -f qcow2 -o  raw centos7-new.qcow2 centos7-mini.raw</span><br><span class="line"># 实际操作</span><br><span class="line">qemu-img convert -c -f raw -O qcow2 windows_server_2016_x64_new.raw windows_server_2016_x64_min.qcow2</span><br></pre></td></tr></table></figure><h4 id="上传到openstack—skyline"><a href="#上传到openstack—skyline" class="headerlink" title="上传到openstack—skyline:"></a>上传到<code>openstack—skyline</code>:</h4><p><strong>参数：</strong><code>--property os_distro=windows --property os_version=2012 --property os_admin_user=Administrator</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># qcm2格式</span><br><span class="line">openstack image create --disk-format qcow2 --public --property hw_qemu_guest_agent=yes --property os_distro=windows --property os_version=2012 --property os_admin_user=Administrator --file  windows_server_2016_x64.qcow2 windows_server_2016_x64.qcow2</span><br><span class="line"># raw格式</span><br><span class="line">openstack image create --disk-format raw --public --property hw_qemu_guest_agent=yes --property os_distro=windows --property os_version=2012 --property os_admin_user=Administrator --file windows_server_2019_x64.raw windows_server_2019_x64.raw </span><br></pre></td></tr></table></figure><h4 id="使用命令行创建云主机："><a href="#使用命令行创建云主机：" class="headerlink" title="使用命令行创建云主机："></a>使用命令行创建云主机：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 此命令必须要先将镜像上传到openstack</span><br><span class="line">openstack server create --config-drive true --image windows2016min.qcow2 --flavor 9 --password ******20! --network demo-net windows2016_test</span><br></pre></td></tr></table></figure><h4 id="注：-此时配置完成-集成可修改密码"><a href="#注：-此时配置完成-集成可修改密码" class="headerlink" title="注： 此时配置完成  集成可修改密码"></a>注： 此时配置完成  集成可修改密码</h4><h4 id="效果："><a href="#效果：" class="headerlink" title="效果："></a>效果：</h4><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_d0e78dd049d08305a4192234429c341d.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_d0e78dd049d08305a4192234429c341d.png"></p><h4 id="扩展：-旧面板-windows-重置密码"><a href="#扩展：-旧面板-windows-重置密码" class="headerlink" title="扩展： 旧面板 windows 重置密码:"></a>扩展： 旧面板 windows 重置密码:</h4><p>更新云主机元数据，添加<code>change_passwd=True</code>, 软重启云主机。重启完之后，虚机密码为 <code>admin_pass</code> 指定的密码。密码重置后再将元数据 <code>change_passwd</code> 删掉，或者改为其他值</p><p><strong>添加后 &gt;&gt; 软重启   ||  软重启之后 &gt;&gt; 删除change_passwd=True    此时密码变为创建云主机时设置的密码即</strong><code>****023!</code>。</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_65022b246096b0295461a22397c72313.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_65022b246096b0295461a22397c72313.png"></p><p><strong>教程结束。</strong></p>]]></content>
      
      
      <categories>
          
          <category> openstack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openstack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>赞助墙</title>
      <link href="/2024/02/01/%E8%B5%9E%E5%8A%A9%E5%A2%99/"/>
      <url>/2024/02/01/%E8%B5%9E%E5%8A%A9%E5%A2%99/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>网站建设与维护实属不易，如果我的文章帮助到了您，或者您想支持我的网站，可以扫描下方二维码进行赞助（赞助时请备注自己的 化名/昵称 ，打赏后将在此页面展示），非常感谢您的支持~ 🌹</p></blockquote><h2 id="赞助墙🌹"><a href="#赞助墙🌹" class="headerlink" title="赞助墙🌹"></a>赞助墙🌹</h2><p>打赏方式  微信  支付宝🌙</p><div class="gallery">    <div class="fj-gallery  data" data-rowheight="220" data-limit="10">    <span class="gallery-data">[{"url":"https://wn-apple-teawine.fun/img/wechatpayqr.webp","alt":"微信"},{"url":"https://wn-apple-teawine.fun/img/alipayqr.webp","alt":"支付宝"}]</span>    </div>    <button class="gallery-load-more"><span>Load More</span><i class="fa-solid fa-arrow-down"></i></button>    </div><table><thead><tr><th>ZzNnWn.</th><th>晒在深海里.</th><th>粘人的鸭嘴兽</th></tr></thead><tbody><tr><td>￥100</td><td>￥50</td><td>￥1000</td></tr><tr><td></td><td></td><td></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 日常 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日常 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>简历</title>
      <link href="/2024/02/01/%E7%AE%80%E5%8E%86/"/>
      <url>/2024/02/01/%E7%AE%80%E5%8E%86/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="简历"><a href="#简历" class="headerlink" title="简历"></a>简历</h2><h4 id="基本信息-教育背景-求职意向"><a href="#基本信息-教育背景-求职意向" class="headerlink" title="基本信息 教育背景 求职意向"></a><strong>基本信息</strong> <strong>教育背景</strong> <strong>求职意向</strong></h4><p>姓名：<br>邮箱：<a href="mailto:&#56;&#55;&#56;&#x38;&#57;&#49;&#54;&#49;&#x31;&#x40;&#x71;&#113;&#x2e;&#99;&#111;&#x6d;">&#56;&#55;&#56;&#x38;&#57;&#49;&#54;&#49;&#x31;&#x40;&#x71;&#113;&#x2e;&#99;&#111;&#x6d;</a><br>证书：阿里云ACP<br>期望薪资：15k<br>岗位：云计算工程师</p><h4 id="专业技能概览"><a href="#专业技能概览" class="headerlink" title="专业技能概览"></a><strong>专业技能概览</strong></h4><p>· 精通各类<strong>linux</strong>系统各项配置性能调优安全优化<strong>shell</strong>脚本操作系统包括但不限于<strong>（ubuntu centos debain 华为欧拉 阿里龙蜥</strong>等）<br>· 精通云计算<strong>iaas paas</strong>层<br>· 精通ceph分布式存储,<br>· 精通openstack集群 nova cinder neutoen glance的运维<br>· 精通grafana开源日志监控<strong>loki</strong><br>· 精通云迁移技术<strong>DTS SMC OSS迁移（阿里云）</strong><br>· 精通冷迁移技术<strong>V2V Qemu-img dd  disk2vhd</strong>等 （使用于任何适配的平台）<br>· 精通<strong>ansible</strong>自动化运维工具<br>· 精通<strong>docker docker-compose Dockerfile。</strong><br>· 精通各种开源时序数据库<strong>influxdb promethus-tsdb</strong>等<br>· 精通各种监控系统<strong>prometheus zabbix telegraf nightingale cacti smartping uptime-Kuma</strong>等<br>· 精通各种关系数据库<strong>mysql postgreSQL mariadb</strong>掌握<strong>Mysql</strong>以及<strong>mariadb</strong>数据库安全策略如（密码安全 登录安全 审计等）<br>· 精通<strong>keepalived+nginx</strong>高可用.掌握<strong>mysql</strong>主从复制 <strong>redis</strong>集群。<br>· 精通部署<strong>openstack</strong>云平台 <strong>管理OpenStack云平台，包括虚拟机实例、网络和存储资源的配置。</strong><br>· 精通<strong>Ceph分布式存储系统，负责Ceph集群的部署、监控和性能调优。</strong><br>· 精通<strong>tcp udp http https snmp ftp vrrp</strong>等各种协议<br>· 精通<strong>nginx</strong> 负载均衡，动静分离，反向代理 熟练掌握开源<strong>openvpn l2tp frp</strong>技术<br>· 精通<strong>nas</strong>存储多副本<strong>cephfs</strong>（单副本<strong>NFS iscsi</strong>） 对象存储 负载均衡 <strong>nat</strong>网关** rds** 等<br>· 精通使用<strong>kubeadm</strong>部署<strong>k8s</strong>以及实现与<strong>ceph</strong>集成（StorageClass）<br>· 熟练掌握<strong>python</strong>脚本（网络爬虫方向）。</p><h4 id="工作经验1"><a href="#工作经验1" class="headerlink" title="工作经验1"></a><strong>工作经验1</strong></h4><p>公司经营范围：主要经营物联网产品 软件开发等</p><h4 id="项目经验："><a href="#项目经验：" class="headerlink" title="项目经验："></a><strong>项目经验：</strong></h4><p>2020.11——2021.04<br>· 维护设计及部署苏州市国家电网各套系统如隧道子系统 精益化管控平台等。<br>2021.04——2021.05<br>· 部署维护优化公司边缘计算箱产品，编写<strong>dockerfile</strong>制作一键启动私有化镜像 并实地测试其功能。<br>2021.05——2021.07<br>· 设计部署公司<strong>vmware vcenter esxi</strong> 私有云平台<br>· 搭建<strong>openvpn</strong>实现企业员工在家访问公司内网<br>· 对需要暴露外网没有<strong>外网IP</strong>的<strong>web</strong>服务做内网穿透。<br>· 对<strong>vcenter</strong>其中一台虚拟机配置外网IP对外服务<br>2021.07——2022.02<br>· 日常维护<strong>mysql</strong>数据库 公司各套系统如禅道 精益化管控平台 <strong>nacos</strong>  虚拟化平台<strong>vcenter</strong>等<br>· 检查系统运行情况排错等<br>· 编写运维技术文档<br>· 利用<strong>ansible</strong>给多台服务器配置环境，编写剧本部署程序环境等。</p><h4 id="工作经验2"><a href="#工作经验2" class="headerlink" title="工作经验2"></a><strong>工作经验2</strong></h4><p><strong>公司介绍：</strong></p><p>华中地区最大的分布式云服务商 阿里云华中地区最大代理商 公司有自己的云计算平台MSC-Stack对外帮助上千家客户上云 对上千家企业提供服务 客户包括小米 华为 英伟达 斗鱼 字节跳动等<br><strong>主要产品：</strong></p><p><strong>MSC-Stack：</strong>基于openstack与ceph分布式存储开发的一套云计算平台。<br>K8s 堡垒机 主机入侵 云主机负载均衡器 nat网关等功能 目前拥有武汉 福州 北京 成都 四节点。<br>原生OpenStack部分：一套openstack n版外网环境 一套openstack zed版内网环境。</p><h4 id="项目经验"><a href="#项目经验" class="headerlink" title="项目经验"></a><strong>项目经验</strong></h4><p><strong>原生OpenStack，MCS-Stack与ceph云计算部分</strong><br>2022.05——2022.06<br>· 部署公司<strong>openstac-zed</strong>版本系统 后端存储采用<strong>ceph</strong>分布式存储 编写<strong>shell</strong>脚本部署九州云开源前端skyline（openstack-ui）<strong>阶段：<br><strong>调研:</strong>  openstack与ceph版本适配 测试搭配情况。<br><strong>制作镜像：</strong>制作</strong>openstack<strong>所需镜像 先搭建</strong>all-in-one<strong>环境</strong>openstack<strong>与</strong>ceph<strong>再制作其镜像 并推送到公司内网harbor镜像平台。<br><strong>搭建：</strong>最后搭建集群版</strong>openstack**<br>· 部署完成后 mariadb passwd等数据备份<br>· 云主机安装docker无法访问外网设置MTU解决<br>· <strong>cephadm</strong>的方式部署后端<strong>ceph</strong>集群。**<br>2023.05—2023.06<br>· 计算节点故障时恢复云主机<br>· 删除云主机卡死，卡在deleting状态<br>2022.07—2022.08<br>· 云盘手动扩容<br>· cinder 云盘无法删除<br>· windows云主机设置密码永不过期<br>· 制作openstack云上使用的镜像（linux(ubuntu16.04-22.04) centos(7.4-8.3) rocky9.2  debain11 windows server 2012r2 —2019）<br>2023.08—2023.08<br>· openstack集群缩减计算节点。</p><p><strong>云计算-云迁移部分</strong><br>2023.06-2023.07<br>· 使用<strong>v2v</strong>，将客户<strong>vmware</strong>数台虚拟机迁移到<strong>MCS-Stack</strong>云平台包括<strong>Linux</strong>与<strong>windows</strong>。<br>· 使用<strong>disk2vhd</strong>技术将客户<strong>OpenStack</strong>云平台<strong>windows server</strong>迁移到<strong>MCS-Stack</strong>云平台。<br>2023.09-2023.09<br>· 阿里云龙蜥镜像ECS，使用<strong>qemu-img</strong>冷迁移技术迁移到<strong>MCS-Stack</strong>云平台 并修改脚本适配<strong>could-init</strong><br>· 客户华为云八台centos7.9，云资源迁移到<strong>MCS-Stack</strong>云平台 使用<strong>qemu-img</strong>冷迁移技术 并安装cloud-init等适配<strong>MCS-Stack</strong>云平台<br>2023.10-2023.11<br>· 将某客户国科云多台centos及rds,ubuntu阿里云<strong>DTS SMC 热</strong>迁移等方式 迁移到阿里云。<br>· 使用共享镜像方式将某客户<strong>A</strong>账号ECS资源迁移到<strong>B</strong>账户及将客户oss迁移到B账号</p><p><strong>客户服务下方为部分例子(2022.04——至今)</strong><br>· 解决rds产品<strong>sql-mode</strong>报错，部署<strong>mysql</strong>主从，部署<strong>redis</strong>集群<br>· 部署<strong>nginx+keepalived</strong>高可用实现一个外网IP两服务器公用 以及一个内网VIP两服务器公用<br>· 客户在mcs-stack上云主机<strong>遭遇xmrig挖矿病毒 pnscan病毒</strong>攻击解决。<br>· 云主机使用lvm卷使数据盘扩容到系统盘后进入<strong>grub rescue</strong>救援模式解决等。<br>· 解决客户使用docker构建nacos遇到的一系列问题包括数据持久化 使用外部数据库等。</p><p><strong>脚本部分</strong><br>· 编写shell脚本监控后端<strong>ceph</strong>集群健康状况（openstack 集成了prometheus实时监控ceph集群状况）。        （告警推送到钉钉），编写清空zabbix表shell脚本。<br>· 编写<strong>zabbix</strong>告警脚本  （企业微信告警），编写lvm自动扩容脚本（人机交互）。<br>· 编写编译安装nginx keepalivedmysql redis，<br>· 监控vcenter exsi python脚本 告警推送到钉钉<br>· 编写部署openstack初始化脚本 以及<strong>all-in-one</strong>环境一键部署openstack脚本<br>· 编写一键清理ceph集群以及一键安装ceph集群脚本，二次开发kalla-ansible集成公司前端面板。<br>· 编写监控oracle python脚本 对某大神的项目二次开发 增加python脚本oracle监控项目<br>· 编写冷迁移v2v半自动迁移脚本，<br>· 编写适用于centos ubuntu 的服务器初始化脚本包括自己设置时区 源 limit docker pip等<br>· 编写mysql pg数据库自动备份脚本，编写ansible剧本实现skyline与openstack集成</p><p><strong>监控部分</strong><br>2022.04-2022.05<br>· 按客户需求设计部署监控某医院七台服务器<strong>telegraf+prometheus+grafana</strong>的方式监控<strong>linux各项指标</strong><br>· <strong>搭建采用telegraf+prometheus架构</strong>监控交换机等数通设备 （后期性能不足替换为zabbix）。<br>· 搭建zabbix监控公司<strong>上百台交换机</strong>实现交换机各种监控不限于（进出口流量 cpu 内存 温度等）搭配脚本实现告警推送到企业微信。<br>2022.07-2022.08<br>· 搭建<strong>telegraf+influxdb+grafana</strong>监控<strong>某客户代运维vcenter</strong>项目 实现对整个集群的监控 包括每一台虚拟机 每一台exsi宿主机 完全满足业务需求 <strong>该vmware项目包含500多台虚拟机</strong>十个<strong>esxi</strong>节点。<br>· 构建<strong>telegraf+influxdb+python</strong>脚本+<strong>grafana</strong>监控<strong>某客户代运维vcenter</strong>项目中五台<strong>oracle</strong>数据库（此项目为对某大神项目二次开发  修改<strong>python</strong>脚本制作<strong>telegraf-py</strong>版镜像实现对<strong>oracle</strong>完全监控）。<br>2023.07-2023.07<br>· 编译<strong>nginx-module-vts</strong>模块进<strong>nginx</strong>使用<strong>prometheus+grafana</strong>实现对<strong>nginx</strong>的监控，部署<strong>uptime-Kuma</strong>监控公司各套系统<br>· 部署<strong>grafana</strong>开源<strong>loki</strong>监控公司各台物理服务器系统日志。</p><p><strong>代运维客户及公司内部系统部署及维护部分（2023.07-至今）</strong><br>· 使用<strong>vercel函数计算</strong>搭建公司<strong>chagpt问答系统实现</strong>跨境访问<strong>openai chatgpt</strong>服务。<br>· 部署<strong>k8s与ceph</strong>集成（<strong>storeglass</strong>）。<br>· 部署<strong>wiki</strong>公司内部知识库系统<br>· 部署<strong>cacti</strong>监控交换机平台<br>· <strong>smartping</strong> 监控网络状况系统并制作<strong>smartping docker</strong>镜像实现快捷部署。<br>· 部署<strong>webstack</strong>网站导航系统。<br>· <strong>ferry万能</strong>工单系统。<br>· <strong>cloudreve</strong>公司云盘系统。<br>· 调研<strong>kanboard</strong>与<strong>禅道</strong>项目管理系统 <strong>因kanboard功能多样但前端简陋</strong>最终选型使用<strong>禅道系统</strong>。<br>· 部署公司<strong>esxi集群使用vcenter</strong>管理平台控制。<br>· 培训公司各种运维人员，研发部署云箱维护<br>· 集群<strong>cronsun</strong>定时任务管理系统，<strong>bitwarden</strong>密码管理平台。<br>· 帮助某云平台客户将<strong>nacos</strong>制作成为镜像实现<strong>docker</strong>一键快捷部署实现数据持久化<br>· 日常维护openstack集群  维护后端存储ceph集群<br>例： 云主机 无法删除 前端卡死 ，10 pgs not deep-scrubbed in time，ceph集群容量告警 osd换盘更换<br>· 公司云平台上千家客户云资源的日常运维服务制作云上环境使用的各种<strong>windows</strong>系统<strong>linux</strong>系统的镜像<br>· 搭建某客户nginx+keepalived高可用 实现主挂<strong>外网IP</strong>及<strong>内网VIP</strong>自动切换到备服务器（该项目只有一个外网IP）<br>· 搭建某客户<strong>mysql</strong>主从复制项目后期替换为<strong>MariaDB Galera****Cluster</strong>实现主备自动切换。</p><h4 id="其他-自有项目"><a href="#其他-自有项目" class="headerlink" title="其他/自有项目"></a>其他/自有项目</h4><p>· 两站点个人博客系统 （编写技术博客180余篇 加上onenote累计三十万字）<br>· <strong>Discuss Twikoo</strong>评论系统<br><strong>OneManager</strong> 网盘管理系统（所有网盘通过此<strong>web</strong>管理<strong>onedrive</strong> 阿里云盘等实现不限格式任意可共享）<br>· <strong>Blazeb2</strong>图床管理系统兼容<strong>s3</strong>协议。<br>· 搭建NextChat访问openai  ChatGpt服务<br>NOTE：上述各种系统均采用<strong>cloudns</strong>提供域名 <strong>cloudfare</strong>提供域名解析及<strong>CDN</strong>缓存等 除博客外其余系统均使用<strong>vercel</strong>函数计算（faas）部署。</p><h4 id="自我评价-兴趣爱好"><a href="#自我评价-兴趣爱好" class="headerlink" title="自我评价/兴趣爱好"></a>自我评价/兴趣爱好</h4><p>自我评价<br>· 强执行力（执行的意愿+执行的能力）<br>· 强学习力（对新技术的渴望+刻苦的钻研精神）<br>· 较强的团队合作意识、乐于并善于分享。<br>兴趣爱好<br>· 篮球 足球 羽毛球 散步 登山 等各种运动及对技术有浓厚的兴趣爱好瞎折腾 。<br>· 热爱中国古诗词文化 及明代历史。</p>]]></content>
      
      
      <categories>
          
          <category> 日常 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日常 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用vercel及docker构建chatgpt-nex-web实现国内访问</title>
      <link href="/2024/01/31/%E4%BD%BF%E7%94%A8vercel%E5%8F%8Adocker%E6%9E%84%E5%BB%BAchatgpt-nex-web%E5%AE%9E%E7%8E%B0%E5%9B%BD%E5%86%85%E8%AE%BF%E9%97%AE/"/>
      <url>/2024/01/31/%E4%BD%BF%E7%94%A8vercel%E5%8F%8Adocker%E6%9E%84%E5%BB%BAchatgpt-nex-web%E5%AE%9E%E7%8E%B0%E5%9B%BD%E5%86%85%E8%AE%BF%E9%97%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="使用vercel及docker构建chatgpt-nex-web实现国内访问"><a href="#使用vercel及docker构建chatgpt-nex-web实现国内访问" class="headerlink" title="使用vercel及docker构建chatgpt-nex-web实现国内访问"></a>使用vercel及docker构建chatgpt-nex-web实现国内访问</h2><p>概览：</p><ul><li>需要在某宝购买openai-key</li><li>可购买直连key或中转key 如果购买的为中转key则需要填写中转服务地址</li><li><a href="https://github.com/ChatGPTNextWeb/ChatGPT-Next-Web">chatgpt-nex-web项目地址</a> 先fork到自己仓库</li><li><a href="https://vercel.com/new/clone?repository-url=https://github.com/Yidadaa/ChatGPT-Next-Web&env=OPENAI_API_KEY&env=CODE&env=GOOGLE_API_KEY&project-name=chatgpt-next-web&repository-name=ChatGPT-Next-Web">vercel部署地址</a></li></ul><p>其他类似开源项目：</p><ul><li><a href="https://lobehub.com/zh/docs/self-hosting/platform/vercel">Lobe Chat</a></li><li><a href="https://github.com/lobehub/lobe-chat">lobe chat代码仓库</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzkzODY1MTQzOQ==&mid=2247483908&idx=1&sn=b2080d845ce5f0bc0c62373876763fa9&chksm=c2fdb844f58a3152a8164dd750c28d213fbd10d27ab83afd4af88e6105e054935e8c1f095f7d&mpshare=1&scene=24&srcid=050689k9Z1fsXTKMRvZ99D8j&sharer_shareinfo=7581c54658eeb1539b7febee12f3c196&sharer_shareinfo_first=7581c54658eeb1539b7febee12f3c196#rd">lobe Chat部署教程</a></li></ul><h4 id="一-构建"><a href="#一-构建" class="headerlink" title="一. 构建"></a>一. 构建</h4><p>添加如下环境变量即可</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CODE: passwd</span><br><span class="line">BASE<span class="emphasis">_URL: https://chatapi<span class="strong">***</span></span></span><br><span class="line"><span class="strong"><span class="emphasis">OPENAI_API_KEY: sk-wD6Ha8FsvZfbpH7AD53**</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_c4148f2652bb4fe1369077b9bafea30c.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_c4148f2652bb4fe1369077b9bafea30c.png"></p><p>此时构建完成。</p><h4 id="二-docker部署"><a href="#二-docker部署" class="headerlink" title="二. docker部署"></a>二. docker部署</h4><p>镜像可选</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yidadaa/chatgpt-next-web</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:chatgpt-next-web-v2.11.3</span><br></pre></td></tr></table></figure><p>docker-compose部署</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">chatgpt-next-web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">yidadaa/chatgpt-next-web</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">chatgpt-next-web_container</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3001:3000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">OPENAI_API_KEY=sk-En7SyGK0zljZWKlT98836aD3B2Dc420c900021D943Ac41F4</span> <span class="comment"># oneapi key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CODE=Jkl123456</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PROXY_URL=http://192.168.31.163:3002</span>   <span class="comment"># oneapi地址</span></span><br></pre></td></tr></table></figure><h4 id="三-使用"><a href="#三-使用" class="headerlink" title="三. 使用"></a>三. 使用</h4><ul><li><p>若key额度不够则需要充值, 其他key使用此平台访问chatgpt需要如下操作</p></li><li><p>直连key直接填写后即可使用 自定义接口处 接口地址保留默认“/api/openai”</p></li><li><p>中转key则自定义接口处 接口地址需要填写中转服务地址</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_6f3a9535578411a50e84c4b23940099b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/2/image_6f3a9535578411a50e84c4b23940099b.png"></p></li></ul><p>lobechat效果</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_83095fcea8d81d4ab7cfba1b69f2bd33.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/5/image_83095fcea8d81d4ab7cfba1b69f2bd33.png"></p><p>建议使用cloudfare给vercel绑定域名访问。</p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>公有云私有云对象桶信息配置</title>
      <link href="/2024/01/29/%E5%85%AC%E6%9C%89%E4%BA%91%E7%A7%81%E6%9C%89%E4%BA%91%E5%AF%B9%E8%B1%A1%E6%A1%B6%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE/"/>
      <url>/2024/01/29/%E5%85%AC%E6%9C%89%E4%BA%91%E7%A7%81%E6%9C%89%E4%BA%91%E5%AF%B9%E8%B1%A1%E6%A1%B6%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="公有云私有云对象桶信息配置"><a href="#公有云私有云对象桶信息配置" class="headerlink" title="公有云私有云对象桶信息配置"></a>公有云私有云对象桶信息配置</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>公有云与私有云配置对象桶信息是有差异的</p><h3 id="一-公有云-阿里云为例"><a href="#一-公有云-阿里云为例" class="headerlink" title="一. 公有云-阿里云为例"></a>一. 公有云-阿里云为例</h3><p>使用软件<strong>s3cmd</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装s3cmd</span></span><br><span class="line">yum install -y epel-release &amp;&amp; yum install -y s3cmd</span><br><span class="line"><span class="comment"># 安装qemu</span></span><br><span class="line">yum install qemu-kvm libvirt virt-install bridge-utils  -y</span><br></pre></td></tr></table></figure><p>其他安装方式（ubuntu）</p><p><a href="https://developer.aliyun.com/article/356106">https://developer.aliyun.com/article/356106</a><br><a href="https://www.s3express.com/download.htm">https://www.s3express.com/download.htm</a>    （s3软件下载链接）</p><p>简介：<br><a href="https://wangyan.org/blog/s3cmd-how-to-use.html">https://wangyan.org/blog/s3cmd-how-to-use.html</a></p><p>s3cmd 安装使用指南<br>s3cmd 是一款 Amazon S3 命令行工具。它不仅能上传、下载、同步，还能设置权限，下面是完整的安装使用指南。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">一、安装方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法一：（Debian/Ubuntu ）</span></span><br><span class="line"><span class="string">wget</span> <span class="string">-O-</span> <span class="string">-q</span> <span class="string">http://s3tools.org/repo/deb-all/stable/s3tools.key</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">apt-key</span> <span class="string">add</span> <span class="bullet">-</span></span><br><span class="line"><span class="string">wget</span> <span class="string">-O/etc/apt/sources.list.d/s3tools.list</span> <span class="string">http://s3tools.org/repo/deb-all/stable/s3tools.list</span></span><br><span class="line"><span class="string">apt-get</span> <span class="string">update</span> <span class="string">&amp;&amp;</span> <span class="string">sudo</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="string">s3cmd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二：</span></span><br><span class="line"><span class="string">wget</span> <span class="string">http://nchc.dl.sourceforge.net/project/s3tools/s3cmd/1.0.0/s3cmd-1.0.0.tar.gz</span></span><br><span class="line"><span class="string">tar</span> <span class="string">-zxf</span> <span class="string">s3cmd-1.0.0.tar.gz</span> <span class="string">-C</span> <span class="string">/usr/local/</span></span><br><span class="line"><span class="string">mv</span> <span class="string">/usr/local/s3cmd-1.0.0/</span> <span class="string">/usr/local/s3cmd/</span></span><br><span class="line"><span class="string">ln</span> <span class="string">-s</span> <span class="string">/usr/local/s3cmd/s3cmd</span> <span class="string">/usr/bin/s3cmd</span></span><br></pre></td></tr></table></figure><p>阿里云配置如下</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_896f06a76b5634cec9f24ce6f7ec5119.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_896f06a76b5634cec9f24ce6f7ec5119.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化s3cmd</span></span><br><span class="line">s3cmd --configure</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行</span></span><br><span class="line">[root@3z6to251zh02kg system]# s3cmd --configure</span><br><span class="line"></span><br><span class="line">Enter new values or accept defaults in brackets with Enter.</span><br><span class="line">Refer to user manual for detailed description of all options.</span><br><span class="line"></span><br><span class="line">Access key and Secret key are your identifiers for Amazon S3. Leave them empty for using the env variables.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Access Key: LTAI5t9</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Secret Key: XD0f6iyM0nY8oUJZz</span></span><br><span class="line">Default Region [US]:  # hangzhou</span><br><span class="line"></span><br><span class="line">Use &quot;s3.amazonaws.com&quot; for S3 Endpoint and not modify it to the target Amazon S3.</span><br><span class="line">S3 Endpoint [s3.amazonaws.com]: # oss-cn-hangzhou.aliyuncs.com （buckets域名在阿里云oss概览中查看）</span><br><span class="line"></span><br><span class="line">Use &quot;%(bucket)s.s3.amazonaws.com&quot; to the target Amazon S3. &quot;%(bucket)s&quot; and &quot;%(location)s&quot; vars can be used</span><br><span class="line">if the target S3 system supports dns based buckets.</span><br><span class="line">DNS-style bucket+hostname:port template for accessing a bucket [%(bucket)s.s3.amazonaws.com]: # %(bucket)s.oss-cn-hangzhou.aliyuncs.com</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">%(bucket)s.oss-cn-hangzhou.aliyuncs.com</span></span><br><span class="line">Encryption password is used to protect your files from reading</span><br><span class="line">by unauthorized persons while in transfer to S3</span><br><span class="line">Encryption password: </span><br><span class="line">Path to GPG program [/bin/gpg]: </span><br><span class="line"></span><br><span class="line">When using secure HTTPS protocol all communication with Amazon S3</span><br><span class="line">servers is protected from 3rd party eavesdropping. This method is</span><br><span class="line">slower than plain HTTP, and can only be proxied with Python 2.7 or newer</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Use HTTPS protocol [Yes]: Yes</span></span><br><span class="line"></span><br><span class="line">On some networks all internet access must go through a HTTP proxy.</span><br><span class="line">Try setting it here if you can&#x27;t connect to S3 directly</span><br><span class="line">HTTP Proxy server name: </span><br><span class="line"></span><br><span class="line">New settings:</span><br><span class="line">  Access Key: LTAI5t9EwR</span><br><span class="line">  Secret Key: XD0f6iyM0nJZz1</span><br><span class="line">  Default Region: hangzhou</span><br><span class="line">  S3 Endpoint: oss-cn-hangzhou.aliyuncs.com</span><br><span class="line">  DNS-style bucket+hostname:port template for accessing a bucket: %(bucket)s.oss-cn-hangzhou.aliyuncs.com</span><br><span class="line">  Encryption password: </span><br><span class="line">  Path to GPG program: /bin/gpg</span><br><span class="line">  Use HTTPS protocol: True</span><br><span class="line">  HTTP Proxy server name: </span><br><span class="line">  HTTP Proxy server port: 0</span><br><span class="line"></span><br><span class="line">Test access with supplied credentials? [Y/n] y</span><br><span class="line">Please wait, attempting to list all buckets...</span><br><span class="line">Success. Your access key and secret key worked fine :-)</span><br><span class="line"></span><br><span class="line">Now verifying that encryption works...</span><br><span class="line">Not configured. Never mind.</span><br><span class="line"></span><br><span class="line">Save settings? [y/N] y</span><br><span class="line">Configuration saved to &#x27;/root/.s3cfg&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此时设置完成</span></span><br></pre></td></tr></table></figure><p>客户端连接软件配置</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_69abbafcc46e7ce35928521f13a67e58.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_69abbafcc46e7ce35928521f13a67e58.png"></p><p>此时即可访问阿里云对象存储。</p><h3 id="二-私有云-某云配置"><a href="#二-私有云-某云配置" class="headerlink" title="二. 私有云 某云配置"></a>二. 私有云 某云配置</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 创建buckets报错：原因版本不一致 需要将v2启用</span></span><br><span class="line">解决：</span><br><span class="line">vim /root/.s3cfg</span><br><span class="line">signature<span class="emphasis">_v2 = True </span></span><br><span class="line"><span class="emphasis"># 或新建文件输入：</span></span><br><span class="line"><span class="emphasis">vim ~/.s3cfg</span></span><br><span class="line"><span class="emphasis">[default]</span></span><br><span class="line"><span class="emphasis">access_</span>key = 914c4</span><br><span class="line">secret<span class="emphasis">_key = qk45WMQg5VP4MBeAYE</span></span><br><span class="line"><span class="emphasis">host_</span>base = http://111.111.87.99:7480</span><br><span class="line">host<span class="emphasis">_bucket = http://111.111.87.99:7480/914c48814</span></span><br><span class="line"><span class="emphasis">use_</span>https = False</span><br><span class="line">signature<span class="emphasis">_v2 = True </span></span><br></pre></td></tr></table></figure><h3 id="三-扩展s3cmd命令使用"><a href="#三-扩展s3cmd命令使用" class="headerlink" title="三. 扩展s3cmd命令使用"></a>三. 扩展<code>s3cmd</code>命令使用</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 命令使用</span></span><br><span class="line"><span class="section">#创建bucket名称为s3://cem-demo</span></span><br><span class="line">s3cmd -h                                            # 查看命令详情</span><br><span class="line">s3cmd put /etc/fstab  s3://s3cmd-demo/fstab-demo    # 上传文件将/etc目录下文件fstab上传</span><br><span class="line">s3cmd ls s3://ceph-s3-bucket                        # 查看bucket里面有什么查看具体内容后面接目录</span><br><span class="line">s3cmd put /etc s3://ceph-s3-bucket/fstab-demo/etc/ --recursive # 上传目录（递归的方式记得&quot;/&quot;）</span><br><span class="line">s3cmd get s3://ceph-s3-bucket/s3browser-6-4-1.rar              # 下载命令</span><br><span class="line"></span><br><span class="line">s3cmd rm s3://ceph-s3-bucket/fstab-demo                        # 删除文件命令</span><br><span class="line">s3cmd rm s3://ceph-s3-bucket/fstab-demo/ --recursive           # 删除目录命令</span><br><span class="line">s3cmd mb s3://cmd-demo                                         # 创建目录</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos设置登陆密码验证错误自动锁定</title>
      <link href="/2024/01/28/centos%E8%AE%BE%E7%BD%AE%E7%99%BB%E9%99%86%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81%E9%94%99%E8%AF%AF%E8%87%AA%E5%8A%A8%E9%94%81%E5%AE%9A/"/>
      <url>/2024/01/28/centos%E8%AE%BE%E7%BD%AE%E7%99%BB%E9%99%86%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81%E9%94%99%E8%AF%AF%E8%87%AA%E5%8A%A8%E9%94%81%E5%AE%9A/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>centos设置登陆密码验证错误自动锁定</strong></p><p>参考：</p><p><a href="https://blog.csdn.net/weixin_43822878/article/details/93018223">Linux限制远程登录尝试密码次数及锁定时间_linux ssh连接5次封ip1小时-CSDN博客</a></p><p>CentOS中有一个pam_tally2.so的PAM模块，来限定用户的登录失败次数，如果次数达到设置的阈值，则锁定用户。</p><h3 id="一-system-auth设置登陆错误锁定（本教程使用此优化配置）"><a href="#一-system-auth设置登陆错误锁定（本教程使用此优化配置）" class="headerlink" title="一. system-auth设置登陆错误锁定（本教程使用此优化配置）"></a>一. system-auth设置登陆错误锁定（本教程使用此优化配置）</h3><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_7a31d3176074dee91ac4da1d3a07e168.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_7a31d3176074dee91ac4da1d3a07e168.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/pam.d/system-auth</span><br><span class="line"><span class="comment"># 配置如下</span></span><br><span class="line"><span class="comment">#%PAM-1.0</span></span><br><span class="line"><span class="comment"># This file is auto-generated.</span></span><br><span class="line"><span class="comment"># User changes will be destroyed the next time authconfig is run.</span></span><br><span class="line">auth       required       pam_tally2.so    deny=3    unlock_time=10 even_deny_root root_unlock_time=10</span><br><span class="line">auth        required      pam_env.so</span><br><span class="line">auth        required      pam_faildelay.so delay=2000000</span><br><span class="line">auth        sufficient    pam_unix.so nullok try_first_pass</span><br><span class="line">auth        requisite     pam_succeed_if.so uid &gt;= 1000 quiet_success</span><br><span class="line">auth        required      pam_deny.so</span><br><span class="line"></span><br><span class="line">account     required      pam_unix.so</span><br><span class="line">account     sufficient    pam_localuser.so</span><br><span class="line">account     sufficient    pam_succeed_if.so uid &lt; 1000 quiet</span><br><span class="line">account     required      pam_permit.so</span><br><span class="line"></span><br><span class="line">password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=</span><br><span class="line">password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok</span><br><span class="line">password    required      pam_deny.so</span><br><span class="line"></span><br><span class="line">session     optional      pam_keyinit.so revoke</span><br><span class="line">session     required      pam_limits.so</span><br><span class="line">-session     optional      pam_systemd.so</span><br><span class="line">session     [success=1 default=ignore] pam_succeed_if.so service <span class="keyword">in</span> crond quiet use_uid</span><br><span class="line">session     required      pam_unix.so</span><br></pre></td></tr></table></figure><p>参数解释：</p><p>添加参数介绍：设置密码尝试错误三次，普通用户和root用户都进行锁定，普通用户锁定10秒，root用户锁定10秒</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth       required       pam_tally2.so    deny=3    unlock_time=10 even_deny_root root_unlock_time=10</span><br></pre></td></tr></table></figure><h3 id="二-下方为其他配置项内容"><a href="#二-下方为其他配置项内容" class="headerlink" title="二. 下方为其他配置项内容"></a>二. 下方为其他配置项内容</h3><h4 id="1、编译PAM的配置文件"><a href="#1、编译PAM的配置文件" class="headerlink" title="1、编译PAM的配置文件"></a>1、编译PAM的配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~ ]<span class="comment"># vim /etc/pam.d/login</span></span><br><span class="line"><span class="comment">#%PAM-1.0</span></span><br><span class="line">auth    required    pam_tally2.so    deny=3    unlock_time=100 even_deny_root root_unlock_time=200</span><br><span class="line">auth [user_unknown=ignore success=ok ignore=ignore default=bad] pam_securetty.so</span><br><span class="line">auth       substack     system-auth</span><br><span class="line">auth       include      postlogin</span><br><span class="line">account    required     pam_nologin.so</span><br><span class="line">account    include      system-auth</span><br><span class="line">password   include      system-auth</span><br><span class="line"><span class="comment"># pam_selinux.so close should be the first session rule</span></span><br><span class="line">session    required     pam_selinux.so close</span><br><span class="line">session    required     pam_loginuid.so</span><br><span class="line">session    optional     pam_console.so</span><br><span class="line"><span class="comment"># pam_selinux.so open should only be followed by sessions to be executed in the user context</span></span><br><span class="line">session    required     pam_selinux.so open</span><br><span class="line">session    required     pam_namespace.so</span><br><span class="line">session    optional     pam_keyinit.so force revoke</span><br><span class="line">session    include      system-auth</span><br><span class="line">session    include      postlogin</span><br><span class="line">-session   optional     pam_ck_connector.so</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>各参数介绍：</p><blockquote><p>even_deny_root     也限制root用户；<br>deny                      设置普通用户和root用户连续错误登陆的最大次数，超过最大次数，则锁定该用户<br>unlock_time          设定普通用户锁定后，多少时间后解锁，单位是秒；<br>root_unlock_time  设定root用户锁定后，多少时间后解锁，单位是秒；<br>此处使用的是 pam_tally2 模块，如果不支持 pam_tally2 可以使用 pam_tally 模块。另外，不同的pam版本，设置可能有所不同，具体使用方法，可以参照相关模块的使用规则。</p></blockquote><p>在#%PAM-1.0的下面，即第二行，添加内容，一定要写在前面，如果写在后面，虽然用户被锁定，但是只要用户输入正确的密码，还是可以登录的！</p><p>添加参数介绍：设置密码尝试错误三次，普通用户和root用户都进行锁定，普通用户锁定100秒，root用户锁定200秒</p><p><strong>/etc/pam.d/login</strong> —最终配置图：</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_b79029648b226f7ff2cca46a85548223.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_b79029648b226f7ff2cca46a85548223.png"></p><h4 id="2、这个只是限制了用户从tty登录，而没有限制远程登录，如果想限制远程登录，需要改sshd文件"><a href="#2、这个只是限制了用户从tty登录，而没有限制远程登录，如果想限制远程登录，需要改sshd文件" class="headerlink" title="2、这个只是限制了用户从tty登录，而没有限制远程登录，如果想限制远程登录，需要改sshd文件"></a>2、这个只是限制了用户从tty登录，而没有限制远程登录，如果想限制远程登录，需要改sshd文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~ ]<span class="comment"># vim /etc/pam.d/sshd</span></span><br><span class="line"><span class="comment">#%PAM-1.0</span></span><br><span class="line">auth    required    pam_tally2.so    deny=3    unlock_time=100 even_deny_root root_unlock_time=200</span><br><span class="line">auth       required     pam_sepermit.so</span><br><span class="line">auth       substack     password-auth</span><br><span class="line">auth       include      postlogin</span><br><span class="line"><span class="comment"># Used with polkit to reauthorize users in remote sessions</span></span><br><span class="line">-auth      optional     pam_reauthorize.so prepare</span><br><span class="line">account    required     pam_nologin.so</span><br><span class="line">account    include      password-auth</span><br><span class="line">password   include      password-auth</span><br><span class="line"><span class="comment"># pam_selinux.so close should be the first session rule</span></span><br><span class="line">session    required     pam_selinux.so close</span><br><span class="line">session    required     pam_loginuid.so</span><br><span class="line"><span class="comment"># pam_selinux.so open should only be followed by sessions to be executed in the user context</span></span><br><span class="line">session    required     pam_selinux.so open env_params</span><br><span class="line">session    required     pam_namespace.so</span><br><span class="line">session    optional     pam_keyinit.so force revoke</span><br><span class="line">session    include      password-auth</span><br><span class="line">session    include      postlogin</span><br><span class="line"><span class="comment"># Used with polkit to reauthorize users in remote sessions</span></span><br><span class="line">-session   optional     pam_reauthorize.so prepare</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>同样是增加在第2行！</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_5dbaaaaf8233e87db4cc63de60cab88b.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_5dbaaaaf8233e87db4cc63de60cab88b.png"></p><p>查看用户登录失败的次数:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~ ]<span class="comment"># pam_tally2 --user</span></span><br><span class="line">Login           Failures Latest failure     From</span><br><span class="line">aihuidi             6    06/20/19 10:11:07  192.168.200.186    在186这个ip上有个普通用户aihuidi登录失败</span><br></pre></td></tr></table></figure><p>解锁指定用户:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~ ]<span class="comment"># pam_tally2 -r -u aihuidi    解锁aihuidi用户</span></span><br><span class="line">Login           Failures Latest failure     From</span><br><span class="line">aihuidi             6    06/20/19 10:11:07  192.168.200.186</span><br><span class="line">[root@node2 ~ ]<span class="comment"># pam_tally2 --user     在进行查看用户登录失败次数</span></span><br><span class="line">[root@node2 ~ ]<span class="comment"># </span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ps：这个远程ssh的时候，输入密码错误超过三次但是没有提示，我用的是Xshell，不知道其它终端有没有提示，但是只要超过设定的值，输入正确的密码也是登陆不了的！，还是要等到设定的时间在重新尝试输入正确密码进行登录认证</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>魔改笔记四：hexo小猫咪与漫画导航</title>
      <link href="/2024/01/26/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E5%9B%9B%EF%BC%9Ahexo%E5%B0%8F%E7%8C%AB%E5%92%AA%E4%B8%8E%E6%BC%AB%E7%94%BB%E5%AF%BC%E8%88%AA/"/>
      <url>/2024/01/26/%E9%AD%94%E6%94%B9%E7%AC%94%E8%AE%B0%E5%9B%9B%EF%BC%9Ahexo%E5%B0%8F%E7%8C%AB%E5%92%AA%E4%B8%8E%E6%BC%AB%E7%94%BB%E5%AF%BC%E8%88%AA/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="魔改笔记四：hexo小猫咪与漫画导航"><a href="#魔改笔记四：hexo小猫咪与漫画导航" class="headerlink" title="魔改笔记四：hexo小猫咪与漫画导航"></a>魔改笔记四：hexo小猫咪与漫画导航</h4><p>详见：<a href="https://tzy1997.com/articles/hexo1613/">请收下这只可爱的猫咪吧</a><br>详见：<a href="https://www.fomal.cc/posts/5389e93f.html">漫画导航</a></p><h3 id="一-小猫咪"><a href="#一-小猫咪" class="headerlink" title="一. 小猫咪"></a>一. 小猫咪</h3><p>制作一个盛放内容的盒子，在<code>[BlogRoot]/node_modules/hexo-theme-butterfly/layout/includes/head.pug</code>(如果是<code>git clone</code> 安装在<code>[BlogRoot]/themes/butterfly/layout/includes/head.pug</code>)最后一行加入如下代码：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">#myscoll</span></span><br></pre></td></tr></table></figure><p>其实随便放在哪里都行，只要能加载出来就行</p><p>在<code>[BlogRoot]/node_modules/hexo-theme-butterfly/source/js</code>文件夹下新建一个<code>cat.js</code>，将以下代码复制到文件中。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">clientWidth</span> &gt; <span class="number">992</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getBasicInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">/* 窗口高度 */</span></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">ViewH</span> = $(<span class="variable language_">window</span>).<span class="title function_">height</span>();</span><br><span class="line">        <span class="comment">/* document高度 */</span></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">DocH</span> = $(<span class="string">&quot;body&quot;</span>)[<span class="number">0</span>].<span class="property">scrollHeight</span>;</span><br><span class="line">        <span class="comment">/* 滚动的高度 */</span></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">ScrollTop</span> = $(<span class="variable language_">window</span>).<span class="title function_">scrollTop</span>();</span><br><span class="line">        <span class="comment">/* 可滚动的高度 */</span></span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">S_V</span> = <span class="title class_">DocH</span> - <span class="title class_">ViewH</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Band</span>_H = <span class="title class_">ScrollTop</span> / (<span class="title class_">DocH</span> - <span class="title class_">ViewH</span>) * <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="title class_">ViewH</span>: <span class="title class_">ViewH</span>,</span><br><span class="line">            <span class="title class_">DocH</span>: <span class="title class_">DocH</span>,</span><br><span class="line">            <span class="title class_">ScrollTop</span>: <span class="title class_">ScrollTop</span>,</span><br><span class="line">            <span class="title class_">Band</span><span class="attr">_H</span>: <span class="title class_">Band</span>_H,</span><br><span class="line">            <span class="attr">S_V</span>: <span class="variable constant_">S_V</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">show</span>(<span class="params">basicInfo</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (basicInfo.<span class="property">ScrollTop</span> &gt; <span class="number">0.001</span>) &#123;</span><br><span class="line">            $(<span class="string">&quot;.neko&quot;</span>).<span class="title function_">css</span>(<span class="string">&#x27;display&#x27;</span>, <span class="string">&#x27;block&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $(<span class="string">&quot;.neko&quot;</span>).<span class="title function_">css</span>(<span class="string">&#x27;display&#x27;</span>, <span class="string">&#x27;none&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    (<span class="keyword">function</span> (<span class="params">$</span>) &#123;</span><br><span class="line">        $.fn.<span class="property">nekoScroll</span> = <span class="keyword">function</span> (<span class="params">option</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> defaultSetting = &#123;</span><br><span class="line">                <span class="attr">top</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">                <span class="attr">scroWidth</span>: <span class="number">6</span> + <span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">                <span class="attr">z_index</span>: <span class="number">9999</span>,</span><br><span class="line">                <span class="attr">zoom</span>: <span class="number">0.9</span>,</span><br><span class="line">                <span class="attr">borderRadius</span>: <span class="number">5</span> + <span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">                <span class="attr">right</span>: <span class="number">60</span> + <span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">                <span class="comment">// 这里可以换为你喜欢的图片，例如我就换为了雪人，但是要抠图</span></span><br><span class="line">                <span class="attr">nekoImg</span>: <span class="string">&quot;https://bu.dusays.com/2022/07/20/62d812db74be9.png&quot;</span>,</span><br><span class="line">                <span class="attr">hoverMsg</span>: <span class="string">&quot;喵喵喵~&quot;</span>,</span><br><span class="line">                <span class="attr">color</span>: <span class="string">&quot;#6f42c1&quot;</span>,</span><br><span class="line">                <span class="attr">during</span>: <span class="number">500</span>,</span><br><span class="line">                <span class="attr">blog_body</span>: <span class="string">&quot;body&quot;</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">var</span> setting = $.<span class="title function_">extend</span>(defaultSetting, option);</span><br><span class="line">            <span class="keyword">var</span> getThis = <span class="variable language_">this</span>.<span class="title function_">prop</span>(<span class="string">&quot;className&quot;</span>) !== <span class="string">&quot;&quot;</span> ? <span class="string">&quot;.&quot;</span> + <span class="variable language_">this</span>.<span class="title function_">prop</span>(<span class="string">&quot;className&quot;</span>) : <span class="variable language_">this</span>.<span class="title function_">prop</span>(<span class="string">&quot;id&quot;</span>) !== <span class="string">&quot;&quot;</span> ? <span class="string">&quot;#&quot;</span> +</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">prop</span>(<span class="string">&quot;id&quot;</span>) : <span class="variable language_">this</span>.<span class="title function_">prop</span>(<span class="string">&quot;nodeName&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ($(<span class="string">&quot;.neko&quot;</span>).<span class="property">length</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">after</span>(<span class="string">&quot;&lt;div class=\&quot;neko\&quot; id=&quot;</span> + setting.<span class="property">nekoname</span> + <span class="string">&quot; data-msg=\&quot;&quot;</span> + setting.<span class="property">hoverMsg</span> + <span class="string">&quot;\&quot;&gt;&lt;/div&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> basicInfo = <span class="title function_">getBasicInfo</span>();</span><br><span class="line">            $(getThis)</span><br><span class="line">                .<span class="title function_">css</span>(&#123;</span><br><span class="line">                    <span class="string">&#x27;position&#x27;</span>: <span class="string">&#x27;fixed&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;width&#x27;</span>: setting.<span class="property">scroWidth</span>,</span><br><span class="line">                    <span class="string">&#x27;top&#x27;</span>: setting.<span class="property">top</span>,</span><br><span class="line">                    <span class="string">&#x27;height&#x27;</span>: basicInfo.<span class="property">Band_H</span> * setting.<span class="property">zoom</span> * basicInfo.<span class="property">ViewH</span> * <span class="number">0.01</span> + <span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;z-index&#x27;</span>: setting.<span class="property">z_index</span>,</span><br><span class="line">                    <span class="string">&#x27;background-color&#x27;</span>: setting.<span class="property">bgcolor</span>,</span><br><span class="line">                    <span class="string">&quot;border-radius&quot;</span>: setting.<span class="property">borderRadius</span>,</span><br><span class="line">                    <span class="string">&#x27;right&#x27;</span>: setting.<span class="property">right</span>,</span><br><span class="line">                    <span class="string">&#x27;background-image&#x27;</span>: <span class="string">&#x27;url(&#x27;</span> + setting.<span class="property">scImg</span> + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;background-image&#x27;</span>: <span class="string">&#x27;-webkit-linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.1) 75%, transparent 75%, transparent)&#x27;</span>, <span class="string">&#x27;border-radius&#x27;</span>: <span class="string">&#x27;2em&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;background-size&#x27;</span>: <span class="string">&#x27;contain&#x27;</span></span><br><span class="line">                &#125;);</span><br><span class="line">            $(<span class="string">&quot;#&quot;</span> + setting.<span class="property">nekoname</span>)</span><br><span class="line">                .<span class="title function_">css</span>(&#123;</span><br><span class="line">                    <span class="string">&#x27;position&#x27;</span>: <span class="string">&#x27;fixed&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;top&#x27;</span>: basicInfo.<span class="property">Band_H</span> * setting.<span class="property">zoom</span> * basicInfo.<span class="property">ViewH</span> * <span class="number">0.01</span> - <span class="number">50</span> + <span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;z-index&#x27;</span>: setting.<span class="property">z_index</span> * <span class="number">10</span>,</span><br><span class="line">                    <span class="string">&#x27;right&#x27;</span>: setting.<span class="property">right</span>,</span><br><span class="line">                    <span class="string">&#x27;background-image&#x27;</span>: <span class="string">&#x27;url(&#x27;</span> + setting.<span class="property">nekoImg</span> + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            <span class="title function_">show</span>(<span class="title function_">getBasicInfo</span>());</span><br><span class="line">            $(<span class="variable language_">window</span>)</span><br><span class="line">                .<span class="title function_">scroll</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> basicInfo = <span class="title function_">getBasicInfo</span>();</span><br><span class="line">                    <span class="title function_">show</span>(basicInfo);</span><br><span class="line">                    $(getThis)</span><br><span class="line">                        .<span class="title function_">css</span>(&#123;</span><br><span class="line">                            <span class="string">&#x27;position&#x27;</span>: <span class="string">&#x27;fixed&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;width&#x27;</span>: setting.<span class="property">scroWidth</span>,</span><br><span class="line">                            <span class="string">&#x27;top&#x27;</span>: setting.<span class="property">top</span>,</span><br><span class="line">                            <span class="string">&#x27;height&#x27;</span>: basicInfo.<span class="property">Band_H</span> * setting.<span class="property">zoom</span> * basicInfo.<span class="property">ViewH</span> * <span class="number">0.01</span> + <span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;z-index&#x27;</span>: setting.<span class="property">z_index</span>,</span><br><span class="line">                            <span class="string">&#x27;background-color&#x27;</span>: setting.<span class="property">bgcolor</span>,</span><br><span class="line">                            <span class="string">&quot;border-radius&quot;</span>: setting.<span class="property">borderRadius</span>,</span><br><span class="line">                            <span class="string">&#x27;right&#x27;</span>: setting.<span class="property">right</span>,</span><br><span class="line">                            <span class="string">&#x27;background-image&#x27;</span>: <span class="string">&#x27;url(&#x27;</span> + setting.<span class="property">scImg</span> + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;background-image&#x27;</span>: <span class="string">&#x27;-webkit-linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.1) 75%, transparent 75%, transparent)&#x27;</span>, <span class="string">&#x27;border-radius&#x27;</span>: <span class="string">&#x27;2em&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;background-size&#x27;</span>: <span class="string">&#x27;contain&#x27;</span></span><br><span class="line">                        &#125;);</span><br><span class="line">                    $(<span class="string">&quot;#&quot;</span> + setting.<span class="property">nekoname</span>)</span><br><span class="line">                        .<span class="title function_">css</span>(&#123;</span><br><span class="line">                            <span class="string">&#x27;position&#x27;</span>: <span class="string">&#x27;fixed&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;top&#x27;</span>: basicInfo.<span class="property">Band_H</span> * setting.<span class="property">zoom</span> * basicInfo.<span class="property">ViewH</span> * <span class="number">0.01</span> - <span class="number">50</span> + <span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;z-index&#x27;</span>: setting.<span class="property">z_index</span> * <span class="number">10</span>,</span><br><span class="line">                            <span class="string">&#x27;right&#x27;</span>: setting.<span class="property">right</span>,</span><br><span class="line">                            <span class="string">&#x27;background-image&#x27;</span>: <span class="string">&#x27;url(&#x27;</span> + setting.<span class="property">nekoImg</span> + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">                        &#125;);</span><br><span class="line">                    <span class="keyword">if</span> (basicInfo.<span class="property">ScrollTop</span> == basicInfo.<span class="property">S_V</span>) &#123;</span><br><span class="line">                        $(<span class="string">&quot;#&quot;</span> + setting.<span class="property">nekoname</span>)</span><br><span class="line">                            .<span class="title function_">addClass</span>(<span class="string">&quot;showMsg&quot;</span>)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        $(<span class="string">&quot;#&quot;</span> + setting.<span class="property">nekoname</span>)</span><br><span class="line">                            .<span class="title function_">removeClass</span>(<span class="string">&quot;showMsg&quot;</span>);</span><br><span class="line">                        $(<span class="string">&quot;#&quot;</span> + setting.<span class="property">nekoname</span>)</span><br><span class="line">                            .<span class="title function_">attr</span>(<span class="string">&quot;data-msg&quot;</span>, setting.<span class="property">hoverMsg</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">                btf.<span class="title function_">scrollToDest</span>(<span class="number">0</span>, <span class="number">500</span>)</span><br><span class="line">            &#125;);</span><br><span class="line">            $(<span class="string">&quot;#&quot;</span> + setting.<span class="property">nekoname</span>)</span><br><span class="line">                .<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    btf.<span class="title function_">scrollToDest</span>(<span class="number">0</span>, <span class="number">500</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)(jQuery);</span><br><span class="line"></span><br><span class="line">    $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//部分自定义</span></span><br><span class="line">        $(<span class="string">&quot;#myscoll&quot;</span>).<span class="title function_">nekoScroll</span>(&#123;</span><br><span class="line">            <span class="attr">bgcolor</span>: <span class="string">&#x27;rgb(0 0 0 / .5)&#x27;</span>, <span class="comment">//背景颜色，没有绳子背景图片时有效</span></span><br><span class="line">            <span class="attr">borderRadius</span>: <span class="string">&#x27;2em&#x27;</span>,</span><br><span class="line">            <span class="attr">zoom</span>: <span class="number">0.9</span></span><br><span class="line">        &#125;</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//自定义（去掉以下注释，并注释掉其他的查看效果）</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        $(&quot;#myscoll&quot;).nekoScroll(&#123;</span></span><br><span class="line"><span class="comment">            nekoname:&#x27;neko1&#x27;, //nekoname，相当于id</span></span><br><span class="line"><span class="comment">            nekoImg:&#x27;img/猫咪.png&#x27;, //neko的背景图片</span></span><br><span class="line"><span class="comment">            scImg:&quot;img/绳1.png&quot;, //绳子的背景图片</span></span><br><span class="line"><span class="comment">            bgcolor:&#x27;#1e90ff&#x27;, //背景颜色，没有绳子背景图片时有效</span></span><br><span class="line"><span class="comment">            zoom:0.9, //绳子长度的缩放值</span></span><br><span class="line"><span class="comment">            hoverMsg:&#x27;你好~喵&#x27;, //鼠标浮动到neko上方的对话框信息</span></span><br><span class="line"><span class="comment">            right:&#x27;100px&#x27;, //距离页面右边的距离</span></span><br><span class="line"><span class="comment">            fontFamily:&#x27;楷体&#x27;, //对话框字体</span></span><br><span class="line"><span class="comment">            fontSize:&#x27;14px&#x27;, //对话框字体的大小</span></span><br><span class="line"><span class="comment">            color:&#x27;#1e90ff&#x27;, //对话框字体颜色</span></span><br><span class="line"><span class="comment">            scroWidth:&#x27;8px&#x27;, //绳子的宽度</span></span><br><span class="line"><span class="comment">            z_index:100, //不用解释了吧</span></span><br><span class="line"><span class="comment">            during:1200, //从顶部到底部滑动的时长</span></span><br><span class="line"><span class="comment">        &#125;);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>[BlogRoot]/node_modules/hexo-theme-butterfly/source/css</code>文件夹下新建一个<code>cat.css</code>，将以下代码复制到文件中。当然你也可以选择不新建 css 文件，复制代码到<code>custom.css</code>也行，总之有地方引入就行。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">body</span>::-webkit-scrollbar &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.neko</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">64px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">64px</span>;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;https://bu.dusays.com/2022/07/20/62d812db74be9.png&quot;</span>);</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">32px</span>;</span><br><span class="line">    <span class="attribute">background-repeat</span>: no-repeat;</span><br><span class="line">    <span class="attribute">background-size</span>: contain;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateX</span>(<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">font-family</span>: tzy;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">600</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#6f42c1</span>;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.neko</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;https://bu.dusays.com/2022/07/20/62d812d95e6f5.png&quot;</span>);</span><br><span class="line">    <span class="attribute">background-size</span>: contain;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">9999</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">top</span>: -<span class="number">115%</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.neko</span><span class="selector-class">.showMsg</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="built_in">attr</span>(data-msg);</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.neko</span><span class="selector-pseudo">:hover</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="built_in">attr</span>(data-msg);</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.neko</span><span class="selector-class">.fontColor</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description: 滚动条样式  跟猫二选一</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>:<span class="number">992px</span>) &#123;</span><br><span class="line">    ::-webkit-scrollbar &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">8px</span> <span class="meta">!important</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">8px</span> <span class="meta">!important</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ::-webkit-scrollbar-track &#123;</span><br><span class="line">        <span class="attribute">border-radius</span>: <span class="number">2em</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ::-webkit-scrollbar-thumb &#123;</span><br><span class="line">        <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">255</span> <span class="number">255</span> <span class="number">255</span> / .<span class="number">3</span>);</span><br><span class="line">        <span class="attribute">background-image</span>: <span class="built_in">-webkit-linear-gradient</span>(<span class="number">45deg</span>, <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>) <span class="number">25%</span>, transparent <span class="number">25%</span>, transparent <span class="number">50%</span>, <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>) <span class="number">50%</span>, <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>) <span class="number">75%</span>, transparent <span class="number">75%</span>, transparent);</span><br><span class="line">        <span class="attribute">border-radius</span>: <span class="number">2em</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ::-webkit-scrollbar-corner &#123;</span><br><span class="line">        <span class="attribute">background-color</span>: transparent</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在主题配置文件<code>_config.butterfly.yml</code>中引入<code>cat.js</code>和<code>cat.css</code>，当然还有在bottom的最前面引入<code>jQuery</code>，因为<code>cat.js</code>的语法依赖<code>jQuery</code>。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inject:</span></span><br><span class="line">  <span class="attr">head:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;link</span> <span class="string">rel=&quot;stylesheet&quot;</span> <span class="string">href=&quot;/css/cat.css&quot;&gt;</span></span><br><span class="line">  <span class="attr">bottom:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;script</span> <span class="string">defer</span> <span class="string">src=&quot;https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;script</span> <span class="string">defer</span> <span class="string">data-pjax</span> <span class="string">src=&quot;/js/cat.js&quot;&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure><p>最后重新编译运行即可看见效果。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo cl; hexo s</span><br></pre></td></tr></table></figure><h3 id="二-漫画导航"><a href="#二-漫画导航" class="headerlink" title="二. 漫画导航"></a>二. 漫画导航</h3><p>选择喜欢的图标 添加到项目 在<a href="https://www.iconfont.cn/">阿里云图标库</a></p><p>在<code>[BlogRoot]\themes\butterfly\source\css\custom.css</code>中填写如下内容，引入Unicode和Font-class的线上资源：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">@import</span> <span class="string">&quot;//at.alicdn.com/t/c/font_4426032_sy4sytzuoj9.css&quot;</span><span class="string">;</span></span><br></pre></td></tr></table></figure><p>更推荐在在主题配置文件<code>inject</code>配置项进行全局引入：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inject:</span></span><br><span class="line">  <span class="attr">head:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;link</span> <span class="string">rel=&quot;stylesheet&quot;</span> <span class="string">href=&quot;//at.alicdn.com/t/c/font_4426032_sy4sytzuoj9.css&quot;</span> <span class="string">media=&quot;defer&quot;</span> <span class="string">onload=&quot;this.media=&#x27;all&#x27;&quot;&gt;</span></span><br><span class="line">  <span class="attr">bottom:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;script</span> <span class="string">async</span> <span class="string">src=&quot;//at.alicdn.com/t/c/font_4426032_sy4sytzuoj9.js&quot;&gt;&lt;/script&gt;</span> </span><br></pre></td></tr></table></figure><p>同时可以在自定义<code>CSS</code>中添加如下样式来控制图标默认大小和颜色等属性（<strong>若已经在项目设置中勾选了彩色选项，则无需再定义图标颜色</strong>），写法与字体样式类似，这恐怕也是它被称为<code>iconfont</code>（图标字体）的原因:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">.iconfont</span> &#123;</span><br><span class="line">  <span class="attr">font-family:</span> <span class="string">&quot;iconfont&quot;</span> <span class="type">!important;</span></span><br><span class="line">  <span class="string">/*</span> <span class="string">这里可以自定义图标大小</span> <span class="string">*/</span></span><br><span class="line">  <span class="attr">font-size:</span> <span class="string">3em;</span></span><br><span class="line">  <span class="attr">font-style:</span> <span class="string">normal;</span></span><br><span class="line">  <span class="string">-webkit-font-smoothing:</span> <span class="string">antialiased;</span></span><br><span class="line">  <span class="string">-moz-osx-font-smoothing:</span> <span class="string">grayscale;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后定义导航栏</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="string">主页:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">iconfont</span> <span class="string">icon-shouye</span>              <span class="comment">#fas fa-home</span></span><br><span class="line">  <span class="string">分类:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">iconfont</span> <span class="string">icon-fenlei</span> <span class="comment">#fa fa-archive</span></span><br><span class="line">  <span class="string">标签:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">iconfont</span> <span class="string">icon-biaoqian</span>     <span class="comment">#fa fa-tags</span></span><br><span class="line">  <span class="string">归档:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">iconfont</span> <span class="string">icon-guidang</span>  <span class="comment">#fa fa-folder-open</span></span><br><span class="line">  <span class="string">友链:</span> <span class="string">/link/</span>    <span class="string">||</span> <span class="string">iconfont</span> <span class="string">icon-kafei</span>  <span class="comment"># fa fa-link</span></span><br><span class="line">  <span class="string">留言板:</span> <span class="string">https://gegewu-cloud.github.io/2023/05/23/留言板/</span> <span class="string">||</span> <span class="string">iconfont</span> <span class="string">icon-lishiliuyan</span> <span class="comment">#fa fa-paper-plane</span></span><br><span class="line">  <span class="string">关于:</span> <span class="string">https://gegewu-cloud.github.io/2023/05/22/关于/</span> <span class="string">||</span> <span class="string">iconfont</span> <span class="string">icon-xing</span> <span class="comment">#fas fa-heart </span></span><br></pre></td></tr></table></figure><p>效果</p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_4b90daa3afa9713b09d6c5b78cbb6671.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_4b90daa3afa9713b09d6c5b78cbb6671.png"></p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>清理systemd日志之journalctl</title>
      <link href="/2024/01/25/%E6%B8%85%E7%90%86systemd%E6%97%A5%E5%BF%97%E4%B9%8Bjournalctl/"/>
      <url>/2024/01/25/%E6%B8%85%E7%90%86systemd%E6%97%A5%E5%BF%97%E4%B9%8Bjournalctl/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="清理systemd日志之journalctl"><a href="#清理systemd日志之journalctl" class="headerlink" title="清理systemd日志之journalctl"></a>清理systemd日志之journalctl</h2><p>参考文献</p><p><a href="https://itlanyan.com/clear-systemd-journal-logs/">https://itlanyan.com/clear-systemd-journal-logs/</a></p><p><strong>systemd journal</strong>之于<code>systemd</code>犹如<strong>syslog</strong>之于<code>init</code>，其日志文件保存在 <strong>/var/log/journal</strong> 目录下。随着时间的流逝，该目录下会积累大量日志文件，占用不少的磁盘空间。如果硬盘容量较小或可用空间紧张，可以考虑清理过期日志释放占用的空间。</p><p>本文介绍清理<a href="https://itlanyan.com/tag/systemd/">systemd</a>日志的方法。</p><h3 id="清理systemd日志"><a href="#清理systemd日志" class="headerlink" title="清理systemd日志"></a>清理systemd日志</h3><p><a href="https://itlanyan.com/clear-systemd-journal-logs/#bnp_indexs">返回目录</a></p><p>清理之前，可查看一下systemd日志所占用的磁盘空间。既可以用常用的 <code>&lt;span class=&quot;pln&quot;&gt;du&lt;/span&gt;</code> 命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo du -sh /var/log/journal/</span><br><span class="line"># 示例输出</span><br><span class="line"># 3.9G /var/log/journal/</span><br></pre></td></tr></table></figure><p>但更推荐使用systemd日志管理专用命令 <code>&lt;span class=&quot;pln&quot;&gt;journalctl&lt;/span&gt;</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">journalctl --disk-usage</span><br><span class="line"># 示例输出</span><br><span class="line"># Archived and active journals take up 3.9G on disk.</span><br></pre></td></tr></table></figure><p>知道了日志占用的磁盘空间，接下来便可以清理过期日志。开始之前，建议 <code>&lt;span class=&quot;pln&quot;&gt;rotate&lt;/span&gt;</code> 当前日志(rotate是日志操作中的一个术语，其归档旧日志，后续日志写入新创建的日志文件中)：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo journalctl --rotate</span><br></pre></td></tr></table></figure><p><code>&lt;span class=&quot;pln&quot;&gt;journalctl&lt;/span&gt;</code>提供了三种清理systemd日志的方式。第一种是清理指定时间之前的日志：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 清理7天之前的日志</span><br><span class="line">sudo journalctl --vacuum-time=7d</span><br><span class="line"># 清理2小时之前的日志</span><br><span class="line">sudo journactl --vacuum-time=2h</span><br><span class="line"># 清理10秒之前的日志</span><br><span class="line">sudo journalctl --vacuum-time=10s</span><br><span class="line"># 上述命令示例输出：</span><br><span class="line"># Vacuuming done, freed 3.7G of archived journals on disk.</span><br></pre></td></tr></table></figure><p>第二种是限制日志占用的空间大小：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 限制systemd日志占用不超过1G空间</span><br><span class="line">sudo journalctl --vacuum-size=1G</span><br><span class="line"># 限制systemd日志占用不超过100M</span><br><span class="line">sudo journalctl --vacuum-size=100M</span><br><span class="line"># 输出与第一种类似</span><br></pre></td></tr></table></figure><p>第三种是保留日志文件个数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 保留最近的5个日志文件</span><br><span class="line">sudo journalctl --vacuum-files=5</span><br><span class="line"># 输出与第一种类似</span><br></pre></td></tr></table></figure><p>不知道 <code>journalctl</code> 管理日志功能之前，本人用过 <code>find 配合 </code><span class="kwd">exec</span><code> (或者管道加</code><span class="pln">xargs</span>`)的土办法清理过期日志：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 删除7天前的日志</span><br><span class="line">find /var/log/journal -mtime +7 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><h3 id="一劳永逸的办法"><a href="#一劳永逸的办法" class="headerlink" title="一劳永逸的办法"></a>一劳永逸的办法</h3><p><a href="https://itlanyan.com/clear-systemd-journal-logs/#bnp_indexs">返回目录</a></p><p>上文介绍的清理systemd日志方法适合一次性手动管理，重复做就没意思了。一劳永逸的办法是配置systemd journal，让其自动管理日志，不占用过多磁盘空间。</p><p>方法是编辑 <strong>/etc/systemd/journald.conf</strong> 文件，对其中的参数进行设置。例如限制日志最大占用1G空间：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Journal]</span><br><span class="line">#Storage=auto</span><br><span class="line">#Compress=yes</span><br><span class="line">#Seal=yes</span><br><span class="line">#SplitMode=uid</span><br><span class="line">#SyncIntervalSec=5m</span><br><span class="line">#RateLimitInterval=30s</span><br><span class="line">#RateLimitBurst=1000</span><br><span class="line">SystemMaxUse=1G</span><br><span class="line">#SystemKeepFree=</span><br><span class="line">#SystemMaxFileSize=</span><br><span class="line">#RuntimeMaxUse=</span><br><span class="line">#RuntimeKeepFree=</span><br><span class="line">#RuntimeMaxFileSize=</span><br></pre></td></tr></table></figure><p>保存配置文件后记得重新加载：<code>sudo systemctl restart systemd-journald</code></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://itlanyan.com/clear-systemd-journal-logs/#bnp_indexs">返回目录</a></p><ol><li><a href="https://linuxhandbook.com/clear-systemd-journal-logs/">How to Clear Systemd Journal Logs</a></li><li><a href="https://itlanyan.com/find-files-in-linux/">Linux文件查找</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker与k8s及vercel方式部署qexo😘</title>
      <link href="/2024/01/24/docker%E4%B8%8Ek8s%E5%8F%8Avercel%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2qexo/"/>
      <url>/2024/01/24/docker%E4%B8%8Ek8s%E5%8F%8Avercel%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2qexo/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="docker与k8s及vercel方式部署qexo😘"><a href="#docker与k8s及vercel方式部署qexo😘" class="headerlink" title="docker与k8s及vercel方式部署qexo😘"></a>docker与k8s及vercel方式部署qexo😘</h2><h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><p><a href="https://github.com/Qexo/Qexo.git">https://github.com/Qexo/Qexo.git</a>      【github官方托管仓库】<br><a href="https://www.yyds.space/posts/3dfeb390abb4">https://www.yyds.space/posts/3dfeb390abb4</a><br><a href="https://www.oplog.cn/qexo/start/build.html">Qexo 文档 (oplog.cn)</a></p><h2 id="一、docker部署及构建镜像"><a href="#一、docker部署及构建镜像" class="headerlink" title="一、docker部署及构建镜像"></a>一、docker部署及构建镜像</h2><p>最新部署方式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://onenote.zznnwn.cloudns.biz/api/raw/?path=/%E8%84%9A%E6%9C%AC/qexo/qexo.sh |  bash</span><br></pre></td></tr></table></figure><p>脚本详情</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"><span class="comment"># IP=$&#123;IP:-&#x27;127.0.0.1&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;执行此脚本前需要先执行初始化脚本&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"><span class="comment"># read -p &quot;输入您的本机iP: &quot; hostname_ip</span></span><br><span class="line"><span class="comment"># mkdir -p /opt/qexo &amp;&amp; cd /opt/qexo &amp;&amp; touch db.sqlite3</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/qexo || <span class="literal">true</span></span><br><span class="line"><span class="built_in">cd</span> /opt/qexo </span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="built_in">cat</span> &gt; docker-compose.yml &lt;&lt; <span class="string">eric</span></span><br><span class="line"><span class="string">version: &quot;3.8&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">services:</span></span><br><span class="line"><span class="string">  qexo:</span></span><br><span class="line"><span class="string">    image: registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:qexo-3.6.0</span></span><br><span class="line"><span class="string">    container_name: qexo</span></span><br><span class="line"><span class="string">    restart: always</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - &quot;8000:8000&quot;</span></span><br><span class="line"><span class="string">    environment:</span></span><br><span class="line"><span class="string">      - TIMEOUT=600</span></span><br><span class="line"><span class="string">    volumes:</span></span><br><span class="line"><span class="string">      - &quot;./db:/app/db&quot;</span></span><br><span class="line"><span class="string">eric</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># # configs.py</span></span><br><span class="line"><span class="comment"># cat &gt; configs.py &lt;&lt; eric</span></span><br><span class="line"><span class="comment"># import pymysql,os</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DOMAINS = [&quot;127.0.0.1&quot;,&quot;$IP&quot;]</span></span><br><span class="line"><span class="comment"># DATABASES = &#123;</span></span><br><span class="line"><span class="comment">#     &#x27;default&#x27;: &#123;</span></span><br><span class="line"><span class="comment">#         &#x27;ENGINE&#x27;: &#x27;django.db.backends.sqlite3&#x27;,</span></span><br><span class="line"><span class="comment">#         &#x27;NAME&#x27;: os.path.join(&#x27;/app/db&#x27; , &#x27;db.sqlite3&#x27;),</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment"># eric</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat &gt; docker-compose.yml &lt;&lt; eric</span></span><br><span class="line"><span class="comment"># version: &#x27;3&#x27;</span></span><br><span class="line"><span class="comment"># services:</span></span><br><span class="line"><span class="comment">#   qexo:</span></span><br><span class="line"><span class="comment">#     image: registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:qexo-3.0.2 </span></span><br><span class="line"><span class="comment">#     container_name: qexo</span></span><br><span class="line"><span class="comment">#     restart: always</span></span><br><span class="line"><span class="comment">#     ports:</span></span><br><span class="line"><span class="comment">#       - &quot;8000:8000&quot;</span></span><br><span class="line"><span class="comment">#     volumes:</span></span><br><span class="line"><span class="comment">#       - ./db.sqlite3:/app/db/db.sqlite3</span></span><br><span class="line"><span class="comment">#       - ./blog:/app/data</span></span><br><span class="line"><span class="comment">#       - ./configs.py:/app/configs.py</span></span><br><span class="line"><span class="comment"># eric</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始构建qexo&quot;</span></span><br><span class="line">[ $? -eq 0 ] &amp;&amp; docker-compose up -d </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;构建完成 访问本机IP+8000端口访问&quot;</span></span><br><span class="line">hostname -I</span><br><span class="line">docker-compose ps</span><br></pre></td></tr></table></figure><h2 id="二、申请免费mongondb数据库使用vercel部署qexo"><a href="#二、申请免费mongondb数据库使用vercel部署qexo" class="headerlink" title="二、申请免费mongondb数据库使用vercel部署qexo"></a>二、申请免费mongondb数据库使用vercel部署qexo</h2><h3 id="申请-MongoDB-数据库"><a href="#申请-MongoDB-数据库" class="headerlink" title="申请 MongoDB 数据库"></a>申请 MongoDB 数据库<a href="https://www.oplog.cn/qexo/start/build.html#%E7%94%B3%E8%AF%B7-mongodb-%E6%95%B0%E6%8D%AE%E5%BA%93"></a></h3><p><a href="https://www.mongodb.com/cloud/atlas/register">注册 MongoDB 账号</a> 创建免费 MongoDB 数据库, 区域<strong>一定要选择 AWS / N. Virginia (us-east-1)</strong> 在 Clusters 页面点击 CONNECT, 按步骤设置允许所有 IP 地址的连接）, 创建数据库用户, 并记录数据库连接信息, 密码即为你所设置的值<a href="https://s2.loli.net/2024/07/19/9axCOdNGJWUIqQ7.png"><img src="https://s2.loli.net/2024/07/19/9axCOdNGJWUIqQ7.png"></a></p><p>首次部署会报错, 请无视并重新进入项目, 在项目设置界面添加环境变量 Environment Variables（见 onenote 博客分类栏目）</p><table><thead><tr><th>名称</th><th>意义</th><th>示例</th></tr></thead><tbody><tr><td>MONGODB_HOST</td><td>MongoDB 数据库连接地址</td><td>mongodb+srv://cluster0.xxxx.mongodb.net</td></tr><tr><td>MONGODB_PORT</td><td>MongoDB 数据库通信端口 默认应填写 27017</td><td>27017</td></tr><tr><td>MONGODB_USER</td><td>MongoDB 数据库用户名</td><td>abudu</td></tr><tr><td>MONGODB_DB</td><td>MongoDB 数据库名</td><td>Cluster0</td></tr><tr><td>MONGODB_PASS</td><td>MongoDB 数据库密码</td><td>password</td></tr></tbody></table><p>在 Deployments 点击 Redeploy 开始部署, 若没有 Error 信息即可打开域名进入初始化引导</p><p><del>下方忽略</del></p><div class="tabs" id="test4"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test4-1">此栏下方部署方式作废</button></li><li class="tab"><button type="button" data-href="#test4-2"><i class="fab fa-apple-pay" style="text-align: center;"></i></button></li><li class="tab"><button type="button" data-href="#test4-3"><i class="fas fa-bomb"></i>炸弹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test4-1"><h4 id="概览："><a href="#概览：" class="headerlink" title="概览："></a>概览：</h4><ul><li><p>使用Dockerfile文件构建镜像</p></li><li><p>启动容器</p></li><li><p>推送到阿里云镜像栈</p></li><li><p>创建所需目录及文件</p></li><li><p>如不想了解镜像制作过程可直接使用此docker-compose.yml文件启动qexo服务<br>镜像可选“<strong>registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:qexo-3.0.2</strong>”<br>docker-compose.yml文件(需要修改<strong>config.py</strong>文件将自己的机器<strong>IP</strong>或<strong>域名</strong>加入  |  关于<strong>db.sqlite3</strong>只需要在当前目录创建一个名为<strong>db.sqlite3</strong>的空文件即可😎 )</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">qexo:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:qexo-3.0.2</span> </span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">qexo</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./db.sqlite3:/app/db/db.sqlite3</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./blog:/app/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./configs.py:/app/configs.py</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="1-创建配置文件目录及空数据库文件"><a href="#1-创建配置文件目录及空数据库文件" class="headerlink" title="1. 创建配置文件目录及空数据库文件"></a>1. 创建配置文件目录及空数据库文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置文件目录及空数据库文件</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /app/db /app/data</span><br><span class="line"><span class="built_in">touch</span>    /app/db/db.sqlite3</span><br><span class="line"><span class="comment"># 创建Dockerfile工作目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /data/qexo</span><br><span class="line"><span class="built_in">mkdir</span> -p /data/qexo/db</span><br><span class="line"><span class="built_in">cd</span> /data/qexo/db &amp;&amp; <span class="built_in">touch</span> db.sqlite3</span><br><span class="line"><span class="comment"># 将Qexo源码文件上传至工作目录 并打包为tar.gz格式文件</span></span><br><span class="line"><span class="built_in">cd</span> /data/qexo &amp;&amp; rz</span><br><span class="line"><span class="comment"># 配置编排文件</span></span><br><span class="line">vim Dockerfile</span><br></pre></td></tr></table></figure><p><strong>2. Dockerfile文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.11.3-alpine</span><br><span class="line"><span class="comment"># 维护者信息</span></span><br><span class="line">LABEL maintainer=<span class="string">&quot;xwgegewu@gmail.com&quot;</span></span><br><span class="line"><span class="comment"># 设置生产模式环境变量 </span></span><br><span class="line"><span class="comment"># ENV APP_ENV production</span></span><br><span class="line"><span class="comment"># pipy源设置</span></span><br><span class="line">RUN pip config <span class="built_in">set</span> global.index-url https://mirrors.cloud.tencent.com/pypi/simple/</span><br><span class="line"><span class="comment"># 设置时区</span></span><br><span class="line">RUN sed -i <span class="string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27;</span> /etc/apk/repositories &amp;&amp; \</span><br><span class="line">    apk --no-cache add tzdata &amp;&amp; \</span><br><span class="line">    <span class="built_in">cp</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; \</span><br><span class="line">    apk --no-cache del tzdata &amp;&amp; \</span><br><span class="line">    apk --no-cache add git &amp;&amp; \</span><br><span class="line">    <span class="built_in">mkdir</span> /app</span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line">WORKDIR /app</span><br><span class="line"><span class="comment"># 拷贝数据</span></span><br><span class="line"><span class="comment"># RUN git clone https://github.com/Qexo/Qexo.git /app</span></span><br><span class="line">ADD ./Qexo.tar.gz /app/</span><br><span class="line">RUN <span class="built_in">mv</span> /app/Qexo/* /app/</span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">RUN pip install --upgrade pip </span><br><span class="line">RUN apk --no-cache add build-base python3-dev libffi-dev</span><br><span class="line">RUN pip install Django==3.2.18</span><br><span class="line">RUN pip install PyMySQL==1.0.2</span><br><span class="line">RUN pip install boto3==1.26.94</span><br><span class="line">RUN pip install requests==2.28.2</span><br><span class="line">RUN pip install PyGithub==1.58.1</span><br><span class="line">RUN pip install python-gitlab==3.13.0</span><br><span class="line">RUN pip install html2text==2020.1.16</span><br><span class="line">RUN pip install PyYAML</span><br><span class="line">RUN pip install urllib3==1.26.15</span><br><span class="line">RUN pip install Markdown==3.4.1</span><br><span class="line">RUN pip install djongo==1.3.6</span><br><span class="line">RUN pip install django-cors-headers==3.14.0</span><br><span class="line">RUN pip install pymongo==3.13.0</span><br><span class="line">RUN pip install dnspython==2.2.1</span><br><span class="line">RUN pip install sqlparse==0.2.4</span><br><span class="line">RUN pip install psycopg2-binary==2.9.5</span><br><span class="line">RUN pip install cryptography==39.0.2</span><br><span class="line">RUN pip install pyopenssl==23.0.0</span><br><span class="line">RUN pip install oss2==2.17.0</span><br><span class="line">RUN pip install beautifulsoup4==4.11.2</span><br><span class="line"><span class="comment"># 拷贝启动脚本</span></span><br><span class="line">COPY . /app/</span><br><span class="line">RUN <span class="built_in">chmod</span> +x /app/run.sh</span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line">EXPOSE 8000</span><br><span class="line"><span class="comment"># 挂载目录</span></span><br><span class="line">VOLUME [<span class="string">&quot;/app/db&quot;</span>, <span class="string">&quot;/app/data&quot;</span>]</span><br><span class="line"><span class="comment"># 启动django</span></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;/app/run.sh&quot;</span>]</span><br></pre></td></tr></table></figure><h4 id="3-在-data-qexo创建配置文件"><a href="#3-在-data-qexo创建配置文件" class="headerlink" title="3. 在/data/qexo创建配置文件"></a>3. 在/data/qexo创建配置文件</h4><h5 id="configs-py"><a href="#configs-py" class="headerlink" title="configs.py"></a>configs.py</h5><p><strong>DOMAINS</strong>处需要加上自己的本机<strong>IP</strong>或者<strong>域名</strong> 相当于设置白名单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd /data/qexo &amp;&amp; vim configs.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库配置</span></span><br><span class="line"><span class="keyword">import</span> pymysql,os</span><br><span class="line"></span><br><span class="line">DOMAINS = [<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;10.0.0.10&quot;</span>]</span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.sqlite3&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: os.path.join(<span class="string">&#x27;/app/db&#x27;</span> , <span class="string">&#x27;db.sqlite3&#x27;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">python3 manage.py makemigrations</span><br><span class="line">python3 manage.py migrate</span><br><span class="line">python3 manage.py runserver 0.0.0.0:8000 --noreload</span><br></pre></td></tr></table></figure><h5 id="构建docker镜像-启动容器"><a href="#构建docker镜像-启动容器" class="headerlink" title="构建docker镜像 启动容器"></a>构建docker镜像 启动容器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建</span></span><br><span class="line">docker build -t qexo:3.0.2 .</span><br><span class="line"><span class="comment"># 启动容器</span></span><br><span class="line">docker run -d --name qexo -p 8000:8000 -v /data/qexo/db:/app/db -v /data/blog:/app/data qexo:3.0.2</span><br></pre></td></tr></table></figure><h5 id="查看docker日志是否成功运行"><a href="#查看docker日志是否成功运行" class="headerlink" title="查看docker日志是否成功运行"></a>查看docker日志是否成功运行</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">docker logs qexo</span><br><span class="line"></span><br><span class="line">获取本地配置文件成功, 使用本地数据库配置</span><br><span class="line">           _               _ </span><br><span class="line">     /\   | |             | |</span><br><span class="line">    /  \  | |__  _   _  __| |_   _ </span><br><span class="line">   / /\ \ | |_ \| | | |/ _| | | | |</span><br><span class="line">  / ____ \| |_) | |_| | (_| | |_| |</span><br><span class="line"> /_/    \_\____/ \____|\____|\____|</span><br><span class="line">当前环境: 本地</span><br><span class="line">Operations to perform:</span><br><span class="line">  Apply all migrations: auth, contenttypes, hexoweb, sessions</span><br><span class="line">Running migrations:</span><br><span class="line">  No migrations to apply.</span><br><span class="line">[25/Jan/2024 07:11:16] ERROR: Provider获取失败, 跳过(functions.py.&lt;module&gt;[line:55])</span><br><span class="line">[25/Jan/2024 07:11:40] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 302 0</span><br><span class="line">[25/Jan/2024 07:11:40] INFO: 未检测到初始化配置, 转跳到初始化页面(views.py.login_view[line:40])</span><br><span class="line">[25/Jan/2024 07:11:40] <span class="string">&quot;GET /login/?next=/ HTTP/1.1&quot;</span> 302 0</span><br><span class="line">[25/Jan/2024 07:11:40] INFO: 保存设置CDN_PREV =&gt; https://unpkg.com/(functions.py.save_setting[line:259])</span><br><span class="line">[25/Jan/2024 07:11:40] INFO: 保存设置QEXO_NAME =&gt; Hexo管理面板(functions.py.save_setting[line:259])</span><br></pre></td></tr></table></figure><p>浏览器访问: http://本机IP:8000 完成各项初始化等配置。</p><h4 id="4-最后推送到阿里云镜像栈-略-并使用阿里云镜像构建容器"><a href="#4-最后推送到阿里云镜像栈-略-并使用阿里云镜像构建容器" class="headerlink" title="4. 最后推送到阿里云镜像栈(略)并使用阿里云镜像构建容器"></a>4. 最后推送到阿里云镜像栈(略)并使用阿里云镜像构建容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker login ....</span><br><span class="line">docker tag .....</span><br><span class="line">docker push .....</span><br></pre></td></tr></table></figure><h2 id="二、k8s部署qexo（使用HostPath存储）"><a href="#二、k8s部署qexo（使用HostPath存储）" class="headerlink" title="二、k8s部署qexo（使用HostPath存储）"></a>二、k8s部署qexo（使用HostPath存储）</h2><p>创建配置文件夹目录：/opt/qexo/app/db</p><p>创建配置文件目录：  /opt/qexo/app/db/db.sqlite3</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql配置</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qexo-py</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">configs.py:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    # 数据库配置</span></span><br><span class="line"><span class="string">    import pymysql,os</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">    <span class="string">DOMAINS</span> <span class="string">=</span> [<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;10.0.0.10&quot;</span>]</span><br><span class="line">    <span class="string">DATABASES</span> <span class="string">=</span> &#123;</span><br><span class="line">        <span class="attr">&#x27;default&#x27;:</span> &#123;</span><br><span class="line">            <span class="attr">&#x27;ENGINE&#x27;:</span> <span class="string">&#x27;django.db.backends.sqlite3&#x27;</span>,</span><br><span class="line">            <span class="attr">&#x27;NAME&#x27;:</span> <span class="string">os.path.join(&#x27;/app/db&#x27;</span> , <span class="string">&#x27;db.sqlite3&#x27;</span><span class="string">)</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># qexo  </span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qexo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">qexo</span> <span class="comment"># has to match .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;qexo&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span> <span class="comment"># by default is 1               # 3副本</span></span><br><span class="line">  <span class="comment"># minReadySeconds: 10 # by default is 0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">qexo</span> <span class="comment"># has to match .spec.selector.matchLabels</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qexo</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/zznn/mycentos:qexo-3.0.2</span> </span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">qexo</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qexo-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/app/db/db.sqlite3</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qexo-py</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">&quot;/app/configs.py&quot;</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">configs.py</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qexo-volume</span></span><br><span class="line">        <span class="attr">hostPath:</span> </span><br><span class="line">          <span class="attr">path:</span> <span class="string">/opt/qexo/app/db/db.sqlite3</span>      <span class="comment"># 宿主机目录  </span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">FileOrCreate</span>                     <span class="comment"># 目录存在就使用，不存在就先创建后使用</span></span><br><span class="line">      <span class="comment"># 定义 ConfigMap 类型的 Volume</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">qexo-py</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">qexo-py</span>  <span class="comment"># 引用名为 mysql-cm 的 ConfigMap</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露webstack端口</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qexo-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">qexo</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># 将服务暴露为 NodePort 类型</span></span><br></pre></td></tr></table></figure><p>扩展编辑挂载上去的configmap文件：</p><ul><li>kubectl get cm -n dev</li><li>kubectl edit cm qexo-py -n dev</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test4-2"><p><strong>只有图标 没有Tab名字</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test4-3"><p><strong>名字+icon</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
      
      
      <categories>
          
          <category> qexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> qexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos7重置密码</title>
      <link href="/2024/01/24/centos7%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81/"/>
      <url>/2024/01/24/centos7%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>centos7重置密码</strong></p><h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><p><a href="https://blog.csdn.net/gnail_oug/article/details/94721777">https://blog.csdn.net/gnail_oug/article/details/94721777</a></p><h4 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h4><p>centos7.6 / 7.9 重置密码</p><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>当<strong>root</strong>密码忘了之后，可以通过重启系统，在开机时重新设置密码。注：测试版本为**CentOS Linux release 7.6.1810 (Core)**，其他版本可能有些区别。</p><h4 id="重置密码"><a href="#重置密码" class="headerlink" title="重置密码"></a>重置密码</h4><h5 id="1、重启系统，在开机过程中，出现以下界面时按e键，进入编辑界面"><a href="#1、重启系统，在开机过程中，出现以下界面时按e键，进入编辑界面" class="headerlink" title="1、重启系统，在开机过程中，出现以下界面时按e键，进入编辑界面"></a>1、重启系统，在开机过程中，出现以下界面时按e键，进入编辑界面</h5><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_56eb784c63c8b82f62e62f1b5752d680.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_56eb784c63c8b82f62e62f1b5752d680.png"></p><h5 id="2、修改配置修改密码"><a href="#2、修改配置修改密码" class="headerlink" title="2、修改配置修改密码"></a>2、修改配置修改密码</h5><ul><li>按方向键下键↓，找到设置语言的地方，如<strong>LANG=en_US.UTF-8</strong> 在后面追加<strong>rw single init=/bin/bash,<strong>然后按</strong>ctrl+x</strong>重启系统</li><li>进入<strong>bash</strong>界面后，可以输入<strong>passwd</strong>命令重新设置<strong>root</strong>密码</li><li>如果开启了<strong>SELinux</strong>，执行命令<strong>touch /.autorelabel</strong>命令</li><li>输入<strong>exec /sbin/init</strong>命令重启系统 使用新设置的密码进入系统之后，为了安全起见，可以输入<strong>reboot</strong>重新启动一次系统。</li></ul><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_5f98f5afcf72816ec0aeff6ad4f81deb.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_5f98f5afcf72816ec0aeff6ad4f81deb.png"></p><p>此时成功！</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux带宽网卡流量监控工具nethogs使用</title>
      <link href="/2024/01/22/linux%E5%B8%A6%E5%AE%BD%E7%BD%91%E5%8D%A1%E6%B5%81%E9%87%8F%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7nethogs%E4%BD%BF%E7%94%A8/"/>
      <url>/2024/01/22/linux%E5%B8%A6%E5%AE%BD%E7%BD%91%E5%8D%A1%E6%B5%81%E9%87%8F%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7nethogs%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>linux带宽网卡流量监控工具nethogs使用</strong></p><p>前言：</p><p>此前在另外一篇博客里面介绍了另一测速工具<a href="https://gegewu-cloud.github.io/2023/07/14/speedtest-%E6%B5%8B%E8%AF%95%E7%BD%91%E7%BB%9C%E5%B8%A6%E5%AE%BD/?highlight=speed">speedtest</a>不少小伙伴反馈说测速不准确 本次介绍另一工具<a href="%5BLinux%E5%B7%A5%E5%85%B7%E4%B9%8Bnethogs%E5%91%BD%E4%BB%A4-CSDN%E5%8D%9A%E5%AE%A2%5D(https://blog.csdn.net/carefree2005/article/details/124199604)">nethogs</a>  各种网络流量监控工具 &gt; <a href="https://gegewu-cloud.github.io/2023/11/23/linux%E6%8E%92%E6%9F%A5%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%E5%B8%B8%E7%94%A8CMD%E6%80%BB%E7%BB%93/">传送</a></p><h3 id="一-安装"><a href="#一-安装" class="headerlink" title="一. 安装"></a>一. 安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install - y nethogs</span><br></pre></td></tr></table></figure><h3 id="二-使用"><a href="#二-使用" class="headerlink" title="二. 使用"></a>二. 使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看帮助</span></span><br><span class="line">nethogs -h</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看版本</span></span><br><span class="line">nethogs -v</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nethogs命令默认监控所有物理网卡，可以后面接口网卡名称方式指定监控某网卡流量，可以接多个网卡名称，网卡之间空格隔开</span></span><br><span class="line">nethogs eth0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监控时刷新频率3秒总计2次</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认刷新频率间隔1秒，刷新次数不限制直到主动结束进程或者退出。</span></span><br><span class="line">nethogs -d 3 -c 2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">按照MB流量格式显示模式显示</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定网卡流量显示单位，默认KB，(0 = KB/s, 1 = total KB, 2 = total B, 3 = total MB)</span></span><br><span class="line">nethogs -v 3</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监控所有网卡流量</span></span><br><span class="line">nethogs -a</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-t表示启用追踪模式，可以记录每一次的值，也可以结合其他参数一起使用。</span></span><br><span class="line">nethogs -t -d 10 -c 5</span><br></pre></td></tr></table></figure><h3 id="三-使用语法及参数说明"><a href="#三-使用语法及参数说明" class="headerlink" title="三. 使用语法及参数说明"></a>三. 使用语法及参数说明</h3><p>使用语法<br>用法：nethogs [参数] [device]</p><p>参数    参数说明<br>-V    打印命令版本<br>-h    打印帮助<br>-b    bughunt模式<br>-d    指定显示刷新频率，单位秒，默认1秒<br>-v    指定流量单位模式(0 = KB/s, 1 = total KB, 2 = total B, 3 = total MB)<br>-c    设置刷新更新次数<br>-t    tracemode模式，可以记录下每一次刷新的流量值<br>-p    混杂模式下监听流量（不建议使用）<br>-s    按照发送流量排序输出<br>-a    监控所有网卡端口，包括环回接口<br>运行模式下按键说明<br>按键    按键说明<br>q    退出<br>s    按照发送流量排序<br>r    按照接受流量排序<br>m    切换端口流量单位显示模式在B,KB,MB之间流量切换</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>物理服务器结构图</title>
      <link href="/2024/01/17/%E7%89%A9%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BB%93%E6%9E%84%E5%9B%BE/"/>
      <url>/2024/01/17/%E7%89%A9%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BB%93%E6%9E%84%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>物理服务器结构图</strong></p><p><strong>概览🍉 ：</strong></p><p>外观接口</p><p>产品内部结构</p><div class="gallery">    <div class="fj-gallery  data" data-rowheight="220" data-limit="10">    <span class="gallery-data">[{"url":"https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_e55ad4914ecc2115cae8f66c70a4d2ce.png","alt":""},{"url":"https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_0719498ab66e6038ecc45c5d21398f75.png","alt":""},{"url":"https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_30518c76a3cbacc8c7bfb54189ee5695.png","alt":""}]</span>    </div>    <button class="gallery-load-more"><span>Load More</span><i class="fa-solid fa-arrow-down"></i></button>    </div>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小站简介</title>
      <link href="/2024/01/17/%E6%9C%AC%E7%AB%99%E8%AF%B4%E6%98%8E/"/>
      <url>/2024/01/17/%E6%9C%AC%E7%AB%99%E8%AF%B4%E6%98%8E/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="小站简介🌙"><a href="#小站简介🌙" class="headerlink" title="小站简介🌙"></a>小站简介🌙</h1><p>本站为<a href="https://gegewu-cloud.github.io/">ZzNnWn.</a>博主新开博客 本站使用图床Blazeb2及Github图床</p><p>之前一直使用<del>hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</del>的方式写作管理博客 不是很方便有时候会出现<strong>hexo d</strong>报错的现象  加之博客篇数太多后导致 每次执行损耗时间过长 一直在寻找解决此问题的方法 中途差点放弃使用hexo  一次偶然的机会 了解到<a href="http://sunlight.zznnwn.cloudns.biz/2024/01/16/hexo-butterfly-Qexo%E5%90%8E%E7%AB%AFgithub%E8%87%AA%E5%8A%A8%E5%8C%96.md/">Qexo</a>这个极其好用的管理hexo的工具几番尝试后决定新开一博客<a href="http://sunlight.zznnwn.cloudns.biz/">粘人的鸭嘴兽. </a> 初衷 用于记录日常 本站技术类文章较少 技术类文章在博主另一小站<a href="https://gegewu-cloud.github.io/">ZzNnWn.</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_5b853d0d15aa45c9015e5066614ecc8f.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/9/image_5b853d0d15aa45c9015e5066614ecc8f.png"></p><p>站点初始链接：<a href="http://sunlight.zznnwn.cloudns.biz/">zznn-cloud博客</a><br>托管域名地址：<a href="http://sunlight.zznnwn.cloudns.biz/">http://sunlight.zznnwn.cloudns.biz/</a></p>]]></content>
      
      
      <categories>
          
          <category> 日常 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日常 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux-alias方式防止根目录误删</title>
      <link href="/2024/01/16/linux-alias%E6%96%B9%E5%BC%8F%E9%98%B2%E6%AD%A2%E6%A0%B9%E7%9B%AE%E5%BD%95%E8%AF%AF%E5%88%A0/"/>
      <url>/2024/01/16/linux-alias%E6%96%B9%E5%BC%8F%E9%98%B2%E6%AD%A2%E6%A0%B9%E7%9B%AE%E5%BD%95%E8%AF%AF%E5%88%A0/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>linux-alias方式防止根目录误删（本文档未测试）</strong></p><p>参考：</p><ul><li><a href="http://www.opstool.com/article/179">http://www.opstool.com/article/179</a></li><li><a href="https://steemit.com/cn/@oflyhigh/sudo-rm-rf">https://steemit.com/cn/@oflyhigh/sudo-rm-rf</a></li><li><a href="https://zhuanlan.zhihu.com/p/106066854">https://zhuanlan.zhihu.com/p/106066854</a></li></ul><p>rm是一个危险的命令，为了防止rm /这样的操作发生。我们可以在用户的家目录的.bashrc里将rm alisa一下，加上–preserve-root这个参数。其实除了rm外，另外几个命令也需要谨慎，如chgrp、chown、chmod总结一下，我们可以在.bashrc里加入如下alias：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> <span class="built_in">chgrp</span>=<span class="string">&#x27;chgrp --preserve-root&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> <span class="built_in">chown</span>=<span class="string">&#x27;chown --preserve-root&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> <span class="built_in">chmod</span>=<span class="string">&#x27;chmod --preserve-root&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> <span class="built_in">rm</span>=<span class="string">&#x27;rm -i --preserve-root&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>详细解释之根目录保护</strong></p><p>有一定经验的系统管理员可能这个时候会想起来，<code>rm</code> 命令有一对专门针对根目录的选项 <code>--preserve-root</code> 和 <code>--no-preserve-root</code> 。这对选项的意思是：</p><ul><li><code>--preserve-root</code>：保护根目录，这是默认行为。</li><li><code>--no-preserve-root</code>：不保护根目录。</li></ul><p>这对选项是后来添加到 <code>rm</code> 命令的。可能几乎每个系统管理员都犯过操作错误，而这其中删除过根目录的比比皆是（我就是一个）。出现这种情况的原因有几种：</p><ul><li>输入手误：比如本来想输入 <code>rm /tmp/test.txt</code>，结果不小心键盘打的飞起，多输入了一个空格变成： <code>rm / tmp/test.txt</code> 。看到根目录（<code>/</code>）后面的空格了么？！——这就是我当前自己亲手犯过的错误，而且是在生产服务器上。</li><li>未正确初始化或命名错误的 shell 脚本变量：比如在脚本中，<code>rm -rf /$&#123;tmp_dir&#125;</code>，如果无论是 <code>tmp_dir</code> 变量没有正确赋值还是输入错误（原本或许是 <code>tmpdir</code> ？），那会导致什么？当然是删除根目录咯~</li></ul><p>鉴于这种情况层出不穷，在 Linux 圈子几乎和“初学者如何退出 vi” 一样成为经典笑话了。所以，在 POSIX 第七版规范中，<code>rm</code> 命令<a href="https://link.zhihu.com/?target=http://pubs.opengroup.org/onlinepubs/9699919799/utilities/rm.html">添加</a>了 <code>--preserve-root</code> 选项，并将其作为默认行为，以降低出现这种错误的可能。</p><p>但是，这个选项不能防范本文中所述的清除根目录下所有文件（<code>/*</code>）的操作。</p><p>有的同学可能要问，那为什么还会专门出现 <code>--no-preserve-root</code> 选项呢？这可能主要是出于 UNIX 哲学的考虑，给予你想要的一切权力，犯傻是你的事情，而不是操作系统的事情。万一，你真的想删除根目录下的所有文件呢？</p><p>你还别说，真有这种需求：比如你要清除一个 chroot 环境下的所有文件。 chroot 我们这里不多讲，它就是以一个目录作为“监狱”，该目录在逻辑上形成了新的“根目录”，在该监狱内的文件操作不能跨出该目录范畴。近些年流行的 Docker、LXC/LXD 之类的容器技术，都是一种 chroot 技术。</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo-butterfly-Qexo后端github自动化</title>
      <link href="/2024/01/16/hexo-butterfly-Qexo%E5%90%8E%E7%AB%AFgithub%E8%87%AA%E5%8A%A8%E5%8C%96/"/>
      <url>/2024/01/16/hexo-butterfly-Qexo%E5%90%8E%E7%AB%AFgithub%E8%87%AA%E5%8A%A8%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>hexo+butterfly+Qexo后端+github自动化</strong>👍</p><p>参考：</p><p><a href="https://www.oplog.cn/qexo/">https://www.oplog.cn/qexo/</a>                      （官网）<br><a href="https://blog.kwxos.top/posts/18807.html">https://blog.kwxos.top/posts/18807.html</a> （只此一篇即可👍 ）<br><a href="https://blog.syize.cn/2024/12/04/hexo-github-actions/">使用GitHub的Action自动生成和部署Hexo博客 | Syize の blog</a></p><p>概览：</p><p>（只需要github整体设置创建token后配置action填入token在autodeploy.yml文件中即可实现自动化部署）</p><ul><li><p>新建两个仓库一个放博客源文件 一个存放静态文件<br>存放源文件仓库：<a href="https://github.com/zznn-cloud/qexo-blog-source">qexo-blog-source</a>此仓库需设置为私有<br>存放静态文件仓库：zznn-cloud.github.io 此仓库公开</p></li><li><p>常规部署方式hexo clean &amp;&amp; hexo g &amp;&amp; hexo d将静态文件推送到仓库zznn-cloud.github.io</p></li><li><p>使用Git、vscode或者github自带的app等工具将博客源文件推送到仓库qexo-blog-source<br>推荐使用github自带的app<br>使用参考：<a href="https://www.cnblogs.com/chuqianyu/p/14185992.html">通过GitHub Desktop 上传代码到github 远程仓库 - 楚千羽 - 博客园 (cnblogs.com)</a></p><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/1/image_69e9fe2fb3567df1fc4753addd7aa446.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/25/1/image_69e9fe2fb3567df1fc4753addd7aa446.png"></p></li><li><p>源文件仓库qexo-blog-source <strong>.github</strong>下新建Github Action配置文件</p></li><li><p>使用Vercel部署qexo管理博客</p></li><li><p>浏览器访问zznn-cloud.github.io 此时部署完成</p></li></ul><blockquote><p>~~note: 关于博客如何搭建及Github pages如何使用相对简单本文不做介绍~</p><p>最简方式部署利用博主公开的源码仓库：</p><p><a href="https://github.com/zznn-cloud/blog_easy_client">https://github.com/zznn-cloud/blog_easy_client</a></p></blockquote><h2 id="一-两个仓库配置"><a href="#一-两个仓库配置" class="headerlink" title="一. 两个仓库配置"></a>一. 两个仓库配置</h2><ol><li><p><a href="https://wn-apple-teawine.fun/2023/08/12/hexo%E4%B8%8Egithub%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/#%E5%8D%81-butterfly%E4%B8%BB%E9%A2%98%E8%AE%BE%E7%BD%AE">公开仓库zznn-cloud.github.io静态文件推送较为简单此处略</a></p></li><li><p><strong>github-token</strong>生成此<code>token</code>填入下方<code>action</code>配置文件(配置永不过期以及下方权限)</p><p><img src="https://f005.backblazeb2.com/file/boke-images/znn-cloud-boke/86b145ca-5730-4187-836e-00aad670b76d.png"></p></li><li><p>私有仓库<strong>qexo-blog-source</strong>只需要<strong>push</strong>下方文件即可</p><p><img src="https://f005.backblazeb2.com/file/boke-images/znn-cloud-boke/5ff789ab-8d59-4a54-b2a2-aeec9ba423b4.png"></p></li><li><p>私有仓库.github目录新建配置文件如下</p><p><img src="https://f005.backblazeb2.com/file/boke-images/znn-cloud-boke/6eb998ca-bee5-4b26-9286-86d3ba8ea862.png"></p><p>配置如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">自动部署</span></span><br><span class="line"><span class="comment"># 当有改动推送到main分支时，启动Action</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">      <span class="comment">#2020年10月后github新建仓库默认分支改为main，注意更改</span></span><br><span class="line">  <span class="attr">release:</span></span><br><span class="line">    <span class="attr">types:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">published</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">检查分支</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装</span> <span class="string">Node</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&quot;16.x&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装</span> <span class="string">Hexo</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          export TZ=&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line"><span class="string">          npm install hexo-cli -g</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">缓存</span> <span class="string">Hexo</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">cache-npm</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/cache@v3</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">cache-name:</span> <span class="string">cache-node-modules</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">node_modules</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">$&#123;&#123;</span> <span class="string">runner.os</span> <span class="string">&#125;&#125;-build-$&#123;&#123;</span> <span class="string">env.cache-name</span> <span class="string">&#125;&#125;-$&#123;&#123;</span> <span class="string">hashFiles(&#x27;**/package-lock.json&#x27;)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">restore-keys:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            $&#123;&#123; runner.os &#125;&#125;-build-$&#123;&#123; env.cache-name &#125;&#125;-</span></span><br><span class="line"><span class="string">            $&#123;&#123; runner.os &#125;&#125;-build-</span></span><br><span class="line"><span class="string">            $&#123;&#123; runner.os &#125;&#125;-</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># Install pandoc for mathjax (Optional)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">pandoc</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          cd /tmp</span></span><br><span class="line"><span class="string">          wget -c https://github.com/jgm/pandoc/releases/download/2.14.0.3/pandoc-2.14.0.3-1-amd64.deb</span></span><br><span class="line"><span class="string">          sudo dpkg -i pandoc-2.14.0.3-1-amd64.deb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装依赖</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.cache-npm.outputs.cache-hit</span> <span class="type">!=</span> <span class="string">&#x27;true&#x27;</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          # npm install gulp-cli -g #全局安装gulp</span></span><br><span class="line"><span class="string">          npm install --save</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">     <span class="comment"># - name: 修改双栏插件的CDN</span></span><br><span class="line">     <span class="comment">#   run: |</span></span><br><span class="line">     <span class="comment">#     sed -i &quot;s/cdn.jsdelivr.net/blogresource.sqwdream.top\/cdn.jsdelivr.net/g&quot; node_modules/hexo-butterfly-article-double-row/index.js</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">生成静态文件</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          hexo clean</span></span><br><span class="line"><span class="string">          hexo bangumi -u #bilibili番剧更新</span></span><br><span class="line"><span class="string">          hexo generate</span></span><br><span class="line"><span class="string">          # gulp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署到Github</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">JamesIves/github-pages-deploy-action@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">token:</span> <span class="string">github-token</span>  <span class="comment"># github高权限token</span></span><br><span class="line">          <span class="attr">repository-name:</span> <span class="string">zznn-cloud/zznn-cloud.github.io</span></span><br><span class="line">          <span class="attr">branch:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">folder:</span> <span class="string">public</span></span><br><span class="line">          <span class="attr">commit-message:</span> <span class="string">&quot;$<span class="template-variable">&#123;&#123; github.event.head_commit.message &#125;&#125;</span> Updated By Github Actions&quot;</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="二-Qexo部署及配置"><a href="#二-Qexo部署及配置" class="headerlink" title="二. Qexo部署及配置"></a>二. Qexo部署及配置</h2><ol><li><p>此处申请vercel免费的数据库作为存储数据使用</p></li><li><p>使用vercel函数计算部署Qexo前端</p><p><del>Note：上方两步骤较为简单本文不做介绍</del></p></li><li><p>一键部署Qexo传送门(<a href="https://vercel.com/new/clone?repository-url=https://github.com/am-abudu/Qexo">New Project – Vercel</a></p><p><img src="https://f005.backblazeb2.com/file/boke-images/znn-cloud-boke/bc9f1111-b88d-49be-a0dd-a61f94e46078.png"></p></li><li><p>Qexo写博客参数留存</p><p><img src="https://f005.backblazeb2.com/file/boke-images/znn-cloud-boke/655e81e0-1d98-40ee-9fbe-20f0f9ceea2e.png"></p><p><img src="https://f005.backblazeb2.com/file/boke-images/znn-cloud-boke/04073e0c-4649-4ea8-8e83-5ab25e43507d.png"></p></li></ol><h1 id="三-扩展😘"><a href="#三-扩展😘" class="headerlink" title="三. 扩展😘"></a>三. 扩展😘</h1><p><strong>Qexo logo等信息</strong></p><ul><li><a href="https://unpkg.com/qexo-static@2.2.3/qexo/images/qexo.png">https://unpkg.com/qexo-static@2.2.3/qexo/images/qexo.png</a></li><li><a href="https://unpkg.com/qexo-static@2.2.3/qexo/images/icon.png">https://unpkg.com/qexo-static@2.2.3/qexo/images/icon.png</a></li><li><a href="https://unpkg.com/qexo-static@2.2.3/qexo/images/qexo-dark.png">https://unpkg.com/qexo-static@2.2.3/qexo/images/qexo-dark.png</a></li></ul><p><strong>Github图床设置</strong>✌</p><p><a href="https://github.com/Qexo/Qexo/wiki/%E5%9B%BE%E5%BA%8A%E9%85%8D%E7%BD%AE">https://github.com/Qexo/Qexo/wiki/%E5%9B%BE%E5%BA%8A%E9%85%8D%E7%BD%AE</a></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 仓库</span></span><br><span class="line">zznn-cloud/zznn-cloud-blog-images</span><br><span class="line"><span class="section"># 分支</span></span><br><span class="line">main</span><br><span class="line"><span class="section"># 高权限token</span></span><br><span class="line">ghp<span class="emphasis">_Qknm...................</span></span><br><span class="line"><span class="emphasis"># 保存路径</span></span><br><span class="line"><span class="emphasis">Qexo/&#123;year&#125;/&#123;month&#125;/&#123;filename&#125;_</span>&#123;md5&#125;.&#123;extName&#125;</span><br><span class="line"><span class="section"># 自定义域名</span></span><br><span class="line">https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/&#123;year&#125;/&#123;month&#125;/&#123;filename&#125;<span class="emphasis">_&#123;md5&#125;.&#123;extName&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p><img src="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_3292d63d8f8d8a13d3e5c4da5693056e.png" alt="https://github.com/zznn-cloud/zznn-cloud-blog-images/raw/main/Qexo/24/1/image_3292d63d8f8d8a13d3e5c4da5693056e.png"></p></blockquote><p>结语：Qexo是一个极其好用的hexo管理平台感谢维护此项目大佬们的贡献👍 。</p>]]></content>
      
      
      <categories>
          
          <category> qexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> qexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>qexo</title>
      <link href="/2023/12/15/test%E6%96%87%E6%A1%A3/"/>
      <url>/2023/12/15/test%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh,这是一个无效的密码。请检查并重试。" data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="1e36074e6806db3b794944b334a845b30ee4a44008c0f95412e8164b226bd2f7">a81b18b76326989181327cf554748c52da21cc33c0731b37b224ba7b570727d3b6d5ddf5cf3c517190be31f0da481a7c1ae1ccf60fc7eaceeb9cc5892e16592bedd0fa34da4e1fbebcabbc85c61b51dc15b4dd5c653dd684e603438464111c4758ada5701ed225dfbd33a33cab2ad7f5093655aeb5eaca0232ba36211d5fc9ff44db582730bf5c727b33bccadb8cb8b77cae0b827153cec6695bba5dd664156870a40827582da63c9bb736da2a1bfc98df7330236d44a7d2f8b10dfdfcd122bd5e2c4b11abfa2950fbe9241cf3f70397f4fefef6014cbf3accc24f189e4e0a0c3b4ec4f45e9219defb3827e97c491cc502d47705a211f980292e5d94782afb28e13979fec10f387caf7a4b98b79a86fe4e7ad3f9160a17314f34ae7dc9de9657330c39bdb079565dd9b9028e55be707459664d80e94aaa904db0f7625599f5d554d2eb884008a91dba287ef5a9e3b8d7f9be0e0cb510ed2de19caaef0d93f43f3fab92059dcb4ae3117d38f5f8569e2599dba450684e50ae2cafed01af668acaccbfd559639df872095f921c09511ba9aa98eaa60ff40792ef9de59eaf803fa0385e164e13c46a17baba7df1020fff0da0f5966c893838d94d1acb2cdefc0c668136b567139a3ccdb81c79fe589a04e4c29f588bc4970922e347038b5255e2073adf5a6f7b1b3da9766823e784de618db79c4e9c7fa9bcb8d349420c1caec932caf6fec3f006905a4da03a87acbb2a0c976d6aa75713e4ac4f627cfdf081140629c8e64f4a4f530949bef04038eb8a5f5bda930b8e4f90f00b0054e7424e220988a14706065271315d9cc90efbea5a21e6b2ab3b97950791af32fea88dc1b4997e0f745f4ee19c3ea33ef460bf37f91a0915fef7997f1476766e49003ee3b4a68b8b45b1fa6c2a9819837b731413ac89ca44f96ed6e06fdde14d31aafd7f10be7182781fcc2f07c927aa8a9b3e18889648d59b4731c1118ab551e3eace4c6cbdcec0dafc9ea2038503b1bf4ce5d78f51c6357e483f7ecd9082168c55ef6208c20227a5499cf042252ea5444d6d925806a4834d574b220e8e14e1ee686f2a699360a0fcedebe1c4b8b0ec701509bb99b96bf2bd69b73b8fd4db9ee9adf0bece84ccfef7bb6759ce3d88f32b8d6f5a4c48f33cc5576c609bf4b89b88fec3a9e95657ff7f1a71f8c2c08068bd8f32c9e0e6adae824595277425c51c9342210ea2ddbd0c468a56e49a07dd603b6c077294df30fd2d37ef48c85b28495a7fba0fdceb2f82d630deea7f8de307fb911599f5c6cb732ffa0c94511fb928a2ea94df54502f6e4ee0a1ec2287b6f0ab5d8cb8a71da9f5cd4fe2f3e86440dfef0c5f538f1fa794b49d86b24907d5ab7bef455fce7a1f5f0f8df94c6b4778617a040daa6e38feff24023cdc7d58888534dac1a361c5</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">请输入访问密码</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> default </category>
          
      </categories>
      
      
        <tags>
            
            <tag> default </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
